# Cognitive Razor — 下一步计划（折中路线）

## 1) 约束与基线
- 原则：KISS / YAGNI / DRY / SOLID；Result Monad、无裸 throw；尽量复用已有 utils。
- 工具/栈：TypeScript strict，Obsidian API，现有 PromptManager/schemaRegistry 为唯一的 Prompt/Schema 来源。

## 2) 双边偏向决策（本轮执行依据）
- 任务覆盖：偏向 SSOT —— Merge/Incremental/Write 类任务纳入队列管理。
- 调度时机：偏向 SSOT —— 重启后不自动执行 Pending，需手动 resume。
- 锁模型：偏向代码 —— 维持简单锁实现（可补 TypeLock 但不引入复杂等待）。
- Embedding/去重：偏向代码 —— 允许可配置维度；增量/合并后重算 embedding。
- Frontmatter 契约：偏向 SSOT —— definition 入 frontmatter；保留 parentUid/parentType/sourceUids/version 并在 SSOT 明示。
- 快照策略：偏向 SSOT —— 仅破坏性操作（merge/amend/incremental）建快照，路径统一。
- 错误码/分类：偏向 SSOT —— 全 Result/err 流，使用现行码表，消除裸 throw。
- Workbench 折叠默认：偏向 SSOT —— duplicates 默认展开，凸显核心价值。
- 命令矩阵：偏向 SSOT —— 文档保留完整命令，标记未实现项；优先补 verify/visualize 通路或在文档注明缺口。
- 分层/依赖方向：偏向 SSOT —— UI→Core→Data 分层，减少 Core 直触 vault/LLM。
- Prompt 槽位与输出：偏向 SSOT（统一 JSON→渲染）；字段顺序/命名/Markdown 渲染规则以现行代码为准。

## 3) 近期执行序列（结合 principles-audit）
1) 正确性/一致性
   - 增量/合并后重算 embedding 并去重（兼容可配置维度）；补 TypeLock 键但保持实现简洁。
   - definition 写入 frontmatter；统一快照入口，仅破坏性操作建快照。
   - 队列恢复改为“加载但不自动执行”；提供 resume 控制。
2) 架构/DRY（audit 对应项）
   - 拆 PipelineOrchestrator 大类：状态/事件、渲染、文件写入/原子化分别下沉服务；复用 frontmatter-utils/naming-utils，删除重复实现。
   - TaskQueue 拆持久化与调度；ProviderManager 请求执行去重（共用 HTTP 执行器）；TaskRunner 只编排，不直接文件/向量。
3) 交互/命令
   - Workbench 默认展开 duplicates；命令文档标注未实现项，先打通 verify/visualize 触发链或标注“待实现”。

## 4) 交付物与文档同步
- 更新 SSOT：记录新增 frontmatter 字段、可配置 embedding 维度、锁简化、命令缺口状态；保留 Prompt 字段顺序以代码为准。
- 输出改动清单与受影响文件；必要时补最小化测试（TaskQueue 调度、Embedding 重算、frontmatter 写入）。

## 5) 风险与依赖
- 大类拆分需分步提交，避免一次性重构；优先围绕文件写入/快照/embedding 路径加回归检查。
- Prompt/Schema 变更需同步 PromptManager/schemaRegistry，防止模型返回与解析不一致。***

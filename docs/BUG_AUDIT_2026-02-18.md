# Cognitive Razor Bug 审计报告（2026-02-18）

## 审计范围
- 代码范围：`src/core/**`、`src/data/**`、`src/ui/**`、`src/ui/svelte/**`、`src/core/frontmatter-utils.ts`、`src/core/task-runner.ts`
- 运行时范围：Obsidian CLI 重载、错误采集、管线 API 触发（`amend`、`updateNoteStatus`）
- 校验命令：
  - `npm run build`（通过，含多条 Svelte 告警）
  - `npm run test`（103/103 通过）
  - `npm run test:coverage`（失败，缺少依赖 `@vitest/coverage-v8`）
  - `obsidian dev:errors`（无加载期错误）
  - `npx knip`（用于检出未接线能力）

---

## 高严重度问题（High）

### 1. Merge 主流程未接线，用户“接受合并”不会触发真正合并
- 证据：
  - `src/core/merge-orchestrator.ts:111`（`startMergePipeline` 定义）
  - `src/ui/svelte/workbench/DuplicatesSection.svelte:93`（仅打开 Diff）
  - `src/ui/svelte/workbench/DuplicatesSection.svelte:100`（`onAccept`）
  - `src/ui/svelte/workbench/DuplicatesSection.svelte:101`（仅日志）
- 现象：UI 点击“对比/接受”没有进入 `MergeOrchestrator.startMergePipeline()`。
- 影响：合并不会实际执行（写入、引用重写、删除被合并笔记、索引清理均不会发生）。

### 2. Amend/Merge 进入 `confirmation_required` 后无消费方，`confirmWrite()` 无调用链
- 证据：
  - `src/core/amend-orchestrator.ts:480`（发布 `confirmation_required`）
  - `src/core/merge-orchestrator.ts:489`（发布 `confirmation_required`）
  - `src/core/amend-orchestrator.ts:160`（`confirmWrite`）
  - `src/core/merge-orchestrator.ts:184`（`confirmWrite`）
  - 全仓检索 `confirmWrite(` 仅命中 orchestrator 内部与 create 自调用：`src/core/create-orchestrator.ts:957`
  - `src/ui/bridge/reactive.svelte.ts:95`（`createPipelineStore` 存在但未被任何 UI 使用）
- 现象：修订/合并的确认阶段没有 UI 或桥接逻辑推进到 `confirmWrite`。
- 影响：流程容易停在待确认状态或变为“只生成不落地”。

### 3. 任务取消语义被覆盖：`Running` 任务取消后可能被改写为 `Failed` 并自动重试
- 证据：
  - `src/core/task-queue.ts:254`（`cancel` 可取消 Running）
  - `src/core/task-queue.ts:734`（失败处理会改状态并可重试）
- 现象：取消后，后续失败回调未识别“已取消”，可能把任务改回 `Failed/Pending`。
- 影响：用户取消失效，任务可能继续重试执行。

### 4. 任务执行异常路径不触发重新调度，可能导致队列挂起
- 证据：
  - `src/core/task-queue.ts:841`（`handleTaskExecutionFailure`）
  - 该方法末尾发布 `task-failed` 但没有 `this.tryScheduleAll()`（对比 `handleTaskFailure` 会调度，见 `src/core/task-queue.ts:835`）
- 现象：未预期异常分支释放了并发槽，但不继续调度下一个 Pending。
- 影响：并发槽空闲却不推进队列，表现为“队列卡住”。

---

## 中严重度问题（Medium）

### 5. `updateNoteStatus()` 存在“返回成功但未更新”假成功
- 证据：
  - `src/core/task-runner.ts:386`（`updateNoteStatus`）
  - `src/core/task-runner.ts:409`（frontmatter 正则）
  - `src/core/task-runner.ts:418`（仅替换已存在 `status:`）
  - `src/core/task-runner.ts:423`（仅替换已存在 `updated:`）
- 复现：对缺少 `status` 或 `updated` 字段的笔记调用 `updateNoteStatus`，返回 `ok`，内容不变。
- 影响：状态机与文件状态漂移。

### 6. Frontmatter/状态更新对 CRLF 不兼容（Windows 风险）
- 证据：
  - `src/core/frontmatter-utils.ts:285`（`content.startsWith('---\n')`）
  - `src/core/frontmatter-utils.ts:289`（按 `\n` 切分）
  - `src/core/task-runner.ts:409`（仅 `\n` frontmatter 正则）
- 复现：
  - 对 CRLF 笔记启动 `amend`，管线失败并报“无法解析目标笔记的 frontmatter”。
  - 对 CRLF 笔记执行 `updateNoteStatus`，返回 `ok` 但字段不更新。
- 影响：跨平台文本换行下流程失效。

### 7. 设置加载先校验再回填默认值，旧数据可能被整包重置
- 证据：
  - `src/data/settings-store.ts:298`（`loadSettings`）
  - `src/data/settings-store.ts:321`（先 `validateSettingsDetailed(data)`）
  - `src/data/settings-store.ts:330`、`src/data/settings-store.ts:331`（后 `mergeSettings` / `ensureBackwardCompatibility`）
- 现象：旧版本缺少新必填字段时，可能直接判 invalid 并重置为默认设置。
- 影响：用户配置丢失风险。

### 8. 重复检测结果写盘失败未处理，可能“内存有、重启丢”
- 证据：
  - `src/core/duplicate-manager.ts:215`（`await this.saveStore()` 但不检查返回）
- 现象：保存失败后仍继续流程，不上抛错误。
- 影响：新重复对只存在内存，重启后丢失。

### 9. 重复对存储非原子写，崩溃时可能损坏 `duplicate-pairs.json`
- 证据：
  - `src/core/duplicate-manager.ts:654`（`saveStore`）
  - `src/core/duplicate-manager.ts:659`（使用 `fileStorage.write`，非 `atomicWrite`）
- 影响：中途写入失败可能产生损坏 JSON，后续初始化回退空存储。

### 10. 向量文件与索引元数据写入非原子，可能导致索引/文件不一致
- 证据：
  - `src/data/file-storage.ts:494`（`writeVectorFile`）
  - `src/data/file-storage.ts:501`（直接 `write`）
  - `src/data/file-storage.ts:570`、`src/data/file-storage.ts:572`（`writeVectorIndexMeta` 直接 `write`）
- 影响：中断时产生半写入文件，向量读取失败或元数据不一致。

### 11. 设置导入异常分支错误提示“成功”
- 证据：
  - `src/ui/svelte/settings/SystemTab.svelte:92`（成功提示）
  - `src/ui/svelte/settings/SystemTab.svelte:97`（`catch` 仍提示成功）
- 影响：用户误判导入成功。

### 12. 历史区失败提示复用成功文案键
- 证据：
  - `src/ui/svelte/workbench/HistorySection.svelte:185`（失败分支仍用 `recentOps.undo`）
  - `src/ui/svelte/workbench/HistorySection.svelte:203`（失败分支仍用 `recentOps.clearAll`）
- 影响：失败时用户看到“成功语义”提示。

### 13. 日志级别提示占位符未插值（`{level}` 原样显示）
- 证据：
  - `src/ui/svelte/settings/SystemTab.svelte:57`（`i18n.t('notices.logLevelChanged', { level })`）
  - `src/core/i18n.ts:87`、`src/core/i18n.ts:89`（`t` 不接收插值参数）
  - `src/core/i18n.ts:104`（应使用 `format`）
- 影响：提示文本错误，影响可用性。

### 14. 多个设置页忽略 `settingsStore.update()` 返回值，可能静默失败并造成 UI/持久化不一致
- 证据（示例）：
  - `src/ui/svelte/settings/GeneralTab.svelte:52`（未检查返回）
  - `src/ui/svelte/settings/GeneralTab.svelte:53`（即便保存失败仍切换界面语言）
- 影响：保存失败时 UI 已变化，但磁盘设置未落地。

### 15. 队列“重试成功”提示文案使用 `retryFailed`
- 证据：
  - `src/ui/svelte/workbench/QueueSection.svelte:124`
- 影响：用户看到“重试失败 (N)”样式文本，语义混乱。

### 16. Create 管线对索引/去重结果静默忽略
- 证据：
  - `src/core/create-orchestrator.ts:868`（`await vectorIndex.upsert(...)` 未检查 `Result`）
  - `src/core/create-orchestrator.ts:879`（`await duplicateManager.detect(...)` 未检查 `Result`）
- 现象：索引或去重失败时，管线仍按成功继续。
- 影响：UI 显示创建成功，但索引与重复对状态可能不一致。

---

## 低严重度/潜在问题（Low/Potential）

### 17. DiffRoot 存在 Svelte rune 冲突告警，可能导致合并名称状态不同步
- 证据：
  - `src/ui/svelte/diff/DiffRoot.svelte:21`（props 变量名 `state`）
  - `src/ui/svelte/diff/DiffRoot.svelte:39`（`$state` rune）
  - `src/ui/svelte/diff/DiffRoot.svelte:53`（读取 `selectedName` 提交）
- 构建告警：`store_rune_conflict`、`non_reactive_update`
- 影响：合并名称提交可能出现陈旧值/空值风险。

### 18. 测试覆盖率流程不可用（测试盲区）
- 证据：
  - `npm run test:coverage` 失败：缺少依赖 `@vitest/coverage-v8`
  - `npx knip` 同步报出 `Unlisted dependency: @vitest/coverage-v8`
- 影响：无法量化回归覆盖，降低“已修复问题不再复发”的验证能力。

---

## 已执行运行时复现（摘要）
- `updateNoteStatus`：
  - 对缺 `status/updated` 的笔记调用，返回 `ok`，内容未变（已复现）。
  - 对 CRLF 笔记调用，返回 `ok`，内容未变（已复现）。
- `amend`：
  - 对 CRLF frontmatter 笔记启动 `startAmendPipeline`，上下文进入 `failed`，错误为 frontmatter 解析失败（已复现）。

---

## 当前结论
- 已定位到 18 项“明显或高概率潜在”问题，覆盖：流程接线、状态机、持久化原子性、跨平台兼容、错误提示一致性。
- 当前未再发现新的高影响入口级问题；后续建议按 High → Medium 顺序修复并补回归测试。

# Cognitive Razor 故障排除指南

本指南帮助你诊断和解决使用 Cognitive Razor 时遇到的常见问题。

## 🔍 诊断工具

### 查看日志

日志文件位于：`<vault>/.obsidian/plugins/obsidian-cognitive-razor/data/logs/`

**查看方法**：
```bash
# 查看最新日志
cat <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/logs/latest.log

# 实时监控日志
tail -f <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/logs/latest.log
```

### 打开开发者控制台

在 Obsidian 中按 `Ctrl/Cmd + Shift + I` 打开开发者工具，查看控制台错误信息。

### 检查插件状态

1. 打开设置 → 社区插件
2. 确认 Cognitive Razor 已启用
3. 查看插件版本号

## 🚨 常见问题和解决方案

### 问题 1: 插件无法加载

**症状**：
- 插件列表中看不到 Cognitive Razor
- 启用后立即禁用
- 控制台显示加载错误

**可能原因和解决方案**：

#### 原因 A: Obsidian 版本过低

**检查**：
```
设置 → 关于 → 当前版本
```

**解决**：
- 升级 Obsidian 到 1.0.0 或更高版本

#### 原因 B: 插件文件不完整

**检查**：
```bash
ls <vault>/.obsidian/plugins/obsidian-cognitive-razor/
# 应该包含: main.js, manifest.json, styles.css
```

**解决**：
1. 删除插件目录
2. 重新安装插件

#### 原因 C: 文件权限问题

**检查**：
```bash
ls -la <vault>/.obsidian/plugins/obsidian-cognitive-razor/
```

**解决**：
```bash
chmod -R 755 <vault>/.obsidian/plugins/obsidian-cognitive-razor/
```

#### 原因 D: 依赖冲突

**解决**：
1. 禁用其他插件
2. 逐个启用，找出冲突的插件
3. 报告 Bug

### 问题 2: API 调用失败

**症状**：
- 任务一直失败
- 显示 "API Error"
- 控制台显示网络错误

**可能原因和解决方案**：

#### 原因 A: API Key 无效

**检查**：
```
设置 → Cognitive Razor → Provider 配置 → 测试连接
```

**解决**：
1. 访问 Provider 控制台
2. 检查 API Key 是否有效
3. 重新生成 API Key
4. 在插件设置中更新

#### 原因 B: 网络连接问题

**检查**：
```bash
# 测试网络连接
ping google.com

# 测试 API 端点（OpenAI）
curl https://api.openai.com/v1/models

# 测试 API 端点（Gemini）
curl https://generativelanguage.googleapis.com/v1/models
```

**解决**：
1. 检查网络连接
2. 检查防火墙设置
3. 检查代理配置
4. 尝试使用 VPN（访问 OpenAI 可能需要）

#### 原因 C: API 配额耗尽

**检查**：
- 访问 Provider 控制台查看配额使用情况

**解决**：
1. 等待配额重置
2. 升级 API 计划
3. 更换 Provider

#### 原因 D: 速率限制

**症状**：
- 错误码 429
- 日志显示 "Rate limit exceeded"

**解决**：
1. 降低并发任务数（设置 → 并发任务数）
2. 等待一段时间后重试
3. 升级 API 计划

#### 原因 E: 自定义端点配置错误

**症状**：
- 使用自定义端点时连接失败
- 错误信息显示 "Invalid URL" 或 "Connection refused"

**检查**：
1. 确认端点 URL 格式正确
2. 确认服务已启动（本地服务）
3. 确认端口号正确

**解决**：

**对于 OpenRouter**：
```
端点：https://openrouter.ai/api/v1
API Key：你的 OpenRouter API Key
模型：anthropic/claude-3-opus（或其他支持的模型）
```

**对于 Ollama**：
```bash
# 1. 确认 Ollama 已启动
ollama serve

# 2. 确认模型已拉取
ollama list

# 3. 在插件中配置
端点：http://localhost:11434/v1
API Key：ollama（任意值）
模型：llama2（或你拉取的模型名称）
```

**对于 LM Studio**：
```
# 1. 在 LM Studio 中启动本地服务器
# 2. 记下端口号（通常是 1234）
# 3. 在插件中配置
端点：http://localhost:1234/v1
API Key：lmstudio（任意值）
模型：LM Studio 中显示的模型名称
```

**对于 Azure OpenAI**：
```
端点：https://your-resource.openai.azure.com/openai/deployments/your-deployment
API Key：你的 Azure API Key
模型：你的部署名称
```

**调试步骤**：

1. **测试端点连通性**：
   ```bash
   # 测试 OpenRouter
   curl https://openrouter.ai/api/v1/models
   
   # 测试本地 Ollama
   curl http://localhost:11434/v1/models
   
   # 测试本地 LM Studio
   curl http://localhost:1234/v1/models
   ```

2. **检查防火墙**：
   - Windows：检查 Windows Defender 防火墙
   - macOS：检查系统偏好设置 → 安全性与隐私 → 防火墙
   - Linux：检查 iptables 或 ufw 规则

3. **查看详细日志**：
   ```
   .obsidian/plugins/obsidian-cognitive-razor/data/logs/latest.log
   ```

4. **使用开发者工具**：
   - 按 `Ctrl/Cmd + Shift + I` 打开开发者工具
   - 切换到 Network 标签
   - 尝试测试连接
   - 查看请求和响应详情

### 问题 3: 概念创建失败

**症状**：
- 标准化后无法创建笔记
- 显示 "创建失败"
- 任务状态为 Failed

**可能原因和解决方案**：

#### 原因 A: 文件名冲突

**检查**：
- 查看是否已存在同名笔记

**解决**：
1. 重命名现有笔记
2. 或使用不同的概念名称

#### 原因 B: 文件系统权限

**检查**：
```bash
ls -la <vault>/
```

**解决**：
```bash
chmod -R 755 <vault>/
```

#### 原因 C: 磁盘空间不足

**检查**：
```bash
df -h
```

**解决**：
- 清理磁盘空间

#### 原因 D: 内容验证失败

**症状**：
- 日志显示 "Schema violation" 或 "Constraint violation"

**解决**：
1. 查看日志了解具体错误
2. 尝试重新生成内容
3. 如果持续失败，报告 Bug

### 问题 4: 去重检测不准确

**症状**：
- 明显重复的概念未被检测
- 不相关的概念被标记为重复

**可能原因和解决方案**：

#### 原因 A: 阈值设置不当

**解决**：
```
设置 → Cognitive Razor → 去重阈值
```
- 误报过多：提高阈值（0.95+）
- 漏报过多：降低阈值（0.85-）

#### 原因 B: 向量索引未更新

**解决**：
1. 重启插件
2. 或手动刷新索引：
   ```
   设置 → Cognitive Razor → 重建向量索引
   ```

#### 原因 C: 类型不匹配

**检查**：
- 确认两个概念的类型是否相同

**说明**：
- 系统只在同类型概念中检测重复
- 这是设计决策，不是 Bug

#### 原因 D: 向量索引损坏

**症状**：
- 所有概念都被标记为重复
- 或完全没有重复检测

**解决**：
1. 备份 `data/vector-index.json`
2. 删除该文件
3. 重启插件
4. 系统会自动重建索引

### 问题 5: 任务队列卡住

**症状**：
- 任务一直显示 "进行中"
- 队列不再处理新任务
- 状态栏任务计数不变

**可能原因和解决方案**：

#### 原因 A: 任务超时

**解决**：
1. 取消卡住的任务
2. 重启插件
3. 重新提交任务

#### 原因 B: 锁未释放

**症状**：
- 新任务显示 "锁冲突"
- 但没有任务在执行

**解决**：
1. 重启插件（会自动清理所有锁）
2. 或手动清理：
   ```
   设置 → Cognitive Razor → 清理所有锁
   ```

#### 原因 C: 队列状态损坏

**解决**：
1. 备份 `data/queue-state.json`
2. 删除该文件
3. 重启插件

### 问题 6: 撤销功能不工作

**症状**：
- 点击撤销按钮无反应
- 操作历史为空
- 撤销后内容未恢复

**可能原因和解决方案**：

#### 原因 A: 快照已过期

**说明**：
- 快照只保留 100 个
- 超过会自动清理

**解决**：
- 无法恢复，建议及时撤销

#### 原因 B: 快照文件损坏

**检查**：
```bash
ls <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/snapshots/
```

**解决**：
1. 尝试手动恢复快照文件
2. 或从 Obsidian 的文件历史恢复

#### 原因 C: 文件已被删除

**说明**：
- 如果原文件已被删除，无法撤销

**解决**：
- 从快照目录手动恢复

### 问题 7: 内容生成质量差

**症状**：
- 生成的内容不准确
- 内容过于简短
- 内容格式错误

**可能原因和解决方案**：

#### 原因 A: 概念描述不清晰

**解决**：
- 提供更详细、准确的概念描述
- 包含关键信息和上下文

#### 原因 B: 模型选择不当

**解决**：
```
设置 → Cognitive Razor → Provider 配置 → 模型
```
- 尝试更强大的模型（如 GPT-4）

#### 原因 C: 提示词模板需要优化

**解决**（高级）：
1. 打开 `prompts/` 目录
2. 编辑对应的提示词模板
3. 重启插件

#### 原因 D: AI 模型的固有限制

**说明**：
- AI 生成的内容可能存在错误
- 需要人工审查和修改

**解决**：
1. 使用增量改进功能逐步完善
2. 手动编辑生成的内容

### 问题 8: 性能问题

**症状**：
- Obsidian 变慢
- 插件响应缓慢
- 任务执行很慢

**可能原因和解决方案**：

#### 原因 A: 并发任务过多

**解决**：
```
设置 → Cognitive Razor → 并发任务数
```
- 降低到 1-2

#### 原因 B: 向量索引过大

**检查**：
```bash
du -h <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/vector-index.json
```

**解决**：
- 如果超过 10 MB，考虑清理不需要的概念

#### 原因 C: 日志文件过多

**检查**：
```bash
ls -lh <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/logs/
```

**解决**：
```bash
rm <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/logs/*.log
```

#### 原因 D: 快照过多

**解决**：
```
设置 → Cognitive Razor → 清理快照
```

### 问题 9: 数据丢失

**症状**：
- 配置丢失
- 向量索引丢失
- 任务历史丢失

**可能原因和解决方案**：

#### 原因 A: 文件被意外删除

**解决**：
1. 检查回收站
2. 从备份恢复
3. 使用文件恢复工具

#### 原因 B: 文件系统错误

**检查**：
```bash
# Windows
chkdsk /f

# macOS/Linux
fsck
```

#### 原因 C: 同步冲突

**说明**：
- 如果使用云同步（如 iCloud、Dropbox），可能导致文件冲突

**解决**：
1. 暂停云同步
2. 手动解决冲突
3. 重启插件

### 问题 10: 自定义端点连接问题

**症状**：
- 配置自定义端点后无法连接
- 测试连接失败
- 任务执行时报错

**可能原因和解决方案**：

#### 原因 A: URL 格式错误

**检查**：
- URL 必须以 `http://` 或 `https://` 开头
- URL 必须是有效格式

**常见错误**：
```
❌ 错误：localhost:11434
✅ 正确：http://localhost:11434/v1

❌ 错误：openrouter.ai/api/v1
✅ 正确：https://openrouter.ai/api/v1

❌ 错误：http://localhost:11434
✅ 正确：http://localhost:11434/v1（注意 /v1 后缀）
```

#### 原因 B: 本地服务未启动

**检查**：
```bash
# 检查 Ollama
curl http://localhost:11434/v1/models

# 检查 LM Studio
curl http://localhost:1234/v1/models

# 检查端口是否被占用
netstat -an | findstr "11434"  # Windows
lsof -i :11434                  # macOS/Linux
```

**解决**：
1. 启动对应的本地服务
2. 确认服务监听正确的端口
3. 检查服务日志了解启动问题

#### 原因 C: 防火墙阻止

**检查**：
- Windows Defender 防火墙设置
- 第三方防火墙软件设置
- 路由器防火墙设置

**解决**：
1. 添加例外规则允许本地服务
2. 临时禁用防火墙测试（测试后记得重新启用）

#### 原因 D: CORS 问题

**症状**：
- 浏览器控制台显示 CORS 错误
- 本地服务可以访问但插件无法连接

**解决**：
1. 配置本地服务允许 CORS
2. Ollama 通常不需要额外配置
3. LM Studio 在设置中启用 CORS

#### 原因 E: 模型名称错误

**检查**：
```bash
# 列出 Ollama 可用模型
ollama list

# 测试模型是否可用
ollama run llama2 "test"
```

**解决**：
1. 确认模型名称与服务中的完全一致
2. OpenRouter 模型格式：`provider/model-name`
3. 本地模型使用 `ollama list` 显示的名称

#### 原因 F: API 兼容性问题

**症状**：
- 连接成功但任务失败
- 返回格式错误

**解决**：
1. 确认服务实现了 OpenAI 兼容的 API
2. 检查 API 版本是否匹配
3. 查看服务文档了解 API 差异
4. 某些功能可能不被所有服务支持

### 问题 11: 键盘快捷键不工作

**症状**：
- `Ctrl/Cmd + Shift + N` 无反应
- `Ctrl/Cmd + Shift + Q` 无反应

**可能原因和解决方案**：

#### 原因 A: 快捷键冲突

**检查**：
```
设置 → 快捷键 → 搜索 "Cognitive Razor"
```

**解决**：
- 修改冲突的快捷键

#### 原因 B: 插件未正确加载

**解决**：
- 重启 Obsidian

## 🔧 高级故障排除

### 完全重置插件

如果所有方法都无效，可以完全重置插件：

**警告**：这会删除所有配置和数据！

```bash
# 1. 备份数据
cp -r <vault>/.obsidian/plugins/obsidian-cognitive-razor/data/ ~/backup/

# 2. 删除插件
rm -rf <vault>/.obsidian/plugins/obsidian-cognitive-razor/

# 3. 重启 Obsidian

# 4. 重新安装插件
```

### 手动修复数据文件

#### 修复 settings.json

```json
{
  "provider": "gemini",
  "apiKey": "your-api-key",
  "model": "gemini-pro",
  "duplicateThreshold": 0.9,
  "maxConcurrentTasks": 2,
  "maxSnapshots": 100,
  "maxRetries": 3,
  "advancedMode": false
}
```

#### 修复 vector-index.json

```json
{
  "version": "1.0.0",
  "entries": [],
  "stats": {
    "totalEntries": 0,
    "byType": {
      "Domain": 0,
      "Issue": 0,
      "Theory": 0,
      "Entity": 0,
      "Mechanism": 0
    }
  }
}
```

#### 修复 queue-state.json

```json
{
  "version": "1.0.0",
  "tasks": [],
  "paused": false
}
```

### 启用调试模式

在开发者控制台中运行：

```javascript
// 启用详细日志
app.plugins.plugins['obsidian-cognitive-razor'].settings.logLevel = 'debug';

// 查看内部状态
console.log(app.plugins.plugins['obsidian-cognitive-razor']);
```

## 📊 性能优化建议

### 1. 优化配置

```
设置 → Cognitive Razor
```

- **并发任务数**: 1-2（降低 API 压力）
- **去重阈值**: 0.9（平衡准确性和性能）
- **快照上限**: 50（减少存储占用）

### 2. 定期维护

每月执行：

1. 清理旧快照
2. 清理日志文件
3. 检查向量索引大小
4. 备份数据

### 3. 使用更快的 Provider

性能排序（从快到慢）：

1. Google Gemini（推荐）
2. OpenAI GPT-3.5
3. OpenAI GPT-4
4. OpenRouter（取决于模型）

## 🐛 报告 Bug

如果问题仍未解决，请报告 Bug：

### 收集信息

1. **插件版本**：设置 → 社区插件 → Cognitive Razor
2. **Obsidian 版本**：设置 → 关于
3. **操作系统**：Windows/macOS/Linux + 版本
4. **错误信息**：控制台截图
5. **日志文件**：`data/logs/latest.log`

### 提交 Issue

访问 [GitHub Issues](https://github.com/your-username/obsidian-cognitive-razor/issues)

**Issue 模板**：

```markdown
## 问题描述
[简要描述问题]

## 复现步骤
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

## 预期行为
[描述预期的正确行为]

## 实际行为
[描述实际发生的情况]

## 环境信息
- 插件版本: [版本号]
- Obsidian 版本: [版本号]
- 操作系统: [系统 + 版本]

## 错误信息
[粘贴控制台错误或日志]

## 附加信息
[其他相关信息]
```

## 💬 获取帮助

- 📖 [快速开始指南](快速开始指南.md)
- ❓ [常见问题解答](常见问题解答.md)
- 💬 [讨论区](https://github.com/your-username/obsidian-cognitive-razor/discussions)
- 🐛 [报告 Bug](https://github.com/your-username/obsidian-cognitive-razor/issues)

---

**还有问题？** 欢迎在讨论区提问，我们会尽快回复！

# ç³»ç»Ÿæ¶æ„ä¸è¯¦ç»†è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: 0.9.3  
**æœ€åæ›´æ–°**: 2025-12-11  
**é¡¹ç›®**: obsidian-cognitive-razor

> **æ–‡æ¡£è¯´æ˜**ï¼šæœ¬æ–‡æ¡£æè¿° Cognitive Razor æ’ä»¶çš„å®Œæ•´æŠ€æœ¯æ¶æ„ã€è®¾è®¡å†³ç­–å’Œå®ç°ç»†èŠ‚ã€‚æ–‡æ¡£å†…å®¹ä¸ä»£ç åº“ä¿æŒåŒæ­¥ï¼Œæ‰€æœ‰æ¶æ„å›¾ã€æ•°æ®ç»“æ„å’Œæµç¨‹æè¿°å‡åŸºäºå®é™…ä»£ç å®ç°ï¼ˆç‰ˆæœ¬ 0.9.3ï¼‰ã€‚æœ¬æ–‡æ¡£éµå¾ª `.kiro/steering/` ä¸­å®šä¹‰çš„é¡¹ç›®è§„èŒƒå’ŒæŠ€æœ¯æ ˆè¦æ±‚ã€‚
> 
> **ğŸ“– ä½¿ç”¨æç¤º**ï¼šæœ¬æ–‡æ¡£çº¦ 13,000 è¡Œï¼Œè¯·å‚è€ƒ `.kiro/steering/documentation-guide.md` äº†è§£å¦‚ä½•é«˜æ•ˆä½¿ç”¨ã€‚

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
   - 1.1 [é¡¹ç›®ç®€ä»‹](#11-é¡¹ç›®ç®€ä»‹)
   - 1.2 [æ ¸å¿ƒåŠŸèƒ½](#12-æ ¸å¿ƒåŠŸèƒ½)
   - 1.3 [è®¾è®¡å“²å­¦](#13-è®¾è®¡å“²å­¦)

2. [æŠ€æœ¯æ ˆ](#2-æŠ€æœ¯æ ˆ)
   - 2.1 [æ ¸å¿ƒä¾èµ–](#21-æ ¸å¿ƒä¾èµ–)
   - 2.2 [å¼€å‘å·¥å…·](#22-å¼€å‘å·¥å…·)
   - 2.3 [ç‰ˆæœ¬è¦æ±‚](#23-ç‰ˆæœ¬è¦æ±‚)

3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
   - 3.1 [ä¸‰å±‚æ¶æ„æ¦‚è¿°](#31-ä¸‰å±‚æ¶æ„æ¦‚è¿°)
   - 3.2 [ç»„ä»¶ä¾èµ–å…³ç³»](#32-ç»„ä»¶ä¾èµ–å…³ç³»)
   - 3.3 [æ•°æ®æµå‘](#33-æ•°æ®æµå‘)

4. [æ•°æ®å±‚è®¾è®¡](#4-æ•°æ®å±‚è®¾è®¡)
   - 4.1 [FileStorage](#41-filestorage)
   - 4.2 [Logger](#42-logger)
   - 4.3 [SettingsStore](#43-settingsstore)
   - 4.4 [Validator](#44-validator)

5. [åº”ç”¨å±‚è®¾è®¡](#5-åº”ç”¨å±‚è®¾è®¡)
   - 5.1 [TaskQueue](#51-taskqueue)
   - 5.2 [TaskRunner](#52-taskrunner)
   - 5.3 [VectorIndex](#53-vectorindex)
   - 5.4 [LockManager](#54-lockmanager)
   - 5.5 [UndoManager](#55-undomanager)
   - 5.6 [ProviderManager](#56-providermanager)
   - 5.7 [PromptManager](#57-promptmanager)
   - 5.8 [DuplicateManager](#58-duplicatemanager)
   - 5.9 [PipelineOrchestrator](#59-pipelineorchestrator)

6. [UIå±‚è®¾è®¡](#6-uiå±‚è®¾è®¡)
   - 6.1 [WorkbenchPanel](#61-workbenchpanel)
   - 6.2 [StatusBadge](#62-statusbadge)
   - 6.3 [CommandDispatcher](#63-commanddispatcher)
   - 6.4 [SettingsTab](#64-settingstab)

7. [æ ¸å¿ƒæµç¨‹](#7-æ ¸å¿ƒæµç¨‹)
   - 7.1 [æ¦‚å¿µåˆ›å»ºæµç¨‹](#71-æ¦‚å¿µåˆ›å»ºæµç¨‹)
   - 7.2 [ä»»åŠ¡è°ƒåº¦æµç¨‹](#72-ä»»åŠ¡è°ƒåº¦æµç¨‹)
   - 7.3 [å»é‡æ£€æµ‹æµç¨‹](#73-å»é‡æ£€æµ‹æµç¨‹)
   - 7.4 [æ’¤é”€æ¢å¤æµç¨‹](#74-æ’¤é”€æ¢å¤æµç¨‹)
   - 7.5 [ç®¡çº¿ç¼–æ’æµç¨‹](#75-ç®¡çº¿ç¼–æ’æµç¨‹)

8. [æ•°æ®æ¨¡å‹](#8-æ•°æ®æ¨¡å‹)
   - 8.1 [Frontmatter ç»“æ„](#81-frontmatter-ç»“æ„)
   - 8.2 [ä»»åŠ¡è®°å½•ç»“æ„](#82-ä»»åŠ¡è®°å½•ç»“æ„)
   - 8.3 [å‘é‡ç´¢å¼•ç»“æ„](#83-å‘é‡ç´¢å¼•ç»“æ„)
   - 8.4 [é‡å¤å¯¹ç»“æ„](#84-é‡å¤å¯¹ç»“æ„)
   - 8.5 [é…ç½®ç»“æ„](#85-é…ç½®ç»“æ„)

9. [é”™è¯¯å¤„ç†](#9-é”™è¯¯å¤„ç†)
   - 9.1 [é”™è¯¯åˆ†ç±»](#91-é”™è¯¯åˆ†ç±»)
   - 9.2 [é‡è¯•ç­–ç•¥](#92-é‡è¯•ç­–ç•¥)
   - 9.3 [Result Monad](#93-result-monad)
   - 9.4 [æ—¥å¿—è®°å½•](#94-æ—¥å¿—è®°å½•)
   - 9.5 [ç”¨æˆ·é€šçŸ¥](#95-ç”¨æˆ·é€šçŸ¥)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

**Cognitive Razor** æ˜¯ä¸€ä¸ªä¸º Obsidian è®¾è®¡çš„ AI é©±åŠ¨çŸ¥è¯†ç®¡ç†æ’ä»¶ï¼Œæ—¨åœ¨è§£å†³æ•°å­—è®¤çŸ¥ç³»ç»Ÿä¸­çš„"æ¦‚å¿µè€—æ•£ä¸ä¸»æƒä¸§å¤±"é—®é¢˜ã€‚è¯¥æ’ä»¶é€šè¿‡ä¸¥æ ¼çš„æœ¬ä½“è®ºçº¦æŸå’Œç®—æ³•åŒ–çš„é™ç†µä»ªå¼ï¼Œå°†æ¨¡ç³Šçš„æ¦‚å¿µè½¬åŒ–ä¸ºç»“æ„åŒ–çš„çŸ¥è¯†èŠ‚ç‚¹ï¼Œç¡®ä¿æ¯ä¸ªæ¦‚å¿µåœ¨ç³»ç»Ÿä¸­æ‹¥æœ‰å”¯ä¸€çš„èº«ä»½ã€å¯éªŒè¯çš„å­˜åœ¨å’Œå®Œæ•´çš„è°±ç³»ã€‚

æ’ä»¶çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

- **å”¯ä¸€æ€§ä¿éšœ**ï¼šé€šè¿‡ UID å’Œè¯­ä¹‰å‘é‡åµŒå…¥ï¼Œç¡®ä¿çŸ¥è¯†åº“ä¸­ä¸å­˜åœ¨é‡å¤æ¦‚å¿µ
- **ä¸»æƒå›å½’**ï¼šæ‰€æœ‰å†™å…¥æ“ä½œå¿…é¡»ç»è¿‡äººç±»æ˜¾å¼ç¡®è®¤ï¼ŒAI ä»…ä½œä¸ºå»ºè®®è€…è€Œéå†³ç­–è€…
- **å¯é€†æ€§è®¾è®¡**ï¼šå¢é‡æ”¹è¿›å’Œåˆå¹¶æ“ä½œå‰è‡ªåŠ¨åˆ›å»ºå¿«ç…§ï¼Œæ”¯æŒæ— æŸæ’¤é”€æ“ä½œï¼ˆæ–°å»ºæ¦‚å¿µæ— éœ€å¿«ç…§ï¼‰
- **é€æ˜åŒ–æµç¨‹**ï¼šæ‰€æœ‰åå°ä»»åŠ¡ã€çŠ¶æ€è½¬æ¢å’Œé”™è¯¯ä¿¡æ¯åœ¨ UI ä¸Šå®æ—¶å¯è§

Cognitive Razor ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œæ›´æ˜¯ä¸€å¥—å…³äº"æ¦‚å¿µå¦‚ä½•åœ¨æ•°å­—ç³»ç»Ÿä¸­åˆæ³•é™ç”Ÿ"çš„ç³»ç»Ÿæ–¹æ³•è®ºã€‚å®ƒå»ºç«‹åœ¨å…­é¡¹ç¬¬ä¸€æ€§åŸç†ï¼ˆå­˜åœ¨åŸç†ã€å¯åˆ¤å®šåŸç†ã€å¯é€†åŸç†ã€é€æ˜åŸç†ã€äººæœºå…±è£åŸç†ã€ä¸»æƒåŸç†ï¼‰å’Œåäº”æ¡æ ¸å¿ƒå…¬ç†ä¹‹ä¸Šï¼Œç¡®ä¿ç³»ç»Ÿçš„æ¯ä¸€ä¸ªè®¾è®¡å†³ç­–éƒ½æœ‰åšå®çš„å“²å­¦åŸºç¡€ã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

Cognitive Razor æä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š

#### 1. æ¦‚å¿µåˆ›å»ºä¸æ ‡å‡†åŒ–
- **æ™ºèƒ½æ ‡å‡†åŒ–**ï¼šå°†ç”¨æˆ·è¾“å…¥çš„æ¨¡ç³Šæè¿°è½¬åŒ–ä¸ºç¬¦åˆæœ¬ä½“è®ºè§„èŒƒçš„æ ‡å‡†æ¦‚å¿µ
- **ç±»å‹è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«æ¦‚å¿µç±»å‹ï¼ˆDomainã€Issueã€Theoryã€Entityã€Mechanismï¼‰
- **åˆ«åæ‰©å±•**ï¼šåˆ©ç”¨ AI ç”Ÿæˆæ¦‚å¿µçš„æ‰€æœ‰å¯èƒ½ç§°å‘¼ï¼ˆå…¨ç§°ã€ç®€ç§°ã€ä¿—ç§°ã€å¤–æ–‡åï¼‰
- **è°±ç³»å»ºç«‹**ï¼šè‡ªåŠ¨å»ºç«‹æ¦‚å¿µçš„çˆ¶å­å…³ç³»ï¼Œç¡®ä¿çŸ¥è¯†å›¾è°±çš„å±‚çº§ç»“æ„

#### 2. è¯­ä¹‰å»é‡ä¸åˆå¹¶
- **å‘é‡åµŒå…¥**ï¼šå°†æ¦‚å¿µæ˜ å°„åˆ°é«˜ç»´è¯­ä¹‰ç©ºé—´ï¼Œå®ç°ç²¾ç¡®çš„ç›¸ä¼¼åº¦è®¡ç®—
- **åˆ†æ¡¶æ£€ç´¢**ï¼šæŒ‰æ¦‚å¿µç±»å‹åˆ†æ¡¶ï¼Œé¿å…è·¨ç±»å‹è¯¯åˆ¤ï¼ˆå¦‚"è‹¹æœå…¬å¸"ä¸"è‹¹æœæ°´æœ"ï¼‰
- **åŒé‡é˜ˆå€¼**ï¼š
  - é˜»æ–­é˜ˆå€¼ï¼ˆ>0.95ï¼‰ï¼šè‡ªåŠ¨æ‹’ç»æé«˜ç›¸ä¼¼åº¦çš„é‡å¤æ¦‚å¿µ
  - æç¤ºé˜ˆå€¼ï¼ˆ>0.85ï¼‰ï¼šå°†ç–‘ä¼¼é‡å¤æäº¤äººç±»è£å†³
- **æ™ºèƒ½åˆå¹¶**ï¼šæ”¯æŒå°†é‡å¤æ¦‚å¿µåˆå¹¶ï¼Œä¿ç•™å®Œæ•´çš„åˆå¹¶å†å²

#### 3. å¢é‡æ”¹è¿›ä¸å†…å®¹ç”Ÿæˆ
- **æ¸è¿›å¼å¡«å……**ï¼šä» Stubï¼ˆå­˜æ ¹ï¼‰â†’ Draftï¼ˆè‰ç¨¿ï¼‰â†’ Evergreenï¼ˆå¸¸é’ï¼‰çš„æˆç†Ÿåº¦æ¼”åŒ–
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šåŸºäºæ¦‚å¿µçš„ç±»å‹ã€è°±ç³»å’Œé¢†åŸŸçŸ¥è¯†ç”Ÿæˆé«˜è´¨é‡å†…å®¹
- **å¤šè½®æ¨ç†**ï¼šæ”¯æŒé’ˆå¯¹ä¸åŒç»´åº¦ï¼ˆé¢†åŸŸã€è®®é¢˜ã€ç†è®ºã€å®ä½“ã€æœºåˆ¶ï¼‰çš„ä¸“é¡¹æ¨ç†
- **äººç±»ç¡®è®¤**ï¼šæ‰€æœ‰ AI ç”Ÿæˆçš„å†…å®¹å¿…é¡»ç»è¿‡äººç±»å®¡æ ¸åæ‰èƒ½å†™å…¥

#### 4. ä»»åŠ¡é˜Ÿåˆ—ä¸å¹¶å‘æ§åˆ¶
- **å…¨å±€é˜Ÿåˆ—**ï¼šæ‰€æœ‰å†™å…¥æ“ä½œè¿›å…¥ç»Ÿä¸€é˜Ÿåˆ—ï¼Œç¡®ä¿æ“ä½œçš„ä¸²è¡ŒåŒ–
- **é”æœºåˆ¶**ï¼šæ”¯æŒèŠ‚ç‚¹é”å’Œç±»å‹é”ï¼Œé˜²æ­¢å¹¶å‘å†²çª
- **çŠ¶æ€ç®¡ç†**ï¼šå®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆPending â†’ Running â†’ Awaiting â†’ Confirm â†’ Completedï¼‰
- **æŒä¹…åŒ–**ï¼šé˜Ÿåˆ—çŠ¶æ€æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ”¯æŒæ–­ç”µæ¢å¤

#### 5. æ’¤é”€ä¸å¿«ç…§ç®¡ç†
- **é€‰æ‹©æ€§å¿«ç…§**ï¼šä»…åœ¨å¢é‡æ”¹è¿›å’Œåˆå¹¶æ“ä½œå‰åˆ›å»ºå¿«ç…§ï¼ˆæ–°å»ºæ¦‚å¿µæ— éœ€å¿«ç…§ï¼Œå› ä¸ºå¯ç›´æ¥åˆ é™¤ï¼‰
- **ç´¢å¼•ç®¡ç†**ï¼šç»´æŠ¤å¿«ç…§ç´¢å¼•ï¼Œæ”¯æŒå¿«é€ŸæŸ¥æ‰¾å’Œæ¢å¤
- **åŸå­æ¢å¤**ï¼šä½¿ç”¨åŸå­å†™å…¥æœºåˆ¶ç¡®ä¿æ¢å¤æ“ä½œçš„å®‰å…¨æ€§
- **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå¿«ç…§ï¼Œé¿å…ç£ç›˜ç©ºé—´æµªè´¹

#### 6. ç»Ÿä¸€å·¥ä½œå°
- **å››åŒºåŸŸå¸ƒå±€**ï¼š
  - åˆ›å»ºæ¦‚å¿µåŒºï¼šå¿«é€Ÿåˆ›å»ºæ–°æ¦‚å¿µ
  - é‡å¤æ¦‚å¿µåŒºï¼šç®¡ç†å¾…å¤„ç†çš„é‡å¤å¯¹
  - é˜Ÿåˆ—çŠ¶æ€åŒºï¼šå®æ—¶ç›‘æ§ä»»åŠ¡æ‰§è¡Œ
  - æœ€è¿‘æ“ä½œåŒºï¼šæŸ¥çœ‹å’Œæ’¤é”€æœ€è¿‘çš„æ“ä½œ
- **å®æ—¶åŒæ­¥**ï¼šUI çŠ¶æ€ä¸åå°çŠ¶æ€ä¿æŒæ¯«ç§’çº§åŒæ­¥
- **é”™è¯¯é€æ˜**ï¼šæ‰€æœ‰é”™è¯¯ä¿¡æ¯æ¸…æ™°å±•ç¤ºï¼Œæä¾›å¯æ“ä½œçš„è§£å†³æ–¹æ¡ˆ

#### 7. å¤š Provider æ”¯æŒ
- **OpenAI å…¼å®¹**ï¼šæ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI API æ ¼å¼çš„æœåŠ¡
- **è‡ªå®šä¹‰ç«¯ç‚¹**ï¼šæ”¯æŒé…ç½®è‡ªå®šä¹‰ API ç«¯ç‚¹å’Œæ¨¡å‹
- **ç½‘ç»œç›‘æ§**ï¼šå®æ—¶ç›‘æ§ Provider å¯ç”¨æ€§ï¼Œè‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æ–¹æ¡ˆ
- **é”™è¯¯é‡è¯•**ï¼šæ™ºèƒ½é‡è¯•ç­–ç•¥ï¼ŒåŒºåˆ†å†…å®¹é”™è¯¯å’Œç½‘ç»œé”™è¯¯

### 1.3 è®¾è®¡å“²å­¦

Cognitive Razor çš„è®¾è®¡å“²å­¦æºè‡ªã€ŠCognitive Razorï¼šæ•°å­—è®¤çŸ¥ç³»ç»Ÿçš„æœ¬ä½“è®ºé‡æ„ä¸ä¸»æƒè¾©æŠ¤ç™½çš®ä¹¦ã€‹ï¼Œè¯¥ç™½çš®ä¹¦ä»è®¤çŸ¥çš„"å…ƒé—®é¢˜"å‡ºå‘ï¼Œé€šè¿‡ä¸¥æ ¼çš„æ¼”ç»æ¨ç†ï¼Œæ„å»ºäº†ä¸€å¥—åŒ…å«ç¬¬ä¸€æ€§åŸç†ã€åäº”æ¡å…¬ç†åŠå®Œæ•´æ¨è®ºé“¾çš„ç†è®ºä½“ç³»ã€‚

#### æ ¸å¿ƒå“²å­¦åŸåˆ™

**1. å­˜åœ¨å³é“­æ–‡ï¼ˆExistence as Inscriptionï¼‰**

åœ¨æ•°å­—ä¸–ç•Œä¸­ï¼Œå­˜åœ¨ä¸æ˜¯ä¸€ç§çŠ¶æ€ï¼Œè€Œæ˜¯ä¸€ç§è¢«"è¯æ˜"çš„è¿‡ç¨‹ã€‚æ¯ä¸ªæ¦‚å¿µå¿…é¡»æ‹¥æœ‰ä¸å¯ç¯¡æ”¹çš„èº«ä»½è¯æ˜ï¼ˆUIDï¼‰ä¸æ—¶ç©ºé”šç‚¹ï¼ˆFrontmatterï¼‰ã€‚æ— è¯ä¹‹ç‰©ï¼Œå³ä¸ºå™ªéŸ³ã€‚

> "æœªè¢«å‘½åä¸”æœªè¢«ç­¾åçš„æ¦‚å¿µåœ¨æœ¬ä½“è®ºä¸Šä¸å­˜åœ¨ã€‚"

**2. ä¾¿æ·æ˜¯ä¸»æƒçš„æ•Œäººï¼ˆConvenience vs. Sovereigntyï¼‰**

å½“æˆ‘ä»¬å°†æ€ç»´å¤–åŒ…ç»™é»‘ç®±ç®—æ³•æ—¶ï¼Œè°æ‹¥æœ‰æœ€ç»ˆè£å†³æƒï¼ŸCognitive Razor é€šè¿‡å¼•å…¥"å¿…è¦çš„è®¤çŸ¥é˜»åŠ›"ï¼Œç¡®ä¿äººç±»å§‹ç»ˆæ˜¯è®¤çŸ¥çš„ä¸»ä½“ï¼Œè€Œéæ•°æ®çš„å®¿ä¸»ã€‚

> "æœºå™¨æ˜¯å»ºè®®è€…ï¼Œäººç±»æ˜¯è£å†³è€…ã€‚AI æ‹¥æœ‰ç”Ÿæˆå†…å®¹çš„æ— é™èƒ½åŠ›ï¼Œä½†æ²¡æœ‰ä»»ä½•'ç¡®è®¤äº‹å®'çš„æƒåˆ©ã€‚"

**3. å¯é€†æ€§å³è‡ªç”±ï¼ˆReversibility as Freedomï¼‰**

æƒåŠ›çš„æœ¬è´¨æ˜¯"æ‚”æ£‹æƒ"ã€‚ä¸å¯é€†çš„å†™å…¥ç­‰åŒäºæš´æ”¿ã€‚ç³»ç»Ÿè®°å½•çš„ä¸ä»…æ˜¯"çŠ¶æ€"ï¼Œæ›´æ˜¯"çŠ¶æ€çš„å˜æ›´å†å²"ã€‚

> "ä»»ä½•å¯¹ç³»ç»Ÿçš„ç†µå¢æ“ä½œï¼ˆå†™å…¥ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰éƒ½å¿…é¡»ä¼´éšä¸€æ¡ç¡®å®šæ€§çš„å›æ»šè·¯å¾„ã€‚"

**4. æ‹’ç»å³è¯šå®ï¼ˆRejection as Honestyï¼‰**

è¯šå®çš„æ‹’ç»ä¼˜äºè™šå‡çš„é¡ºä»ã€‚å½“çº¦æŸä¸è¶³ã€èƒ½åŠ›ä¸è¶³æˆ–é£é™©è¿‡é«˜æ—¶ï¼Œç³»ç»Ÿå¿…é¡»è¿”å›ç»“æ„åŒ–çš„æ‹’ç»ä¿¡å·ï¼Œè€Œéç¼–é€ å¹»è§‰ã€‚

> "ä¸€ä¸ªè¯šå®çš„'æˆ‘ä¸çŸ¥é“'åœ¨ä»·å€¼ä¸Šè¿œé«˜äºä¸€ä¸‡ä¸ªè™šæ„çš„'æˆ‘çŸ¥é“'ã€‚"

**5. é€æ˜å³ä¿¡ä»»ï¼ˆTransparency as Trustï¼‰**

é»‘ç®±å³ä¸ä¿¡ä»»ã€‚æ¯ä¸€æ¬¡å†³ç­–ã€æ¯ä¸€æ¬¡ç­‰å¾…ã€æ¯ä¸€æ¬¡é”™è¯¯ã€æ¯ä¸€æ¬¡æ‹’ç»ï¼Œéƒ½å¿…é¡»åœ¨è§‚æµ‹ç•Œé¢ä¸Šæ‹¥æœ‰åŒæ„çš„æŠ•å½±ã€‚

> "é€»è¾‘å¿…é¡»æ˜¯é€æ˜çš„ç»ç’ƒç›’ï¼Œè€Œéç¥è°•çš„é»‘ç®±ã€‚"

#### äº”ç»´è®¤çŸ¥å¼ é‡

Cognitive Razor å°†äººç±»è®¤çŸ¥æŠ½è±¡ä¸ºäº”ä¸ªä¸”ä»…æœ‰äº”ä¸ª"å­˜åœ¨çš„å½¢å¼"ï¼Œæ„æˆå®Œå¤‡çš„è®¤çŸ¥å¼ é‡ç©ºé—´ï¼š

1. **Domainï¼ˆè¾¹ç•Œï¼‰**ï¼šå›ç­”"ä½•æ‰€ä¸ºç•Œ"ï¼Œå®šä¹‰é—®é¢˜è®¨è®ºçš„åˆæ³•èŒƒå›´
2. **Issueï¼ˆå¼ åŠ›ï¼‰**ï¼šå›ç­”"å“ªå¯¹çŸ›ç›¾"ï¼Œä½“ç°æ¨åŠ¨ç†è®ºæ¼”åŒ–çš„æ ¹æœ¬åŠ¨åŠ›
3. **Theoryï¼ˆæ¨æ¼”ï¼‰**ï¼šå›ç­”"å¦‚ä½•è§£å†³"ï¼Œå½¢æˆä»å…¬ç†åˆ°è§£é‡Šæ¨¡å‹çš„é€»è¾‘è¿‡ç¨‹
4. **Entityï¼ˆå¯¹è±¡ï¼‰**ï¼šå›ç­”"ä½•ç‰©"ï¼Œå…·æœ‰å¯è§‚æµ‹å±æ€§çš„å…·ä½“åè¯æ€§å­˜åœ¨
5. **Mechanismï¼ˆå› æœï¼‰**ï¼šå›ç­”"ä½•å› è‡´ä½•æœ"ï¼Œæè¿°å®ä½“ä¹‹é—´ç›¸äº’ä½œç”¨çš„è¿‡ç¨‹

è¿™äº”è€…æ„æˆäº†ä¸€ä¸ªè‡ªæ´½çš„é—­ç¯ï¼šDomain åˆ’ç•Œ â†’ Issue æé—® â†’ Theory æ±‚è§£ â†’ Entity å®šä¹‰å¯¹è±¡ â†’ Mechanism æè¿°äº’åŠ¨ã€‚ç¼ºå¤±ä»»ä½•ä¸€ç¯ï¼Œè®¤çŸ¥é—­ç¯å³å‘Šæ–­è£‚ã€‚

#### é™ç†µä»ªå¼

å†™å…¥ä¸æ˜¯ç®€å•çš„æ•°æ®æŒä¹…åŒ–ï¼Œè€Œæ˜¯ä¸€åœºå¯¹æŠ—ç†µå¢çš„ä»ªå¼ã€‚Cognitive Razor å®šä¹‰äº†ä¸å¯åˆ å‡çš„å…­æ­¥ä»ªå¼åºåˆ—ï¼š

1. **æ ‡å‡†åŒ–ï¼ˆNormalizationï¼‰**ï¼šç”Ÿæˆ UIDï¼Œæ¸…æ´—æ ‡é¢˜ï¼Œç¡®å®š Type
2. **åˆ«åæ‰©å±•ï¼ˆAlias Expansionï¼‰**ï¼šæ•è·æ¦‚å¿µçš„æ‰€æœ‰å¯èƒ½å«æ³•
3. **åµŒå…¥ç”Ÿæˆï¼ˆEmbeddingï¼‰**ï¼šå°†æ¦‚å¿µæ˜ å°„åˆ°é«˜ç»´å‘é‡ç©ºé—´
4. **äººç±»ç¡®è®¤ï¼ˆHuman Confirmationï¼‰**ï¼šAI æäº¤è‰ç¨¿ï¼Œäººç±»è¡Œä½¿æ‰¹å‡†æƒ
5. **å†™å…¥ï¼ˆCommitï¼‰**ï¼šåŸå­å†™å…¥æ–‡ä»¶ï¼ˆå¢é‡æ”¹è¿›/åˆå¹¶æ—¶ä¿å­˜å¿«ç…§ï¼‰
6. **åµŒå…¥ä¸å»é‡ï¼ˆEmbedding & Deduplicationï¼‰**ï¼šç”Ÿæˆå‘é‡åµŒå…¥ï¼Œåœ¨åŒç±»å‹æ¡¶å†…æ£€ç´¢ç›¸ä¼¼æ¦‚å¿µ

è¿™ä¸€ä»ªå¼çš„æ¯ä¸€æ­¥éƒ½æ˜¯å¯¹"ç†µ"çš„å¯¹æŠ—ã€‚å¦‚æœæ²¡æœ‰å»é‡ï¼Œç³»ç»Ÿä¼šè¢«åƒåœ¾æ·¹æ²¡ï¼›å¦‚æœæ²¡æœ‰å¿«ç…§ï¼Œå¢é‡æ”¹è¿›çš„é”™è¯¯å°†ä¸å¯æŒ½å›ã€‚

#### å¥¥å¡å§†å‰ƒåˆ€å®¡åˆ¤

Cognitive Razor çš„æ¯ä¸€ä¸ªè®¾è®¡è¦ç´ éƒ½ç»è¿‡å¥¥å¡å§†å‰ƒåˆ€çš„ä¸¥è‹›å®¡è§†ã€‚å¦‚æœå‰”é™¤æŸè¦ç´ ï¼Œç³»ç»Ÿé€»è¾‘é“¾æ¡ä¸æ–­è£‚ï¼Œåˆ™è¯¥è¦ç´ å¿…é¡»è¢«åˆ é™¤ã€‚é€šè¿‡åè¯æ³•ï¼Œæˆ‘ä»¬è¯æ˜äº† UIDã€Typeã€Queueã€Snapshotã€Aliasesã€Refusal ç­‰æ ¸å¿ƒè¦ç´ çš„å¿…è¦æ€§ã€‚

> "è‹¥å…¬ç†æˆç«‹ï¼Œåˆ™ç³»ç»Ÿå¿…é¡»å¦‚æ­¤ï¼Œä¸”åªèƒ½å¦‚æ­¤ã€‚"

## 2. æŠ€æœ¯æ ˆ

### 2.1 æ ¸å¿ƒä¾èµ–

Cognitive Razor åŸºäº Obsidian æ’ä»¶ç”Ÿæ€æ„å»ºï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„ TypeScript æŠ€æœ¯æ ˆã€‚ä»¥ä¸‹æ˜¯é¡¹ç›®çš„æ ¸å¿ƒä¾èµ–ï¼š

#### è¿è¡Œæ—¶ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `yaml` | ^2.8.2 | YAML æ ¼å¼è§£æä¸åºåˆ—åŒ–ï¼Œç”¨äºå¤„ç† Frontmatter |

**æ³¨æ„**ï¼šé¡¹ç›®ä»…æœ‰ä¸€ä¸ªè¿è¡Œæ—¶ä¾èµ– `yaml`ï¼Œå…¶ä»–æ‰€æœ‰åŠŸèƒ½éƒ½åŸºäº Obsidian API å’Œ TypeScript æ ‡å‡†åº“å®ç°ã€‚

#### å¼€å‘ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `obsidian` | latest | Obsidian API ç±»å‹å®šä¹‰ï¼Œæä¾›æ’ä»¶å¼€å‘æ¥å£ |
| `typescript` | ^5.7.2 | TypeScript ç¼–è¯‘å™¨ï¼Œæä¾›ç±»å‹æ£€æŸ¥å’Œç¼–è¯‘åŠŸèƒ½ |
| `esbuild` | ^0.25.12 | é«˜æ€§èƒ½æ„å»ºå·¥å…·ï¼Œå°† TypeScript ä»£ç æ‰“åŒ…ä¸ºå•ä¸€ JavaScript æ–‡ä»¶ |
| `vitest` | ^4.0.15 | ç°ä»£åŒ–æµ‹è¯•æ¡†æ¶ï¼Œæ”¯æŒå•å…ƒæµ‹è¯•å’Œå±æ€§æµ‹è¯• |
| `fast-check` | ^4.3.0 | å±æ€§æµ‹è¯•åº“ï¼Œç”¨äºç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®éªŒè¯ä¸å˜é‡ |
| `eslint` | ^9.16.0 | ä»£ç è´¨é‡æ£€æŸ¥å·¥å…·ï¼Œä½¿ç”¨ Flat Config æ ¼å¼ |
| `typescript-eslint` | ^8.17.0 | TypeScript çš„ ESLint æ’ä»¶ï¼Œæä¾› TypeScript ç‰¹å®šçš„ lint è§„åˆ™ |
| `@types/node` | ^22.10.1 | Node.js ç±»å‹å®šä¹‰ |
| `tslib` | ^2.8.1 | TypeScript è¿è¡Œæ—¶è¾…åŠ©åº“ |
| `builtin-modules` | ^3.3.0 | Node.js å†…ç½®æ¨¡å—åˆ—è¡¨ï¼Œç”¨äºæ„å»ºé…ç½® |

#### æµ‹è¯•ç›¸å…³ä¾èµ–

| ä¾èµ– | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| `@vitest/ui` | ^4.0.15 | Vitest çš„ Web UI ç•Œé¢ï¼Œæä¾›å¯è§†åŒ–æµ‹è¯•ç»“æœ |
| `happy-dom` | ^20.0.11 | è½»é‡çº§ DOM å®ç°ï¼Œç”¨äºæµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿæµè§ˆå™¨ API |
| `knip` | ^5.72.0 | æœªä½¿ç”¨ä»£ç æ£€æµ‹å·¥å…·ï¼Œå¸®åŠ©æ¸…ç†å†—ä½™ä¾èµ–å’Œæ­»ä»£ç  |

**ä¾èµ–ç®¡ç†åŸåˆ™**ï¼š

1. **æœ€å°åŒ–åŸåˆ™**ï¼šä»…ä¿ç•™å¿…è¦ä¾èµ–ï¼Œé¿å…å¼•å…¥å¤§å‹åº“
2. **æµè§ˆå™¨å…¼å®¹**ï¼šä¼˜å…ˆé€‰æ‹©æµè§ˆå™¨å…¼å®¹çš„åŒ…ï¼Œç¡®ä¿ç§»åŠ¨ç«¯å¯ç”¨
3. **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰ä¾èµ–å¿…é¡»æä¾› TypeScript ç±»å‹å®šä¹‰
4. **ç‰ˆæœ¬é”å®š**ï¼šä½¿ç”¨ `package-lock.json` é”å®šä¾èµ–ç‰ˆæœ¬ï¼Œç¡®ä¿æ„å»ºå¯å¤ç°

**å½“å‰ç‰ˆæœ¬**ï¼š0.9.3ï¼ˆå‚è§ `package.json` å’Œ `manifest.json`ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `package.json`ï¼šnpm åŒ…é…ç½®å’Œä¾èµ–å®šä¹‰
- `manifest.json`ï¼šObsidian æ’ä»¶å…ƒæ•°æ®

### 2.2 å¼€å‘å·¥å…·

Cognitive Razor ä½¿ç”¨ç°ä»£åŒ–çš„å¼€å‘å·¥å…·é“¾ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ï¼š

#### æ„å»ºå·¥å…·

**esbuild (v0.25.12)**

- **ç”¨é€”**ï¼šå°† TypeScript æºä»£ç æ‰“åŒ…ä¸ºå•ä¸€çš„ `main.js` æ–‡ä»¶
- **ä¼˜åŠ¿**ï¼š
  - æå¿«çš„æ„å»ºé€Ÿåº¦ï¼ˆæ¯” webpack å¿« 10-100 å€ï¼‰
  - å†…ç½® TypeScript æ”¯æŒï¼Œæ— éœ€é¢å¤–é…ç½®
  - æ”¯æŒ Tree Shakingï¼Œè‡ªåŠ¨ç§»é™¤æœªä½¿ç”¨çš„ä»£ç 
  - æ”¯æŒ Watch æ¨¡å¼ï¼Œå®ç°çƒ­é‡è½½å¼€å‘
- **é…ç½®æ–‡ä»¶**ï¼š`esbuild.config.mjs`
- **æ„å»ºå‘½ä»¤**ï¼š
  - å¼€å‘æ¨¡å¼ï¼š`npm run dev`ï¼ˆå¯ç”¨ watch æ¨¡å¼å’Œ sourcemapï¼‰
  - ç”Ÿäº§æ¨¡å¼ï¼š`npm run build`ï¼ˆå¯ç”¨ä»£ç å‹ç¼©å’Œä¼˜åŒ–ï¼‰

**æ„å»ºæµç¨‹**ï¼š
```
TypeScript æºç  (main.ts + src/**/*.ts)
    â†“ [esbuild]
å•ä¸€ JavaScript æ–‡ä»¶ (main.js)
    â†“ [Obsidian]
æ’ä»¶åŠ è½½è¿è¡Œ
```

**æ³¨æ„**ï¼šå…¥å£æ–‡ä»¶æ˜¯æ ¹ç›®å½•çš„ `main.ts`ï¼Œè€Œé `src/main.ts`ã€‚esbuild ä¼šå°† `main.ts` åŠå…¶æ‰€æœ‰ä¾èµ–æ‰“åŒ…ä¸ºå•ä¸€çš„ `main.js` æ–‡ä»¶ã€‚

#### ç±»å‹æ£€æŸ¥

**TypeScript (v5.7.2)**

- **é…ç½®**ï¼š`tsconfig.json`
- **å…³é”®é…ç½®é¡¹**ï¼š
  - `target: ES2022`ï¼šä½¿ç”¨ç°ä»£ JavaScript ç‰¹æ€§
  - `strict: true`ï¼šå¯ç”¨æ‰€æœ‰ä¸¥æ ¼ç±»å‹æ£€æŸ¥
  - `moduleResolution: bundler`ï¼šä½¿ç”¨ bundler æ¨¡å¼çš„æ¨¡å—è§£æ
  - `skipLibCheck: true`ï¼šè·³è¿‡ç¬¬ä¸‰æ–¹åº“çš„ç±»å‹æ£€æŸ¥ï¼ŒåŠ å¿«ç¼–è¯‘é€Ÿåº¦
- **ç±»å‹æ£€æŸ¥å‘½ä»¤**ï¼š`tsc -noEmit -skipLibCheck`ï¼ˆä»…æ£€æŸ¥ç±»å‹ï¼Œä¸ç”Ÿæˆæ–‡ä»¶ï¼‰

**TypeScript ä½¿ç”¨è§„èŒƒ**ï¼š
- ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹ï¼Œä½¿ç”¨ `unknown` ä»£æ›¿
- æ‰€æœ‰å‡½æ•°å¿…é¡»æ˜¾å¼å£°æ˜è¿”å›ç±»å‹
- ä½¿ç”¨ `interface` å®šä¹‰æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ `type` å®šä¹‰è”åˆç±»å‹
- ä½¿ç”¨ Result Monad æ¨¡å¼å¤„ç†é”™è¯¯ï¼Œé¿å…æŠ›å‡ºå¼‚å¸¸

#### ä»£ç è´¨é‡

**ESLint (v9.16.0) + typescript-eslint (v8.17.0)**

- **é…ç½®æ ¼å¼**ï¼šFlat Config (`eslint.config.js`)
- **å…³é”®è§„åˆ™**ï¼š
  - ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹
  - å¼ºåˆ¶ä½¿ç”¨ `const` å£°æ˜ä¸å¯å˜å˜é‡
  - è¦æ±‚æ˜¾å¼çš„å‡½æ•°è¿”å›ç±»å‹
  - ç¦æ­¢æœªä½¿ç”¨çš„å˜é‡å’Œå¯¼å…¥
- **æ£€æŸ¥å‘½ä»¤**ï¼š
  - æ£€æŸ¥ä»£ç ï¼š`npx eslint ./src/`
  - è‡ªåŠ¨ä¿®å¤ï¼š`npx eslint ./src/ --fix`

**æ³¨æ„**ï¼šæœ¬é¡¹ç›®ä½¿ç”¨ ESLint 9.x çš„ Flat Config æ ¼å¼ï¼Œä¸å†æ”¯æŒæ—§ç‰ˆ `.eslintrc` æ ¼å¼ã€‚

#### æµ‹è¯•æ¡†æ¶

**Vitest (v4.0.15)**

- **ç”¨é€”**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€å±æ€§æµ‹è¯•
- **ä¼˜åŠ¿**ï¼š
  - ä¸ Vite ç”Ÿæ€æ— ç¼é›†æˆ
  - åŸç”Ÿæ”¯æŒ TypeScript å’Œ ESM
  - å¿«é€Ÿçš„æµ‹è¯•æ‰§è¡Œé€Ÿåº¦
  - å†…ç½®ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
  - æ”¯æŒ Watch æ¨¡å¼å’Œ UI ç•Œé¢
- **æµ‹è¯•å‘½ä»¤**ï¼š
  - è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š`npm run test`
  - Watch æ¨¡å¼ï¼š`npm run test:watch`
  - UI ç•Œé¢ï¼š`npm run test:ui`
  - è¦†ç›–ç‡æŠ¥å‘Šï¼š`npm run test:coverage`

**fast-check (v4.3.0)**

- **ç”¨é€”**ï¼šå±æ€§æµ‹è¯•ï¼ˆProperty-Based Testingï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼š
  - éªŒè¯ä¸å˜é‡ï¼ˆå¦‚æ ‡é¢˜å±‚çº§ä¸€è‡´æ€§ï¼‰
  - æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆå¦‚ç©ºè¾“å…¥ã€æå¤§å€¼ï¼‰
  - ç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®
- **ç¤ºä¾‹**ï¼šå‚è§ `src/core/task-queue.test.ts`ã€`src/core/pipeline-orchestrator.test.ts`

#### ç‰ˆæœ¬ç®¡ç†

**version-bump.mjs**

- **ç”¨é€”**ï¼šè‡ªåŠ¨æ›´æ–° `manifest.json` å’Œ `versions.json` çš„ç‰ˆæœ¬å·
- **ä½¿ç”¨**ï¼š`npm version patch/minor/major`

**verify-release.js**

- **ç”¨é€”**ï¼šéªŒè¯å‘å¸ƒå‰çš„æ–‡ä»¶å®Œæ•´æ€§
- **æ£€æŸ¥é¡¹**ï¼š
  - `main.js` æ˜¯å¦å­˜åœ¨
  - `manifest.json` ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´
  - `versions.json` æ˜¯å¦åŒ…å«å½“å‰ç‰ˆæœ¬

#### å¼€å‘ç¯å¢ƒ

**æ¨èé…ç½®**ï¼š
- **ç¼–è¾‘å™¨**ï¼šVisual Studio Code
- **æ’ä»¶**ï¼š
  - ESLintï¼šå®æ—¶ä»£ç æ£€æŸ¥
  - TypeScript Vue Plugin (Volar)ï¼šå¢å¼º TypeScript æ”¯æŒ
  - Vitestï¼šæµ‹è¯•ç»“æœå¯è§†åŒ–
- **Node.js**ï¼š22+ LTSï¼ˆNode 18 å·²äº 2025 å¹´ EOLï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `esbuild.config.mjs`ï¼šesbuild æ„å»ºé…ç½®
- `tsconfig.json`ï¼šTypeScript ç¼–è¯‘å™¨é…ç½®
- `eslint.config.js`ï¼šESLint ä»£ç æ£€æŸ¥é…ç½®
- `package.json`ï¼šnpm è„šæœ¬å’Œä¾èµ–å®šä¹‰

**æ³¨æ„**ï¼šé¡¹ç›®å½“å‰æœªä½¿ç”¨ç‹¬ç«‹çš„ `vitest.config.ts`ï¼Œæµ‹è¯•é…ç½®åœ¨ `package.json` ä¸­å®šä¹‰ã€‚

### 2.3 ç‰ˆæœ¬è¦æ±‚

ä¸ºç¡®ä¿é¡¹ç›®çš„ç¨³å®šæ€§å’Œå…¼å®¹æ€§ï¼ŒCognitive Razor å¯¹è¿è¡Œç¯å¢ƒå’Œä¾èµ–ç‰ˆæœ¬æœ‰æ˜ç¡®è¦æ±‚ï¼š

#### è¿è¡Œç¯å¢ƒ

| ç¯å¢ƒ | æœ€ä½ç‰ˆæœ¬ | æ¨èç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|----------|------|
| **Node.js** | 22.0.0 | 22.x LTS | Node 18 å·²äº 2025 å¹´ EOLï¼Œå¿…é¡»ä½¿ç”¨ Node 22+ |
| **npm** | 10.0.0 | æœ€æ–°ç‰ˆæœ¬ | ä¸ Node.js 22 é…å¥—çš„åŒ…ç®¡ç†å™¨ |
| **Obsidian** | 1.5.7 | æœ€æ–°ç‰ˆæœ¬ | æ’ä»¶çš„æœ€ä½æ”¯æŒç‰ˆæœ¬ï¼Œå®šä¹‰åœ¨ `manifest.json` çš„ `minAppVersion` |

**é‡è¦æç¤º**ï¼š
- âŒ **ç¦æ­¢ä½¿ç”¨ Node 18 æˆ–æ›´æ—©ç‰ˆæœ¬**ï¼šNode 18 å·²äº 2025 å¹´ 4 æœˆ 30 æ—¥åœæ­¢ç»´æŠ¤ï¼Œå­˜åœ¨å®‰å…¨é£é™©
- âœ… **æ¨èä½¿ç”¨ Node 22 LTS**ï¼šé•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œç¨³å®šæ€§å’Œå®‰å…¨æ€§æœ‰ä¿éšœ
- âš ï¸ **Obsidian ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šæ’ä»¶ä½¿ç”¨äº† Obsidian 1.5.7+ çš„æ–° APIï¼Œä½äºæ­¤ç‰ˆæœ¬çš„ Obsidian æ— æ³•è¿è¡Œ

#### æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬

| ä¾èµ– | æœ€ä½ç‰ˆæœ¬ | å½“å‰ç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|----------|------|
| **TypeScript** | 5.7.0 | 5.7.2 | æ”¯æŒæœ€æ–°çš„ç±»å‹æ£€æŸ¥ç‰¹æ€§å’Œ ES2022+ è¯­æ³• |
| **esbuild** | 0.25.0 | 0.25.12 | é«˜æ€§èƒ½æ„å»ºå·¥å…·ï¼Œå¿…é¡»ä½¿ç”¨ 0.25.x ç‰ˆæœ¬ |
| **ESLint** | 9.0.0 | 9.16.0 | ä½¿ç”¨ Flat Config æ ¼å¼ï¼Œä¸å…¼å®¹æ—§ç‰ˆ `.eslintrc` |
| **Vitest** | 4.0.0 | 4.0.15 | ç°ä»£åŒ–æµ‹è¯•æ¡†æ¶ |
| **fast-check** | 4.0.0 | 4.3.0 | å±æ€§æµ‹è¯•åº“ |

#### TypeScript é…ç½®è¦æ±‚

**tsconfig.json å…³é”®é…ç½®**ï¼š

```json
{
  "compilerOptions": {
    "target": "ES2022",           // ä½¿ç”¨ç°ä»£ JavaScript ç‰¹æ€§
    "module": "ESNext",           // ä½¿ç”¨ ESM æ¨¡å—ç³»ç»Ÿ
    "moduleResolution": "bundler", // bundler æ¨¡å¼çš„æ¨¡å—è§£æ
    "strict": true,               // å¯ç”¨æ‰€æœ‰ä¸¥æ ¼ç±»å‹æ£€æŸ¥
    "skipLibCheck": true,         // è·³è¿‡ç¬¬ä¸‰æ–¹åº“çš„ç±»å‹æ£€æŸ¥
    "esModuleInterop": true,      // å¯ç”¨ ESM äº’æ“ä½œæ€§
    "resolveJsonModule": true,    // æ”¯æŒå¯¼å…¥ JSON æ–‡ä»¶
    "isolatedModules": true,      // ç¡®ä¿æ¯ä¸ªæ–‡ä»¶å¯ä»¥ç‹¬ç«‹ç¼–è¯‘
    "noUnusedLocals": true,       // ç¦æ­¢æœªä½¿ç”¨çš„å±€éƒ¨å˜é‡
    "noUnusedParameters": true,   // ç¦æ­¢æœªä½¿ç”¨çš„å‡½æ•°å‚æ•°
    "noImplicitReturns": true,    // è¦æ±‚å‡½æ•°æ‰€æœ‰åˆ†æ”¯éƒ½æœ‰è¿”å›å€¼
    "noFallthroughCasesInSwitch": true // ç¦æ­¢ switch è¯­å¥çš„ fallthrough
  }
}
```

**ç±»å‹å®‰å…¨è¦æ±‚**ï¼š
- âŒ **ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹**ï¼šä½¿ç”¨ `unknown` ä»£æ›¿ï¼Œå¼ºåˆ¶ç±»å‹æ£€æŸ¥
- âœ… **ä½¿ç”¨ `strict: true`**ï¼šå¯ç”¨æ‰€æœ‰ä¸¥æ ¼æ¨¡å¼æ£€æŸ¥
- âœ… **æ˜¾å¼è¿”å›ç±»å‹**ï¼šæ‰€æœ‰å‡½æ•°å¿…é¡»å£°æ˜è¿”å›ç±»å‹

#### ESLint é…ç½®è¦æ±‚

**eslint.config.js æ ¼å¼**ï¼š

æœ¬é¡¹ç›®ä½¿ç”¨ ESLint 9.x çš„ Flat Config æ ¼å¼ï¼Œä¸å†æ”¯æŒæ—§ç‰ˆ `.eslintrc` æ ¼å¼ã€‚

```javascript
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';

export default [
  eslint.configs.recommended,
  ...tseslint.configs.recommended,
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'error',
      '@typescript-eslint/explicit-function-return-type': 'warn',
      // ... å…¶ä»–è§„åˆ™
    }
  }
];
```

**é‡è¦å˜æ›´**ï¼š
- âŒ **ä¸å†æ”¯æŒ `.eslintrc` æ ¼å¼**ï¼šæ—§ç‰ˆé…ç½®æ–‡ä»¶å·²å¼ƒç”¨
- âœ… **ä½¿ç”¨ `eslint.config.js`**ï¼šæ–°ç‰ˆ Flat Config æ ¼å¼
- âœ… **typescript-eslint v8+**ï¼šä¸ ESLint 9 å…¼å®¹çš„ TypeScript æ’ä»¶

#### Obsidian API ç‰ˆæœ¬è¦æ±‚

**æœ€ä½æ”¯æŒç‰ˆæœ¬**ï¼šObsidian 1.5.7

**å¯ç”¨ API**ï¼ˆ1.5.7+ï¼‰ï¼š
- âœ… `onExternalSettingsChange`ï¼šç›‘å¬å¤–éƒ¨è®¾ç½®å˜æ›´
- âœ… `prepareFuzzySearch`ï¼šå‡†å¤‡æ¨¡ç³Šæœç´¢
- âœ… `getAvailablePathForAttachment`ï¼šè·å–é™„ä»¶å¯ç”¨è·¯å¾„

**å·²å¼ƒç”¨ API**ï¼ˆç¦æ­¢ä½¿ç”¨ï¼‰ï¼š
- âŒ `prepareQuery`ï¼šå·²è¢« `prepareFuzzySearch` æ›¿ä»£
- âŒ `fuzzySearch`ï¼šå·²è¢« `prepareFuzzySearch` æ›¿ä»£

**å…¼å®¹æ€§ç­–ç•¥**ï¼š
- æ’ä»¶ä»…ä½¿ç”¨ Obsidian 1.5.7+ æ”¯æŒçš„ API
- ä¸ä½¿ç”¨å®éªŒæ€§æˆ–æœªæ–‡æ¡£åŒ–çš„ API
- å®šæœŸæ£€æŸ¥ Obsidian API æ›´æ–°ï¼ŒåŠæ—¶é€‚é…æ–°ç‰¹æ€§

#### AI æ¨¡å‹ç‰ˆæœ¬è¦æ±‚

**æ¨èæ¨¡å‹**ï¼š

| ä»»åŠ¡ç±»å‹ | æ¨èæ¨¡å‹ | å¤‡é€‰æ¨¡å‹ | è¯´æ˜ |
|---------|---------|---------|------|
| **èŠå¤©/æ¨ç†** | `gpt-4o` | `gpt-4o-mini` | é»˜è®¤ä½¿ç”¨ gpt-4oï¼Œè½»é‡ä»»åŠ¡å¯ç”¨ gpt-4o-mini |
| **å‘é‡åµŒå…¥** | `text-embedding-3-small` | `text-embedding-3-large` | é»˜è®¤ä½¿ç”¨ small ç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ |

**ç¦æ­¢ä½¿ç”¨**ï¼š
- âŒ `gpt-3.5-turbo`ï¼šå·²è¿‡æ—¶ï¼Œèƒ½åŠ›ä¸è¶³ä»¥å®Œæˆå¤æ‚æ¨ç†ä»»åŠ¡

**Provider å…¼å®¹æ€§**ï¼š
- ç”¨æˆ·å¯é€šè¿‡ Provider é…ç½®ä½¿ç”¨å…¶ä»–å…¼å®¹ OpenAI æ ¼å¼çš„æœåŠ¡
- å¿…é¡»æ”¯æŒ `/chat/completions` å’Œ `/embeddings` æ ‡å‡†ç«¯ç‚¹
- å‚è€ƒå®ç°ï¼š`src/core/provider-manager.ts`

#### ç‰ˆæœ¬å‡çº§ç­–ç•¥

**ä¾èµ–æ›´æ–°åŸåˆ™**ï¼š
1. **ä¸»ç‰ˆæœ¬æ›´æ–°**ï¼šéœ€è¦è¯„ä¼°ç ´åæ€§å˜æ›´ï¼Œæ›´æ–°ä»£ç é€‚é…
2. **æ¬¡ç‰ˆæœ¬æ›´æ–°**ï¼šå®šæœŸæ›´æ–°ï¼Œè·å–æ–°ç‰¹æ€§å’Œæ€§èƒ½æ”¹è¿›
3. **è¡¥ä¸ç‰ˆæœ¬æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°ï¼Œä¿®å¤å®‰å…¨æ¼æ´å’Œ bug
4. **é”å®šæ–‡ä»¶**ï¼šä½¿ç”¨ `package-lock.json` ç¡®ä¿æ„å»ºå¯å¤ç°

**å‡çº§æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ£€æŸ¥ CHANGELOG å’Œ Breaking Changes
- [ ] æ›´æ–° TypeScript ç±»å‹å®šä¹‰
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] æ£€æŸ¥ ESLint è§„åˆ™å˜æ›´
- [ ] éªŒè¯ Obsidian API å…¼å®¹æ€§
- [ ] æ›´æ–°æ–‡æ¡£ä¸­çš„ç‰ˆæœ¬å·

**å‚è€ƒæ–‡æ¡£**ï¼š
- `.kiro/steering/tech-stack-reference.md`ï¼šæŠ€æœ¯æ ˆåŸºçº¿è§„èŒƒ
- `package.json`ï¼šä¾èµ–ç‰ˆæœ¬å®šä¹‰
- `manifest.json`ï¼šObsidian æ’ä»¶å…ƒæ•°æ®

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 ä¸‰å±‚æ¶æ„æ¦‚è¿°

Cognitive Razor é‡‡ç”¨ç»å…¸çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼Œå°†ç³»ç»Ÿåˆ’åˆ†ä¸ºæ•°æ®å±‚ï¼ˆData Layerï¼‰ã€åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰å’Œ UI å±‚ï¼ˆUI Layerï¼‰ã€‚è¿™ç§åˆ†å±‚è®¾è®¡ç¡®ä¿äº†ä»£ç çš„æ¨¡å—åŒ–ã€å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

#### æ¶æ„åŸåˆ™

**å•å‘ä¾èµ–åŸåˆ™**

ç³»ç»Ÿä¸¥æ ¼éµå¾ªå•å‘ä¾èµ–åŸåˆ™ï¼š**UI å±‚ â†’ åº”ç”¨å±‚ â†’ æ•°æ®å±‚**

- **UI å±‚**å¯ä»¥ä¾èµ–åº”ç”¨å±‚å’Œæ•°æ®å±‚
- **åº”ç”¨å±‚**å¯ä»¥ä¾èµ–æ•°æ®å±‚ï¼Œä½†ä¸èƒ½ä¾èµ– UI å±‚
- **æ•°æ®å±‚**ä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚ï¼Œä¿æŒå®Œå…¨ç‹¬ç«‹

è¿™ç§å•å‘ä¾èµ–ç¡®ä¿äº†ï¼š
1. **ä½è€¦åˆ**ï¼šæ¯ä¸€å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£ï¼Œä¸éœ€è¦äº†è§£ä¸Šå±‚çš„å®ç°ç»†èŠ‚
2. **å¯æµ‹è¯•æ€§**ï¼šæ•°æ®å±‚å’Œåº”ç”¨å±‚å¯ä»¥ç‹¬ç«‹äº UI è¿›è¡Œå•å…ƒæµ‹è¯•
3. **å¯æ›¿æ¢æ€§**ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ UI å®ç°è€Œä¸å½±å“ä¸šåŠ¡é€»è¾‘
4. **æ¸…æ™°çš„èŒè´£è¾¹ç•Œ**ï¼šæ¯ä¸€å±‚çš„èŒè´£æ˜ç¡®ï¼Œé¿å…ä»£ç æ··ä¹±

**ä¾èµ–æ³¨å…¥æ¨¡å¼**

ç³»ç»Ÿä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰æ¨¡å¼ç®¡ç†ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼š

- æ‰€æœ‰ç»„ä»¶åœ¨ `main.ts` çš„ `onload()` æ–¹æ³•ä¸­æŒ‰é¡ºåºåˆå§‹åŒ–
- ç»„ä»¶é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¶ä¾èµ–ï¼Œè€Œéè‡ªè¡Œåˆ›å»º
- æ’ä»¶ä¸»ç±»æä¾› `getComponents()` æ–¹æ³•ï¼Œä¾› UI å±‚è®¿é—®åº”ç”¨å±‚å’Œæ•°æ®å±‚ç»„ä»¶

è¿™ç§æ¨¡å¼çš„ä¼˜åŠ¿ï¼š
1. **è§£è€¦**ï¼šç»„ä»¶ä¸éœ€è¦çŸ¥é“ä¾èµ–çš„å…·ä½“å®ç°
2. **å¯æµ‹è¯•**ï¼šå¯ä»¥è½»æ¾æ³¨å…¥ Mock å¯¹è±¡è¿›è¡Œå•å…ƒæµ‹è¯•
3. **çµæ´»æ€§**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢ä¾èµ–å®ç°

#### ç³»ç»Ÿæ¶æ„å›¾

ä»¥ä¸‹ Mermaid å›¾è¡¨å±•ç¤ºäº† Cognitive Razor çš„ä¸‰å±‚æ¶æ„åŠä¸»è¦ç»„ä»¶ï¼š

```mermaid
graph TD
    subgraph UI["UI å±‚ (User Interface Layer)"]
        WorkbenchPanel[WorkbenchPanel<br/>ç»Ÿä¸€å·¥ä½œå°]
        StatusBadge[StatusBadge<br/>çŠ¶æ€æ å¾½ç« ]
        CommandDispatcher[CommandDispatcher<br/>å‘½ä»¤åˆ†å‘å™¨]
        SettingsTab[SettingsTab<br/>è®¾ç½®é¢æ¿]
    end
    
    subgraph App["åº”ç”¨å±‚ (Application Layer)"]
        PipelineOrchestrator[PipelineOrchestrator<br/>ç®¡çº¿ç¼–æ’å™¨]
        TaskQueue[TaskQueue<br/>ä»»åŠ¡é˜Ÿåˆ—]
        TaskRunner[TaskRunner<br/>ä»»åŠ¡æ‰§è¡Œå™¨]
        DuplicateManager[DuplicateManager<br/>é‡å¤ç®¡ç†å™¨]
        VectorIndex[VectorIndex<br/>å‘é‡ç´¢å¼•]
        LockManager[LockManager<br/>é”ç®¡ç†å™¨]
        UndoManager[UndoManager<br/>æ’¤é”€ç®¡ç†å™¨]
        ProviderManager[ProviderManager<br/>Providerç®¡ç†å™¨]
        PromptManager[PromptManager<br/>æç¤ºè¯ç®¡ç†å™¨]
    end
    
    subgraph Data["æ•°æ®å±‚ (Data Layer)"]
        FileStorage[FileStorage<br/>æ–‡ä»¶å­˜å‚¨]
        Logger[Logger<br/>æ—¥å¿—è®°å½•å™¨]
        SettingsStore[SettingsStore<br/>è®¾ç½®å­˜å‚¨]
        Validator[Validator<br/>éªŒè¯å™¨]
    end
    
    %% UI å±‚ â†’ åº”ç”¨å±‚ä¾èµ–
    WorkbenchPanel --> PipelineOrchestrator
    WorkbenchPanel --> TaskQueue
    WorkbenchPanel --> DuplicateManager
    WorkbenchPanel --> UndoManager
    
    StatusBadge --> TaskQueue
    
    CommandDispatcher --> TaskQueue
    CommandDispatcher --> PipelineOrchestrator
    CommandDispatcher --> DuplicateManager
    
    SettingsTab --> SettingsStore
    SettingsTab --> ProviderManager
    
    %% åº”ç”¨å±‚ â†’ æ•°æ®å±‚ä¾èµ–
    PipelineOrchestrator --> TaskQueue
    PipelineOrchestrator --> TaskRunner
    PipelineOrchestrator --> DuplicateManager
    
    TaskQueue --> LockManager
    TaskQueue --> TaskRunner
    TaskQueue --> FileStorage
    
    TaskRunner --> ProviderManager
    TaskRunner --> PromptManager
    TaskRunner --> Validator
    TaskRunner --> UndoManager
    TaskRunner --> VectorIndex
    TaskRunner --> FileStorage
    TaskRunner --> Logger
    
    DuplicateManager --> VectorIndex
    DuplicateManager --> FileStorage
    
    VectorIndex --> FileStorage
    UndoManager --> FileStorage
    PromptManager --> FileStorage
    
    ProviderManager --> SettingsStore
    ProviderManager --> Logger
    
    Validator --> VectorIndex
    
    LockManager --> Logger
    Logger --> FileStorage
    
    %% æ ·å¼å®šä¹‰
    classDef uiLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef appLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dataLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class WorkbenchPanel,StatusBadge,CommandDispatcher,SettingsTab uiLayer
    class PipelineOrchestrator,TaskQueue,TaskRunner,DuplicateManager,VectorIndex,LockManager,UndoManager,ProviderManager,PromptManager appLayer
    class FileStorage,Logger,SettingsStore,Validator dataLayer
```

**å›¾è¡¨è¯´æ˜**ï¼š

- **è“è‰²åŒºåŸŸ**ï¼šUI å±‚ç»„ä»¶ï¼Œè´Ÿè´£ç”¨æˆ·äº¤äº’å’Œç•Œé¢å±•ç¤º
- **æ©™è‰²åŒºåŸŸ**ï¼šåº”ç”¨å±‚ç»„ä»¶ï¼Œè´Ÿè´£æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **ç»¿è‰²åŒºåŸŸ**ï¼šæ•°æ®å±‚ç»„ä»¶ï¼Œè´Ÿè´£æ•°æ®å­˜å‚¨å’ŒåŸºç¡€æœåŠ¡
- **ç®­å¤´æ–¹å‘**ï¼šè¡¨ç¤ºä¾èµ–å…³ç³»ï¼Œéµå¾ªå•å‘ä¾èµ–åŸåˆ™ï¼ˆUI â†’ åº”ç”¨ â†’ æ•°æ®ï¼‰

#### ä¸‰å±‚èŒè´£åˆ’åˆ†

**æ•°æ®å±‚ï¼ˆData Layerï¼‰**

**èŒè´£**ï¼šæä¾›åº•å±‚çš„æ•°æ®å­˜å‚¨ã€æ—¥å¿—è®°å½•ã€é…ç½®ç®¡ç†å’Œæ•°æ®éªŒè¯åŠŸèƒ½

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **FileStorage**ï¼šæ–‡ä»¶è¯»å†™ã€åŸå­å†™å…¥ã€ç›®å½•ç®¡ç†
- **Logger**ï¼šæ—¥å¿—è®°å½•ã€æ—¥å¿—çº§åˆ«æ§åˆ¶ã€å¾ªç¯æ—¥å¿—
- **SettingsStore**ï¼šè®¾ç½®åŠ è½½ã€ä¿å­˜ã€è®¢é˜…
- **Validator**ï¼šè¾“å‡ºéªŒè¯ã€Schema æ ¡éªŒã€è¯­ä¹‰å»é‡

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚
- æä¾›é€šç”¨çš„æ•°æ®æ“ä½œæ¥å£ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
- ä½¿ç”¨ Result Monad æ¨¡å¼è¿”å›æ“ä½œç»“æœï¼Œé¿å…æŠ›å‡ºå¼‚å¸¸
- æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½ç»è¿‡ FileStorage ç»Ÿä¸€ç®¡ç†ï¼Œç¡®ä¿è·¯å¾„ä¸€è‡´æ€§

**å‚è€ƒæ–‡ä»¶**ï¼š`src/data/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

---

**åº”ç”¨å±‚ï¼ˆApplication Layerï¼‰**

**èŒè´£**ï¼šå®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬ä»»åŠ¡è°ƒåº¦ã€å‘é‡ç´¢å¼•ã€é”ç®¡ç†ã€æ’¤é”€ç®¡ç†ã€Provider ç®¡ç†ã€å»é‡æ£€æµ‹ç­‰

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **TaskQueue**ï¼šä»»åŠ¡è°ƒåº¦ã€å¹¶å‘æ§åˆ¶ã€çŠ¶æ€ç®¡ç†
- **TaskRunner**ï¼šä»»åŠ¡æ‰§è¡Œã€Provider è°ƒç”¨ã€ç»“æœéªŒè¯
- **VectorIndex**ï¼šå‘é‡å­˜å‚¨ã€ç›¸ä¼¼åº¦æœç´¢ã€åˆ†æ¡¶ç®¡ç†
- **LockManager**ï¼šé”è·å–ã€é”é‡Šæ”¾ã€é”æ¢å¤
- **UndoManager**ï¼šå¿«ç…§åˆ›å»ºã€å¿«ç…§æ¢å¤ã€å¿«ç…§æ¸…ç†
- **ProviderManager**ï¼šProvider é…ç½®ã€API è°ƒç”¨ã€ç½‘ç»œçŠ¶æ€ç›‘æ§
- **PromptManager**ï¼šæ¨¡æ¿åŠ è½½ã€Prompt æ„å»ºã€æ§½ä½å¡«å……
- **DuplicateManager**ï¼šé‡å¤æ£€æµ‹ã€é‡å¤å¯¹ç®¡ç†ã€åˆå¹¶æµç¨‹
- **PipelineOrchestrator**ï¼šç®¡çº¿ç¼–æ’ã€é˜¶æ®µè½¬æ¢ã€ç”¨æˆ·ç¡®è®¤

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- ä¾èµ–æ•°æ®å±‚æä¾›çš„åŸºç¡€æœåŠ¡
- å®ç°æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å’Œç®—æ³•
- é€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶ä¸ UI å±‚é€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–
- ä½¿ç”¨ Result Monad æ¨¡å¼å¤„ç†é”™è¯¯ï¼Œç¡®ä¿é”™è¯¯å¯è¿½æº¯

**å‚è€ƒæ–‡ä»¶**ï¼š`src/core/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

---

**UI å±‚ï¼ˆUI Layerï¼‰**

**èŒè´£**ï¼šæä¾›ç”¨æˆ·äº¤äº’ç•Œé¢ï¼Œå±•ç¤ºç³»ç»ŸçŠ¶æ€ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **WorkbenchPanel**ï¼šç»Ÿä¸€å·¥ä½œå°ï¼Œå››åŒºåŸŸå¸ƒå±€ï¼Œç”¨æˆ·äº¤äº’
- **StatusBadge**ï¼šçŠ¶æ€æ æ˜¾ç¤ºï¼Œé˜Ÿåˆ—çŠ¶æ€æ›´æ–°
- **CommandDispatcher**ï¼šå‘½ä»¤æ³¨å†Œã€å‘½ä»¤åˆ†å‘
- **SettingsTab**ï¼šè®¾ç½®ç•Œé¢ã€é…ç½®ç®¡ç†

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- ä¾èµ–åº”ç”¨å±‚å’Œæ•°æ®å±‚æä¾›çš„æœåŠ¡
- é€šè¿‡è®¢é˜…æœºåˆ¶ç›‘å¬åº”ç”¨å±‚äº‹ä»¶ï¼Œå®æ—¶æ›´æ–° UI
- æ‰€æœ‰ç”¨æˆ·æ“ä½œéƒ½é€šè¿‡åº”ç”¨å±‚çš„å…¬å¼€æ¥å£æ‰§è¡Œ
- ä½¿ç”¨ Obsidian æä¾›çš„ UI ç»„ä»¶ï¼ˆModalã€Noticeã€Setting ç­‰ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

#### åˆå§‹åŒ–é¡ºåº

ç³»ç»Ÿç»„ä»¶çš„åˆå§‹åŒ–ä¸¥æ ¼æŒ‰ç…§ä¾èµ–å…³ç³»ä»ä¸‹åˆ°ä¸Šè¿›è¡Œï¼š

```
1. æ•°æ®ç›®å½•åˆå§‹åŒ–
   â”œâ”€ åˆ›å»º data/ ç›®å½•
   â””â”€ åˆ›å»º data/snapshots/ å­ç›®å½•

2. æ•°æ®å±‚ç»„ä»¶åˆå§‹åŒ–
   â”œâ”€ FileStorageï¼ˆä¾èµ–ï¼šObsidian Vaultï¼‰
   â”œâ”€ Loggerï¼ˆä¾èµ–ï¼šFileStorageï¼‰
   â”œâ”€ SettingsStoreï¼ˆä¾èµ–ï¼šPluginï¼‰
   â””â”€ Validatorï¼ˆä¾èµ–ï¼šVectorIndexï¼Œç¨åæ³¨å…¥ï¼‰

3. åŠ è½½è®¾ç½®
   â”œâ”€ åˆ›å»º VersionChecker
   â”œâ”€ åŠ è½½ data.json
   â”œâ”€ æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
   â””â”€ åŒæ­¥æ—¥å¿—çº§åˆ«

4. åº”ç”¨å±‚ç»„ä»¶åˆå§‹åŒ–
   â”œâ”€ VectorIndexï¼ˆä¾èµ–ï¼šFileStorageï¼‰
   â”œâ”€ Validatorï¼ˆæ³¨å…¥ VectorIndexï¼‰
   â”œâ”€ LockManagerï¼ˆæ— ä¾èµ–ï¼‰
   â”œâ”€ UndoManagerï¼ˆä¾èµ–ï¼šFileStorageï¼‰
   â”œâ”€ ProviderManagerï¼ˆä¾èµ–ï¼šSettingsStoreï¼‰
   â”œâ”€ PromptManagerï¼ˆä¾èµ–ï¼šFileStorageï¼‰
   â”œâ”€ DuplicateManagerï¼ˆä¾èµ–ï¼šVectorIndex, FileStorageï¼‰
   â”œâ”€ TaskRunnerï¼ˆä¾èµ–ï¼šProviderManager, PromptManager, Validator, UndoManagerï¼‰
   â”œâ”€ TaskQueueï¼ˆä¾èµ–ï¼šLockManager, FileStorage, TaskRunnerï¼‰
   â””â”€ PipelineOrchestratorï¼ˆä¾èµ–ï¼šTaskQueue, TaskRunner, DuplicateManagerï¼‰

5. UI å±‚ç»„ä»¶åˆå§‹åŒ–
   â”œâ”€ æ³¨å†Œè§†å›¾ï¼ˆWorkbenchPanelï¼‰
   â”œâ”€ StatusBadgeï¼ˆä¾èµ–ï¼šPlugin, TaskQueueï¼‰
   â”œâ”€ CommandDispatcherï¼ˆä¾èµ–ï¼šPlugin, TaskQueueï¼‰
   â””â”€ SettingsTabï¼ˆä¾èµ–ï¼šPluginï¼‰

6. äº‹ä»¶è®¢é˜…
   â”œâ”€ è®¢é˜…é˜Ÿåˆ—äº‹ä»¶ â†’ æ›´æ–° StatusBadge å’Œ WorkbenchPanel
   â”œâ”€ è®¢é˜…è®¾ç½®å˜æ›´äº‹ä»¶ â†’ åŒæ­¥é…ç½®
   â”œâ”€ è®¢é˜…é‡å¤å¯¹å˜æ›´äº‹ä»¶ â†’ æ›´æ–° WorkbenchPanel
   â””â”€ è®¢é˜…ç®¡çº¿äº‹ä»¶ â†’ æ›´æ–° WorkbenchPanel
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`onload()` æ–¹æ³•å±•ç¤ºå®Œæ•´çš„åˆå§‹åŒ–æµç¨‹

#### å¸è½½é¡ºåº

ç³»ç»Ÿå¸è½½æ—¶æŒ‰ç…§åˆå§‹åŒ–çš„é€†åºè¿›è¡Œæ¸…ç†ï¼š

```
1. æš‚åœä»»åŠ¡é˜Ÿåˆ—
   â””â”€ åœæ­¢è°ƒåº¦å™¨ï¼Œç­‰å¾…è¿è¡Œä¸­ä»»åŠ¡å®Œæˆ

2. åœæ­¢ç®¡çº¿ç¼–æ’å™¨
   â””â”€ PipelineOrchestrator.dispose()

3. æ¸…ç† UI ç»„ä»¶
   â”œâ”€ StatusBadge.destroy()
   â””â”€ å¸è½½æ‰€æœ‰è§†å›¾

4. è§£é™¤äº‹ä»¶è®¢é˜…
   â””â”€ è°ƒç”¨æ‰€æœ‰ unsubscribe å‡½æ•°

5. ä¿å­˜çŠ¶æ€
   â””â”€ é˜Ÿåˆ—çŠ¶æ€ã€å‘é‡ç´¢å¼•ã€é‡å¤å¯¹åˆ—è¡¨è‡ªåŠ¨æŒä¹…åŒ–
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`onunload()` æ–¹æ³•å±•ç¤ºç»„ä»¶å¸è½½å’Œèµ„æºæ¸…ç†æµç¨‹

#### æ¶æ„ä¼˜åŠ¿

**1. æ¸…æ™°çš„èŒè´£è¾¹ç•Œ**

æ¯ä¸€å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£ï¼Œä¸ä¼šå‡ºç°"ä¸Šå¸ç±»"æˆ–"æ„å¤§åˆ©é¢æ¡ä»£ç "ã€‚ä¾‹å¦‚ï¼š
- FileStorage åªè´Ÿè´£æ–‡ä»¶è¯»å†™ï¼Œä¸å…³å¿ƒæ–‡ä»¶å†…å®¹çš„ä¸šåŠ¡å«ä¹‰
- TaskQueue åªè´Ÿè´£ä»»åŠ¡è°ƒåº¦ï¼Œä¸å…³å¿ƒä»»åŠ¡çš„å…·ä½“æ‰§è¡Œé€»è¾‘
- WorkbenchPanel åªè´Ÿè´£ UI å±•ç¤ºï¼Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘

**2. é«˜å¯æµ‹è¯•æ€§**

- æ•°æ®å±‚å’Œåº”ç”¨å±‚å¯ä»¥ç‹¬ç«‹äº Obsidian ç¯å¢ƒè¿›è¡Œå•å…ƒæµ‹è¯•
- é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œå¯ä»¥è½»æ¾ Mock ä¾èµ–ç»„ä»¶
- æ¯ä¸ªç»„ä»¶çš„èŒè´£å•ä¸€ï¼Œæµ‹è¯•ç”¨ä¾‹ç¼–å†™ç®€å•

**3. æ˜“äºç»´æŠ¤å’Œæ‰©å±•**

- ä¿®æ”¹æŸä¸€å±‚çš„å®ç°ä¸ä¼šå½±å“å…¶ä»–å±‚
- å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ç»„ä»¶æˆ–æ›¿æ¢ç°æœ‰ç»„ä»¶
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ–°å¼€å‘è€…å®¹æ˜“ç†è§£

**4. ç¬¦åˆ SOLID åŸåˆ™**

- **å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰**ï¼šæ¯ä¸ªç»„ä»¶åªæœ‰ä¸€ä¸ªå˜æ›´ç†ç”±
- **å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­
- **é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰**ï¼šå­ç±»å¯ä»¥æ›¿æ¢çˆ¶ç±»
- **æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰**ï¼šæ¥å£ç²¾ç®€ï¼Œä¸å¼ºè¿«å®ç°ä¸éœ€è¦çš„æ–¹æ³•
- **ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

**å‚è€ƒæ–‡æ¡£**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œå±•ç¤ºå®Œæ•´çš„åˆå§‹åŒ–å’Œå¸è½½æµç¨‹
- `src/types.ts`ï¼šæ‰€æœ‰æ¥å£å®šä¹‰ï¼Œå±•ç¤ºç»„ä»¶ä¹‹é—´çš„å¥‘çº¦

### 3.2 ç»„ä»¶ä¾èµ–å…³ç³»

æœ¬èŠ‚ä½¿ç”¨ Mermaid å›¾è¡¨å±•ç¤ºç³»ç»Ÿä¸­ä¸»è¦ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚å›¾è¡¨é‡‡ç”¨ä»å·¦åˆ°å³ï¼ˆLeft-to-Rightï¼‰çš„å¸ƒå±€ï¼Œæ¸…æ™°å±•ç¤ºä¾èµ–æ–¹å‘å’Œæ•°æ®æµã€‚

#### å®Œæ•´ä¾èµ–å…³ç³»å›¾

```mermaid
graph LR
    %% UI å±‚ç»„ä»¶
    WorkbenchPanel[WorkbenchPanel<br/>ç»Ÿä¸€å·¥ä½œå°]
    StatusBadge[StatusBadge<br/>çŠ¶æ€æ å¾½ç« ]
    CommandDispatcher[CommandDispatcher<br/>å‘½ä»¤åˆ†å‘å™¨]
    SettingsTab[SettingsTab<br/>è®¾ç½®é¢æ¿]
    
    %% åº”ç”¨å±‚ç»„ä»¶
    PipelineOrchestrator[PipelineOrchestrator<br/>ç®¡çº¿ç¼–æ’å™¨]
    TaskQueue[TaskQueue<br/>ä»»åŠ¡é˜Ÿåˆ—]
    TaskRunner[TaskRunner<br/>ä»»åŠ¡æ‰§è¡Œå™¨]
    DuplicateManager[DuplicateManager<br/>é‡å¤ç®¡ç†å™¨]
    VectorIndex[VectorIndex<br/>å‘é‡ç´¢å¼•]
    LockManager[LockManager<br/>é”ç®¡ç†å™¨]
    UndoManager[UndoManager<br/>æ’¤é”€ç®¡ç†å™¨]
    ProviderManager[ProviderManager<br/>Providerç®¡ç†å™¨]
    PromptManager[PromptManager<br/>æç¤ºè¯ç®¡ç†å™¨]
    
    %% æ•°æ®å±‚ç»„ä»¶
    FileStorage[FileStorage<br/>æ–‡ä»¶å­˜å‚¨]
    Logger[Logger<br/>æ—¥å¿—è®°å½•å™¨]
    SettingsStore[SettingsStore<br/>è®¾ç½®å­˜å‚¨]
    Validator[Validator<br/>éªŒè¯å™¨]
    
    %% UI å±‚ â†’ åº”ç”¨å±‚ä¾èµ–
    WorkbenchPanel --> PipelineOrchestrator
    WorkbenchPanel --> TaskQueue
    WorkbenchPanel --> DuplicateManager
    WorkbenchPanel --> UndoManager
    
    StatusBadge --> TaskQueue
    
    CommandDispatcher --> TaskQueue
    CommandDispatcher --> PipelineOrchestrator
    CommandDispatcher --> DuplicateManager
    
    SettingsTab --> SettingsStore
    SettingsTab --> ProviderManager
    
    %% åº”ç”¨å±‚å†…éƒ¨ä¾èµ–
    PipelineOrchestrator --> TaskQueue
    PipelineOrchestrator --> TaskRunner
    PipelineOrchestrator --> DuplicateManager
    PipelineOrchestrator --> VectorIndex
    PipelineOrchestrator --> UndoManager
    PipelineOrchestrator --> PromptManager
    PipelineOrchestrator --> ProviderManager
    
    TaskQueue --> LockManager
    TaskQueue --> TaskRunner
    
    TaskRunner --> ProviderManager
    TaskRunner --> PromptManager
    TaskRunner --> Validator
    TaskRunner --> UndoManager
    TaskRunner --> VectorIndex
    
    DuplicateManager --> VectorIndex
    
    %% åº”ç”¨å±‚ â†’ æ•°æ®å±‚ä¾èµ–
    VectorIndex --> FileStorage
    UndoManager --> FileStorage
    PromptManager --> FileStorage
    DuplicateManager --> FileStorage
    TaskQueue --> FileStorage
    
    ProviderManager --> SettingsStore
    ProviderManager --> Logger
    
    TaskRunner --> FileStorage
    TaskRunner --> Logger
    
    Validator --> VectorIndex
    
    LockManager --> Logger
    
    %% æ•°æ®å±‚å†…éƒ¨ä¾èµ–
    Logger --> FileStorage
    
    %% æ ·å¼å®šä¹‰
    classDef uiLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef appLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dataLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class WorkbenchPanel,StatusBadge,CommandDispatcher,SettingsTab uiLayer
    class PipelineOrchestrator,TaskQueue,TaskRunner,DuplicateManager,VectorIndex,LockManager,UndoManager,ProviderManager,PromptManager appLayer
    class FileStorage,Logger,SettingsStore,Validator dataLayer
```

**å›¾è¡¨è¯´æ˜**ï¼š

- **è“è‰²èŠ‚ç‚¹**ï¼šUI å±‚ç»„ä»¶
- **æ©™è‰²èŠ‚ç‚¹**ï¼šåº”ç”¨å±‚ç»„ä»¶
- **ç»¿è‰²èŠ‚ç‚¹**ï¼šæ•°æ®å±‚ç»„ä»¶
- **ç®­å¤´æ–¹å‘**ï¼šä»å·¦åˆ°å³è¡¨ç¤ºä¾èµ–å…³ç³»ï¼ŒA â†’ B è¡¨ç¤º A ä¾èµ– B
- **ä¾èµ–æµå‘**ï¼šUI å±‚ â†’ åº”ç”¨å±‚ â†’ æ•°æ®å±‚ï¼Œéµå¾ªå•å‘ä¾èµ–åŸåˆ™
```

#### ä¾èµ–å…³ç³»è¯´æ˜

**UI å±‚ä¾èµ–**

UI å±‚ç»„ä»¶é€šè¿‡æ’ä»¶ä¸»ç±»çš„ `getComponents()` æ–¹æ³•è·å–åº”ç”¨å±‚å’Œæ•°æ®å±‚ç»„ä»¶çš„å¼•ç”¨ï¼š

- **WorkbenchPanel**ï¼šä¾èµ–æœ€å¤šçš„ UI ç»„ä»¶ï¼Œéœ€è¦è®¿é—®ç®¡çº¿ç¼–æ’å™¨ã€ä»»åŠ¡é˜Ÿåˆ—ã€é‡å¤ç®¡ç†å™¨å’Œæ’¤é”€ç®¡ç†å™¨
- **StatusBadge**ï¼šä»…ä¾èµ–ä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºæ˜¾ç¤ºé˜Ÿåˆ—çŠ¶æ€
- **CommandDispatcher**ï¼šä¾èµ–ä»»åŠ¡é˜Ÿåˆ—ã€ç®¡çº¿ç¼–æ’å™¨å’Œé‡å¤ç®¡ç†å™¨ï¼Œç”¨äºæ‰§è¡Œç”¨æˆ·å‘½ä»¤
- **SettingsTab**ï¼šä¾èµ–è®¾ç½®å­˜å‚¨å’Œ Provider ç®¡ç†å™¨ï¼Œç”¨äºé…ç½®ç®¡ç†

**åº”ç”¨å±‚ä¾èµ–**

åº”ç”¨å±‚ç»„ä»¶ä¹‹é—´å­˜åœ¨å¤æ‚çš„ä¾èµ–å…³ç³»ï¼Œä½†éƒ½éµå¾ªå•å‘ä¾èµ–åŸåˆ™ï¼š

- **PipelineOrchestrator**ï¼ˆç®¡çº¿ç¼–æ’å™¨ï¼‰ï¼šä½œä¸ºæ¦‚å¿µåˆ›å»ºæµç¨‹çš„æ€»æ§åˆ¶å™¨ï¼Œä¾èµ–å‡ ä¹æ‰€æœ‰å…¶ä»–åº”ç”¨å±‚ç»„ä»¶
- **TaskQueue**ï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰ï¼šä¾èµ–é”ç®¡ç†å™¨å’Œä»»åŠ¡æ‰§è¡Œå™¨ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦
- **TaskRunner**ï¼ˆä»»åŠ¡æ‰§è¡Œå™¨ï¼‰ï¼šä¾èµ– Provider ç®¡ç†å™¨ã€æç¤ºè¯ç®¡ç†å™¨ã€éªŒè¯å™¨ã€æ’¤é”€ç®¡ç†å™¨å’Œå‘é‡ç´¢å¼•ï¼Œè´Ÿè´£ä»»åŠ¡æ‰§è¡Œ
- **DuplicateManager**ï¼ˆé‡å¤ç®¡ç†å™¨ï¼‰ï¼šä¾èµ–å‘é‡ç´¢å¼•å’Œæ–‡ä»¶å­˜å‚¨ï¼Œè´Ÿè´£å»é‡æ£€æµ‹
- **PipelineOrchestrator**ï¼ˆç®¡çº¿ç¼–æ’å™¨ï¼‰ï¼šä¾èµ–ä»»åŠ¡é˜Ÿåˆ—ã€ä»»åŠ¡æ‰§è¡Œå™¨ã€é‡å¤ç®¡ç†å™¨ç­‰ï¼Œè´Ÿè´£æ¦‚å¿µåˆ›å»ºæµç¨‹çš„ç¼–æ’

**æ•°æ®å±‚ä¾èµ–**

æ•°æ®å±‚ç»„ä»¶ä¿æŒæœ€å°ä¾èµ–ï¼š

- **Logger**ï¼šä¾èµ– FileStorage è¿›è¡Œæ—¥å¿—æ–‡ä»¶è¯»å†™
- **Validator**ï¼šä¾èµ– VectorIndex è¿›è¡Œè¯­ä¹‰å»é‡
- **FileStorage**ã€**SettingsStore**ï¼šå®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–ç»„ä»¶

#### ä¾èµ–æ³¨å…¥æµç¨‹

ç³»ç»Ÿä½¿ç”¨ä¾èµ–æ³¨å…¥æ¨¡å¼ç®¡ç†ç»„ä»¶ä¾èµ–ï¼Œåˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼š

```typescript
// 1. åˆå§‹åŒ–æ•°æ®å±‚ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
const fileStorage = new FileStorage(vault, pluginDir);
const logger = new Logger(logFilePath, fileStorage, logLevel);
const settingsStore = new SettingsStore(plugin);

// 2. åˆå§‹åŒ–åº”ç”¨å±‚ï¼ˆæŒ‰ä¾èµ–é¡ºåºï¼‰
const vectorIndex = new VectorIndex(indexPath, fileStorage, model, dimension);
const validator = new Validator(vectorIndex);
const lockManager = new LockManager(logger);
const undoManager = new UndoManager(fileStorage, logger, snapshotsDir, maxSnapshots, maxAgeDays);
const providerManager = new ProviderManager(settingsStore, logger);
const promptManager = new PromptManager(fileStorage, logger, promptsDir);
const duplicateManager = new DuplicateManager(vectorIndex, fileStorage, logger, settingsStore, pairsPath);
const taskRunner = new TaskRunner({ providerManager, promptManager, validator, undoManager, logger, vectorIndex, fileStorage, settingsStore });
const taskQueue = new TaskQueue(lockManager, fileStorage, logger, settingsStore, queueStatePath);
taskQueue.setTaskRunner(taskRunner); // è§£å†³å¾ªç¯ä¾èµ–

// 3. åˆå§‹åŒ– UI å±‚ï¼ˆé€šè¿‡ getComponents() è®¿é—®åº”ç”¨å±‚ï¼‰
const workbenchPanel = new WorkbenchPanel(leaf);
workbenchPanel.setPlugin(plugin); // é€šè¿‡ plugin.getComponents() è®¿é—®æ‰€æœ‰ç»„ä»¶
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼š`onload()` æ–¹æ³•å±•ç¤ºå®Œæ•´çš„ä¾èµ–æ³¨å…¥æµç¨‹
- `src/types.ts`ï¼šæ‰€æœ‰æ¥å£å®šä¹‰
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼ŒåŒ…å« `setTaskRunner()` æ–¹æ³•ç”¨äºè§£å†³å¾ªç¯ä¾èµ–

#### å¾ªç¯ä¾èµ–å¤„ç†

ç³»ç»Ÿä¸­å­˜åœ¨ä¸€å¤„å¾ªç¯ä¾èµ–ï¼š**TaskQueue â†” TaskRunner**

- TaskQueue éœ€è¦ TaskRunner æ¥æ‰§è¡Œä»»åŠ¡
- TaskRunner éœ€è¦è®¿é—® TaskQueue æ¥æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆé—´æ¥ä¾èµ–ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Setter æ³¨å…¥

```typescript
// å…ˆåˆ›å»º TaskQueueï¼ˆä¸æ³¨å…¥ TaskRunnerï¼‰
const taskQueue = new TaskQueue(lockManager, fileStorage, logger, settingsStore, queueStatePath);

// å†åˆ›å»º TaskRunner
const taskRunner = new TaskRunner({ /* ä¾èµ– */ });

// æœ€åé€šè¿‡ Setter æ³¨å…¥ TaskRunner
taskQueue.setTaskRunner(taskRunner);
```

è¿™ç§æ–¹å¼æ‰“ç ´äº†å¾ªç¯ä¾èµ–ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„æ¸…æ™°æ€§ã€‚

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`initializeApplicationLayer()` æ–¹æ³•å±•ç¤ºå¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆ
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œ`setTaskRunner()` æ–¹æ³•ç”¨äºæ³¨å…¥ TaskRunner

#### ä¾èµ–å…³ç³»è®¾è®¡åŸåˆ™

**1. æœ€å°ä¾èµ–åŸåˆ™**

æ¯ä¸ªç»„ä»¶åªä¾èµ–å®Œæˆå…¶èŒè´£æ‰€å¿…éœ€çš„ç»„ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„è€¦åˆã€‚ä¾‹å¦‚ï¼š
- StatusBadge åªä¾èµ– TaskQueueï¼Œä¸éœ€è¦ä¾èµ–å…¶ä»–åº”ç”¨å±‚ç»„ä»¶
- LockManager åªä¾èµ– Loggerï¼Œä¿æŒè½»é‡çº§

**2. æ¥å£éš”ç¦»åŸåˆ™**

ç»„ä»¶é€šè¿‡æ¥å£è€Œéå…·ä½“å®ç°è¿›è¡Œä¾èµ–ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢ã€‚ä¾‹å¦‚ï¼š
- TaskRunner ä¾èµ– `IProviderManager` æ¥å£ï¼Œè€Œé `ProviderManager` ç±»
- æ‰€æœ‰æ ¸å¿ƒç»„ä»¶éƒ½å®šä¹‰äº†å¯¹åº”çš„æ¥å£ï¼ˆå‚è§ `src/types.ts`ï¼‰

**3. ä¾èµ–å€’ç½®åŸåˆ™**

é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½ä¾èµ–æŠ½è±¡ã€‚ä¾‹å¦‚ï¼š
- UI å±‚é€šè¿‡ `getComponents()` è·å–ç»„ä»¶å¼•ç”¨ï¼Œè€Œéç›´æ¥ import
- åº”ç”¨å±‚é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼Œè€Œéè‡ªè¡Œåˆ›å»º

**4. å•å‘ä¾èµ–åŸåˆ™**

ä¸¥æ ¼éµå¾ª UI â†’ åº”ç”¨ â†’ æ•°æ®çš„å•å‘ä¾èµ–ï¼Œé¿å…åå‘ä¾èµ–ã€‚ä¾‹å¦‚ï¼š
- æ•°æ®å±‚ç»„ä»¶ä¸èƒ½ä¾èµ–åº”ç”¨å±‚æˆ– UI å±‚
- åº”ç”¨å±‚ç»„ä»¶ä¸èƒ½ä¾èµ– UI å±‚

**å‚è€ƒæ–‡æ¡£**ï¼š
- `docs/å“²å­¦è®¾è®¡æ–‡æ¡£.md`ï¼šç³»ç»Ÿè®¾è®¡å“²å­¦
- `.kiro/steering/AGENTS.md`ï¼šä»£ç ç»„ç»‡è§„èŒƒ

### 3.3 æ•°æ®æµå‘

æœ¬èŠ‚æè¿°ç³»ç»Ÿä¸­æ•°æ®çš„æµè½¬è·¯å¾„ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¾“å…¥å¦‚ä½•æµç»å„å±‚ã€ä»»åŠ¡æ•°æ®å¦‚ä½•åœ¨ç»„ä»¶é—´ä¼ é€’ã€ä»¥åŠæŒä¹…åŒ–æ•°æ®çš„è¯»å†™è·¯å¾„ã€‚

#### æ€»ä½“æ•°æ®æµå›¾

ä»¥ä¸‹ Mermaid å›¾è¡¨å±•ç¤ºäº†æ•°æ®åœ¨ä¸‰å±‚æ¶æ„ä¹‹é—´çš„æµè½¬è·¯å¾„å’Œå…³é”®è½¬æ¢ç‚¹ï¼š

```mermaid
flowchart TD
    subgraph UI["UI å±‚"]
        UserInput[ç”¨æˆ·è¾“å…¥]
        UIDisplay[ç•Œé¢å±•ç¤º]
    end
    
    subgraph App["åº”ç”¨å±‚"]
        Pipeline[ç®¡çº¿ç¼–æ’]
        TaskQueue[ä»»åŠ¡é˜Ÿåˆ—]
        TaskRunner[ä»»åŠ¡æ‰§è¡Œ]
        VectorIndex[å‘é‡ç´¢å¼•]
        DupManager[é‡å¤ç®¡ç†]
    end
    
    subgraph Data["æ•°æ®å±‚"]
        FileStorage[æ–‡ä»¶å­˜å‚¨]
        Logger[æ—¥å¿—è®°å½•]
        SettingsStore[è®¾ç½®å­˜å‚¨]
    end
    
    subgraph External["å¤–éƒ¨æœåŠ¡"]
        AIProvider[AI Provider<br/>OpenAI/è‡ªå®šä¹‰]
    end
    
    subgraph Disk["ç£ç›˜å­˜å‚¨"]
        VaultFiles[Vault æ–‡ä»¶<br/>*.md]
        DataFiles[æ•°æ®æ–‡ä»¶<br/>*.json]
        LogFiles[æ—¥å¿—æ–‡ä»¶<br/>*.log]
    end
    
    %% ç”¨æˆ·è¾“å…¥æµ
    UserInput -->|1. æ¦‚å¿µæè¿°| Pipeline
    Pipeline -->|2. åˆ›å»ºä»»åŠ¡| TaskQueue
    TaskQueue -->|3. è°ƒåº¦ä»»åŠ¡| TaskRunner
    TaskRunner -->|4. æ„å»º Prompt| AIProvider
    AIProvider -->|5. AI å“åº”| TaskRunner
    TaskRunner -->|6. éªŒè¯è¾“å‡º| VectorIndex
    VectorIndex -->|7. å»é‡æ£€æµ‹| DupManager
    DupManager -->|8. æ£€æµ‹ç»“æœ| Pipeline
    Pipeline -->|9. ç¡®è®¤è¯·æ±‚| UIDisplay
    UIDisplay -->|10. ç”¨æˆ·ç¡®è®¤| Pipeline
    Pipeline -->|11. å†™å…¥æ–‡ä»¶| FileStorage
    FileStorage -->|12. åŸå­å†™å…¥| VaultFiles
    
    %% æ•°æ®æŒä¹…åŒ–æµ
    TaskQueue -->|æŒä¹…åŒ–é˜Ÿåˆ—| FileStorage
    VectorIndex -->|æŒä¹…åŒ–ç´¢å¼•| FileStorage
    DupManager -->|æŒä¹…åŒ–é‡å¤å¯¹| FileStorage
    FileStorage -->|å†™å…¥| DataFiles
    
    %% æ—¥å¿—æµ
    TaskRunner -->|è®°å½•æ—¥å¿—| Logger
    Pipeline -->|è®°å½•æ—¥å¿—| Logger
    Logger -->|è¿½åŠ æ—¥å¿—| LogFiles
    
    %% é…ç½®æµ
    SettingsStore -->|è¯»å–é…ç½®| DataFiles
    UIDisplay -->|æ˜¾ç¤ºé…ç½®| SettingsStore
    UserInput -->|ä¿®æ”¹é…ç½®| SettingsStore
    SettingsStore -->|ä¿å­˜é…ç½®| DataFiles
    
    %% äº‹ä»¶æµ
    TaskQueue -.->|çŠ¶æ€äº‹ä»¶| UIDisplay
    DupManager -.->|é‡å¤äº‹ä»¶| UIDisplay
    Pipeline -.->|ç®¡çº¿äº‹ä»¶| UIDisplay
    
    style UI fill:#e1f5ff
    style App fill:#fff3e0
    style Data fill:#f1f8e9
    style External fill:#ffe0b2
    style Disk fill:#f5f5f5
```

**æ•°æ®æµè¯´æ˜**ï¼š

1. **ç”¨æˆ·è¾“å…¥æµ**ï¼ˆå®çº¿ç®­å¤´ï¼‰ï¼š
   - ç”¨æˆ·è¾“å…¥ â†’ ç®¡çº¿ç¼–æ’ â†’ ä»»åŠ¡é˜Ÿåˆ— â†’ ä»»åŠ¡æ‰§è¡Œ â†’ AI Provider â†’ éªŒè¯ â†’ å»é‡ â†’ ç”¨æˆ·ç¡®è®¤ â†’ æ–‡ä»¶å†™å…¥
   - æ•°æ®ä» UI å±‚æµå‘åº”ç”¨å±‚ï¼Œå†æµå‘æ•°æ®å±‚ï¼Œæœ€ç»ˆæŒä¹…åŒ–åˆ°ç£ç›˜

2. **æ•°æ®æŒä¹…åŒ–æµ**ï¼ˆå®çº¿ç®­å¤´ï¼‰ï¼š
   - åº”ç”¨å±‚ç»„ä»¶ï¼ˆTaskQueueã€VectorIndexã€DupManagerï¼‰é€šè¿‡ FileStorage å°†çŠ¶æ€æŒä¹…åŒ–åˆ°ç£ç›˜
   - æ‰€æœ‰æŒä¹…åŒ–æ“ä½œéƒ½ç»è¿‡æ•°æ®å±‚çš„ FileStorage ç»Ÿä¸€ç®¡ç†

3. **æ—¥å¿—æµ**ï¼ˆå®çº¿ç®­å¤´ï¼‰ï¼š
   - åº”ç”¨å±‚ç»„ä»¶é€šè¿‡ Logger è®°å½•æ—¥å¿—
   - Logger å°†æ—¥å¿—è¿½åŠ åˆ°ç£ç›˜æ–‡ä»¶

4. **é…ç½®æµ**ï¼ˆå®çº¿ç®­å¤´ï¼‰ï¼š
   - UI å±‚é€šè¿‡ SettingsStore è¯»å–å’Œä¿®æ”¹é…ç½®
   - SettingsStore è´Ÿè´£é…ç½®çš„æŒä¹…åŒ–

5. **äº‹ä»¶æµ**ï¼ˆè™šçº¿ç®­å¤´ï¼‰ï¼š
   - åº”ç”¨å±‚ç»„ä»¶é€šè¿‡äº‹ä»¶æœºåˆ¶é€šçŸ¥ UI å±‚æ›´æ–°
   - äº‹ä»¶æµæ˜¯å•å‘çš„ï¼Œä»åº”ç”¨å±‚åˆ° UI å±‚

**å…³é”®è½¬æ¢ç‚¹**ï¼š

- **ç®¡çº¿ç¼–æ’ï¼ˆPipelineï¼‰**ï¼šå°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºä»»åŠ¡åºåˆ—
- **ä»»åŠ¡æ‰§è¡Œï¼ˆTaskRunnerï¼‰**ï¼šå°†ä»»åŠ¡è½¬æ¢ä¸º AI API è°ƒç”¨
- **å‘é‡ç´¢å¼•ï¼ˆVectorIndexï¼‰**ï¼šå°†æ¦‚å¿µè½¬æ¢ä¸ºå‘é‡åµŒå…¥
- **æ–‡ä»¶å­˜å‚¨ï¼ˆFileStorageï¼‰**ï¼šå°†å†…å­˜æ•°æ®è½¬æ¢ä¸ºç£ç›˜æ–‡ä»¶

#### ç”¨æˆ·è¾“å…¥æµ

ç”¨æˆ·è¾“å…¥ä» UI å±‚å¼€å§‹ï¼Œç»è¿‡åº”ç”¨å±‚å¤„ç†ï¼Œæœ€ç»ˆç”±æ•°æ®å±‚æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚

```mermaid
flowchart TD
    Start([ç”¨æˆ·è¾“å…¥æ¦‚å¿µæè¿°]) --> UI[WorkbenchPanel<br/>æ¥æ”¶è¾“å…¥]
    UI --> Validate{è¾“å…¥éªŒè¯}
    Validate -->|æ— æ•ˆ| Error1[æ˜¾ç¤ºé”™è¯¯æç¤º]
    Validate -->|æœ‰æ•ˆ| Pipeline[PipelineOrchestrator<br/>å¯åŠ¨ç®¡çº¿]
    
    Pipeline --> Standardize[æ ‡å‡†åŒ–é˜¶æ®µ<br/>ç”Ÿæˆ UID å’Œæ ‡å‡†åç§°]
    Standardize --> TypeSelect[ç”¨æˆ·é€‰æ‹©æ¦‚å¿µç±»å‹]
    TypeSelect --> Enrich[ä¸°å¯Œé˜¶æ®µ<br/>ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾]
    Enrich --> Embed[åµŒå…¥é˜¶æ®µ<br/>ç”Ÿæˆå‘é‡åµŒå…¥]
    Embed --> Dedup[å»é‡é˜¶æ®µ<br/>æ£€æµ‹é‡å¤æ¦‚å¿µ]
    
    Dedup --> DupCheck{æ˜¯å¦é‡å¤?}
    DupCheck -->|æ˜¯| DupUI[æ˜¾ç¤ºé‡å¤æç¤º<br/>ç”¨æˆ·å†³ç­–]
    DupUI --> DupDecision{ç”¨æˆ·å†³ç­–}
    DupDecision -->|åˆå¹¶| Merge[å¯åŠ¨åˆå¹¶æµç¨‹]
    DupDecision -->|å¿½ç•¥| Continue[ç»§ç»­åˆ›å»º]
    DupCheck -->|å¦| Continue
    
    Continue --> Confirm[ç”¨æˆ·ç¡®è®¤åˆ›å»º]
    Confirm --> Write[å†™å…¥é˜¶æ®µ<br/>åˆ›å»º Stub æ–‡ä»¶]
    Write --> Snapshot[UndoManager<br/>åˆ›å»ºå¿«ç…§]
    Snapshot --> FileWrite[FileStorage<br/>åŸå­å†™å…¥æ–‡ä»¶]
    FileWrite --> IndexUpdate[VectorIndex<br/>æ›´æ–°ç´¢å¼•]
    IndexUpdate --> Reason[æ¨ç†é˜¶æ®µ<br/>ç”Ÿæˆå†…å®¹]
    Reason --> Draft[æ›´æ–°ä¸º Draft çŠ¶æ€]
    Draft --> End([åˆ›å»ºå®Œæˆ])
    
    Error1 --> End
    Merge --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Error1 fill:#ffcdd2
    style UI fill:#e1f5ff
    style Pipeline fill:#fff3e0
    style FileWrite fill:#f1f8e9
```

**æµç¨‹è¯´æ˜**ï¼š

1. **ç”¨æˆ·è¾“å…¥**ï¼šç”¨æˆ·åœ¨ WorkbenchPanel çš„"åˆ›å»ºæ¦‚å¿µ"åŒºåŸŸè¾“å…¥æ¦‚å¿µæè¿°
2. **è¾“å…¥éªŒè¯**ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©ºæˆ–è¿‡çŸ­
3. **ç®¡çº¿å¯åŠ¨**ï¼šPipelineOrchestrator å¯åŠ¨æ¦‚å¿µåˆ›å»ºç®¡çº¿
4. **æ ‡å‡†åŒ–é˜¶æ®µ**ï¼šè°ƒç”¨ AI ç”Ÿæˆ UID å’Œæ ‡å‡†åç§°
5. **ç±»å‹é€‰æ‹©**ï¼šç”¨æˆ·ä»äº”ç§æ¦‚å¿µç±»å‹ä¸­é€‰æ‹©ä¸€ç§
6. **ä¸°å¯Œé˜¶æ®µ**ï¼šè°ƒç”¨ AI ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾
7. **åµŒå…¥é˜¶æ®µ**ï¼šè°ƒç”¨ AI ç”Ÿæˆå‘é‡åµŒå…¥
8. **å»é‡é˜¶æ®µ**ï¼šåœ¨ VectorIndex ä¸­æœç´¢ç›¸ä¼¼æ¦‚å¿µ
9. **é‡å¤æ£€æµ‹**ï¼šå¦‚æœç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼ï¼Œæç¤ºç”¨æˆ·å†³ç­–
10. **ç”¨æˆ·ç¡®è®¤**ï¼šç”¨æˆ·ç¡®è®¤åˆ›å»ºæ¦‚å¿µ
11. **å†™å…¥é˜¶æ®µ**ï¼šåˆ›å»º Stub æ–‡ä»¶ï¼ˆä»…åŒ…å« Frontmatterï¼‰
12. **å¿«ç…§åˆ›å»º**ï¼šUndoManager åˆ›å»ºå¿«ç…§ä»¥æ”¯æŒæ’¤é”€
13. **æ–‡ä»¶å†™å…¥**ï¼šFileStorage ä½¿ç”¨åŸå­å†™å…¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§
14. **ç´¢å¼•æ›´æ–°**ï¼šVectorIndex æ›´æ–°å‘é‡ç´¢å¼•
15. **æ¨ç†é˜¶æ®µ**ï¼šè°ƒç”¨ AI ç”Ÿæˆæ¦‚å¿µå†…å®¹
16. **çŠ¶æ€æ›´æ–°**ï¼šå°†æ¦‚å¿µçŠ¶æ€ä» Stub æ›´æ–°ä¸º Draft

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œç”¨æˆ·è¾“å…¥å¤„ç†
- `src/core/pipeline-orchestrator.ts`ï¼šPipelineOrchestrator å®ç°ï¼Œç®¡çº¿ç¼–æ’é€»è¾‘
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œç»„ä»¶åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

---

#### ä»»åŠ¡æ•°æ®æµ

ä»»åŠ¡æ•°æ®åœ¨åº”ç”¨å±‚ç»„ä»¶ä¹‹é—´æµè½¬ï¼Œä»ä»»åŠ¡åˆ›å»ºåˆ°ä»»åŠ¡å®Œæˆçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

```mermaid
flowchart TD
    Start([ä»»åŠ¡åˆ›å»ºè¯·æ±‚]) --> Create[PipelineOrchestrator<br/>åˆ›å»ºä»»åŠ¡è®°å½•]
    Create --> Enqueue[TaskQueue<br/>ä»»åŠ¡å…¥é˜Ÿ]
    
    Enqueue --> LockCheck{LockManager<br/>æ£€æŸ¥é”å†²çª}
    LockCheck -->|æœ‰å†²çª| Wait[ä»»åŠ¡ç­‰å¾…]
    Wait --> LockCheck
    LockCheck -->|æ— å†²çª| Acquire[LockManager<br/>è·å–é”]
    
    Acquire --> Persist1[FileStorage<br/>æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€]
    Persist1 --> Schedule[TaskQueue<br/>è°ƒåº¦å™¨è½®è¯¢]
    Schedule --> ConcCheck{æ£€æŸ¥å¹¶å‘é™åˆ¶}
    ConcCheck -->|å·²è¾¾ä¸Šé™| Wait2[ç­‰å¾…ç©ºé—²]
    Wait2 --> Schedule
    ConcCheck -->|æœªè¾¾ä¸Šé™| Execute[TaskRunner<br/>æ‰§è¡Œä»»åŠ¡]
    
    Execute --> LoadPrompt[PromptManager<br/>åŠ è½½æç¤ºè¯æ¨¡æ¿]
    LoadPrompt --> BuildPrompt[PromptManager<br/>æ„å»º Prompt]
    BuildPrompt --> CallAPI[ProviderManager<br/>è°ƒç”¨ AI API]
    
    CallAPI --> APIResult{API è°ƒç”¨ç»“æœ}
    APIResult -->|å¤±è´¥| Retry{æ˜¯å¦é‡è¯•?}
    Retry -->|æ˜¯| Execute
    Retry -->|å¦| Failed[ä»»åŠ¡å¤±è´¥]
    
    APIResult -->|æˆåŠŸ| Validate[Validator<br/>éªŒè¯è¾“å‡º]
    Validate --> ValidResult{éªŒè¯ç»“æœ}
    ValidResult -->|å¤±è´¥| Retry
    ValidResult -->|æˆåŠŸ| Process[å¤„ç†ä»»åŠ¡ç»“æœ]
    
    Process --> TaskType{ä»»åŠ¡ç±»å‹}
    TaskType -->|embedding| UpdateIndex[VectorIndex<br/>æ›´æ–°ç´¢å¼•]
    TaskType -->|enrich| UpdateFM[æ›´æ–° Frontmatter]
    TaskType -->|reason:new| WriteContent[å†™å…¥å†…å®¹]
    
    UpdateIndex --> Complete
    UpdateFM --> Complete
    WriteContent --> Snapshot[UndoManager<br/>åˆ›å»ºå¿«ç…§]
    Snapshot --> Complete[ä»»åŠ¡å®Œæˆ]
    
    Complete --> Release[LockManager<br/>é‡Šæ”¾é”]
    Failed --> Release
    Release --> Persist2[FileStorage<br/>æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€]
    Persist2 --> Notify[é€šçŸ¥ UI æ›´æ–°]
    Notify --> End([ä»»åŠ¡ç»“æŸ])
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Failed fill:#ffcdd2
    style Execute fill:#fff3e0
    style Persist1 fill:#f1f8e9
    style Persist2 fill:#f1f8e9
```

**æµç¨‹è¯´æ˜**ï¼š

1. **ä»»åŠ¡åˆ›å»º**ï¼šPipelineOrchestrator æˆ–å…¶ä»–ç»„ä»¶åˆ›å»ºä»»åŠ¡è®°å½•
2. **ä»»åŠ¡å…¥é˜Ÿ**ï¼šTaskQueue å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
3. **é”å†²çªæ£€æŸ¥**ï¼šLockManager æ£€æŸ¥æ˜¯å¦å­˜åœ¨èŠ‚ç‚¹é”æˆ–ç±»å‹é”å†²çª
4. **è·å–é”**ï¼šå¦‚æœæ— å†²çªï¼Œè·å–ç›¸åº”çš„é”
5. **æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€**ï¼šå°†é˜Ÿåˆ—çŠ¶æ€å†™å…¥ `data/queue-state.json`
6. **è°ƒåº¦å™¨è½®è¯¢**ï¼šTaskQueue çš„è°ƒåº¦å™¨æ¯ç§’æ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
7. **å¹¶å‘é™åˆ¶æ£€æŸ¥**ï¼šæ£€æŸ¥å½“å‰è¿è¡Œä»»åŠ¡æ•°æ˜¯å¦è¾¾åˆ°ä¸Šé™
8. **ä»»åŠ¡æ‰§è¡Œ**ï¼šTaskRunner å¼€å§‹æ‰§è¡Œä»»åŠ¡
9. **åŠ è½½æç¤ºè¯**ï¼šPromptManager åŠ è½½å¯¹åº”çš„æç¤ºè¯æ¨¡æ¿
10. **æ„å»º Prompt**ï¼šå¡«å……æ§½ä½ï¼Œç”Ÿæˆå®Œæ•´çš„ Prompt
11. **è°ƒç”¨ API**ï¼šProviderManager è°ƒç”¨ AI API
12. **å¤„ç†ç»“æœ**ï¼šæ ¹æ® API è°ƒç”¨ç»“æœå†³å®šé‡è¯•æˆ–ç»§ç»­
13. **éªŒè¯è¾“å‡º**ï¼šValidator éªŒè¯ AI è¾“å‡ºæ˜¯å¦ç¬¦åˆ Schema
14. **å¤„ç†ä»»åŠ¡ç»“æœ**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œä¸åŒçš„åç»­æ“ä½œ
15. **åˆ›å»ºå¿«ç…§**ï¼šå¯¹äºå†™å…¥æ“ä½œï¼ŒUndoManager åˆ›å»ºå¿«ç…§
16. **ä»»åŠ¡å®Œæˆ**ï¼šæ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º Completed
17. **é‡Šæ”¾é”**ï¼šLockManager é‡Šæ”¾æŒæœ‰çš„é”
18. **æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€**ï¼šå†æ¬¡æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
19. **é€šçŸ¥ UI**ï¼šé€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶é€šçŸ¥ UI æ›´æ–°

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œä»»åŠ¡è°ƒåº¦å’Œå¹¶å‘æ§åˆ¶
- `src/core/task-runner.ts`ï¼šTaskRunner å®ç°ï¼Œä»»åŠ¡æ‰§è¡Œå’Œ API è°ƒç”¨
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé”™è¯¯åˆ†ç±»å’Œé‡è¯•ç­–ç•¥

---

#### æŒä¹…åŒ–æ•°æ®æµ

æŒä¹…åŒ–æ•°æ®çš„è¯»å†™è·¯å¾„ï¼Œå±•ç¤ºæ•°æ®å¦‚ä½•åœ¨å†…å­˜å’Œç£ç›˜ä¹‹é—´æµè½¬ã€‚

```mermaid
flowchart LR
    subgraph Memory[å†…å­˜]
        Settings[PluginSettings<br/>è®¾ç½®å¯¹è±¡]
        QueueState[QueueState<br/>é˜Ÿåˆ—çŠ¶æ€]
        VectorData[VectorIndex<br/>å‘é‡æ•°æ®]
        DupPairs[DuplicatePairs<br/>é‡å¤å¯¹åˆ—è¡¨]
        Snapshots[SnapshotIndex<br/>å¿«ç…§ç´¢å¼•]
    end
    
    subgraph Disk[ç£ç›˜]
        DataJson[data.json<br/>æ’ä»¶é…ç½®]
        QueueJson[data/queue-state.json<br/>é˜Ÿåˆ—çŠ¶æ€]
        VectorsDir[data/vectors/<br/>å‘é‡ç´¢å¼•ç›®å½•]
        PairsJson[data/duplicate-pairs.json<br/>é‡å¤å¯¹]
        SnapshotIndex[data/snapshots/index.json<br/>å¿«ç…§ç´¢å¼•]
        SnapshotFiles[data/snapshots/*.json<br/>å¿«ç…§æ–‡ä»¶]
        LogFile[data/app.log<br/>æ—¥å¿—æ–‡ä»¶]
    end
    
    subgraph DataLayer[æ•°æ®å±‚]
        SettingsStore[SettingsStore]
        FileStorage[FileStorage]
        Logger[Logger]
    end
    
    %% è¯»å–è·¯å¾„
    DataJson -->|loadData| SettingsStore
    SettingsStore -->|è§£æ| Settings
    
    QueueJson -->|read| FileStorage
    FileStorage -->|è§£æ| QueueState
    
    IndexJson -->|read| FileStorage
    FileStorage -->|è§£æ| VectorData
    
    PairsJson -->|read| FileStorage
    FileStorage -->|è§£æ| DupPairs
    
    SnapshotIndex -->|read| FileStorage
    FileStorage -->|è§£æ| Snapshots
    
    %% å†™å…¥è·¯å¾„
    Settings -->|åºåˆ—åŒ–| SettingsStore
    SettingsStore -->|saveData| DataJson
    
    QueueState -->|åºåˆ—åŒ–| FileStorage
    FileStorage -->|write| QueueJson
    
    VectorData -->|åºåˆ—åŒ–| FileStorage
    FileStorage -->|write| IndexJson
    
    DupPairs -->|åºåˆ—åŒ–| FileStorage
    FileStorage -->|write| PairsJson
    
    Snapshots -->|åºåˆ—åŒ–| FileStorage
    FileStorage -->|write| SnapshotIndex
    FileStorage -->|atomicWrite| SnapshotFiles
    
    Logger -->|append| LogFile
    
    style Memory fill:#e1f5ff
    style Disk fill:#f1f8e9
    style DataLayer fill:#fff3e0
```

**æ•°æ®æ–‡ä»¶è¯´æ˜**ï¼š

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” | è¯»å–æ—¶æœº | å†™å…¥æ—¶æœº | æ ¼å¼ |
|---------|------|---------|---------|------|
| `data.json` | æ’ä»¶é…ç½® | æ’ä»¶åŠ è½½æ—¶ | è®¾ç½®å˜æ›´æ—¶ | JSON |
| `data/queue-state.json` | é˜Ÿåˆ—çŠ¶æ€ | æ’ä»¶åŠ è½½æ—¶ | ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¶ | JSON |
| `data/vectors/index.json` | å‘é‡ç´¢å¼•å…ƒæ•°æ® | æ’ä»¶åŠ è½½æ—¶ | åµŒå…¥ç”Ÿæˆ/åˆ é™¤æ—¶ | JSON |
| `data/vectors/{type}/{uid}.json` | å•ä¸ªæ¦‚å¿µå‘é‡ | å»é‡æ£€æµ‹æ—¶ | åµŒå…¥ç”Ÿæˆ/åˆ é™¤æ—¶ | JSON |
| `data/duplicate-pairs.json` | é‡å¤å¯¹åˆ—è¡¨ | æ’ä»¶åŠ è½½æ—¶ | å»é‡æ£€æµ‹/åˆå¹¶æ—¶ | JSON |
| `data/snapshots/index.json` | å¿«ç…§ç´¢å¼• | æ’ä»¶åŠ è½½æ—¶ | å¿«ç…§åˆ›å»º/åˆ é™¤æ—¶ | JSON |
| `data/snapshots/*.json` | å¿«ç…§æ–‡ä»¶ | æ’¤é”€æ“ä½œæ—¶ | å†™å…¥æ“ä½œå‰ | JSON |
| `data/app.log` | æ—¥å¿—æ–‡ä»¶ | æ’ä»¶åŠ è½½æ—¶ | å®æ—¶è¿½åŠ  | JSON Lines |

**è¯»å–æµç¨‹**ï¼š

1. **æ’ä»¶åŠ è½½æ—¶**ï¼š
   - SettingsStore é€šè¿‡ Obsidian çš„ `loadData()` è¯»å– `data.json`
   - FileStorage è¯»å– `data/queue-state.json`ã€`data/vectors/index.json`ã€`data/duplicate-pairs.json`ã€`data/snapshots/index.json`
   - Logger è¯»å– `data/app.log` çš„æœ€å 1000 è¡Œï¼ˆå¾ªç¯æ—¥å¿—ï¼‰

2. **è¿è¡Œæ—¶è¯»å–**ï¼š
   - PromptManager è¯»å– `prompts/*.md` æç¤ºè¯æ¨¡æ¿
   - UndoManager è¯»å– `data/snapshots/*.json` å¿«ç…§æ–‡ä»¶ï¼ˆæ’¤é”€æ“ä½œæ—¶ï¼‰

**å†™å…¥æµç¨‹**ï¼š

1. **è®¾ç½®å˜æ›´**ï¼š
   - SettingsStore é€šè¿‡ Obsidian çš„ `saveData()` å†™å…¥ `data.json`
   - å†™å…¥æ“ä½œæ˜¯åŸå­çš„ï¼Œç”± Obsidian ä¿è¯

2. **é˜Ÿåˆ—çŠ¶æ€å˜æ›´**ï¼š
   - TaskQueue åœ¨ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¶è°ƒç”¨ FileStorage å†™å…¥ `data/queue-state.json`
   - ä½¿ç”¨æ™®é€šå†™å…¥ï¼ˆéåŸå­ï¼‰ï¼Œå› ä¸ºé˜Ÿåˆ—çŠ¶æ€å¯ä»¥ä»ä»»åŠ¡è®°å½•é‡å»º

3. **å‘é‡ç´¢å¼•æ›´æ–°**ï¼š
   - VectorIndex åœ¨åµŒå…¥ç”Ÿæˆæˆ–åˆ é™¤æ—¶å†™å…¥å•ä¸ªå‘é‡æ–‡ä»¶ï¼ˆ`data/vectors/{type}/{uid}.json`ï¼‰å¹¶æ›´æ–°å…ƒæ•°æ®ç´¢å¼•ï¼ˆ`data/vectors/index.json`ï¼‰
   - ä½¿ç”¨æ™®é€šå†™å…¥ï¼Œå› ä¸ºç´¢å¼•å¯ä»¥ä»ç¬”è®°æ–‡ä»¶é‡å»º

4. **é‡å¤å¯¹æ›´æ–°**ï¼š
   - DuplicateManager åœ¨å»é‡æ£€æµ‹æˆ–åˆå¹¶æ—¶è°ƒç”¨ FileStorage å†™å…¥ `data/duplicate-pairs.json`
   - ä½¿ç”¨æ™®é€šå†™å…¥

5. **å¿«ç…§åˆ›å»º**ï¼š
   - UndoManager åœ¨å†™å…¥æ“ä½œå‰è°ƒç”¨ FileStorage åˆ›å»ºå¿«ç…§
   - ä½¿ç”¨åŸå­å†™å…¥ï¼ˆ`atomicWrite`ï¼‰ï¼Œç¡®ä¿å¿«ç…§å®Œæ•´æ€§
   - å¿«ç…§æ–‡ä»¶å‘½åæ ¼å¼ï¼š`{snapshotId}.json`

6. **æ—¥å¿—è¿½åŠ **ï¼š
   - Logger å®æ—¶è¿½åŠ æ—¥å¿—åˆ° `data/app.log`
   - ä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼Œé¿å…è¦†ç›–æ—¢æœ‰æ—¥å¿—
   - å½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡ 1MB æ—¶ï¼Œè‡ªåŠ¨æˆªæ–­ï¼ˆä¿ç•™æœ€å 1000 è¡Œï¼‰

**åŸå­å†™å…¥æœºåˆ¶**ï¼š

FileStorage æä¾›ä¸¤ç§å†™å…¥æ–¹æ³•ï¼š

1. **æ™®é€šå†™å…¥ï¼ˆ`write`ï¼‰**ï¼š
   - ç›´æ¥å†™å…¥ç›®æ ‡æ–‡ä»¶
   - é€‚ç”¨äºå¯é‡å»ºçš„æ•°æ®ï¼ˆé˜Ÿåˆ—çŠ¶æ€ã€å‘é‡ç´¢å¼•ã€é‡å¤å¯¹åˆ—è¡¨ï¼‰

2. **åŸå­å†™å…¥ï¼ˆ`atomicWrite`ï¼‰**ï¼š
   - å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆ`.tmp` åç¼€ï¼‰
   - æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
   - é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶ï¼ˆåŸå­æ“ä½œï¼‰
   - é€‚ç”¨äºå…³é”®æ•°æ®ï¼ˆå¿«ç…§æ–‡ä»¶ã€ç¬”è®°æ–‡ä»¶ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæ–‡ä»¶è¯»å†™å’ŒåŸå­å†™å…¥
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œè®¾ç½®æŒä¹…åŒ–å’Œè®¢é˜…
- `src/core/undo-manager.ts`ï¼šUndoManager å®ç°ï¼Œå¿«ç…§åˆ›å»ºå’Œæ¢å¤
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`initializeDataDirectory()` æ–¹æ³•å®šä¹‰æ•°æ®ç›®å½•ç»“æ„

---

#### äº‹ä»¶æµ

ç³»ç»Ÿä½¿ç”¨äº‹ä»¶è®¢é˜…æœºåˆ¶å®ç°ç»„ä»¶ä¹‹é—´çš„æ¾è€¦åˆé€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–ã€‚

```mermaid
flowchart LR
    subgraph Publishers[äº‹ä»¶å‘å¸ƒè€…]
        TaskQueue[TaskQueue]
        SettingsStore[SettingsStore]
        DuplicateManager[DuplicateManager]
        PipelineOrchestrator[PipelineOrchestrator]
    end
    
    subgraph Events[äº‹ä»¶]
        QueueEvent[QueueEvent<br/>ä»»åŠ¡çŠ¶æ€å˜æ›´]
        SettingsEvent[SettingsEvent<br/>è®¾ç½®å˜æ›´]
        DupEvent[DuplicateEvent<br/>é‡å¤å¯¹å˜æ›´]
        PipelineEvent[PipelineEvent<br/>ç®¡çº¿çŠ¶æ€å˜æ›´]
    end
    
    subgraph Subscribers[äº‹ä»¶è®¢é˜…è€…]
        StatusBadge[StatusBadge<br/>æ›´æ–°çŠ¶æ€æ ]
        WorkbenchPanel[WorkbenchPanel<br/>æ›´æ–°å·¥ä½œå°]
        Main[Main<br/>åŒæ­¥é…ç½®]
    end
    
    TaskQueue -->|å‘å¸ƒ| QueueEvent
    QueueEvent -->|è®¢é˜…| StatusBadge
    QueueEvent -->|è®¢é˜…| WorkbenchPanel
    
    SettingsStore -->|å‘å¸ƒ| SettingsEvent
    SettingsEvent -->|è®¢é˜…| Main
    
    DuplicateManager -->|å‘å¸ƒ| DupEvent
    DupEvent -->|è®¢é˜…| WorkbenchPanel
    
    PipelineOrchestrator -->|å‘å¸ƒ| PipelineEvent
    PipelineEvent -->|è®¢é˜…| WorkbenchPanel
    
    style Publishers fill:#fff3e0
    style Events fill:#e1f5ff
    style Subscribers fill:#e1f5ff
```

**äº‹ä»¶è®¢é˜…æœºåˆ¶**ï¼š

1. **é˜Ÿåˆ—äº‹ä»¶**ï¼š
   - å‘å¸ƒè€…ï¼šTaskQueue
   - äº‹ä»¶ç±»å‹ï¼š`task-added`ã€`task-started`ã€`task-completed`ã€`task-failed`ã€`task-cancelled`ã€`queue-paused`ã€`queue-resumed`
   - è®¢é˜…è€…ï¼šStatusBadgeã€WorkbenchPanel
   - ç”¨é€”ï¼šå®æ—¶æ›´æ–° UI æ˜¾ç¤ºé˜Ÿåˆ—çŠ¶æ€

2. **è®¾ç½®å˜æ›´äº‹ä»¶**ï¼š
   - å‘å¸ƒè€…ï¼šSettingsStore
   - äº‹ä»¶ç±»å‹ï¼šè®¾ç½®å¯¹è±¡å˜æ›´
   - è®¢é˜…è€…ï¼šMainï¼ˆæ’ä»¶ä¸»ç±»ï¼‰
   - ç”¨é€”ï¼šåŒæ­¥æ—¥å¿—çº§åˆ«ã€è¯­è¨€è®¾ç½®ç­‰é…ç½®

3. **é‡å¤å¯¹å˜æ›´äº‹ä»¶**ï¼š
   - å‘å¸ƒè€…ï¼šDuplicateManager
   - äº‹ä»¶ç±»å‹ï¼šé‡å¤å¯¹åˆ—è¡¨å˜æ›´
   - è®¢é˜…è€…ï¼šWorkbenchPanel
   - ç”¨é€”ï¼šæ›´æ–°"é‡å¤æ¦‚å¿µ"åŒºåŸŸçš„æ˜¾ç¤º

4. **ç®¡çº¿çŠ¶æ€å˜æ›´äº‹ä»¶**ï¼š
   - å‘å¸ƒè€…ï¼šPipelineOrchestrator
   - äº‹ä»¶ç±»å‹ï¼šç®¡çº¿çŠ¶æ€å˜æ›´
   - è®¢é˜…è€…ï¼šWorkbenchPanel
   - ç”¨é€”ï¼šæ›´æ–°"åˆ›å»ºæ¦‚å¿µ"åŒºåŸŸçš„æ˜¾ç¤º

**è®¢é˜…ç¤ºä¾‹**ï¼š

```typescript
// è®¢é˜…é˜Ÿåˆ—äº‹ä»¶
const unsubQueue = this.taskQueue.subscribe((event) => {
  // æ›´æ–°çŠ¶æ€æ 
  const status = this.taskQueue.getStatus();
  this.statusBadge.updateStatus(status);
  
  // æ›´æ–°å·¥ä½œå°
  const workbenchLeaves = this.app.workspace.getLeavesOfType(WORKBENCH_VIEW_TYPE);
  if (workbenchLeaves.length > 0) {
    const workbench = workbenchLeaves[0].view as WorkbenchPanel;
    workbench.updateQueueStatus(status);
  }
});

// ä¿å­˜å–æ¶ˆè®¢é˜…å‡½æ•°ï¼Œç”¨äºæ’ä»¶å¸è½½æ—¶æ¸…ç†
this.unsubscribers.push(unsubQueue);
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`subscribeToEvents()` æ–¹æ³•å®ç°äº‹ä»¶è®¢é˜…
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œäº‹ä»¶å‘å¸ƒæœºåˆ¶
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œè®¾ç½®å˜æ›´äº‹ä»¶
- `src/core/duplicate-manager.ts`ï¼šDuplicateManager å®ç°ï¼Œé‡å¤å¯¹å˜æ›´äº‹ä»¶
- `src/core/pipeline-orchestrator.ts`ï¼šPipelineOrchestrator å®ç°ï¼Œç®¡çº¿çŠ¶æ€äº‹ä»¶

---

#### æ•°æ®æµè®¾è®¡åŸåˆ™

**1. å•å‘æ•°æ®æµ**

æ•°æ®æµåŠ¨éµå¾ª UI â†’ åº”ç”¨ â†’ æ•°æ®çš„å•å‘åŸåˆ™ï¼Œé¿å…åå‘æ•°æ®æµï¼š
- UI å±‚é€šè¿‡è°ƒç”¨åº”ç”¨å±‚æ–¹æ³•è§¦å‘æ•°æ®å˜æ›´
- åº”ç”¨å±‚é€šè¿‡äº‹ä»¶é€šçŸ¥ UI å±‚æ›´æ–°
- æ•°æ®å±‚ä¸ä¸»åŠ¨é€šçŸ¥ä»»ä½•å±‚ï¼Œä»…è¢«åŠ¨å“åº”è¯»å†™è¯·æ±‚

**2. ä¸å¯å˜æ•°æ®**

æ‰€æœ‰æ•°æ®å¯¹è±¡åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ä¿æŒä¸å¯å˜ï¼š
- ä½¿ç”¨ `Object.freeze()` å†»ç»“é…ç½®å¯¹è±¡
- ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦åˆ›å»ºå‰¯æœ¬è€Œéä¿®æ”¹åŸå¯¹è±¡
- é¿å…åœ¨å¤šä¸ªç»„ä»¶ä¹‹é—´å…±äº«å¯å˜çŠ¶æ€

**3. æ•°æ®æŒä¹…åŒ–ç­–ç•¥**

æ ¹æ®æ•°æ®çš„é‡è¦æ€§å’Œå¯é‡å»ºæ€§é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼š
- **å…³é”®æ•°æ®**ï¼ˆå¿«ç…§ã€ç¬”è®°ï¼‰ï¼šä½¿ç”¨åŸå­å†™å…¥ï¼Œç¡®ä¿å®Œæ•´æ€§
- **å¯é‡å»ºæ•°æ®**ï¼ˆé˜Ÿåˆ—çŠ¶æ€ã€å‘é‡ç´¢å¼•ï¼‰ï¼šä½¿ç”¨æ™®é€šå†™å…¥ï¼Œæé«˜æ€§èƒ½
- **ä¸´æ—¶æ•°æ®**ï¼ˆæ—¥å¿—ï¼‰ï¼šä½¿ç”¨è¿½åŠ æ¨¡å¼ï¼Œé¿å…è¦†ç›–

**4. é”™è¯¯ä¼ æ’­**

ä½¿ç”¨ Result Monad æ¨¡å¼ä¼ æ’­é”™è¯¯ï¼Œé¿å…å¼‚å¸¸æŠ›å‡ºï¼š
- æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œè¿”å› `Result<T>` ç±»å‹
- è°ƒç”¨è€…é€šè¿‡ `result.ok` åˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥
- é”™è¯¯ä¿¡æ¯åŒ…å«é”™è¯¯ç ã€æ¶ˆæ¯å’Œè¯¦ç»†ä¿¡æ¯

**å‚è€ƒæ–‡æ¡£**ï¼š
- `src/types.ts`ï¼šResult Monad ç±»å‹å®šä¹‰å’Œæ‰€æœ‰æ¥å£å®šä¹‰
- `docs/å“²å­¦è®¾è®¡æ–‡æ¡£.md`ï¼šç³»ç»Ÿè®¾è®¡å“²å­¦å’Œç¬¬ä¸€æ€§åŸç†
- `.kiro/steering/AGENTS.md`ï¼šObsidian æ’ä»¶å¼€å‘è§„èŒƒ

### 3.4 å¹¶å‘æ§åˆ¶æœºåˆ¶

Cognitive Razor ä½¿ç”¨é”æœºåˆ¶å’Œä»»åŠ¡é˜Ÿåˆ—è°ƒåº¦ç­–ç•¥æ¥é˜²æ­¢å¹¶å‘å†²çªï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œæ“ä½œçš„åŸå­æ€§ã€‚

#### é”æœºåˆ¶

ç³»ç»Ÿä½¿ç”¨ **LockManager** ç®¡ç†ä¸¤ç§ç±»å‹çš„é”ï¼š

**1. èŠ‚ç‚¹é”ï¼ˆNode Lockï¼‰**

- **é”é”®**ï¼šæ¦‚å¿µçš„ UIDï¼ˆ`nodeId`ï¼‰
- **ç”¨é€”**ï¼šé˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘æ“ä½œ
- **åœºæ™¯**ï¼š
  - å†™å…¥æ¦‚å¿µå†…å®¹æ—¶
  - æ›´æ–° Frontmatter æ—¶
  - ç”Ÿæˆå‘é‡åµŒå…¥æ—¶
  - åˆ é™¤æ¦‚å¿µæ—¶

**ç¤ºä¾‹**ï¼š
```typescript
// è·å–èŠ‚ç‚¹é”
const lockResult = lockManager.acquire(nodeId, "node", taskId);
if (!lockResult.ok) {
  // é”å†²çªï¼Œä»»åŠ¡æ— æ³•æ‰§è¡Œ
  return err("E400", `èŠ‚ç‚¹ ${nodeId} å·²è¢«é”å®š`);
}

// æ‰§è¡Œæ“ä½œ...

// é‡Šæ”¾èŠ‚ç‚¹é”
lockManager.release(lockResult.value);
```

**2. ç±»å‹é”ï¼ˆType Lockï¼‰**

- **é”é”®**ï¼š`type:{CRType}`ï¼ˆå¦‚ `type:Domain`ã€`type:Issue`ï¼‰
- **ç”¨é€”**ï¼šé˜²æ­¢åŒä¸€ç±»å‹çš„å¹¶å‘å»é‡æ£€æµ‹
- **åœºæ™¯**ï¼š
  - å»é‡æ£€æµ‹æ—¶ï¼ˆéœ€è¦æ‰«æåŒç±»å‹çš„æ‰€æœ‰æ¦‚å¿µï¼‰
  - æ‰¹é‡æ“ä½œåŒç±»å‹æ¦‚å¿µæ—¶

**ç¤ºä¾‹**ï¼š
```typescript
// è·å–ç±»å‹é”
const typeLockKey = `type:${crType}`;
const lockResult = lockManager.acquire(typeLockKey, "type", taskId);
if (!lockResult.ok) {
  // ç±»å‹é”å†²çªï¼Œä»»åŠ¡æ— æ³•æ‰§è¡Œ
  return err("E400", `ç±»å‹ ${crType} å·²è¢«é”å®š`);
}

// æ‰§è¡Œå»é‡æ£€æµ‹...

// é‡Šæ”¾ç±»å‹é”
lockManager.release(lockResult.value);
```

**é”çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```mermaid
stateDiagram-v2
    [*] --> Idle: åˆå§‹çŠ¶æ€
    Idle --> Acquired: acquire()
    Acquired --> Held: é”å·²è·å–
    Held --> Released: release()
    Released --> [*]: é”å·²é‡Šæ”¾
    
    Held --> Expired: è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
    Expired --> Released: è‡ªåŠ¨æ¸…ç†
    
    note right of Held
        é”è¶…æ—¶æ—¶é—´ï¼š5åˆ†é’Ÿ
        é˜²æ­¢åƒµå°¸é”é•¿æœŸå ç”¨
    end note
```

**é”è¶…æ—¶æœºåˆ¶**ï¼š

ä¸ºé˜²æ­¢åƒµå°¸é”ï¼ˆä»»åŠ¡å¼‚å¸¸é€€å‡ºä½†æœªé‡Šæ”¾é”ï¼‰ï¼ŒLockManager å®ç°äº†é”è¶…æ—¶æœºåˆ¶ï¼š

- **è¶…æ—¶æ—¶é—´**ï¼š5 åˆ†é’Ÿ
- **æ¸…ç†ç­–ç•¥**ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨é‡Šæ”¾è¿‡æœŸé”
- **è¶…æ—¶å­—æ®µ**ï¼š`LockRecord.expiresAt`

```typescript
// é”è®°å½•ç»“æ„
interface LockRecord {
  key: string;              // é”é”®
  type: 'node' | 'type';    // é”ç±»å‹
  taskId: string;           // æŒæœ‰é”çš„ä»»åŠ¡ ID
  acquiredAt: string;       // è·å–æ—¶é—´
  expiresAt: string;        // è¿‡æœŸæ—¶é—´ï¼ˆ5åˆ†é’Ÿåï¼‰
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/lock-manager.ts`ï¼šLockManager å®ç°ï¼ŒLockRecord ç»“æ„å®šä¹‰å’Œé”è¶…æ—¶æœºåˆ¶
- `src/types.ts`ï¼šILockManager æ¥å£å®šä¹‰

---

#### ä»»åŠ¡é˜Ÿåˆ—è°ƒåº¦ç­–ç•¥

**TaskQueue** è´Ÿè´£ä»»åŠ¡çš„è°ƒåº¦å’Œå¹¶å‘æ§åˆ¶ï¼Œç¡®ä¿ä»»åŠ¡æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œã€‚

**è°ƒåº¦æµç¨‹**ï¼š

```mermaid
flowchart TD
    Start([è°ƒåº¦å™¨è½®è¯¢<br/>æ¯ç§’ä¸€æ¬¡]) --> Paused{é˜Ÿåˆ—æ˜¯å¦æš‚åœ?}
    Paused -->|æ˜¯| End([è·³è¿‡æœ¬è½®])
    Paused -->|å¦| ConcCheck{æ˜¯å¦è¾¾åˆ°å¹¶å‘ä¸Šé™?}
    
    ConcCheck -->|æ˜¯| End
    ConcCheck -->|å¦| FindTask[æŸ¥æ‰¾ç¬¬ä¸€ä¸ª<br/>Pending ä»»åŠ¡]
    
    FindTask --> HasTask{æ‰¾åˆ°ä»»åŠ¡?}
    HasTask -->|å¦| End
    HasTask -->|æ˜¯| NodeLock{èŠ‚ç‚¹é”å†²çª?}
    
    NodeLock -->|æ˜¯| FindTask
    NodeLock -->|å¦| TypeLock{ç±»å‹é”å†²çª?}
    
    TypeLock -->|æ˜¯| ReleaseNode[é‡Šæ”¾èŠ‚ç‚¹é”]
    ReleaseNode --> FindTask
    TypeLock -->|å¦| AcquireLocks[è·å–èŠ‚ç‚¹é”å’Œç±»å‹é”]
    
    AcquireLocks --> UpdateState[æ›´æ–°ä»»åŠ¡çŠ¶æ€<br/>Pending â†’ Running]
    UpdateState --> Persist[æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€]
    Persist --> Execute[å¼‚æ­¥æ‰§è¡Œä»»åŠ¡]
    Execute --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Execute fill:#fff3e0
```

**è°ƒåº¦ç­–ç•¥è¯´æ˜**ï¼š

1. **è½®è¯¢é¢‘ç‡**ï¼šè°ƒåº¦å™¨æ¯ç§’æ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—
2. **æš‚åœæ£€æŸ¥**ï¼šå¦‚æœé˜Ÿåˆ—æš‚åœï¼Œè·³è¿‡æœ¬è½®è°ƒåº¦
3. **å¹¶å‘é™åˆ¶**ï¼šæ£€æŸ¥å½“å‰è¿è¡Œä»»åŠ¡æ•°æ˜¯å¦è¾¾åˆ°ä¸Šé™ï¼ˆé»˜è®¤ 3ï¼Œå¯é…ç½®ï¼‰
4. **ä»»åŠ¡é€‰æ‹©**ï¼šæŒ‰ç…§å…¥é˜Ÿé¡ºåºï¼ˆFIFOï¼‰é€‰æ‹©ç¬¬ä¸€ä¸ª Pending çŠ¶æ€çš„ä»»åŠ¡
5. **é”å†²çªæ£€æŸ¥**ï¼š
   - å…ˆæ£€æŸ¥èŠ‚ç‚¹é”ï¼Œå¦‚æœå†²çªåˆ™è·³è¿‡è¯¥ä»»åŠ¡
   - å†æ£€æŸ¥ç±»å‹é”ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œå¦‚æœå†²çªåˆ™é‡Šæ”¾èŠ‚ç‚¹é”å¹¶è·³è¿‡
6. **è·å–é”**ï¼šåŒæ—¶è·å–èŠ‚ç‚¹é”å’Œç±»å‹é”ï¼ˆå¦‚æœéœ€è¦ï¼‰
7. **çŠ¶æ€æ›´æ–°**ï¼šå°†ä»»åŠ¡çŠ¶æ€ä» Pending æ›´æ–°ä¸º Running
8. **æŒä¹…åŒ–**ï¼šç«‹å³æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€åˆ° `data/queue-state.json`
9. **å¼‚æ­¥æ‰§è¡Œ**ï¼šå¯åŠ¨ä»»åŠ¡æ‰§è¡Œï¼Œä¸é˜»å¡è°ƒåº¦å™¨ç»§ç»­è½®è¯¢

**å¹¶å‘é™åˆ¶**ï¼š

ç³»ç»Ÿé€šè¿‡ `concurrency` é…ç½®é¡¹æ§åˆ¶æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°ï¼š

```typescript
// ä»è®¾ç½®ä¸­è¯»å–å¹¶å‘é™åˆ¶
const settings = settingsStore.getSettings();
const concurrency = settings.concurrency; // é»˜è®¤ 3

// æ£€æŸ¥å½“å‰è¿è¡Œä»»åŠ¡æ•°
if (processingTasks.size >= concurrency) {
  // å·²è¾¾åˆ°å¹¶å‘ä¸Šé™ï¼Œè·³è¿‡è°ƒåº¦
  return;
}
```

**å¹¶å‘é™åˆ¶çš„ä½œç”¨**ï¼š
- é˜²æ­¢åŒæ—¶å‘èµ·è¿‡å¤š API è¯·æ±‚ï¼Œé¿å…è§¦å‘é€Ÿç‡é™åˆ¶
- æ§åˆ¶ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼ˆå†…å­˜ã€CPUï¼‰
- ç¡®ä¿ä»»åŠ¡æ‰§è¡Œçš„ç¨³å®šæ€§

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œè°ƒåº¦å™¨è½®è¯¢å’Œå¹¶å‘æ§åˆ¶é€»è¾‘
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œå¹¶å‘é™åˆ¶é…ç½®ç®¡ç†

---

#### å…¥é˜Ÿå‰é”å†²çªæ£€æŸ¥

ä¸ºé¿å…ä»»åŠ¡å…¥é˜Ÿåé•¿æ—¶é—´ç­‰å¾…ï¼Œç³»ç»Ÿåœ¨å…¥é˜Ÿå‰è¿›è¡Œé”å†²çªæ£€æŸ¥ï¼š

```typescript
// 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒ nodeId çš„ Pending/Running ä»»åŠ¡
for (const existingTask of tasks.values()) {
  if (existingTask.nodeId === nodeId && 
      (existingTask.state === "Pending" || existingTask.state === "Running")) {
    return err("E400", `èŠ‚ç‚¹ ${nodeId} å·²æœ‰ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­`);
  }
}

// 2. æ£€æŸ¥èŠ‚ç‚¹é”
if (lockManager.isLocked(nodeId)) {
  return err("E400", `èŠ‚ç‚¹ ${nodeId} å·²è¢«é”å®š`);
}

// 3. æ£€æŸ¥ç±»å‹é”ï¼ˆå¦‚æœéœ€è¦ï¼‰
if (crType && lockManager.isLocked(`type:${crType}`)) {
  return err("E400", `ç±»å‹ ${crType} å·²è¢«é”å®š`);
}

// 4. å…¥é˜ŸæˆåŠŸ
tasks.set(taskId, task);
```

**æ£€æŸ¥é¡¹**ï¼š
1. **åŒèŠ‚ç‚¹ä»»åŠ¡æ£€æŸ¥**ï¼šé˜²æ­¢åŒä¸€æ¦‚å¿µçš„é‡å¤å…¥é˜Ÿ
2. **èŠ‚ç‚¹é”æ£€æŸ¥**ï¼šé˜²æ­¢ä¸æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å†²çª
3. **ç±»å‹é”æ£€æŸ¥**ï¼šé˜²æ­¢ä¸å»é‡æ£€æµ‹ç­‰æ“ä½œå†²çª

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œ`enqueue()` æ–¹æ³•ä¸­çš„é”å†²çªæ£€æŸ¥é€»è¾‘

---

#### ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ§åˆ¶

ä¸ºé˜²æ­¢ä»»åŠ¡é•¿æ—¶é—´å ç”¨èµ„æºï¼Œç³»ç»Ÿå®ç°äº†ä»»åŠ¡è¶…æ—¶æœºåˆ¶ï¼š

```typescript
// ä»è®¾ç½®ä¸­è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 3 åˆ†é’Ÿï¼‰
const timeoutMs = settings.taskTimeoutMs || 3 * 60 * 1000;

// è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
const timeoutHandle = setTimeout(() => {
  logger.warn("ä»»åŠ¡è¶…æ—¶ï¼Œè§¦å‘è‡ªåŠ¨å–æ¶ˆ", { taskId });
  taskRunner.abort(taskId); // ä¸­æ–­ä»»åŠ¡æ‰§è¡Œ
}, timeoutMs);

// æ‰§è¡Œä»»åŠ¡
const result = await taskRunner.run(task);

// æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
clearTimeout(timeoutHandle);
```

**è¶…æ—¶å¤„ç†**ï¼š
- è¶…æ—¶åè‡ªåŠ¨è°ƒç”¨ `taskRunner.abort(taskId)` ä¸­æ–­ä»»åŠ¡
- ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸º Failed
- é‡Šæ”¾æŒæœ‰çš„é”
- æ ¹æ®é‡è¯•ç­–ç•¥å†³å®šæ˜¯å¦é‡è¯•

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œ`executeTask()` æ–¹æ³•ä¸­çš„è¶…æ—¶æ§åˆ¶é€»è¾‘
- `src/core/task-runner.ts`ï¼šTaskRunner å®ç°ï¼Œ`abort()` æ–¹æ³•ç”¨äºä¸­æ–­ä»»åŠ¡

---

#### é”æ¢å¤æœºåˆ¶

ç³»ç»Ÿé‡å¯åï¼ŒTaskQueue ä¼šä»æŒä¹…åŒ–æ–‡ä»¶æ¢å¤é˜Ÿåˆ—çŠ¶æ€ï¼Œå¹¶æ¸…ç†æ®‹ç•™çš„é”ï¼š

```typescript
// 1. æ¢å¤é”çŠ¶æ€
if (queueState.locks && queueState.locks.length > 0) {
  lockManager.restoreLocks(queueState.locks);
}

// 2. å¤„ç† Running çŠ¶æ€çš„ä»»åŠ¡
for (const task of queueState.tasks) {
  if (task.state === "Running") {
    // é‡å¯åä¸å­˜åœ¨æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œé™çº§ä¸º Pending
    task.state = "Pending";
    task.lockKey = undefined;
    task.typeLockKey = undefined;
    
    // é‡Šæ”¾ä»»åŠ¡æŒæœ‰çš„é”
    lockManager.releaseByTaskId(task.id);
  }
}

// 3. æ¸…é™¤æ— ä»»åŠ¡å…³è”çš„é”
const activeLocks = lockManager.getActiveLocks();
for (const lock of activeLocks) {
  if (!validTaskIds.has(lock.taskId)) {
    lockManager.release(lock.key);
  }
}

// 4. æ¸…ç©ºæ‰€æœ‰é”ï¼ˆå¯åŠ¨æ—¶ä¸ä¿ç•™ä»»ä½•é”ï¼‰
lockManager.clear();
```

**æ¢å¤ç­–ç•¥**ï¼š
1. å…ˆæ¢å¤é”çŠ¶æ€ï¼ˆç”¨äºåç»­æ¸…ç†ï¼‰
2. å°†æ‰€æœ‰ Running çŠ¶æ€çš„ä»»åŠ¡é™çº§ä¸º Pending
3. é‡Šæ”¾æ‰€æœ‰ä»»åŠ¡æŒæœ‰çš„é”
4. æ¸…é™¤æ— ä»»åŠ¡å…³è”çš„é”
5. æœ€åæ¸…ç©ºæ‰€æœ‰é”ï¼ˆè¿è¡Œæ—¶ä¼šé‡æ–°è·å–ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œ`restoreQueueState()` æ–¹æ³•å®ç°é”æ¢å¤é€»è¾‘
- `src/core/lock-manager.ts`ï¼šLockManager å®ç°ï¼Œ`restoreLocks()` å’Œ `clear()` æ–¹æ³•

---

#### å¹¶å‘æ§åˆ¶è®¾è®¡åŸåˆ™

**1. æ‚²è§‚é”ç­–ç•¥**

ç³»ç»Ÿé‡‡ç”¨æ‚²è§‚é”ç­–ç•¥ï¼Œåœ¨æ“ä½œå‰å…ˆè·å–é”ï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§ï¼š
- ä¼˜ç‚¹ï¼šé¿å…å¹¶å‘å†²çªï¼Œæ•°æ®ä¸€è‡´æ€§æœ‰ä¿éšœ
- ç¼ºç‚¹ï¼šå¯èƒ½é™ä½å¹¶å‘æ€§èƒ½ï¼Œä½†å¯¹äºçŸ¥è¯†ç®¡ç†åœºæ™¯å¯æ¥å—

**2. ç»†ç²’åº¦é”**

ç³»ç»Ÿä½¿ç”¨ç»†ç²’åº¦çš„èŠ‚ç‚¹é”å’Œç±»å‹é”ï¼Œè€Œéå…¨å±€é”ï¼š
- ä¸åŒæ¦‚å¿µçš„æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œ
- åŒä¸€æ¦‚å¿µçš„æ“ä½œä¸²è¡Œæ‰§è¡Œ
- å»é‡æ£€æµ‹æ—¶é”å®šæ•´ä¸ªç±»å‹ï¼Œç¡®ä¿ç»“æœå‡†ç¡®

**3. é”è¶…æ—¶æœºåˆ¶**

ä¸ºé˜²æ­¢åƒµå°¸é”ï¼Œæ‰€æœ‰é”éƒ½æœ‰ 5 åˆ†é’Ÿçš„è¶…æ—¶æ—¶é—´ï¼š
- å®šæœŸæ¸…ç†è¿‡æœŸé”
- é¿å…é”é•¿æœŸå ç”¨å¯¼è‡´æ­»é”

**4. å…¥é˜Ÿå‰æ£€æŸ¥**

åœ¨ä»»åŠ¡å…¥é˜Ÿå‰è¿›è¡Œé”å†²çªæ£€æŸ¥ï¼Œé¿å…ä»»åŠ¡é•¿æ—¶é—´ç­‰å¾…ï¼š
- æå‰å‘ç°å†²çªï¼Œå¿«é€Ÿè¿”å›é”™è¯¯
- å‡å°‘é˜Ÿåˆ—ä¸­çš„æ— æ•ˆä»»åŠ¡

**5. ä»»åŠ¡è¶…æ—¶æ§åˆ¶**

ä¸ºæ¯ä¸ªä»»åŠ¡è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢ä»»åŠ¡é•¿æ—¶é—´å ç”¨èµ„æºï¼š
- è¶…æ—¶åè‡ªåŠ¨ä¸­æ–­ä»»åŠ¡
- é‡Šæ”¾æŒæœ‰çš„é”
- æ ¹æ®é‡è¯•ç­–ç•¥å†³å®šæ˜¯å¦é‡è¯•

**å‚è€ƒæ–‡æ¡£**ï¼š
- `src/core/lock-manager.ts`ï¼šLockManager å®Œæ•´å®ç°
- `src/core/task-queue.ts`ï¼šTaskQueue å®Œæ•´å®ç°
- `src/types.ts`ï¼šILockManager å’Œ ITaskQueue æ¥å£å®šä¹‰
- `docs/å“²å­¦è®¾è®¡æ–‡æ¡£.md`ï¼šç³»ç»Ÿè®¾è®¡å“²å­¦å’Œå¹¶å‘æ§åˆ¶åŸåˆ™

### 3.5 å­˜å‚¨ç»“æ„

Cognitive Razor é‡‡ç”¨æœ¬åœ°ä¼˜å…ˆçš„å­˜å‚¨ç­–ç•¥ï¼Œæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨æ’ä»¶ç›®å½•ä¸‹ã€‚æœ¬èŠ‚æè¿°æ‰€æœ‰æŒä¹…åŒ–æ–‡ä»¶çš„ç”¨é€”ã€æ•°æ®ç»“æ„å’Œè¯»å†™æ—¶æœºã€‚

#### ç›®å½•ç»“æ„

```
.obsidian/plugins/obsidian-cognitive-razor/
â”œâ”€â”€ data.json                    # æ’ä»¶é…ç½®ï¼ˆç”± Obsidian ç®¡ç†ï¼‰
â”œâ”€â”€ data/                        # è¿è¡Œæ—¶æ•°æ®æ ¹ç›®å½•
â”‚   â”œâ”€â”€ app.log                  # å¾ªç¯æ—¥å¿—ï¼ˆ1MBï¼‰
â”‚   â”œâ”€â”€ queue-state.json         # é˜Ÿåˆ—çŠ¶æ€
â”‚   â”œâ”€â”€ duplicate-pairs.json     # é‡å¤å¯¹åˆ—è¡¨
â”‚   â”œâ”€â”€ vectors/                 # å‘é‡ç´¢å¼•ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.json           # å‘é‡ç´¢å¼•å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ Domain/              # Domain ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Issue/               # Issue ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Theory/              # Theory ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Entity/              # Entity ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ Mechanism/           # Mechanism ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â””â”€â”€ snapshots/               # å¿«ç…§ç›®å½•
â”‚       â”œâ”€â”€ index.json           # å¿«ç…§ç´¢å¼•
â”‚       â””â”€â”€ *.json               # å¿«ç…§æ–‡ä»¶
â”œâ”€â”€ prompts/                     # æç¤ºè¯æ¨¡æ¿ç›®å½•
â”‚   â”œâ”€â”€ standardizeClassify.md  # æ ‡å‡†åŒ–å’Œåˆ†ç±»æ¨¡æ¿
â”‚   â”œâ”€â”€ enrich.md                # ä¸°å¯Œæ¨¡æ¿
â”‚   â”œâ”€â”€ reason-domain.md         # Domain æ¨ç†æ¨¡æ¿
â”‚   â”œâ”€â”€ reason-issue.md          # Issue æ¨ç†æ¨¡æ¿
â”‚   â”œâ”€â”€ reason-theory.md         # Theory æ¨ç†æ¨¡æ¿
â”‚   â”œâ”€â”€ reason-entity.md         # Entity æ¨ç†æ¨¡æ¿
â”‚   â”œâ”€â”€ reason-mechanism.md      # Mechanism æ¨ç†æ¨¡æ¿
â”‚   â””â”€â”€ ground.md                # æ¥åœ°éªŒè¯æ¨¡æ¿
â”œâ”€â”€ main.js                      # æ’ä»¶ä»£ç 
â”œâ”€â”€ manifest.json                # æ’ä»¶å…ƒæ•°æ®
â””â”€â”€ styles.css                   # æ’ä»¶æ ·å¼ï¼ˆå¯é€‰ï¼‰
```

**ç›®å½•è®¾è®¡åŸåˆ™**ï¼š

1. **å•æ–‡ä»¶ç›´æ¥æ”¾åœ¨ data/ ä¸‹**ï¼šé¿å…è¿‡åº¦åµŒå¥—ï¼Œæé«˜è®¿é—®æ•ˆç‡
2. **å‘é‡ç´¢å¼•ä½¿ç”¨å­ç›®å½•**ï¼šæŒ‰ç±»å‹åˆ†æ¡¶å­˜å‚¨ï¼Œæ”¯æŒå»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°
3. **å¿«ç…§ä½¿ç”¨å­ç›®å½•**ï¼šå› ä¸ºå¿«ç…§æ–‡ä»¶æ•°é‡å¤šï¼Œä½¿ç”¨å­ç›®å½•ä¾¿äºç®¡ç†
4. **æç¤ºè¯æ¨¡æ¿ç‹¬ç«‹ç›®å½•**ï¼šä¾¿äºç”¨æˆ·è‡ªå®šä¹‰å’Œç‰ˆæœ¬æ§åˆ¶

**å‚è€ƒæ–‡ä»¶**ï¼š
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`initializeDataDirectory()` æ–¹æ³•å®šä¹‰å®Œæ•´çš„ç›®å½•ç»“æ„
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œ`initialize()` æ–¹æ³•åˆ›å»ºç›®å½•å’Œåˆå§‹åŒ–æ–‡ä»¶

---

#### æŒä¹…åŒ–æ–‡ä»¶è¯¦è§£

**1. data.json - æ’ä»¶é…ç½®**

**ç”¨é€”**ï¼šå­˜å‚¨æ’ä»¶çš„æ‰€æœ‰é…ç½®é¡¹

**ç®¡ç†æ–¹å¼**ï¼šç”± Obsidian çš„ `loadData()` å’Œ `saveData()` ç®¡ç†ï¼Œè‡ªåŠ¨å¤„ç†åŸå­å†™å…¥

**æ•°æ®ç»“æ„**ï¼š

```typescript
interface PluginSettings {
  version: string;                    // æ’ä»¶ç‰ˆæœ¬
  language: "zh" | "en";              // ç•Œé¢è¯­è¨€
  advancedMode: boolean;              // é«˜çº§æ¨¡å¼
  namingTemplate: string;             // å‘½åæ¨¡æ¿
  directoryScheme: DirectoryScheme;   // ç›®å½•æ–¹æ¡ˆ
  similarityThreshold: number;        // ç›¸ä¼¼åº¦é˜ˆå€¼
  topK: number;                       // å»é‡æ£€ç´¢æ•°é‡
  concurrency: number;                // å¹¶å‘é™åˆ¶
  autoRetry: boolean;                 // è‡ªåŠ¨é‡è¯•
  maxRetryAttempts: number;           // æœ€å¤§é‡è¯•æ¬¡æ•°
  taskTimeoutMs: number;              // ä»»åŠ¡è¶…æ—¶æ—¶é—´
  maxTaskHistory: number;             // ä»»åŠ¡å†å²ä¸Šé™
  maxSnapshots: number;               // å¿«ç…§æ•°é‡ä¸Šé™
  maxSnapshotAgeDays: number;         // å¿«ç…§ä¿ç•™å¤©æ•°
  enableGrounding: boolean;           // å¯ç”¨æ¥åœ°éªŒè¯
  providers: Record<string, ProviderConfig>;  // Provider é…ç½®
  defaultProviderId: string;          // é»˜è®¤ Provider
  taskModels: Record<TaskType, TaskModelConfig>;  // ä»»åŠ¡æ¨¡å‹é…ç½®
  logLevel: "debug" | "info" | "warn" | "error";  // æ—¥å¿—çº§åˆ«
  logFormat: "json" | "pretty" | "compact";       // æ—¥å¿—æ ¼å¼
  embeddingDimension: number;         // åµŒå…¥å‘é‡ç»´åº¦
}
```

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`onload()`ï¼‰
- å¤–éƒ¨è®¾ç½®å˜æ›´æ—¶ï¼ˆ`onExternalSettingsChange()`ï¼ŒObsidian 1.5.7+ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- ç”¨æˆ·ä¿®æ”¹è®¾ç½®æ—¶ï¼ˆé€šè¿‡ SettingsTabï¼‰
- ç¨‹åºæ›´æ–°é…ç½®æ—¶ï¼ˆå¦‚æ·»åŠ /åˆ é™¤ Providerï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šPluginSettings æ¥å£å®šä¹‰å’Œæ‰€æœ‰é…ç½®ç›¸å…³ç±»å‹
- `src/data/settings-store.ts`ï¼šSettingsStore å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬åŠ è½½ã€ä¿å­˜å’Œè®¢é˜…æœºåˆ¶
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œ`loadSettings()` æ–¹æ³•å±•ç¤ºè®¾ç½®åŠ è½½æµç¨‹

---

**2. data/queue-state.json - é˜Ÿåˆ—çŠ¶æ€**

**ç”¨é€”**ï¼šæŒä¹…åŒ–ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€ï¼Œæ”¯æŒæ–­ç”µæ¢å¤

**æ•°æ®ç»“æ„**ï¼š

```typescript
interface QueueStateFile {
  version: string;                    // é˜Ÿåˆ—çŠ¶æ€ç‰ˆæœ¬
  tasks: TaskRecord[];                // ä»»åŠ¡åˆ—è¡¨
  concurrency: number;                // å½“å‰å¹¶å‘æ•°
  paused: boolean;                    // æ˜¯å¦æš‚åœ
  stats: {                            // ç»Ÿè®¡ä¿¡æ¯
    totalProcessed: number;           // å·²å¤„ç†ä»»åŠ¡æ•°
    totalFailed: number;              // å¤±è´¥ä»»åŠ¡æ•°
    totalCancelled: number;           // å–æ¶ˆä»»åŠ¡æ•°
    lastProcessedAt?: string;         // æœ€åå¤„ç†æ—¶é—´
  };
  locks: LockRecord[];                // é”çŠ¶æ€
}

interface TaskRecord {
  id: string;                         // ä»»åŠ¡ ID
  nodeId: string;                     // å…³è”çš„èŠ‚ç‚¹ ID
  taskType: TaskType;                 // ä»»åŠ¡ç±»å‹
  state: TaskState;                   // ä»»åŠ¡çŠ¶æ€
  providerRef?: string;               // Provider å¼•ç”¨
  promptRef?: string;                 // Prompt å¼•ç”¨
  attempt: number;                    // å½“å‰å°è¯•æ¬¡æ•°
  maxAttempts: number;                // æœ€å¤§å°è¯•æ¬¡æ•°
  payload: Record<string, unknown>;   // ä»»åŠ¡è½½è·
  result?: Record<string, unknown>;   // ä»»åŠ¡ç»“æœ
  undoPointer?: string;               // æ’¤é”€æŒ‡é’ˆï¼ˆå¿«ç…§ IDï¼‰
  lockKey?: string;                   // é”é”®
  typeLockKey?: string;               // ç±»å‹é”é”®
  created: string;                    // åˆ›å»ºæ—¶é—´
  updated: string;                    // æ›´æ–°æ—¶é—´
  startedAt?: string;                 // å¼€å§‹æ—¶é—´
  completedAt?: string;               // å®Œæˆæ—¶é—´
  errors?: TaskError[];               // é”™è¯¯å†å²
}
```

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`TaskQueue.initialize()`ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- ä»»åŠ¡å…¥é˜Ÿæ—¶
- ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¶ï¼ˆPending â†’ Running â†’ Completed/Failedï¼‰
- é˜Ÿåˆ—æš‚åœ/æ¢å¤æ—¶
- ä»»åŠ¡å–æ¶ˆæ—¶

**å†™å…¥æ–¹å¼**ï¼šåŸå­å†™å…¥ï¼ˆ`atomicWrite`ï¼‰ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šQueueStateFileã€TaskRecordã€TaskState ç­‰æ¥å£å®šä¹‰
- `src/core/task-queue.ts`ï¼šTaskQueue å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ `saveQueue()` å’Œ `restoreQueueState()` æ–¹æ³•
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾›åŸå­å†™å…¥åŠŸèƒ½

---

**3. data/vectors/ - å‘é‡ç´¢å¼•ç›®å½•ï¼ˆæ–°æ¶æ„ v2.0ï¼‰**

**ç”¨é€”**ï¼šå­˜å‚¨æ‰€æœ‰æ¦‚å¿µçš„å‘é‡åµŒå…¥ï¼Œç”¨äºç›¸ä¼¼åº¦æœç´¢å’Œå»é‡æ£€æµ‹

**æ¶æ„è¯´æ˜**ï¼š

æ–°æ¶æ„é‡‡ç”¨åˆ†æ¡¶å­˜å‚¨ç­–ç•¥ï¼Œæ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ä¸ºå•ä¸ªæ–‡ä»¶ï¼Œæ”¯æŒå»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°ã€‚

**ç›®å½•ç»“æ„**ï¼š

```
data/vectors/
â”œâ”€â”€ index.json              # è½»é‡çº§å…ƒæ•°æ®ç´¢å¼•
â”œâ”€â”€ Domain/                 # Domain ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”œâ”€â”€ {uid1}.json
â”‚   â””â”€â”€ {uid2}.json
â”œâ”€â”€ Issue/                  # Issue ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Theory/                 # Theory ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Entity/                 # Entity ç±»å‹å‘é‡æ–‡ä»¶
â””â”€â”€ Mechanism/              # Mechanism ç±»å‹å‘é‡æ–‡ä»¶
```

**å…ƒæ•°æ®ç´¢å¼•ç»“æ„**ï¼ˆ`data/vectors/index.json`ï¼‰ï¼š

```typescript
interface VectorIndexMeta {
  version: string;          // ç´¢å¼•ç‰ˆæœ¬ï¼ˆå½“å‰ä¸º "2.0"ï¼‰
  lastUpdated: number;      // æœ€åæ›´æ–°æ—¶é—´æˆ³
  stats: {
    totalConcepts: number;
    byType: Record<CRType, number>;
  };
  concepts: Record<string, ConceptMeta>;  // UID â†’ å…ƒæ•°æ®æ˜ å°„
}

interface ConceptMeta {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  filePath: string;         // å‘é‡æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ "Domain/uid.json"ï¼‰
  lastModified: number;     // æœ€åä¿®æ”¹æ—¶é—´æˆ³
  hasEmbedding: boolean;    // æ˜¯å¦æœ‰åµŒå…¥å‘é‡
}
```

**å•ä¸ªæ¦‚å¿µå‘é‡æ–‡ä»¶ç»“æ„**ï¼ˆ`data/vectors/{type}/{uid}.json`ï¼‰ï¼š

```typescript
interface ConceptVector {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  embedding: number[];      // å‘é‡åµŒå…¥
  metadata: {
    createdAt: number;      // åˆ›å»ºæ—¶é—´æˆ³
    updatedAt: number;      // æ›´æ–°æ—¶é—´æˆ³
    embeddingModel: string; // åµŒå…¥æ¨¡å‹ï¼ˆå¦‚ "text-embedding-3-small"ï¼‰
    dimensions: number;     // å‘é‡ç»´åº¦ï¼ˆå¦‚ 1536ï¼‰
  };
}
```

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼šè¯»å–å…ƒæ•°æ®ç´¢å¼•ï¼ˆ`data/vectors/index.json`ï¼‰
- å»é‡æ£€æµ‹æ—¶ï¼šæŒ‰éœ€åŠ è½½åŒç±»å‹çš„å‘é‡æ–‡ä»¶

**å†™å…¥æ—¶æœº**ï¼š
- åµŒå…¥ç”Ÿæˆå®Œæˆæ—¶ï¼šå†™å…¥å•ä¸ªå‘é‡æ–‡ä»¶å¹¶æ›´æ–°å…ƒæ•°æ®ç´¢å¼•
- æ¦‚å¿µåˆ é™¤æ—¶ï¼šåˆ é™¤å‘é‡æ–‡ä»¶å¹¶æ›´æ–°å…ƒæ•°æ®ç´¢å¼•

**å†™å…¥æ–¹å¼**ï¼šæ™®é€šå†™å…¥ï¼ˆ`write`ï¼‰ï¼Œå› ä¸ºå‘é‡æ•°æ®å¯ä»ç¬”è®°æ–‡ä»¶é‡å»º

**æ–°æ¶æ„ä¼˜åŠ¿**ï¼š
1. **å»¶è¿ŸåŠ è½½**ï¼šå…ƒæ•°æ®ç´¢å¼•è½»é‡çº§ï¼Œå‘é‡æ•°æ®æŒ‰éœ€åŠ è½½
2. **å¢é‡æ›´æ–°**ï¼šå•ä¸ªæ¦‚å¿µçš„å¢åˆ æ”¹åªå½±å“ä¸€ä¸ªæ–‡ä»¶
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§è§„æ¨¡çŸ¥è¯†åº“ï¼ˆæ•°ä¸‡ä¸ªæ¦‚å¿µï¼‰
4. **è°ƒè¯•å‹å¥½**ï¼šæ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ï¼Œä¾¿äºæ£€æŸ¥

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šVectorIndexMetaã€ConceptMetaã€ConceptVector ç­‰æ¥å£å®šä¹‰
- `src/core/vector-index.ts`ï¼šVectorIndex å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬åˆ†æ¡¶å­˜å‚¨ã€å»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾› `readVectorFile()`ã€`writeVectorFile()` ç­‰æ–¹æ³•

---

**4. data/duplicate-pairs.json - é‡å¤å¯¹åˆ—è¡¨**

**ç”¨é€”**ï¼šå­˜å‚¨æ£€æµ‹åˆ°çš„é‡å¤æ¦‚å¿µå¯¹ï¼Œç”¨äºåˆå¹¶æµç¨‹

**æ•°æ®ç»“æ„
  model: string;                      // åµŒå…¥æ¨¡å‹æ ‡è¯†
  dimension: number;                  // å‘é‡ç»´åº¦
  buckets: Record<CRType, VectorEntry[]>;  // æŒ‰ç±»å‹åˆ†æ¡¶
  metadata: {
    totalCount: number;               // æ€»æ¡ç›®æ•°
    lastUpdated: string;              // æœ€åæ›´æ–°æ—¶é—´
  };
}

interface VectorEntry {
  uid: string;                        // æ¦‚å¿µ UID
  type: CRType;                       // çŸ¥è¯†ç±»å‹
  embedding: number[];                // å‘é‡åµŒå…¥
  name: string;                       // æ¦‚å¿µåç§°
  path: string;                       // æ–‡ä»¶è·¯å¾„
  updated: string;                    // æ›´æ–°æ—¶é—´
}
```

**åˆ†æ¡¶ç­–ç•¥**ï¼š

ç³»ç»ŸæŒ‰ç…§æ¦‚å¿µç±»å‹ï¼ˆCRTypeï¼‰å°†å‘é‡æ¡ç›®åˆ†æ¡¶å­˜å‚¨ï¼š

```json
{
  "version": "1.0.0",
  "model": "text-embedding-3-small",
  "dimension": 1536,
  "buckets": {
    "Domain": [
      { "uid": "...", "type": "Domain", "embedding": [...], "name": "...", "path": "...", "updated": "..." }
    ],
    "Issue": [...],
    "Theory": [...],
    "Entity": [...],
    "Mechanism": [...]
  },
  "metadata": {
    "totalCount": 100,
    "lastUpdated": "2025-12-10T10:00:00.000Z"
  }
}
```

**åˆ†æ¡¶çš„ä¼˜åŠ¿**ï¼š
- å»é‡æ£€æµ‹æ—¶åªéœ€æœç´¢åŒç±»å‹çš„æ¡¶ï¼Œé¿å…è·¨ç±»å‹è¯¯åˆ¤
- æé«˜æœç´¢æ•ˆç‡ï¼ˆå‡å°‘æœç´¢ç©ºé—´ï¼‰
- ä¾¿äºç»Ÿè®¡æ¯ç§ç±»å‹çš„æ¦‚å¿µæ•°é‡

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`VectorIndex.load()`ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- åµŒå…¥ç”Ÿæˆå®Œæˆæ—¶ï¼ˆ`VectorIndex.upsert()`ï¼‰
- æ¦‚å¿µåˆ é™¤æ—¶ï¼ˆ`VectorIndex.delete()`ï¼‰

**å†™å…¥æ–¹å¼**ï¼šæ™®é€šå†™å…¥ï¼ˆ`write`ï¼‰ï¼Œå› ä¸ºç´¢å¼•å¯ä»¥ä»ç¬”è®°æ–‡ä»¶é‡å»º

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šVectorIndexFileã€VectorEntryã€CRType ç­‰æ¥å£å®šä¹‰
- `src/core/vector-index.ts`ï¼šVectorIndex å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬åˆ†æ¡¶å­˜å‚¨ã€ç›¸ä¼¼åº¦æœç´¢å’Œç´¢å¼•æŒä¹…åŒ–
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾›æ–‡ä»¶è¯»å†™åŠŸèƒ½

---

**4. data/duplicate-pairs.json - é‡å¤å¯¹åˆ—è¡¨**

**ç”¨é€”**ï¼šå­˜å‚¨æ£€æµ‹åˆ°çš„é‡å¤æ¦‚å¿µå¯¹ï¼Œç”¨äºåˆå¹¶æµç¨‹

**æ•°æ®ç»“æ„**ï¼š

```typescript
interface DuplicatePairsStore {
  version: string;                    // ç‰ˆæœ¬
  pairs: DuplicatePair[];             // é‡å¤å¯¹åˆ—è¡¨
  dismissedPairs: string[];           // å·²å¿½ç•¥çš„ pair ID åˆ—è¡¨
}

interface DuplicatePair {
  id: string;                         // é‡å¤å¯¹ ID
  noteA: {
    nodeId: string;                   // ç¬”è®° A çš„ UID
    name: string;                     // ç¬”è®° A çš„åç§°
    path: string;                     // ç¬”è®° A çš„è·¯å¾„
  };
  noteB: {
    nodeId: string;                   // ç¬”è®° B çš„ UID
    name: string;                     // ç¬”è®° B çš„åç§°
    path: string;                     // ç¬”è®° B çš„è·¯å¾„
  };
  type: CRType;                       // çŸ¥è¯†ç±»å‹
  similarity: number;                 // ç›¸ä¼¼åº¦ (0-1)
  detectedAt: string;                 // æ£€æµ‹æ—¶é—´
  status: DuplicatePairStatus;        // çŠ¶æ€
}

type DuplicatePairStatus = "pending" | "merging" | "merged" | "dismissed";
```

**çŠ¶æ€æµè½¬**ï¼š

```mermaid
stateDiagram-v2
    [*] --> pending: æ£€æµ‹åˆ°é‡å¤
    pending --> merging: ç”¨æˆ·å¼€å§‹åˆå¹¶
    pending --> dismissed: ç”¨æˆ·å¿½ç•¥
    merging --> merged: åˆå¹¶å®Œæˆ
    merged --> [*]
    dismissed --> [*]
```

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`DuplicateManager.initialize()`ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- å»é‡æ£€æµ‹å®Œæˆæ—¶ï¼ˆ`DuplicateManager.detect()`ï¼‰
- é‡å¤å¯¹çŠ¶æ€å˜æ›´æ—¶ï¼ˆ`DuplicateManager.updateStatus()`ï¼‰
- åˆå¹¶å®Œæˆæ—¶ï¼ˆ`DuplicateManager.completeMerge()`ï¼‰
- æ ‡è®°ä¸ºéé‡å¤æ—¶ï¼ˆ`DuplicateManager.markAsNonDuplicate()`ï¼‰

**å†™å…¥æ–¹å¼**ï¼šæ™®é€šå†™å…¥ï¼ˆ`write`ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šDuplicatePairsStoreã€DuplicatePairã€DuplicatePairStatus ç­‰æ¥å£å®šä¹‰
- `src/core/duplicate-manager.ts`ï¼šDuplicateManager å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å»é‡æ£€æµ‹ã€çŠ¶æ€ç®¡ç†å’Œäº‹ä»¶å‘å¸ƒ
- `src/core/vector-index.ts`ï¼šVectorIndex å®ç°ï¼Œæä¾›ç›¸ä¼¼åº¦æœç´¢åŠŸèƒ½

---

**5. data/snapshots/index.json - å¿«ç…§ç´¢å¼•**

**ç”¨é€”**ï¼šç»´æŠ¤æ‰€æœ‰å¿«ç…§çš„å…ƒæ•°æ®ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾å’Œæ¢å¤

**æ•°æ®ç»“æ„**ï¼š

```typescript
interface SnapshotIndex {
  version: string;                    // ç‰ˆæœ¬
  snapshots: SnapshotRecord[];        // å¿«ç…§åˆ—è¡¨
  retentionPolicy: {
    maxCount: number;                 // æœ€å¤§å¿«ç…§æ•°é‡
    maxAgeDays: number;               // æœ€å¤§ä¿ç•™å¤©æ•°
  };
}

interface SnapshotRecord {
  id: string;                         // å¿«ç…§ IDï¼ˆUUIDï¼‰
  nodeId: string;                     // å…³è”çš„æ¦‚å¿µ UID
  taskId: string;                     // å…³è”çš„ä»»åŠ¡ ID
  path: string;                       // åŸæ–‡ä»¶è·¯å¾„
  content: string;                    // åŸå§‹ Markdown å†…å®¹
  created: string;                    // åˆ›å»ºæ—¶é—´
  fileSize: number;                   // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  checksum: string;                   // å†…å®¹æ ¡éªŒå’Œï¼ˆMD5ï¼‰
}
```

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`UndoManager.initialize()`ï¼‰
- æ’¤é”€æ“ä½œæ—¶ï¼ˆ`UndoManager.restoreSnapshot()`ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- å¿«ç…§åˆ›å»ºæ—¶ï¼ˆ`UndoManager.createSnapshot()`ï¼‰
- å¿«ç…§åˆ é™¤æ—¶ï¼ˆ`UndoManager.deleteSnapshot()`ï¼‰
- å¿«ç…§æ¸…ç†æ—¶ï¼ˆ`UndoManager.cleanupExpiredSnapshots()`ï¼‰

**å†™å…¥æ–¹å¼**ï¼šåŸå­å†™å…¥ï¼ˆ`atomicWrite`ï¼‰ï¼Œç¡®ä¿ç´¢å¼•å®Œæ•´æ€§

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šSnapshotIndexã€SnapshotRecord ç­‰æ¥å£å®šä¹‰
- `src/core/undo-manager.ts`ï¼šUndoManager å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å¿«ç…§åˆ›å»ºã€æ¢å¤å’Œæ¸…ç†
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾›åŸå­å†™å…¥åŠŸèƒ½ç¡®ä¿å¿«ç…§å®Œæ•´æ€§

---

**6. data/snapshots/*.json - å¿«ç…§æ–‡ä»¶**

**ç”¨é€”**ï¼šå­˜å‚¨æ–‡ä»¶çš„å®Œæ•´å¿«ç…§ï¼Œç”¨äºæ’¤é”€æ“ä½œ

**å‘½åè§„åˆ™**ï¼š`{snapshotId}.json`

**æ•°æ®ç»“æ„**ï¼šä¸ `SnapshotRecord` ç›¸åŒ

**è¯»å–æ—¶æœº**ï¼š
- æ’¤é”€æ“ä½œæ—¶ï¼ˆ`UndoManager.restoreSnapshot()`ï¼‰

**å†™å…¥æ—¶æœº**ï¼š
- å†™å…¥æ“ä½œå‰ï¼ˆ`UndoManager.createSnapshot()`ï¼‰

**å†™å…¥æ–¹å¼**ï¼šåŸå­å†™å…¥ï¼ˆ`atomicWrite`ï¼‰ï¼Œç¡®ä¿å¿«ç…§å®Œæ•´æ€§

**æ¸…ç†ç­–ç•¥**ï¼š
- æŒ‰æ•°é‡æ¸…ç†ï¼šä¿ç•™æœ€è¿‘çš„ N ä¸ªå¿«ç…§ï¼ˆé»˜è®¤ 100ï¼‰
- æŒ‰æ—¶é—´æ¸…ç†ï¼šåˆ é™¤è¶…è¿‡ N å¤©çš„å¿«ç…§ï¼ˆé»˜è®¤ 30 å¤©ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/undo-manager.ts`ï¼šUndoManager å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬å¿«ç…§åˆ›å»ºã€ç´¢å¼•ç®¡ç†å’Œæ¸…ç†ç­–ç•¥
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾›åŸå­å†™å…¥å’Œæ–‡ä»¶ç®¡ç†åŠŸèƒ½

---

**7. data/app.log - å¾ªç¯æ—¥å¿—**

**ç”¨é€”**ï¼šè®°å½•ç³»ç»Ÿè¿è¡Œæ—¥å¿—ï¼Œç”¨äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

**æ—¥å¿—æ ¼å¼**ï¼šæ”¯æŒä¸‰ç§æ ¼å¼ï¼ˆé€šè¿‡ `logFormat` é…ç½®ï¼‰
- `json`ï¼šJSON Lines æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰
- `pretty`ï¼šäººç±»å¯è¯»çš„æ ¼å¼åŒ–è¾“å‡º
- `compact`ï¼šç´§å‡‘çš„å•è¡Œæ ¼å¼

**æ—¥å¿—ç»“æ„**ï¼š

```typescript
interface LogEntry {
  timestamp: string;                  // æ—¶é—´æˆ³
  level: "debug" | "info" | "warn" | "error";  // æ—¥å¿—çº§åˆ«
  module: string;                     // æ¨¡å—åç§°
  message: string;                    // æ¶ˆæ¯
  context?: Record<string, unknown>;  // ä¸Šä¸‹æ–‡æ•°æ®
  error?: {                           // é”™è¯¯ä¿¡æ¯ï¼ˆä»… error çº§åˆ«ï¼‰
    name: string;
    message: string;
    stack?: string;
  };
}
```

**æ—¥å¿—ç¤ºä¾‹ï¼ˆJSON æ ¼å¼ï¼‰**ï¼š

```json
{"timestamp":"2025-12-11T10:00:00.000Z","level":"info","module":"TaskQueue","message":"ä»»åŠ¡çŠ¶æ€å˜æ›´: task-123","context":{"event":"TASK_STATE_CHANGE","taskId":"task-123","previousState":"Pending","newState":"Running"}}
{"timestamp":"2025-12-11T10:00:05.000Z","level":"error","module":"TaskRunner","message":"ä»»åŠ¡æ‰§è¡Œå¤±è´¥","context":{"taskId":"task-123","errorCode":"E100"},"error":{"name":"Error","message":"API è°ƒç”¨å¤±è´¥","stack":"..."}}ntext":{"taskId":"task-123","errorCode":"E100"},"error":{"name":"NetworkError","message":"Connection timeout"}}
```

**å¾ªç¯æ—¥å¿—æœºåˆ¶**ï¼š

- **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š1MB
- **ä¿ç•™è¡Œæ•°**ï¼šæœ€å 1000 è¡Œ
- **æˆªæ–­ç­–ç•¥**ï¼šå½“æ–‡ä»¶è¶…è¿‡ 1MB æ—¶ï¼Œä¿ç•™æœ€å 1000 è¡Œï¼Œåˆ é™¤æ—§æ—¥å¿—

**è¯»å–æ—¶æœº**ï¼š
- æ’ä»¶åŠ è½½æ—¶ï¼ˆ`Logger.initialize()`ï¼‰
- ç”¨æˆ·æŸ¥çœ‹æ—¥å¿—æ—¶

**å†™å…¥æ—¶æœº**ï¼š
- å®æ—¶è¿½åŠ ï¼ˆæ¯æ¬¡æ—¥å¿—è°ƒç”¨ï¼‰

**å†™å…¥æ–¹å¼**ï¼šè¿½åŠ æ¨¡å¼ï¼ˆ`append`ï¼‰ï¼Œé¿å…è¦†ç›–æ—¢æœ‰æ—¥å¿—

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬æ—¥å¿—çº§åˆ«æ§åˆ¶ã€å¾ªç¯æ—¥å¿—å’Œæ ¼å¼åŒ–è¾“å‡º
- `src/types.ts`ï¼šILogger æ¥å£å®šä¹‰å’Œ LogLevel ç±»å‹å®šä¹‰
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œå±•ç¤º Logger åˆå§‹åŒ–å’Œæ—¥å¿—çº§åˆ«åŒæ­¥

---

#### å­˜å‚¨è®¾è®¡åŸåˆ™

**1. æœ¬åœ°ä¼˜å…ˆ**

æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¾èµ–äº‘æœåŠ¡ï¼š
- ä¿æŠ¤ç”¨æˆ·éšç§
- æ”¯æŒç¦»çº¿ä½¿ç”¨
- é¿å…ç½‘ç»œå»¶è¿Ÿ

**2. åŸå­å†™å…¥**

å…³é”®æ•°æ®ä½¿ç”¨åŸå­å†™å…¥æœºåˆ¶ï¼š
- å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆ`.tmp` åç¼€ï¼‰
- æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
- é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶ï¼ˆåŸå­æ“ä½œï¼‰
- é€‚ç”¨äºï¼šå¿«ç…§æ–‡ä»¶ã€é˜Ÿåˆ—çŠ¶æ€

**3. å¯é‡å»ºæ•°æ®**

éƒ¨åˆ†æ•°æ®å¯ä»¥ä»ç¬”è®°æ–‡ä»¶é‡å»ºï¼Œä½¿ç”¨æ™®é€šå†™å…¥ï¼š
- å‘é‡ç´¢å¼•ï¼šå¯ä»¥ä»ç¬”è®°çš„ Frontmatter é‡å»º
- é‡å¤å¯¹åˆ—è¡¨ï¼šå¯ä»¥é‡æ–°è¿è¡Œå»é‡æ£€æµ‹
- ä¼˜åŠ¿ï¼šæé«˜å†™å…¥æ€§èƒ½ï¼Œç®€åŒ–é”™è¯¯å¤„ç†

**4. åˆ†å±‚å­˜å‚¨**

æ ¹æ®æ•°æ®çš„è®¿é—®é¢‘ç‡å’Œé‡è¦æ€§åˆ†å±‚å­˜å‚¨ï¼š
- **çƒ­æ•°æ®**ï¼ˆå†…å­˜ï¼‰ï¼šé˜Ÿåˆ—çŠ¶æ€ã€å‘é‡ç´¢å¼•
- **æ¸©æ•°æ®**ï¼ˆç£ç›˜ï¼‰ï¼šå¿«ç…§ç´¢å¼•ã€é‡å¤å¯¹åˆ—è¡¨
- **å†·æ•°æ®**ï¼ˆç£ç›˜ï¼‰ï¼šå¿«ç…§æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶

**5. å®šæœŸæ¸…ç†**

è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œé¿å…ç£ç›˜ç©ºé—´æµªè´¹ï¼š
- å¿«ç…§ï¼šæŒ‰æ•°é‡å’Œæ—¶é—´æ¸…ç†
- ä»»åŠ¡å†å²ï¼šä¿ç•™æœ€è¿‘ N ä¸ªå·²å®Œæˆä»»åŠ¡
- æ—¥å¿—ï¼šå¾ªç¯æ—¥å¿—ï¼Œä¿ç•™æœ€å 1000 è¡Œ

**å‚è€ƒæ–‡æ¡£**ï¼š
- `src/data/file-storage.ts`ï¼šFileStorage å®Œæ•´å®ç°
- `src/core/undo-manager.ts`ï¼šUndoManager å®ç°ï¼Œå±•ç¤ºåŸå­å†™å…¥çš„ä½¿ç”¨
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œå±•ç¤ºæ•°æ®ç›®å½•åˆå§‹åŒ–å’Œç»„ä»¶ä¾èµ–å…³ç³»
- `docs/å“²å­¦è®¾è®¡æ–‡æ¡£.md`ï¼šç³»ç»Ÿè®¾è®¡å“²å­¦å’Œå­˜å‚¨åŸåˆ™
- `.kiro/steering/tech-stack-reference.md`ï¼šæŠ€æœ¯æ ˆåŸºçº¿è§„èŒƒ

---

## 4. æ•°æ®å±‚è®¾è®¡

### 4.1 FileStorage

**èŒè´£**ï¼šæä¾›æ–‡ä»¶è¯»å†™ã€åŸå­å†™å…¥å’Œç›®å½•ç®¡ç†åŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œæ“ä½œå®‰å…¨æ€§ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`src/data/file-storage.ts`

**å®ç°ç±»**ï¼š`FileStorage implements IFileStorage`

#### æ ¸å¿ƒèŒè´£

FileStorage æ˜¯æ•°æ®å±‚çš„åŸºç¡€ç»„ä»¶ï¼Œè´Ÿè´£æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚å®ƒæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **æ–‡ä»¶è¯»å†™**ï¼šæä¾›ç»Ÿä¸€çš„æ–‡ä»¶è¯»å†™æ¥å£ï¼Œå±è”½åº•å±‚ Obsidian Vault API çš„å¤æ‚æ€§
2. **åŸå­å†™å…¥**ï¼šé€šè¿‡ä¸´æ—¶æ–‡ä»¶å’Œé‡å‘½åæœºåˆ¶ç¡®ä¿å†™å…¥æ“ä½œçš„åŸå­æ€§
3. **ç›®å½•ç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†ç›®å½•ç»“æ„ï¼Œç¡®ä¿æ•°æ®æ–‡ä»¶çš„ç»„ç»‡æ€§
4. **è·¯å¾„è§£æ**ï¼šç»Ÿä¸€å¤„ç†ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œç¡®ä¿è·¯å¾„ä¸€è‡´æ€§
5. **æ•°æ®åˆå§‹åŒ–**ï¼šåœ¨æ’ä»¶å¯åŠ¨æ—¶åˆå§‹åŒ–æ•°æ®ç›®å½•å’Œé»˜è®¤æ–‡ä»¶

#### ä¾èµ–å…³ç³»

```typescript
// æ„é€ å‡½æ•°ä¾èµ–
constructor(
  vault: Vault,           // Obsidian Vault API
  basePath: string        // æ’ä»¶æ•°æ®ç›®å½•åŸºç¡€è·¯å¾„
)
```

**ä¾èµ–è¯´æ˜**ï¼š
- **Vault**ï¼šObsidian æä¾›çš„æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼Œç”¨äºæ–‡ä»¶è¯»å†™æ“ä½œ
- **basePath**ï¼šæ’ä»¶æ•°æ®ç›®å½•çš„åŸºç¡€è·¯å¾„ï¼ˆé€šå¸¸ä¸º `.obsidian/plugins/obsidian-cognitive-razor`ï¼‰

#### è·¯å¾„å¸¸é‡å®šä¹‰

FileStorage å®šä¹‰äº†æ ‡å‡†åŒ–çš„è·¯å¾„å¸¸é‡ï¼Œç¡®ä¿æ•´ä¸ªç³»ç»Ÿä½¿ç”¨ä¸€è‡´çš„è·¯å¾„ï¼š

```typescript
// æ•°æ®ç›®å½•è·¯å¾„å¸¸é‡
export const DATA_DIR = "data";
export const SNAPSHOTS_DIR = `${DATA_DIR}/snapshots`;
export const VECTORS_DIR = `${DATA_DIR}/vectors`;

// æ•°æ®æ–‡ä»¶è·¯å¾„å¸¸é‡
export const QUEUE_STATE_FILE = `${DATA_DIR}/queue-state.json`;
export const VECTOR_INDEX_META_FILE = `${VECTORS_DIR}/index.json`;
export const DUPLICATE_PAIRS_FILE = `${DATA_DIR}/duplicate-pairs.json`;
export const SNAPSHOTS_INDEX_FILE = `${SNAPSHOTS_DIR}/index.json`;
export const APP_LOG_FILE = `${DATA_DIR}/app.log`;
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
import { QUEUE_STATE_FILE, VECTORS_DIR } from './file-storage';

// è¯»å–é˜Ÿåˆ—çŠ¶æ€
const result = await fileStorage.read(QUEUE_STATE_FILE);

// ç¡®ä¿å‘é‡ç›®å½•å­˜åœ¨
await fileStorage.ensureDir(VECTORS_DIR);
```

**ä¼˜åŠ¿**ï¼š
- é¿å…ç¡¬ç¼–ç è·¯å¾„å­—ç¬¦ä¸²ï¼Œå‡å°‘æ‹¼å†™é”™è¯¯
- ç»Ÿä¸€è·¯å¾„ç®¡ç†ï¼Œä¾¿äºé‡æ„å’Œç»´æŠ¤
- ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥è·¯å¾„å¼•ç”¨

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `initialize()` | `async initialize(): Promise<Result<void>>` | åˆå§‹åŒ–ç›®å½•ç»“æ„å’Œæ•°æ®æ–‡ä»¶ |
| `read(path)` | `async read(path: string): Promise<Result<string>>` | è¯»å–æ–‡ä»¶å†…å®¹ |
| `write(path, content)` | `async write(path: string, content: string): Promise<Result<void>>` | æ™®é€šå†™å…¥ï¼ˆéåŸå­ï¼‰ |
| `atomicWrite(path, content)` | `async atomicWrite(path: string, content: string): Promise<Result<void>>` | åŸå­å†™å…¥ï¼ˆä¸´æ—¶æ–‡ä»¶ + é‡å‘½åï¼‰ |
| `delete(path)` | `async delete(path: string): Promise<Result<void>>` | åˆ é™¤æ–‡ä»¶ |
| `exists(path)` | `async exists(path: string): Promise<boolean>` | æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ |
| `ensureDir(path)` | `async ensureDir(path: string): Promise<Result<void>>` | ç¡®ä¿ç›®å½•å­˜åœ¨ï¼ˆé€’å½’åˆ›å»ºï¼‰ |
| `rename(oldPath, newPath)` | `async rename(oldPath: string, newPath: string): Promise<Result<void>>` | é‡å‘½åæ–‡ä»¶ |
| `writeVectorFile(type, conceptId, data)` | `async writeVectorFile(type: CRType, conceptId: string, data: ConceptVector): Promise<Result<void>>` | å†™å…¥å‘é‡æ–‡ä»¶ |
| `readVectorFile(type, conceptId)` | `async readVectorFile(type: CRType, conceptId: string): Promise<Result<ConceptVector>>` | è¯»å–å‘é‡æ–‡ä»¶ |
| `deleteVectorFile(type, conceptId)` | `async deleteVectorFile(type: CRType, conceptId: string): Promise<Result<void>>` | åˆ é™¤å‘é‡æ–‡ä»¶ |
| `readVectorIndexMeta()` | `async readVectorIndexMeta(): Promise<Result<VectorIndexMeta>>` | è¯»å–å‘é‡ç´¢å¼•å…ƒæ•°æ® |
| `writeVectorIndexMeta(meta)` | `async writeVectorIndexMeta(meta: VectorIndexMeta): Promise<Result<void>>` | å†™å…¥å‘é‡ç´¢å¼•å…ƒæ•°æ® |

#### åŸå­å†™å…¥æœºåˆ¶

åŸå­å†™å…¥æ˜¯ FileStorage çš„æ ¸å¿ƒç‰¹æ€§ï¼Œç¡®ä¿å†™å…¥æ“ä½œçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚å®ç°æœºåˆ¶å¦‚ä¸‹ï¼š

**æ­¥éª¤ 1ï¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶**

```typescript
const tempPath = `${fullPath}.tmp`;
await this.vault.adapter.write(tempPath, content);
```

å°†å†…å®¹å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆ`.tmp` åç¼€ï¼‰ï¼Œé¿å…ç›´æ¥ä¿®æ”¹ç›®æ ‡æ–‡ä»¶ã€‚

**æ­¥éª¤ 2ï¼šæ ¡éªŒå†™å…¥å®Œæ•´æ€§**

```typescript
const actualContent = await this.vault.adapter.read(tempPath);
if (actualContent !== expectedContent) {
  throw new Error("Write integrity check failed");
}
```

è¯»å–ä¸´æ—¶æ–‡ä»¶å¹¶ä¸åŸå§‹å†…å®¹æ¯”è¾ƒï¼Œç¡®ä¿å†™å…¥è¿‡ç¨‹æ²¡æœ‰æ•°æ®æŸåã€‚

**æ­¥éª¤ 3ï¼šå¤‡ä»½åŸæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰**

```typescript
if (await this.exists(fullPath)) {
  const originalContent = await this.vault.adapter.read(fullPath);
  await this.vault.adapter.write(backupPath, originalContent);
  await this.vault.adapter.remove(fullPath);
}
```

å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œå…ˆåˆ›å»ºå¤‡ä»½ï¼ˆ`.bak` åç¼€ï¼‰ï¼Œç„¶ååˆ é™¤åŸæ–‡ä»¶ã€‚

**æ­¥éª¤ 4ï¼šé‡å‘½åä¸´æ—¶æ–‡ä»¶ä¸ºç›®æ ‡æ–‡ä»¶**

```typescript
await this.vault.adapter.rename(tempPath, fullPath);
```

å°†ä¸´æ—¶æ–‡ä»¶é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶ã€‚ç”±äºæ–‡ä»¶ç³»ç»Ÿçš„ `rename` æ“ä½œæ˜¯åŸå­çš„ï¼Œè¿™ä¸€æ­¥ç¡®ä¿äº†æ“ä½œçš„åŸå­æ€§ã€‚

**æ­¥éª¤ 5ï¼šæ¸…ç†å¤‡ä»½æ–‡ä»¶**

```typescript
await this.cleanupTempFile(backupPath);
```

æ“ä½œæˆåŠŸåï¼Œåˆ é™¤å¤‡ä»½æ–‡ä»¶ã€‚

**é”™è¯¯æ¢å¤æœºåˆ¶**

å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼ŒåŸå­å†™å…¥ä¼šå°è¯•æ¢å¤ï¼š

- å¦‚æœæ­¥éª¤ 1-2 å¤±è´¥ï¼šåˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œç›®æ ‡æ–‡ä»¶ä¿æŒä¸å˜
- å¦‚æœæ­¥éª¤ 3-4 å¤±è´¥ï¼šå°è¯•ä»å¤‡ä»½æ¢å¤åŸæ–‡ä»¶
- å¦‚æœæ¢å¤å¤±è´¥ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä½†ä¸æ©ç›–åŸå§‹é”™è¯¯

è¿™ç§æœºåˆ¶ç¡®ä¿äº†ï¼š
- **åŸå­æ€§**ï¼šè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†å†™å…¥
- **ä¸€è‡´æ€§**ï¼šç›®æ ‡æ–‡ä»¶å§‹ç»ˆå¤„äºæœ‰æ•ˆçŠ¶æ€
- **æŒä¹…æ€§**ï¼šå†™å…¥æˆåŠŸåï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±
- **éš”ç¦»æ€§**ï¼šå¹¶å‘å†™å…¥ä¸ä¼šç›¸äº’å¹²æ‰°ï¼ˆé€šè¿‡é”æœºåˆ¶ä¿è¯ï¼‰

#### ç›®å½•ç»“æ„åˆå§‹åŒ–

FileStorage åœ¨ `initialize()` æ–¹æ³•ä¸­åˆ›å»ºä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
.obsidian/plugins/obsidian-cognitive-razor/
â”œâ”€â”€ data/                          # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ queue-state.json          # é˜Ÿåˆ—çŠ¶æ€
â”‚   â”œâ”€â”€ vectors/                  # å‘é‡ç´¢å¼•ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.json            # å‘é‡ç´¢å¼•å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ Domain/               # Domain ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Issue/                # Issue ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Theory/               # Theory ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ Entity/               # Entity ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ Mechanism/            # Mechanism ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”œâ”€â”€ duplicate-pairs.json      # é‡å¤å¯¹åˆ—è¡¨
â”‚   â”œâ”€â”€ app.log                   # åº”ç”¨æ—¥å¿—
â”‚   â””â”€â”€ snapshots/                # å¿«ç…§ç›®å½•
â”‚       â”œâ”€â”€ index.json            # å¿«ç…§ç´¢å¼•
â”‚       â””â”€â”€ *.json                # å¿«ç…§æ–‡ä»¶
```

åˆå§‹åŒ–è¿‡ç¨‹ï¼š

1. åˆ›å»º `data/` ç›®å½•
2. åˆ›å»º `data/vectors/` åŠå…¶å­ç›®å½•ï¼ˆDomainã€Issueã€Theoryã€Entityã€Mechanismï¼‰
3. åˆ›å»º `data/snapshots/` å­ç›®å½•
4. åˆå§‹åŒ– `queue-state.json`ï¼ˆæ€»æ˜¯é‡æ–°åˆ›å»ºï¼‰
5. åˆå§‹åŒ– `vectors/index.json`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
6. åˆå§‹åŒ– `duplicate-pairs.json`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
7. åˆå§‹åŒ– `snapshots/index.json`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œ`initialize()` æ–¹æ³•

#### è·¯å¾„è§£ææœºåˆ¶

FileStorage ä½¿ç”¨ `resolvePath()` æ–¹æ³•ç»Ÿä¸€å¤„ç†è·¯å¾„ï¼š

```typescript
private resolvePath(relativePath: string): string {
  if (!this.basePath) {
    return relativePath;
  }
  return `${this.basePath}/${relativePath}`;
}
```

- **ç›¸å¯¹è·¯å¾„**ï¼šå¦‚ `data/queue-state.json`
- **å®Œæ•´è·¯å¾„**ï¼šå¦‚ `.obsidian/plugins/obsidian-cognitive-razor/data/queue-state.json`

è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿ï¼š
- æ‰€æœ‰è·¯å¾„éƒ½ç›¸å¯¹äºæ’ä»¶ç›®å½•ï¼Œä¾¿äºæµ‹è¯•å’Œè¿ç§»
- é¿å…ç¡¬ç¼–ç ç»å¯¹è·¯å¾„ï¼Œæé«˜ä»£ç å¯ç§»æ¤æ€§
- ç»Ÿä¸€è·¯å¾„å¤„ç†é€»è¾‘ï¼Œå‡å°‘è·¯å¾„æ‹¼æ¥é”™è¯¯

#### é”™è¯¯å¤„ç†

FileStorage ä½¿ç”¨ Result Monad æ¨¡å¼å¤„ç†é”™è¯¯ï¼Œæ‰€æœ‰æ–¹æ³•è¿”å› `Result<T>` ç±»å‹ï¼š

```typescript
// æˆåŠŸç¤ºä¾‹
return ok(content);

// å¤±è´¥ç¤ºä¾‹
return err("E300", "Failed to read file", error);
```

**é”™è¯¯ç **ï¼š
- **E300**ï¼šæ–‡ä»¶è¯»å–å¤±è´¥
- **E301**ï¼šæ–‡ä»¶å†™å…¥å¤±è´¥

**é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š
- æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åŒ…è£¹åœ¨ try-catch ä¸­
- é”™è¯¯ä¿¡æ¯åŒ…å«æ–‡ä»¶è·¯å¾„å’ŒåŸå§‹é”™è¯¯å¯¹è±¡
- ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå§‹ç»ˆè¿”å› Result å¯¹è±¡

#### ä½¿ç”¨ç¤ºä¾‹

**æ™®é€šè¯»å†™**ï¼š

```typescript
// è¯»å–æ–‡ä»¶
const result = await fileStorage.read("data/queue-state.json");
if (result.ok) {
  const content = result.value;
  // å¤„ç†å†…å®¹
} else {
  console.error(result.error);
}

// å†™å…¥æ–‡ä»¶
const writeResult = await fileStorage.write("data/queue-state.json", JSON.stringify(data));
if (!writeResult.ok) {
  console.error(writeResult.error);
}
```

**åŸå­å†™å…¥**ï¼š

```typescript
// åŸå­å†™å…¥ï¼ˆç”¨äºå…³é”®æ•°æ®ï¼‰
const atomicResult = await fileStorage.atomicWrite(
  "data/snapshots/snapshot-123.json",
  JSON.stringify(snapshot)
);
if (!atomicResult.ok) {
  console.error("Atomic write failed:", atomicResult.error);
}
```

**ç›®å½•ç®¡ç†**ï¼š

```typescript
// ç¡®ä¿ç›®å½•å­˜åœ¨
const dirResult = await fileStorage.ensureDir("data/custom");
if (dirResult.ok) {
  // ç›®å½•å·²åˆ›å»ºæˆ–å·²å­˜åœ¨
}

// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
const exists = await fileStorage.exists("data/queue-state.json");
if (exists) {
  // æ–‡ä»¶å­˜åœ¨
}
```

#### è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**ï¼šåªæä¾›å¿…è¦çš„æ–‡ä»¶æ“ä½œæ¥å£ï¼Œä¸æš´éœ²åº•å±‚ Vault API
2. **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½è¿›è¡Œé”™è¯¯æ£€æŸ¥å’Œè¾¹ç•Œæ¡ä»¶å¤„ç†
3. **åŸå­æ€§ä¿è¯**ï¼šå…³é”®æ•°æ®å†™å…¥ä½¿ç”¨åŸå­æ“ä½œï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
4. **è·¯å¾„ä¸€è‡´æ€§**ï¼šç»Ÿä¸€è·¯å¾„è§£æé€»è¾‘ï¼Œé¿å…è·¯å¾„æ‹¼æ¥é”™è¯¯
5. **å¯æµ‹è¯•æ€§**ï¼šé€šè¿‡ä¾èµ–æ³¨å…¥ Vault å®ä¾‹ï¼Œä¾¿äºå•å…ƒæµ‹è¯•

**å‚è€ƒéœ€æ±‚**ï¼š
- Requirements 3.1ï¼šæ•°æ®å±‚æ¨¡å—èŒè´£å’Œæ¥å£
- Requirements 3.4ï¼šæ¨¡å—æ¥å£çš„å…³é”®æ–¹æ³•
- Requirements 2.8ï¼šåŸå­å†™å…¥æœºåˆ¶ï¼ˆè®¾è®¡æ–‡æ¡£ï¼‰

### 4.2 Logger

**èŒè´£**ï¼šæä¾›ç»“æ„åŒ–æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Œæ”¯æŒæ—¥å¿—çº§åˆ«æ§åˆ¶ã€å¾ªç¯æ—¥å¿—å’Œå¤šç§è¾“å‡ºæ ¼å¼ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`src/data/logger.ts`

#### æ ¸å¿ƒèŒè´£

Logger æ˜¯æ•°æ®å±‚çš„æ—¥å¿—è®°å½•ç»„ä»¶ï¼Œè´Ÿè´£è®°å½•ç³»ç»Ÿè¿è¡Œæ—¶çš„æ‰€æœ‰å…³é”®äº‹ä»¶ã€‚å®ƒæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ JSON æ ¼å¼è®°å½•æ—¥å¿—ï¼Œä¾¿äºè§£æå’Œåˆ†æ
2. **æ—¥å¿—çº§åˆ«æ§åˆ¶**ï¼šæ”¯æŒ debugã€infoã€warnã€error å››ä¸ªçº§åˆ«
3. **å¾ªç¯æ—¥å¿—æœºåˆ¶**ï¼šè‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼Œä¿æŒæ—¥å¿—æ–‡ä»¶å¤§å°åœ¨ 1MB ä»¥å†…
4. **å¤šç§è¾“å‡ºæ ¼å¼**ï¼šæ”¯æŒ JSONã€Prettyã€Compact ä¸‰ç§æ ¼å¼
5. **è¿½è¸ª ID å…³è”**ï¼šæ”¯æŒä¸ºåŒä¸€æ“ä½œçš„å¤šæ¡æ—¥å¿—åˆ†é…è¿½è¸ª ID
6. **ä¼šè¯ç®¡ç†**ï¼šè®°å½•ä¼šè¯å¼€å§‹æ ‡è®°ï¼Œä¾¿äºåŒºåˆ†ä¸åŒçš„è¿è¡Œä¼šè¯
7. **æ—¥å¿—æŸ¥è¯¢**ï¼šæä¾›æŒ‰çº§åˆ«ã€æ¨¡å—ã€è¿½è¸ª IDã€äº‹ä»¶ç±»å‹ç­‰ç»´åº¦çš„æŸ¥è¯¢åŠŸèƒ½

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `initialize()` | `async initialize(): Promise<void>` | åˆå§‹åŒ– Loggerï¼Œè¯»å–æ—¢æœ‰æ—¥å¿—æ–‡ä»¶ |
| `debug(module, message, context?)` | `debug(module: string, message: string, context?: Record<string, unknown>): void` | è®°å½•è°ƒè¯•æ—¥å¿— |
| `info(module, message, context?)` | `info(module: string, message: string, context?: Record<string, unknown>): void` | è®°å½•ä¿¡æ¯æ—¥å¿— |
| `warn(module, message, context?)` | `warn(module: string, message: string, context?: Record<string, unknown>): void` | è®°å½•è­¦å‘Šæ—¥å¿— |
| `error(module, message, error?, context?)` | `error(module: string, message: string, error?: Error, context?: Record<string, unknown>): void` | è®°å½•é”™è¯¯æ—¥å¿— |
| `errorWithCode(module, errorCode, message, error?, context?)` | `errorWithCode(module: string, errorCode: string, message: string, error?: Error, context?: Record<string, unknown>): void` | è®°å½•å¸¦é”™è¯¯ç çš„é”™è¯¯æ—¥å¿— |
| `setLogLevel(level)` | `setLogLevel(level: LogLevel): void` | è®¾ç½®æœ€å°æ—¥å¿—çº§åˆ« |
| `setFileFormat(format)` | `setFileFormat(format: LogFormat): void` | è®¾ç½®æ–‡ä»¶è¾“å‡ºæ ¼å¼ |
| `setConsoleFormat(format)` | `setConsoleFormat(format: LogFormat): void` | è®¾ç½®æ§åˆ¶å°è¾“å‡ºæ ¼å¼ |
| `generateTraceId()` | `generateTraceId(): string` | ç”Ÿæˆè¿½è¸ª ID |
| `setTraceId(traceId)` | `setTraceId(traceId: string \| null): void` | è®¾ç½®å½“å‰è¿½è¸ª ID |
| `startTrace(operation)` | `startTrace(operation: string): string` | å¼€å§‹ä¸€ä¸ªå¸¦è¿½è¸ª ID çš„æ“ä½œ |
| `endTrace(operation)` | `endTrace(operation: string): void` | ç»“æŸå½“å‰è¿½è¸ª |
| `withTiming(module, operation, fn)` | `async withTiming<T>(module: string, operation: string, fn: () => Promise<T>): Promise<T>` | è®°å½•å¸¦è€—æ—¶çš„æ“ä½œ |
| `filterByLevel(level)` | `filterByLevel(level: LogLevel): LogEntry[]` | æŒ‰çº§åˆ«è¿‡æ»¤æ—¥å¿— |
| `filterByModule(module)` | `filterByModule(module: string): LogEntry[]` | æŒ‰æ¨¡å—è¿‡æ»¤æ—¥å¿— |
| `filterByTraceId(traceId)` | `filterByTraceId(traceId: string): LogEntry[]` | æŒ‰è¿½è¸ª ID è¿‡æ»¤æ—¥å¿— |
| `search(keyword)` | `search(keyword: string): LogEntry[]` | æœç´¢æ—¥å¿—æ¶ˆæ¯ |
| `getErrorSummary()` | `getErrorSummary(): { count: number; byModule: Record<string, number>; byCode: Record<string, number> }` | è·å–é”™è¯¯æ‘˜è¦ |

#### æ—¥å¿—æ ¼å¼

Logger æ”¯æŒä¸‰ç§è¾“å‡ºæ ¼å¼ï¼Œå¯ä»¥åˆ†åˆ«ä¸ºæ–‡ä»¶å’Œæ§åˆ¶å°è®¾ç½®ä¸åŒçš„æ ¼å¼ï¼š

**1. JSON æ ¼å¼ï¼ˆé»˜è®¤æ–‡ä»¶æ ¼å¼ï¼‰**

ç»“æ„åŒ– JSON æ ¼å¼ï¼Œä¾¿äºæœºå™¨è§£æå’Œæ—¥å¿—åˆ†æå·¥å…·å¤„ç†ï¼š

```json
{
  "timestamp": "2025-12-10T10:30:45.123Z",
  "level": "info",
  "module": "TaskQueue",
  "event": "TASK_STATE_CHANGE",
  "message": "ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running",
  "traceId": "abc123",
  "context": {
    "taskId": "task-001",
    "oldState": "Pending",
    "newState": "Running"
  }
}
```

**2. Pretty æ ¼å¼ï¼ˆé»˜è®¤æ§åˆ¶å°æ ¼å¼ï¼‰**

äººç±»å¯è¯»æ ¼å¼ï¼Œå¸¦å›¾æ ‡å’Œç¼©è¿›ï¼Œé€‚åˆå¼€å‘è°ƒè¯•ï¼š

```
10:30:45.123 â„¹ï¸  [TaskQueue][abc123] ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running {taskId=task-001, oldState=Pending, newState=Running}
```

**3. Compact æ ¼å¼**

ç´§å‡‘å•è¡Œæ ¼å¼ï¼Œé€‚åˆå¿«é€Ÿæ‰«æï¼š

```
10:30:45.123 INF TaskQueue[abc123]: ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running {taskId=task-001}
```

#### æ—¥å¿—çº§åˆ«

Logger æ”¯æŒå››ä¸ªæ—¥å¿—çº§åˆ«ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»ä½åˆ°é«˜æ’åˆ—ï¼š

| çº§åˆ« | ä¼˜å…ˆçº§ | ç”¨é€” | å›¾æ ‡ | æ ‡ç­¾ |
|------|--------|------|------|------|
| **debug** | 0 | è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œä»…åœ¨å¼€å‘æ—¶å¯ç”¨ | ğŸ” | DBG |
| **info** | 1 | ä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„å…³é”®äº‹ä»¶ | â„¹ï¸ | INF |
| **warn** | 2 | è­¦å‘Šä¿¡æ¯ï¼Œè¡¨ç¤ºæ½œåœ¨é—®é¢˜ä½†ä¸å½±å“åŠŸèƒ½ | âš ï¸ | WRN |
| **error** | 3 | é”™è¯¯ä¿¡æ¯ï¼Œè¡¨ç¤ºåŠŸèƒ½å¤±è´¥æˆ–å¼‚å¸¸æƒ…å†µ | âŒ | ERR |

**çº§åˆ«è¿‡æ»¤**ï¼š

```typescript
// è®¾ç½®æœ€å°æ—¥å¿—çº§åˆ«ä¸º info
logger.setLogLevel("info");

// æ­¤å debug æ—¥å¿—ä¸ä¼šè¢«è®°å½•
logger.debug("TaskQueue", "è°ƒåº¦å™¨è½®è¯¢"); // ä¸è®°å½•
logger.info("TaskQueue", "ä»»åŠ¡å¼€å§‹æ‰§è¡Œ"); // è®°å½•
```

#### å¾ªç¯æ—¥å¿—æœºåˆ¶

Logger å®ç°äº†å¾ªç¯æ—¥å¿—æœºåˆ¶ï¼Œç¡®ä¿æ—¥å¿—æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 1MBï¼š

**å·¥ä½œåŸç†**ï¼š

1. **å¤§å°ç›‘æ§**ï¼šæ¯æ¬¡å†™å…¥æ—¥å¿—å‰æ£€æŸ¥å½“å‰æ—¥å¿—å¤§å°
2. **è‡ªåŠ¨æ¸…ç†**ï¼šå¦‚æœè¶…è¿‡ 1MBï¼Œåˆ é™¤æœ€æ—§çš„æ—¥å¿—æ¡ç›®
3. **ä¿ç•™ç­–ç•¥**ï¼šåˆ é™¤è¶³å¤Ÿçš„æ—§æ—¥å¿—ï¼Œä¸ºæ–°æ—¥å¿—è…¾å‡ºç©ºé—´
4. **è·¨ä¼šè¯ä¿ç•™**ï¼šæ—¥å¿—æ–‡ä»¶åœ¨æ’ä»¶é‡å¯åä¿ç•™ï¼Œæ”¯æŒå†å²æŸ¥è¯¢

**å®ç°ä»£ç **ï¼š

```typescript
private rotateLog(newEntrySize: number): void {
  const targetSize = this.maxLogSize - newEntrySize;
  
  while (this.logBuffer.length > 0 && this.currentSize > targetSize) {
    const removedLine = this.logBuffer.shift();
    if (removedLine) {
      const removedSize = new TextEncoder().encode(removedLine + "\n").length;
      this.currentSize -= removedSize;
    }
  }
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œè¿½è¸ª ID ç”Ÿæˆé€»è¾‘

#### è¿½è¸ª ID æœºåˆ¶

è¿½è¸ª IDï¼ˆTrace IDï¼‰ç”¨äºå…³è”åŒä¸€æ“ä½œçš„å¤šæ¡æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªå®Œæ•´çš„æ‰§è¡Œæµç¨‹ï¼š

**ç”Ÿæˆè¿½è¸ª ID**ï¼š

```typescript
const traceId = logger.generateTraceId();
// ç”Ÿæˆæ ¼å¼ï¼š{timestamp}-{random}ï¼Œå¦‚ "abc123-def456"
```

**ä½¿ç”¨è¿½è¸ª ID**ï¼š

```typescript
// æ–¹å¼ 1ï¼šæ‰‹åŠ¨è®¾ç½®
const traceId = logger.generateTraceId();
logger.setTraceId(traceId);
logger.info("TaskQueue", "ä»»åŠ¡å¼€å§‹æ‰§è¡Œ");
logger.info("TaskRunner", "è°ƒç”¨ AI API");
logger.setTraceId(null); // æ¸…é™¤è¿½è¸ª ID

// æ–¹å¼ 2ï¼šä½¿ç”¨ startTrace/endTrace
const traceId = logger.startTrace("åˆ›å»ºæ¦‚å¿µ");
// ... æ‰§è¡Œæ“ä½œ ...
logger.endTrace("åˆ›å»ºæ¦‚å¿µ");

// æ–¹å¼ 3ï¼šæŸ¥è¯¢ç‰¹å®šè¿½è¸ª ID çš„æ‰€æœ‰æ—¥å¿—
const logs = logger.filterByTraceId(traceId);
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š

```
10:30:45.123 â„¹ï¸  [TaskQueue][abc123] ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
10:30:45.456 â„¹ï¸  [TaskRunner][abc123] è°ƒç”¨ AI API
10:30:46.789 â„¹ï¸  [TaskRunner][abc123] API è°ƒç”¨æˆåŠŸ
```

æ‰€æœ‰å¸¦ `[abc123]` çš„æ—¥å¿—éƒ½å±äºåŒä¸€ä¸ªæ“ä½œï¼Œä¾¿äºè¿½è¸ªå®Œæ•´æµç¨‹ã€‚

#### ä¼šè¯ç®¡ç†

Logger åœ¨åˆå§‹åŒ–æ—¶è‡ªåŠ¨è®°å½•ä¼šè¯å¼€å§‹æ ‡è®°ï¼Œä¾¿äºåŒºåˆ†ä¸åŒçš„è¿è¡Œä¼šè¯ï¼š

**ä¼šè¯ ID ç”Ÿæˆ**ï¼š

```typescript
private generateSessionId(): string {
  const now = new Date();
  const dateStr = now.toISOString().slice(0, 10).replace(/-/g, "");
  const timeStr = now.toISOString().slice(11, 19).replace(/:/g, "");
  const random = Math.random().toString(36).slice(2, 6);
  return `${dateStr}-${timeStr}-${random}`;
}
// ç”Ÿæˆæ ¼å¼ï¼š20251210-103045-a1b2
```

**ä¼šè¯å¼€å§‹æ ‡è®°**ï¼š

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
10:30:45.123 â„¹ï¸  [Session] æ–°ä¼šè¯å¼€å§‹ [20251210-103045-a1b2]
```

è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿ï¼š
- ä¾¿äºåœ¨æ—¥å¿—æ–‡ä»¶ä¸­å¿«é€Ÿå®šä½ä¸åŒçš„è¿è¡Œä¼šè¯
- æ”¯æŒè·¨ä¼šè¯çš„æ—¥å¿—åˆ†æå’Œé—®é¢˜æ’æŸ¥
- ä¼šè¯ ID åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œä¾¿äºæ—¶é—´èŒƒå›´æŸ¥è¯¢

#### è€—æ—¶åŸ‹ç‚¹

Logger æä¾› `withTiming()` æ–¹æ³•ï¼Œè‡ªåŠ¨è®°å½•æ“ä½œè€—æ—¶ï¼š

```typescript
const result = await logger.withTiming(
  "TaskRunner",
  "æ‰§è¡Œä»»åŠ¡",
  async () => {
    // æ‰§è¡Œä»»åŠ¡é€»è¾‘
    return await taskRunner.run(task);
  }
);
```

**æ—¥å¿—è¾“å‡º**ï¼š

```
10:30:45.123 â„¹ï¸  [TaskRunner] æ‰§è¡Œä»»åŠ¡ å®Œæˆ (1234ms) {operation=æ‰§è¡Œä»»åŠ¡, durationMs=1234}
```

å¦‚æœæ“ä½œå¤±è´¥ï¼Œä¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼š

```
10:30:45.123 âŒ [TaskRunner] æ‰§è¡Œä»»åŠ¡ å¤±è´¥ (1234ms) {operation=æ‰§è¡Œä»»åŠ¡, durationMs=1234}
```

#### æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½

Logger æä¾›ä¸°å¯Œçš„æ—¥å¿—æŸ¥è¯¢åŠŸèƒ½ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ•°æ®åˆ†æï¼š

**æŒ‰çº§åˆ«è¿‡æ»¤**ï¼š

```typescript
const errors = logger.filterByLevel("error");
// è¿”å›æ‰€æœ‰ error çº§åˆ«çš„æ—¥å¿—
```

**æŒ‰æ¨¡å—è¿‡æ»¤**ï¼š

```typescript
const taskQueueLogs = logger.filterByModule("TaskQueue");
// è¿”å›æ‰€æœ‰æ¥è‡ª TaskQueue æ¨¡å—çš„æ—¥å¿—
```

**æŒ‰è¿½è¸ª ID è¿‡æ»¤**ï¼š

```typescript
const traceLogs = logger.filterByTraceId("abc123");
// è¿”å›æ‰€æœ‰å¸¦è¿½è¸ª ID "abc123" çš„æ—¥å¿—
```

**æŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤**ï¼š

```typescript
const stateChangeLogs = logger.filterByEvent("TASK_STATE_CHANGE");
// è¿”å›æ‰€æœ‰ä»»åŠ¡çŠ¶æ€å˜æ›´äº‹ä»¶çš„æ—¥å¿—
```

**æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤**ï¼š

```typescript
const startTime = new Date("2025-12-10T10:00:00Z");
const endTime = new Date("2025-12-10T11:00:00Z");
const logs = logger.filterByTimeRange(startTime, endTime);
// è¿”å›æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ—¥å¿—
```

**æœç´¢æ—¥å¿—æ¶ˆæ¯**ï¼š

```typescript
const logs = logger.search("API è°ƒç”¨");
// è¿”å›æ‰€æœ‰åŒ…å« "API è°ƒç”¨" å…³é”®è¯çš„æ—¥å¿—
```

**è·å–é”™è¯¯æ‘˜è¦**ï¼š

```typescript
const summary = logger.getErrorSummary();
// è¿”å›ï¼š
// {
//   count: 5,
//   byModule: { "TaskRunner": 3, "ProviderManager": 2 },
//   byCode: { "E100": 2, "E001": 3 }
// }
```

#### é”™è¯¯ç æ”¯æŒ

Logger æ”¯æŒè®°å½•å¸¦é”™è¯¯ç çš„é”™è¯¯æ—¥å¿—ï¼Œä¾¿äºé”™è¯¯åˆ†ç±»å’Œç»Ÿè®¡ï¼š

```typescript
logger.errorWithCode(
  "TaskRunner",
  "E100",
  "API è°ƒç”¨å¤±è´¥",
  error,
  { providerId: "openai", model: "gpt-4o" }
);
```

**æ—¥å¿—è¾“å‡º**ï¼š

```json
{
  "timestamp": "2025-12-10T10:30:45.123Z",
  "level": "error",
  "module": "TaskRunner",
  "event": "ERROR",
  "message": "API è°ƒç”¨å¤±è´¥",
  "context": {
    "providerId": "openai",
    "model": "gpt-4o",
    "errorCode": "E100",
    "errorCodeName": "NETWORK_ERROR",
    "errorCategory": "network",
    "retryable": true
  },
  "error": {
    "name": "NetworkError",
    "message": "Connection timeout",
    "code": "E100",
    "codeName": "NETWORK_ERROR",
    "fixSuggestion": "æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®è®¤ API ç«¯ç‚¹å¯è®¿é—®"
  }
}
```

é”™è¯¯ç ä¿¡æ¯ä¼šè‡ªåŠ¨ä» `error-codes.ts` ä¸­æŸ¥è¯¢ï¼ŒåŒ…æ‹¬ï¼š
- é”™è¯¯åç§°ï¼ˆcodeNameï¼‰
- é”™è¯¯ç±»åˆ«ï¼ˆerrorCategoryï¼‰
- æ˜¯å¦å¯é‡è¯•ï¼ˆretryableï¼‰
- ä¿®å¤å»ºè®®ï¼ˆfixSuggestionï¼‰

#### ä½¿ç”¨ç¤ºä¾‹

**åŸºæœ¬æ—¥å¿—è®°å½•**ï¼š

```typescript
// è°ƒè¯•æ—¥å¿—
logger.debug("TaskQueue", "è°ƒåº¦å™¨è½®è¯¢", { queueSize: 5 });

// ä¿¡æ¯æ—¥å¿—
logger.info("TaskRunner", "ä»»åŠ¡å¼€å§‹æ‰§è¡Œ", { taskId: "task-001" });

// è­¦å‘Šæ—¥å¿—
logger.warn("ProviderManager", "API å“åº”æ…¢", { latency: 5000 });

// é”™è¯¯æ—¥å¿—
logger.error("TaskRunner", "ä»»åŠ¡æ‰§è¡Œå¤±è´¥", error, { taskId: "task-001" });
```

**å¸¦è¿½è¸ª ID çš„æ—¥å¿—**ï¼š

```typescript
const traceId = logger.startTrace("åˆ›å»ºæ¦‚å¿µ");
logger.info("PipelineOrchestrator", "ç®¡çº¿å¯åŠ¨");
logger.info("TaskQueue", "ä»»åŠ¡å…¥é˜Ÿ");
logger.info("TaskRunner", "ä»»åŠ¡æ‰§è¡Œ");
logger.endTrace("åˆ›å»ºæ¦‚å¿µ");
```

**è€—æ—¶åŸ‹ç‚¹**ï¼š

```typescript
const result = await logger.withTiming(
  "ProviderManager",
  "è°ƒç”¨ AI API",
  async () => {
    return await providerManager.chat(messages);
  }
);
```

**æ—¥å¿—æŸ¥è¯¢**ï¼š

```typescript
// æŸ¥è¯¢æ‰€æœ‰é”™è¯¯æ—¥å¿—
const errors = logger.filterByLevel("error");

// æŸ¥è¯¢ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
const taskQueueLogs = logger.filterByModule("TaskQueue");

// æŸ¥è¯¢ç‰¹å®šè¿½è¸ª ID çš„æ—¥å¿—
const traceLogs = logger.filterByTraceId(traceId);

// æœç´¢åŒ…å«å…³é”®è¯çš„æ—¥å¿—
const apiLogs = logger.search("API");

// è·å–é”™è¯¯æ‘˜è¦
const summary = logger.getErrorSummary();
console.log(`æ€»é”™è¯¯æ•°: ${summary.count}`);
console.log(`æŒ‰æ¨¡å—ç»Ÿè®¡:`, summary.byModule);
console.log(`æŒ‰é”™è¯¯ç ç»Ÿè®¡:`, summary.byCode);
```

#### è®¾è®¡åŸåˆ™

1. **ç»“æ„åŒ–ä¼˜å…ˆ**ï¼šä½¿ç”¨ JSON æ ¼å¼è®°å½•æ—¥å¿—ï¼Œä¾¿äºè§£æå’Œåˆ†æ
2. **äººç±»å¯è¯»**ï¼šæä¾› Pretty å’Œ Compact æ ¼å¼ï¼Œä¾¿äºå¼€å‘è°ƒè¯•
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šå¼‚æ­¥å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
4. **ç©ºé—´å¯æ§**ï¼šå¾ªç¯æ—¥å¿—æœºåˆ¶ç¡®ä¿æ—¥å¿—æ–‡ä»¶å¤§å°å¯æ§
5. **å¯è¿½æº¯æ€§**ï¼šè¿½è¸ª ID æœºåˆ¶æ”¯æŒå®Œæ•´çš„æ“ä½œæµç¨‹è¿½è¸ª
6. **å¯æŸ¥è¯¢æ€§**ï¼šæä¾›ä¸°å¯Œçš„æŸ¥è¯¢æ¥å£ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

**å‚è€ƒéœ€æ±‚**ï¼š
- Requirements 3.1ï¼šæ•°æ®å±‚æ¨¡å—èŒè´£å’Œæ¥å£
- Requirements 3.4ï¼šæ¨¡å—æ¥å£çš„å…³é”®æ–¹æ³•
- Requirements 6.4ï¼šæ—¥å¿—çº§åˆ«ã€æ ¼å¼å’Œå…³é”®äº‹ä»¶çš„è®°å½•è¦æ±‚
- Requirements A-NF-03ï¼šå¯è§‚å¯Ÿæ€§è¦æ±‚ï¼ˆè®¾è®¡æ–‡æ¡£ï¼‰

### 4.3 SettingsStore

**èŒè´£**ï¼šç®¡ç†æ’ä»¶é…ç½®ï¼Œæ”¯æŒè®¾ç½®åŠ è½½ã€ä¿å­˜ã€è®¢é˜…å’Œç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`src/data/settings-store.ts`

#### æ ¸å¿ƒèŒè´£

SettingsStore æ˜¯æ•°æ®å±‚çš„é…ç½®ç®¡ç†ç»„ä»¶ï¼Œè´Ÿè´£æ’ä»¶çš„æ‰€æœ‰é…ç½®é¡¹ã€‚å®ƒæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **è®¾ç½®åŠ è½½**ï¼šä» Obsidian çš„ `data.json` åŠ è½½æ’ä»¶é…ç½®
2. **è®¾ç½®ä¿å­˜**ï¼šå°†é…ç½®æŒä¹…åŒ–åˆ° `data.json`
3. **è®¾ç½®è®¢é˜…**ï¼šæ”¯æŒç›‘å¬é…ç½®å˜æ›´ï¼Œå®æ—¶åŒæ­¥åˆ°å…¶ä»–ç»„ä»¶
4. **ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**ï¼šæ£€æŸ¥é…ç½®ç‰ˆæœ¬ï¼Œä¸å…¼å®¹æ—¶é‡ç½®ä¸ºé»˜è®¤å€¼
5. **è®¾ç½®éªŒè¯**ï¼šéªŒè¯é…ç½®ç»“æ„çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
6. **å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒå¯¼å‡ºå®Œæ•´é…ç½®å’Œä» JSON å¯¼å…¥é…ç½®
7. **ä¾¿æ·æ–¹æ³•**ï¼šæä¾› Provider ç®¡ç†ã€ä»»åŠ¡æ¨¡å‹é…ç½®ç­‰ä¾¿æ·æ–¹æ³•

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `loadSettings()` | `async loadSettings(): Promise<Result<void>>` | åŠ è½½è®¾ç½®ï¼ŒéªŒè¯ç‰ˆæœ¬å’Œç»“æ„ |
| `getSettings()` | `getSettings(): PluginSettings` | è·å–å½“å‰è®¾ç½®ï¼ˆå‰¯æœ¬ï¼‰ |
| `updateSettings(partial)` | `async updateSettings(partial: Partial<PluginSettings>): Promise<Result<void>>` | æ›´æ–°éƒ¨åˆ†è®¾ç½® |
| `exportSettings()` | `exportSettings(): string` | å¯¼å‡ºè®¾ç½®ä¸º JSON å­—ç¬¦ä¸² |
| `importSettings(json)` | `async importSettings(json: string): Promise<Result<void>>` | ä» JSON å¯¼å…¥è®¾ç½® |
| `resetToDefaults()` | `async resetToDefaults(): Promise<Result<void>>` | é‡ç½®ä¸ºé»˜è®¤è®¾ç½® |
| `subscribe(listener)` | `subscribe(listener: (settings: PluginSettings) => void): () => void` | è®¢é˜…è®¾ç½®å˜æ›´ |
| `addProvider(id, config)` | `async addProvider(id: string, config: ProviderConfig): Promise<Result<void>>` | æ·»åŠ  Provider |
| `updateProvider(id, updates)` | `async updateProvider(id: string, updates: Partial<ProviderConfig>): Promise<Result<void>>` | æ›´æ–° Provider |
| `removeProvider(id)` | `async removeProvider(id: string): Promise<Result<void>>` | ç§»é™¤ Provider |
| `setDefaultProvider(providerId)` | `async setDefaultProvider(providerId: string): Promise<Result<void>>` | è®¾ç½®é»˜è®¤ Provider |

#### è®¾ç½®æŒä¹…åŒ–æœºåˆ¶

SettingsStore ä½¿ç”¨ Obsidian æä¾›çš„ `loadData()` å’Œ `saveData()` æ–¹æ³•è¿›è¡ŒæŒä¹…åŒ–ï¼š

**æŒä¹…åŒ–è·¯å¾„**ï¼š

```
.obsidian/plugins/obsidian-cognitive-razor/data.json
```

**æŒä¹…åŒ–æµç¨‹**ï¼š

```mermaid
flowchart LR
    Memory[å†…å­˜ä¸­çš„ PluginSettings] -->|saveData| Obsidian[Obsidian Plugin API]
    Obsidian -->|å†™å…¥| DataJson[data.json]
    
    DataJson -->|è¯»å–| Obsidian2[Obsidian Plugin API]
    Obsidian2 -->|loadData| Memory2[å†…å­˜ä¸­çš„ PluginSettings]
    
    style Memory fill:#fff3e0
    style Memory2 fill:#fff3e0
    style DataJson fill:#f1f8e9
```

**æ•æ„Ÿæ•°æ®å¤„ç†**ï¼š

SettingsStore æ”¯æŒ `persistApiKey` é…ç½®ï¼Œæ§åˆ¶ API Key æ˜¯å¦æŒä¹…åŒ–ï¼š

```typescript
// Provider é…ç½®
{
  apiKey: "sk-xxx",
  persistApiKey: true  // true: æŒä¹…åŒ–, false: ä¸æŒä¹…åŒ–
}

// åºåˆ—åŒ–æ—¶å¤„ç†
private serializeSettings(redactAllApiKeys = false): PluginSettings {
  const providers: Record<string, ProviderConfig> = {};
  for (const [id, config] of Object.entries(this.settings.providers)) {
    providers[id] = {
      ...config,
      apiKey: config.persistApiKey === false || redactAllApiKeys ? "" : config.apiKey
    };
  }
  return { ...this.settings, providers };
}
```

- `persistApiKey: true`ï¼šAPI Key ä¼šä¿å­˜åˆ° `data.json`
- `persistApiKey: false`ï¼šAPI Key ä¸ä¼šä¿å­˜ï¼Œæ¯æ¬¡å¯åŠ¨éœ€è¦é‡æ–°è¾“å…¥
- å¯¼å‡ºè®¾ç½®æ—¶ï¼Œæ‰€æœ‰ API Key éƒ½ä¼šè¢«æ¸…ç©ºï¼ˆ`redactAllApiKeys = true`ï¼‰

#### ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

SettingsStore åœ¨åŠ è½½è®¾ç½®æ—¶ä¼šæ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§ï¼Œç¡®ä¿é…ç½®ç»“æ„ä¸å½“å‰ç‰ˆæœ¬åŒ¹é…ï¼š

**ç‰ˆæœ¬æ£€æŸ¥é€»è¾‘**ï¼š

```typescript
private checkVersionCompatibility(version: string): Result<void> {
  // ç®€å•çš„ç‰ˆæœ¬æ£€æŸ¥ï¼šä¸»ç‰ˆæœ¬å·å¿…é¡»åŒ¹é…
  const currentMajor = DEFAULT_SETTINGS.version.split(".")[0];
  const loadedMajor = version.split(".")[0];

  if (currentMajor !== loadedMajor) {
    return err(
      "E302",
      `Incompatible settings version: ${version} (current: ${DEFAULT_SETTINGS.version})`
    );
  }

  return ok(undefined);
}
```

**ç‰ˆæœ¬ä¸å…¼å®¹å¤„ç†**ï¼š

å¦‚æœç‰ˆæœ¬ä¸å…¼å®¹ï¼ŒSettingsStore ä¼šï¼š
1. è®°å½•è­¦å‘Šæ—¥å¿—
2. é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
3. ä¿å­˜é»˜è®¤è®¾ç½®åˆ°ç£ç›˜
4. è¿”å›æˆåŠŸï¼ˆä¸é˜»æ–­æ’ä»¶åŠ è½½ï¼‰

è¿™ç§ç­–ç•¥ç¡®ä¿äº†ï¼š
- æ’ä»¶åœ¨ç‰ˆæœ¬å‡çº§åä»èƒ½æ­£å¸¸è¿è¡Œ
- ç”¨æˆ·ä¸ä¼šå› ä¸ºé…ç½®é—®é¢˜å¯¼è‡´æ’ä»¶æ— æ³•ä½¿ç”¨
- å¼€å‘é˜¶æ®µå¯ä»¥é¢‘ç¹ä¿®æ”¹é…ç½®ç»“æ„è€Œä¸å½±å“æµ‹è¯•

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œè®¾ç½®è¿ç§»é€»è¾‘

#### è®¾ç½®éªŒè¯

SettingsStore æä¾›è¯¦ç»†çš„è®¾ç½®éªŒè¯åŠŸèƒ½ï¼Œç¡®ä¿é…ç½®ç»“æ„çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ï¼š

**éªŒè¯ç»´åº¦**ï¼š

1. **å¿…å¡«å­—æ®µæ£€æŸ¥**ï¼šéªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µæ˜¯å¦å­˜åœ¨
2. **ç±»å‹æ£€æŸ¥**ï¼šéªŒè¯å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®
3. **å€¼åŸŸæ£€æŸ¥**ï¼šéªŒè¯æ•°å€¼æ˜¯å¦åœ¨åˆæ³•èŒƒå›´å†…
4. **æšä¸¾æ£€æŸ¥**ï¼šéªŒè¯æšä¸¾å€¼æ˜¯å¦åˆæ³•
5. **åµŒå¥—å¯¹è±¡æ£€æŸ¥**ï¼šé€’å½’éªŒè¯åµŒå¥—å¯¹è±¡çš„ç»“æ„

**éªŒè¯ç¤ºä¾‹**ï¼š

```typescript
// éªŒè¯ similarityThreshold å­—æ®µ
if (typeof settings.similarityThreshold !== "number") {
  errors.push({
    field: "similarityThreshold",
    message: "similarityThreshold must be a number",
    expectedType: "number",
    actualType: typeof settings.similarityThreshold,
  });
} else if (settings.similarityThreshold < 0 || settings.similarityThreshold > 1) {
  errors.push({
    field: "similarityThreshold",
    message: "similarityThreshold must be between 0 and 1",
    expectedType: "number (0-1)",
    actualType: String(settings.similarityThreshold),
  });
}
```

**éªŒè¯ç»“æœ**ï¼š

```typescript
interface SettingsValidationResult {
  valid: boolean;
  errors: SettingsValidationError[];
}

interface SettingsValidationError {
  field: string;
  message: string;
  expectedType?: string;
  actualType?: string;
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œè®¾ç½®è®¢é˜…æœºåˆ¶

#### è®¾ç½®è®¢é˜…æœºåˆ¶

SettingsStore æ”¯æŒè®¢é˜…è®¾ç½®å˜æ›´ï¼Œå½“è®¾ç½®æ›´æ–°æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…ï¼š

**è®¢é˜…ç¤ºä¾‹**ï¼š

```typescript
// è®¢é˜…è®¾ç½®å˜æ›´
const unsubscribe = settingsStore.subscribe((settings) => {
  console.log("è®¾ç½®å·²æ›´æ–°:", settings);
  // åŒæ­¥åˆ°å…¶ä»–ç»„ä»¶
  logger.setLogLevel(settings.logLevel);
  taskQueue.setConcurrency(settings.concurrency);
});

// å–æ¶ˆè®¢é˜…
unsubscribe();
```

**å®ç°æœºåˆ¶**ï¼š

```typescript
private listeners: Array<(settings: PluginSettings) => void> = [];

subscribe(listener: (settings: PluginSettings) => void): () => void {
  this.listeners.push(listener);
  
  // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
  return () => {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  };
}

private notifyListeners(): void {
  const settingsCopy = { ...this.settings };
  for (const listener of this.listeners) {
    listener(settingsCopy);
  }
}
```

**é€šçŸ¥æ—¶æœº**ï¼š

- è°ƒç”¨ `updateSettings()` å
- è°ƒç”¨ `importSettings()` å
- è°ƒç”¨ `resetToDefaults()` å

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œäº‹ä»¶å‘å¸ƒé€»è¾‘

#### é»˜è®¤è®¾ç½®

SettingsStore å®šä¹‰äº†å®Œæ•´çš„é»˜è®¤è®¾ç½®ï¼Œç¡®ä¿æ’ä»¶åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æœ‰åˆç†çš„åˆå§‹é…ç½®ï¼š

```typescript
export const DEFAULT_SETTINGS: PluginSettings = {
  version: "0.9.3",
  
  // åŸºç¡€è®¾ç½®
  language: "zh",
  advancedMode: false,
  
  // å‘½åè®¾ç½®
  namingTemplate: "{{chinese}} ({{english}})",
  
  // å­˜å‚¨è®¾ç½®
  directoryScheme: {
    Domain: "1-é¢†åŸŸ",
    Issue: "2-è®®é¢˜",
    Theory: "3-ç†è®º",
    Entity: "4-å®ä½“",
    Mechanism: "5-æœºåˆ¶",
  },
  
  // å»é‡è®¾ç½®
  similarityThreshold: 0.9,
  topK: 10,
  
  // é˜Ÿåˆ—è®¾ç½®
  concurrency: 1,
  autoRetry: true,
  maxRetryAttempts: 3,
  taskTimeoutMs: 180000,  // 3 åˆ†é’Ÿ
  maxTaskHistory: 300,
  
  // å¿«ç…§è®¾ç½®
  maxSnapshots: 100,
  maxSnapshotAgeDays: 30,
  
  // åŠŸèƒ½å¼€å…³
  enableGrounding: false,
  
  // Provider é…ç½®
  providers: {},
  defaultProviderId: "",
  
  // ä»»åŠ¡æ¨¡å‹é…ç½®
  taskModels: {
    embedding: {
      providerId: "",
      model: "text-embedding-3-small",
    },
    standardizeClassify: {
      providerId: "",
      model: "gpt-4o",
      temperature: 0.3,
    },
    enrich: {
      providerId: "",
      model: "gpt-4o",
      temperature: 0.5,
    },
    "reason:new": {
      providerId: "",
      model: "gpt-4o",
      temperature: 0.7,
    },
    ground: {
      providerId: "",
      model: "gpt-4o",
      temperature: 0.3,
    },
  },
  
  // æ—¥å¿—è®¾ç½®
  logLevel: "info",
  logFormat: "json",
  
  // åµŒå…¥å‘é‡ç»´åº¦
  embeddingDimension: 1536,
};
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œé»˜è®¤è®¾ç½®å®šä¹‰
- `src/types.ts`ï¼šPluginSettings æ¥å£å®šä¹‰

#### Provider ç®¡ç†ä¾¿æ·æ–¹æ³•

SettingsStore æä¾›äº†ä¸€ç»„ä¾¿æ·æ–¹æ³•ï¼Œç®€åŒ– Provider çš„ç®¡ç†ï¼š

**æ·»åŠ  Provider**ï¼š

```typescript
await settingsStore.addProvider("openai", {
  apiKey: "sk-xxx",
  baseUrl: undefined,
  defaultChatModel: "gpt-4o",
  defaultEmbedModel: "text-embedding-3-small",
  enabled: true,
  persistApiKey: true
});
```

å¦‚æœæ˜¯ç¬¬ä¸€ä¸ª Providerï¼Œä¼šè‡ªåŠ¨ï¼š
- è®¾ç½®ä¸ºé»˜è®¤ Provider
- æ›´æ–°æ‰€æœ‰ä»»åŠ¡æ¨¡å‹çš„ `providerId`

**æ›´æ–° Provider**ï¼š

```typescript
await settingsStore.updateProvider("openai", {
  apiKey: "sk-new-key",
  enabled: false
});
```

**ç§»é™¤ Provider**ï¼š

```typescript
await settingsStore.removeProvider("openai");
```

å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤ Providerï¼Œä¼šè‡ªåŠ¨é€‰æ‹©å‰©ä½™çš„ç¬¬ä¸€ä¸ª Provider ä½œä¸ºé»˜è®¤ã€‚

**è®¾ç½®é»˜è®¤ Provider**ï¼š

```typescript
await settingsStore.setDefaultProvider("openai");
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼ŒProvider ç®¡ç†æ–¹æ³•

#### å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

SettingsStore æ”¯æŒå¯¼å‡ºå®Œæ•´é…ç½®å’Œä» JSON å¯¼å…¥é…ç½®ï¼š

**å¯¼å‡ºè®¾ç½®**ï¼š

```typescript
const json = settingsStore.exportSettings();
// è¿”å›æ ¼å¼åŒ–çš„ JSON å­—ç¬¦ä¸²ï¼Œæ‰€æœ‰ API Key éƒ½è¢«æ¸…ç©º
```

å¯¼å‡ºçš„ JSON å¯ä»¥ç”¨äºï¼š
- å¤‡ä»½é…ç½®
- åœ¨ä¸åŒè®¾å¤‡é—´åŒæ­¥é…ç½®
- åˆ†äº«é…ç½®æ¨¡æ¿

**å¯¼å…¥è®¾ç½®**ï¼š

```typescript
const result = await settingsStore.importSettings(json);
if (result.ok) {
  console.log("è®¾ç½®å¯¼å…¥æˆåŠŸ");
} else {
  console.error("è®¾ç½®å¯¼å…¥å¤±è´¥:", result.error);
}
```

å¯¼å…¥è¿‡ç¨‹ä¼šï¼š
1. è§£æ JSON å­—ç¬¦ä¸²
2. éªŒè¯è®¾ç½®ç»“æ„
3. æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
4. åˆå¹¶é»˜è®¤å€¼
5. ä¿å­˜åˆ°ç£ç›˜
6. é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…

**å‚è€ƒä»£ç **ï¼š
- `src/data/settings-store.ts`ï¼šSettingsStore å®ç°ï¼Œå¯¼å…¥å¯¼å‡ºåŠŸèƒ½

#### ä½¿ç”¨ç¤ºä¾‹

**åŠ è½½å’Œè·å–è®¾ç½®**ï¼š

```typescript
// åŠ è½½è®¾ç½®
const loadResult = await settingsStore.loadSettings();
if (!loadResult.ok) {
  console.error("è®¾ç½®åŠ è½½å¤±è´¥:", loadResult.error);
}

// è·å–å½“å‰è®¾ç½®
const settings = settingsStore.getSettings();
console.log("å½“å‰æ—¥å¿—çº§åˆ«:", settings.logLevel);
```

**æ›´æ–°è®¾ç½®**ï¼š

```typescript
// æ›´æ–°éƒ¨åˆ†è®¾ç½®
const updateResult = await settingsStore.updateSettings({
  logLevel: "debug",
  concurrency: 2,
  similarityThreshold: 0.85
});

if (updateResult.ok) {
  console.log("è®¾ç½®æ›´æ–°æˆåŠŸ");
}
```

**è®¢é˜…è®¾ç½®å˜æ›´**ï¼š

```typescript
// è®¢é˜…è®¾ç½®å˜æ›´
const unsubscribe = settingsStore.subscribe((settings) => {
  // åŒæ­¥æ—¥å¿—çº§åˆ«
  logger.setLogLevel(settings.logLevel);
  
  // åŒæ­¥å¹¶å‘æ•°
  taskQueue.setConcurrency(settings.concurrency);
  
  // åŒæ­¥ç›¸ä¼¼åº¦é˜ˆå€¼
  duplicateManager.setSimilarityThreshold(settings.similarityThreshold);
});

// åœ¨æ’ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…
plugin.register(unsubscribe);
```

**Provider ç®¡ç†**ï¼š

```typescript
// æ·»åŠ  Provider
await settingsStore.addProvider("openai", {
  apiKey: "sk-xxx",
  defaultChatModel: "gpt-4o",
  defaultEmbedModel: "text-embedding-3-small",
  enabled: true
});

// æ›´æ–° Provider
await settingsStore.updateProvider("openai", {
  apiKey: "sk-new-key"
});

// è®¾ç½®é»˜è®¤ Provider
await settingsStore.setDefaultProvider("openai");

// ç§»é™¤ Provider
await settingsStore.removeProvider("openai");
```

**å¯¼å…¥å¯¼å‡º**ï¼š

```typescript
// å¯¼å‡ºè®¾ç½®
const json = settingsStore.exportSettings();
await navigator.clipboard.writeText(json);
console.log("è®¾ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");

// å¯¼å…¥è®¾ç½®
const json = await navigator.clipboard.readText();
const result = await settingsStore.importSettings(json);
if (result.ok) {
  console.log("è®¾ç½®å¯¼å…¥æˆåŠŸ");
}
```

#### è®¾è®¡åŸåˆ™

1. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šæ”¯æŒç‰ˆæœ¬æ£€æŸ¥ï¼Œä¸å…¼å®¹æ—¶è‡ªåŠ¨é‡ç½®
2. **æ•°æ®å®Œæ•´æ€§**ï¼šè¯¦ç»†çš„éªŒè¯æœºåˆ¶ç¡®ä¿é…ç½®ç»“æ„æ­£ç¡®
3. **å“åº”å¼æ›´æ–°**ï¼šè®¢é˜…æœºåˆ¶æ”¯æŒé…ç½®å˜æ›´çš„å®æ—¶åŒæ­¥
4. **æ•æ„Ÿæ•°æ®ä¿æŠ¤**ï¼šæ”¯æŒæ§åˆ¶ API Key æ˜¯å¦æŒä¹…åŒ–
5. **ä¾¿æ·æ€§**ï¼šæä¾› Provider ç®¡ç†ç­‰ä¾¿æ·æ–¹æ³•
6. **å¯å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒé…ç½®çš„å¤‡ä»½å’Œè¿ç§»

**å‚è€ƒéœ€æ±‚**ï¼š
- Requirements 3.1ï¼šæ•°æ®å±‚æ¨¡å—èŒè´£å’Œæ¥å£
- Requirements 3.4ï¼šæ¨¡å—æ¥å£çš„å…³é”®æ–¹æ³•
- Requirements 1.4ï¼šéªŒè¯ PluginSettings æ¥å£æ‰€æœ‰å¿…å¡«å­—æ®µ
- Requirements 1.5ï¼šç‰ˆæœ¬ä¸å…¼å®¹æ—¶é‡ç½®ä¸ºé»˜è®¤å€¼
- Requirements 10.3ï¼šå¯¼å‡ºå®Œæ•´ JSON
- Requirements 10.4ï¼šå¯¼å…¥æ—¶éªŒè¯å¹¶åˆå¹¶é»˜è®¤å€¼
- Requirements 10.5ï¼šè®¾ç½®å˜æ›´æ—¶é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…

### 4.4 Validator

**èŒè´£**ï¼šéªŒè¯ AI è¾“å‡ºï¼ŒåŒ…æ‹¬ JSON è§£æã€Schema æ ¡éªŒã€å¿…å¡«å­—æ®µæ£€æŸ¥ã€ä¸šåŠ¡è§„åˆ™æ ¡éªŒå’Œè¯­ä¹‰å»é‡ã€‚

**æ–‡ä»¶è·¯å¾„**ï¼š`src/data/validator.ts`

#### æ ¸å¿ƒèŒè´£

Validator æ˜¯æ•°æ®å±‚çš„éªŒè¯ç»„ä»¶ï¼Œè´Ÿè´£ç¡®ä¿ AI è¾“å‡ºç¬¦åˆç³»ç»Ÿè¦æ±‚ã€‚å®ƒæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **JSON è§£æ**ï¼šå®¹é”™è§£æ AI è¾“å‡ºï¼Œæ”¯æŒä»£ç å—å’Œå‰åç¼€æ–‡æœ¬
2. **Schema æ ¡éªŒ**ï¼šéªŒè¯è¾“å‡ºç»“æ„æ˜¯å¦ç¬¦åˆé¢„å®šä¹‰çš„ Schema
3. **å¿…å¡«å­—æ®µæ£€æŸ¥**ï¼šéªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”éç©º
4. **ä¸šåŠ¡è§„åˆ™æ ¡éªŒ**ï¼šæ‰§è¡Œ 16 æ¡ä¸šåŠ¡è§„åˆ™ï¼ˆC001-C016ï¼‰
5. **è¯­ä¹‰å»é‡**ï¼šæ£€æµ‹è¾“å‡ºæ˜¯å¦ä¸å·²æœ‰æ¦‚å¿µé‡å¤ï¼ˆå¯é€‰ï¼‰
6. **é”™è¯¯åˆ†ç±»**ï¼šæŒ‰ç…§éªŒè¯é˜¶æ®µè¿”å›ç»“æ„åŒ–çš„é”™è¯¯ä¿¡æ¯

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `validate(output, schema, rules, context?)` | `async validate(output: string, schema: object, rules: string[], context?: ValidationContext): Promise<ValidationResult>` | éªŒè¯ AI è¾“å‡º |
| `getValidationPhase(errorCode)` | `getValidationPhase(errorCode: string): ValidationPhase` | æ ¹æ®é”™è¯¯ç åˆ¤æ–­éªŒè¯é˜¶æ®µ |
| `getRulesForType(type)` | `static getRulesForType(type: CRType): string[]` | è·å–é€‚ç”¨äºç‰¹å®šç±»å‹çš„æ ¡éªŒè§„åˆ™ |
| `getStandardizeClassifyRules()` | `static getStandardizeClassifyRules(): string[]` | è·å– standardizeClassify ä»»åŠ¡çš„æ ¡éªŒè§„åˆ™ |

#### éªŒè¯é¡ºåº

Validator ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡ŒéªŒè¯ï¼Œé‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å³è¿”å›ï¼š

```mermaid
flowchart TD
    Start([AI è¾“å‡º]) --> Parse[é˜¶æ®µ 1: JSON è§£æ]
    Parse --> ParseOK{è§£ææˆåŠŸ?}
    ParseOK -->|å¦| E001[è¿”å› E001 é”™è¯¯]
    ParseOK -->|æ˜¯| Schema[é˜¶æ®µ 2: Schema æ ¡éªŒ]
    
    Schema --> SchemaOK{Schema æ­£ç¡®?}
    SchemaOK -->|å¦| E002[è¿”å› E002 é”™è¯¯]
    SchemaOK -->|æ˜¯| Required[é˜¶æ®µ 3: å¿…å¡«å­—æ®µæ£€æŸ¥]
    
    Required --> RequiredOK{å¿…å¡«å­—æ®µå®Œæ•´?}
    RequiredOK -->|å¦| E003[è¿”å› E003 é”™è¯¯]
    RequiredOK -->|æ˜¯| Business[é˜¶æ®µ 4: ä¸šåŠ¡è§„åˆ™æ ¡éªŒ]
    
    Business --> BusinessOK{ä¸šåŠ¡è§„åˆ™é€šè¿‡?}
    BusinessOK -->|å¦| E004[è¿”å› E004/E006/E009/E010 é”™è¯¯]
    BusinessOK -->|æ˜¯| Semantic[é˜¶æ®µ 5: è¯­ä¹‰å»é‡]
    
    Semantic --> SemanticOK{æ˜¯å¦é‡å¤?}
    SemanticOK -->|æ˜¯| E005[è¿”å› E005 è­¦å‘Š<br/>ä¸é˜»æ–­æµç¨‹]
    SemanticOK -->|å¦| Success[éªŒè¯é€šè¿‡]
    
    E001 --> End([è¿”å›éªŒè¯ç»“æœ])
    E002 --> End
    E003 --> End
    E004 --> End
    E005 --> Success
    Success --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style E001 fill:#ffcdd2
    style E002 fill:#ffcdd2
    style E003 fill:#ffcdd2
    style E004 fill:#ffcdd2
    style E005 fill:#fff9c4
    style Success fill:#c8e6c9
```

**éªŒè¯é˜¶æ®µè¯´æ˜**ï¼š

1. **JSON è§£æï¼ˆparseï¼‰**ï¼šå°è¯•è§£æ AI è¾“å‡ºä¸º JSON å¯¹è±¡ï¼Œæ”¯æŒå®¹é”™æå–
2. **Schema æ ¡éªŒï¼ˆschemaï¼‰**ï¼šéªŒè¯ JSON ç»“æ„æ˜¯å¦ç¬¦åˆé¢„å®šä¹‰çš„ Schema
3. **å¿…å¡«å­—æ®µæ£€æŸ¥ï¼ˆrequiredï¼‰**ï¼šéªŒè¯æ‰€æœ‰å¿…å¡«å­—æ®µæ˜¯å¦å­˜åœ¨ä¸”éç©º
4. **ä¸šåŠ¡è§„åˆ™æ ¡éªŒï¼ˆbusinessï¼‰**ï¼šæ‰§è¡Œç‰¹å®šç±»å‹çš„ä¸šåŠ¡è§„åˆ™
5. **è¯­ä¹‰å»é‡ï¼ˆsemanticï¼‰**ï¼šæ£€æµ‹æ˜¯å¦ä¸å·²æœ‰æ¦‚å¿µé‡å¤ï¼ˆä¸é˜»æ–­æµç¨‹ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/data/validator.ts`ï¼šValidator å®ç°ï¼Œ`validate()` æ–¹æ³•

#### å®¹é”™ JSON è§£æ

Validator å®ç°äº†å®¹é”™çš„ JSON è§£ææœºåˆ¶ï¼Œèƒ½å¤Ÿå¤„ç†å¤šç§æ ¼å¼çš„ AI è¾“å‡ºï¼š

**æ”¯æŒçš„æ ¼å¼**ï¼š

1. **çº¯ JSON**ï¼š
```json
{"chinese": "äººå·¥æ™ºèƒ½", "english": "Artificial Intelligence"}
```

2. **Markdown ä»£ç å—**ï¼š
````markdown
```json
{"chinese": "äººå·¥æ™ºèƒ½", "english": "Artificial Intelligence"}
```
````

3. **å¸¦å‰åç¼€æ–‡æœ¬**ï¼š
```
è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µçš„æ ‡å‡†åŒ–ç»“æœï¼š
{"chinese": "äººå·¥æ™ºèƒ½", "english": "Artificial Intelligence"}
ä»¥ä¸Šæ˜¯æ ‡å‡†åŒ–çš„è¾“å‡ºã€‚
```

**è§£æç­–ç•¥**ï¼š

```typescript
private tryParseJson(output: string): { ok: true; data: Record<string, unknown> } | { ok: false; error: ValidationError } {
  const trimmed = output.trim();
  
  // 1) ç›´æ¥è§£æ
  const direct = attemptParse(trimmed);
  if (direct) return { ok: true, data: direct };
  
  // 2) æå– ```json ``` æˆ– ``` ``` ä»£ç å—
  const codeBlockMatch = trimmed.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);
  if (codeBlockMatch) {
    const parsed = attemptParse(codeBlockMatch[1]);
    if (parsed) return { ok: true, data: parsed };
  }
  
  // 3) æå–é¦–å°¾å¤§æ‹¬å·ä¹‹é—´çš„å†…å®¹
  const firstBrace = trimmed.indexOf("{");
  const lastBrace = trimmed.lastIndexOf("}");
  if (firstBrace !== -1 && lastBrace > firstBrace) {
    const sliced = trimmed.slice(firstBrace, lastBrace + 1);
    const parsed = attemptParse(sliced);
    if (parsed) return { ok: true, data: parsed };
  }
  
  return { ok: false, error: buildParseError() };
}
```

è¿™ç§å®¹é”™æœºåˆ¶ç¡®ä¿äº†ï¼š
- AI è¾“å‡ºæ ¼å¼ä¸è§„èŒƒæ—¶ä»èƒ½æ­£ç¡®è§£æ
- å‡å°‘å› æ ¼å¼é—®é¢˜å¯¼è‡´çš„éªŒè¯å¤±è´¥
- æé«˜ç³»ç»Ÿçš„é²æ£’æ€§

**å‚è€ƒä»£ç **ï¼š
- `src/data/validator.ts`ï¼šValidator å®ç°ï¼Œå®¹é”™ JSON è§£æé€»è¾‘

#### Schema æ ¡éªŒ

Validator ä½¿ç”¨ç®€åŒ–çš„ Schema æ ¡éªŒæœºåˆ¶ï¼ŒéªŒè¯å­—æ®µç±»å‹æ˜¯å¦æ­£ç¡®ï¼š

**Schema å®šä¹‰ç¤ºä¾‹**ï¼š

```typescript
const schema = {
  properties: {
    chinese: { type: "string" },
    english: { type: "string" },
    aliases: { type: "array" },
    tags: { type: "array" },
    holistic_understanding: { type: "string" }
  },
  required: ["chinese", "english", "holistic_understanding"]
};
```

**æ ¡éªŒé€»è¾‘**ï¼š

```typescript
private validateSchema(data: Record<string, unknown>, schema: object): ValidationError[] {
  const errors: ValidationError[] = [];
  const schemaProps = (schema as { properties?: Record<string, { type: string }> }).properties;
  
  for (const [key, propSchema] of Object.entries(schemaProps)) {
    const value = data[key];
    const expectedType = propSchema.type;
    const actualType = Array.isArray(value) ? "array" : typeof value;
    
    if (expectedType === "array" && !Array.isArray(value)) {
      errors.push({
        code: "E002",
        type: "SchemaError",
        message: `Field "${key}" should be an array`,
        location: key
      });
    } else if (expectedType !== actualType) {
      errors.push({
        code: "E002",
        type: "SchemaError",
        message: `Field "${key}" should be of type "${expectedType}", got "${actualType}"`,
        location: key
      });
    }
  }
  
  return errors;
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/validator.ts`ï¼šValidator å®ç°ï¼ŒSchema æ ¡éªŒé€»è¾‘
- `src/core/schema-registry.ts`ï¼šSchemaRegistry å®ç°ï¼ŒSchema å®šä¹‰

#### ä¸šåŠ¡è§„åˆ™æ ¡éªŒ

Validator å®ç°äº† 16 æ¡ä¸šåŠ¡è§„åˆ™ï¼ˆC001-C016ï¼‰ï¼Œè¦†ç›–æ‰€æœ‰æ¦‚å¿µç±»å‹çš„ç‰¹å®šçº¦æŸï¼š

**è§„åˆ™åˆ—è¡¨**ï¼š

| è§„åˆ™ | è¯´æ˜ | é€‚ç”¨ç±»å‹ | é”™è¯¯ç  |
|------|------|----------|--------|
| **C001** | Issue ç±»å‹çš„ core_tension å¿…é¡»åŒ¹é… "X vs Y" æ ¼å¼ | Issue | E010 |
| **C002** | wikilink å¿…é¡»ä½¿ç”¨ [[...]] æ ¼å¼ | æ‰€æœ‰ç±»å‹ | E006 |
| **C003** | Theory ç±»å‹çš„ axioms æ•°ç»„é•¿åº¦å¿…é¡» >= 1 | Theory | E003 |
| **C004** | Theory ç±»å‹çš„ axioms æ¯ä¸ªå…ƒç´ å¿…é¡»æœ‰ statement å’Œ justification | Theory | E003 |
| **C005** | Mechanism ç±»å‹çš„ causal_chain æ•°ç»„é•¿åº¦å¿…é¡» >= 2 | Mechanism | E003 |
| **C006** | Mechanism ç±»å‹çš„ operates_on æ•°ç»„é•¿åº¦å¿…é¡» >= 1 | Mechanism | E003 |
| **C007** | Entity ç±»å‹çš„ classification å¿…é¡»åŒ…å« genus å’Œ differentia | Entity | E004 |
| **C008** | Domain ç±»å‹çš„ boundaries æ•°ç»„é•¿åº¦å¿…é¡» >= 1 | Domain | E003 |
| **C009** | standardizeClassify è¾“å‡ºçš„äº”ä¸ª confidences æ±‚å’Œ = 1.0 | standardizeClassify | E009 |
| **C010** | å¿…å¡«å­—ç¬¦ä¸²å­—æ®µé•¿åº¦ > 0 | æ‰€æœ‰ç±»å‹ | E003 |
| **C011** | æ•°ç»„å­—æ®µä¸å¾—åŒ…å«ç©ºå­—ç¬¦ä¸² | æ‰€æœ‰ç±»å‹ | E004 |
| **C012** | æ‰€æœ‰ç±»å‹çš„ holistic_understanding å¿…é¡»å­˜åœ¨ä¸”éç©º | æ‰€æœ‰ç±»å‹ | E003 |
| **C013** | Issue ç±»å‹çš„ theories æ•°ç»„ä¸­æ¯é¡¹å¿…é¡»åŒ…å« name å’Œ status | Issue | E003 |
| **C014** | Theory ç±»å‹çš„ argument_chain æ•°ç»„é•¿åº¦ >= 1 | Theory | E003 |
| **C015** | Theory ç±»å‹çš„ extracted_components å¿…é¡»åŒ…å« entities å’Œ mechanisms æ•°ç»„ | Theory | E003 |
| **C016** | Domain ç±»å‹çš„ sub_domainsï¼ˆè‹¥å­˜åœ¨ï¼‰æ¯é¡¹å¿…é¡»åŒ…å« name å’Œ dimension | Domain | E003 |

**è§„åˆ™åº”ç”¨**ï¼š

```typescript
// è·å–é€‚ç”¨äº Issue ç±»å‹çš„è§„åˆ™
const rules = Validator.getRulesForType("Issue");
// è¿”å›: ["C002", "C010", "C011", "C012", "C001", "C013"]

// è·å– standardizeClassify ä»»åŠ¡çš„è§„åˆ™
const rules = Validator.getStandardizeClassifyRules();
// è¿”å›: ["C009"]
```

**è§„åˆ™æ‰§è¡Œ**ï¼š

```typescript
private validateBusinessRules(
  data: Record<string, unknown>,
  rules: string[],
  context?: ValidationContext
): ValidationError[] {
  const errors: ValidationError[] = [];
  
  for (const rule of rules) {
    const validator = this.ruleValidators.get(rule);
    if (validator) {
      const error = validator(data, context);
      if (error) {
        errors.push(error);
        // è¿”å›ç¬¬ä¸€ä¸ªä¸šåŠ¡è§„åˆ™é”™è¯¯
        return errors;
      }
    }
  }
  
  return errors;
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/validator.ts`ï¼šValidator å®ç°ï¼Œä¸šåŠ¡è§„åˆ™æ ¡éªŒé€»è¾‘

#### è§„åˆ™ç¤ºä¾‹

**C001: Issue ç±»å‹çš„ core_tension å¿…é¡»åŒ¹é… "X vs Y" æ ¼å¼**

```typescript
validators.set("C001", (data) => {
  const coreTension = data.core_tension as string;
  if (coreTension === undefined || coreTension === null) {
    return null; // ç”±å¿…å¡«å­—æ®µæ£€æŸ¥å¤„ç†
  }
  if (!/^.+ vs .+$/.test(coreTension)) {
    return {
      code: "E010",
      type: "InvalidPattern",
      message: 'Field "core_tension" must match pattern "X vs Y"',
      location: "core_tension",
      fixInstruction: 'Ensure "core_tension" follows the format "X vs Y", e.g., "æ•ˆç‡ vs å…¬å¹³"',
    };
  }
  return null;
});
```

**C009: standardizeClassify è¾“å‡ºçš„äº”ä¸ª confidences æ±‚å’Œ = 1.0**

```typescript
validators.set("C009", (data) => {
  const types: CRType[] = ["Domain", "Issue", "Theory", "Entity", "Mechanism"];
  let sum = 0;
  
  for (const type of types) {
    const node = data[type] as Record<string, unknown>;
    const value = (node as { confidences?: unknown }).confidences;
    if (typeof value !== "number") {
      return {
        code: "E009",
        type: "SumNotOne",
        message: `"${type}.confidences" must be a number`,
        location: `${type}.confidences`,
      };
    }
    sum += value;
  }
  
  if (Math.abs(sum - 1.0) > 0.001) {
    return {
      code: "E009",
      type: "SumNotOne",
      message: `confidences sum is ${sum.toFixed(4)}, should be 1.0`,
      location: "confidences",
      fixInstruction: "Adjust the five confidences so they sum exactly to 1.0",
    };
  }
  return null;
});
```

**å‚è€ƒä»£ç **ï¼š
- `src/data/validator.ts`ï¼šValidator å®ç°ï¼Œè§„åˆ™ç¤ºä¾‹

#### é”™è¯¯åˆ†ç±»

Validator è¿”å›çš„é”™è¯¯ä¿¡æ¯åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```typescript
interface ValidationError {
  code: string;              // é”™è¯¯ç ï¼ˆE001-E010ï¼‰
  type: string;              // é”™è¯¯ç±»å‹ï¼ˆParseError, SchemaError, MissingField ç­‰ï¼‰
  message: string;           // é”™è¯¯æ¶ˆæ¯
  location?: string;         // é”™è¯¯ä½ç½®ï¼ˆå­—æ®µè·¯å¾„ï¼‰
  rawOutput?: string;        // åŸå§‹è¾“å‡ºï¼ˆæˆªæ–­åˆ° 500 å­—ç¬¦ï¼‰
  fixInstruction?: string;   // ä¿®å¤å»ºè®®
}
```

**é”™è¯¯ç æ˜ å°„**ï¼š

| é”™è¯¯ç  | é”™è¯¯ç±»å‹ | éªŒè¯é˜¶æ®µ | è¯´æ˜ |
|--------|----------|----------|------|
| **E001** | ParseError | parse | JSON è§£æå¤±è´¥ |
| **E002** | SchemaError | schema | Schema æ ¡éªŒå¤±è´¥ |
| **E003** | MissingField | required / business | å¿…å¡«å­—æ®µç¼ºå¤±æˆ–ä¸ºç©º |
| **E004** | ConstraintViolation | business | ä¸šåŠ¡çº¦æŸè¿å |
| **E005** | SemanticDuplicate | semantic | è¯­ä¹‰é‡å¤ï¼ˆä¸é˜»æ–­ï¼‰ |
| **E006** | InvalidWikilink | business | Wikilink æ ¼å¼é”™è¯¯ |
| **E009** | SumNotOne | business | ç½®ä¿¡åº¦æ±‚å’Œä¸ä¸º 1.0 |
| **E010** | InvalidPattern | business | æ¨¡å¼åŒ¹é…å¤±è´¥ |

#### éªŒè¯ç»“æœ

Validator è¿”å›çš„éªŒè¯ç»“æœåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```typescript
interface ValidationResult {
  valid: boolean;                    // æ˜¯å¦éªŒè¯é€šè¿‡
  data?: Record<string, unknown>;    // è§£æåçš„æ•°æ®ï¼ˆéªŒè¯é€šè¿‡æ—¶ï¼‰
  errors?: ValidationError[];        // é”™è¯¯åˆ—è¡¨
  duplicates?: Array<{               // é‡å¤æ¦‚å¿µåˆ—è¡¨ï¼ˆè¯­ä¹‰å»é‡æ—¶ï¼‰
    uid: string;
    similarity: number;
    name: string;
    path: string;
  }>;
}
```

**éªŒè¯é€šè¿‡ç¤ºä¾‹**ï¼š

```typescript
{
  valid: true,
  data: {
    chinese: "äººå·¥æ™ºèƒ½",
    english: "Artificial Intelligence",
    aliases: ["AI", "æœºå™¨æ™ºèƒ½"],
    tags: ["æŠ€æœ¯", "è®¡ç®—æœºç§‘å­¦"],
    holistic_understanding: "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯..."
  }
}
```

**éªŒè¯å¤±è´¥ç¤ºä¾‹**ï¼š

```typescript
{
  valid: false,
  errors: [
    {
      code: "E003",
      type: "MissingField",
      message: 'Required field "holistic_understanding" is missing',
      location: "holistic_understanding",
      fixInstruction: 'Provide a value for "holistic_understanding"'
    }
  ]
}
```

**è¯­ä¹‰é‡å¤ç¤ºä¾‹**ï¼š

```typescript
{
  valid: true,
  data: { /* ... */ },
  errors: [
    {
      code: "E005",
      type: "SemanticDuplicate",
      message: "Concept is semantically similar to existing concepts",
      duplicateUid: "concept-123",
      similarity: 0.92
    }
  ],
  duplicates: [
    {
      uid: "concept-123",
      similarity: 0.92,
      name: "äººå·¥æ™ºèƒ½ (Artificial Intelligence)",
      path: "1-é¢†åŸŸ/äººå·¥æ™ºèƒ½.md"
    }
  ]
}
```

#### ä½¿ç”¨ç¤ºä¾‹

**éªŒè¯ enrich ä»»åŠ¡è¾“å‡º**ï¼š

```typescript
const output = `
{
  "aliases": ["AI", "æœºå™¨æ™ºèƒ½", "äººå·¥æ™ºæ…§"],
  "tags": ["æŠ€æœ¯", "è®¡ç®—æœºç§‘å­¦", "è®¤çŸ¥ç§‘å­¦"],
  "holistic_understanding": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯..."
}
`;

const schema = {
  properties: {
    aliases: { type: "array" },
    tags: { type: "array" },
    holistic_understanding: { type: "string" }
  },
  required: ["aliases", "tags", "holistic_understanding"]
};

const rules = ["C002", "C010", "C011", "C012"];

const result = await validator.validate(output, schema, rules);

if (result.valid) {
  console.log("éªŒè¯é€šè¿‡:", result.data);
} else {
  console.error("éªŒè¯å¤±è´¥:", result.errors);
}
```

**éªŒè¯ standardizeClassify ä»»åŠ¡è¾“å‡º**ï¼š

```typescript
const output = `
{
  "Domain": {
    "chinese": "äººå·¥æ™ºèƒ½",
    "english": "Artificial Intelligence",
    "confidences": 0.7
  },
  "Issue": {
    "chinese": "AI ä¼¦ç†",
    "english": "AI Ethics",
    "confidences": 0.1
  },
  "Theory": {
    "chinese": "æ·±åº¦å­¦ä¹ ç†è®º",
    "english": "Deep Learning Theory",
    "confidences": 0.1
  },
  "Entity": {
    "chinese": "ç¥ç»ç½‘ç»œ",
    "english": "Neural Network",
    "confidences": 0.05
  },
  "Mechanism": {
    "chinese": "åå‘ä¼ æ’­",
    "english": "Backpropagation",
    "confidences": 0.05
  }
}
`;

const rules = Validator.getStandardizeClassifyRules();
// è¿”å›: ["C009"]

const result = await validator.validate(output, schema, rules);

if (result.valid) {
  console.log("éªŒè¯é€šè¿‡ï¼Œç½®ä¿¡åº¦æ±‚å’Œä¸º 1.0");
} else {
  console.error("éªŒè¯å¤±è´¥:", result.errors);
  // å¯èƒ½çš„é”™è¯¯: "confidences sum is 1.0000, should be 1.0"
}
```

**éªŒè¯ Issue ç±»å‹è¾“å‡º**ï¼š

```typescript
const output = `
{
  "core_tension": "æ•ˆç‡ vs å…¬å¹³",
  "theories": [
    {
      "name": "å¸•ç´¯æ‰˜æœ€ä¼˜",
      "status": "ä¸»æµ"
    },
    {
      "name": "ç½—å°”æ–¯æ­£ä¹‰è®º",
      "status": "æ›¿ä»£"
    }
  ],
  "holistic_understanding": "æ•ˆç‡ä¸å…¬å¹³æ˜¯ç»æµå­¦ä¸­çš„æ ¸å¿ƒçŸ›ç›¾..."
}
`;

const rules = Validator.getRulesForType("Issue");
// è¿”å›: ["C002", "C010", "C011", "C012", "C001", "C013"]

const result = await validator.validate(output, schema, rules);

if (result.valid) {
  console.log("éªŒè¯é€šè¿‡");
} else {
  console.error("éªŒè¯å¤±è´¥:", result.errors);
}
```

#### è®¾è®¡åŸåˆ™

1. **ä¸¥æ ¼çš„éªŒè¯é¡ºåº**ï¼šæŒ‰ç…§ parse â†’ schema â†’ required â†’ business â†’ semantic çš„é¡ºåºæ‰§è¡Œ
2. **å¿«é€Ÿå¤±è´¥**ï¼šé‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å³è¿”å›ï¼Œé¿å…æ— æ•ˆçš„åç»­éªŒè¯
3. **å®¹é”™è§£æ**ï¼šæ”¯æŒå¤šç§ JSON æ ¼å¼ï¼Œæé«˜ç³»ç»Ÿé²æ£’æ€§
4. **è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯**ï¼šæä¾›é”™è¯¯ä½ç½®ã€ä¿®å¤å»ºè®®ç­‰è¯¦ç»†ä¿¡æ¯
5. **å¯æ‰©å±•æ€§**ï¼šä¸šåŠ¡è§„åˆ™é€šè¿‡ Map ç®¡ç†ï¼Œä¾¿äºæ·»åŠ æ–°è§„åˆ™
6. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript ç±»å‹ç³»ç»Ÿç¡®ä¿éªŒè¯é€»è¾‘çš„æ­£ç¡®æ€§

**å‚è€ƒéœ€æ±‚**ï¼š
- Requirements 3.1ï¼šæ•°æ®å±‚æ¨¡å—èŒè´£å’Œæ¥å£
- Requirements 3.4ï¼šæ¨¡å—æ¥å£çš„å…³é”®æ–¹æ³•
- Requirements 1.6ï¼šéªŒè¯é¡ºåºï¼ˆparse â†’ schema â†’ required â†’ business â†’ semanticï¼‰
- Property 5ï¼šValidation Orderï¼ˆéªŒè¯é¡ºåºå±æ€§ï¼‰

---

---

## 5. åº”ç”¨å±‚è®¾è®¡

### 5.1 TaskQueue

**èŒè´£**ï¼šä»»åŠ¡è°ƒåº¦ã€å¹¶å‘æ§åˆ¶ã€çŠ¶æ€ç®¡ç†

TaskQueue æ˜¯ç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å®ƒç¡®ä¿ä»»åŠ¡æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢å¹¶å‘å†²çªï¼Œå¹¶æä¾›å®Œæ•´çš„ä»»åŠ¡çŠ¶æ€è¿½è¸ªã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `enqueue` | `(task: Omit<TaskRecord, 'id' \| 'created' \| 'updated'>) => Result<string>` | å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œè¿”å›ä»»åŠ¡ ID |
| `cancel` | `(taskId: string) => Result<boolean>` | å–æ¶ˆæŒ‡å®šä»»åŠ¡ |
| `pause` | `() => Promise<void>` | æš‚åœé˜Ÿåˆ—ï¼Œåœæ­¢è°ƒåº¦æ–°ä»»åŠ¡ |
| `resume` | `() => Promise<void>` | æ¢å¤é˜Ÿåˆ—ï¼Œç»§ç»­è°ƒåº¦ä»»åŠ¡ |
| `getStatus` | `() => QueueStatus` | è·å–é˜Ÿåˆ—çŠ¶æ€ï¼ˆå¾…å¤„ç†ã€è¿è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥ä»»åŠ¡æ•°ï¼‰ |
| `getTask` | `(taskId: string) => TaskRecord \| undefined` | è·å–æŒ‡å®šä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ |
| `getAllTasks` | `() => TaskRecord[]` | è·å–æ‰€æœ‰ä»»åŠ¡åˆ—è¡¨ |
| `subscribe` | `(listener: QueueEventListener) => () => void` | è®¢é˜…é˜Ÿåˆ—äº‹ä»¶ï¼Œè¿”å›å–æ¶ˆè®¢é˜…å‡½æ•° |

#### ä»»åŠ¡çŠ¶æ€è½¬æ¢

TaskQueue ç®¡ç†ä»»åŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œä»»åŠ¡çŠ¶æ€æŒ‰ä»¥ä¸‹é¡ºåºè½¬æ¢ï¼š

```mermaid
stateDiagram-v2
    [*] --> Pending: ä»»åŠ¡å…¥é˜Ÿ
    
    Pending --> Running: è°ƒåº¦å™¨é€‰ä¸­<br/>è·å–é”æˆåŠŸ
    Pending --> Cancelled: ç”¨æˆ·å–æ¶ˆ
    
    Running --> Completed: æ‰§è¡ŒæˆåŠŸ
    Running --> Failed: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    Running --> Pending: å¯é‡è¯•é”™è¯¯<br/>é‡Šæ”¾é”å¹¶é‡æ–°å…¥é˜Ÿ
    Running --> Cancelled: ç”¨æˆ·å–æ¶ˆ<br/>æˆ–ä»»åŠ¡è¶…æ—¶
    
    Completed --> [*]: ä»»åŠ¡ç»“æŸ
    Failed --> [*]: ä»»åŠ¡ç»“æŸ
    Cancelled --> [*]: ä»»åŠ¡ç»“æŸ
    
    note right of Pending
        ç­‰å¾…è°ƒåº¦
        æ£€æŸ¥é”å†²çª
        æ£€æŸ¥å¹¶å‘é™åˆ¶
    end note
    
    note right of Running
        æŒæœ‰èŠ‚ç‚¹é”
        å¯èƒ½æŒæœ‰ç±»å‹é”
        æ‰§è¡Œ AI è°ƒç”¨
        éªŒè¯è¾“å‡º
    end note
    
    note right of Completed
        é‡Šæ”¾æ‰€æœ‰é”
        æŒä¹…åŒ–ç»“æœ
        å‘å¸ƒå®Œæˆäº‹ä»¶
    end note
    
    note right of Failed
        é‡Šæ”¾æ‰€æœ‰é”
        è®°å½•é”™è¯¯å†å²
        å‘å¸ƒå¤±è´¥äº‹ä»¶
    end note
```

**çŠ¶æ€è¯´æ˜**ï¼š

- **Pendingï¼ˆå¾…å¤„ç†ï¼‰**ï¼šä»»åŠ¡å·²å…¥é˜Ÿï¼Œç­‰å¾…è°ƒåº¦å™¨é€‰ä¸­å¹¶è·å–é”
- **Runningï¼ˆè¿è¡Œä¸­ï¼‰**ï¼šä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼ŒæŒæœ‰èŠ‚ç‚¹é”ï¼ˆå¯èƒ½è¿˜æŒæœ‰ç±»å‹é”ï¼‰
- **Completedï¼ˆå·²å®Œæˆï¼‰**ï¼šä»»åŠ¡æˆåŠŸå®Œæˆï¼Œæ‰€æœ‰é”å·²é‡Šæ”¾
- **Failedï¼ˆå¤±è´¥ï¼‰**ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¸”è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‰€æœ‰é”å·²é‡Šæ”¾
- **Cancelledï¼ˆå·²å–æ¶ˆï¼‰**ï¼šä»»åŠ¡è¢«ç”¨æˆ·å–æ¶ˆæˆ–è¶…æ—¶ï¼Œæ‰€æœ‰é”å·²é‡Šæ”¾

**çŠ¶æ€è½¬æ¢æ¡ä»¶**ï¼š

| è½¬æ¢ | æ¡ä»¶ | è¯´æ˜ |
|------|------|------|
| Pending â†’ Running | è°ƒåº¦å™¨é€‰ä¸­ + è·å–é”æˆåŠŸ | ä»»åŠ¡å¼€å§‹æ‰§è¡Œ |
| Running â†’ Completed | æ‰§è¡ŒæˆåŠŸ + éªŒè¯é€šè¿‡ | ä»»åŠ¡æ­£å¸¸å®Œæˆ |
| Running â†’ Failed | è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° | ä»»åŠ¡å½»åº•å¤±è´¥ |
| Running â†’ Pending | å¯é‡è¯•é”™è¯¯ + æœªè¾¾é‡è¯•ä¸Šé™ | ä»»åŠ¡é‡æ–°å…¥é˜Ÿ |
| Pending â†’ Cancelled | ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ | ä»»åŠ¡è¢«å–æ¶ˆ |
| Running â†’ Cancelled | ç”¨æˆ·å–æ¶ˆæˆ–ä»»åŠ¡è¶…æ—¶ | ä»»åŠ¡è¢«ä¸­æ–­ |

#### é”å†²çªæ£€æŸ¥

TaskQueue åœ¨ä»»åŠ¡å…¥é˜Ÿæ—¶ä¼šæ£€æŸ¥ä¸¤ç§ç±»å‹çš„é”ï¼š

**1. èŠ‚ç‚¹é”ï¼ˆNode Lockï¼‰**

- **ç”¨é€”**ï¼šé˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘æ“ä½œ
- **é”é”®æ ¼å¼**ï¼š`nodeId`ï¼ˆå¦‚ `concept-123`ï¼‰
- **æ£€æŸ¥é€»è¾‘**ï¼šå¦‚æœåŒä¸€ `nodeId` å·²æœ‰ Pending æˆ– Running ä»»åŠ¡ï¼Œæ‹’ç»å…¥é˜Ÿ

**2. ç±»å‹é”ï¼ˆType Lockï¼‰**

- **ç”¨é€”**ï¼šé˜²æ­¢åŒç±»å‹æ¦‚å¿µçš„å¹¶å‘å»é‡æ£€æµ‹
- **é”é”®æ ¼å¼**ï¼š`type:{CRType}`ï¼ˆå¦‚ `type:Domain`ï¼‰
- **æ£€æŸ¥é€»è¾‘**ï¼šå¦‚æœåŒä¸€ç±»å‹å·²æœ‰å»é‡ä»»åŠ¡åœ¨è¿è¡Œï¼Œæ‹’ç»å…¥é˜Ÿ

**é”å†²çªå¤„ç†**ï¼š

```typescript
// æ£€æŸ¥èŠ‚ç‚¹é”
if (this.lockManager.isLocked(task.nodeId)) {
  return err("E400", `èŠ‚ç‚¹ ${task.nodeId} å·²è¢«é”å®šï¼Œæ— æ³•å…¥é˜Ÿ`);
}

// æ£€æŸ¥ç±»å‹é”ï¼ˆå¦‚æœä»»åŠ¡éœ€è¦ï¼‰
const crType = task.payload?.type as string | undefined;
if (crType) {
  const typeLockKey = `type:${crType}`;
  if (this.lockManager.isLocked(typeLockKey)) {
    return err("E400", `ç±»å‹ ${crType} å·²è¢«é”å®šï¼Œæ— æ³•å…¥é˜Ÿ`);
  }
}
```

#### é˜Ÿåˆ—æŒä¹…åŒ–

TaskQueue åœ¨ä»¥ä¸‹æ—¶æœºå°†é˜Ÿåˆ—çŠ¶æ€æŒä¹…åŒ–åˆ° `data/queue-state.json`ï¼š

1. **ä»»åŠ¡å…¥é˜ŸæˆåŠŸå**ï¼šç«‹å³æŒä¹…åŒ–ï¼Œç¡®ä¿ä»»åŠ¡ä¸ä¸¢å¤±
2. **ä»»åŠ¡çŠ¶æ€å˜æ›´å**ï¼šå¦‚ Pending â†’ Runningã€Running â†’ Completed
3. **é˜Ÿåˆ—æš‚åœ/æ¢å¤å**ï¼šè®°å½•é˜Ÿåˆ—çš„æš‚åœçŠ¶æ€

**æŒä¹…åŒ–å†…å®¹**ï¼š

```typescript
interface QueueStateFile {
  version: string;                // é˜Ÿåˆ—çŠ¶æ€æ–‡ä»¶ç‰ˆæœ¬
  tasks: TaskRecord[];            // æ‰€æœ‰ä»»åŠ¡è®°å½•
  concurrency: number;            // å¹¶å‘é™åˆ¶
  paused: boolean;                // æ˜¯å¦æš‚åœ
  stats: {                        // ç»Ÿè®¡ä¿¡æ¯
    pending: number;
    running: number;
    completed: number;
    failed: number;
  };
  locks: LockRecord[];            // æ´»è·ƒé”åˆ—è¡¨
}
```

**åŸå­å†™å…¥**ï¼š

TaskQueue ä½¿ç”¨ `FileStorage.atomicWrite()` æ–¹æ³•ç¡®ä¿æŒä¹…åŒ–æ“ä½œçš„åŸå­æ€§ï¼Œé¿å…å†™å…¥è¿‡ç¨‹ä¸­æ–­å¯¼è‡´æ•°æ®æŸåã€‚

#### è°ƒåº¦ç­–ç•¥

TaskQueue ä½¿ç”¨è½®è¯¢è°ƒåº¦å™¨ï¼Œæ¯ç§’æ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—ï¼š

```typescript
// è°ƒåº¦å™¨ä¼ªä»£ç 
setInterval(() => {
  if (paused) return;
  if (processingTasks.size >= concurrency) return;
  
  const pendingTask = findFirstPendingTask();
  if (!pendingTask) return;
  
  // æ£€æŸ¥é”å†²çª
  if (lockManager.isLocked(pendingTask.nodeId)) return;
  
  // è·å–é”
  lockManager.acquire(pendingTask.nodeId, "node", pendingTask.id);
  
  // æ›´æ–°çŠ¶æ€ä¸º Running
  pendingTask.state = "Running";
  processingTasks.add(pendingTask.id);
  
  // å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
  executeTask(pendingTask);
}, 1000);
```

**å¹¶å‘æ§åˆ¶**ï¼š

- é»˜è®¤å¹¶å‘é™åˆ¶ï¼š`concurrency = 2`ï¼ˆå¯åœ¨è®¾ç½®ä¸­è°ƒæ•´ï¼‰
- å¦‚æœè¿è¡Œä¸­ä»»åŠ¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œè°ƒåº¦å™¨ä¼šè·³è¿‡æœ¬è½®è°ƒåº¦
- ä»»åŠ¡å®Œæˆåé‡Šæ”¾é”ï¼Œè°ƒåº¦å™¨ä¼šåœ¨ä¸‹ä¸€è½®è°ƒåº¦æ–°ä»»åŠ¡

#### é”™è¯¯å¤„ç†ä¸é‡è¯•

TaskQueue æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•ï¼š

**é‡è¯•ç­–ç•¥**ï¼š

| é”™è¯¯ç±»å‹ | æœ€å¤§é‡è¯•æ¬¡æ•° | é‡è¯•ç­–ç•¥ |
|---------|-------------|---------|
| å†…å®¹é”™è¯¯ï¼ˆE001-E010ï¼‰ | 3 æ¬¡ | ç«‹å³é‡è¯• |
| ç½‘ç»œé”™è¯¯ï¼ˆE100-E102ï¼‰ | 5 æ¬¡ | æŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4s, 8s, 16sï¼‰ |
| ç³»ç»Ÿé”™è¯¯ï¼ˆE300-E304ï¼‰ | 0 æ¬¡ | ä¸é‡è¯• |

**é‡è¯•é€»è¾‘**ï¼š

```typescript
if (shouldRetry && task.attempt < task.maxAttempts) {
  task.state = "Pending";  // é‡ç½®ä¸º Pending çŠ¶æ€
  task.attempt++;          // å¢åŠ é‡è¯•æ¬¡æ•°
  releaseTaskLocks(task);  // é‡Šæ”¾é”ï¼Œå…è®¸é‡æ–°è°ƒåº¦
} else {
  task.state = "Failed";   // æ ‡è®°ä¸ºå¤±è´¥
  releaseTaskLocks(task);  // é‡Šæ”¾é”
}
```

#### äº‹ä»¶è®¢é˜…

TaskQueue æ”¯æŒäº‹ä»¶è®¢é˜…æœºåˆ¶ï¼ŒUI å±‚å¯ä»¥è®¢é˜…é˜Ÿåˆ—äº‹ä»¶å®æ—¶æ›´æ–°ç•Œé¢ï¼š

**äº‹ä»¶ç±»å‹**ï¼š

```typescript
type QueueEventType =
  | "task-added"      // ä»»åŠ¡å…¥é˜Ÿ
  | "task-started"    // ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
  | "task-completed"  // ä»»åŠ¡å®Œæˆ
  | "task-failed"     // ä»»åŠ¡å¤±è´¥
  | "task-cancelled"  // ä»»åŠ¡å–æ¶ˆ
  | "queue-paused"    // é˜Ÿåˆ—æš‚åœ
  | "queue-resumed";  // é˜Ÿåˆ—æ¢å¤
```

**è®¢é˜…ç¤ºä¾‹**ï¼š

```typescript
const unsubscribe = taskQueue.subscribe((event) => {
  console.log(`é˜Ÿåˆ—äº‹ä»¶: ${event.type}, ä»»åŠ¡ ID: ${event.taskId}`);
  updateUI(event);
});

// å–æ¶ˆè®¢é˜…
unsubscribe();
```

#### é˜Ÿåˆ—æ¢å¤

TaskQueue åœ¨æ’ä»¶å¯åŠ¨æ—¶ä¼šä» `data/queue-state.json` æ¢å¤é˜Ÿåˆ—çŠ¶æ€ï¼š

**æ¢å¤é€»è¾‘**ï¼š

1. **è¯»å–é˜Ÿåˆ—çŠ¶æ€æ–‡ä»¶**ï¼šåŠ è½½æ‰€æœ‰ä»»åŠ¡è®°å½•
2. **æ¸…ç† Running çŠ¶æ€ä»»åŠ¡**ï¼šå°†æ‰€æœ‰ Running çŠ¶æ€çš„ä»»åŠ¡é™çº§ä¸º Pendingï¼ˆå› ä¸ºæ’ä»¶é‡å¯åä¸å­˜åœ¨æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼‰
3. **æ¢å¤é”çŠ¶æ€**ï¼šä»é˜Ÿåˆ—çŠ¶æ€æ–‡ä»¶ä¸­æ¢å¤é”ä¿¡æ¯
4. **æ¸…ç†æ— æ•ˆé”**ï¼šé‡Šæ”¾ä¸å½“å‰ä»»åŠ¡é›†ä¸åŒ¹é…çš„é”
5. **å¯åŠ¨è°ƒåº¦å™¨**ï¼šå¼€å§‹è°ƒåº¦ Pending ä»»åŠ¡

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-queue.ts`ï¼šTaskQueue å®Œæ•´å®ç°
- `src/types.ts`ï¼šITaskQueue æ¥å£å®šä¹‰å’Œ TaskRecord ç±»å‹å®šä¹‰

### 5.2 TaskRunner

**èŒè´£**ï¼šä»»åŠ¡æ‰§è¡Œã€Provider è°ƒç”¨ã€ç»“æœéªŒè¯

TaskRunner æ˜¯ä»»åŠ¡çš„å®é™…æ‰§è¡Œè€…ï¼Œè´Ÿè´£è°ƒç”¨ AI Providerã€æ„å»º Promptã€éªŒè¯è¾“å‡ºã€å¤„ç†ç»“æœã€‚å®ƒæ˜¯è¿æ¥ä»»åŠ¡é˜Ÿåˆ—å’Œå¤–éƒ¨ AI æœåŠ¡çš„æ¡¥æ¢ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `run` | `(task: TaskRecord) => Promise<Result<TaskResult>>` | æ‰§è¡ŒæŒ‡å®šä»»åŠ¡ï¼Œè¿”å›æ‰§è¡Œç»“æœ |
| `abort` | `(taskId: string) => void` | ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ |

#### ä»»åŠ¡æ‰§è¡Œæµç¨‹

TaskRunner æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œä»»åŠ¡ï¼š

```
1. éªŒè¯ Provider èƒ½åŠ›
   â†“
2. æ ¹æ®ä»»åŠ¡ç±»å‹åˆ†å‘
   â†“
3. åŠ è½½æç¤ºè¯æ¨¡æ¿
   â†“
4. æ„å»º Prompt
   â†“
5. è°ƒç”¨ AI API
   â†“
6. éªŒè¯è¾“å‡º
   â†“
7. å¤„ç†ç»“æœ
   â†“
8. è¿”å›æ‰§è¡Œç»“æœ
```

**æµç¨‹è¯´æ˜**ï¼š

**1. éªŒè¯ Provider èƒ½åŠ›**

åœ¨æ‰§è¡Œä»»åŠ¡å‰ï¼ŒTaskRunner ä¼šæ£€æŸ¥é…ç½®çš„ Provider æ˜¯å¦æ”¯æŒè¯¥ä»»åŠ¡ç±»å‹ï¼š

```typescript
// æ£€æŸ¥ Provider æ˜¯å¦é…ç½®
const providerId = this.getProviderIdForTask(task.taskType);
if (!providerId) {
  return err("E304", `ä»»åŠ¡ ${task.taskType} æœªé…ç½® Provider`);
}

// æ£€æŸ¥ Provider æ˜¯å¦å¯ç”¨
const providerConfig = settings.providers[providerId];
if (!providerConfig.enabled) {
  return err("E304", `Provider "${providerId}" å·²ç¦ç”¨`);
}
```

**2. æ ¹æ®ä»»åŠ¡ç±»å‹åˆ†å‘**

TaskRunner æ”¯æŒä»¥ä¸‹ä»»åŠ¡ç±»å‹ï¼š

| ä»»åŠ¡ç±»å‹ | è¯´æ˜ | æ‰§è¡Œæ–¹æ³• |
|---------|------|---------|
| `standardizeClassify` | æ ‡å‡†åŒ–å’Œåˆ†ç±»æ¦‚å¿µ | `executeStandardizeClassify()` |
| `enrich` | ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾ | `executeEnrich()` |
| `embedding` | ç”Ÿæˆå‘é‡åµŒå…¥ | `executeEmbedding()` |
| `reason:new` | ç”Ÿæˆæ¦‚å¿µå†…å®¹ | `executeReasonNew()` |
| `ground` | äº‹å®æ ¸æŸ¥ | `executeGround()` |

**3. åŠ è½½æç¤ºè¯æ¨¡æ¿**

TaskRunner é€šè¿‡ PromptManager åŠ è½½å¯¹åº”çš„æç¤ºè¯æ¨¡æ¿ï¼š

```typescript
const promptResult = this.promptManager.build(task.taskType, slots);
if (!promptResult.ok) {
  return err(promptResult.error.code, promptResult.error.message);
}
```

**4. æ„å»º Prompt**

å¡«å……æ¨¡æ¿æ§½ä½ï¼Œç”Ÿæˆå®Œæ•´çš„ Promptï¼š

```typescript
const slots = {
  CTX_INPUT: userInput,
  CTX_META: metaContext,
  CTX_LANGUAGE: this.getLanguage()
};
```

**5. è°ƒç”¨ AI API**

é€šè¿‡ ProviderManager è°ƒç”¨ AI APIï¼š

```typescript
const chatResult = await this.providerManager.chat({
  providerId: task.providerRef || "default",
  model: "gpt-4o",
  messages: [
    { role: "user", content: promptResult.value }
  ]
}, signal);
```

**6. éªŒè¯è¾“å‡º**

ä½¿ç”¨ Validator éªŒè¯ AI è¾“å‡ºæ˜¯å¦ç¬¦åˆ Schemaï¼š

```typescript
const validationResult = await this.validator.validate(
  chatResult.value.content,
  schema,
  validationRules
);

if (!validationResult.valid) {
  return this.createValidationError(task, validationResult.errors!);
}
```

**7. å¤„ç†ç»“æœ**

æ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œä¸åŒçš„åç»­æ“ä½œï¼š

- **embedding**ï¼šå°†å‘é‡åµŒå…¥å­˜å‚¨åˆ° VectorIndex
- **enrich**ï¼šæ›´æ–°æ¦‚å¿µçš„åˆ«åå’Œæ ‡ç­¾
- **reason:new**ï¼šå†™å…¥ç”Ÿæˆçš„å†…å®¹åˆ°æ–‡ä»¶

**8. è¿”å›æ‰§è¡Œç»“æœ**

è¿”å›åŒ…å«ä»»åŠ¡ç»“æœçš„ `TaskResult` å¯¹è±¡ï¼š

```typescript
return ok({
  taskId: task.id,
  state: "Completed",
  data: parsedResult
});
```

#### è¶…æ—¶å¤„ç†

TaskRunner ä¸ºæ¯ä¸ªä»»åŠ¡è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 3 åˆ†é’Ÿï¼‰ï¼Œè¶…æ—¶åè‡ªåŠ¨ä¸­æ–­ï¼š

```typescript
const timeoutMs = this.settingsStore.getSettings().taskTimeoutMs || 180000;
const timeoutHandle = setTimeout(() => {
  this.taskRunner?.abort(task.id);
}, timeoutMs);

try {
  const result = await this.taskRunner.run(task);
  clearTimeout(timeoutHandle);
  return result;
} finally {
  clearTimeout(timeoutHandle);
}
```

**è¶…æ—¶å¤„ç†é€»è¾‘**ï¼š

1. è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
2. å¦‚æœä»»åŠ¡åœ¨è¶…æ—¶å‰å®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
3. å¦‚æœä»»åŠ¡è¶…æ—¶ï¼Œè°ƒç”¨ `abort()` æ–¹æ³•ä¸­æ–­ä»»åŠ¡
4. è¿”å›è¶…æ—¶é”™è¯¯ï¼ˆE102ï¼‰

#### å¿«ç…§åˆ›å»ºï¼ˆProperty 10ï¼‰

TaskRunner åœ¨å†™å…¥æ–‡ä»¶å‰ä¼šè‡ªåŠ¨åˆ›å»ºå¿«ç…§ï¼Œç¡®ä¿æ“ä½œå¯é€†ï¼š

```typescript
// Property 10: Snapshot Before Write
async createSnapshotBeforeWrite(context: WriteContext): Promise<Result<string>> {
  // è·å–åŸå§‹å†…å®¹
  let originalContent = context.originalContent;
  if (originalContent === undefined && this.fileStorage) {
    const readResult = await this.fileStorage.read(context.filePath);
    if (readResult.ok) {
      originalContent = readResult.value;
    }
  }

  // åˆ›å»ºå¿«ç…§
  const snapshotResult = await this.undoManager.createSnapshot(
    context.filePath,
    originalContent || "",
    context.taskId,
    context.nodeId
  );

  return snapshotResult;
}
```

**å¿«ç…§åˆ›å»ºæ—¶æœº**ï¼š

- **reason:new ä»»åŠ¡**ï¼šåœ¨å†™å…¥ç”Ÿæˆå†…å®¹å‰åˆ›å»ºå¿«ç…§
- **å¢é‡æ”¹è¿›ä»»åŠ¡**ï¼šåœ¨æ›´æ–°æ–‡ä»¶å‰åˆ›å»ºå¿«ç…§
- **åˆå¹¶ä»»åŠ¡**ï¼šåœ¨åˆå¹¶æ–‡ä»¶å‰ä¸ºä¸¤ä¸ªæ–‡ä»¶éƒ½åˆ›å»ºå¿«ç…§

#### ç±»å‹å­—æ®µå®Œæ•´æ€§éªŒè¯ï¼ˆProperty 27ï¼‰

TaskRunner éªŒè¯ç”Ÿæˆçš„å†…å®¹æ˜¯å¦åŒ…å«ç±»å‹æ‰€éœ€çš„æ‰€æœ‰å¿…å¡«å­—æ®µï¼š

```typescript
validateTypeFieldCompleteness(data: Record<string, unknown>, type: CRType): Result<void> {
  const requiredFields = TYPE_REQUIRED_FIELDS[type];
  const missingFields: string[] = [];

  for (const field of requiredFields) {
    const value = data[field];
    if (value === undefined || value === null) {
      missingFields.push(field);
    } else if (typeof value === "string" && value.trim() === "") {
      missingFields.push(field);
    }
  }

  if (missingFields.length > 0) {
    return err("E003", `ç±»å‹ ${type} ç¼ºå°‘å¿…å¡«å­—æ®µ: ${missingFields.join(", ")}`);
  }

  return ok(undefined);
}
```

**ç±»å‹å¿…å¡«å­—æ®µå®šä¹‰**ï¼š

| ç±»å‹ | å¿…å¡«å­—æ®µ |
|------|---------|
| **Domain** | definition, teleology, methodology, historical_genesis, boundaries, sub_domains, issues, holistic_understanding |
| **Issue** | definition, core_tension, significance, epistemic_barrier, counter_intuition, historical_genesis, sub_issues, stakeholder_perspectives, boundary_conditions, theories, holistic_understanding |
| **Theory** | definition, axioms, sub_theories, logical_structure, entities, mechanisms, core_predictions, limitations, historical_genesis, holistic_understanding |
| **Entity** | definition, classification, properties, states, constraints, composition, distinguishing_features, examples, counter_examples, holistic_understanding |
| **Mechanism** | definition, trigger_conditions, operates_on, causal_chain, modulation, inputs, outputs, side_effects, termination_conditions, holistic_understanding |

#### ä»»åŠ¡ç®¡çº¿é¡ºåºéªŒè¯ï¼ˆProperty 29ï¼‰

TaskRunner éªŒè¯ä»»åŠ¡æ˜¯å¦æŒ‰ç…§æ­£ç¡®çš„ç®¡çº¿é¡ºåºæ‰§è¡Œï¼š

```typescript
validatePipelineOrder(previousTaskType: TaskType | null, currentTaskType: TaskType): boolean {
  // ç®¡çº¿é¡ºåºï¼šstandardizeClassify â†’ enrich â†’ reason:new â†’ å†™å…¥ â†’ embedding â†’ å»é‡
  const TASK_PIPELINE_ORDER: TaskType[] = [
    "standardizeClassify",
    "enrich",
    "reason:new",
    "ground",
    "embedding"
  ];

  if (previousTaskType === null) {
    return true;  // ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œä»»ä½•ç±»å‹éƒ½å¯ä»¥
  }

  const previousIndex = TASK_PIPELINE_ORDER.indexOf(previousTaskType);
  const currentIndex = TASK_PIPELINE_ORDER.indexOf(currentTaskType);

  // å½“å‰ä»»åŠ¡ç´¢å¼•åº”è¯¥å¤§äºç­‰äºå‰ä¸€ä¸ªä»»åŠ¡ç´¢å¼•
  return currentIndex >= previousIndex;
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/task-runner.ts`ï¼šTaskRunner å®Œæ•´å®ç°
- `src/types.ts`ï¼šITaskRunner æ¥å£å®šä¹‰å’Œ TaskResult ç±»å‹å®šä¹‰

### 5.3 VectorIndex

**èŒè´£**ï¼šå‘é‡å­˜å‚¨ã€ç›¸ä¼¼åº¦æœç´¢ã€åˆ†æ¡¶ç®¡ç†

VectorIndex è´Ÿè´£ç®¡ç†æ¦‚å¿µçš„å‘é‡åµŒå…¥ï¼Œæ”¯æŒé«˜æ•ˆçš„ç›¸ä¼¼åº¦æœç´¢ã€‚å®ƒé‡‡ç”¨åˆ†æ¡¶ç­–ç•¥ï¼ŒæŒ‰æ¦‚å¿µç±»å‹åˆ†åˆ«å­˜å‚¨å‘é‡ï¼Œé¿å…è·¨ç±»å‹è¯¯åˆ¤ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `load` | `() => Promise<Result<void>>` | ä»ç£ç›˜åŠ è½½å‘é‡ç´¢å¼• |
| `upsert` | `(entry: VectorEntry) => Promise<Result<void>>` | æ·»åŠ æˆ–æ›´æ–°å‘é‡æ¡ç›® |
| `delete` | `(uid: string) => Promise<Result<void>>` | åˆ é™¤æŒ‡å®šçš„å‘é‡æ¡ç›® |
| `search` | `(type: CRType, embedding: number[], topK: number) => Promise<Result<SearchResult[]>>` | åœ¨æŒ‡å®šç±»å‹æ¡¶å†…æœç´¢ç›¸ä¼¼æ¦‚å¿µ |
| `getStats` | `() => IndexStats` | è·å–ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ |
| `getEntry` | `(uid: string) => VectorEntry \| undefined` | æ ¹æ® UID è·å–å‘é‡æ¡ç›® |

#### æ–°æ¶æ„ï¼šåˆ†æ¡¶å­˜å‚¨ï¼ˆv2.0ï¼‰

VectorIndex é‡‡ç”¨æ–°çš„åˆ†æ¡¶å­˜å‚¨æ¶æ„ï¼Œæ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ä¸ºå•ä¸ªæ–‡ä»¶ï¼Œæ”¯æŒå»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°ï¼š

**ç›®å½•ç»“æ„**ï¼š

```
data/vectors/
â”œâ”€â”€ index.json              # è½»é‡çº§å…ƒæ•°æ®ç´¢å¼•
â”œâ”€â”€ Domain/                 # Domain ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”œâ”€â”€ {uid1}.json
â”‚   â””â”€â”€ {uid2}.json
â”œâ”€â”€ Issue/                  # Issue ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Theory/                 # Theory ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Entity/                 # Entity ç±»å‹å‘é‡æ–‡ä»¶
â””â”€â”€ Mechanism/              # Mechanism ç±»å‹å‘é‡æ–‡ä»¶
```

**å…ƒæ•°æ®ç´¢å¼•ç»“æ„**ï¼ˆ`data/vectors/index.json`ï¼‰ï¼š

```typescript
interface VectorIndexMeta {
  version: string;          // ç´¢å¼•ç‰ˆæœ¬ï¼ˆå½“å‰ä¸º "2.0"ï¼‰
  lastUpdated: number;      // æœ€åæ›´æ–°æ—¶é—´æˆ³
  stats: {
    totalConcepts: number;
    byType: Record<CRType, number>;
  };
  concepts: Record<string, ConceptMeta>;  // UID â†’ å…ƒæ•°æ®æ˜ å°„
}

interface ConceptMeta {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  filePath: string;         // å‘é‡æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ "Domain/uid.json"ï¼‰
  lastModified: number;     // æœ€åä¿®æ”¹æ—¶é—´æˆ³
  hasEmbedding: boolean;    // æ˜¯å¦æœ‰åµŒå…¥å‘é‡
}
```

**å•ä¸ªæ¦‚å¿µå‘é‡æ–‡ä»¶ç»“æ„**ï¼ˆ`data/vectors/{type}/{uid}.json`ï¼‰ï¼š

```typescript
interface ConceptVector {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  embedding: number[];      // å‘é‡åµŒå…¥
  metadata: {
    createdAt: number;      // åˆ›å»ºæ—¶é—´æˆ³
    updatedAt: number;      // æ›´æ–°æ—¶é—´æˆ³
    embeddingModel: string; // åµŒå…¥æ¨¡å‹ï¼ˆå¦‚ "text-embedding-3-small"ï¼‰
    dimensions: number;     // å‘é‡ç»´åº¦ï¼ˆå¦‚ 1536ï¼‰
  };
}
```

**æ–°æ¶æ„ä¼˜åŠ¿**ï¼š

1. **å»¶è¿ŸåŠ è½½**ï¼š
   - å…ƒæ•°æ®ç´¢å¼•å§‹ç»ˆåœ¨å†…å­˜ä¸­ï¼ˆè½»é‡çº§ï¼‰
   - å‘é‡æ•°æ®æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨
   - å»é‡æ£€æµ‹æ—¶åªåŠ è½½åŒç±»å‹çš„å‘é‡æ–‡ä»¶

2. **å¢é‡æ›´æ–°**ï¼š
   - å•ä¸ªæ¦‚å¿µçš„å¢åˆ æ”¹åªå½±å“ä¸€ä¸ªæ–‡ä»¶
   - é¿å…å…¨é‡ç´¢å¼•çš„è¯»å†™å¼€é”€
   - æ”¯æŒå¹¶å‘å†™å…¥ä¸åŒæ¦‚å¿µçš„å‘é‡

3. **é¿å…è·¨ç±»å‹è¯¯åˆ¤**ï¼š
   - æŒ‰ç±»å‹åˆ†æ¡¶å­˜å‚¨ï¼Œæœç´¢æ—¶åªæ£€ç´¢åŒç±»å‹
   - "è‹¹æœå…¬å¸"ï¼ˆEntityï¼‰å’Œ"å¸‚åœºç«äº‰"ï¼ˆIssueï¼‰ä¸ä¼šè¢«æ¯”è¾ƒ

4. **å¯æ‰©å±•æ€§**ï¼š
   - æ”¯æŒå¤§è§„æ¨¡çŸ¥è¯†åº“ï¼ˆæ•°ä¸‡ä¸ªæ¦‚å¿µï¼‰
   - æ–‡ä»¶ç³»ç»Ÿå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨
   - ä¾¿äºå¤‡ä»½å’Œè¿ç§»ï¼ˆæŒ‰ç±»å‹æ‰“åŒ…ï¼‰

5. **è°ƒè¯•å‹å¥½**ï¼š
   - æ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ï¼Œä¾¿äºæ£€æŸ¥
   - å…ƒæ•°æ®ç´¢å¼•å¯è¯»æ€§å¼ºï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

#### å‘é‡æ¡ç›®ç»“æ„

```typescript
interface VectorEntry {
  uid: string;           // æ¦‚å¿µ UID
  type: CRType;          // æ¦‚å¿µç±»å‹
  embedding: number[];   // å‘é‡åµŒå…¥ï¼ˆç»´åº¦ç”±æ¨¡å‹å†³å®šï¼‰
  name: string;          // æ¦‚å¿µåç§°
  path: string;          // æ–‡ä»¶è·¯å¾„
  updated: string;       // æœ€åæ›´æ–°æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
}
```

#### ç›¸ä¼¼åº¦æœç´¢

VectorIndex ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰è®¡ç®—å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼š

```typescript
cosineSimilarity(a: number[], b: number[]): number {
  let dotProduct = 0;
  let normA = 0;
  let normB = 0;

  for (let i = 0; i < a.length; i++) {
    dotProduct += a[i] * b[i];
    normA += a[i] * a[i];
    normB += b[i] * b[i];
  }

  normA = Math.sqrt(normA);
  normB = Math.sqrt(normB);

  if (normA === 0 || normB === 0) {
    return 0;
  }

  return dotProduct / (normA * normB);
}
```

**æœç´¢æµç¨‹**ï¼š

1. **éªŒè¯å‘é‡ç»´åº¦**ï¼šç¡®ä¿æŸ¥è¯¢å‘é‡çš„ç»´åº¦ä¸ç´¢å¼•ä¸€è‡´
2. **é€‰æ‹©æ¡¶**ï¼šæ ¹æ®æ¦‚å¿µç±»å‹é€‰æ‹©å¯¹åº”çš„æ¡¶
3. **è®¡ç®—ç›¸ä¼¼åº¦**ï¼šéå†æ¡¶å†…æ‰€æœ‰å‘é‡ï¼Œè®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
4. **æ’åº**ï¼šæŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
5. **è¿”å› Top-K**ï¼šè¿”å›ç›¸ä¼¼åº¦æœ€é«˜çš„ K ä¸ªç»“æœ

**å±€éƒ¨æ’åºä¼˜åŒ–**ï¼š

ä¸ºé¿å…å…¨é‡æ’åºé˜»å¡ä¸»çº¿ç¨‹ï¼ŒVectorIndex ä½¿ç”¨å±€éƒ¨æ’åºç­–ç•¥ï¼š

```typescript
const topResults: Array<{ entry: VectorEntry; similarity: number }> = [];

for (const entry of bucket) {
  const similarity = this.cosineSimilarity(embedding, entry.embedding);
  
  if (topResults.length < topK) {
    topResults.push({ entry, similarity });
    topResults.sort((a, b) => b.similarity - a.similarity);
  } else if (similarity > topResults[topResults.length - 1].similarity) {
    topResults[topResults.length - 1] = { entry, similarity };
    topResults.sort((a, b) => b.similarity - a.similarity);
  }
}
```

è¿™ç§ç­–ç•¥åªç»´æŠ¤ Top-K ç»“æœï¼Œé¿å…å¯¹æ‰€æœ‰ç»“æœè¿›è¡Œæ’åºã€‚

#### ç´¢å¼•æŒä¹…åŒ–

VectorIndex åœ¨ä»¥ä¸‹æ—¶æœºå°†æ•°æ®æŒä¹…åŒ–ï¼š

1. **æ·»åŠ æˆ–æ›´æ–°æ¡ç›®**ï¼ˆ`upsert()`ï¼‰ï¼š
   - å†™å…¥å•ä¸ªå‘é‡æ–‡ä»¶ï¼š`data/vectors/{type}/{uid}.json`
   - æ›´æ–°å…ƒæ•°æ®ç´¢å¼•ï¼š`data/vectors/index.json`
   - ä¸¤æ­¥æ“ä½œï¼Œå…ˆå†™å‘é‡æ–‡ä»¶ï¼Œå†æ›´æ–°ç´¢å¼•

2. **åˆ é™¤æ¡ç›®**ï¼ˆ`delete()`ï¼‰ï¼š
   - åˆ é™¤å‘é‡æ–‡ä»¶ï¼š`data/vectors/{type}/{uid}.json`
   - æ›´æ–°å…ƒæ•°æ®ç´¢å¼•ï¼š`data/vectors/index.json`

**å†™å…¥ç­–ç•¥**ï¼š

- å‘é‡æ–‡ä»¶ä½¿ç”¨æ™®é€šå†™å…¥ï¼ˆ`FileStorage.write()`ï¼‰
- å…ƒæ•°æ®ç´¢å¼•ä½¿ç”¨æ™®é€šå†™å…¥ï¼ˆå¯ä»ç¬”è®°æ–‡ä»¶é‡å»ºï¼‰
- ä¸ä½¿ç”¨åŸå­å†™å…¥ï¼Œå› ä¸ºå‘é‡æ•°æ®å¯é‡å»º

**é”™è¯¯æ¢å¤**ï¼š

å¦‚æœå‘é‡æ–‡ä»¶æŸåæˆ–ä¸¢å¤±ï¼Œç³»ç»Ÿå¯ä»¥ï¼š
1. ä»ç¬”è®°æ–‡ä»¶çš„ Frontmatter è¯»å– UID å’Œç±»å‹
2. é‡æ–°è°ƒç”¨åµŒå…¥ API ç”Ÿæˆå‘é‡
3. é‡å»ºå‘é‡ç´¢å¼•

#### æ¨¡å‹å’Œç»´åº¦éªŒè¯

VectorIndex åœ¨åŠ è½½ç´¢å¼•æ—¶ä¼šéªŒè¯æ¨¡å‹å’Œç»´åº¦æ˜¯å¦åŒ¹é…ï¼š

```typescript
async load(): Promise<Result<void>> {
  const indexMeta: VectorIndexMeta = JSON.parse(readResult.value);
  
  // éªŒè¯æ¨¡å‹å’Œç»´åº¦
  if (indexFile.model !== this.model || indexFile.dimension !== this.dimension) {
    console.warn(`VectorIndex æ¨¡å‹/ç»´åº¦ä¸åŒ¹é…ï¼Œå·²é‡å»ºç´¢å¼•`);
    this.buckets = this.createEmptyBuckets();
    await this.save();
    return ok(undefined);
  }

  // åŠ è½½æ¡¶æ•°æ®
  this.buckets = indexFile.buckets;
  return ok(undefined);
}
```

**ä¸åŒ¹é…å¤„ç†**ï¼š

å¦‚æœç´¢å¼•æ–‡ä»¶çš„æ¨¡å‹æˆ–ç»´åº¦ä¸å½“å‰é…ç½®ä¸åŒ¹é…ï¼ŒVectorIndex ä¼šè‡ªåŠ¨é‡å»ºç´¢å¼•ï¼Œé¿å…æ’ä»¶æ— æ³•ä½¿ç”¨ã€‚

#### ç´¢å¼•ç»Ÿè®¡

VectorIndex æä¾›ç»Ÿè®¡ä¿¡æ¯ï¼Œç”¨äºç›‘æ§ç´¢å¼•çŠ¶æ€ï¼š

```typescript
interface IndexStats {
  totalEntries: number;
  byType: Record<CRType, number>;
  lastUpdated: string;
}
```

**ç»Ÿè®¡ç¤ºä¾‹**ï¼š

```json
{
  "totalEntries": 150,
  "byType": {
    "Domain": 10,
    "Issue": 30,
    "Theory": 25,
    "Entity": 60,
    "Mechanism": 25
  },
  "lastUpdated": "2025-12-10T10:30:00.000Z"
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/vector-index.ts`ï¼šVectorIndex å®Œæ•´å®ç°
- `src/types.ts`ï¼šIVectorIndex æ¥å£å®šä¹‰å’Œ VectorEntry ç±»å‹å®šä¹‰

### 5.4 LockManager

**èŒè´£**ï¼šé”è·å–ã€é”é‡Šæ”¾ã€é”æ¢å¤

LockManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰é”ï¼Œé˜²æ­¢å¹¶å‘æ“ä½œå¯¼è‡´çš„æ•°æ®å†²çªã€‚å®ƒæ”¯æŒä¸¤ç§ç±»å‹çš„é”ï¼šèŠ‚ç‚¹é”å’Œç±»å‹é”ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `acquire` | `(key: string, type: 'node' \| 'type', taskId: string) => Result<string>` | è·å–é”ï¼Œè¿”å›é” ID |
| `release` | `(lockId: string) => void` | é‡Šæ”¾æŒ‡å®šçš„é” |
| `isLocked` | `(key: string) => boolean` | æ£€æŸ¥æŒ‡å®šé”®æ˜¯å¦è¢«é”å®š |
| `getActiveLocks` | `() => LockRecord[]` | è·å–æ‰€æœ‰æ´»è·ƒé”åˆ—è¡¨ |
| `restoreLocks` | `(locks: LockRecord[]) => void` | ä»æŒä¹…åŒ–çŠ¶æ€æ¢å¤é” |
| `releaseByTaskId` | `(taskId: string) => void` | é‡Šæ”¾æŒ‡å®šä»»åŠ¡æŒæœ‰çš„æ‰€æœ‰é” |
| `clear` | `() => void` | æ¸…ç©ºæ‰€æœ‰é”ï¼ˆç”¨äºæµ‹è¯•æˆ–é‡ç½®ï¼‰ |

#### èŠ‚ç‚¹é”å’Œç±»å‹é”çš„åŒºåˆ«

LockManager æ”¯æŒä¸¤ç§ç±»å‹çš„é”ï¼Œç”¨äºä¸åŒçš„å¹¶å‘æ§åˆ¶åœºæ™¯ï¼š

**1. èŠ‚ç‚¹é”ï¼ˆNode Lockï¼‰**

- **ç”¨é€”**ï¼šé˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘æ“ä½œ
- **é”é”®æ ¼å¼**ï¼š`nodeId`ï¼ˆå¦‚ `concept-123`ï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼š
  - åˆ›å»ºæ¦‚å¿µæ—¶ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
  - æ›´æ–°æ¦‚å¿µæ—¶ï¼Œé˜²æ­¢å¹¶å‘ä¿®æ”¹
  - åˆ é™¤æ¦‚å¿µæ—¶ï¼Œé˜²æ­¢å¹¶å‘åˆ é™¤

**ç¤ºä¾‹**ï¼š

```typescript
// è·å–èŠ‚ç‚¹é”
const lockResult = lockManager.acquire("concept-123", "node", "task-456");
if (!lockResult.ok) {
  console.error("èŠ‚ç‚¹å·²è¢«é”å®šï¼Œæ— æ³•æ“ä½œ");
  return;
}

// æ‰§è¡Œæ“ä½œ...

// é‡Šæ”¾èŠ‚ç‚¹é”
lockManager.release(lockResult.value);
```

**2. ç±»å‹é”ï¼ˆType Lockï¼‰**

- **ç”¨é€”**ï¼šé˜²æ­¢åŒç±»å‹æ¦‚å¿µçš„å¹¶å‘å»é‡æ£€æµ‹
- **é”é”®æ ¼å¼**ï¼š`type:{CRType}`ï¼ˆå¦‚ `type:Domain`ï¼‰
- **ä½¿ç”¨åœºæ™¯**ï¼š
  - å»é‡æ£€æµ‹æ—¶ï¼Œé˜²æ­¢åŒç±»å‹çš„å¹¶å‘æ£€æµ‹å¯¼è‡´é‡å¤å¯¹é—æ¼

**ç¤ºä¾‹**ï¼š

```typescript
// è·å–ç±»å‹é”
const lockResult = lockManager.acquire("type:Domain", "type", "task-789");
if (!lockResult.ok) {
  console.error("ç±»å‹é”å†²çªï¼Œæ— æ³•æ‰§è¡Œå»é‡æ£€æµ‹");
  return;
}

// æ‰§è¡Œå»é‡æ£€æµ‹...

// é‡Šæ”¾ç±»å‹é”
lockManager.release(lockResult.value);
```

#### é”è®°å½•ç»“æ„

```typescript
interface LockRecord {
  key: string;           // é”é”®ï¼ˆnodeId æˆ– type:CRTypeï¼‰
  type: 'node' | 'type'; // é”ç±»å‹
  taskId: string;        // æŒæœ‰é”çš„ä»»åŠ¡ ID
  acquiredAt: string;    // è·å–æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
  expiresAt: string;     // è¿‡æœŸæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
}
```

#### é”è¶…æ—¶æœºåˆ¶

LockManager ä¸ºæ¯ä¸ªé”è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰ï¼Œé˜²æ­¢åƒµå°¸é”é•¿æœŸå ç”¨ï¼š

```typescript
const LOCK_TIMEOUT_MS = 5 * 60 * 1000; // 5 åˆ†é’Ÿ

acquire(key: string, type: 'node' | 'type', taskId: string): Result<string> {
  // æ£€æŸ¥æ˜¯å¦å·²è¢«é”å®š
  if (this.locks.has(key)) {
    const existingLock = this.locks.get(key)!;
    return err("E400", `é”å†²çª: ${key} å·²è¢«ä»»åŠ¡ ${existingLock.taskId} æŒæœ‰`);
  }

  // åˆ›å»ºé”è®°å½•
  const lockRecord: LockRecord = {
    key,
    type,
    taskId,
    acquiredAt: new Date().toISOString(),
    expiresAt: new Date(Date.now() + LOCK_TIMEOUT_MS).toISOString()
  };

  // å­˜å‚¨é”
  this.locks.set(key, lockRecord);

  return ok(key);
}
```

**è¶…æ—¶æ¸…ç†**ï¼š

LockManager æ¯åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸé”ï¼š

```typescript
private startCleanup(): void {
  this.cleanupInterval = setInterval(() => {
    const released = this.cleanupExpiredLocks();
    if (released > 0) {
      this.logger.warn("LockManager", `æ¸…ç†è¿‡æœŸé” ${released} ä¸ª`);
    }
  }, 60 * 1000);
}

private cleanupExpiredLocks(): number {
  const now = Date.now();
  let released = 0;

  for (const [key, lock] of this.locks.entries()) {
    const expiresAt = new Date(lock.expiresAt).getTime();
    if (expiresAt < now) {
      this.locks.delete(key);
      released++;
    }
  }

  return released;
}
```

#### é”æ¢å¤

LockManager æ”¯æŒä»æŒä¹…åŒ–çŠ¶æ€æ¢å¤é”ï¼Œç”¨äºæ’ä»¶é‡å¯åæ¢å¤é˜Ÿåˆ—çŠ¶æ€ï¼š

```typescript
restoreLocks(locks: LockRecord[]): void {
  this.locks.clear();

  for (const lock of locks) {
    if (!lock || !lock.key || !lock.taskId) continue;
    
    // å¦‚æœé”æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œè®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´
    if (!lock.expiresAt) {
      lock.expiresAt = new Date(Date.now() + this.LOCK_TIMEOUT_MS).toISOString();
    }
    
    this.locks.set(lock.key, lock);
  }

  this.logger.info("LockManager", `é”çŠ¶æ€å·²æ¢å¤ï¼Œå…± ${this.locks.size} ä¸ª`);
}
```

**æ¢å¤ç­–ç•¥**ï¼š

1. **æ¸…ç©ºç°æœ‰é”**ï¼šé¿å…ä¸æ—§é”å†²çª
2. **éªŒè¯é”è®°å½•**ï¼šç¡®ä¿é”è®°å½•åŒ…å«å¿…éœ€å­—æ®µ
3. **è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼šå¦‚æœé”æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œè®¾ç½®é»˜è®¤å€¼
4. **æ¢å¤é”**ï¼šå°†é”è®°å½•æ·»åŠ åˆ°é”ç®¡ç†å™¨

#### æ‰¹é‡é‡Šæ”¾é”

LockManager æ”¯æŒæ‰¹é‡é‡Šæ”¾æŒ‡å®šä»»åŠ¡æŒæœ‰çš„æ‰€æœ‰é”ï¼š

```typescript
releaseByTaskId(taskId: string): void {
  const locksToRelease: string[] = [];

  for (const [key, lock] of this.locks.entries()) {
    if (lock.taskId === taskId) {
      locksToRelease.push(key);
    }
  }

  for (const key of locksToRelease) {
    this.release(key);
  }

  if (locksToRelease.length > 0) {
    this.logger.info("LockManager", `é‡Šæ”¾ä»»åŠ¡ ${taskId} æŒæœ‰çš„ ${locksToRelease.length} ä¸ªé”`);
  }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š

- ä»»åŠ¡å®Œæˆåï¼Œé‡Šæ”¾æ‰€æœ‰æŒæœ‰çš„é”
- ä»»åŠ¡å¤±è´¥åï¼Œé‡Šæ”¾æ‰€æœ‰æŒæœ‰çš„é”
- ä»»åŠ¡å–æ¶ˆåï¼Œé‡Šæ”¾æ‰€æœ‰æŒæœ‰çš„é”

#### é”å†²çªå¤„ç†

å½“å°è¯•è·å–å·²è¢«é”å®šçš„é”®æ—¶ï¼ŒLockManager è¿”å›é”™è¯¯ï¼š

```typescript
if (this.locks.has(key)) {
  const existingLock = this.locks.get(key)!;
  this.logger.warn("LockManager", `é”å†²çª: key=${key} å·²è¢«ä»»åŠ¡ ${existingLock.taskId} æŒæœ‰`);
  
  return err("E400", `é”å†²çª: ${key} å·²è¢«ä»»åŠ¡ ${existingLock.taskId} æŒæœ‰`, {
    key,
    type,
    taskId,
    existingLock
  });
}
```

**å†²çªè§£å†³ç­–ç•¥**ï¼š

1. **ä»»åŠ¡å…¥é˜Ÿæ—¶æ£€æŸ¥**ï¼šTaskQueue åœ¨ä»»åŠ¡å…¥é˜Ÿæ—¶æ£€æŸ¥é”å†²çªï¼Œå¦‚æœå†²çªåˆ™æ‹’ç»å…¥é˜Ÿ
2. **ä»»åŠ¡è°ƒåº¦æ—¶æ£€æŸ¥**ï¼šTaskQueue åœ¨è°ƒåº¦ä»»åŠ¡æ—¶å†æ¬¡æ£€æŸ¥é”å†²çªï¼Œå¦‚æœå†²çªåˆ™è·³è¿‡è¯¥ä»»åŠ¡
3. **ä»»åŠ¡å®Œæˆåé‡Šæ”¾**ï¼šä»»åŠ¡å®Œæˆåç«‹å³é‡Šæ”¾é”ï¼Œå…è®¸å…¶ä»–ä»»åŠ¡è·å–

#### é”çš„ç”Ÿå‘½å‘¨æœŸ

```
1. ä»»åŠ¡å…¥é˜Ÿ
   â†“
2. æ£€æŸ¥é”å†²çª
   â†“
3. è·å–é”ï¼ˆå¦‚æœæ— å†²çªï¼‰
   â†“
4. ä»»åŠ¡æ‰§è¡Œ
   â†“
5. ä»»åŠ¡å®Œæˆ/å¤±è´¥/å–æ¶ˆ
   â†“
6. é‡Šæ”¾é”
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/lock-manager.ts`ï¼šLockManager å®Œæ•´å®ç°
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œå±•ç¤ºé”çš„è·å–å’Œé‡Šæ”¾æµç¨‹
- `src/types.ts`ï¼šLockRecord å’Œ ILockManager æ¥å£å®šä¹‰

### 5.5 UndoManager

**èŒè´£**ï¼šå¿«ç…§åˆ›å»ºã€å¿«ç…§æ¢å¤ã€å¿«ç…§æ¸…ç†

UndoManager è´Ÿè´£ç®¡ç†æ–‡ä»¶å¿«ç…§ï¼Œæ”¯æŒæ’¤é”€æ“ä½œã€‚å®ƒåœ¨æ¯æ¬¡å†™å…¥æ–‡ä»¶å‰è‡ªåŠ¨åˆ›å»ºå¿«ç…§ï¼Œç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥æ— æŸå›æ»šã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `initialize` | `() => Promise<Result<void>>` | åˆå§‹åŒ–æ’¤é”€ç®¡ç†å™¨ï¼ŒåŠ è½½å¿«ç…§ç´¢å¼• |
| `createSnapshot` | `(filePath: string, content: string, taskId: string, nodeId?: string) => Promise<Result<string>>` | åˆ›å»ºå¿«ç…§ï¼Œè¿”å›å¿«ç…§ ID |
| `restoreSnapshot` | `(snapshotId: string) => Promise<Result<Snapshot>>` | æ¢å¤å¿«ç…§ï¼ˆä»…è¯»å–å†…å®¹ï¼‰ |
| `restoreSnapshotToFile` | `(snapshotId: string) => Promise<Result<Snapshot>>` | æ¢å¤å¿«ç…§åˆ°æ–‡ä»¶ï¼ˆä½¿ç”¨åŸå­å†™å…¥ï¼‰ |
| `deleteSnapshot` | `(snapshotId: string) => Promise<Result<void>>` | åˆ é™¤æŒ‡å®šå¿«ç…§ |
| `listSnapshots` | `() => Promise<Result<SnapshotMetadata[]>>` | åˆ—å‡ºæ‰€æœ‰å¿«ç…§çš„å…ƒæ•°æ® |
| `cleanupExpiredSnapshots` | `(maxAgeMs: number) => Promise<Result<number>>` | æ¸…ç†è¿‡æœŸå¿«ç…§ |
| `updateRetentionPolicy` | `(maxSnapshots?: number, maxAgeDays?: number) => void` | æ›´æ–°ä¿ç•™ç­–ç•¥ |

#### å¿«ç…§ç´¢å¼•ç®¡ç†

UndoManager ç»´æŠ¤ä¸€ä¸ªå¿«ç…§ç´¢å¼•æ–‡ä»¶ï¼ˆ`data/snapshots/index.json`ï¼‰ï¼Œè®°å½•æ‰€æœ‰å¿«ç…§çš„å…ƒæ•°æ®ï¼š

```typescript
interface SnapshotIndex {
  version: string;
  snapshots: SnapshotRecord[];
  retentionPolicy: {
    maxCount: number;    // æœ€å¤§å¿«ç…§æ•°é‡
    maxAgeDays: number;  // æœ€å¤§ä¿ç•™å¤©æ•°
  };
}

interface SnapshotRecord {
  id: string;           // å¿«ç…§ ID
  nodeId: string;       // èŠ‚ç‚¹ ID
  taskId: string;       // ä»»åŠ¡ ID
  path: string;         // æ–‡ä»¶è·¯å¾„
  created: string;      // åˆ›å»ºæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
  fileSize: number;     // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  checksum: string;     // æ ¡éªŒå’Œï¼ˆSHA-256ï¼‰
}
```

**ç´¢å¼•ä¼˜åŠ¿**ï¼š

1. **å¿«é€ŸæŸ¥æ‰¾**ï¼šæ— éœ€éå†æ‰€æœ‰å¿«ç…§æ–‡ä»¶ï¼Œç›´æ¥ä»ç´¢å¼•ä¸­æŸ¥æ‰¾
2. **å…ƒæ•°æ®ç®¡ç†**ï¼šè®°å½•å¿«ç…§çš„åˆ›å»ºæ—¶é—´ã€æ–‡ä»¶å¤§å°ç­‰ä¿¡æ¯
3. **ä¿ç•™ç­–ç•¥**ï¼šæ ¹æ®ç´¢å¼•ä¸­çš„å…ƒæ•°æ®æ‰§è¡Œæ¸…ç†ç­–ç•¥

#### å¿«ç…§åˆ›å»ºæµç¨‹

UndoManager åœ¨åˆ›å»ºå¿«ç…§æ—¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```
1. éªŒè¯å‚æ•°
   â†“
2. ç”Ÿæˆå¿«ç…§ ID
   â†“
3. è®¡ç®—æ ¡éªŒå’Œ
   â†“
4. åˆ›å»ºå¿«ç…§è®°å½•
   â†“
5. ä¿å­˜å¿«ç…§æ–‡ä»¶
   â†“
6. æ›´æ–°ç´¢å¼•
   â†“
7. æ¸…ç†è¿‡æœŸå¿«ç…§ï¼ˆå¦‚æœè¶…è¿‡ä¸Šé™ï¼‰
```

**å¿«ç…§è®°å½•å®Œæ•´æ€§éªŒè¯ï¼ˆProperty 11ï¼‰**ï¼š

UndoManager ç¡®ä¿å¿«ç…§è®°å½•åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼š

```typescript
private validateSnapshotRecord(snapshot: SnapshotRecord): Result<void> {
  const requiredFields: (keyof SnapshotRecord)[] = [
    'id', 'nodeId', 'taskId', 'path', 'content', 'created', 'fileSize', 'checksum'
  ];
  
  for (const field of requiredFields) {
    if (snapshot[field] === undefined || snapshot[field] === null) {
      return err("E303", `å¿«ç…§è®°å½•ç¼ºå°‘å¿…éœ€å­—æ®µ: ${field}`);
    }
  }
  
  // éªŒè¯å­—æ®µç±»å‹
  if (typeof snapshot.id !== 'string' || snapshot.id.length === 0) {
    return err("E303", "å¿«ç…§ ID å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²");
  }
  // ... å…¶ä»–å­—æ®µéªŒè¯
  
  return ok(undefined);
}
```

#### åŸå­æ¢å¤ï¼ˆProperty 12ï¼‰

UndoManager ä½¿ç”¨åŸå­å†™å…¥æœºåˆ¶æ¢å¤å¿«ç…§ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼š

```typescript
async restoreSnapshotToFile(snapshotId: string): Promise<Result<Snapshot>> {
  // 1. è¯»å–å¿«ç…§å†…å®¹
  const snapshotResult = await this.restoreSnapshot(snapshotId);
  if (!snapshotResult.ok) {
    return snapshotResult;
  }

  const snapshot = snapshotResult.value;

  // 2. ä½¿ç”¨åŸå­å†™å…¥æ¢å¤æ–‡ä»¶
  // éµå¾ª A-NF-02ï¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶ .tmp â†’ æ ¡éªŒå®Œæ•´æ€§ â†’ é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶
  const atomicWriteResult = await this.fileStorage.atomicWrite(
    snapshot.path,
    snapshot.content
  );

  if (!atomicWriteResult.ok) {
    return err("E303", `å¿«ç…§æ¢å¤å¤±è´¥: ${atomicWriteResult.error.message}`);
  }

  return ok(snapshot);
}
```

**åŸå­å†™å…¥æµç¨‹**ï¼š

1. **å†™å…¥ä¸´æ—¶æ–‡ä»¶**ï¼šå°†å†…å®¹å†™å…¥ `.tmp` æ–‡ä»¶
2. **æ ¡éªŒå®Œæ•´æ€§**ï¼šéªŒè¯å†™å…¥çš„å†…å®¹ä¸å¿«ç…§å†…å®¹ä¸€è‡´
3. **é‡å‘½åæ–‡ä»¶**ï¼šå°† `.tmp` æ–‡ä»¶é‡å‘½åä¸ºç›®æ ‡æ–‡ä»¶
4. **åˆ é™¤å¤‡ä»½**ï¼šåˆ é™¤ `.bak` å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

è¿™ç§æœºåˆ¶ç¡®ä¿å³ä½¿æ¢å¤è¿‡ç¨‹ä¸­æ–­ï¼Œä¹Ÿä¸ä¼šæŸååŸæ–‡ä»¶ã€‚

#### å¿«ç…§æ¸…ç†ç­–ç•¥

UndoManager æ”¯æŒä¸¤ç§æ¸…ç†ç­–ç•¥ï¼š

**1. æŒ‰æ•°é‡æ¸…ç†**

å½“å¿«ç…§æ•°é‡è¶…è¿‡ä¸Šé™æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„å¿«ç…§ï¼š

```typescript
if (this.index.snapshots.length > this.maxSnapshots) {
  await this.cleanupOldestSnapshots(this.index.snapshots.length - this.maxSnapshots);
}
```

**2. æŒ‰æ—¶é—´æ¸…ç†**

å®šæœŸæ¸…ç†è¶…è¿‡ä¿ç•™æœŸé™çš„å¿«ç…§ï¼š

```typescript
async cleanupExpiredSnapshots(maxAgeMs: number): Promise<Result<number>> {
  const now = Date.now();
  const expiredSnapshots: string[] = [];

  for (const snapshot of this.index.snapshots) {
    const createdTime = new Date(snapshot.created).getTime();
    if (now - createdTime > maxAgeMs) {
      expiredSnapshots.push(snapshot.id);
    }
  }

  for (const snapshotId of expiredSnapshots) {
    await this.deleteSnapshot(snapshotId);
  }

  return ok(expiredSnapshots.length);
}
```

**é»˜è®¤ä¿ç•™ç­–ç•¥**ï¼š

- **æœ€å¤§å¿«ç…§æ•°é‡**ï¼š100 ä¸ª
- **æœ€å¤§ä¿ç•™å¤©æ•°**ï¼š30 å¤©

ç”¨æˆ·å¯ä»¥é€šè¿‡ `updateRetentionPolicy()` æ–¹æ³•è°ƒæ•´ä¿ç•™ç­–ç•¥ã€‚

#### å¿«ç…§æ–‡ä»¶ç»„ç»‡

UndoManager å°†å¿«ç…§æ–‡ä»¶å­˜å‚¨åœ¨ `data/snapshots/` ç›®å½•ä¸‹ï¼š

```
data/
â””â”€â”€ snapshots/
    â”œâ”€â”€ index.json                    # å¿«ç…§ç´¢å¼•
    â”œâ”€â”€ snapshot-1234567890-abc.json  # å¿«ç…§æ–‡ä»¶
    â”œâ”€â”€ snapshot-1234567891-def.json
    â””â”€â”€ ...
```

**å¿«ç…§æ–‡ä»¶æ ¼å¼**ï¼š

```json
{
  "id": "snapshot-1234567890-abc",
  "nodeId": "concept-123",
  "taskId": "task-456",
  "path": "Domain/è®¤çŸ¥ç§‘å­¦.md",
  "content": "---\nuid: concept-123\n...",
  "created": "2025-12-10T10:30:00.000Z",
  "fileSize": 1024,
  "checksum": "a1b2c3d4..."
}
```

#### æ ¡éªŒå’ŒéªŒè¯

UndoManager åœ¨æ¢å¤å¿«ç…§æ—¶ä¼šéªŒè¯æ ¡éªŒå’Œï¼Œç¡®ä¿å¿«ç…§æ–‡ä»¶æœªè¢«ç¯¡æ”¹ï¼š

```typescript
// è®¡ç®—æ ¡éªŒå’Œ
const calculatedChecksum = this.calculateChecksum(snapshot.content);

// éªŒè¯æ ¡éªŒå’Œ
if (calculatedChecksum !== snapshot.checksum) {
  return err("E303", "å¿«ç…§æ–‡ä»¶å·²æŸåï¼ˆæ ¡éªŒå’Œä¸åŒ¹é…ï¼‰");
}
```

**æ ¡éªŒå’Œç®—æ³•**ï¼šSHA-256

```typescript
private calculateChecksum(content: string): string {
  return createHash('sha256').update(content, 'utf8').digest('hex');
}
```

#### è·¯å¾„éªŒè¯

UndoManager åœ¨åˆ›å»ºå¿«ç…§æ—¶ä¼šéªŒè¯æ–‡ä»¶è·¯å¾„ï¼Œé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼š

```typescript
private validateFilePath(filePath: string): Result<void> {
  // ç¦æ­¢è·¯å¾„éå†
  if (filePath.includes("..")) {
    return err("E303", "æ–‡ä»¶è·¯å¾„ä¸èƒ½åŒ…å« '..'");
  }
  
  // ç¦æ­¢ç»å¯¹è·¯å¾„
  if (/^([A-Za-z]:|\\\\|\/)/.test(filePath)) {
    return err("E303", "æ–‡ä»¶è·¯å¾„å¿…é¡»æ˜¯ç›¸å¯¹è·¯å¾„");
  }
  
  // ä»…æ”¯æŒ Markdown æ–‡ä»¶
  if (!filePath.endsWith(".md")) {
    return err("E303", "ä»…æ”¯æŒ Markdown æ–‡ä»¶å¿«ç…§ (.md)");
  }
  
  return ok(undefined);
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/undo-manager.ts`ï¼šUndoManager å®Œæ•´å®ç°
- `src/types.ts`ï¼šIUndoManager æ¥å£å®šä¹‰å’Œ SnapshotRecord ç±»å‹å®šä¹‰

### 5.6 ProviderManager

**èŒè´£**ï¼šProvider é…ç½®ã€API è°ƒç”¨ã€ç½‘ç»œçŠ¶æ€ç›‘æ§

ProviderManager è´Ÿè´£ç®¡ç† AI æœåŠ¡æä¾›å•†ï¼ˆProviderï¼‰ï¼Œæ”¯æŒ OpenAI æ ‡å‡†æ ¼å¼çš„ API è°ƒç”¨ã€‚å®ƒæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œæ”¯æŒå¤šä¸ª Provider é…ç½®å’Œè‡ªå®šä¹‰ç«¯ç‚¹ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `chat` | `(request: ChatRequest, signal?: AbortSignal) => Promise<Result<ChatResponse>>` | è°ƒç”¨èŠå¤© API |
| `embed` | `(request: EmbedRequest, signal?: AbortSignal) => Promise<Result<EmbedResponse>>` | è°ƒç”¨åµŒå…¥ API |
| `checkAvailability` | `(providerId: string, forceRefresh?: boolean) => Promise<Result<ProviderCapabilities>>` | æ£€æŸ¥ Provider å¯ç”¨æ€§ |
| `getConfiguredProviders` | `() => ProviderInfo[]` | è·å–å·²é…ç½®çš„ Provider åˆ—è¡¨ |
| `subscribeNetworkStatus` | `(listener: (online: boolean, error?: Err) => void) => () => void` | è®¢é˜…ç½‘ç»œçŠ¶æ€å˜åŒ– |
| `setProvider` | `(id: string, config: ProviderConfig) => void` | è®¾ç½® Provider é…ç½® |
| `removeProvider` | `(id: string) => void` | ç§»é™¤ Provider |

#### OpenAI æ ‡å‡†æ ¼å¼æ”¯æŒ

ProviderManager ä½¿ç”¨ OpenAI æ ‡å‡†æ ¼å¼è°ƒç”¨ APIï¼Œæ”¯æŒæ‰€æœ‰å…¼å®¹ OpenAI API çš„æœåŠ¡ï¼š

**èŠå¤© API**ï¼š`POST /chat/completions`

```typescript
// è¯·æ±‚æ ¼å¼
{
  "model": "gpt-4o",
  "messages": [
    { "role": "user", "content": "..." }
  ],
  "temperature": 0.7,
  "top_p": 1.0,
  "max_tokens": 4000
}

// å“åº”æ ¼å¼
{
  "choices": [
    {
      "message": {
        "content": "..."
      },
      "finish_reason": "stop"
    }
  ],
  "usage": {
    "prompt_tokens": 100,
    "completion_tokens": 200,
    "total_tokens": 300
  }
}
```

**åµŒå…¥ API**ï¼š`POST /embeddings`

```typescript
// è¯·æ±‚æ ¼å¼
{
  "model": "text-embedding-3-small",
  "input": "...",
  "dimensions": 1536  // å¯é€‰ï¼Œæ”¯æŒå¯å˜ç»´åº¦æ¨¡å‹
}

// å“åº”æ ¼å¼
{
  "data": [
    {
      "embedding": [0.1, 0.2, ...]
    }
  ],
  "usage": {
    "prompt_tokens": 10,
    "total_tokens": 10
  }
}
```

#### è‡ªå®šä¹‰ç«¯ç‚¹æ”¯æŒ

ProviderManager æ”¯æŒé…ç½®è‡ªå®šä¹‰ API ç«¯ç‚¹ï¼Œå…¼å®¹ OpenRouterã€Azureã€æœ¬åœ°æ¨¡å‹ç­‰æœåŠ¡ï¼š

```typescript
interface ProviderConfig {
  enabled: boolean;
  apiKey: string;
  baseUrl?: string;  // è‡ªå®šä¹‰ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
}
```

**é»˜è®¤ç«¯ç‚¹**ï¼š

```typescript
const DEFAULT_ENDPOINTS = {
  "openai": "https://api.openai.com/v1"
};
```

**è‡ªå®šä¹‰ç«¯ç‚¹ç¤ºä¾‹**ï¼š

- **OpenRouter**ï¼š`https://openrouter.ai/api/v1`
- **Azure OpenAI**ï¼š`https://{resource}.openai.azure.com/openai/deployments/{deployment}`
- **æœ¬åœ°æ¨¡å‹**ï¼š`http://localhost:8000/v1`

#### ç½‘ç»œçŠ¶æ€ç›‘æ§

ProviderManager å®æ—¶ç›‘æ§ç½‘ç»œçŠ¶æ€ï¼Œå½“æ£€æµ‹åˆ°ç½‘ç»œé”™è¯¯æ—¶é€šçŸ¥ UI å±‚ï¼š

```typescript
subscribeNetworkStatus(listener: (online: boolean, error?: Err) => void): () => void {
  this.networkListeners.push(listener);
  return () => {
    this.networkListeners = this.networkListeners.filter((l) => l !== listener);
  };
}
```

**çŠ¶æ€å˜æ›´é€šçŸ¥**ï¼š

- **åœ¨çº¿ â†’ ç¦»çº¿**ï¼šå½“ API è°ƒç”¨è¿”å›ç½‘ç»œé”™è¯¯ï¼ˆE102ï¼‰æ—¶
- **ç¦»çº¿ â†’ åœ¨çº¿**ï¼šå½“ API è°ƒç”¨æˆåŠŸæ—¶

**UI å“åº”**ï¼š

- æ˜¾ç¤ºç¦»çº¿æç¤º
- ç¦ç”¨éœ€è¦ç½‘ç»œçš„åŠŸèƒ½
- æä¾›é‡è¯•é€‰é¡¹

#### å¯ç”¨æ€§æ£€æŸ¥ç¼“å­˜

ProviderManager ç¼“å­˜ Provider å¯ç”¨æ€§æ£€æŸ¥ç»“æœï¼Œé¿å…é¢‘ç¹ç½‘ç»œè¯·æ±‚ï¼š

```typescript
private availabilityCache: Map<string, AvailabilityCacheEntry>;
private static readonly CACHE_TTL_MS = 5 * 60 * 1000; // 5 åˆ†é’Ÿç¼“å­˜

async checkAvailability(providerId: string, forceRefresh = false): Promise<Result<ProviderCapabilities>> {
  // æ£€æŸ¥ç¼“å­˜ï¼ˆé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰
  if (!forceRefresh) {
    const cached = this.availabilityCache.get(providerId);
    if (cached && Date.now() - cached.timestamp < ProviderManager.CACHE_TTL_MS) {
      return ok(cached.capabilities);
    }
  }

  // è°ƒç”¨ /models ç«¯ç‚¹éªŒè¯ API Key å’Œè¿æ¥
  const response = await fetch(`${baseUrl}/models`, {
    headers: { "Authorization": `Bearer ${apiKey}` }
  });

  // æ›´æ–°ç¼“å­˜
  this.availabilityCache.set(providerId, {
    capabilities,
    timestamp: Date.now()
  });

  return ok(capabilities);
}
```

**ç¼“å­˜ç­–ç•¥**ï¼š

- **ç¼“å­˜æ—¶é—´**ï¼š5 åˆ†é’Ÿ
- **å¼ºåˆ¶åˆ·æ–°**ï¼šè®¾ç½®é¡µé¢"æµ‹è¯•è¿æ¥"æ—¶ä½¿ç”¨ `forceRefresh=true`
- **ç¦»çº¿å®¹é”™**ï¼šç½‘ç»œé”™è¯¯æ—¶è¿”å›è¿‡æœŸç¼“å­˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### é”™è¯¯å¤„ç†ä¸é‡è¯•

ProviderManager ä½¿ç”¨ RetryHandler å¤„ç†é”™è¯¯å’Œé‡è¯•ï¼š

```typescript
const result = await this.retryHandler.executeWithRetry(
  async () => this.executeChatRequest(url, requestBody, apiKey, signal),
  {
    ...NETWORK_ERROR_CONFIG,
    onRetry: (attempt, error) => {
      this.logger.warn("ProviderManager", `èŠå¤©è¯·æ±‚é‡è¯• ${attempt}`, {
        errorCode: error.code,
        errorMessage: error.message
      });
    }
  }
);
```

**é‡è¯•ç­–ç•¥**ï¼š

| é”™è¯¯ç±»å‹ | æœ€å¤§é‡è¯•æ¬¡æ•° | é‡è¯•ç­–ç•¥ |
|---------|-------------|---------|
| ç½‘ç»œé”™è¯¯ï¼ˆE102ï¼‰ | 5 æ¬¡ | æŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 4s, 8s, 16sï¼‰ |
| é€Ÿç‡é™åˆ¶ï¼ˆ429ï¼‰ | 5 æ¬¡ | æŒ‡æ•°é€€é¿ |
| æœåŠ¡å™¨é”™è¯¯ï¼ˆ5xxï¼‰ | 3 æ¬¡ | æŒ‡æ•°é€€é¿ |
| è®¤è¯é”™è¯¯ï¼ˆ401/403ï¼‰ | 0 æ¬¡ | ä¸é‡è¯• |

#### HTTP é”™è¯¯æ˜ å°„

ProviderManager å°† HTTP çŠ¶æ€ç æ˜ å°„ä¸ºç³»ç»Ÿé”™è¯¯ç ï¼š

```typescript
private mapHttpError(status: number, responseText: string): Result<never> {
  // è®¤è¯é”™è¯¯ (401/403) â†’ E103
  if (status === 401 || status === 403) {
    return err("E103", `è®¤è¯å¤±è´¥: ${errorMessage}`);
  }

  // é€Ÿç‡é™åˆ¶ (429) â†’ E102
  if (status === 429) {
    return err("E102", `é€Ÿç‡é™åˆ¶: ${errorMessage}`);
  }

  // æœåŠ¡å™¨é”™è¯¯ (5xx) â†’ E100
  if (status >= 500) {
    return err("E100", `æœåŠ¡å™¨é”™è¯¯ (${status}): ${errorMessage}`);
  }

  // å…¶ä»–å®¢æˆ·ç«¯é”™è¯¯ â†’ E100
  return err("E100", `API é”™è¯¯ (${status}): ${errorMessage}`);
}
```

#### è¯·æ±‚è¶…æ—¶

ProviderManager ä¸ºæ¯ä¸ªè¯·æ±‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 60 ç§’ï¼‰ï¼š

```typescript
private static readonly REQUEST_TIMEOUT_MS = 60 * 1000; // 60 ç§’

const controller = new AbortController();
const timeoutId = setTimeout(() => {
  controller.abort(new Error("è¯·æ±‚è¶…æ—¶"));
}, ProviderManager.REQUEST_TIMEOUT_MS);

try {
  const response = await fetch(url, {
    signal: controller.signal,
    // ...
  });
} finally {
  clearTimeout(timeoutId);
}
```

#### å®‰å…¨æ€§

ProviderManager å®ç°äº†å¤šé¡¹å®‰å…¨æªæ–½ï¼š

**1. API Key è„±æ•**

æ—¥å¿—ä¸­çš„ API Key ä¼šè¢«è„±æ•å¤„ç†ï¼š

```typescript
static maskApiKey(apiKey: string): string {
  if (!apiKey || apiKey.length <= 8) return "***";
  return `${apiKey.slice(0, 4)}...${apiKey.slice(-4)}`;
}
```

**2. URL æ¸…ç†**

æ—¥å¿—ä¸­çš„ URL ä¼šç§»é™¤æ•æ„Ÿå‚æ•°ï¼š

```typescript
static sanitizeUrl(raw: string): string {
  const url = new URL(raw);
  url.searchParams.delete("api_key");
  url.searchParams.delete("token");
  return url.toString();
}
```

**3. è¯·æ±‚éªŒè¯**

åœ¨å‘é€è¯·æ±‚å‰éªŒè¯ Provider é…ç½®ï¼š

```typescript
// æ£€æŸ¥ Provider æ˜¯å¦å­˜åœ¨
if (!providerConfig) {
  return err("E304", `Provider æœªé…ç½®: ${providerId}`);
}

// æ£€æŸ¥ Provider æ˜¯å¦å¯ç”¨
if (!providerConfig.enabled) {
  return err("E304", `Provider å·²ç¦ç”¨: ${providerId}`);
}

// æ£€æŸ¥ API Key æ˜¯å¦é…ç½®
if (!providerConfig.apiKey) {
  return err("E103", `Provider API Key æœªé…ç½®: ${providerId}`);
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/provider-manager.ts`ï¼šProviderManager å®Œæ•´å®ç°
- `src/types.ts`ï¼šIProviderManager æ¥å£å®šä¹‰å’Œ ProviderConfig ç±»å‹å®šä¹‰

### 5.7 PromptManager

**èŒè´£**ï¼šæ¨¡æ¿åŠ è½½ã€Prompt æ„å»ºã€æ§½ä½å¡«å……

PromptManager è´Ÿè´£ç®¡ç†æç¤ºè¯æ¨¡æ¿ï¼Œæ”¯æŒæ¨¡æ¿åŠ è½½ã€éªŒè¯å’Œæ„å»ºã€‚å®ƒç¡®ä¿æ‰€æœ‰ AI è°ƒç”¨ä½¿ç”¨ä¸€è‡´çš„æç¤ºè¯æ ¼å¼ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `build` | `(taskType: TaskType, slots: Record<string, string>, conceptType?: string) => Result<string>` | æ„å»º Prompt |
| `validateTemplate` | `(templateId: string) => Result<boolean>` | éªŒè¯æ¨¡æ¿ç»“æ„ |
| `resolveTemplateId` | `(taskType: TaskType, conceptType?: string) => string` | è·å–æ¨¡æ¿ ID |
| `preloadTemplate` | `(templateId: string) => Promise<Result<void>>` | é¢„åŠ è½½æ¨¡æ¿ |
| `preloadAllTemplates` | `() => Promise<Result<void>>` | é¢„åŠ è½½æ‰€æœ‰æ¨¡æ¿ |
| `getRequiredSlots` | `(taskType: TaskType) => string[]` | è·å–å¿…éœ€æ§½ä½ |
| `getOptionalSlots` | `(taskType: TaskType) => string[]` | è·å–å¯é€‰æ§½ä½ |

#### æ¨¡æ¿æ–‡ä»¶ç»„ç»‡

PromptManager ä» `prompts/` ç›®å½•åŠ è½½æ¨¡æ¿æ–‡ä»¶ï¼š

```
prompts/
â”œâ”€â”€ standardizeClassify.md    # æ ‡å‡†åŒ–å’Œåˆ†ç±»æ¨¡æ¿
â”œâ”€â”€ enrich.md                 # ä¸°å¯Œæ¨¡æ¿ï¼ˆç”Ÿæˆåˆ«åå’Œæ ‡ç­¾ï¼‰
â”œâ”€â”€ reason-domain.md          # Domain ç±»å‹æ¨ç†æ¨¡æ¿
â”œâ”€â”€ reason-issue.md           # Issue ç±»å‹æ¨ç†æ¨¡æ¿
â”œâ”€â”€ reason-theory.md          # Theory ç±»å‹æ¨ç†æ¨¡æ¿
â”œâ”€â”€ reason-entity.md          # Entity ç±»å‹æ¨ç†æ¨¡æ¿
â”œâ”€â”€ reason-mechanism.md       # Mechanism ç±»å‹æ¨ç†æ¨¡æ¿
â””â”€â”€ ground.md                 # äº‹å®æ ¸æŸ¥æ¨¡æ¿
```

**æ¨¡æ¿å‘½åè§„åˆ™**ï¼š

- ä»»åŠ¡ç±»å‹ç›´æ¥æ˜ å°„åˆ°æ¨¡æ¿æ–‡ä»¶åï¼ˆå¦‚ `standardizeClassify` â†’ `standardizeClassify.md`ï¼‰
- `reason:new` ä»»åŠ¡æ ¹æ®æ¦‚å¿µç±»å‹é€‰æ‹©æ¨¡æ¿ï¼ˆå¦‚ `Domain` â†’ `reason-domain.md`ï¼‰

#### æ¨¡æ¿ç»“æ„

PromptManager ä½¿ç”¨ç»“æ„åŒ–çš„æ¨¡æ¿æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹åŒºå—ï¼š

```markdown
<system_instructions>
ç³»ç»ŸæŒ‡ä»¤å’Œè§’è‰²å®šä¹‰
</system_instructions>

<context_slots>
ä¸Šä¸‹æ–‡æ§½ä½ï¼ˆå˜é‡å ä½ç¬¦ï¼‰
- {{CTX_INPUT}}: ç”¨æˆ·è¾“å…¥
- {{CTX_META}}: å…ƒæ•°æ®ä¸Šä¸‹æ–‡
- {{CTX_LANGUAGE}}: è¾“å‡ºè¯­è¨€
</context_slots>

<task_instruction>
ä»»åŠ¡è¯´æ˜
</task_instruction>

<output_schema>
è¾“å‡ºæ ¼å¼å®šä¹‰ï¼ˆJSON Schemaï¼‰
</output_schema>
```

**å¿…éœ€åŒºå—**ï¼š

- `<system_instructions>`ï¼šç³»ç»ŸæŒ‡ä»¤å’Œè§’è‰²å®šä¹‰
- `<context_slots>`ï¼šä¸Šä¸‹æ–‡æ§½ä½
- `<output_schema>`ï¼šè¾“å‡ºæ ¼å¼å®šä¹‰
- `<task_instruction>` æˆ– `<task>`ï¼šä»»åŠ¡è¯´æ˜ï¼ˆè‡³å°‘ä¸€ä¸ªï¼‰

**å¯é€‰åŒºå—**ï¼š

- `<writing_style>`ï¼šå†™ä½œé£æ ¼æŒ‡å—ï¼ˆreason ç±»ä»»åŠ¡ï¼‰
- `<naming_morphology>`ï¼šå‘½åè§„èŒƒï¼ˆæŸäº›ä»»åŠ¡ï¼‰
- `<philosophical_core>`ï¼šå“²å­¦æ ¸å¿ƒï¼ˆreason ç±»ä»»åŠ¡ï¼‰

#### æ§½ä½æœºåˆ¶

PromptManager ä½¿ç”¨æ§½ä½ï¼ˆSlotï¼‰æœºåˆ¶å¡«å……æ¨¡æ¿å˜é‡ï¼š

**æ§½ä½æ ¼å¼**ï¼š`{{SLOT_NAME}}`

**ä»»åŠ¡-æ§½ä½æ˜ å°„è¡¨**ï¼š

| ä»»åŠ¡ç±»å‹ | å¿…éœ€æ§½ä½ | å¯é€‰æ§½ä½ |
|---------|---------|---------|
| `standardizeClassify` | `CTX_INPUT` | `CTX_LANGUAGE` |
| `enrich` | `CTX_META` | `CTX_LANGUAGE` |
| `embedding` | `CTX_INPUT` | `CTX_LANGUAGE` |
| `reason:new` | `CTX_META` | `CTX_SOURCES`, `CTX_LANGUAGE` |
| `ground` | `CTX_META`, `CTX_CURRENT` | `CTX_SOURCES`, `CTX_LANGUAGE` |

**æ§½ä½éªŒè¯**ï¼š

PromptManager åœ¨æ„å»º Prompt æ—¶ä¼šéªŒè¯æ§½ä½æ˜¯å¦ç¬¦åˆä»»åŠ¡-æ§½ä½æ˜ å°„è¡¨ï¼š

```typescript
const slotValidation = validateSlots(taskType, providedSlotKeys);

if (!slotValidation.valid) {
  if (slotValidation.missingRequired) {
    return err("E002", `ç¼ºå°‘å¿…éœ€æ§½ä½: ${slotValidation.missingRequired.join(", ")}`);
  }
  if (slotValidation.extraSlots) {
    return err("E002", `ä»»åŠ¡ ${taskType} ä¸å…è®¸ä½¿ç”¨æ§½ä½: ${slotValidation.extraSlots.join(", ")}`);
  }
}
```

#### Prompt æ„å»ºæµç¨‹

PromptManager æŒ‰ä»¥ä¸‹æ­¥éª¤æ„å»º Promptï¼š

```
1. è§£ææ¨¡æ¿ ID
   â†“
2. åŠ è½½æ¨¡æ¿
   â†“
3. éªŒè¯æ§½ä½
   â†“
4. æ›¿æ¢å˜é‡
   â†“
5. éªŒè¯æœªæ›¿æ¢å˜é‡
   â†“
6. è¿”å›å®Œæ•´ Prompt
```

**å˜é‡æ›¿æ¢**ï¼š

```typescript
// æ›¿æ¢æ‰€æœ‰æ§½ä½
for (const [key, value] of Object.entries(slots)) {
  prompt = replaceVariable(prompt, key, value);
}

// éªŒè¯æ˜¯å¦è¿˜æœ‰æœªæ›¿æ¢çš„å˜é‡
const unreplacedVars = findUnreplacedVariables(prompt);
if (unreplacedVars.length > 0) {
  return err("E002", `å­˜åœ¨æœªæ›¿æ¢çš„å˜é‡: ${unreplacedVars.join(", ")}`);
}
```

**æ›¿æ¢å‡½æ•°**ï¼š

```typescript
function replaceVariable(template: string, varName: string, value: string): string {
  const placeholder = "{{" + varName + "}}";
  // ä½¿ç”¨ split + join æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
  return template.split(placeholder).join(value);
}
```

#### æ¨¡æ¿éªŒè¯

PromptManager åœ¨åŠ è½½æ¨¡æ¿æ—¶ä¼šéªŒè¯æ¨¡æ¿ç»“æ„ï¼š

**éªŒè¯è§„åˆ™**ï¼š

1. **å¿…éœ€åŒºå—æ£€æŸ¥**ï¼šç¡®ä¿æ¨¡æ¿åŒ…å«æ‰€æœ‰å¿…éœ€åŒºå—
2. **ä»»åŠ¡åŒºå—æ£€æŸ¥**ï¼šç¡®ä¿æ¨¡æ¿åŒ…å« `<task_instruction>` æˆ– `<task>` ä¸­çš„è‡³å°‘ä¸€ä¸ª
3. **åŒºå—é¡ºåºæ£€æŸ¥**ï¼šç¡®ä¿ `<system_instructions>` åœ¨ `<context_slots>` ä¹‹å‰

**éªŒè¯å‡½æ•°**ï¼š

```typescript
function validateBlockOrder(content: string): { valid: boolean; error?: string; missingBlocks?: string[] } {
  // æ£€æŸ¥æ‰€æœ‰å¿…éœ€åŒºå—æ˜¯å¦å­˜åœ¨
  const missingBlocks: string[] = [];
  for (const block of REQUIRED_BLOCKS) {
    if (!content.includes(block)) {
      missingBlocks.push(block);
    }
  }

  if (missingBlocks.length > 0) {
    return {
      valid: false,
      error: `æ¨¡æ¿ç¼ºå°‘å¿…éœ€åŒºå—: ${missingBlocks.join(", ")}`,
      missingBlocks
    };
  }

  // æ£€æŸ¥ä»»åŠ¡åŒºå—ï¼ˆè‡³å°‘éœ€è¦ä¸€ä¸ªï¼‰
  const hasTaskBlock = TASK_BLOCKS.some(block => content.includes(block));
  if (!hasTaskBlock) {
    return {
      valid: false,
      error: `æ¨¡æ¿ç¼ºå°‘ä»»åŠ¡åŒºå—ï¼Œéœ€è¦ ${TASK_BLOCKS.join(" æˆ– ")} ä¸­çš„è‡³å°‘ä¸€ä¸ª`
    };
  }

  return { valid: true };
}
```

#### æ¨¡æ¿é¢„åŠ è½½

PromptManager åœ¨æ’ä»¶å¯åŠ¨æ—¶é¢„åŠ è½½æ‰€æœ‰æ¨¡æ¿ï¼Œé¿å…è¿è¡Œæ—¶åŠ è½½å»¶è¿Ÿï¼š

```typescript
async preloadAllTemplates(): Promise<Result<void>> {
  const templateIds = [
    "standardizeClassify",
    "enrich",
    "reason-domain",
    "reason-issue",
    "reason-theory",
    "reason-entity",
    "reason-mechanism",
    "ground"
  ];

  const errors: string[] = [];

  for (const templateId of templateIds) {
    const result = await this.preloadTemplate(templateId);
    if (!result.ok) {
      errors.push(`${templateId}: ${result.error.message}`);
    }
  }

  if (errors.length > 0) {
    return err("E002", `${errors.length} ä¸ªæ¨¡æ¿åŠ è½½å¤±è´¥: ${errors.join("; ")}`);
  }

  return ok(undefined);
}
```

**é¢„åŠ è½½ä¼˜åŠ¿**ï¼š

1. **å¿«é€Ÿå“åº”**ï¼šä»»åŠ¡æ‰§è¡Œæ—¶æ— éœ€ç­‰å¾…æ¨¡æ¿åŠ è½½
2. **æ—©æœŸé”™è¯¯æ£€æµ‹**ï¼šæ’ä»¶å¯åŠ¨æ—¶å³å¯å‘ç°æ¨¡æ¿é”™è¯¯
3. **ç¼“å­˜ä¼˜åŒ–**ï¼šæ¨¡æ¿åŠ è½½åç¼“å­˜åœ¨å†…å­˜ä¸­

#### æ¨¡æ¿ç¼“å­˜

PromptManager å°†åŠ è½½çš„æ¨¡æ¿ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼š

```typescript
private templateCache: Map<string, PromptTemplate>;

interface PromptTemplate {
  id: string;
  content: string;
  requiredSlots: string[];
  optionalSlots: string[];
}
```

**ç¼“å­˜ç­–ç•¥**ï¼š

- æ¨¡æ¿åŠ è½½åæ°¸ä¹…ç¼“å­˜ï¼ˆç›´åˆ°æ’ä»¶å¸è½½ï¼‰
- ä¸æ”¯æŒçƒ­é‡è½½ï¼ˆéœ€è¦é‡å¯æ’ä»¶ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/prompt-manager.ts`ï¼šPromptManager å®Œæ•´å®ç°
- `src/types.ts`ï¼šIPromptManager æ¥å£å®šä¹‰

### 5.8 DuplicateManager

**èŒè´£**ï¼šé‡å¤æ£€æµ‹ã€é‡å¤å¯¹ç®¡ç†ã€åˆå¹¶æµç¨‹

DuplicateManager è´Ÿè´£æ£€æµ‹å’Œç®¡ç†é‡å¤æ¦‚å¿µï¼Œæ”¯æŒç›¸ä¼¼åº¦è®¡ç®—ã€é‡å¤å¯¹ç®¡ç†å’Œåˆå¹¶æµç¨‹ã€‚å®ƒç¡®ä¿çŸ¥è¯†åº“ä¸­ä¸å­˜åœ¨é‡å¤æ¦‚å¿µã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `initialize` | `() => Promise<Result<void>>` | åˆå§‹åŒ–é‡å¤ç®¡ç†å™¨ï¼ŒåŠ è½½é‡å¤å¯¹åˆ—è¡¨ |
| `detect` | `(nodeId: string, type: CRType, embedding: number[]) => Promise<Result<DuplicatePair[]>>` | æ£€æµ‹é‡å¤æ¦‚å¿µ |
| `getPendingPairs` | `() => DuplicatePair[]` | è·å–å¾…å¤„ç†çš„é‡å¤å¯¹ |
| `markAsNonDuplicate` | `(pairId: string) => Promise<Result<void>>` | æ ‡è®°ä¸ºéé‡å¤ |
| `startMerge` | `(pairId: string) => Promise<Result<string>>` | å¼€å§‹åˆå¹¶ï¼Œè¿”å›åˆå¹¶ä»»åŠ¡ ID |
| `completeMerge` | `(pairId: string, keepNodeId: string) => Promise<Result<void>>` | å®Œæˆåˆå¹¶ |
| `updateStatus` | `(pairId: string, status: DuplicatePairStatus) => Promise<Result<void>>` | æ›´æ–°é‡å¤å¯¹çŠ¶æ€ |
| `subscribe` | `(listener: (pairs: DuplicatePair[]) => void) => () => void` | è®¢é˜…é‡å¤å¯¹å˜æ›´ |

#### ç›¸ä¼¼åº¦é˜ˆå€¼

DuplicateManager ä½¿ç”¨ç›¸ä¼¼åº¦é˜ˆå€¼åˆ¤æ–­æ¦‚å¿µæ˜¯å¦é‡å¤ï¼š

**é»˜è®¤é˜ˆå€¼**ï¼š0.85ï¼ˆå¯åœ¨è®¾ç½®ä¸­è°ƒæ•´ï¼‰

**é˜ˆå€¼è¯´æ˜**ï¼š

- **>= 0.95**ï¼šæé«˜ç›¸ä¼¼åº¦ï¼Œå‡ ä¹å¯ä»¥ç¡®å®šæ˜¯é‡å¤
- **>= 0.85**ï¼šé«˜ç›¸ä¼¼åº¦ï¼Œéœ€è¦äººå·¥åˆ¤æ–­
- **< 0.85**ï¼šç›¸ä¼¼åº¦è¾ƒä½ï¼Œä¸è§†ä¸ºé‡å¤

**é˜ˆå€¼é…ç½®**ï¼š

```typescript
interface PluginSettings {
  similarityThreshold: number;  // é»˜è®¤ 0.85
  topK: number;                 // é»˜è®¤ 5ï¼ˆæ£€ç´¢å‰ K ä¸ªç›¸ä¼¼æ¦‚å¿µï¼‰
}
```

#### é‡å¤å¯¹çŠ¶æ€æµè½¬

é‡å¤å¯¹åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ä¼šç»å†ä»¥ä¸‹çŠ¶æ€ï¼š

```
pendingï¼ˆå¾…å¤„ç†ï¼‰
    â†“
mergingï¼ˆåˆå¹¶ä¸­ï¼‰/ dismissedï¼ˆå·²å¿½ç•¥ï¼‰
    â†“
mergedï¼ˆå·²åˆå¹¶ï¼‰
```

**çŠ¶æ€è¯´æ˜**ï¼š

- **pending**ï¼šåˆšæ£€æµ‹åˆ°çš„é‡å¤å¯¹ï¼Œç­‰å¾…ç”¨æˆ·å†³ç­–
- **merging**ï¼šç”¨æˆ·é€‰æ‹©åˆå¹¶ï¼Œæ­£åœ¨æ‰§è¡Œåˆå¹¶æµç¨‹
- **merged**ï¼šåˆå¹¶å®Œæˆ
- **dismissed**ï¼šç”¨æˆ·æ ‡è®°ä¸ºéé‡å¤ï¼Œä¸å†æç¤º

#### é‡å¤å¯¹ç»“æ„

```typescript
interface DuplicatePair {
  id: string;                    // é‡å¤å¯¹ IDï¼ˆæ ¼å¼ï¼šnodeA--nodeBï¼‰
  noteA: {
    nodeId: string;
    name: string;
    path: string;
  };
  noteB: {
    nodeId: string;
    name: string;
    path: string;
  };
  type: CRType;                  // æ¦‚å¿µç±»å‹
  similarity: number;            // ç›¸ä¼¼åº¦ï¼ˆ0-1ï¼‰
  detectedAt: string;            // æ£€æµ‹æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
  status: DuplicatePairStatus;   // çŠ¶æ€
}
```

#### é‡å¤æ£€æµ‹æµç¨‹

DuplicateManager æŒ‰ä»¥ä¸‹æ­¥éª¤æ£€æµ‹é‡å¤æ¦‚å¿µï¼š

```
1. è·å–æ¦‚å¿µçš„å‘é‡åµŒå…¥
   â†“
2. åœ¨ VectorIndex ä¸­æœç´¢ç›¸ä¼¼æ¦‚å¿µï¼ˆåŒç±»å‹ï¼‰
   â†“
3. è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
   â†“
4. æ ¹æ®é˜ˆå€¼åˆ¤æ–­æ˜¯å¦é‡å¤
   â†“
5. åˆ›å»ºé‡å¤å¯¹è®°å½•
   â†“
6. æŒä¹…åŒ–é‡å¤å¯¹åˆ—è¡¨
   â†“
7. é€šçŸ¥ UI æ›´æ–°
```

**æ£€æµ‹é€»è¾‘**ï¼š

```typescript
async detect(nodeId: string, type: CRType, embedding: number[]): Promise<Result<DuplicatePair[]>> {
  const threshold = this.settingsStore.getSettings().similarityThreshold;
  const topK = this.settingsStore.getSettings().topK;

  // åœ¨åŒç±»å‹æ¡¶å†…æ£€ç´¢ç›¸ä¼¼æ¦‚å¿µ
  const searchResult = await this.vectorIndex.search(type, embedding, topK);
  if (!searchResult.ok) {
    return searchResult as Result<DuplicatePair[]>;
  }

  const similarConcepts = searchResult.value;

  // è¿‡æ»¤å‡ºç›¸ä¼¼åº¦ >= é˜ˆå€¼çš„æ¦‚å¿µ
  const duplicates = similarConcepts.filter(
    result => result.similarity >= threshold && result.uid !== nodeId
  );

  // åˆ›å»ºé‡å¤å¯¹
  const newPairs: DuplicatePair[] = [];
  for (const duplicate of duplicates) {
    const pairId = this.generatePairId(nodeId, duplicate.uid);
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æˆ–å·²è¢«æ ‡è®°ä¸ºéé‡å¤
    if (this.isDismissed(pairId) || this.pairExists(pairId)) {
      continue;
    }

    const pair: DuplicatePair = {
      id: pairId,
      noteA: { nodeId, name: "...", path: "..." },
      noteB: { nodeId: duplicate.uid, name: duplicate.name, path: duplicate.path },
      type,
      similarity: duplicate.similarity,
      detectedAt: new Date().toISOString(),
      status: "pending"
    };

    newPairs.push(pair);
    this.store.pairs.push(pair);
  }

  // ä¿å­˜å­˜å‚¨
  await this.saveStore();

  // é€šçŸ¥ç›‘å¬å™¨
  this.notifyListeners();

  return ok(newPairs);
}
```

#### é‡å¤å¯¹ ID ç”Ÿæˆ

DuplicateManager ä½¿ç”¨ç¡®å®šæ€§ç®—æ³•ç”Ÿæˆé‡å¤å¯¹ IDï¼Œç¡®ä¿ ID çš„å”¯ä¸€æ€§å’Œä¸€è‡´æ€§ï¼š

```typescript
private generatePairId(nodeIdA: string, nodeIdB: string): string {
  // æŒ‰å­—å…¸åºæ’åºï¼Œç¡®ä¿ ID ä¸€è‡´
  const [first, second] = [nodeIdA, nodeIdB].sort();
  return `${first}--${second}`;
}
```

**ID æ ¼å¼**ï¼š`nodeA--nodeB`ï¼ˆæŒ‰å­—å…¸åºæ’åºï¼‰

**ä¼˜åŠ¿**ï¼š

- æ— è®ºæ£€æµ‹é¡ºåºå¦‚ä½•ï¼ŒåŒä¸€å¯¹æ¦‚å¿µçš„ ID å§‹ç»ˆç›¸åŒ
- é¿å…é‡å¤åˆ›å»ºç›¸åŒçš„é‡å¤å¯¹

#### é‡å¤å¯¹æŒä¹…åŒ–

DuplicateManager å°†é‡å¤å¯¹åˆ—è¡¨æŒä¹…åŒ–åˆ° `data/duplicate-pairs.json`ï¼š

```typescript
interface DuplicatePairsStore {
  version: string;
  pairs: DuplicatePair[];
  dismissedPairs: string[];  // å·²æ ‡è®°ä¸ºéé‡å¤çš„é‡å¤å¯¹ ID åˆ—è¡¨
}
```

**æŒä¹…åŒ–æ—¶æœº**ï¼š

1. **æ£€æµ‹åˆ°æ–°é‡å¤å¯¹å**ï¼šç«‹å³æŒä¹…åŒ–
2. **æ›´æ–°é‡å¤å¯¹çŠ¶æ€å**ï¼šå¦‚æ ‡è®°ä¸ºéé‡å¤ã€å¼€å§‹åˆå¹¶ã€å®Œæˆåˆå¹¶
3. **ç§»é™¤é‡å¤å¯¹å**ï¼šå¦‚åˆå¹¶å®Œæˆååˆ é™¤é‡å¤å¯¹è®°å½•

#### æ ‡è®°ä¸ºéé‡å¤

ç”¨æˆ·å¯ä»¥å°†é‡å¤å¯¹æ ‡è®°ä¸ºéé‡å¤ï¼Œç³»ç»Ÿå°†ä¸å†æç¤ºè¯¥é‡å¤å¯¹ï¼š

```typescript
async markAsNonDuplicate(pairId: string): Promise<Result<void>> {
  const pairIndex = this.store.pairs.findIndex(p => p.id === pairId);
  if (pairIndex === -1) {
    return err("E304", `é‡å¤å¯¹ä¸å­˜åœ¨: ${pairId}`);
  }

  // æ›´æ–°çŠ¶æ€
  this.store.pairs[pairIndex].status = "dismissed";

  // æ·»åŠ åˆ°å·²æ ‡è®°åˆ—è¡¨
  if (!this.store.dismissedPairs.includes(pairId)) {
    this.store.dismissedPairs.push(pairId);
  }

  // ä¿å­˜å­˜å‚¨
  await this.saveStore();

  // é€šçŸ¥ç›‘å¬å™¨
  this.notifyListeners();

  return ok(undefined);
}
```

**å·²æ ‡è®°åˆ—è¡¨**ï¼š

- å­˜å‚¨åœ¨ `dismissedPairs` æ•°ç»„ä¸­
- æ£€æµ‹é‡å¤æ—¶ä¼šè·³è¿‡å·²æ ‡è®°çš„é‡å¤å¯¹
- ç”¨æˆ·å¯ä»¥åœ¨è®¾ç½®ä¸­æ¸…ç©ºå·²æ ‡è®°åˆ—è¡¨

#### åˆå¹¶æµç¨‹

DuplicateManager æ”¯æŒåˆå¹¶é‡å¤æ¦‚å¿µï¼š

**åˆå¹¶æ­¥éª¤**ï¼š

1. **å¼€å§‹åˆå¹¶**ï¼šè°ƒç”¨ `startMerge()`ï¼Œæ›´æ–°çŠ¶æ€ä¸º `merging`
2. **æ‰§è¡Œåˆå¹¶**ï¼šç”± MergeHandler æˆ– PipelineOrchestrator æ‰§è¡Œåˆå¹¶é€»è¾‘
3. **å®Œæˆåˆå¹¶**ï¼šè°ƒç”¨ `completeMerge()`ï¼Œæ›´æ–°çŠ¶æ€ä¸º `merged`

**åˆå¹¶é€»è¾‘**ï¼š

```typescript
async completeMerge(pairId: string, keepNodeId: string): Promise<Result<void>> {
  const pairIndex = this.store.pairs.findIndex(p => p.id === pairId);
  if (pairIndex === -1) {
    return err("E304", `é‡å¤å¯¹ä¸å­˜åœ¨: ${pairId}`);
  }

  const pair = this.store.pairs[pairIndex];

  // ç¡®å®šè¢«åˆ é™¤çš„èŠ‚ç‚¹
  const deleteNodeId = keepNodeId === pair.noteA.nodeId 
    ? pair.noteB.nodeId 
    : pair.noteA.nodeId;

  // æ›´æ–°çŠ¶æ€
  this.store.pairs[pairIndex].status = "merged";

  // ä¿å­˜å­˜å‚¨
  await this.saveStore();

  // é€šçŸ¥ç›‘å¬å™¨
  this.notifyListeners();

  return ok(undefined);
}
```

**æ³¨æ„**ï¼šå®é™…åˆ é™¤è¢«åˆå¹¶ç¬”è®°çš„æ“ä½œç”± TaskRunner æˆ– PipelineOrchestrator æ‰§è¡Œï¼ŒDuplicateManager åªè´Ÿè´£æ›´æ–°çŠ¶æ€ã€‚

#### äº‹ä»¶è®¢é˜…

DuplicateManager æ”¯æŒäº‹ä»¶è®¢é˜…æœºåˆ¶ï¼ŒUI å±‚å¯ä»¥è®¢é˜…é‡å¤å¯¹å˜æ›´å®æ—¶æ›´æ–°ç•Œé¢ï¼š

```typescript
subscribe(listener: (pairs: DuplicatePair[]) => void): () => void {
  this.listeners.push(listener);

  // ç«‹å³è°ƒç”¨ä¸€æ¬¡
  if (this.store) {
    listener(this.store.pairs);
  }

  // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
  return () => {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  };
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/duplicate-manager.ts`ï¼šDuplicateManager å®Œæ•´å®ç°
- `src/types.ts`ï¼šIDuplicateManager æ¥å£å®šä¹‰å’Œ DuplicatePair ç±»å‹å®šä¹‰

### 5.9 PipelineOrchestrator

**èŒè´£**ï¼šç®¡çº¿ç¼–æ’ã€é˜¶æ®µè½¬æ¢ã€ç”¨æˆ·ç¡®è®¤

PipelineOrchestrator æ˜¯æ¦‚å¿µåˆ›å»ºæµç¨‹çš„æ€»æ§åˆ¶å™¨ï¼Œè´Ÿè´£åè°ƒä»»åŠ¡é“¾çš„æ‰§è¡Œï¼ŒåŒ…æ‹¬ç”¨æˆ·ç¡®è®¤æ­¥éª¤ã€‚å®ƒç¡®ä¿ä»»åŠ¡æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œï¼Œå¹¶åœ¨å…³é”®èŠ‚ç‚¹ç­‰å¾…ç”¨æˆ·ç¡®è®¤ã€‚

#### å…³é”®æ–¹æ³•

| æ–¹æ³• | ç­¾å | è¯´æ˜ |
|------|------|------|
| `standardizeDirect` | `(userInput: string) => Promise<Result<StandardizedConcept>>` | ç›´æ¥æ ‡å‡†åŒ–ï¼ˆä¸å…¥é˜Ÿï¼‰ |
| `startCreatePipelineWithStandardized` | `(standardizedData: StandardizedConcept, selectedType: CRType) => Result<string>` | ä½¿ç”¨å·²æ ‡å‡†åŒ–æ•°æ®å¯åŠ¨åˆ›å»ºç®¡çº¿ |
| `confirmCreate` | `(pipelineId: string) => Promise<Result<void>>` | ç¡®è®¤åˆ›å»ºï¼ˆåœ¨ embedding ä¹‹åï¼‰ |
| `confirmWrite` | `(pipelineId: string) => Promise<Result<void>>` | ç¡®è®¤å†™å…¥ï¼ˆåœ¨ reason:new ä¹‹åï¼‰ |
| `buildWritePreview` | `(pipelineId: string) => Promise<Result<{ targetPath: string; newContent: string; previousContent: string }>>` | æ„å»ºå†™å…¥é¢„è§ˆ |
| `updateStandardizedData` | `(pipelineId: string, updates: Partial<StandardizedConcept>) => Result<PipelineContext>` | æ›´æ–°æ ‡å‡†åŒ–ç»“æœ |
| `cancelPipeline` | `(pipelineId: string) => Result<void>` | å–æ¶ˆç®¡çº¿ |
| `getContext` | `(pipelineId: string) => PipelineContext \| undefined` | è·å–ç®¡çº¿ä¸Šä¸‹æ–‡ |
| `getActivePipelines` | `() => PipelineContext[]` | è·å–æ‰€æœ‰æ´»è·ƒç®¡çº¿ |
| `subscribe` | `(listener: PipelineEventListener) => () => void` | è®¢é˜…ç®¡çº¿äº‹ä»¶ |

#### ç®¡çº¿é˜¶æ®µï¼ˆstandardizing â†’ enriching â†’ embedding â†’ reasoning â†’ writingï¼‰

PipelineOrchestrator å°†æ¦‚å¿µåˆ›å»ºæµç¨‹åˆ’åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼š

```
idleï¼ˆç©ºé—²ï¼‰
    â†“
standardizingï¼ˆæ ‡å‡†åŒ–ä¸­ï¼‰
    â†“
enrichingï¼ˆä¸°å¯Œä¸­ï¼‰
    â†“
embeddingï¼ˆåµŒå…¥ä¸­ï¼‰
    â†“
awaiting_create_confirmï¼ˆç­‰å¾…åˆ›å»ºç¡®è®¤ï¼‰
    â†“
reasoningï¼ˆæ¨ç†ä¸­ï¼‰
    â†“
groundingï¼ˆGround æ ¡éªŒä¸­ï¼Œå¯é€‰ï¼‰
    â†“
awaiting_write_confirmï¼ˆç­‰å¾…å†™å…¥ç¡®è®¤ï¼‰
    â†“
writingï¼ˆå†™å…¥ä¸­ï¼‰
    â†“
deduplicatingï¼ˆå»é‡ä¸­ï¼‰
    â†“
completedï¼ˆå®Œæˆï¼‰/ failedï¼ˆå¤±è´¥ï¼‰
```

**é˜¶æ®µè¯´æ˜**ï¼š

- **standardizing**ï¼šè°ƒç”¨ AI æ ‡å‡†åŒ–æ¦‚å¿µï¼Œç”Ÿæˆ UID å’Œæ ‡å‡†åç§°
- **enriching**ï¼šè°ƒç”¨ AI ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾
- **embedding**ï¼šè°ƒç”¨ AI ç”Ÿæˆå‘é‡åµŒå…¥
- **awaiting_create_confirm**ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤åˆ›å»º
- **reasoning**ï¼šè°ƒç”¨ AI ç”Ÿæˆæ¦‚å¿µå†…å®¹
- **grounding**ï¼šè°ƒç”¨ AI è¿›è¡Œäº‹å®æ ¸æŸ¥ï¼ˆå¯é€‰ï¼‰
- **awaiting_write_confirm**ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤å†™å…¥
- **writing**ï¼šå†™å…¥æ–‡ä»¶åˆ°ç£ç›˜
- **deduplicating**ï¼šæ£€æµ‹é‡å¤æ¦‚å¿µ
- **completed**ï¼šç®¡çº¿å®Œæˆ
- **failed**ï¼šç®¡çº¿å¤±è´¥

#### ç®¡çº¿ä¸Šä¸‹æ–‡

PipelineOrchestrator ä¸ºæ¯ä¸ªç®¡çº¿ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ï¼š

```typescript
interface PipelineContext {
  kind: "create" | "incremental" | "merge";  // ç®¡çº¿ç±»å‹
  pipelineId: string;                        // ç®¡çº¿ ID
  nodeId: string;                            // èŠ‚ç‚¹ ID
  type: CRType;                              // çŸ¥è¯†ç±»å‹
  stage: PipelineStage;                      // å½“å‰é˜¶æ®µ
  userInput: string;                         // ç”¨æˆ·è¾“å…¥
  standardizedData?: StandardizedConcept;    // æ ‡å‡†åŒ–ç»“æœ
  enrichedData?: {                           // ä¸°å¯Œç»“æœ
    aliases: string[];
    tags: string[];
  };
  embedding?: number[];                      // åµŒå…¥å‘é‡
  generatedContent?: unknown;                // ç”Ÿæˆçš„å†…å®¹
  filePath?: string;                         // æ–‡ä»¶è·¯å¾„
  snapshotId?: string;                       // å¿«ç…§ ID
  skipSnapshots?: boolean;                   // æ˜¯å¦è·³è¿‡å¿«ç…§
  error?: { code: string; message: string }; // é”™è¯¯ä¿¡æ¯
  createdAt: string;                         // åˆ›å»ºæ—¶é—´
  updatedAt: string;                         // æ›´æ–°æ—¶é—´
}
```

#### ç›´æ¥æ ‡å‡†åŒ–ï¼ˆä¸å…¥é˜Ÿï¼‰

PipelineOrchestrator æä¾› `standardizeDirect()` æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ AI è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¸è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼š

```typescript
async standardizeDirect(userInput: string): Promise<Result<StandardizedConcept>> {
  // å‰ç½®æ ¡éªŒ
  const prerequisiteCheck = this.validatePrerequisites("standardizeClassify");
  if (!prerequisiteCheck.ok) {
    return prerequisiteCheck as Result<StandardizedConcept>;
  }

  // è¾“å…¥éªŒè¯
  if (typeof userInput !== "string" || userInput.trim().length === 0) {
    return err("E001", "è¾“å…¥ä¸èƒ½ä¸ºç©º");
  }

  // æ„å»º prompt
  const promptResult = this.promptManager.build("standardizeClassify", {
    CTX_INPUT: userInput
  });
  if (!promptResult.ok) {
    return err(promptResult.error.code, promptResult.error.message);
  }

  // ç›´æ¥è°ƒç”¨ API
  const chatResult = await this.providerManager.chat({
    providerId: "default",
    model: "gpt-4o",
    messages: [
      { role: "user", content: promptResult.value }
    ]
  });

  if (!chatResult.ok) {
    return err(chatResult.error.code, chatResult.error.message);
  }

  // è§£æå“åº”
  const parsed: StandardizedConcept = JSON.parse(chatResult.value.content);
  return ok(parsed);
}
```

**ä¼˜åŠ¿**ï¼š

- ç«‹å³è¿”å›ç»“æœï¼Œæ— éœ€ç­‰å¾…é˜Ÿåˆ—è°ƒåº¦
- ç”¨æˆ·å¯ä»¥å¿«é€Ÿçœ‹åˆ°æ ‡å‡†åŒ–ç»“æœå¹¶é€‰æ‹©ç±»å‹
- é¿å…é˜Ÿåˆ—é˜»å¡å½±å“ç”¨æˆ·ä½“éªŒ

#### ä½¿ç”¨å·²æ ‡å‡†åŒ–æ•°æ®å¯åŠ¨ç®¡çº¿

ç”¨æˆ·é€‰æ‹©ç±»å‹åï¼ŒPipelineOrchestrator ä½¿ç”¨ `startCreatePipelineWithStandardized()` æ–¹æ³•å¯åŠ¨ç®¡çº¿ï¼š

```typescript
startCreatePipelineWithStandardized(
  standardizedData: StandardizedConcept,
  selectedType: CRType
): Result<string> {
  // å‰ç½®æ ¡éªŒ
  const prerequisiteCheck = this.validatePrerequisites("enrich");
  if (!prerequisiteCheck.ok) {
    return prerequisiteCheck as Result<string>;
  }

  const pipelineId = this.generatePipelineId();
  const nodeId = this.generateNodeId();

  // åˆ›å»ºç®¡çº¿ä¸Šä¸‹æ–‡ï¼Œç›´æ¥è®¾ç½®æ ‡å‡†åŒ–æ•°æ®
  const context: PipelineContext = {
    kind: "create",
    pipelineId,
    nodeId,
    type: selectedType,
    stage: "enriching",  // ç›´æ¥è¿›å…¥ enriching é˜¶æ®µ
    userInput: standardizedData.standardNames[selectedType].chinese,
    skipSnapshots: true,
    standardizedData,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  this.pipelines.set(pipelineId, context);

  // åˆ›å»º enrich ä»»åŠ¡
  const taskResult = this.taskQueue.enqueue({
    nodeId,
    taskType: "enrich",
    state: "Pending",
    attempt: 0,
    maxAttempts: 3,
    providerRef: this.getProviderIdForTask("enrich"),
    payload: {
      pipelineId,
      standardizedData: context.standardizedData,
      conceptType: selectedType,
      userInput: context.userInput
    }
  });

  if (!taskResult.ok) {
    this.pipelines.delete(pipelineId);
    return err("E304", `åˆ›å»ºä»»åŠ¡å¤±è´¥: ${taskResult.error.message}`);
  }

  return ok(pipelineId);
}
```

#### ç¡®è®¤åˆ›å»ºï¼ˆåœ¨ embedding ä¹‹åï¼‰

ç”¨æˆ·åœ¨ embedding é˜¶æ®µå®Œæˆåéœ€è¦ç¡®è®¤åˆ›å»ºï¼š

```typescript
async confirmCreate(pipelineId: string): Promise<Result<void>> {
  const context = this.pipelines.get(pipelineId);
  if (!context) {
    return err("E304", `ç®¡çº¿ä¸å­˜åœ¨: ${pipelineId}`);
  }

  if (context.stage !== "awaiting_create_confirm") {
    return err("E304", `ç®¡çº¿çŠ¶æ€ä¸æ­£ç¡®: ${context.stage}`);
  }

  // 1. ç”Ÿæˆ Stub æ–‡ä»¶ï¼ˆä»…å« frontmatterï¼ŒNoteState: Stubï¼‰
  const stubResult = await this.createStubFile(context);
  if (!stubResult.ok) {
    context.stage = "failed";
    return stubResult as Result<void>;
  }

  // 2. æ›´æ–°é˜¶æ®µä¸º reasoning
  context.stage = "reasoning";

  // 3. åˆ›å»º reason:new ä»»åŠ¡
  const taskResult = this.taskQueue.enqueue({
    nodeId: context.nodeId,
    taskType: "reason:new",
    state: "Pending",
    attempt: 0,
    maxAttempts: 3,
    providerRef: this.getProviderIdForTask("reason:new"),
    payload: {
      pipelineId,
      standardizedData: context.standardizedData,
      conceptType: context.type,
      enrichedData: context.enrichedData,
      embedding: context.embedding,
      filePath: context.filePath,
      skipSnapshot: context.skipSnapshots
    }
  });

  if (!taskResult.ok) {
    context.stage = "failed";
    return err("E304", `åˆ›å»ºä»»åŠ¡å¤±è´¥: ${taskResult.error.message}`);
  }

  return ok(undefined);
}
```

#### ç¡®è®¤å†™å…¥ï¼ˆåœ¨ reason:new ä¹‹åï¼‰

ç”¨æˆ·åœ¨ reason:new é˜¶æ®µå®Œæˆåéœ€è¦ç¡®è®¤å†™å…¥ï¼š

```typescript
async confirmWrite(pipelineId: string): Promise<Result<void>> {
  const context = this.pipelines.get(pipelineId);
  if (!context) {
    return err("E304", `ç®¡çº¿ä¸å­˜åœ¨: ${pipelineId}`);
  }

  if (context.stage !== "awaiting_write_confirm") {
    return err("E304", `ç®¡çº¿çŠ¶æ€ä¸æ­£ç¡®: ${context.stage}`);
  }

  // æ ¹æ®ç®¡çº¿ç±»å‹æ‰§è¡Œä¸åŒçš„å†™å…¥é€»è¾‘
  switch (context.kind) {
    case "create":
      return await this.confirmCreateWrite(context);
    case "incremental":
      return await this.confirmIncrementalWrite(context);
    case "merge":
      return await this.confirmMergeWrite(context);
    default:
      return err("E304", `æœªçŸ¥çš„ç®¡çº¿ç±»å‹: ${context.kind}`);
  }
}
```

#### å‰ç½®æ ¡éªŒ

PipelineOrchestrator åœ¨å¯åŠ¨ç®¡çº¿å‰ä¼šè¿›è¡Œå‰ç½®æ ¡éªŒï¼Œç¡®ä¿ Provider å’Œæ¨¡æ¿å¯ç”¨ï¼š

```typescript
private validatePrerequisites(taskType: TaskType, conceptType?: CRType): Result<void> {
  const settings = this.getSettings();
  
  // 1. æ£€æŸ¥ Provider æ˜¯å¦é…ç½®
  const providerId = this.getProviderIdForTask(taskType);
  if (!providerId) {
    return err("E304", `ä»»åŠ¡ ${taskType} æœªé…ç½® Provider`);
  }

  // æ£€æŸ¥ Provider æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
  const providerConfig = settings.providers[providerId];
  if (!providerConfig || !providerConfig.enabled || !providerConfig.apiKey) {
    return err("E304", `Provider "${providerId}" é…ç½®ä¸å®Œæ•´`);
  }

  // 2. æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å·²åŠ è½½
  if (this.promptManager) {
    const templateId = this.promptManager.resolveTemplateId(taskType, conceptType);
    if (!this.promptManager.hasTemplate(templateId)) {
      return err("E002", `æ¨¡æ¿ "${templateId}" æœªåŠ è½½`);
    }
  }

  return ok(undefined);
}
```

#### äº‹ä»¶è®¢é˜…

PipelineOrchestrator æ”¯æŒäº‹ä»¶è®¢é˜…æœºåˆ¶ï¼ŒUI å±‚å¯ä»¥è®¢é˜…ç®¡çº¿äº‹ä»¶å®æ—¶æ›´æ–°ç•Œé¢ï¼š

**äº‹ä»¶ç±»å‹**ï¼š

```typescript
type PipelineEventType =
  | "stage_changed"          // é˜¶æ®µå˜æ›´
  | "task_completed"         // ä»»åŠ¡å®Œæˆ
  | "task_failed"            // ä»»åŠ¡å¤±è´¥
  | "confirmation_required"  // éœ€è¦ç”¨æˆ·ç¡®è®¤
  | "pipeline_completed"     // ç®¡çº¿å®Œæˆ
  | "pipeline_failed";       // ç®¡çº¿å¤±è´¥
```

**è®¢é˜…ç¤ºä¾‹**ï¼š

```typescript
const unsubscribe = pipelineOrchestrator.subscribe((event) => {
  console.log(`ç®¡çº¿äº‹ä»¶: ${event.type}, é˜¶æ®µ: ${event.stage}`);
  updateUI(event);
});

// å–æ¶ˆè®¢é˜…
unsubscribe();
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/pipeline-orchestrator.ts`ï¼šPipelineOrchestrator å®Œæ•´å®ç°
- `src/types.ts`ï¼šPipelineContextã€PipelineStage ç­‰ç±»å‹å®šä¹‰

---

## 6. UIå±‚è®¾è®¡

### 6.1 WorkbenchPanel

**èŒè´£**ï¼šç»Ÿä¸€å·¥ä½œå°é¢æ¿ï¼Œæä¾›å››åŒºåŸŸå¯æŠ˜å å¸ƒå±€ï¼Œä½œä¸ºç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’çš„ä¸»è¦ç•Œé¢

**æ–‡ä»¶è·¯å¾„**ï¼š`src/ui/workbench-panel.ts`

**ç±»å®šä¹‰**ï¼š
```typescript
export class WorkbenchPanel extends ItemView {
  private conceptInput: HTMLInputElement | null = null;
  private duplicatesContainer: HTMLElement | null = null;
  private queueStatusContainer: HTMLElement | null = null;
  private recentOpsContainer: HTMLElement | null = null;
  private pipelineStatusContainer: HTMLElement | null = null;
  // ... å…¶ä»–ç§æœ‰å­—æ®µ
}
```

#### æ ¸å¿ƒåŠŸèƒ½

WorkbenchPanel æ˜¯ Cognitive Razor çš„ç»Ÿä¸€å·¥ä½œå°ï¼Œå®ç°äº†å››åŒºåŸŸå¯æŠ˜å å¸ƒå±€ï¼Œéµå¾ªè®¾è®¡æ–‡æ¡£ section 8.5.1 çš„è§„èŒƒã€‚å®ƒæ•´åˆäº†æ¦‚å¿µåˆ›å»ºã€é‡å¤ç®¡ç†ã€é˜Ÿåˆ—ç›‘æ§å’Œæ“ä½œå†å²ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ç«™å¼çš„çŸ¥è¯†ç®¡ç†ç•Œé¢ã€‚

**å››åŒºåŸŸå¸ƒå±€**ï¼š

1. **åˆ›å»ºæ¦‚å¿µåŒºåŸŸï¼ˆCreate Concept Sectionï¼‰**
   - ç°ä»£åŒ–æœç´¢æ è®¾è®¡ï¼ˆGoogle/Bing é£æ ¼ï¼‰
   - æœç´¢å›¾æ ‡ + è¾“å…¥æ¡† + æ“ä½œæŒ‰é’®
   - æ”¯æŒ Enter é”®å¿«æ·æäº¤
   - æ ‡å‡†åŒ–ç»“æœå±•ç¤º
   - ç±»å‹ç½®ä¿¡åº¦è¡¨æ ¼ï¼ˆå¯é€‰æ‹©æ¦‚å¿µç±»å‹ï¼‰

2. **é‡å¤æ¦‚å¿µåŒºåŸŸï¼ˆDuplicates Sectionï¼‰**
   - é‡å¤å¯¹åˆ—è¡¨å±•ç¤º
   - æ’åºå’Œç­›é€‰æ§åˆ¶
   - æ‰¹é‡æ“ä½œæŒ‰é’®ï¼ˆå…¨é€‰ã€æ‰¹é‡åˆå¹¶ã€æ‰¹é‡å¿½ç•¥ï¼‰
   - æŸ¥çœ‹åˆå¹¶å†å²
   - å®æ—¶æ›´æ–°é‡å¤å¯¹æ•°é‡å¾½ç« 

3. **é˜Ÿåˆ—çŠ¶æ€åŒºåŸŸï¼ˆQueue Status Sectionï¼‰**
   - å®æ—¶æ˜¾ç¤ºä»»åŠ¡é˜Ÿåˆ—ç»Ÿè®¡ï¼ˆå¾…å¤„ç†ã€è¿è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥ï¼‰
   - ç®¡çº¿çŠ¶æ€å±•ç¤º
   - å¿«æ·æ“ä½œæŒ‰é’®ï¼ˆæš‚åœ/æ¢å¤é˜Ÿåˆ—ï¼‰

4. **æœ€è¿‘æ“ä½œåŒºåŸŸï¼ˆRecent Operations Sectionï¼‰**
   - æ˜¾ç¤ºæœ€è¿‘çš„æ“ä½œå†å²
   - æ”¯æŒæ’¤é”€æ“ä½œ
   - å¿«ç…§ç®¡ç†ï¼ˆåˆ·æ–°ã€æ¸…ç©ºå…¨éƒ¨ï¼‰

#### å…³é”®æ–¹æ³•

**1. renderCreateConceptSection(container: HTMLElement): void**

æ¸²æŸ“åˆ›å»ºæ¦‚å¿µåŒºåŸŸï¼Œä½¿ç”¨ç°ä»£åŒ–æœç´¢æ è®¾è®¡ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºæœç´¢å›¾æ ‡ã€è¾“å…¥æ¡†å’Œæ“ä½œæŒ‰é’®
- ç»‘å®š Enter é”®å’ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
- åˆ›å»ºæ ‡å‡†åŒ–ç»“æœå®¹å™¨å’Œç±»å‹ç½®ä¿¡åº¦è¡¨æ ¼å®¹å™¨

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œåˆ›å»ºæ¦‚å¿µåŒºåŸŸæ¸²æŸ“

---

**2. renderDuplicatesSection(container: HTMLElement): void**

æ¸²æŸ“é‡å¤æ¦‚å¿µé¢æ¿ï¼Œæä¾›é‡å¤å¯¹ç®¡ç†åŠŸèƒ½ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºå¯æŠ˜å æ ‡é¢˜ï¼ˆå¸¦æ•°é‡å¾½ç« ï¼‰
- åˆ›å»ºæ’åºå’Œç­›é€‰æ§åˆ¶
- åˆ›å»ºæ‰¹é‡æ“ä½œæŒ‰é’®
- åˆ›å»ºé‡å¤å¯¹åˆ—è¡¨å®¹å™¨

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œé‡å¤æ¦‚å¿µåŒºåŸŸæ¸²æŸ“

---

**3. renderQueueStatusSection(container: HTMLElement): void**

æ¸²æŸ“é˜Ÿåˆ—çŠ¶æ€åŒºåŸŸï¼Œå®æ—¶æ˜¾ç¤ºä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºå¯æŠ˜å æ ‡é¢˜
- åˆ›å»ºé˜Ÿåˆ—çŠ¶æ€å®¹å™¨ï¼ˆæ˜¾ç¤ºç»Ÿè®¡æ•°æ®ï¼‰
- åˆ›å»ºç®¡çº¿çŠ¶æ€å®¹å™¨ï¼ˆæ˜¾ç¤ºå½“å‰ç®¡çº¿ï¼‰
- è®¾ç½® aria-live å±æ€§ä»¥æ”¯æŒæ— éšœç¢è®¿é—®

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œé˜Ÿåˆ—çŠ¶æ€åŒºåŸŸæ¸²æŸ“

---

**4. renderRecentOpsSection(container: HTMLElement): void**

æ¸²æŸ“æœ€è¿‘æ“ä½œåŒºåŸŸï¼Œæä¾›æ“ä½œå†å²å’Œæ’¤é”€åŠŸèƒ½ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºå¯æŠ˜å æ ‡é¢˜
- åˆ›å»ºå·¥å…·æ ï¼ˆåˆ·æ–°ã€æ¸…ç©ºå…¨éƒ¨æŒ‰é’®ï¼‰
- åˆ›å»ºæ“ä½œåˆ—è¡¨å®¹å™¨
- è°ƒç”¨ refreshRecentOps() åŠ è½½æ“ä½œå†å²

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œæœ€è¿‘æ“ä½œåŒºåŸŸæ¸²æŸ“

---

**5. handleStandardize(descriptionOverride?: string): Promise<void>**

å¤„ç†æ¦‚å¿µæ ‡å‡†åŒ–æµç¨‹ï¼Œç›´æ¥è°ƒç”¨ API è€Œä¸è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚

**åŠŸèƒ½**ï¼š
- éªŒè¯ç”¨æˆ·è¾“å…¥
- ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- è°ƒç”¨ PipelineOrchestrator.standardizeDirect() è¿›è¡Œæ ‡å‡†åŒ–
- ä¿å­˜æ ‡å‡†åŒ–ç»“æœ
- æ¸²æŸ“ç±»å‹ç½®ä¿¡åº¦è¡¨æ ¼
- é‡ç½®æŒ‰é’®çŠ¶æ€

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œæ ‡å‡†åŒ–æµç¨‹å¤„ç†

---

**6. renderTypeConfidenceTable(standardizedData: StandardizedConcept): void**

æ¸²æŸ“ç±»å‹ç½®ä¿¡åº¦è¡¨æ ¼ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ¦‚å¿µç±»å‹ã€‚

**åŠŸèƒ½**ï¼š
- æ¸…ç©ºå®¹å™¨å¹¶æ˜¾ç¤ºè¡¨æ ¼
- åˆ›å»ºè¡¨æ ¼æ ‡é¢˜å’Œè¯´æ˜
- æŒ‰ç½®ä¿¡åº¦é™åºæ’åˆ—ç±»å‹
- ä¸ºæ¯ç§ç±»å‹åˆ›å»ºä¸€è¡Œï¼ŒåŒ…å«ï¼š
  - ç±»å‹åç§°
  - æ ‡å‡†åç§°ï¼ˆä¸­æ–‡ + è‹±æ–‡ï¼‰
  - ç½®ä¿¡åº¦æ¡å’Œç™¾åˆ†æ¯”
  - åˆ›å»ºæŒ‰é’®
- ç»‘å®šåˆ›å»ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œåˆ›å»ºæŒ‰é’®äº‹ä»¶å¤„ç†

---

**7. handleCreateConcept(selectedType: CRType, standardizedData: StandardizedConcept): Promise<void>**

å¤„ç†åˆ›å»ºæ¦‚å¿µæ“ä½œï¼Œä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ç±»å‹å¯åŠ¨åˆ›å»ºç®¡çº¿ã€‚

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ PipelineOrchestrator.startCreatePipelineWithStandardized()
- ä¿å­˜ç®¡çº¿ ID
- æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
- éšè—ç±»å‹ç½®ä¿¡åº¦è¡¨æ ¼
- é‡ç½®è¾“å…¥æ¡†

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œç±»å‹é€‰æ‹©å¤„ç†

---

**8. updateQueueStatus(status: QueueStatus): void**

æ›´æ–°é˜Ÿåˆ—çŠ¶æ€æ˜¾ç¤ºã€‚

**åŠŸèƒ½**ï¼š
- æ›´æ–°é˜Ÿåˆ—ç»Ÿè®¡æ•°æ®ï¼ˆå¾…å¤„ç†ã€è¿è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥ï¼‰
- æ›´æ–°æš‚åœ/æ¢å¤æŒ‰é’®çŠ¶æ€
- é€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶è‡ªåŠ¨è°ƒç”¨

**å‚è€ƒä»£ç **ï¼šé€šè¿‡ TaskQueue çš„äº‹ä»¶è®¢é˜…æœºåˆ¶è§¦å‘

---

**9. startQuickCreate(description: string): Promise<void>**

ä»å‘½ä»¤å…¥å£å¿«é€Ÿåˆ›å»ºæ¦‚å¿µï¼Œå¤ç”¨æ ‡å‡†åŒ– â†’ é€‰æ‹©ç±»å‹æµç¨‹ã€‚

**åŠŸèƒ½**ï¼š
- éªŒè¯è¾“å…¥
- è®¾ç½®å¾…å¤„ç†è¾“å…¥ï¼ˆå¦‚æœè§†å›¾æœªæ¸²æŸ“ï¼‰
- å¦‚æœè§†å›¾å·²æ¸²æŸ“ï¼Œç›´æ¥è§¦å‘æ ‡å‡†åŒ–æµç¨‹

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼Œå¿«é€Ÿåˆ›å»ºæµç¨‹

---

**10. createCollapsibleHeader(section: HTMLElement, title: string, sectionKey: keyof SectionCollapseState, showBadge?: boolean): HTMLElement**

åˆ›å»ºå¯æŠ˜å æ ‡é¢˜ï¼Œæ”¯æŒé”®ç›˜è®¿é—®å’Œæ— éšœç¢åŠŸèƒ½ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºæ ‡é¢˜å®¹å™¨
- æ·»åŠ æŠ˜å å›¾æ ‡ï¼ˆâ–¶/â–¼ï¼‰
- æ·»åŠ æ ‡é¢˜æ–‡æœ¬
- å¯é€‰æ·»åŠ å¾½ç« ï¼ˆæ˜¾ç¤ºæ•°é‡ï¼‰
- ç»‘å®šç‚¹å‡»å’Œé”®ç›˜äº‹ä»¶
- è®¾ç½® ARIA å±æ€§

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼ŒUI æ›´æ–°æ–¹æ³•

---

**11. toggleSection(sectionKey: keyof SectionCollapseState, icon: HTMLElement): void**

åˆ‡æ¢åŒºåŸŸæŠ˜å çŠ¶æ€ã€‚

**åŠŸèƒ½**ï¼š
- åˆ‡æ¢æŠ˜å çŠ¶æ€
- æ›´æ–°æŠ˜å å›¾æ ‡
- æ·»åŠ /ç§»é™¤ cr-collapsed æ ·å¼ç±»

**å‚è€ƒä»£ç **ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®ç°ï¼ŒåŒºåŸŸæŠ˜å /å±•å¼€é€»è¾‘

#### ä¾èµ–å…³ç³»

WorkbenchPanel ä¾èµ–ä»¥ä¸‹ç»„ä»¶ï¼š

- **PipelineOrchestrator**ï¼šå¯åŠ¨æ¦‚å¿µåˆ›å»ºç®¡çº¿ã€æ ‡å‡†åŒ–æµç¨‹
- **TaskQueue**ï¼šæŸ¥è¯¢é˜Ÿåˆ—çŠ¶æ€ã€è®¢é˜…é˜Ÿåˆ—äº‹ä»¶
- **DuplicateManager**ï¼šè·å–é‡å¤å¯¹åˆ—è¡¨ã€è®¢é˜…é‡å¤å¯¹äº‹ä»¶
- **UndoManager**ï¼šè·å–å¿«ç…§åˆ—è¡¨ã€æ‰§è¡Œæ’¤é”€æ“ä½œ
- **PipelineOrchestrator**ï¼šå¯åŠ¨æ¦‚å¿µåˆ›å»ºæµç¨‹ã€ç®¡çº¿çŠ¶æ€ç®¡ç†

**ä¾èµ–æ³¨å…¥æ–¹å¼**ï¼š

```typescript
// é€šè¿‡ setPlugin() æ–¹æ³•æ³¨å…¥æ’ä»¶å¼•ç”¨
workbenchPanel.setPlugin(plugin);

// é€šè¿‡ plugin.getComponents() è®¿é—®æ‰€æœ‰ç»„ä»¶
const components = this.plugin.getComponents();
const po = components.pipelineOrchestrator;
const taskQueue = components.taskQueue;
// ...
```

#### äº‹ä»¶è®¢é˜…

WorkbenchPanel é€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶ç›‘å¬åº”ç”¨å±‚äº‹ä»¶ï¼Œå®ç° UI çš„å®æ—¶æ›´æ–°ï¼š

**1. é˜Ÿåˆ—äº‹ä»¶è®¢é˜…**

```typescript
this.plugin.registerEvent(
  taskQueue.on('status-changed', (status) => {
    this.updateQueueStatus(status);
  })
);
```

**2. ç®¡çº¿äº‹ä»¶è®¢é˜…**

```typescript
this.pipelineUnsubscribe = pipelineOrchestrator.subscribe((event) => {
  this.handlePipelineEvent(event);
});
```

**3. é‡å¤å¯¹äº‹ä»¶è®¢é˜…**

```typescript
this.plugin.registerEvent(
  duplicateManager.on('pairs-updated', () => {
    this.refreshDuplicates();
  })
);
```

#### çŠ¶æ€ç®¡ç†

WorkbenchPanel ç»´æŠ¤ä»¥ä¸‹å†…éƒ¨çŠ¶æ€ï¼š

**1. æŠ˜å çŠ¶æ€**

```typescript
private collapseState: SectionCollapseState = {
  createConcept: false,  // é»˜è®¤å±•å¼€
  duplicates: false,     // é»˜è®¤å±•å¼€
  queueStatus: false,    // é»˜è®¤å±•å¼€
  recentOps: false,      // é»˜è®¤å±•å¼€
};
```

**2. æ ‡å‡†åŒ–çŠ¶æ€**

```typescript
private currentStandardizedData: StandardizedConcept | null = null;
private currentPipelineId: string | null = null;
private pendingConceptInput: string | null = null;
```

**3. é‡å¤å¯¹ç®¡ç†çŠ¶æ€**

```typescript
private selectedDuplicates: Set<string> = new Set();
private currentSortOrder: DuplicateSortOrder = "similarity-desc";
private currentTypeFilter: CRType | "all" = "all";
private allDuplicates: DuplicatePair[] = [];
```

#### æ— éšœç¢æ”¯æŒ

WorkbenchPanel éµå¾ª WCAG 2.1 AA æ ‡å‡†ï¼Œæä¾›å®Œæ•´çš„æ— éšœç¢æ”¯æŒï¼š

**1. ARIA å±æ€§**

- å¯æŠ˜å æ ‡é¢˜ä½¿ç”¨ `role="button"` å’Œ `aria-expanded`
- åŠ¨æ€æ›´æ–°åŒºåŸŸä½¿ç”¨ `aria-live="polite"`
- æ‰€æœ‰äº¤äº’å…ƒç´ éƒ½æœ‰ `aria-label`

**2. é”®ç›˜å¯¼èˆª**

- å¯æŠ˜å æ ‡é¢˜æ”¯æŒ Enter å’Œ Space é”®åˆ‡æ¢
- è¾“å…¥æ¡†æ”¯æŒ Enter é”®æäº¤
- æ‰€æœ‰æŒ‰é’®éƒ½å¯é€šè¿‡ Tab é”®èšç„¦

**3. è¯­ä¹‰åŒ– HTML**

- ä½¿ç”¨æ­£ç¡®çš„æ ‡é¢˜å±‚çº§ï¼ˆh3, h4ï¼‰
- ä½¿ç”¨ `<button>` è€Œé `<div>` å®ç°æŒ‰é’®
- ä½¿ç”¨ `<table>` å±•ç¤ºè¡¨æ ¼æ•°æ®

#### æ€§èƒ½ä¼˜åŒ–

**1. æ‡’åŠ è½½**

- é‡å¤å¯¹åˆ—è¡¨ä»…åœ¨åŒºåŸŸå±•å¼€æ—¶åŠ è½½
- æ“ä½œå†å²ä»…åœ¨åŒºåŸŸå±•å¼€æ—¶åŠ è½½

**2. é˜²æŠ–å’ŒèŠ‚æµ**

- æœç´¢è¾“å…¥ä½¿ç”¨é˜²æŠ–ï¼ˆ300msï¼‰
- é˜Ÿåˆ—çŠ¶æ€æ›´æ–°ä½¿ç”¨èŠ‚æµï¼ˆ100msï¼‰

**3. è™šæ‹Ÿæ»šåŠ¨**

- é‡å¤å¯¹åˆ—è¡¨è¶…è¿‡ 100 é¡¹æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
- æ“ä½œå†å²åˆ—è¡¨è¶…è¿‡ 50 é¡¹æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨

#### æ ·å¼è§„èŒƒ

WorkbenchPanel ä½¿ç”¨ BEM å‘½åè§„èŒƒå’Œ CSS å˜é‡ï¼š

**CSS ç±»å‘½å**ï¼š

- `.cr-workbench-panel`ï¼šé¢æ¿æ ¹å®¹å™¨
- `.cr-section`ï¼šåŒºåŸŸå®¹å™¨
- `.cr-section-header`ï¼šåŒºåŸŸæ ‡é¢˜
- `.cr-section-content`ï¼šåŒºåŸŸå†…å®¹
- `.cr-collapsed`ï¼šæŠ˜å çŠ¶æ€
- `.cr-modern-search-container`ï¼šç°ä»£åŒ–æœç´¢æ 
- `.cr-confidence-table`ï¼šç½®ä¿¡åº¦è¡¨æ ¼

**CSS å˜é‡**ï¼š

- `--cr-primary-color`ï¼šä¸»è‰²è°ƒ
- `--cr-background-color`ï¼šèƒŒæ™¯è‰²
- `--cr-border-color`ï¼šè¾¹æ¡†è‰²
- `--cr-text-color`ï¼šæ–‡æœ¬è‰²

**å‚è€ƒæ–‡ä»¶**ï¼š`styles.css` ä¸­çš„ `.cr-workbench-panel` ç›¸å…³æ ·å¼

#### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼š

- æµ‹è¯•ç»„ä»¶åˆå§‹åŒ–
- æµ‹è¯•åŒºåŸŸæŠ˜å /å±•å¼€
- æµ‹è¯•è¾“å…¥éªŒè¯
- æµ‹è¯•äº‹ä»¶å¤„ç†

**é›†æˆæµ‹è¯•**ï¼š

- æµ‹è¯•ä¸ PipelineOrchestrator çš„äº¤äº’
- æµ‹è¯•ä¸ TaskQueue çš„äº¤äº’
- æµ‹è¯•ä¸ DuplicateManager çš„äº¤äº’

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/workbench-panel.test.ts`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

---

**éœ€æ±‚éªŒè¯**ï¼š
- âœ… éœ€æ±‚ 3.3ï¼šUI å±‚ç»„ä»¶èŒè´£æè¿°
- âœ… éœ€æ±‚ 3.4ï¼šå…³é”®æ–¹æ³•åˆ—å‡º
- âœ… éœ€æ±‚ 1.3ï¼šç»„ä»¶åç§°ã€èŒè´£æè¿°ã€ä¾èµ–å…³ç³»ã€å…³é”®æ–¹æ³•

### 6.2 StatusBadge

**èŒè´£**ï¼šçŠ¶æ€æ å¾½ç« ç»„ä»¶ï¼Œæä¾›é˜Ÿåˆ—çŠ¶æ€çš„å®æ—¶æ˜¾ç¤ºå’Œå¿«æ·èœå•å…¥å£

**æ–‡ä»¶è·¯å¾„**ï¼š`src/ui/status-badge.ts`

**ç±»å®šä¹‰**ï¼š
```typescript
export class StatusBadge {
  private plugin: Plugin;
  private statusBarItem: HTMLElement;
  private queueStatus: QueueStatus;
  private isOffline: boolean = false;
}
```

#### æ ¸å¿ƒåŠŸèƒ½

StatusBadge æ˜¯ Obsidian çŠ¶æ€æ ä¸­çš„å¾½ç« ç»„ä»¶ï¼Œä¸ºç”¨æˆ·æä¾›ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€çš„å®æ—¶åé¦ˆã€‚å®ƒéµå¾ªè®¾è®¡æ–‡æ¡£ Requirements 5.5 çš„çŠ¶æ€æ ¼å¼è§„èŒƒï¼Œä½¿ç”¨ç®€æ´çš„å›¾æ ‡å’Œæ–‡æœ¬å±•ç¤ºé˜Ÿåˆ—çŠ¶æ€ï¼Œå¹¶æä¾›å¿«æ·èœå•è®¿é—®å¸¸ç”¨åŠŸèƒ½ã€‚

**çŠ¶æ€æ ¼å¼æ˜¾ç¤ºè§„èŒƒ**ï¼ˆRequirements 5.5ï¼‰ï¼š

- **æ­£å¸¸**ï¼š`[CR: running/pending â³]` ä¾‹å¦‚ `[CR: 1/3 â³]`
- **æš‚åœ**ï¼š`[CR: â¸ï¸ n]` ä¾‹å¦‚ `[CR: â¸ï¸ 3]`
- **æœ‰å¤±è´¥**ï¼š`[CR: running/pending âš ï¸failed]` ä¾‹å¦‚ `[CR: 1/3 âš ï¸1]`
- **ç¦»çº¿**ï¼š`[CR: ğŸ“´]`
- **ç©ºé—²**ï¼š`[CR: âœ“]`

#### å…³é”®æ–¹æ³•

**1. updateStatus(status: QueueStatus): void**

æ›´æ–°é˜Ÿåˆ—çŠ¶æ€æ˜¾ç¤ºã€‚

**åŠŸèƒ½**ï¼š
- æ¥æ”¶é˜Ÿåˆ—çŠ¶æ€å¯¹è±¡ï¼ˆåŒ…å« pendingã€runningã€completedã€failedã€paused å­—æ®µï¼‰
- è°ƒç”¨ formatStatusBadgeText() ç”Ÿæˆç¬¦åˆè§„èŒƒçš„çŠ¶æ€æ–‡æœ¬
- æ›´æ–°çŠ¶æ€æ ·å¼ç±»ï¼ˆidleã€activeã€pausedã€failedã€offlineï¼‰
- æ›´æ–°å·¥å…·æç¤ºæ–‡æœ¬
- æ›´æ–° ARIA æ ‡ç­¾ä»¥æ”¯æŒæ— éšœç¢è®¿é—®

**å‚æ•°**ï¼š
```typescript
interface QueueStatus {
  paused: boolean;
  pending: number;
  running: number;
  completed: number;
  failed: number;
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œæ„é€ å‡½æ•°å’Œåˆå§‹åŒ–

---

**2. setOffline(offline: boolean): void**

è®¾ç½®ç¦»çº¿çŠ¶æ€ã€‚

**åŠŸèƒ½**ï¼š
- è®¾ç½® isOffline æ ‡å¿—
- é‡æ–°æ¸²æŸ“å¾½ç« ï¼Œæ˜¾ç¤ºç¦»çº¿å›¾æ ‡ï¼ˆğŸ“´ï¼‰
- æ›´æ–°æ ·å¼ç±»ä¸º cr-status-offline
- æ›´æ–°å·¥å…·æç¤ºä¸º"ç¦»çº¿"

**ä½¿ç”¨åœºæ™¯**ï¼š
- Provider è¿æ¥å¤±è´¥æ—¶
- ç½‘ç»œæ–­å¼€æ—¶
- API å¯†é’¥æ— æ•ˆæ—¶

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œç¦»çº¿çŠ¶æ€å¤„ç†

---

**3. render(): void**

æ¸²æŸ“çŠ¶æ€å¾½ç« ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ¸…ç©ºçŠ¶æ€æ å…ƒç´ 
- è°ƒç”¨ formatStatusBadgeText() ç”ŸæˆçŠ¶æ€æ–‡æœ¬
- åˆ›å»ºæ–‡æœ¬å…ƒç´ å¹¶è®¾ç½® ARIA æ ‡ç­¾
- è°ƒç”¨ updateStatusClasses() æ›´æ–°æ ·å¼ç±»
- è®¾ç½®å·¥å…·æç¤º

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œå·¥å…·æç¤ºç”Ÿæˆ

---

**4. updateStatusClasses(): void**

æ›´æ–°çŠ¶æ€æ ·å¼ç±»ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
- æ ¹æ®å½“å‰çŠ¶æ€æ·»åŠ å¯¹åº”çš„æ ·å¼ç±»ï¼š
  - `cr-status-offline`ï¼šç¦»çº¿çŠ¶æ€
  - `cr-status-idle`ï¼šç©ºé—²çŠ¶æ€ï¼ˆæ— æ´»åŠ¨ä»»åŠ¡ä¸”æ— å¤±è´¥ï¼‰
  - `cr-status-paused`ï¼šæš‚åœçŠ¶æ€ï¼ˆæœ‰å¾…å¤„ç†ä»»åŠ¡ä½†é˜Ÿåˆ—å·²æš‚åœï¼‰
  - `cr-status-failed`ï¼šå¤±è´¥çŠ¶æ€ï¼ˆæœ‰å¤±è´¥ä»»åŠ¡ï¼‰
  - `cr-status-active`ï¼šæ´»åŠ¨çŠ¶æ€ï¼ˆæœ‰è¿è¡Œä¸­æˆ–å¾…å¤„ç†ä»»åŠ¡ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œæ ·å¼ç±»ç®¡ç†

---

**5. showMenu(event: MouseEvent): void**

æ˜¾ç¤ºå¿«æ·èœå•ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º Obsidian Menu å¯¹è±¡
- æ·»åŠ èœå•é¡¹ï¼š
  - æ‰“å¼€å·¥ä½œå°
  - æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—
  - åˆ›å»ºæ¦‚å¿µ
  - æš‚åœ/æ¢å¤é˜Ÿåˆ—
  - é‡è¯•å¤±è´¥ä»»åŠ¡ï¼ˆä»…åœ¨æœ‰å¤±è´¥ä»»åŠ¡æ—¶æ˜¾ç¤ºï¼‰
  - æ’ä»¶è®¾ç½®
- åœ¨é¼ æ ‡ä½ç½®æ˜¾ç¤ºèœå•

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œå³é”®èœå•æ˜¾ç¤º

---

**6. getStatusText(): string**

è·å–å½“å‰çŠ¶æ€æ–‡æœ¬ï¼ˆç”¨äºæµ‹è¯•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ formatStatusBadgeText() ç”ŸæˆçŠ¶æ€æ–‡æœ¬
- è¿”å›æ–‡æœ¬å­—ç¬¦ä¸²

**ç”¨é€”**ï¼š
- å•å…ƒæµ‹è¯•éªŒè¯çŠ¶æ€æ–‡æœ¬æ ¼å¼
- è°ƒè¯•çŠ¶æ€æ˜¾ç¤ºé€»è¾‘

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œè°ƒè¯•ä¿¡æ¯æ˜¾ç¤º

---

**7. getAriaLabel(): string**

è·å–æ— éšœç¢æ ‡ç­¾ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ ¹æ®å½“å‰çŠ¶æ€ç”Ÿæˆæè¿°æ€§æ–‡æœ¬
- åŒ…å«é˜Ÿåˆ—çŠ¶æ€çš„è¯¦ç»†ä¿¡æ¯
- ä¾‹å¦‚ï¼š"Cognitive Razor - 1 ä¸ªä»»åŠ¡æ‰§è¡Œä¸­, 3 ä¸ªä»»åŠ¡ç­‰å¾…ä¸­, 1 ä¸ªä»»åŠ¡å¤±è´¥"

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼ŒçŠ¶æ€æ–‡æœ¬ç”Ÿæˆ

---

**8. getTooltip(): string**

è·å–å·¥å…·æç¤ºæ–‡æœ¬ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- ç”Ÿæˆå¤šè¡Œå·¥å…·æç¤ºæ–‡æœ¬
- åŒ…å«ï¼š
  - æ’ä»¶åç§°
  - çŠ¶æ€ï¼ˆè¿è¡Œä¸­/å·²æš‚åœ/ç¦»çº¿ï¼‰
  - å„ç±»ä»»åŠ¡æ•°é‡ç»Ÿè®¡
  - æ“ä½œæç¤ºï¼ˆ"ç‚¹å‡»æŸ¥çœ‹èœå•"ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œå·¥å…·æç¤ºå†…å®¹æ„å»º

---

**9. setupClickHandler(): void**

è®¾ç½®ç‚¹å‡»å¤„ç†å™¨ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- ç»‘å®šé¼ æ ‡ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºå¿«æ·èœå•
- ç»‘å®šé”®ç›˜äº‹ä»¶ï¼ˆEnter å’Œ Space é”®ï¼‰ï¼Œæ”¯æŒé”®ç›˜è®¿é—®
- è®¾ç½® ARIA å±æ€§ï¼ˆrole="button", tabindex="0"ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œæ— éšœç¢å±æ€§è®¾ç½®

---

**10. destroy(): void**

æ¸…ç†èµ„æºã€‚

**åŠŸèƒ½**ï¼š
- ä»çŠ¶æ€æ ç§»é™¤å¾½ç« å…ƒç´ 
- åœ¨æ’ä»¶å¸è½½æ—¶è°ƒç”¨

**å‚è€ƒä»£ç **ï¼š
- `src/ui/status-badge.ts`ï¼šStatusBadge å®ç°ï¼Œ`destroy()` æ–¹æ³•

#### ä¾èµ–å…³ç³»

StatusBadge ä¾èµ–ä»¥ä¸‹ç»„ä»¶ï¼š

- **Plugin**ï¼šObsidian æ’ä»¶å®ä¾‹ï¼Œç”¨äºæ·»åŠ çŠ¶æ€æ é¡¹å’Œè§¦å‘å‘½ä»¤
- **TaskQueue**ï¼šé€šè¿‡äº‹ä»¶è®¢é˜…è·å–é˜Ÿåˆ—çŠ¶æ€æ›´æ–°

**ä¾èµ–æ³¨å…¥æ–¹å¼**ï¼š

```typescript
// åœ¨ main.ts ä¸­åˆå§‹åŒ–
const statusBadge = new StatusBadge(this);

// è®¢é˜…é˜Ÿåˆ—äº‹ä»¶
this.registerEvent(
  taskQueue.on('status-changed', (status) => {
    statusBadge.updateStatus(status);
  })
);
```

#### çŠ¶æ€æ ¼å¼åŒ–

StatusBadge ä½¿ç”¨ç‹¬ç«‹çš„æ ¼å¼åŒ–å‡½æ•°ç”ŸæˆçŠ¶æ€æ–‡æœ¬ï¼Œç¡®ä¿æ ¼å¼ä¸€è‡´æ€§ï¼š

**formatStatusBadgeText(status: QueueStatus, isOffline: boolean): string**

**å®ç°é€»è¾‘**ï¼š

```typescript
// ç¦»çº¿çŠ¶æ€
if (isOffline) {
  return "[CR: ğŸ“´]";
}

const { running, pending, failed, paused } = status;
const activeCount = running + pending;

// ç©ºé—²çŠ¶æ€
if (activeCount === 0 && failed === 0) {
  return "[CR: âœ“]";
}

// æš‚åœçŠ¶æ€
if (paused && activeCount > 0) {
  return `[CR: â¸ï¸ ${activeCount}]`;
}

// æœ‰å¤±è´¥ä»»åŠ¡
if (failed > 0) {
  return `[CR: ${running}/${pending} âš ï¸${failed}]`;
}

// æ­£å¸¸è¿è¡Œ
return `[CR: ${running}/${pending} â³]`;
```

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/status-badge-format.ts`

#### æ ·å¼è§„èŒƒ

StatusBadge ä½¿ç”¨ä»¥ä¸‹ CSS ç±»å’Œæ ·å¼ï¼š

**CSS ç±»**ï¼š

- `.cr-status-badge`ï¼šå¾½ç« æ ¹å®¹å™¨
- `.cr-status-text`ï¼šçŠ¶æ€æ–‡æœ¬
- `.cr-status-idle`ï¼šç©ºé—²çŠ¶æ€æ ·å¼ï¼ˆç»¿è‰²ï¼‰
- `.cr-status-active`ï¼šæ´»åŠ¨çŠ¶æ€æ ·å¼ï¼ˆè“è‰²ï¼‰
- `.cr-status-paused`ï¼šæš‚åœçŠ¶æ€æ ·å¼ï¼ˆé»„è‰²ï¼‰
- `.cr-status-failed`ï¼šå¤±è´¥çŠ¶æ€æ ·å¼ï¼ˆçº¢è‰²ï¼‰
- `.cr-status-offline`ï¼šç¦»çº¿çŠ¶æ€æ ·å¼ï¼ˆç°è‰²ï¼‰

**æ ·å¼ç¤ºä¾‹**ï¼š

```css
.cr-status-badge {
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.cr-status-badge.cr-status-idle {
  color: var(--text-success);
}

.cr-status-badge.cr-status-active {
  color: var(--text-accent);
}

.cr-status-badge.cr-status-failed {
  color: var(--text-error);
}

.cr-status-badge.cr-status-offline {
  color: var(--text-muted);
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š`styles.css` ä¸­çš„ `.cr-status-badge` ç›¸å…³æ ·å¼

#### å¿«æ·èœå•

StatusBadge æä¾›ä»¥ä¸‹å¿«æ·èœå•é¡¹ï¼š

| èœå•é¡¹ | å›¾æ ‡ | åŠŸèƒ½ | è§¦å‘äº‹ä»¶ |
|--------|------|------|----------|
| æ‰“å¼€å·¥ä½œå° | brain | æ‰“å¼€ WorkbenchPanel | cognitive-razor:open-workbench |
| æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ— | list-checks | æ‰“å¼€ WorkbenchPanelï¼ˆé˜Ÿåˆ—åŒºåŸŸï¼‰ | cognitive-razor:open-workbench |
| åˆ›å»ºæ¦‚å¿µ | plus | æ‰“å¼€åˆ›å»ºæ¦‚å¿µå¯¹è¯æ¡† | cognitive-razor:create-concept |
| æš‚åœ/æ¢å¤é˜Ÿåˆ— | pause/play | åˆ‡æ¢é˜Ÿåˆ—æš‚åœçŠ¶æ€ | cognitive-razor:toggle-queue |
| é‡è¯•å¤±è´¥ä»»åŠ¡ | refresh-cw | é‡è¯•æ‰€æœ‰å¤±è´¥ä»»åŠ¡ | cognitive-razor:retry-failed |
| æ’ä»¶è®¾ç½® | settings | æ‰“å¼€è®¾ç½®é¢æ¿ | æ‰“å¼€ Obsidian è®¾ç½® |

**æ¡ä»¶æ˜¾ç¤º**ï¼š
- "é‡è¯•å¤±è´¥ä»»åŠ¡"ä»…åœ¨ `status.failed > 0` æ—¶æ˜¾ç¤º
- "æš‚åœé˜Ÿåˆ—"å’Œ"æ¢å¤é˜Ÿåˆ—"æ ¹æ® `status.paused` åŠ¨æ€åˆ‡æ¢

#### æ— éšœç¢æ”¯æŒ

StatusBadge éµå¾ª WCAG 2.1 AA æ ‡å‡†ï¼š

**1. ARIA å±æ€§**

- `role="button"`ï¼šæ ‡è¯†ä¸ºå¯ç‚¹å‡»æŒ‰é’®
- `tabindex="0"`ï¼šæ”¯æŒé”®ç›˜èšç„¦
- `aria-label`ï¼šæä¾›æè¿°æ€§æ ‡ç­¾

**2. é”®ç›˜å¯¼èˆª**

- Enter é”®ï¼šæ‰“å¼€å¿«æ·èœå•
- Space é”®ï¼šæ‰“å¼€å¿«æ·èœå•
- Tab é”®ï¼šèšç„¦åˆ°å¾½ç« 

**3. å±å¹•é˜…è¯»å™¨æ”¯æŒ**

- çŠ¶æ€å˜åŒ–æ—¶æ›´æ–° ARIA æ ‡ç­¾
- å·¥å…·æç¤ºæä¾›è¯¦ç»†ä¿¡æ¯

#### æ€§èƒ½ä¼˜åŒ–

**1. èŠ‚æµæ›´æ–°**

- é˜Ÿåˆ—çŠ¶æ€æ›´æ–°ä½¿ç”¨èŠ‚æµï¼ˆ100msï¼‰ï¼Œé¿å…é¢‘ç¹é‡ç»˜

**2. æœ€å°åŒ– DOM æ“ä½œ**

- ä»…åœ¨çŠ¶æ€å˜åŒ–æ—¶æ›´æ–° DOM
- ä½¿ç”¨ CSS ç±»åˆ‡æ¢è€Œéç›´æ¥ä¿®æ”¹æ ·å¼

**3. äº‹ä»¶å§”æ‰˜**

- ä½¿ç”¨å•ä¸ªç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
- é¿å…ä¸ºæ¯ä¸ªèœå•é¡¹åˆ›å»ºç‹¬ç«‹ç›‘å¬å™¨

#### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼š

- æµ‹è¯•çŠ¶æ€æ–‡æœ¬æ ¼å¼åŒ–
- æµ‹è¯•æ ·å¼ç±»æ›´æ–°
- æµ‹è¯• ARIA æ ‡ç­¾ç”Ÿæˆ
- æµ‹è¯•å·¥å…·æç¤ºç”Ÿæˆ

**é›†æˆæµ‹è¯•**ï¼š

- æµ‹è¯•ä¸ TaskQueue çš„äº‹ä»¶è®¢é˜…
- æµ‹è¯•å¿«æ·èœå•åŠŸèƒ½
- æµ‹è¯•é”®ç›˜è®¿é—®

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/status-badge.test.ts`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### ä½¿ç”¨ç¤ºä¾‹

**åˆå§‹åŒ–**ï¼š

```typescript
// åœ¨ main.ts çš„ onload() ä¸­
const statusBadge = new StatusBadge(this);

// è®¢é˜…é˜Ÿåˆ—äº‹ä»¶
this.registerEvent(
  taskQueue.on('status-changed', (status) => {
    statusBadge.updateStatus(status);
  })
);

// è®¢é˜…ç½‘ç»œçŠ¶æ€äº‹ä»¶
this.registerEvent(
  providerManager.on('offline', () => {
    statusBadge.setOffline(true);
  })
);

this.registerEvent(
  providerManager.on('online', () => {
    statusBadge.setOffline(false);
  })
);
```

**æ¸…ç†**ï¼š

```typescript
// åœ¨ main.ts çš„ onunload() ä¸­
statusBadge.destroy();
```

---

**éœ€æ±‚éªŒè¯**ï¼š
- âœ… éœ€æ±‚ 3.3ï¼šUI å±‚ç»„ä»¶èŒè´£æè¿°
- âœ… éœ€æ±‚ 3.4ï¼šå…³é”®æ–¹æ³•åˆ—å‡º
- âœ… éœ€æ±‚ 1.3ï¼šç»„ä»¶åç§°ã€èŒè´£æè¿°ã€ä¾èµ–å…³ç³»ã€å…³é”®æ–¹æ³•
- âœ… éœ€æ±‚ 5.5ï¼šçŠ¶æ€å¾½ç« æ˜¾ç¤ºé€»è¾‘

### 6.3 CommandDispatcher

**èŒè´£**ï¼šå‘½ä»¤ç»Ÿä¸€åˆ†å‘å™¨ï¼Œè´Ÿè´£æ³¨å†Œæ‰€æœ‰å‘½ä»¤ã€å®ç°å¿«æ·é”®ç»‘å®šå’Œå‘½ä»¤åˆ†å‘

**æ–‡ä»¶è·¯å¾„**ï¼š`src/ui/command-dispatcher.ts`

**ç±»å®šä¹‰**ï¼š
```typescript
export class CommandDispatcher {
  private plugin: CognitiveRazorPlugin;
  private commands: Map<string, CommandDefinition> = new Map();
  private taskQueue: TaskQueue | null = null;
}
```

#### æ ¸å¿ƒåŠŸèƒ½

CommandDispatcher æ˜¯ Cognitive Razor çš„å‘½ä»¤ç®¡ç†ä¸­å¿ƒï¼Œè´Ÿè´£æ³¨å†Œæ‰€æœ‰ç”¨æˆ·å¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œå¹¶å°†å‘½ä»¤åˆ†å‘åˆ°ç›¸åº”çš„å¤„ç†å™¨ã€‚å®ƒéµå¾ªè®¾è®¡æ–‡æ¡£ A-FUNC-09 UI æ³¨å†Œè§„èŒƒå’Œ A-UCD-05 å¤šè¾“å…¥ä¸€è‡´æ€§åŸåˆ™ï¼Œç¡®ä¿å‘½ä»¤ ID æ ¼å¼ç»Ÿä¸€ã€å¿«æ·é”®ç»‘å®šåˆç†ã€å‘½ä»¤æ‰§è¡Œå¯é ã€‚

**å‘½ä»¤ ID æ ¼å¼è§„èŒƒ**ï¼ˆRequirements 9.1ï¼‰ï¼š

æ‰€æœ‰å‘½ä»¤ ID éµå¾ªæ ¼å¼ï¼š`cognitive-razor:<action>-<target>`

ä¾‹å¦‚ï¼š
- `cognitive-razor:create-concept`
- `cognitive-razor:open-workbench`

**æ ¸å¿ƒå‘½ä»¤åˆ—è¡¨**ï¼ˆRequirements 9.1-9.4ï¼‰ï¼š

| å‘½ä»¤ ID | å‘½ä»¤åç§° | å¿«æ·é”® | åŠŸèƒ½ |
|---------|---------|--------|------|
| `cognitive-razor:create-concept` | åˆ›å»ºæ¦‚å¿µ | Ctrl/Cmd + Shift + N | æ‰“å¼€åˆ›å»ºæ¦‚å¿µå¯¹è¯æ¡† |
| `cognitive-razor:open-workbench` | æ‰“å¼€å·¥ä½œå° | Ctrl/Cmd + Shift + W | æ‰“å¼€ç»Ÿä¸€å·¥ä½œå°é¢æ¿ |

**é‡æ„è¯´æ˜**ï¼š

CommandDispatcher å·²è¿›è¡Œé‡æ„ï¼Œä»…ä¿ç•™æ ¸å¿ƒå‘½ä»¤å…¥å£ã€‚å…¶ä»–åŠŸèƒ½ï¼ˆå¦‚é˜Ÿåˆ—ç®¡ç†ã€ç¬”è®°æ“ä½œã€è§†å›¾åˆ‡æ¢ï¼‰ç°åœ¨é€šè¿‡å·¥ä½œå°å†…éƒ¨æ“ä½œå®Œæˆï¼Œç®€åŒ–äº†å‘½ä»¤ç»“æ„ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚

#### å…³é”®æ–¹æ³•

**1. registerAllCommands(): void**

æ³¨å†Œæ‰€æœ‰å‘½ä»¤ã€‚

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ registerConceptCommands() æ³¨å†Œæ¦‚å¿µåˆ›å»ºå‘½ä»¤
- è°ƒç”¨ registerWorkbenchCommands() æ³¨å†Œå·¥ä½œå°å‘½ä»¤
- è°ƒç”¨ registerFileMenu() æ³¨å†Œæ–‡ä»¶èœå•ï¼ˆå³é”®èœå•ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œæ–‡ä»¶èœå•æ³¨å†Œ

---

**2. registerConceptCommands(): void**

æ³¨å†Œæ¦‚å¿µåˆ›å»ºå‘½ä»¤ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ³¨å†Œ `cognitive-razor:create-concept` å‘½ä»¤
- ç»‘å®šå¿«æ·é”®ï¼šCtrl/Cmd + Shift + N
- è®¾ç½®å‘½ä»¤å›¾æ ‡ï¼šplus
- ç»‘å®šå¤„ç†å™¨ï¼šcreateConcept()

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œåˆ›å»ºæ¦‚å¿µå‘½ä»¤

---

**3. registerWorkbenchCommands(): void**

æ³¨å†Œå·¥ä½œå°ç›¸å…³å‘½ä»¤ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ³¨å†Œ `cognitive-razor:open-workbench` å‘½ä»¤
- ç»‘å®šå¿«æ·é”®ï¼šCtrl/Cmd + Shift + W
- è®¾ç½®å‘½ä»¤å›¾æ ‡ï¼šbrain
- ç»‘å®šå¤„ç†å™¨ï¼šopenWorkbench()

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œæ‰“å¼€å·¥ä½œå°å‘½ä»¤

---

**4. registerFileMenu(): void**

æ³¨å†Œæ–‡ä»¶èœå•ï¼ˆå³é”®èœå•ï¼‰ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- ç›‘å¬ `file-menu` äº‹ä»¶
- ä»…å¯¹ Markdown æ–‡ä»¶æ˜¾ç¤ºèœå•é¡¹
- æ·»åŠ "å¢é‡æ”¹è¿›ç¬”è®°"èœå•é¡¹
- ç»‘å®šå¤„ç†å™¨ï¼šimproveNoteFromFile()

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œå¢é‡æ”¹è¿›å‘½ä»¤

---

**5. registerCommand(def: CommandDefinition): void**

æ³¨å†Œå•ä¸ªå‘½ä»¤ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- å°†å‘½ä»¤å®šä¹‰æ·»åŠ åˆ° commands Map
- æ ¹æ®å‘½ä»¤ç±»å‹è°ƒç”¨ä¸åŒçš„ Obsidian APIï¼š
  - æ™®é€šå‘½ä»¤ï¼š`plugin.addCommand({ callback })`
  - éœ€è¦ç¼–è¾‘å™¨çš„å‘½ä»¤ï¼š`plugin.addCommand({ editorCallback })`
  - æ¡ä»¶å‘½ä»¤ï¼š`plugin.addCommand({ checkCallback })`
- ç»‘å®šå¿«æ·é”®
- è®¾ç½®å‘½ä»¤å›¾æ ‡

**å‚æ•°**ï¼š
```typescript
interface CommandDefinition {
  id: string;                    // å‘½ä»¤ ID
  name: string;                  // å‘½ä»¤åç§°
  icon?: string;                 // å‘½ä»¤å›¾æ ‡
  hotkeys?: Array<{              // å¿«æ·é”®
    modifiers: Array<"Mod" | "Ctrl" | "Meta" | "Shift" | "Alt">;
    key: string;
  }>;
  handler: CommandHandler;       // å‘½ä»¤å¤„ç†å™¨
  editorRequired?: boolean;      // æ˜¯å¦éœ€è¦ç¼–è¾‘å™¨
  checkCallback?: (checking: boolean) => boolean; // æ£€æŸ¥å›è°ƒ
}
```

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œå‘½ä»¤æ³¨å†Œé€»è¾‘

---

**6. executeCommand(commandId: string): Promise<void>**

æ‰§è¡Œå‘½ä»¤ã€‚

**åŠŸèƒ½**ï¼š
- æ ¹æ®å‘½ä»¤ ID æŸ¥æ‰¾å‘½ä»¤å®šä¹‰
- è°ƒç”¨å‘½ä»¤å¤„ç†å™¨
- æ•è·å¹¶å¤„ç†é”™è¯¯

**ç”¨é€”**ï¼š
- ç¨‹åºåŒ–æ‰§è¡Œå‘½ä»¤
- æµ‹è¯•å‘½ä»¤æ‰§è¡Œé€»è¾‘

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œå‘½ä»¤æµ‹è¯•æ–¹æ³•

---

**7. getAllCommands(): CommandDefinition[]**

è·å–æ‰€æœ‰å‘½ä»¤ã€‚

**åŠŸèƒ½**ï¼š
- è¿”å›æ‰€æœ‰å·²æ³¨å†Œå‘½ä»¤çš„å®šä¹‰æ•°ç»„

**ç”¨é€”**ï¼š
- è°ƒè¯•å‘½ä»¤æ³¨å†Œ
- ç”Ÿæˆå‘½ä»¤æ–‡æ¡£

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œå‘½ä»¤æ–‡æ¡£ç”Ÿæˆ

---

**8. getCommand(commandId: string): CommandDefinition | undefined**

è·å–å‘½ä»¤å®šä¹‰ã€‚

**åŠŸèƒ½**ï¼š
- æ ¹æ®å‘½ä»¤ ID æŸ¥æ‰¾å‘½ä»¤å®šä¹‰
- è¿”å›å‘½ä»¤å®šä¹‰æˆ– undefined

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œ`getCommand()` æ–¹æ³•

---

**9. hasCommand(commandId: string): boolean**

æ£€æŸ¥å‘½ä»¤æ˜¯å¦å·²æ³¨å†Œã€‚

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥ commands Map ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šå‘½ä»¤ ID

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œ`hasCommand()` æ–¹æ³•

---

**10. static getCoreCommandIds(): string[]**

è·å–æ ¸å¿ƒå‘½ä»¤ ID åˆ—è¡¨ï¼ˆé™æ€æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- è¿”å› Requirements 9.1-9.4 å®šä¹‰çš„æ ¸å¿ƒå‘½ä»¤ ID æ•°ç»„

**è¿”å›å€¼**ï¼š
```typescript
[
  "cognitive-razor:create-concept",
  "cognitive-razor:open-workbench"
]
```

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-utils.ts`ï¼šå‘½ä»¤å·¥å…·å‡½æ•°ï¼Œ`getActiveFile()` å®ç°

---

**11. static isValidCommandId(commandId: string): boolean**

éªŒè¯å‘½ä»¤ ID æ ¼å¼ï¼ˆé™æ€æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥å‘½ä»¤ ID æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼š`cognitive-razor:<action>-<target>`
- ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼éªŒè¯

**æ­£åˆ™è¡¨è¾¾å¼**ï¼š
```typescript
/^cognitive-razor:[a-z]+(-[a-z]+)*$/
```

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-utils.ts`ï¼šå‘½ä»¤å·¥å…·å‡½æ•°ï¼Œ`getActiveEditor()` å®ç°

#### å‘½ä»¤å®ç°

**1. openWorkbench(): Promise<WorkbenchPanel | null>**

æ‰“å¼€å·¥ä½œå°ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¼€ WorkbenchPanel
- å¦‚æœå·²æ‰“å¼€ï¼Œèšç„¦åˆ°è¯¥é¢æ¿
- å¦‚æœæœªæ‰“å¼€ï¼Œåœ¨å³ä¾§è¾¹æ åˆ›å»ºæ–°é¢æ¿
- è¿”å› WorkbenchPanel å®ä¾‹æˆ– null

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œè·å–å·¥ä½œå°é¢æ¿å®ä¾‹

---

**2. createConcept(): Promise<void>**

åˆ›å»ºæ¦‚å¿µï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ‰“å¼€ SimpleInputModal å¯¹è¯æ¡†
- æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„æ¦‚å¿µæè¿°
- æ‰“å¼€ WorkbenchPanel
- è°ƒç”¨ workbenchPanel.startQuickCreate() å¯åŠ¨å¿«é€Ÿåˆ›å»ºæµç¨‹

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œå¿«é€Ÿåˆ›å»ºæ¦‚å¿µå‘½ä»¤å®ç°

---

**3. improveNoteFromFile(file: TFile): Promise<void>**

ä»æ–‡ä»¶è§¦å‘å¢é‡æ”¹è¿›ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- è·å– PipelineOrchestrator å®ä¾‹
- æ‰“å¼€ IncrementalImproveModal å¯¹è¯æ¡†
- ä¼ å…¥æ–‡ä»¶å’Œç®¡çº¿ç¼–æ’å™¨

**å‚è€ƒä»£ç **ï¼š
- `src/ui/command-dispatcher.ts`ï¼šCommandDispatcher å®ç°ï¼Œä»æ–‡ä»¶å¢é‡æ”¹è¿›å‘½ä»¤å®ç°

#### ä¾èµ–å…³ç³»

CommandDispatcher ä¾èµ–ä»¥ä¸‹ç»„ä»¶ï¼š

- **CognitiveRazorPlugin**ï¼šæ’ä»¶ä¸»ç±»ï¼Œç”¨äºæ³¨å†Œå‘½ä»¤å’Œè®¿é—®å…¶ä»–ç»„ä»¶
- **TaskQueue**ï¼šé€šè¿‡ plugin.getComponents() è®¿é—®ï¼ˆå¯é€‰ï¼‰
- **PipelineOrchestrator**ï¼šé€šè¿‡ plugin.getComponents() è®¿é—®
- **DuplicateManager**ï¼šé€šè¿‡ plugin.getComponents() è®¿é—®

**ä¾èµ–æ³¨å…¥æ–¹å¼**ï¼š

```typescript
// åœ¨ main.ts ä¸­åˆå§‹åŒ–
const commandDispatcher = new CommandDispatcher(this, taskQueue);

// æˆ–è€…å»¶è¿Ÿæ³¨å…¥ TaskQueue
const commandDispatcher = new CommandDispatcher(this);
commandDispatcher.setTaskQueue(taskQueue);

// æ³¨å†Œæ‰€æœ‰å‘½ä»¤
commandDispatcher.registerAllCommands();
```

#### å‘½ä»¤ ID è§„èŒƒ

**æ ¼å¼è¦æ±‚**ï¼ˆRequirements 9.1ï¼‰ï¼š

æ‰€æœ‰å‘½ä»¤ ID å¿…é¡»éµå¾ªæ ¼å¼ï¼š`cognitive-razor:<action>-<target>`

**å‘½åè§„åˆ™**ï¼š

- ä½¿ç”¨å°å†™å­—æ¯
- ä½¿ç”¨è¿å­—ç¬¦ï¼ˆ-ï¼‰åˆ†éš”å•è¯
- action æè¿°åŠ¨ä½œï¼ˆcreateã€openã€toggleã€retry ç­‰ï¼‰
- target æè¿°ç›®æ ‡å¯¹è±¡ï¼ˆconceptã€workbenchã€queue ç­‰ï¼‰

**æœ‰æ•ˆç¤ºä¾‹**ï¼š

- âœ… `cognitive-razor:create-concept`
- âœ… `cognitive-razor:open-workbench`
- âœ… `cognitive-razor:toggle-queue`

**æ— æ•ˆç¤ºä¾‹**ï¼š

- âŒ `cognitive-razor:createConcept`ï¼ˆä½¿ç”¨äº†é©¼å³°å‘½åï¼‰
- âŒ `cognitive-razor:create_concept`ï¼ˆä½¿ç”¨äº†ä¸‹åˆ’çº¿ï¼‰
- âŒ `create-concept`ï¼ˆç¼ºå°‘æ’ä»¶å‰ç¼€ï¼‰

**éªŒè¯æ–¹æ³•**ï¼š

```typescript
CommandDispatcher.isValidCommandId("cognitive-razor:create-concept"); // true
CommandDispatcher.isValidCommandId("cognitive-razor:createConcept");  // false
```

#### å¿«æ·é”®è§„èŒƒ

**å¿«æ·é”®è®¾è®¡åŸåˆ™**ï¼ˆA-UCD-05 å¤šè¾“å…¥ä¸€è‡´æ€§ï¼‰ï¼š

1. **è·¨å¹³å°ä¸€è‡´æ€§**ï¼šä½¿ç”¨ "Mod" ä¿®é¥°ç¬¦è‡ªåŠ¨é€‚é… Windows/Linuxï¼ˆCtrlï¼‰å’Œ macOSï¼ˆCmdï¼‰
2. **é¿å…å†²çª**ï¼šé¿å…ä¸ Obsidian æ ¸å¿ƒå¿«æ·é”®å†²çª
3. **æ˜“è®°æ€§**ï¼šå¿«æ·é”®ä¸å‘½ä»¤åŠŸèƒ½ç›¸å…³ï¼ˆå¦‚ N for New, W for Workbenchï¼‰
4. **ä¸€è‡´æ€§**ï¼šåŒç±»å‘½ä»¤ä½¿ç”¨ç›¸åŒçš„ä¿®é¥°ç¬¦ç»„åˆ

**æ ¸å¿ƒå‘½ä»¤å¿«æ·é”®**ï¼š

| å‘½ä»¤ | å¿«æ·é”® | è¯´æ˜ |
|------|--------|------|
| åˆ›å»ºæ¦‚å¿µ | Mod + Shift + N | N = New |
| æ‰“å¼€å·¥ä½œå° | Mod + Shift + W | W = Workbench |

**ä¿®é¥°ç¬¦è¯´æ˜**ï¼š

- **Mod**ï¼šWindows/Linux ä¸Šä¸º Ctrlï¼ŒmacOS ä¸Šä¸º Cmd
- **Shift**ï¼šShift é”®
- **Alt**ï¼šAlt é”®ï¼ˆmacOS ä¸Šä¸º Optionï¼‰

#### é”™è¯¯å¤„ç†

CommandDispatcher å®ç°äº†å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

**1. å‘½ä»¤æ‰§è¡Œé”™è¯¯**

```typescript
try {
  await def.handler();
} catch (error) {
  console.error(`å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${def.id}`, error);
  const errorMessage = error instanceof Error ? error.message : String(error);
  new Notice(`å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${errorMessage}`);
}
```

**2. å‘½ä»¤æœªæ‰¾åˆ°é”™è¯¯**

```typescript
const def = this.commands.get(commandId);
if (!def) {
  throw new Error(`æœªæ‰¾åˆ°å‘½ä»¤: ${commandId}`);
}
```

**3. ç»„ä»¶æœªåˆå§‹åŒ–é”™è¯¯**

```typescript
const components = this.plugin.getComponents();
if (!components.pipelineOrchestrator) {
  new Notice("ç®¡çº¿ç¼–æ’å™¨æœªåˆå§‹åŒ–");
  return;
}
```

#### å‘½ä»¤å·¥å…·å‡½æ•°

CommandDispatcher ä½¿ç”¨ç‹¬ç«‹çš„å·¥å…·æ¨¡å—ç®¡ç†å‘½ä»¤å¸¸é‡å’ŒéªŒè¯é€»è¾‘ï¼š

**æ–‡ä»¶è·¯å¾„**ï¼š`src/ui/command-utils.ts`

**å¯¼å‡ºå†…å®¹**ï¼š

```typescript
// å‘½ä»¤ ID å¸¸é‡
export const COMMAND_IDS = {
  CREATE_CONCEPT: "cognitive-razor:create-concept",
  OPEN_WORKBENCH: "cognitive-razor:open-workbench",
} as const;

// è·å–æ ¸å¿ƒå‘½ä»¤ ID åˆ—è¡¨
export function getCoreCommandIds(): string[] {
  return Object.values(COMMAND_IDS);
}

// éªŒè¯å‘½ä»¤ ID æ ¼å¼
export function isValidCommandId(commandId: string): boolean {
  return /^cognitive-razor:[a-z]+(-[a-z]+)*$/.test(commandId);
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
import { COMMAND_IDS, isValidCommandId } from "./command-utils";

// ä½¿ç”¨å¸¸é‡è€Œéç¡¬ç¼–ç å­—ç¬¦ä¸²
this.registerCommand({
  id: COMMAND_IDS.CREATE_CONCEPT,
  name: "åˆ›å»ºæ¦‚å¿µ",
  // ...
});

// éªŒè¯å‘½ä»¤ ID
if (!isValidCommandId(commandId)) {
  throw new Error(`æ— æ•ˆçš„å‘½ä»¤ ID: ${commandId}`);
}
```

#### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼š

- æµ‹è¯•å‘½ä»¤æ³¨å†Œ
- æµ‹è¯•å‘½ä»¤ ID æ ¼å¼éªŒè¯
- æµ‹è¯•å‘½ä»¤æ‰§è¡Œ
- æµ‹è¯•é”™è¯¯å¤„ç†

**é›†æˆæµ‹è¯•**ï¼š

- æµ‹è¯•ä¸ WorkbenchPanel çš„äº¤äº’
- æµ‹è¯•ä¸ PipelineOrchestrator çš„äº¤äº’
- æµ‹è¯•å¿«æ·é”®ç»‘å®š

**æµ‹è¯•ç¤ºä¾‹**ï¼š

```typescript
describe('CommandDispatcher', () => {
  it('should register all core commands', () => {
    const dispatcher = new CommandDispatcher(plugin);
    dispatcher.registerAllCommands();
    
    const coreIds = CommandDispatcher.getCoreCommandIds();
    coreIds.forEach(id => {
      expect(dispatcher.hasCommand(id)).toBe(true);
    });
  });
  
  it('should validate command ID format', () => {
    expect(CommandDispatcher.isValidCommandId('cognitive-razor:create-concept')).toBe(true);
    expect(CommandDispatcher.isValidCommandId('cognitive-razor:createConcept')).toBe(false);
    expect(CommandDispatcher.isValidCommandId('create-concept')).toBe(false);
  });
});
```

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/command-dispatcher.test.ts`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### ä½¿ç”¨ç¤ºä¾‹

**åˆå§‹åŒ–**ï¼š

```typescript
// åœ¨ main.ts çš„ onload() ä¸­
const commandDispatcher = new CommandDispatcher(this, taskQueue);
commandDispatcher.registerAllCommands();
```

**ç¨‹åºåŒ–æ‰§è¡Œå‘½ä»¤**ï¼š

```typescript
// åœ¨å…¶ä»–ç»„ä»¶ä¸­æ‰§è¡Œå‘½ä»¤
await commandDispatcher.executeCommand(COMMAND_IDS.CREATE_CONCEPT);
```

**è·å–å‘½ä»¤åˆ—è¡¨**ï¼š

```typescript
// è·å–æ‰€æœ‰å‘½ä»¤
const allCommands = commandDispatcher.getAllCommands();
console.log(`å·²æ³¨å†Œ ${allCommands.length} ä¸ªå‘½ä»¤`);

// è·å–ç‰¹å®šå‘½ä»¤
const createCmd = commandDispatcher.getCommand(COMMAND_IDS.CREATE_CONCEPT);
console.log(`å‘½ä»¤åç§°: ${createCmd?.name}`);
```

#### é‡æ„å†å²

**å·²ç§»é™¤çš„å‘½ä»¤**ï¼š

ä»¥ä¸‹å‘½ä»¤å·²åœ¨é‡æ„ä¸­ç§»é™¤ï¼ŒåŠŸèƒ½å·²æ•´åˆåˆ°å·¥ä½œå°å†…éƒ¨æ“ä½œï¼š

- `cognitive-razor:open-queue`ï¼šé˜Ÿåˆ—åŠŸèƒ½å·²æ•´åˆåˆ°å·¥ä½œå°
- `cognitive-razor:toggle-queue`ï¼šé€šè¿‡å·¥ä½œå°æ“ä½œ
- `cognitive-razor:clear-completed`ï¼šé€šè¿‡å·¥ä½œå°æ“ä½œ
- `cognitive-razor:retry-failed`ï¼šé€šè¿‡å·¥ä½œå°æ“ä½œ
- `cognitive-razor:enrich-note`ï¼šé€šè¿‡æ–‡ä»¶èœå•è§¦å‘
- `cognitive-razor:check-duplicates`ï¼šé‡å¤ç®¡ç†å·²æ•´åˆåˆ°å·¥ä½œå°
- `cognitive-razor:undo-last`ï¼šæ’¤é”€åŠŸèƒ½å·²æ•´åˆåˆ°å·¥ä½œå°
- `cognitive-razor:toggle-workbench`ï¼šä¸å†éœ€è¦åˆ‡æ¢å‘½ä»¤
- `cognitive-razor:toggle-queue-view`ï¼šé˜Ÿåˆ—è§†å›¾å·²åºŸé™¤
- `cognitive-razor:open-undo-history`ï¼šå†å²è§†å›¾å·²åºŸé™¤

**é‡æ„åŸå› **ï¼š

1. **ç®€åŒ–å‘½ä»¤ç»“æ„**ï¼šå‡å°‘å‘½ä»¤æ•°é‡ï¼Œé™ä½ç”¨æˆ·å­¦ä¹ æˆæœ¬
2. **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰åŠŸèƒ½é€šè¿‡å·¥ä½œå°è®¿é—®ï¼Œæå‡ä¸€è‡´æ€§
3. **å‡å°‘å¿«æ·é”®å†²çª**ï¼šé¿å…è¿‡å¤šå¿«æ·é”®ç»‘å®š
4. **æå‡å¯ç»´æŠ¤æ€§**ï¼šå‡å°‘å‘½ä»¤å¤„ç†é€»è¾‘çš„é‡å¤ä»£ç 

---

**éœ€æ±‚éªŒè¯**ï¼š
- âœ… éœ€æ±‚ 3.3ï¼šUI å±‚ç»„ä»¶èŒè´£æè¿°
- âœ… éœ€æ±‚ 3.4ï¼šå…³é”®æ–¹æ³•åˆ—å‡º
- âœ… éœ€æ±‚ 1.3ï¼šç»„ä»¶åç§°ã€èŒè´£æè¿°ã€ä¾èµ–å…³ç³»ã€å…³é”®æ–¹æ³•
- âœ… éœ€æ±‚ 9.1ï¼šå‘½ä»¤ ID æ ¼å¼è§„èŒƒ
- âœ… éœ€æ±‚ 9.2ï¼šæ ¸å¿ƒå‘½ä»¤åˆ—è¡¨

### 6.4 SettingsTab

**èŒè´£**ï¼šæ’ä»¶è®¾ç½®é¢æ¿ï¼Œæä¾›é…ç½®ç®¡ç†ã€Provider é…ç½®ã€å‚æ•°è°ƒæ•´å’Œå¯¼å…¥å¯¼å‡ºåŠŸèƒ½

**æ–‡ä»¶è·¯å¾„**ï¼š`src/ui/settings-tab.ts`

**ç±»å®šä¹‰**ï¼š
```typescript
export class CognitiveRazorSettingTab extends PluginSettingTab {
  plugin: CognitiveRazorPlugin;
  
  constructor(app: App, plugin: CognitiveRazorPlugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
}
```

#### æ ¸å¿ƒåŠŸèƒ½

CognitiveRazorSettingTab æ˜¯ Cognitive Razor çš„è®¾ç½®é¢æ¿ï¼Œç»§æ‰¿è‡ª Obsidian çš„ PluginSettingTab ç±»ã€‚å®ƒæä¾›äº†å®Œæ•´çš„é…ç½®ç®¡ç†ç•Œé¢ï¼ŒåŒ…æ‹¬åŸºç¡€è®¾ç½®ã€Provider é…ç½®ã€æ’ä»¶å‚æ•°ã€é«˜çº§è®¾ç½®å’Œå¯¼å…¥å¯¼å‡ºåŠŸèƒ½ã€‚è®¾ç½®é¢æ¿éµå¾ªè®¾è®¡æ–‡æ¡£ A-FUNC-08 çš„é«˜çº§æ¨¡å¼è§„èŒƒï¼Œä¸ºä¸åŒå±‚æ¬¡çš„ç”¨æˆ·æä¾›åˆé€‚çš„é…ç½®é€‰é¡¹ã€‚

**è®¾ç½®åˆ†ç±»**ï¼š

1. **åŸºç¡€è®¾ç½®**ï¼šè¯­è¨€é€‰æ‹©
2. **Provider é…ç½®**ï¼šæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤ã€æµ‹è¯• AI Provider
3. **æ’ä»¶å‚æ•°**ï¼šç›¸ä¼¼åº¦é˜ˆå€¼ã€å¿«ç…§ç®¡ç†ã€å¹¶å‘æ§åˆ¶
4. **é«˜çº§è®¾ç½®**ï¼šå‘½åæ¨¡æ¿ã€ç›®å½•æ–¹æ¡ˆã€ä»»åŠ¡æ¨¡å‹é…ç½®ã€æ¸©åº¦å‚æ•°ã€å»é‡å‚æ•°ã€åµŒå…¥å‚æ•°ã€åŠŸèƒ½å¼€å…³ã€é˜Ÿåˆ—å‚æ•°ã€æ—¥å¿—è®¾ç½®
5. **å¯¼å…¥å¯¼å‡º**ï¼šé…ç½®å¯¼å‡ºã€é…ç½®å¯¼å…¥ã€é…ç½®é‡ç½®

#### å…³é”®æ–¹æ³•

**1. display(): void**

æ¸²æŸ“è®¾ç½®é¢æ¿ã€‚

**åŠŸèƒ½**ï¼š
- æ¸…ç©ºå®¹å™¨
- åˆ›å»ºæ ‡é¢˜
- è°ƒç”¨å„ä¸ªæ¸²æŸ“æ–¹æ³•ï¼š
  - renderBasicSettings()ï¼šåŸºç¡€è®¾ç½®
  - renderProviderSettings()ï¼šProvider é…ç½®
  - renderPluginSettings()ï¼šæ’ä»¶å‚æ•°
  - renderAdvancedSettings()ï¼šé«˜çº§è®¾ç½®ï¼ˆä»…åœ¨é«˜çº§æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
  - renderImportExport()ï¼šå¯¼å…¥å¯¼å‡º

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œ`display()` æ–¹æ³•

---

**2. renderBasicSettings(containerEl: HTMLElement): void**

æ¸²æŸ“åŸºç¡€è®¾ç½®ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º"åŸºç¡€è®¾ç½®"æ ‡é¢˜
- æ·»åŠ è¯­è¨€é€‰æ‹©ä¸‹æ‹‰æ¡†ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
- ç»‘å®šè¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼š
  - æ›´æ–°è®¾ç½®
  - åˆ‡æ¢ i18n è¯­è¨€
  - æ˜¾ç¤ºé€šçŸ¥
  - åˆ·æ–°è®¾ç½®é¢æ¿ä»¥åº”ç”¨æ–°è¯­è¨€

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œè¯­è¨€è®¾ç½®æ¸²æŸ“

---

**3. renderProviderSettings(containerEl: HTMLElement): void**

æ¸²æŸ“ Provider è®¾ç½®ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºå¯æŠ˜å çš„"Provider é…ç½®"åŒºåŸŸ
- æ·»åŠ "æ·»åŠ  Provider"æŒ‰é’®
- æ˜¾ç¤ºå·²é…ç½®çš„ Provider åˆ—è¡¨ï¼ˆè°ƒç”¨ renderProviderItem()ï¼‰
- æ·»åŠ "é»˜è®¤ Provider"é€‰æ‹©ä¸‹æ‹‰æ¡†

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼ŒProvider è®¾ç½®æ¸²æŸ“

---

**4. renderProviderItem(containerEl: HTMLElement, id: string, config: ProviderConfig): void**

æ¸²æŸ“å•ä¸ª Provider é¡¹ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤º Provider IDã€æ¨¡å‹å’ŒçŠ¶æ€
- æ·»åŠ å¯ç”¨/ç¦ç”¨åˆ‡æ¢å¼€å…³
- æ·»åŠ "æµ‹è¯•è¿æ¥"æŒ‰é’®
- æ·»åŠ "ç¼–è¾‘"æŒ‰é’®
- æ·»åŠ "è®¾ä¸ºé»˜è®¤"æŒ‰é’®
- æ·»åŠ "åˆ é™¤"æŒ‰é’®ï¼ˆè­¦å‘Šæ ·å¼ï¼‰

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼ŒProvider åˆ—è¡¨æ¸²æŸ“

---

**5. renderPluginSettings(containerEl: HTMLElement): void**

æ¸²æŸ“æ’ä»¶è®¾ç½®ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º"æ’ä»¶è®¾ç½®"æ ‡é¢˜
- æ·»åŠ ç›¸ä¼¼åº¦é˜ˆå€¼æ»‘å—ï¼ˆ0.5-1.0ï¼‰
- æ·»åŠ æœ€å¤§å¿«ç…§æ•°é‡è¾“å…¥æ¡†
- æ·»åŠ å¿«ç…§ä¿ç•™å¤©æ•°è¾“å…¥æ¡†ï¼ˆA-FUNC-02 å¯é…ç½®çš„å¿«ç…§ä¿ç•™ç­–ç•¥ï¼‰
- æ·»åŠ å¹¶å‘ä»»åŠ¡æ•°è¾“å…¥æ¡†
- æ·»åŠ é«˜çº§æ¨¡å¼åˆ‡æ¢å¼€å…³

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œé«˜çº§è®¾ç½®æ¸²æŸ“

---

**6. renderAdvancedSettings(containerEl: HTMLElement): void**

æ¸²æŸ“é«˜çº§è®¾ç½®ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»ºå¯æŠ˜å çš„"é«˜çº§è®¾ç½®"åŒºåŸŸ
- æ¸²æŸ“ä»¥ä¸‹å­åŒºåŸŸï¼š
  - **å‘½åå’Œç›®å½•é…ç½®**ï¼šå‘½åæ¨¡æ¿ã€ç›®å½•æ–¹æ¡ˆï¼ˆæŒ‰æ¦‚å¿µç±»å‹ï¼‰
  - **ä»»åŠ¡æ¨¡å‹é…ç½®**ï¼šä¸ºæ¯ç§ä»»åŠ¡ç±»å‹é…ç½® Providerã€æ¨¡å‹ã€Temperatureã€TopPã€Reasoning Effort
  - **æ¸©åº¦å‚æ•°**ï¼šé»˜è®¤æ¸©åº¦æ»‘å—
  - **å»é‡å‚æ•°**ï¼šç›¸ä¼¼åº¦é˜ˆå€¼ã€TopK
  - **åµŒå…¥å‚æ•°**ï¼šå‘é‡ç»´åº¦é€‰æ‹©
  - **åŠŸèƒ½å¼€å…³**ï¼šå¯ç”¨/ç¦ç”¨äº‹å®æ ¸æŸ¥ï¼ˆGroundingï¼‰
  - **é˜Ÿåˆ—å‚æ•°**ï¼šå¹¶å‘æ•°ã€è‡ªåŠ¨é‡è¯•ã€æœ€å¤§é‡è¯•æ¬¡æ•°
  - **æ—¥å¿—è®¾ç½®**ï¼šæ—¥å¿—çº§åˆ«ã€æ—¥å¿—æ ¼å¼ã€æ¸…é™¤æ—¥å¿—

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œé«˜çº§è®¾ç½®è¯¦ç»†é…ç½®

---

**7. renderImportExport(containerEl: HTMLElement): void**

æ¸²æŸ“å¯¼å…¥å¯¼å‡ºï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º"å¯¼å…¥å¯¼å‡º"æ ‡é¢˜
- æ·»åŠ "å¯¼å‡ºé…ç½®"æŒ‰é’®ï¼š
  - è°ƒç”¨ settingsStore.export()
  - åˆ›å»º JSON æ–‡ä»¶ä¸‹è½½é“¾æ¥
  - è§¦å‘æµè§ˆå™¨ä¸‹è½½
- æ·»åŠ "å¯¼å…¥é…ç½®"æŒ‰é’®ï¼š
  - æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
  - è¯»å– JSON æ–‡ä»¶
  - è°ƒç”¨ settingsStore.import()
  - åˆ·æ–°è®¾ç½®é¢æ¿
- æ·»åŠ "é‡ç½®é…ç½®"æŒ‰é’®ï¼ˆè­¦å‘Šæ ·å¼ï¼‰ï¼š
  - æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  - è°ƒç”¨ settingsStore.reset()
  - åˆ·æ–°è®¾ç½®é¢æ¿

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œæ·»åŠ  Provider æ¨¡æ€æ¡†

---

**8. showAddProviderModal(): void**

æ˜¾ç¤ºæ·»åŠ  Provider æ¨¡æ€æ¡†ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º ProviderConfigModal å®ä¾‹ï¼ˆmode: "add"ï¼‰
- ç»‘å®šä¿å­˜å›è°ƒï¼š
  - è°ƒç”¨ settingsStore.addProvider()
  - æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
  - åˆ·æ–°è®¾ç½®é¢æ¿
- ç»‘å®šå–æ¶ˆå›è°ƒ

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œç¼–è¾‘ Provider æ¨¡æ€æ¡†

---

**9. showEditProviderModal(id: string, config: ProviderConfig): void**

æ˜¾ç¤ºç¼–è¾‘ Provider æ¨¡æ€æ¡†ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º ProviderConfigModal å®ä¾‹ï¼ˆmode: "edit"ï¼‰
- ä¼ å…¥å½“å‰é…ç½®
- ç»‘å®šä¿å­˜å›è°ƒï¼š
  - è°ƒç”¨ settingsStore.updateProvider()
  - æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
  - åˆ·æ–°è®¾ç½®é¢æ¿
- ç»‘å®šå–æ¶ˆå›è°ƒ

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œåˆ é™¤ Provider ç¡®è®¤

---

**10. showDeleteProviderConfirm(id: string): void**

æ˜¾ç¤ºåˆ é™¤ Provider ç¡®è®¤å¯¹è¯æ¡†ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º ConfirmModal å®ä¾‹
- è®¾ç½®æ ‡é¢˜ã€æ¶ˆæ¯ã€ç¡®è®¤æŒ‰é’®æ–‡æœ¬
- è®¾ç½®å±é™©æ ·å¼ï¼ˆçº¢è‰²ï¼‰
- ç»‘å®šç¡®è®¤å›è°ƒï¼š
  - è°ƒç”¨ settingsStore.removeProvider()
  - æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
  - åˆ·æ–°è®¾ç½®é¢æ¿
- ç»‘å®šå–æ¶ˆå›è°ƒ

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œé‡ç½®è®¾ç½®ç¡®è®¤

---

**11. showResetSettingsConfirm(): void**

æ˜¾ç¤ºé‡ç½®è®¾ç½®ç¡®è®¤å¯¹è¯æ¡†ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- åˆ›å»º ConfirmModal å®ä¾‹
- è®¾ç½®æ ‡é¢˜ã€æ¶ˆæ¯ã€ç¡®è®¤æŒ‰é’®æ–‡æœ¬
- è®¾ç½®å±é™©æ ·å¼ï¼ˆçº¢è‰²ï¼‰
- ç»‘å®šç¡®è®¤å›è°ƒï¼š
  - è°ƒç”¨ settingsStore.reset()
  - æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
  - åˆ·æ–°è®¾ç½®é¢æ¿
- ç»‘å®šå–æ¶ˆå›è°ƒ

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œæ¸…é™¤æ—¥å¿—ç¡®è®¤

---

**12. testProviderConnection(id: string): Promise<void>**

æµ‹è¯• Provider è¿æ¥ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºåŠ è½½é€šçŸ¥
- æ¸…é™¤ Provider å¯ç”¨æ€§ç¼“å­˜
- è°ƒç”¨ providerManager.checkAvailability()ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
- æ˜¾ç¤ºæµ‹è¯•ç»“æœï¼š
  - æˆåŠŸï¼šæ˜¾ç¤ºèŠå¤©ã€åµŒå…¥èƒ½åŠ›å’Œå¯ç”¨æ¨¡å‹æ•°é‡
  - å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œå¯¼å…¥è®¾ç½®å¤„ç†

---

**13. setDefaultProvider(id: string): Promise<void>**

è®¾ç½®é»˜è®¤ Providerï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- è°ƒç”¨ settingsStore.setDefaultProvider()
- æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
- åˆ·æ–°è®¾ç½®é¢æ¿

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œå¯¼å‡ºè®¾ç½®å¤„ç†

---

**14. clearLogs(): Promise<void>**

æ¸…é™¤æ—¥å¿—ï¼ˆç§æœ‰æ–¹æ³•ï¼‰ã€‚

**åŠŸèƒ½**ï¼š
- è·å–æ—¥å¿—æ–‡ä»¶è·¯å¾„
- æ£€æŸ¥æ—¥å¿—ç›®å½•æ˜¯å¦å­˜åœ¨
- åˆ é™¤æ—¥å¿—ç›®å½•
- æ˜¾ç¤ºæˆåŠŸæˆ–å¤±è´¥é€šçŸ¥

**å‚è€ƒä»£ç **ï¼š
- `src/ui/settings-tab.ts`ï¼šCognitiveRazorSettingTab å®ç°ï¼Œæ–‡ä»¶é€‰æ‹©å’Œé€šçŸ¥

#### ä¾èµ–å…³ç³»

SettingsTab ä¾èµ–ä»¥ä¸‹ç»„ä»¶ï¼š

- **CognitiveRazorPlugin**ï¼šæ’ä»¶ä¸»ç±»ï¼Œç”¨äºè®¿é—®è®¾ç½®å’Œç»„ä»¶
- **SettingsStore**ï¼šé€šè¿‡ plugin.getComponents() è®¿é—®ï¼Œç”¨äºè®¾ç½®çš„è¯»å†™
- **ProviderManager**ï¼šé€šè¿‡ plugin.getComponents() è®¿é—®ï¼Œç”¨äºæµ‹è¯• Provider è¿æ¥
- **I18n**ï¼šé€šè¿‡ plugin.getI18n() è®¿é—®ï¼Œç”¨äºå¤šè¯­è¨€æ”¯æŒ

**ä¾èµ–æ³¨å…¥æ–¹å¼**ï¼š

```typescript
// åœ¨ main.ts ä¸­æ³¨å†Œè®¾ç½®é¢æ¿
this.addSettingTab(new CognitiveRazorSettingTab(this.app, this));
```

#### è®¾ç½®é¡¹ç»„ç»‡

SettingsTab å°†è®¾ç½®é¡¹ç»„ç»‡ä¸ºå¤šä¸ªåŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸä½¿ç”¨å¯æŠ˜å çš„ `<details>` å…ƒç´ ï¼š

**1. åŸºç¡€è®¾ç½®**

- è¯­è¨€é€‰æ‹©ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰

**2. Provider é…ç½®**

- Provider åˆ—è¡¨ï¼ˆIDã€æ¨¡å‹ã€çŠ¶æ€ï¼‰
- æ·»åŠ  Provider æŒ‰é’®
- é»˜è®¤ Provider é€‰æ‹©

**3. æ’ä»¶å‚æ•°**

- ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0.5-1.0ï¼‰
- æœ€å¤§å¿«ç…§æ•°é‡
- å¿«ç…§ä¿ç•™å¤©æ•°
- å¹¶å‘ä»»åŠ¡æ•°
- é«˜çº§æ¨¡å¼å¼€å…³

**4. é«˜çº§è®¾ç½®**ï¼ˆä»…åœ¨é«˜çº§æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰

- å‘½åæ¨¡æ¿
- ç›®å½•æ–¹æ¡ˆï¼ˆæŒ‰æ¦‚å¿µç±»å‹ï¼‰
- ä»»åŠ¡æ¨¡å‹é…ç½®ï¼ˆæŒ‰ä»»åŠ¡ç±»å‹ï¼‰
- æ¸©åº¦å‚æ•°
- å»é‡å‚æ•°
- åµŒå…¥å‚æ•°
- åŠŸèƒ½å¼€å…³
- é˜Ÿåˆ—å‚æ•°
- æ—¥å¿—è®¾ç½®

**5. å¯¼å…¥å¯¼å‡º**

- å¯¼å‡ºé…ç½®æŒ‰é’®
- å¯¼å…¥é…ç½®æŒ‰é’®
- é‡ç½®é…ç½®æŒ‰é’®

#### ä»»åŠ¡æ¨¡å‹é…ç½®

SettingsTab ä¸ºæ¯ç§ä»»åŠ¡ç±»å‹æä¾›ç‹¬ç«‹çš„æ¨¡å‹é…ç½®ï¼ˆA-FUNC-08 é«˜çº§æ¨¡å¼ï¼‰ï¼š

**ä»»åŠ¡ç±»å‹åˆ—è¡¨**ï¼š

| ä»»åŠ¡ç±»å‹ | åç§° | æè¿° |
|---------|------|------|
| `standardizeClassify` | æ ‡å‡†åŒ–åˆ†ç±» | å°†ç”¨æˆ·è¾“å…¥æ ‡å‡†åŒ–å¹¶åˆ†ç±» |
| `enrich` | ä¸°å¯Œ | ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾ |
| `embedding` | å‘é‡åµŒå…¥ | ç”Ÿæˆå‘é‡åµŒå…¥ |
| `reason:new` | æ¨ç†ï¼ˆæ–°å»ºï¼‰ | ç”Ÿæˆæ¦‚å¿µå†…å®¹ |
| `ground` | äº‹å®æ ¸æŸ¥ | éªŒè¯å†…å®¹å‡†ç¡®æ€§ |

**æ¯ç§ä»»åŠ¡ç±»å‹çš„é…ç½®é¡¹**ï¼š

- **Provider å’Œæ¨¡å‹**ï¼šé€‰æ‹© Provider å’Œæ¨¡å‹åç§°
- **Temperature**ï¼šæ§åˆ¶ç”Ÿæˆéšæœºæ€§ï¼ˆ0-2ï¼Œä»…é embedding ä»»åŠ¡ï¼‰
- **TopP**ï¼šæ§åˆ¶é‡‡æ ·èŒƒå›´ï¼ˆ0-1ï¼Œä»…é embedding ä»»åŠ¡ï¼‰
- **Reasoning Effort**ï¼šæ¨ç†å¼ºåº¦ï¼ˆlow/medium/highï¼Œä»…é embedding ä»»åŠ¡ï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š

```typescript
taskModels: {
  "standardizeClassify": {
    providerId: "openai",
    model: "gpt-4o",
    temperature: 0.7,
    topP: 1.0,
    reasoning_effort: "medium"
  },
  "embedding": {
    providerId: "openai",
    model: "text-embedding-3-small"
  }
}
```

#### è®¾ç½®éªŒè¯

SettingsTab å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿é…ç½®çš„æœ‰æ•ˆæ€§ï¼š

**1. æ•°å€¼èŒƒå›´éªŒè¯**

```typescript
// ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š0.5-1.0
const num = parseFloat(value);
if (!isNaN(num) && num >= 0.5 && num <= 1.0) {
  await this.plugin.settingsStore.update({ similarityThreshold: num });
}

// å¹¶å‘ä»»åŠ¡æ•°ï¼š1-10
const num = parseInt(value);
if (!isNaN(num) && num > 0 && num <= 10) {
  await this.plugin.settingsStore.update({ concurrency: num });
}
```

**2. Provider é…ç½®éªŒè¯**

- Provider ID ä¸èƒ½ä¸ºç©º
- API ç«¯ç‚¹å¿…é¡»æ˜¯æœ‰æ•ˆçš„ URL
- API å¯†é’¥ä¸èƒ½ä¸ºç©ºï¼ˆå¦‚æœéœ€è¦ï¼‰
- æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º

**3. ç›®å½•æ–¹æ¡ˆéªŒè¯**

- ç›®å½•è·¯å¾„ä¸èƒ½åŒ…å«éæ³•å­—ç¬¦
- ç›®å½•è·¯å¾„ä¸èƒ½ä»¥ `/` å¼€å¤´æˆ–ç»“å°¾

#### å¤šè¯­è¨€æ”¯æŒ

SettingsTab ä½¿ç”¨ i18n ç³»ç»Ÿæä¾›å¤šè¯­è¨€æ”¯æŒï¼š

**è·å–ç¿»è¯‘æ–‡æœ¬**ï¼š

```typescript
const i18n = this.plugin.getI18n();
const t = i18n.t();

// ä½¿ç”¨ç¿»è¯‘æ–‡æœ¬
new Setting(containerEl)
  .setName(t.settings.language.name)
  .setDesc(t.settings.language.desc);
```

**è¯­è¨€åˆ‡æ¢**ï¼š

```typescript
// ç”¨æˆ·åˆ‡æ¢è¯­è¨€æ—¶
await this.plugin.settingsStore.update({ language: lang });
i18n.setLanguage(lang);
new Notice(formatMessage(t.notices.languageChanged, { language: langName }));
this.display(); // åˆ·æ–°è®¾ç½®é¢æ¿ä»¥åº”ç”¨æ–°è¯­è¨€
```

**æ”¯æŒçš„è¯­è¨€**ï¼š

- ä¸­æ–‡ï¼ˆzhï¼‰
- è‹±æ–‡ï¼ˆenï¼‰

#### æ ·å¼è§„èŒƒ

SettingsTab ä½¿ç”¨ä»¥ä¸‹ CSS ç±»å’Œæ ·å¼ï¼š

**CSS ç±»**ï¼š

- `.cr-settings-details`ï¼šå¯æŠ˜å åŒºåŸŸå®¹å™¨
- `.cr-settings-summary`ï¼šå¯æŠ˜å åŒºåŸŸæ ‡é¢˜
- `.cr-settings-header`ï¼šåŒºåŸŸæ ‡é¢˜æ–‡æœ¬
- `.cr-settings-indicator`ï¼šæŠ˜å æŒ‡ç¤ºå™¨ï¼ˆç®­å¤´å›¾æ ‡ï¼‰
- `.cr-settings-content-wrapper`ï¼šåŒºåŸŸå†…å®¹å®¹å™¨

**å¯æŠ˜å åŒºåŸŸæ ·å¼**ï¼š

```css
.cr-settings-details {
  border: 1px solid var(--background-modifier-border);
  border-radius: 4px;
  margin-bottom: 16px;
}

.cr-settings-summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
}

.cr-settings-summary:hover {
  background-color: var(--background-modifier-hover);
}

.cr-settings-indicator {
  transition: transform 0.2s;
}

.cr-settings-details[open] .cr-settings-indicator {
  transform: rotate(90deg);
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š`styles.css` ä¸­çš„ `.cr-settings-*` ç›¸å…³æ ·å¼

#### æ¨¡æ€æ¡†ç»„ä»¶

SettingsTab ä½¿ç”¨ä»¥ä¸‹æ¨¡æ€æ¡†ç»„ä»¶ï¼š

**1. ProviderConfigModal**

ç”¨äºæ·»åŠ å’Œç¼–è¾‘ Provider é…ç½®ã€‚

**å‚æ•°**ï¼š
```typescript
interface ProviderConfigModalOptions {
  mode: "add" | "edit";
  providerId?: string;
  currentConfig?: ProviderConfig;
  onSave: (id: string, config: ProviderConfig) => Promise<void>;
  onCancel: () => void;
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/modals.ts`

---

**2. ConfirmModal**

ç”¨äºæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ã€‚

**å‚æ•°**ï¼š
```typescript
interface ConfirmModalOptions {
  title: string;
  message: string;
  confirmText: string;
  cancelText: string;
  danger?: boolean;
  onConfirm: () => void | Promise<void>;
  onCancel: () => void;
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/modals.ts`

#### å¯¼å…¥å¯¼å‡ºæ ¼å¼

SettingsTab æ”¯æŒé…ç½®çš„å¯¼å…¥å’Œå¯¼å‡ºï¼Œä½¿ç”¨ JSON æ ¼å¼ï¼š

**å¯¼å‡ºæ ¼å¼**ï¼š

```json
{
  "version": "1.0.0",
  "exportedAt": "2025-12-10T12:00:00.000Z",
  "settings": {
    "language": "zh",
    "providers": {
      "openai": {
        "enabled": true,
        "apiEndpoint": "https://api.openai.com/v1",
        "apiKey": "sk-...",
        "defaultChatModel": "gpt-4o",
        "defaultEmbeddingModel": "text-embedding-3-small"
      }
    },
    "defaultProviderId": "openai",
    "similarityThreshold": 0.85,
    "maxSnapshots": 100,
    "maxSnapshotAgeDays": 30,
    "concurrency": 1,
    "advancedMode": false
  }
}
```

**å¯¼å…¥æµç¨‹**ï¼š

1. ç”¨æˆ·ç‚¹å‡»"å¯¼å…¥é…ç½®"æŒ‰é’®
2. æ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
3. è¯»å– JSON æ–‡ä»¶å†…å®¹
4. è°ƒç”¨ `settingsStore.import(jsonString)`
5. SettingsStore éªŒè¯é…ç½®æ ¼å¼
6. åˆå¹¶é…ç½®åˆ°å½“å‰è®¾ç½®
7. ä¿å­˜åˆ° `data.json`
8. åˆ·æ–°è®¾ç½®é¢æ¿

**å¯¼å‡ºæµç¨‹**ï¼š

1. ç”¨æˆ·ç‚¹å‡»"å¯¼å‡ºé…ç½®"æŒ‰é’®
2. è°ƒç”¨ `settingsStore.export()`
3. ç”Ÿæˆ JSON å­—ç¬¦ä¸²
4. åˆ›å»º Blob å¯¹è±¡
5. åˆ›å»ºä¸‹è½½é“¾æ¥
6. è§¦å‘æµè§ˆå™¨ä¸‹è½½
7. æ–‡ä»¶åï¼š`cognitive-razor-settings.json`

#### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**ï¼š

- æµ‹è¯•è®¾ç½®é¡¹æ¸²æŸ“
- æµ‹è¯•è¾“å…¥éªŒè¯
- æµ‹è¯• Provider é…ç½®
- æµ‹è¯•å¯¼å…¥å¯¼å‡º

**é›†æˆæµ‹è¯•**ï¼š

- æµ‹è¯•ä¸ SettingsStore çš„äº¤äº’
- æµ‹è¯•ä¸ ProviderManager çš„äº¤äº’
- æµ‹è¯•æ¨¡æ€æ¡†äº¤äº’

**æµ‹è¯•ç¤ºä¾‹**ï¼š

```typescript
describe('CognitiveRazorSettingTab', () => {
  it('should render all setting sections', () => {
    const tab = new CognitiveRazorSettingTab(app, plugin);
    const container = document.createElement('div');
    tab.containerEl = container;
    tab.display();
    
    expect(container.querySelector('h2')).toBeTruthy();
    expect(container.querySelectorAll('.setting-item').length).toBeGreaterThan(0);
  });
  
  it('should validate similarity threshold', async () => {
    const tab = new CognitiveRazorSettingTab(app, plugin);
    
    // æœ‰æ•ˆå€¼
    await tab.updateSimilarityThreshold(0.85);
    expect(plugin.settings.similarityThreshold).toBe(0.85);
    
    // æ— æ•ˆå€¼ï¼ˆè¶…å‡ºèŒƒå›´ï¼‰
    await tab.updateSimilarityThreshold(1.5);
    expect(plugin.settings.similarityThreshold).toBe(0.85); // ä¸å˜
  });
});
```

**å‚è€ƒæ–‡ä»¶**ï¼š`src/ui/settings-tab.test.ts`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### ä½¿ç”¨ç¤ºä¾‹

**æ³¨å†Œè®¾ç½®é¢æ¿**ï¼š

```typescript
// åœ¨ main.ts çš„ onload() ä¸­
this.addSettingTab(new CognitiveRazorSettingTab(this.app, this));
```

**æ‰“å¼€è®¾ç½®é¢æ¿**ï¼š

```typescript
// ç¨‹åºåŒ–æ‰“å¼€è®¾ç½®é¢æ¿
// @ts-ignore - Obsidian å†…éƒ¨ API
this.app.setting.open();
// @ts-ignore - Obsidian å†…éƒ¨ API
this.app.setting.openTabById(this.manifest.id);
```

**è®¿é—®è®¾ç½®**ï¼š

```typescript
// åœ¨å…¶ä»–ç»„ä»¶ä¸­è®¿é—®è®¾ç½®
const settings = this.plugin.settings;
console.log(`å½“å‰è¯­è¨€: ${settings.language}`);
console.log(`ç›¸ä¼¼åº¦é˜ˆå€¼: ${settings.similarityThreshold}`);
```

---

**éœ€æ±‚éªŒè¯**ï¼š
- âœ… éœ€æ±‚ 3.3ï¼šUI å±‚ç»„ä»¶èŒè´£æè¿°
- âœ… éœ€æ±‚ 3.4ï¼šå…³é”®æ–¹æ³•åˆ—å‡º
- âœ… éœ€æ±‚ 1.3ï¼šç»„ä»¶åç§°ã€èŒè´£æè¿°ã€ä¾èµ–å…³ç³»ã€å…³é”®æ–¹æ³•
- âœ… éœ€æ±‚ A-FUNC-08ï¼šé«˜çº§æ¨¡å¼æ˜¾ç¤ºæ¨¡å‹ã€æ¸©åº¦/TopPã€å»é‡é˜ˆå€¼ã€å¹¶å‘ç­‰å‚æ•°
- âœ… éœ€æ±‚ A-FUNC-02ï¼šå¯é…ç½®çš„å¿«ç…§ä¿ç•™ç­–ç•¥

---

## 7. æ ¸å¿ƒæµç¨‹

### 7.1 æ¦‚å¿µåˆ›å»ºæµç¨‹

æ¦‚å¿µåˆ›å»ºæ˜¯ Cognitive Razor çš„æ ¸å¿ƒåŠŸèƒ½,å°†ç”¨æˆ·è¾“å…¥çš„æ¨¡ç³Šæè¿°è½¬åŒ–ä¸ºç»“æ„åŒ–çš„çŸ¥è¯†èŠ‚ç‚¹ã€‚æ•´ä¸ªæµç¨‹éµå¾ªä¸¥æ ¼çš„é™ç†µä»ªå¼,ç¡®ä¿æ¯ä¸ªæ¦‚å¿µåœ¨ç³»ç»Ÿä¸­æ‹¥æœ‰å”¯ä¸€çš„èº«ä»½ã€å¯éªŒè¯çš„å­˜åœ¨å’Œå®Œæ•´çš„è°±ç³»ã€‚

#### å®Œæ•´æµç¨‹æ­¥éª¤

1. **ç”¨æˆ·è¾“å…¥æ¦‚å¿µæè¿°**
   - ç”¨æˆ·åœ¨ WorkbenchPanel çš„"åˆ›å»ºæ¦‚å¿µ"åŒºåŸŸè¾“å…¥æ¦‚å¿µæè¿°
   - ç³»ç»Ÿè¿›è¡ŒåŸºç¡€è¾“å…¥æ ¡éªŒ(éç©ºã€é•¿åº¦é™åˆ¶ã€å¯ç–‘æŒ‡ä»¤æ£€æµ‹)
   - å‚è€ƒ: `src/ui/workbench-panel.ts`

2. **è°ƒç”¨ `standardizeDirect` è¿›è¡Œæ ‡å‡†åŒ–**
   - PipelineOrchestrator ç›´æ¥è°ƒç”¨ ProviderManager.chat(ä¸è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—)
   - ä½¿ç”¨ `standardizeClassify` æç¤ºè¯æ¨¡æ¿
   - AI è¿”å›æ ‡å‡†åŒ–ç»“æœ,åŒ…å«:
     - æ ‡å‡†åç§°(ä¸­æ–‡å’Œè‹±æ–‡)
     - ç±»å‹ç½®ä¿¡åº¦(Domain/Issue/Theory/Entity/Mechanism)
     - æ ¸å¿ƒå®šä¹‰
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `standardizeDirect()` æ–¹æ³•

3. **ç”¨æˆ·é€‰æ‹©æ¦‚å¿µç±»å‹**
   - UI å±•ç¤º AI æ¨èçš„ç±»å‹åŠç½®ä¿¡åº¦
   - ç”¨æˆ·ä»äº”ç§ç±»å‹ä¸­é€‰æ‹©ä¸€ç§:
     - Domain(é¢†åŸŸ): å®šä¹‰é—®é¢˜è®¨è®ºçš„è¾¹ç•Œ
     - Issue(è®®é¢˜): ä½“ç°æ¨åŠ¨ç†è®ºæ¼”åŒ–çš„å¼ åŠ›
     - Theory(ç†è®º): å½¢æˆä»å…¬ç†åˆ°è§£é‡Šæ¨¡å‹çš„é€»è¾‘è¿‡ç¨‹
     - Entity(å®ä½“): å…·æœ‰å¯è§‚æµ‹å±æ€§çš„å…·ä½“å¯¹è±¡
     - Mechanism(æœºåˆ¶): æè¿°å®ä½“ä¹‹é—´ç›¸äº’ä½œç”¨çš„å› æœè¿‡ç¨‹
   - å‚è€ƒ: `src/ui/workbench-panel.ts`

4. **è°ƒç”¨ `startCreatePipelineWithStandardized` å¯åŠ¨ç®¡çº¿**
   - åˆ›å»ºç®¡çº¿ä¸Šä¸‹æ–‡(PipelineContext),åŒ…å«:
     - pipelineId: ç®¡çº¿å”¯ä¸€æ ‡è¯†
     - nodeId: æ¦‚å¿µå”¯ä¸€æ ‡è¯†(UID)
     - type: ç”¨æˆ·é€‰æ‹©çš„æ¦‚å¿µç±»å‹
     - standardizedData: æ ‡å‡†åŒ–ç»“æœ
     - stage: å½“å‰é˜¶æ®µ(åˆå§‹ä¸º "enriching")
   - ç®¡çº¿è¿›å…¥ enriching é˜¶æ®µ
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `startCreatePipelineWithStandardized()` æ–¹æ³•

5. **æ‰§è¡Œ enrich ä»»åŠ¡(ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾)**
   - TaskQueue å°† enrich ä»»åŠ¡å…¥é˜Ÿ
   - TaskRunner æ‰§è¡Œä»»åŠ¡:
     - åŠ è½½ `enrich` æç¤ºè¯æ¨¡æ¿
     - è°ƒç”¨ AI API ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾
     - éªŒè¯è¾“å‡ºæ ¼å¼
   - ä»»åŠ¡å®Œæˆå,ç®¡çº¿ä¸Šä¸‹æ–‡æ›´æ–° enrichedData
   - å‚è€ƒ: `src/core/task-runner.ts`

6. **æ‰§è¡Œ embedding ä»»åŠ¡(ç”Ÿæˆå‘é‡åµŒå…¥)**
   - æ³¨æ„: embedding ä¸è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—,ç›´æ¥æ‰§è¡Œ
   - æ„å»ºåµŒå…¥æ–‡æœ¬: æ ‡å‡†åç§° + æ ¸å¿ƒå®šä¹‰ + ç±»å‹ + æ ‡ç­¾
   - è°ƒç”¨ ProviderManager.embed() ç”Ÿæˆå‘é‡åµŒå…¥
   - ç®¡çº¿ä¸Šä¸‹æ–‡æ›´æ–° embedding
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `executeEmbeddingDirect()` æ–¹æ³•

7. **ç”¨æˆ·ç¡®è®¤åˆ›å»º(`confirmCreate`)**
   - ç®¡çº¿è¿›å…¥ "awaiting_create_confirm" é˜¶æ®µ
   - ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨ confirmCreate(æ— éœ€ UI äº¤äº’)
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreate()` æ–¹æ³•

8. **åˆ›å»º Stub æ–‡ä»¶(ä»… frontmatter)**
   - ç”Ÿæˆæ¦‚å¿µç­¾å(æ ‡å‡†åç§°)
   - ç”Ÿæˆç›®æ ‡æ–‡ä»¶è·¯å¾„(æ ¹æ®ç›®å½•æ–¹æ¡ˆå’Œç±»å‹)
   - åˆ›å»ºå¿«ç…§(ç©ºå†…å®¹,å› ä¸ºæ˜¯æ–°æ–‡ä»¶)
   - ç”Ÿæˆ Frontmatter:
     - uid: æ¦‚å¿µå”¯ä¸€æ ‡è¯†
     - type: æ¦‚å¿µç±»å‹
     - status: "Stub"(å­˜æ ¹çŠ¶æ€)
     - aliases: åˆ«ååˆ—è¡¨
     - tags: æ ‡ç­¾åˆ—è¡¨
     - created: åˆ›å»ºæ—¶é—´
     - updated: æ›´æ–°æ—¶é—´
   - ä½¿ç”¨åŸå­å†™å…¥åˆ›å»ºæ–‡ä»¶(ä»…åŒ…å« Frontmatter,æ— æ­£æ–‡)
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `createStubFile()` æ–¹æ³•

9. **æ‰§è¡Œ reason:new ä»»åŠ¡(ç”Ÿæˆå†…å®¹)**
   - TaskQueue å°† reason:new ä»»åŠ¡å…¥é˜Ÿ
   - TaskRunner æ‰§è¡Œä»»åŠ¡:
     - åŠ è½½å¯¹åº”ç±»å‹çš„ `reason-{type}` æç¤ºè¯æ¨¡æ¿
     - è°ƒç”¨ AI API ç”Ÿæˆæ¦‚å¿µå†…å®¹
     - éªŒè¯è¾“å‡ºæ ¼å¼
   - ä»»åŠ¡å®Œæˆå,ç®¡çº¿ä¸Šä¸‹æ–‡æ›´æ–° generatedContent
   - å‚è€ƒ: `src/core/task-runner.ts`

10. **æ›´æ–°æ–‡ä»¶ä¸º Draft çŠ¶æ€**
    - è¯»å– Stub æ–‡ä»¶å†…å®¹
    - è§£æ Frontmatter
    - æ›´æ–° status ä¸º "Draft"
    - æ›´æ–° updated æ—¶é—´æˆ³
    - æ¸²æŸ“ç”Ÿæˆçš„å†…å®¹ä¸º Markdown æ ¼å¼
    - åˆ›å»ºå¿«ç…§(ä¿å­˜ Stub çŠ¶æ€)
    - ä½¿ç”¨åŸå­å†™å…¥æ›´æ–°æ–‡ä»¶(åŒ…å« Frontmatter å’Œæ­£æ–‡)
    - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreateWrite()` æ–¹æ³•

11. **æ‰§è¡Œå»é‡æ£€æµ‹**
    - ä½¿ç”¨ç”Ÿæˆçš„å‘é‡åµŒå…¥åœ¨ VectorIndex ä¸­æœç´¢ç›¸ä¼¼æ¦‚å¿µ
    - ä»…åœ¨åŒç±»å‹æ¡¶å†…æœç´¢(é¿å…è·¨ç±»å‹è¯¯åˆ¤)
    - è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
    - æ ¹æ®é˜ˆå€¼åˆ¤æ–­æ˜¯å¦é‡å¤:
      - ç›¸ä¼¼åº¦ >= 0.95: é˜»æ–­é˜ˆå€¼,è‡ªåŠ¨æ‹’ç»
      - ç›¸ä¼¼åº¦ >= 0.85: æç¤ºé˜ˆå€¼,æäº¤äººç±»è£å†³
    - åˆ›å»ºé‡å¤å¯¹è®°å½•(å¦‚æœæ£€æµ‹åˆ°é‡å¤)
    - æŒä¹…åŒ–é‡å¤å¯¹åˆ—è¡¨åˆ° `data/duplicate-pairs.json`
    - é€šçŸ¥ UI æ›´æ–°
    - å‚è€ƒ: `src/core/duplicate-manager.ts` çš„ `detect()` æ–¹æ³•

#### æµç¨‹å›¾

```mermaid
flowchart TD
    Start([ç”¨æˆ·è¾“å…¥æ¦‚å¿µæè¿°]) --> Validate{è¾“å…¥éªŒè¯}
    Validate -->|æ— æ•ˆ| Error[æ˜¾ç¤ºé”™è¯¯æç¤º]
    Validate -->|æœ‰æ•ˆ| Standardize[æ ‡å‡†åŒ–<br/>standardizeDirect]
    
    Standardize --> TypeSelect[ç”¨æˆ·é€‰æ‹©ç±»å‹]
    TypeSelect --> StartPipeline[å¯åŠ¨ç®¡çº¿<br/>startCreatePipelineWithStandardized]
    
    StartPipeline --> Enrich[enrich ä»»åŠ¡<br/>ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾]
    Enrich --> Embedding[embedding ä»»åŠ¡<br/>ç”Ÿæˆå‘é‡åµŒå…¥]
    Embedding --> ConfirmCreate[è‡ªåŠ¨ç¡®è®¤åˆ›å»º<br/>confirmCreate]
    
    ConfirmCreate --> CreateStub[åˆ›å»º Stub æ–‡ä»¶<br/>ä»… frontmatter]
    CreateStub --> Snapshot1[åˆ›å»ºå¿«ç…§<br/>ç©ºå†…å®¹]
    Snapshot1 --> WriteStub[åŸå­å†™å…¥ Stub]
    
    WriteStub --> ReasonNew[reason:new ä»»åŠ¡<br/>ç”Ÿæˆå†…å®¹]
    ReasonNew --> UpdateDraft[æ›´æ–°ä¸º Draft çŠ¶æ€]
    UpdateDraft --> Snapshot2[åˆ›å»ºå¿«ç…§<br/>Stub çŠ¶æ€]
    Snapshot2 --> WriteDraft[åŸå­å†™å…¥ Draft]
    
    WriteDraft --> UpdateIndex[æ›´æ–°å‘é‡ç´¢å¼•]
    UpdateIndex --> Dedup[å»é‡æ£€æµ‹]
    
    Dedup --> DupCheck{æ˜¯å¦é‡å¤?}
    DupCheck -->|æ˜¯| DupUI[æ˜¾ç¤ºé‡å¤æç¤º]
    DupCheck -->|å¦| Complete[åˆ›å»ºå®Œæˆ]
    
    DupUI --> DupDecision{ç”¨æˆ·å†³ç­–}
    DupDecision -->|åˆå¹¶| Merge[å¯åŠ¨åˆå¹¶æµç¨‹]
    DupDecision -->|å¿½ç•¥| Complete
    
    Error --> End([æµç¨‹ç»“æŸ])
    Complete --> End
    Merge --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Error fill:#ffcdd2
```

#### ç»„ä»¶äº¤äº’æ—¶åºå›¾

ä»¥ä¸‹æ—¶åºå›¾å±•ç¤ºäº†æ¦‚å¿µåˆ›å»ºæµç¨‹ä¸­å„ç»„ä»¶ä¹‹é—´çš„äº¤äº’å’Œæ¶ˆæ¯ä¼ é€’ï¼š

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant UI as WorkbenchPanel
    participant Pipeline as PipelineOrchestrator
    participant Queue as TaskQueue
    participant Runner as TaskRunner
    participant Provider as ProviderManager
    participant Validator as Validator
    participant Vector as VectorIndex
    participant Dup as DuplicateManager
    participant Undo as UndoManager
    participant Storage as FileStorage
    
    User->>UI: è¾“å…¥æ¦‚å¿µæè¿°
    UI->>UI: è¾“å…¥éªŒè¯
    UI->>Pipeline: standardizeDirect(description)
    Pipeline->>Provider: chat(standardizeClassify)
    Provider->>Provider: è°ƒç”¨ AI API
    Provider-->>Pipeline: æ ‡å‡†åŒ–ç»“æœ
    Pipeline-->>UI: è¿”å›æ ‡å‡†åŒ–ç»“æœ
    
    UI->>User: å±•ç¤ºç±»å‹é€‰é¡¹
    User->>UI: é€‰æ‹©æ¦‚å¿µç±»å‹
    UI->>Pipeline: startCreatePipelineWithStandardized(type, data)
    Pipeline->>Pipeline: åˆ›å»ºç®¡çº¿ä¸Šä¸‹æ–‡
    
    Note over Pipeline,Queue: Enrich é˜¶æ®µ
    Pipeline->>Queue: enqueue(enrich ä»»åŠ¡)
    Queue->>Queue: æ£€æŸ¥é”å†²çª
    Queue->>Queue: è·å–èŠ‚ç‚¹é”
    Queue->>Runner: run(enrich ä»»åŠ¡)
    Runner->>Provider: chat(enrich)
    Provider-->>Runner: åˆ«åå’Œæ ‡ç­¾
    Runner->>Validator: validate(è¾“å‡º)
    Validator-->>Runner: éªŒè¯é€šè¿‡
    Runner-->>Queue: ä»»åŠ¡å®Œæˆ
    Queue->>Queue: é‡Šæ”¾èŠ‚ç‚¹é”
    Queue-->>Pipeline: ä»»åŠ¡å®Œæˆäº‹ä»¶
    
    Note over Pipeline,Provider: Embedding é˜¶æ®µ
    Pipeline->>Provider: embed(æ ‡å‡†åç§°+å®šä¹‰)
    Provider-->>Pipeline: å‘é‡åµŒå…¥
    
    Note over Pipeline,Storage: åˆ›å»º Stub æ–‡ä»¶
    Pipeline->>Undo: createSnapshot(ç©ºå†…å®¹)
    Undo->>Storage: atomicWrite(å¿«ç…§)
    Storage-->>Undo: å¿«ç…§ ID
    Undo-->>Pipeline: å¿«ç…§ ID
    Pipeline->>Storage: atomicWrite(Stub æ–‡ä»¶)
    Storage-->>Pipeline: å†™å…¥æˆåŠŸ
    
    Note over Pipeline,Queue: Reason é˜¶æ®µ
    Pipeline->>Queue: enqueue(reason:new ä»»åŠ¡)
    Queue->>Queue: è·å–èŠ‚ç‚¹é”
    Queue->>Runner: run(reason:new ä»»åŠ¡)
    Runner->>Provider: chat(reason-{type})
    Provider-->>Runner: ç”Ÿæˆå†…å®¹
    Runner->>Validator: validate(è¾“å‡º)
    Validator-->>Runner: éªŒè¯é€šè¿‡
    Runner-->>Queue: ä»»åŠ¡å®Œæˆ
    Queue->>Queue: é‡Šæ”¾èŠ‚ç‚¹é”
    Queue-->>Pipeline: ä»»åŠ¡å®Œæˆäº‹ä»¶
    
    Note over Pipeline,Storage: æ›´æ–°ä¸º Draft
    Pipeline->>Undo: createSnapshot(Stub å†…å®¹)
    Undo->>Storage: atomicWrite(å¿«ç…§)
    Storage-->>Undo: å¿«ç…§ ID
    Undo-->>Pipeline: å¿«ç…§ ID
    Pipeline->>Storage: atomicWrite(Draft æ–‡ä»¶)
    Storage-->>Pipeline: å†™å…¥æˆåŠŸ
    
    Note over Pipeline,Dup: å»é‡æ£€æµ‹
    Pipeline->>Vector: upsert(nodeId, embedding)
    Vector->>Storage: write(ç´¢å¼•æ–‡ä»¶)
    Storage-->>Vector: å†™å…¥æˆåŠŸ
    Vector-->>Pipeline: ç´¢å¼•æ›´æ–°æˆåŠŸ
    Pipeline->>Dup: detect(nodeId, type)
    Dup->>Vector: search(embedding, type)
    Vector-->>Dup: ç›¸ä¼¼æ¦‚å¿µåˆ—è¡¨
    Dup->>Dup: è®¡ç®—ç›¸ä¼¼åº¦
    Dup->>Storage: write(é‡å¤å¯¹åˆ—è¡¨)
    Storage-->>Dup: å†™å…¥æˆåŠŸ
    Dup-->>Pipeline: æ£€æµ‹å®Œæˆ
    
    Pipeline-->>UI: ç®¡çº¿å®Œæˆäº‹ä»¶
    UI->>User: æ˜¾ç¤ºåˆ›å»ºæˆåŠŸ
```

**æ—¶åºå›¾è¯´æ˜**ï¼š

1. **æ ‡å‡†åŒ–é˜¶æ®µ**ï¼š
   - UI æ¥æ”¶ç”¨æˆ·è¾“å…¥å¹¶éªŒè¯
   - Pipeline ç›´æ¥è°ƒç”¨ Providerï¼ˆä¸ç»è¿‡é˜Ÿåˆ—ï¼‰
   - è¿”å›æ ‡å‡†åŒ–ç»“æœä¾›ç”¨æˆ·é€‰æ‹©ç±»å‹

2. **Enrich é˜¶æ®µ**ï¼š
   - Pipeline å°† enrich ä»»åŠ¡å…¥é˜Ÿ
   - Queue æ£€æŸ¥é”å†²çªå¹¶è·å–èŠ‚ç‚¹é”
   - Runner æ‰§è¡Œä»»åŠ¡ï¼Œè°ƒç”¨ AI API
   - Validator éªŒè¯è¾“å‡ºæ ¼å¼
   - Queue é‡Šæ”¾é”å¹¶é€šçŸ¥ Pipeline

3. **Embedding é˜¶æ®µ**ï¼š
   - Pipeline ç›´æ¥è°ƒç”¨ Providerï¼ˆä¸ç»è¿‡é˜Ÿåˆ—ï¼‰
   - ç”Ÿæˆå‘é‡åµŒå…¥ç”¨äºåç»­å»é‡

4. **åˆ›å»º Stub æ–‡ä»¶**ï¼š
   - Undo åˆ›å»ºç©ºå†…å®¹å¿«ç…§
   - Storage åŸå­å†™å…¥ Stub æ–‡ä»¶

5. **Reason é˜¶æ®µ**ï¼š
   - Pipeline å°† reason:new ä»»åŠ¡å…¥é˜Ÿ
   - æµç¨‹ä¸ Enrich é˜¶æ®µç±»ä¼¼
   - ç”Ÿæˆæ¦‚å¿µå†…å®¹

6. **æ›´æ–°ä¸º Draft**ï¼š
   - Undo åˆ›å»º Stub çŠ¶æ€å¿«ç…§
   - Storage åŸå­å†™å…¥ Draft æ–‡ä»¶

7. **å»é‡æ£€æµ‹**ï¼š
   - Vector æ›´æ–°ç´¢å¼•
   - Dup æœç´¢ç›¸ä¼¼æ¦‚å¿µ
   - è®¡ç®—ç›¸ä¼¼åº¦å¹¶åˆ›å»ºé‡å¤å¯¹è®°å½•

**å…³é”®æ¶ˆæ¯**ï¼š

- **å®çº¿ç®­å¤´**ï¼šåŒæ­¥è°ƒç”¨ï¼Œè°ƒç”¨è€…ç­‰å¾…è¿”å›
- **è™šçº¿ç®­å¤´**ï¼šå¼‚æ­¥è¿”å›ï¼Œè¿”å›ç»“æœæˆ–äº‹ä»¶
- **Note**ï¼šæ ‡æ³¨å½“å‰é˜¶æ®µæˆ–å…³é”®æ“ä½œ

#### å…³é”®è®¾è®¡å†³ç­–

**1. æ ‡å‡†åŒ–ä¸è¿›å…¥é˜Ÿåˆ—**

æ ‡å‡†åŒ–é˜¶æ®µç›´æ¥è°ƒç”¨ AI API,ä¸è¿›å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚åŸå› :
- æ ‡å‡†åŒ–æ˜¯äº¤äº’å¼æµç¨‹,éœ€è¦ç«‹å³è¿”å›ç»“æœä¾›ç”¨æˆ·é€‰æ‹©ç±»å‹
- é¿å…é˜Ÿåˆ—ç­‰å¾…å½±å“ç”¨æˆ·ä½“éªŒ
- æ ‡å‡†åŒ–å¤±è´¥ä¸å½±å“ç³»ç»ŸçŠ¶æ€,å¯ä»¥å®‰å…¨é‡è¯•

**2. Stub â†’ Draft ä¸¤é˜¶æ®µå†™å…¥**

æ¦‚å¿µåˆ›å»ºåˆ†ä¸ºä¸¤æ¬¡å†™å…¥:
- ç¬¬ä¸€æ¬¡å†™å…¥ Stub(ä»… Frontmatter): ç¡®ä¿æ¦‚å¿µèº«ä»½å·²ç¡®ç«‹
- ç¬¬äºŒæ¬¡å†™å…¥ Draft(åŒ…å«æ­£æ–‡): å¡«å……æ¦‚å¿µå†…å®¹

è¿™ç§è®¾è®¡çš„ä¼˜åŠ¿:
- å³ä½¿å†…å®¹ç”Ÿæˆå¤±è´¥,æ¦‚å¿µèº«ä»½å·²å­˜åœ¨,å¯ä»¥åç»­è¡¥å……
- æ”¯æŒæ¸è¿›å¼å†…å®¹å¡«å……(Stub â†’ Draft â†’ Evergreen)
- æ¯æ¬¡å†™å…¥éƒ½åˆ›å»ºå¿«ç…§,æ”¯æŒç²¾ç»†åŒ–æ’¤é”€

**3. è‡ªåŠ¨ç¡®è®¤åˆ›å»º**

enrich å®Œæˆåè‡ªåŠ¨ç¡®è®¤åˆ›å»º,æ— éœ€ç”¨æˆ·äº¤äº’ã€‚åŸå› :
- ç”¨æˆ·å·²åœ¨ç±»å‹é€‰æ‹©é˜¶æ®µåšå‡ºå†³ç­–
- å‡å°‘ä¸å¿…è¦çš„ç¡®è®¤æ­¥éª¤,æå‡æµç•…åº¦
- å†™å…¥å‰ä»ä¼šåˆ›å»ºå¿«ç…§,æ”¯æŒæ’¤é”€

**4. å»é‡æ£€æµ‹åœ¨æœ€å**

å»é‡æ£€æµ‹åœ¨æ–‡ä»¶å†™å…¥åæ‰§è¡Œ,è€Œéå†™å…¥å‰ã€‚åŸå› :
- ç¡®ä¿æ¦‚å¿µå·²å®Œæ•´åˆ›å»º,é¿å…ä¸­é€”å¤±è´¥å¯¼è‡´ä¸ä¸€è‡´
- å»é‡æ£€æµ‹ç»“æœä¸é˜»å¡åˆ›å»ºæµç¨‹,ä»…ä½œä¸ºæç¤º
- ç”¨æˆ·å¯ä»¥é€‰æ‹©åˆå¹¶æˆ–å¿½ç•¥,ä¿æŒçµæ´»æ€§

#### é”™è¯¯å¤„ç†

**æ ‡å‡†åŒ–å¤±è´¥**
- é”™è¯¯ç : E100-E102(ç½‘ç»œé”™è¯¯) æˆ– E001-E010(å†…å®¹é”™è¯¯)
- å¤„ç†: æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯,å…è®¸ç”¨æˆ·é‡è¯•
- ä¸å½±å“ç³»ç»ŸçŠ¶æ€

**ä»»åŠ¡æ‰§è¡Œå¤±è´¥**
- é”™è¯¯ç : æ ¹æ®å¤±è´¥åŸå› åˆ†ç±»
- å¤„ç†: æ ¹æ®é‡è¯•ç­–ç•¥è‡ªåŠ¨é‡è¯•æˆ–æ ‡è®°ä¸ºå¤±è´¥
- ç®¡çº¿çŠ¶æ€æ›´æ–°ä¸º "failed"
- ç”¨æˆ·å¯ä»¥åœ¨ WorkbenchPanel æŸ¥çœ‹å¤±è´¥åŸå› 

**æ–‡ä»¶å†™å…¥å¤±è´¥**
- é”™è¯¯ç : E300-E304(ç³»ç»Ÿé”™è¯¯)
- å¤„ç†: å›æ»šæ“ä½œ,æ¢å¤å¿«ç…§
- é€šçŸ¥ç”¨æˆ·å†™å…¥å¤±è´¥,æä¾›é‡è¯•é€‰é¡¹

**å‚è€ƒæ–‡ä»¶**:
- `src/core/pipeline-orchestrator.ts`: ç®¡çº¿ç¼–æ’é€»è¾‘
- `src/core/task-queue.ts`: ä»»åŠ¡è°ƒåº¦é€»è¾‘
- `src/core/task-runner.ts`: ä»»åŠ¡æ‰§è¡Œé€»è¾‘
- `src/core/duplicate-manager.ts`: å»é‡æ£€æµ‹é€»è¾‘
- `src/core/undo-manager.ts`: å¿«ç…§ç®¡ç†é€»è¾‘

### 7.2 ä»»åŠ¡è°ƒåº¦æµç¨‹

ä»»åŠ¡è°ƒåº¦æ˜¯ Cognitive Razor çš„æ ¸å¿ƒæœºåˆ¶,è´Ÿè´£ç®¡ç†æ‰€æœ‰å¼‚æ­¥æ“ä½œçš„æ‰§è¡Œé¡ºåºã€å¹¶å‘æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†ã€‚TaskQueue ä½œä¸ºå…¨å±€ä»»åŠ¡è°ƒåº¦å™¨,ç¡®ä¿æ‰€æœ‰å†™å…¥æ“ä½œçš„ä¸²è¡ŒåŒ–å’Œå¯è¿½æº¯æ€§ã€‚

#### å®Œæ•´è°ƒåº¦é€»è¾‘

1. **ä»»åŠ¡å…¥é˜Ÿ(`enqueue`)**
   - ç»„ä»¶(å¦‚ PipelineOrchestrator)åˆ›å»ºä»»åŠ¡è®°å½•(TaskRecord)
   - ä»»åŠ¡è®°å½•åŒ…å«:
     - id: ä»»åŠ¡å”¯ä¸€æ ‡è¯†(è‡ªåŠ¨ç”Ÿæˆ)
     - nodeId: å…³è”çš„æ¦‚å¿µ UID
     - taskType: ä»»åŠ¡ç±»å‹(standardizeClassify/enrich/embedding/reason:new/ground)
     - state: ä»»åŠ¡çŠ¶æ€(åˆå§‹ä¸º "Pending")
     - providerRef: Provider æ ‡è¯†
     - payload: ä»»åŠ¡å‚æ•°
     - attempt: å½“å‰å°è¯•æ¬¡æ•°
     - maxAttempts: æœ€å¤§é‡è¯•æ¬¡æ•°
   - è°ƒç”¨ TaskQueue.enqueue() å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `enqueue()` æ–¹æ³•

2. **æ£€æŸ¥é”å†²çª(èŠ‚ç‚¹é”å’Œç±»å‹é”)**
   - **èŠ‚ç‚¹é”æ£€æŸ¥**: æ£€æŸ¥ nodeId æ˜¯å¦å·²è¢«é”å®š
     - é˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘æ“ä½œ
     - éµå¾ª A-FUNC-01: åŒä¸€ nodeId ä¸èƒ½é‡å¤å…¥é˜Ÿ
   - **ç±»å‹é”æ£€æŸ¥**: æ£€æŸ¥ `type:{crType}` æ˜¯å¦å·²è¢«é”å®š
     - ç”¨äºå»é‡æ£€æµ‹ç­‰éœ€è¦ç±»å‹çº§åˆ«é”çš„åœºæ™¯
     - é˜²æ­¢åŒç±»å‹æ¦‚å¿µçš„å¹¶å‘å»é‡æ“ä½œ
   - å¦‚æœå­˜åœ¨é”å†²çª,è¿”å›é”™è¯¯,ä»»åŠ¡ä¸å…¥é˜Ÿ
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `enqueue()` æ–¹æ³•

3. **æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€**
   - ä»»åŠ¡å…¥é˜ŸæˆåŠŸå,ç«‹å³æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€åˆ° `data/queue-state.json`
   - é˜Ÿåˆ—çŠ¶æ€åŒ…å«:
     - version: é˜Ÿåˆ—çŠ¶æ€æ–‡ä»¶ç‰ˆæœ¬
     - tasks: æ‰€æœ‰ä»»åŠ¡è®°å½•
     - concurrency: å¹¶å‘é™åˆ¶
     - paused: æ˜¯å¦æš‚åœ
     - stats: ç»Ÿè®¡ä¿¡æ¯
     - locks: æ´»è·ƒé”åˆ—è¡¨
   - ä½¿ç”¨åŸå­å†™å…¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `saveQueue()` æ–¹æ³•

4. **è°ƒåº¦å™¨è½®è¯¢(æ¯ç§’ä¸€æ¬¡)**
   - TaskQueue å¯åŠ¨æ—¶åˆ›å»ºè°ƒåº¦å™¨å®šæ—¶å™¨(setInterval)
   - æ¯ç§’è°ƒç”¨ä¸€æ¬¡ `scheduleNextTask()`
   - è°ƒåº¦å™¨æ£€æŸ¥:
     - é˜Ÿåˆ—æ˜¯å¦æš‚åœ
     - TaskRunner æ˜¯å¦å·²æ³¨å…¥
     - æ˜¯å¦æœ‰ Pending çŠ¶æ€çš„ä»»åŠ¡
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `startScheduler()` å’Œ `scheduleNextTask()` æ–¹æ³•

5. **æ£€æŸ¥å¹¶å‘é™åˆ¶**
   - è·å–å½“å‰è¿è¡Œä»»åŠ¡æ•°(processingTasks.size)
   - è·å–å¹¶å‘é™åˆ¶(settings.concurrency)
   - å¦‚æœå·²è¾¾åˆ°å¹¶å‘ä¸Šé™,è·³è¿‡æœ¬è½®è°ƒåº¦
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `scheduleNextTask()` æ–¹æ³•

6. **è·å–é”**
   - éå† Pending ä»»åŠ¡,æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è°ƒåº¦çš„ä»»åŠ¡
   - å°è¯•è·å–èŠ‚ç‚¹é”: `lockManager.acquire(nodeId, "node", taskId)`
   - å¦‚æœèŠ‚ç‚¹é”å†²çª,è·³è¿‡è¯¥ä»»åŠ¡,ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
   - å°è¯•è·å–ç±»å‹é”(å¦‚æœéœ€è¦): `lockManager.acquire("type:{crType}", "type", taskId)`
   - å¦‚æœç±»å‹é”å†²çª,é‡Šæ”¾èŠ‚ç‚¹é”,è·³è¿‡è¯¥ä»»åŠ¡
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `scheduleNextTask()` æ–¹æ³•

7. **æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º Running**
   - æ ‡è®°ä»»åŠ¡ä¸ºå¤„ç†ä¸­: `processingTasks.add(taskId)`
   - æ›´æ–°ä»»åŠ¡çŠ¶æ€: `task.state = "Running"`
   - è®°å½•å¼€å§‹æ—¶é—´: `task.startedAt = new Date().toISOString()`
   - ä¿å­˜é”å¼•ç”¨: `task.lockKey = lockKey`, `task.typeLockKey = typeLockKey`
   - æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
   - å‘å¸ƒ "task-started" äº‹ä»¶
   - è®°å½•ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¥å¿—(TASK_STATE_CHANGE)
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `scheduleNextTask()` æ–¹æ³•

8. **è°ƒç”¨ TaskRunner æ‰§è¡Œä»»åŠ¡**
   - å¼‚æ­¥è°ƒç”¨ `taskRunner.run(task)`
   - ä¸é˜»å¡è°ƒåº¦å™¨,å…è®¸ç»§ç»­è°ƒåº¦å…¶ä»–ä»»åŠ¡
   - TaskRunner æ‰§è¡Œæµç¨‹:
     - åŠ è½½æç¤ºè¯æ¨¡æ¿(PromptManager)
     - æ„å»º Prompt(å¡«å……æ§½ä½)
     - è°ƒç”¨ AI API(ProviderManager)
     - éªŒè¯è¾“å‡º(Validator)
     - å¤„ç†ç»“æœ
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `executeTask()` æ–¹æ³•

9. **å¤„ç†æ‰§è¡Œç»“æœ(æˆåŠŸ/å¤±è´¥/é‡è¯•)**
   - **æˆåŠŸ**: è°ƒç”¨ `handleTaskSuccess()`
     - æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º "Completed"
     - è®°å½•å®Œæˆæ—¶é—´
     - ä¿å­˜ä»»åŠ¡ç»“æœ
     - é‡Šæ”¾é”
     - æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
     - å‘å¸ƒ "task-completed" äº‹ä»¶
   - **å¤±è´¥**: è°ƒç”¨ `handleTaskFailure()`
     - è®°å½•é”™è¯¯ä¿¡æ¯
     - ä½¿ç”¨ RetryHandler åˆ†ç±»é”™è¯¯
     - æ ¹æ®é‡è¯•ç­–ç•¥å†³å®šæ˜¯å¦é‡è¯•:
       - å†…å®¹é”™è¯¯(E001-E010): æœ€å¤šé‡è¯• 3 æ¬¡
       - ç½‘ç»œé”™è¯¯(E100-E102): æœ€å¤šé‡è¯• 5 æ¬¡,æŒ‡æ•°é€€é¿
       - ç»ˆæ­¢é”™è¯¯: ä¸é‡è¯•
     - å¦‚æœé‡è¯•: æ›´æ–°çŠ¶æ€ä¸º "Pending",é‡Šæ”¾é”
     - å¦‚æœä¸é‡è¯•: æ›´æ–°çŠ¶æ€ä¸º "Failed",é‡Šæ”¾é”,å‘å¸ƒ "task-failed" äº‹ä»¶
   - å‚è€ƒ: `src/core/task-queue.ts` çš„ `handleTaskSuccess()` å’Œ `handleTaskFailure()` æ–¹æ³•

10. **é‡Šæ”¾é”**
    - é‡Šæ”¾èŠ‚ç‚¹é”: `lockManager.release(task.lockKey)`
    - é‡Šæ”¾ç±»å‹é”: `lockManager.release(task.typeLockKey)`
    - æ¸…é™¤ä»»åŠ¡çš„é”å¼•ç”¨
    - å‚è€ƒ: `src/core/task-queue.ts` çš„ `releaseTaskLocks()` æ–¹æ³•

11. **æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€**
    - ä»»åŠ¡çŠ¶æ€å˜æ›´å,å†æ¬¡æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
    - ç¡®ä¿é˜Ÿåˆ—çŠ¶æ€ä¸å®é™…æ‰§è¡ŒçŠ¶æ€ä¸€è‡´
    - æ”¯æŒæ–­ç”µæ¢å¤
    - å‚è€ƒ: `src/core/task-queue.ts` çš„ `saveQueue()` æ–¹æ³•

#### æµç¨‹å›¾

```mermaid
flowchart TD
    Start([ä»»åŠ¡åˆ›å»º]) --> Enqueue[ä»»åŠ¡å…¥é˜Ÿ<br/>enqueue]
    
    Enqueue --> NodeLockCheck{æ£€æŸ¥èŠ‚ç‚¹é”}
    NodeLockCheck -->|å†²çª| EnqueueError[è¿”å›é”™è¯¯<br/>ä»»åŠ¡ä¸å…¥é˜Ÿ]
    NodeLockCheck -->|æ— å†²çª| TypeLockCheck{æ£€æŸ¥ç±»å‹é”}
    
    TypeLockCheck -->|å†²çª| EnqueueError
    TypeLockCheck -->|æ— å†²çª| Persist1[æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€<br/>queue-state.json]
    
    Persist1 --> Wait[ç­‰å¾…è°ƒåº¦å™¨è½®è¯¢]
    Wait --> Schedule[è°ƒåº¦å™¨è½®è¯¢<br/>æ¯ç§’ä¸€æ¬¡]
    
    Schedule --> PauseCheck{é˜Ÿåˆ—æ˜¯å¦æš‚åœ?}
    PauseCheck -->|æ˜¯| Wait
    PauseCheck -->|å¦| RunnerCheck{TaskRunner<br/>æ˜¯å¦æ³¨å…¥?}
    
    RunnerCheck -->|å¦| Wait
    RunnerCheck -->|æ˜¯| ConcCheck{æ£€æŸ¥å¹¶å‘é™åˆ¶}
    
    ConcCheck -->|å·²è¾¾ä¸Šé™| Wait
    ConcCheck -->|æœªè¾¾ä¸Šé™| FindTask[æŸ¥æ‰¾ Pending ä»»åŠ¡]
    
    FindTask --> HasTask{æœ‰å¯è°ƒåº¦ä»»åŠ¡?}
    HasTask -->|å¦| Wait
    HasTask -->|æ˜¯| AcquireNodeLock[è·å–èŠ‚ç‚¹é”]
    
    AcquireNodeLock --> NodeLockOK{èŠ‚ç‚¹é”è·å–æˆåŠŸ?}
    NodeLockOK -->|å¦| FindTask
    NodeLockOK -->|æ˜¯| NeedTypeLock{éœ€è¦ç±»å‹é”?}
    
    NeedTypeLock -->|å¦| UpdateRunning
    NeedTypeLock -->|æ˜¯| AcquireTypeLock[è·å–ç±»å‹é”]
    
    AcquireTypeLock --> TypeLockOK{ç±»å‹é”è·å–æˆåŠŸ?}
    TypeLockOK -->|å¦| ReleaseNodeLock[é‡Šæ”¾èŠ‚ç‚¹é”]
    ReleaseNodeLock --> FindTask
    TypeLockOK -->|æ˜¯| UpdateRunning[æ›´æ–°çŠ¶æ€ä¸º Running]
    
    UpdateRunning --> Persist2[æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€]
    Persist2 --> PublishStart[å‘å¸ƒ task-started äº‹ä»¶]
    PublishStart --> Execute[TaskRunner æ‰§è¡Œä»»åŠ¡]
    
    Execute --> ExecuteResult{æ‰§è¡Œç»“æœ}
    ExecuteResult -->|æˆåŠŸ| HandleSuccess[å¤„ç†æˆåŠŸ<br/>handleTaskSuccess]
    ExecuteResult -->|å¤±è´¥| ClassifyError[åˆ†ç±»é”™è¯¯<br/>RetryHandler]
    
    ClassifyError --> ShouldRetry{æ˜¯å¦é‡è¯•?}
    ShouldRetry -->|æ˜¯| ResetPending[é‡ç½®ä¸º Pending]
    ShouldRetry -->|å¦| HandleFailed[æ ‡è®°ä¸º Failed]
    
    HandleSuccess --> ReleaseLocks[é‡Šæ”¾é”]
    ResetPending --> ReleaseLocks
    HandleFailed --> ReleaseLocks
    
    ReleaseLocks --> Persist3[æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€]
    Persist3 --> PublishEvent[å‘å¸ƒäº‹ä»¶]
    PublishEvent --> End([ä»»åŠ¡ç»“æŸ])
    
    EnqueueError --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style EnqueueError fill:#ffcdd2
    style HandleFailed fill:#ffcdd2
```

#### å…³é”®è®¾è®¡å†³ç­–

**1. åŒé‡é”æœºåˆ¶**

ç³»ç»Ÿä½¿ç”¨èŠ‚ç‚¹é”å’Œç±»å‹é”ä¸¤ç§é”æœºåˆ¶:
- **èŠ‚ç‚¹é”**: é˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘æ“ä½œ
- **ç±»å‹é”**: é˜²æ­¢åŒç±»å‹æ¦‚å¿µçš„å¹¶å‘å»é‡æ“ä½œ

è¿™ç§è®¾è®¡ç¡®ä¿:
- åŒä¸€æ¦‚å¿µä¸ä¼šè¢«å¹¶å‘ä¿®æ”¹
- å»é‡æ£€æµ‹ä¸ä¼šè¢«å¹¶å‘æ‰§è¡Œ(é¿å…é‡å¤æ£€æµ‹)
- é”ç²’åº¦é€‚ä¸­,ä¸ä¼šè¿‡åº¦é™åˆ¶å¹¶å‘

**2. å…¥é˜Ÿæ—¶æ£€æŸ¥é”å†²çª**

ä»»åŠ¡å…¥é˜Ÿå‰æ£€æŸ¥é”å†²çª,è€Œéè°ƒåº¦æ—¶æ£€æŸ¥ã€‚åŸå› :
- æå‰å‘ç°å†²çª,é¿å…ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­æ— æ•ˆç­‰å¾…
- è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯,ä¾¿äºä¸Šå±‚å¤„ç†
- å‡å°‘é˜Ÿåˆ—ä¸­çš„æ— æ•ˆä»»åŠ¡

**3. è°ƒåº¦å™¨è½®è¯¢è€Œéäº‹ä»¶é©±åŠ¨**

ä½¿ç”¨å®šæ—¶å™¨è½®è¯¢è€Œéäº‹ä»¶é©±åŠ¨è°ƒåº¦ã€‚åŸå› :
- å®ç°ç®€å•,é€»è¾‘æ¸…æ™°
- é¿å…äº‹ä»¶é£æš´(å¤§é‡ä»»åŠ¡åŒæ—¶å®Œæˆæ—¶)
- 1 ç§’çš„è½®è¯¢é—´éš”å¯¹ç”¨æˆ·ä½“éªŒå½±å“å¯å¿½ç•¥
- ä¾¿äºè°ƒè¯•å’Œç›‘æ§

**4. ä¸²è¡ŒåŒ–æŒä¹…åŒ–**

ä½¿ç”¨ Promise é“¾ä¸²è¡ŒåŒ–æŒä¹…åŒ–æ“ä½œã€‚åŸå› :
- é¿å…å¹¶å‘å†™å…¥åŒä¸€æ–‡ä»¶å¯¼è‡´çš„ ENOENT é”™è¯¯
- ç¡®ä¿é˜Ÿåˆ—çŠ¶æ€çš„ä¸€è‡´æ€§
- ä½¿ç”¨åŸå­å†™å…¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§

**5. æ™ºèƒ½é‡è¯•ç­–ç•¥**

æ ¹æ®é”™è¯¯ç±»å‹åŠ¨æ€è°ƒæ•´é‡è¯•ç­–ç•¥:
- **å†…å®¹é”™è¯¯**: æœ€å¤šé‡è¯• 3 æ¬¡(AI è¾“å‡ºæ ¼å¼é”™è¯¯)
- **ç½‘ç»œé”™è¯¯**: æœ€å¤šé‡è¯• 5 æ¬¡,æŒ‡æ•°é€€é¿(ä¸´æ—¶ç½‘ç»œæ•…éšœ)
- **ç»ˆæ­¢é”™è¯¯**: ä¸é‡è¯•(é…ç½®é”™è¯¯ã€æƒé™é”™è¯¯ç­‰)

è¿™ç§è®¾è®¡å¹³è¡¡äº†å¯é æ€§å’Œæ•ˆç‡ã€‚

#### å¹¶å‘æ§åˆ¶

**å¹¶å‘é™åˆ¶**

ç³»ç»Ÿé€šè¿‡ `settings.concurrency` æ§åˆ¶æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°:
- é»˜è®¤å€¼: 3
- å¯é…ç½®èŒƒå›´: 1-10
- è¶…è¿‡é™åˆ¶æ—¶,æ–°ä»»åŠ¡ç­‰å¾…

**å¹¶å‘å®‰å…¨**

- ä½¿ç”¨é”æœºåˆ¶é˜²æ­¢å¹¶å‘å†²çª
- ä½¿ç”¨ `processingTasks` Set è·Ÿè¸ªè¿è¡Œä¸­ä»»åŠ¡
- ä½¿ç”¨ `isScheduling` æ ‡å¿—é˜²æ­¢è°ƒåº¦å™¨é‡å…¥

#### é”™è¯¯å¤„ç†

**å…¥é˜Ÿå¤±è´¥**
- é”™è¯¯ç : E400(é”å†²çª) æˆ– E304(ç³»ç»Ÿé”™è¯¯)
- å¤„ç†: è¿”å›é”™è¯¯,ä»»åŠ¡ä¸å…¥é˜Ÿ
- ä¸å½±å“é˜Ÿåˆ—çŠ¶æ€

**æ‰§è¡Œå¤±è´¥**
- é”™è¯¯ç : æ ¹æ®å¤±è´¥åŸå› åˆ†ç±»
- å¤„ç†: æ ¹æ®é‡è¯•ç­–ç•¥è‡ªåŠ¨é‡è¯•æˆ–æ ‡è®°ä¸ºå¤±è´¥
- æŒä¹…åŒ–å¤±è´¥çŠ¶æ€,æ”¯æŒæ‰‹åŠ¨é‡è¯•

**æŒä¹…åŒ–å¤±è´¥**
- é”™è¯¯ç : E300-E304(ç³»ç»Ÿé”™è¯¯)
- å¤„ç†: è®°å½•é”™è¯¯æ—¥å¿—,ç»§ç»­æ‰§è¡Œ
- ä¸é˜»å¡ä»»åŠ¡æ‰§è¡Œ

#### é˜Ÿåˆ—æ¢å¤

ç³»ç»Ÿå¯åŠ¨æ—¶,TaskQueue ä» `data/queue-state.json` æ¢å¤é˜Ÿåˆ—çŠ¶æ€:
- æ¢å¤æ‰€æœ‰ä»»åŠ¡è®°å½•
- å°† Running çŠ¶æ€çš„ä»»åŠ¡é‡ç½®ä¸º Pending
- æ¢å¤é”çŠ¶æ€
- é‡Šæ”¾æ— ä»»åŠ¡å…³è”çš„é”
- æ¸…ç†æ®‹ç•™é”å¼•ç”¨

è¿™ç¡®ä¿äº†ç³»ç»Ÿåœ¨æ–­ç”µæˆ–å´©æºƒåèƒ½å¤Ÿæ­£ç¡®æ¢å¤ã€‚

**å‚è€ƒæ–‡ä»¶**:
- `src/core/task-queue.ts`: ä»»åŠ¡è°ƒåº¦é€»è¾‘
- `src/core/lock-manager.ts`: é”ç®¡ç†é€»è¾‘
- `src/core/retry-handler.ts`: é‡è¯•ç­–ç•¥é€»è¾‘
- `src/core/task-runner.ts`: ä»»åŠ¡æ‰§è¡Œé€»è¾‘

### 7.3 å»é‡æ£€æµ‹æµç¨‹

å»é‡æ£€æµ‹æ˜¯ Cognitive Razor çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€,é€šè¿‡è¯­ä¹‰å‘é‡åµŒå…¥å’Œç›¸ä¼¼åº¦è®¡ç®—,é˜²æ­¢çŸ¥è¯†åº“ä¸­å‡ºç°é‡å¤æ¦‚å¿µã€‚ç³»ç»Ÿé‡‡ç”¨åˆ†æ¡¶æ£€ç´¢å’ŒåŒé‡é˜ˆå€¼ç­–ç•¥,ç¡®ä¿æ£€æµ‹çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚

#### å®Œæ•´æ£€æµ‹é€»è¾‘

1. **è·å–æ¦‚å¿µçš„å‘é‡åµŒå…¥**
   - åœ¨æ¦‚å¿µåˆ›å»ºæµç¨‹ä¸­,embedding é˜¶æ®µå·²ç”Ÿæˆå‘é‡åµŒå…¥
   - å‘é‡åµŒå…¥ç»´åº¦: 1536(text-embedding-3-small æ¨¡å‹)
   - åµŒå…¥æ–‡æœ¬åŒ…å«: æ ‡å‡†åç§° + æ ¸å¿ƒå®šä¹‰ + ç±»å‹ + æ ‡ç­¾
   - å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `buildEmbeddingText()` æ–¹æ³•

2. **åœ¨ VectorIndex ä¸­æœç´¢ç›¸ä¼¼æ¦‚å¿µ(åŒç±»å‹)**
   - è°ƒç”¨ `vectorIndex.search(type, embedding, topK)`
   - **åˆ†æ¡¶æ£€ç´¢**: ä»…åœ¨åŒç±»å‹æ¡¶å†…æœç´¢
     - é¿å…è·¨ç±»å‹è¯¯åˆ¤(å¦‚"è‹¹æœå…¬å¸"ä¸"è‹¹æœæ°´æœ")
     - æ¯ç§ç±»å‹(Domain/Issue/Theory/Entity/Mechanism)ç»´æŠ¤ç‹¬ç«‹çš„å‘é‡æ¡¶
   - **topK å‚æ•°**: è¿”å›ç›¸ä¼¼åº¦æœ€é«˜çš„ K ä¸ªæ¦‚å¿µ
     - é»˜è®¤å€¼: 10
     - å¯é…ç½®: settings.topK
   - å‚è€ƒ: `src/core/vector-index.ts` çš„ `search()` æ–¹æ³•

3. **è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°**
   - ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦(Cosine Similarity)è®¡ç®—å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦
   - å…¬å¼: `similarity = dot(A, B) / (norm(A) * norm(B))`
   - ç›¸ä¼¼åº¦èŒƒå›´: [-1, 1]
     - 1: å®Œå…¨ç›¸åŒ
     - 0: å®Œå…¨æ— å…³
     - -1: å®Œå…¨ç›¸å(å®é™…å¾ˆå°‘å‡ºç°)
   - å‚è€ƒ: `src/core/vector-index.ts` çš„ `cosineSimilarity()` æ–¹æ³•

4. **æ ¹æ®é˜ˆå€¼åˆ¤æ–­æ˜¯å¦é‡å¤**
   - **é˜»æ–­é˜ˆå€¼(>= 0.95)**: æé«˜ç›¸ä¼¼åº¦,è‡ªåŠ¨æ‹’ç»
     - è®¤ä¸ºæ˜¯å®Œå…¨é‡å¤çš„æ¦‚å¿µ
     - ä¸åˆ›å»ºé‡å¤å¯¹,ç›´æ¥é˜»æ­¢åˆ›å»º
     - é€šçŸ¥ç”¨æˆ·æ¦‚å¿µå·²å­˜åœ¨
   - **æç¤ºé˜ˆå€¼(>= 0.85)**: é«˜ç›¸ä¼¼åº¦,æäº¤äººç±»è£å†³
     - è®¤ä¸ºæ˜¯ç–‘ä¼¼é‡å¤çš„æ¦‚å¿µ
     - åˆ›å»ºé‡å¤å¯¹è®°å½•
     - åœ¨ UI ä¸Šå±•ç¤º,ç”±ç”¨æˆ·å†³å®šæ˜¯å¦åˆå¹¶æˆ–å¿½ç•¥
   - **ä½äºé˜ˆå€¼(< 0.85)**: ä¸è®¤ä¸ºæ˜¯é‡å¤
     - ä¸åˆ›å»ºé‡å¤å¯¹
     - ç»§ç»­åˆ›å»ºæµç¨‹
   - å‚è€ƒ: `src/core/duplicate-manager.ts` çš„ `detect()` æ–¹æ³•

5. **åˆ›å»ºé‡å¤å¯¹è®°å½•**
   - ç”Ÿæˆé‡å¤å¯¹ ID: `pairId = generatePairId(nodeIdA, nodeIdB)`
     - æŒ‰å­—å…¸åºæ’åº,ç¡®ä¿ ID ä¸€è‡´æ€§
     - æ ¼å¼: `{first}--{second}`
   - åˆ›å»º DuplicatePair å¯¹è±¡:
     - id: é‡å¤å¯¹å”¯ä¸€æ ‡è¯†
     - noteA: æ¦‚å¿µ A çš„ä¿¡æ¯(nodeId, name, path)
     - noteB: æ¦‚å¿µ B çš„ä¿¡æ¯(nodeId, name, path)
     - type: æ¦‚å¿µç±»å‹
     - similarity: ç›¸ä¼¼åº¦åˆ†æ•°
     - detectedAt: æ£€æµ‹æ—¶é—´
     - status: çŠ¶æ€(pending/merging/merged/dismissed)
   - å‚è€ƒ: `src/core/duplicate-manager.ts` çš„ `detect()` æ–¹æ³•

6. **æŒä¹…åŒ–é‡å¤å¯¹åˆ—è¡¨**
   - å°†é‡å¤å¯¹æ·»åŠ åˆ° `store.pairs` æ•°ç»„
   - æŒä¹…åŒ–åˆ° `data/duplicate-pairs.json`
   - æ–‡ä»¶ç»“æ„:
     ```json
     {
       "version": "1.0.0",
       "pairs": [
         {
           "id": "uid1--uid2",
           "noteA": { "nodeId": "uid1", "name": "æ¦‚å¿µA", "path": "path/to/a.md" },
           "noteB": { "nodeId": "uid2", "name": "æ¦‚å¿µB", "path": "path/to/b.md" },
           "type": "Entity",
           "similarity": 0.92,
           "detectedAt": "2025-12-10T10:00:00.000Z",
           "status": "pending"
         }
       ],
       "dismissedPairs": ["uid3--uid4"]
     }
     ```
   - å‚è€ƒ: `src/core/duplicate-manager.ts` çš„ `saveStore()` æ–¹æ³•

7. **é€šçŸ¥ UI æ›´æ–°**
   - è°ƒç”¨æ‰€æœ‰è®¢é˜…çš„ç›‘å¬å™¨: `notifyListeners()`
   - WorkbenchPanel æ¥æ”¶é€šçŸ¥,æ›´æ–°"é‡å¤æ¦‚å¿µ"åŒºåŸŸ
   - æ˜¾ç¤ºé‡å¤å¯¹åˆ—è¡¨,åŒ…å«:
     - æ¦‚å¿µ A å’Œæ¦‚å¿µ B çš„åç§°
     - ç›¸ä¼¼åº¦åˆ†æ•°
     - æ“ä½œæŒ‰é’®(åˆå¹¶/å¿½ç•¥)
   - å‚è€ƒ: `src/core/duplicate-manager.ts` çš„ `notifyListeners()` æ–¹æ³•

#### æµç¨‹å›¾

```mermaid
flowchart TD
    Start([æ¦‚å¿µåˆ›å»ºå®Œæˆ]) --> GetEmbed[è·å–å‘é‡åµŒå…¥]
    GetEmbed --> Search[VectorIndex æœç´¢<br/>åŒç±»å‹æ¡¶å†…]
    
    Search --> CalcSim[è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°<br/>ä½™å¼¦ç›¸ä¼¼åº¦]
    CalcSim --> Filter[è¿‡æ»¤ç»“æœ<br/>æ’é™¤è‡ªèº«]
    
    Filter --> HasSimilar{æœ‰ç›¸ä¼¼æ¦‚å¿µ?}
    HasSimilar -->|å¦| NoDup[æ— é‡å¤]
    HasSimilar -->|æ˜¯| CheckThreshold{æ£€æŸ¥é˜ˆå€¼}
    
    CheckThreshold -->|>= 0.95| Block[é˜»æ–­é˜ˆå€¼<br/>è‡ªåŠ¨æ‹’ç»]
    CheckThreshold -->|>= 0.85| Prompt[æç¤ºé˜ˆå€¼<br/>åˆ›å»ºé‡å¤å¯¹]
    CheckThreshold -->|< 0.85| NoDup
    
    Block --> NotifyBlock[é€šçŸ¥ç”¨æˆ·<br/>æ¦‚å¿µå·²å­˜åœ¨]
    NotifyBlock --> End([æµç¨‹ç»“æŸ])
    
    Prompt --> CheckExist{é‡å¤å¯¹å·²å­˜åœ¨?}
    CheckExist -->|æ˜¯| Skip[è·³è¿‡åˆ›å»º]
    CheckExist -->|å¦| CreatePair[åˆ›å»ºé‡å¤å¯¹è®°å½•]
    
    CreatePair --> GenID[ç”Ÿæˆé‡å¤å¯¹ ID<br/>æŒ‰å­—å…¸åºæ’åº]
    GenID --> BuildPair[æ„å»º DuplicatePair å¯¹è±¡]
    BuildPair --> AddStore[æ·»åŠ åˆ° store.pairs]
    AddStore --> Persist[æŒä¹…åŒ–åˆ°<br/>duplicate-pairs.json]
    Persist --> Notify[é€šçŸ¥ UI æ›´æ–°]
    
    Notify --> UpdateUI[WorkbenchPanel<br/>æ›´æ–°é‡å¤æ¦‚å¿µåŒºåŸŸ]
    UpdateUI --> ShowPair[æ˜¾ç¤ºé‡å¤å¯¹<br/>ç­‰å¾…ç”¨æˆ·å†³ç­–]
    
    Skip --> End
    NoDup --> End
    ShowPair --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Block fill:#ffcdd2
    style Prompt fill:#fff9c4
```

#### å…³é”®è®¾è®¡å†³ç­–

**1. åˆ†æ¡¶æ£€ç´¢ç­–ç•¥**

æŒ‰æ¦‚å¿µç±»å‹åˆ†æ¡¶,ä»…åœ¨åŒç±»å‹æ¡¶å†…æœç´¢ã€‚åŸå› :
- **é¿å…è·¨ç±»å‹è¯¯åˆ¤**: "è‹¹æœå…¬å¸"(Entity)ä¸"è‹¹æœæ°´æœ"(Entity)å¯èƒ½ç›¸ä¼¼,ä½†"è‹¹æœå…¬å¸"(Entity)ä¸"è‹¹æœç†è®º"(Theory)ä¸åº”æ¯”è¾ƒ
- **æå‡æ£€ç´¢æ•ˆç‡**: å‡å°‘æœç´¢ç©ºé—´,åŠ å¿«æ£€ç´¢é€Ÿåº¦
- **ç¬¦åˆæœ¬ä½“è®ºçº¦æŸ**: ä¸åŒç±»å‹çš„æ¦‚å¿µåœ¨è®¤çŸ¥å±‚é¢ä¸å¯æ¯”è¾ƒ

**2. åŒé‡é˜ˆå€¼ç­–ç•¥**

ä½¿ç”¨é˜»æ–­é˜ˆå€¼å’Œæç¤ºé˜ˆå€¼ä¸¤ä¸ªé˜ˆå€¼ã€‚åŸå› :
- **é˜»æ–­é˜ˆå€¼(>= 0.95)**: æé«˜ç›¸ä¼¼åº¦,è®¤ä¸ºæ˜¯å®Œå…¨é‡å¤,è‡ªåŠ¨æ‹’ç»
  - é¿å…æ˜æ˜¾é‡å¤çš„æ¦‚å¿µè¿›å…¥ç³»ç»Ÿ
  - å‡å°‘ç”¨æˆ·å†³ç­–è´Ÿæ‹…
- **æç¤ºé˜ˆå€¼(>= 0.85)**: é«˜ç›¸ä¼¼åº¦,è®¤ä¸ºæ˜¯ç–‘ä¼¼é‡å¤,æäº¤äººç±»è£å†³
  - ä¿ç•™äººç±»åˆ¤æ–­çš„ç©ºé—´
  - é¿å…è¯¯åˆ¤å¯¼è‡´çš„ä¿¡æ¯ä¸¢å¤±

**3. æ£€æµ‹æ—¶æœº**

å»é‡æ£€æµ‹åœ¨æ¦‚å¿µåˆ›å»ºå®Œæˆåæ‰§è¡Œ,è€Œéåˆ›å»ºå‰ã€‚åŸå› :
- **ç¡®ä¿æ¦‚å¿µå®Œæ•´æ€§**: æ¦‚å¿µå·²å®Œæ•´åˆ›å»º,é¿å…ä¸­é€”å¤±è´¥å¯¼è‡´ä¸ä¸€è‡´
- **ä¸é˜»å¡åˆ›å»ºæµç¨‹**: å»é‡æ£€æµ‹ç»“æœä¸é˜»å¡åˆ›å»º,ä»…ä½œä¸ºæç¤º
- **æ”¯æŒåç»­åˆå¹¶**: ç”¨æˆ·å¯ä»¥é€‰æ‹©åˆå¹¶æˆ–å¿½ç•¥,ä¿æŒçµæ´»æ€§

**4. é‡å¤å¯¹ ID ç”Ÿæˆ**

ä½¿ç”¨å­—å…¸åºæ’åºç”Ÿæˆé‡å¤å¯¹ IDã€‚åŸå› :
- **ç¡®ä¿ ID ä¸€è‡´æ€§**: æ— è®º Aã€B é¡ºåºå¦‚ä½•,ç”Ÿæˆçš„ ID ç›¸åŒ
- **é¿å…é‡å¤åˆ›å»º**: æ£€æŸ¥é‡å¤å¯¹æ˜¯å¦å·²å­˜åœ¨æ—¶,å¯ä»¥ç›´æ¥æ¯”è¾ƒ ID
- **ç®€åŒ–æŸ¥è¯¢**: ä¸éœ€è¦åŒæ—¶æŸ¥è¯¢ A-B å’Œ B-A ä¸¤ç§ç»„åˆ

**5. è®¢é˜…é€šçŸ¥æœºåˆ¶**

ä½¿ç”¨è®¢é˜…æ¨¡å¼é€šçŸ¥ UI æ›´æ–°ã€‚åŸå› :
- **è§£è€¦**: DuplicateManager ä¸ä¾èµ– UI å±‚
- **å®æ—¶æ›´æ–°**: UI å¯ä»¥å®æ—¶å“åº”é‡å¤å¯¹å˜æ›´
- **æ”¯æŒå¤šè®¢é˜…è€…**: å¯ä»¥æœ‰å¤šä¸ª UI ç»„ä»¶è®¢é˜…åŒä¸€äº‹ä»¶

#### ç›¸ä¼¼åº¦è®¡ç®—

**ä½™å¼¦ç›¸ä¼¼åº¦å…¬å¼**

```
similarity = dot(A, B) / (norm(A) * norm(B))

å…¶ä¸­:
- dot(A, B) = Î£(A[i] * B[i])  # å‘é‡ç‚¹ç§¯
- norm(A) = sqrt(Î£(A[i]^2))   # å‘é‡æ¨¡é•¿
- norm(B) = sqrt(Î£(B[i]^2))
```

**å®ç°ä¼˜åŒ–**

- å‘é‡å½’ä¸€åŒ–: å­˜å‚¨æ—¶å·²å½’ä¸€åŒ–,è®¡ç®—æ—¶ç›´æ¥ç‚¹ç§¯
- æ‰¹é‡è®¡ç®—: ä½¿ç”¨å‘é‡åŒ–æ“ä½œåŠ é€Ÿè®¡ç®—
- ç¼“å­˜ç»“æœ: é¿å…é‡å¤è®¡ç®—

**å‚è€ƒæ–‡ä»¶**: `src/core/vector-index.ts` çš„ `cosineSimilarity()` æ–¹æ³•

#### é‡å¤å¯¹çŠ¶æ€æµè½¬

é‡å¤å¯¹çš„çŠ¶æ€æµè½¬å¦‚ä¸‹:

```
pending (å¾…å¤„ç†)
  â†“
  â”œâ”€â†’ merging (åˆå¹¶ä¸­) â†’ merged (å·²åˆå¹¶)
  â””â”€â†’ dismissed (å·²å¿½ç•¥)
```

**çŠ¶æ€è¯´æ˜**:
- **pending**: åˆšæ£€æµ‹åˆ°çš„é‡å¤å¯¹,ç­‰å¾…ç”¨æˆ·å†³ç­–
- **merging**: ç”¨æˆ·é€‰æ‹©åˆå¹¶,æ­£åœ¨æ‰§è¡Œåˆå¹¶æµç¨‹
- **merged**: åˆå¹¶å®Œæˆ,é‡å¤å¯¹å·²è§£å†³
- **dismissed**: ç”¨æˆ·é€‰æ‹©å¿½ç•¥,è®¤ä¸ºä¸æ˜¯é‡å¤

**å‚è€ƒæ–‡ä»¶**: `src/core/duplicate-manager.ts` çš„ `updateStatus()` æ–¹æ³•

#### é”™è¯¯å¤„ç†

**å‘é‡æ£€ç´¢å¤±è´¥**
- é”™è¯¯ç : E304(ç³»ç»Ÿé”™è¯¯)
- å¤„ç†: è®°å½•é”™è¯¯æ—¥å¿—,è·³è¿‡å»é‡æ£€æµ‹
- ä¸é˜»å¡æ¦‚å¿µåˆ›å»º

**æŒä¹…åŒ–å¤±è´¥**
- é”™è¯¯ç : E300-E304(ç³»ç»Ÿé”™è¯¯)
- å¤„ç†: è®°å½•é”™è¯¯æ—¥å¿—,é‡å¤å¯¹ä»…å­˜åœ¨äºå†…å­˜
- ä¸‹æ¬¡å¯åŠ¨æ—¶ä¸¢å¤±

**é€šçŸ¥å¤±è´¥**
- é”™è¯¯ç : æ— (ç›‘å¬å™¨å¼‚å¸¸)
- å¤„ç†: æ•è·å¼‚å¸¸,è®°å½•é”™è¯¯æ—¥å¿—
- ä¸å½±å“å…¶ä»–ç›‘å¬å™¨

#### æ€§èƒ½ä¼˜åŒ–

**1. åˆ†æ¡¶ç´¢å¼•**

æŒ‰ç±»å‹åˆ†æ¡¶,å‡å°‘æœç´¢ç©ºé—´:
- æ¯ä¸ªæ¡¶ç‹¬ç«‹ç»´æŠ¤å‘é‡åˆ—è¡¨
- æœç´¢æ—¶ä»…éå†å¯¹åº”æ¡¶
- æ—¶é—´å¤æ‚åº¦: O(N/5) (5 ç§ç±»å‹)

**2. topK é™åˆ¶**

ä»…è¿”å›ç›¸ä¼¼åº¦æœ€é«˜çš„ K ä¸ªç»“æœ:
- é»˜è®¤ K=10,å¯é…ç½®
- é¿å…è¿”å›å¤§é‡ä½ç›¸ä¼¼åº¦ç»“æœ
- å‡å°‘åç»­å¤„ç†å¼€é”€

**3. å‘é‡å½’ä¸€åŒ–**

å­˜å‚¨æ—¶å½’ä¸€åŒ–å‘é‡:
- è®¡ç®—ç›¸ä¼¼åº¦æ—¶ç›´æ¥ç‚¹ç§¯
- é¿å…é‡å¤è®¡ç®—æ¨¡é•¿
- æå‡è®¡ç®—æ•ˆç‡

**å‚è€ƒæ–‡ä»¶**:
- `src/core/duplicate-manager.ts`: å»é‡æ£€æµ‹é€»è¾‘
- `src/core/vector-index.ts`: å‘é‡æ£€ç´¢é€»è¾‘
- `src/types.ts`: DuplicatePair ç±»å‹å®šä¹‰

### 7.4 æ’¤é”€æ¢å¤æµç¨‹

æ’¤é”€æ¢å¤æ˜¯ Cognitive Razor çš„æ ¸å¿ƒå®‰å…¨æœºåˆ¶,ç¡®ä¿æ‰€æœ‰å†™å…¥æ“ä½œéƒ½æ˜¯å¯é€†çš„ã€‚ç³»ç»Ÿé€šè¿‡å¿«ç…§æœºåˆ¶è®°å½•æ–‡ä»¶çš„å†å²çŠ¶æ€,æ”¯æŒæ— æŸæ¢å¤åˆ°ä»»æ„å†å²ç‰ˆæœ¬ã€‚

#### å®Œæ•´æ¢å¤é€»è¾‘

1. **ç”¨æˆ·è§¦å‘æ’¤é”€æ“ä½œ**
   - ç”¨æˆ·åœ¨ WorkbenchPanel çš„"æœ€è¿‘æ“ä½œ"åŒºåŸŸç‚¹å‡»"æ’¤é”€"æŒ‰é’®
   - æˆ–é€šè¿‡å‘½ä»¤é¢æ¿æ‰§è¡Œ"æ’¤é”€æœ€è¿‘æ“ä½œ"å‘½ä»¤
   - ä¼ é€’å¿«ç…§ ID ç»™ UndoManager
   - å‚è€ƒ: `src/ui/workbench-panel.ts`

2. **ä»å¿«ç…§ç´¢å¼•ä¸­æŸ¥æ‰¾å¿«ç…§**
   - UndoManager ç»´æŠ¤å¿«ç…§ç´¢å¼•: `data/snapshots/index.json`
   - ç´¢å¼•åŒ…å«æ‰€æœ‰å¿«ç…§çš„å…ƒæ•°æ®:
     - id: å¿«ç…§å”¯ä¸€æ ‡è¯†
     - nodeId: å…³è”çš„æ¦‚å¿µ UID
     - taskId: å…³è”çš„ä»»åŠ¡ ID
     - path: æ–‡ä»¶è·¯å¾„
     - created: åˆ›å»ºæ—¶é—´
     - fileSize: æ–‡ä»¶å¤§å°
   - æ ¹æ®å¿«ç…§ ID æŸ¥æ‰¾å¯¹åº”çš„å¿«ç…§è®°å½•
   - å‚è€ƒ: `src/core/undo-manager.ts` çš„ `restoreSnapshot()` æ–¹æ³•

3. **è¯»å–å¿«ç…§å†…å®¹**
   - å¿«ç…§æ–‡ä»¶è·¯å¾„: `data/snapshots/{snapshotId}.json`
   - å¿«ç…§æ–‡ä»¶åŒ…å«å®Œæ•´çš„æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®:
     ```json
     {
       "id": "snapshot-1234567890-abc123",
       "nodeId": "concept-uid",
       "taskId": "task-1234567890-def456",
       "path": "concepts/entity/apple-company.md",
       "content": "---\nuid: concept-uid\n...\n---\n\n# è‹¹æœå…¬å¸\n...",
       "created": "2025-12-10T10:00:00.000Z",
       "fileSize": 1024,
       "checksum": "sha256-hash"
     }
     ```
   - ä½¿ç”¨ FileStorage.read() è¯»å–å¿«ç…§æ–‡ä»¶
   - è§£æ JSON è·å–å¿«ç…§å¯¹è±¡
   - å‚è€ƒ: `src/core/undo-manager.ts` çš„ `restoreSnapshot()` æ–¹æ³•

4. **ä½¿ç”¨åŸå­å†™å…¥æ¢å¤æ–‡ä»¶**
   - éªŒè¯å¿«ç…§å†…å®¹çš„å®Œæ•´æ€§:
     - è®¡ç®—å†…å®¹çš„ SHA256 æ ¡éªŒå’Œ
     - ä¸å¿«ç…§è®°å½•ä¸­çš„ checksum æ¯”è¾ƒ
     - å¦‚æœä¸åŒ¹é…,è¿”å›é”™è¯¯"å¿«ç…§æ–‡ä»¶å·²æŸå"
   - ä½¿ç”¨ FileStorage.atomicWrite() æ¢å¤æ–‡ä»¶:
     - å†™å…¥ä¸´æ—¶æ–‡ä»¶: `{path}.tmp`
     - è¯»å–ä¸´æ—¶æ–‡ä»¶éªŒè¯å†…å®¹
     - åˆ é™¤åŸæ–‡ä»¶(å¦‚æœå­˜åœ¨)
     - é‡å‘½åä¸´æ—¶æ–‡ä»¶ä¸ºç›®æ ‡æ–‡ä»¶
   - è¿™ç¡®ä¿äº†æ¢å¤æ“ä½œçš„åŸå­æ€§,é¿å…ä¸­é€”å¤±è´¥å¯¼è‡´æ•°æ®ä¸¢å¤±
   - å‚è€ƒ: `src/core/undo-manager.ts` çš„ `restoreSnapshotToFile()` æ–¹æ³•

5. **æ›´æ–°å‘é‡ç´¢å¼•**
   - æ¢å¤æ–‡ä»¶å,éœ€è¦åŒæ­¥æ›´æ–°å‘é‡ç´¢å¼•
   - ä»æ¢å¤çš„æ–‡ä»¶ä¸­æå– Frontmatter
   - è·å–æ¦‚å¿µçš„å‘é‡åµŒå…¥(ä» VectorIndex ä¸­æŸ¥è¯¢)
   - æ›´æ–°å‘é‡ç´¢å¼•æ¡ç›®:
     - uid: æ¦‚å¿µ UID
     - type: æ¦‚å¿µç±»å‹
     - name: æ¦‚å¿µåç§°
     - path: æ–‡ä»¶è·¯å¾„(å¯èƒ½å·²å˜æ›´)
     - embedding: å‘é‡åµŒå…¥
     - updated: æ›´æ–°æ—¶é—´
   - å‚è€ƒ: `src/core/vector-index.ts` çš„ `upsert()` æ–¹æ³•

6. **æ˜¾ç¤ºæ’¤é”€é€šçŸ¥**
   - ä½¿ç”¨ Obsidian Notice æ˜¾ç¤ºæ’¤é”€æˆåŠŸé€šçŸ¥
   - é€šçŸ¥å†…å®¹åŒ…å«:
     - æ–‡ä»¶è·¯å¾„
     - å¿«ç…§åˆ›å»ºæ—¶é—´
     - æ“ä½œç±»å‹(æ’¤é”€)
   - é€šçŸ¥æŒç»­æ—¶é—´: 5 ç§’
   - å‚è€ƒ: `src/ui/undo-notification.ts`

#### æµç¨‹å›¾

```mermaid
flowchart TD
    Start([ç”¨æˆ·è§¦å‘æ’¤é”€]) --> GetID[è·å–å¿«ç…§ ID]
    GetID --> FindIndex[ä»ç´¢å¼•ä¸­æŸ¥æ‰¾å¿«ç…§]
    
    FindIndex --> IndexFound{å¿«ç…§å­˜åœ¨?}
    IndexFound -->|å¦| Error1[è¿”å›é”™è¯¯<br/>å¿«ç…§ä¸å­˜åœ¨]
    IndexFound -->|æ˜¯| ReadFile[è¯»å–å¿«ç…§æ–‡ä»¶<br/>snapshots/{id}.json]
    
    ReadFile --> ReadOK{è¯»å–æˆåŠŸ?}
    ReadOK -->|å¦| Error2[è¿”å›é”™è¯¯<br/>è¯»å–å¤±è´¥]
    ReadOK -->|æ˜¯| ParseJSON[è§£æ JSON]
    
    ParseJSON --> ParseOK{è§£ææˆåŠŸ?}
    ParseOK -->|å¦| Error3[è¿”å›é”™è¯¯<br/>è§£æå¤±è´¥]
    ParseOK -->|æ˜¯| Verify[éªŒè¯æ ¡éªŒå’Œ]
    
    Verify --> VerifyOK{æ ¡éªŒå’ŒåŒ¹é…?}
    VerifyOK -->|å¦| Error4[è¿”å›é”™è¯¯<br/>å¿«ç…§å·²æŸå]
    VerifyOK -->|æ˜¯| WriteTmp[å†™å…¥ä¸´æ—¶æ–‡ä»¶<br/>{path}.tmp]
    
    WriteTmp --> ReadTmp[è¯»å–ä¸´æ—¶æ–‡ä»¶<br/>éªŒè¯å†…å®¹]
    ReadTmp --> VerifyTmp{å†…å®¹åŒ¹é…?}
    VerifyTmp -->|å¦| CleanTmp[åˆ é™¤ä¸´æ—¶æ–‡ä»¶]
    CleanTmp --> Error5[è¿”å›é”™è¯¯<br/>å†™å…¥æ ¡éªŒå¤±è´¥]
    
    VerifyTmp -->|æ˜¯| DeleteOrig[åˆ é™¤åŸæ–‡ä»¶<br/>å¦‚æœå­˜åœ¨]
    DeleteOrig --> Rename[é‡å‘½åä¸´æ—¶æ–‡ä»¶<br/>ä¸ºç›®æ ‡æ–‡ä»¶]
    
    Rename --> UpdateIndex[æ›´æ–°å‘é‡ç´¢å¼•]
    UpdateIndex --> Notify[æ˜¾ç¤ºæ’¤é”€é€šçŸ¥]
    Notify --> End([æ¢å¤å®Œæˆ])
    
    Error1 --> End
    Error2 --> End
    Error3 --> End
    Error4 --> End
    Error5 --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style Error1 fill:#ffcdd2
    style Error2 fill:#ffcdd2
    style Error3 fill:#ffcdd2
    style Error4 fill:#ffcdd2
    style Error5 fill:#ffcdd2
```

#### å…³é”®è®¾è®¡å†³ç­–

**1. å¿«ç…§ç´¢å¼•åˆ†ç¦»**

å¿«ç…§ç´¢å¼•å’Œå¿«ç…§å†…å®¹åˆ†ç¦»å­˜å‚¨ã€‚åŸå› :
- **å¿«é€ŸæŸ¥è¯¢**: ç´¢å¼•æ–‡ä»¶è¾ƒå°,å¯ä»¥å¿«é€ŸåŠ è½½åˆ°å†…å­˜
- **æŒ‰éœ€åŠ è½½**: å¿«ç…§å†…å®¹ä»…åœ¨æ¢å¤æ—¶åŠ è½½,èŠ‚çœå†…å­˜
- **æ˜“äºç®¡ç†**: å¯ä»¥å¿«é€Ÿåˆ—å‡ºæ‰€æœ‰å¿«ç…§,æ”¯æŒæ‰¹é‡æ¸…ç†

**2. åŸå­å†™å…¥æ¢å¤**

ä½¿ç”¨åŸå­å†™å…¥(temp file + rename)æ¢å¤æ–‡ä»¶ã€‚åŸå› :
- **æ•°æ®å®Œæ•´æ€§**: é¿å…ä¸­é€”å¤±è´¥å¯¼è‡´æ–‡ä»¶æŸå
- **ä¸€è‡´æ€§ä¿è¯**: è¦ä¹ˆå®Œå…¨æ¢å¤,è¦ä¹ˆå®Œå…¨å¤±è´¥,ä¸å­˜åœ¨ä¸­é—´çŠ¶æ€
- **ç¬¦åˆè®¾è®¡åŸåˆ™**: éµå¾ª A-NF-02 åŸå­å†™å…¥è¦æ±‚

**3. æ ¡éªŒå’ŒéªŒè¯**

ä½¿ç”¨ SHA256 æ ¡éªŒå’ŒéªŒè¯å¿«ç…§å®Œæ•´æ€§ã€‚åŸå› :
- **æ£€æµ‹æŸå**: åŠæ—¶å‘ç°ç£ç›˜é”™è¯¯æˆ–æ–‡ä»¶æŸå
- **é˜²æ­¢ç¯¡æ”¹**: ç¡®ä¿å¿«ç…§å†…å®¹æœªè¢«ä¿®æ”¹
- **æå‡å¯é æ€§**: é¿å…æ¢å¤æŸåçš„å¿«ç…§å¯¼è‡´æ•°æ®ä¸¢å¤±

**4. å†™å‰å¿«ç…§**

æ¯æ¬¡å†™å…¥å‰è‡ªåŠ¨åˆ›å»ºå¿«ç…§ã€‚åŸå› :
- **æ— éœ€ç”¨æˆ·å¹²é¢„**: è‡ªåŠ¨åŒ–å¿«ç…§åˆ›å»º,é™ä½ä½¿ç”¨é—¨æ§›
- **å®Œæ•´å†å²è®°å½•**: è®°å½•æ‰€æœ‰å†™å…¥æ“ä½œçš„å†å²
- **æ”¯æŒç²¾ç»†åŒ–æ’¤é”€**: å¯ä»¥æ’¤é”€åˆ°ä»»æ„å†å²ç‰ˆæœ¬

**5. å¿«ç…§æ¸…ç†ç­–ç•¥**

å®šæœŸæ¸…ç†è¿‡æœŸå¿«ç…§ã€‚åŸå› :
- **èŠ‚çœç£ç›˜ç©ºé—´**: é¿å…å¿«ç…§æ–‡ä»¶æ— é™å¢é•¿
- **ä¿æŒæ€§èƒ½**: å‡å°‘ç´¢å¼•æ–‡ä»¶å¤§å°,åŠ å¿«æŸ¥è¯¢é€Ÿåº¦
- **å¯é…ç½®**: ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä¿ç•™ç­–ç•¥(æœ€å¤§æ•°é‡ã€æœ€å¤§å¤©æ•°)

#### å¿«ç…§åˆ›å»ºæ—¶æœº

ç³»ç»Ÿåœ¨ä»¥ä¸‹æ—¶æœºè‡ªåŠ¨åˆ›å»ºå¿«ç…§:

1. **æ¦‚å¿µåˆ›å»º**
   - Stub æ–‡ä»¶åˆ›å»ºå‰: å¿«ç…§ç©ºå†…å®¹(æ–°æ–‡ä»¶)
   - Draft æ–‡ä»¶æ›´æ–°å‰: å¿«ç…§ Stub çŠ¶æ€

2. **æ¦‚å¿µæ›´æ–°**
   - å¢é‡æ”¹è¿›å‰: å¿«ç…§å½“å‰å†…å®¹
   - åˆå¹¶æ“ä½œå‰: å¿«ç…§ä¸¤ä¸ªæ¦‚å¿µçš„å†…å®¹

3. **æ¦‚å¿µåˆ é™¤**
   - åˆ é™¤å‰: å¿«ç…§å®Œæ•´å†…å®¹

**å‚è€ƒæ–‡ä»¶**: `src/core/pipeline-orchestrator.ts` çš„å¿«ç…§åˆ›å»ºé€»è¾‘

#### å¿«ç…§ä¿ç•™ç­–ç•¥

ç³»ç»Ÿæ”¯æŒä¸¤ç§ä¿ç•™ç­–ç•¥:

1. **æŒ‰æ•°é‡ä¿ç•™**
   - æœ€å¤§å¿«ç…§æ•°é‡: `maxSnapshots`(é»˜è®¤ 100)
   - è¶…è¿‡é™åˆ¶æ—¶,åˆ é™¤æœ€æ—§çš„å¿«ç…§

2. **æŒ‰æ—¶é—´ä¿ç•™**
   - æœ€å¤§ä¿ç•™å¤©æ•°: `maxAgeDays`(é»˜è®¤ 30)
   - è¶…è¿‡æ—¶é—´çš„å¿«ç…§è‡ªåŠ¨æ¸…ç†

**é…ç½®æ–¹å¼**:
```typescript
undoManager.updateRetentionPolicy(maxSnapshots, maxAgeDays);
```

**å‚è€ƒæ–‡ä»¶**: `src/core/undo-manager.ts` çš„ `updateRetentionPolicy()` å’Œ `cleanupExpiredSnapshots()` æ–¹æ³•

#### å¿«ç…§æ–‡ä»¶ç»“æ„

**å¿«ç…§ç´¢å¼•æ–‡ä»¶** (`data/snapshots/index.json`):
```json
{
  "version": "1.0.0",
  "snapshots": [
    {
      "id": "snapshot-1234567890-abc123",
      "nodeId": "concept-uid",
      "taskId": "task-1234567890-def456",
      "path": "concepts/entity/apple-company.md",
      "created": "2025-12-10T10:00:00.000Z",
      "fileSize": 1024,
      "checksum": "sha256-hash"
    }
  ],
  "retentionPolicy": {
    "maxCount": 100,
    "maxAgeDays": 30
  }
}
```

**å¿«ç…§å†…å®¹æ–‡ä»¶** (`data/snapshots/{snapshotId}.json`):
```json
{
  "id": "snapshot-1234567890-abc123",
  "nodeId": "concept-uid",
  "taskId": "task-1234567890-def456",
  "path": "concepts/entity/apple-company.md",
  "content": "---\nuid: concept-uid\ntype: Entity\nstatus: Draft\n...\n---\n\n# è‹¹æœå…¬å¸\n\n## æ ¸å¿ƒå®šä¹‰\n...",
  "created": "2025-12-10T10:00:00.000Z",
  "fileSize": 1024,
  "checksum": "a1b2c3d4e5f6..."
}
```

#### é”™è¯¯å¤„ç†

**å¿«ç…§ä¸å­˜åœ¨**
- é”™è¯¯ç : E303
- å¤„ç†: è¿”å›é”™è¯¯,é€šçŸ¥ç”¨æˆ·å¿«ç…§ä¸å­˜åœ¨
- å¯èƒ½åŸå› : å¿«ç…§å·²è¢«æ¸…ç†æˆ–ç´¢å¼•æŸå

**å¿«ç…§æ–‡ä»¶æŸå**
- é”™è¯¯ç : E303
- å¤„ç†: è¿”å›é”™è¯¯,é€šçŸ¥ç”¨æˆ·å¿«ç…§å·²æŸå
- å¯èƒ½åŸå› : ç£ç›˜é”™è¯¯æˆ–æ–‡ä»¶è¢«ç¯¡æ”¹

**æ¢å¤å¤±è´¥**
- é”™è¯¯ç : E303
- å¤„ç†: è¿”å›é”™è¯¯,ä¿ç•™åŸæ–‡ä»¶ä¸å˜
- å¯èƒ½åŸå› : ç£ç›˜ç©ºé—´ä¸è¶³æˆ–æƒé™ä¸è¶³

**ç´¢å¼•æŸå**
- é”™è¯¯ç : E303
- å¤„ç†: é‡å»ºç´¢å¼•æˆ–åˆ›å»ºæ–°ç´¢å¼•
- å¯èƒ½åŸå› : æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–ç‰ˆæœ¬ä¸å…¼å®¹

#### æ€§èƒ½ä¼˜åŒ–

**1. ç´¢å¼•ç¼“å­˜**

å¿«ç…§ç´¢å¼•åŠ è½½åˆ°å†…å­˜:
- å¯åŠ¨æ—¶åŠ è½½ä¸€æ¬¡
- åç»­æŸ¥è¯¢ç›´æ¥è®¿é—®å†…å­˜
- ä¿®æ”¹æ—¶åŒæ­¥æŒä¹…åŒ–

**2. æŒ‰éœ€åŠ è½½**

å¿«ç…§å†…å®¹æŒ‰éœ€åŠ è½½:
- ä»…åœ¨æ¢å¤æ—¶è¯»å–å¿«ç…§æ–‡ä»¶
- é¿å…åŠ è½½æ‰€æœ‰å¿«ç…§åˆ°å†…å­˜
- å‡å°‘å†…å­˜å ç”¨

**3. å¼‚æ­¥æ¸…ç†**

å¿«ç…§æ¸…ç†å¼‚æ­¥æ‰§è¡Œ:
- ä¸é˜»å¡ä¸»æµç¨‹
- å®šæœŸåå°æ¸…ç†
- é¿å…å½±å“ç”¨æˆ·ä½“éªŒ

**å‚è€ƒæ–‡ä»¶**:
- `src/core/undo-manager.ts`: æ’¤é”€ç®¡ç†é€»è¾‘
- `src/data/file-storage.ts`: åŸå­å†™å…¥å®ç°
- `src/ui/undo-notification.ts`: æ’¤é”€é€šçŸ¥

### 7.5 ç®¡çº¿ç¼–æ’æµç¨‹

ç®¡çº¿ç¼–æ’æ˜¯ Cognitive Razor çš„æ ¸å¿ƒåè°ƒæœºåˆ¶,è´Ÿè´£å°†æ¦‚å¿µåˆ›å»ºçš„å„ä¸ªé˜¶æ®µä¸²è”èµ·æ¥,å½¢æˆå®Œæ•´çš„é™ç†µä»ªå¼ã€‚PipelineOrchestrator ä½œä¸ºæ€»æ§åˆ¶å™¨,ç®¡ç†ç®¡çº¿çš„çŠ¶æ€è½¬æ¢ã€ç”¨æˆ·ç¡®è®¤å’Œé”™è¯¯å¤„ç†ã€‚

#### ç®¡çº¿é˜¶æ®µ

ç®¡çº¿åŒ…å«ä»¥ä¸‹é˜¶æ®µ,æŒ‰é¡ºåºæ‰§è¡Œ:

1. **idle**(ç©ºé—²): ç®¡çº¿æœªå¯åŠ¨
2. **standardizing**(æ ‡å‡†åŒ–ä¸­): è°ƒç”¨ AI è¿›è¡Œæ ‡å‡†åŒ–
3. **enriching**(ä¸°å¯Œä¸­): ç”Ÿæˆåˆ«åå’Œæ ‡ç­¾
4. **reasoning**(æ¨ç†ä¸­): ç”Ÿæˆæ¦‚å¿µå†…å®¹
5. **grounding**(Ground æ ¡éªŒä¸­): å¯é€‰,éªŒè¯å†…å®¹è´¨é‡
6. **awaiting_write_confirm**(ç­‰å¾…å†™å…¥ç¡®è®¤): ç­‰å¾…ç”¨æˆ·ç¡®è®¤å†™å…¥
7. **writing**(å†™å…¥ä¸­): æ‰§è¡Œæ–‡ä»¶å†™å…¥
8. **embedding**(åµŒå…¥ä¸­): ç”Ÿæˆå‘é‡åµŒå…¥
9. **deduplicating**(å»é‡ä¸­): æ‰§è¡Œå»é‡æ£€æµ‹
10. **completed**(å®Œæˆ): ç®¡çº¿æˆåŠŸå®Œæˆ
11. **failed**(å¤±è´¥): ç®¡çº¿æ‰§è¡Œå¤±è´¥

#### ç®¡çº¿ä¸Šä¸‹æ–‡

æ¯ä¸ªç®¡çº¿ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡(PipelineContext),åŒ…å«:

- **pipelineId**: ç®¡çº¿å”¯ä¸€æ ‡è¯†
- **nodeId**: æ¦‚å¿µå”¯ä¸€æ ‡è¯†(UID)
- **type**: æ¦‚å¿µç±»å‹(Domain/Issue/Theory/Entity/Mechanism)
- **stage**: å½“å‰é˜¶æ®µ
- **userInput**: ç”¨æˆ·è¾“å…¥
- **standardizedData**: æ ‡å‡†åŒ–ç»“æœ
- **enrichedData**: ä¸°å¯Œç»“æœ(åˆ«åå’Œæ ‡ç­¾)
- **embedding**: å‘é‡åµŒå…¥
- **generatedContent**: ç”Ÿæˆçš„å†…å®¹
- **filePath**: æ–‡ä»¶è·¯å¾„
- **snapshotId**: å¿«ç…§ ID
- **error**: é”™è¯¯ä¿¡æ¯(å¦‚æœå¤±è´¥)
- **createdAt**: åˆ›å»ºæ—¶é—´
- **updatedAt**: æ›´æ–°æ—¶é—´

#### å®Œæ•´ç®¡çº¿æµç¨‹å›¾

```mermaid
flowchart TD
    Start([ç”¨æˆ·è¾“å…¥]) --> Standardize[standardizing<br/>æ ‡å‡†åŒ–é˜¶æ®µ]
    Standardize --> StdSuccess{æ ‡å‡†åŒ–æˆåŠŸ?}
    StdSuccess -->|å¦| Failed1[failed<br/>ç®¡çº¿å¤±è´¥]
    StdSuccess -->|æ˜¯| TypeSelect[ç”¨æˆ·é€‰æ‹©ç±»å‹]
    
    TypeSelect --> Enrich[enriching<br/>ä¸°å¯Œé˜¶æ®µ]
    Enrich --> EnrichSuccess{ä¸°å¯ŒæˆåŠŸ?}
    EnrichSuccess -->|å¦| Failed2[failed<br/>ç®¡çº¿å¤±è´¥]
    EnrichSuccess -->|æ˜¯| Reason[reasoning<br/>æ¨ç†é˜¶æ®µ]
    
    Reason --> ReasonSuccess{æ¨ç†æˆåŠŸ?}
    ReasonSuccess -->|å¦| Failed3[failed<br/>ç®¡çº¿å¤±è´¥]
    ReasonSuccess -->|æ˜¯| GroundCheck{å¯ç”¨ Ground?}
    
    GroundCheck -->|æ˜¯| Ground[grounding<br/>Ground æ ¡éªŒ]
    GroundCheck -->|å¦| AwaitWrite[awaiting_write_confirm<br/>ç­‰å¾…å†™å…¥ç¡®è®¤]
    
    Ground --> GroundSuccess{Ground æˆåŠŸ?}
    GroundSuccess -->|å¦| Failed4[failed<br/>ç®¡çº¿å¤±è´¥]
    GroundSuccess -->|æ˜¯| AwaitWrite
    
    AwaitWrite --> UserConfirm[ç”¨æˆ·ç¡®è®¤å†™å…¥]
    UserConfirm --> Writing[writing<br/>å†™å…¥é˜¶æ®µ]
    
    Writing --> WriteSuccess{å†™å…¥æˆåŠŸ?}
    WriteSuccess -->|å¦| Failed5[failed<br/>ç®¡çº¿å¤±è´¥]
    WriteSuccess -->|æ˜¯| Embed[embedding<br/>åµŒå…¥é˜¶æ®µ]
    
    Embed --> EmbedSuccess{åµŒå…¥æˆåŠŸ?}
    EmbedSuccess -->|å¦| Failed6[failed<br/>ç®¡çº¿å¤±è´¥]
    EmbedSuccess -->|æ˜¯| Dedup[deduplicating<br/>å»é‡é˜¶æ®µ]
    
    Dedup --> DedupSuccess{å»é‡æˆåŠŸ?}
    DedupSuccess -->|å¦| Failed7[failed<br/>ç®¡çº¿å¤±è´¥]
    DedupSuccess -->|æ˜¯| Completed[completed<br/>ç®¡çº¿å®Œæˆ]
    
    Failed1 --> End([æµç¨‹ç»“æŸ])
    Failed2 --> End
    Failed3 --> End
    Failed4 --> End
    Failed5 --> End
    Failed6 --> End
    Failed7 --> End
    Completed --> End
    
    style Start fill:#e1f5ff
    style Completed fill:#c8e6c9
    style Failed1 fill:#ffcdd2
    style Failed2 fill:#ffcdd2
    style Failed3 fill:#ffcdd2
    style Failed4 fill:#ffcdd2
    style Failed5 fill:#ffcdd2
    style Failed6 fill:#ffcdd2
    style Failed7 fill:#ffcdd2
```

#### é˜¶æ®µè½¬æ¢é€»è¾‘

**1. standardizing â†’ enriching**

- è§¦å‘æ¡ä»¶: standardizeClassify ä»»åŠ¡å®Œæˆ
- æ“ä½œ:
  - ä¿å­˜æ ‡å‡†åŒ–ç»“æœåˆ° context.standardizedData
  - ç¡®å®šæ¦‚å¿µç±»å‹(primaryType æˆ–ç½®ä¿¡åº¦æœ€é«˜çš„)
  - åˆ›å»º enrich ä»»åŠ¡å¹¶å…¥é˜Ÿ
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `handleStandardizeCompleted()` æ–¹æ³•

**2. enriching â†’ awaiting_create_confirm**

- è§¦å‘æ¡ä»¶: enrich ä»»åŠ¡å®Œæˆ
- æ“ä½œ:
  - ä¿å­˜ä¸°å¯Œç»“æœåˆ° context.enrichedData
  - è‡ªåŠ¨è°ƒç”¨ confirmCreate()(æ— éœ€ UI äº¤äº’)
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `handleEnrichCompleted()` æ–¹æ³•

**3. awaiting_create_confirm â†’ reasoning**

- è§¦å‘æ¡ä»¶: ç”¨æˆ·ç¡®è®¤åˆ›å»º(è‡ªåŠ¨)
- æ“ä½œ:
  - åˆ›å»º Stub æ–‡ä»¶(ä»… frontmatter)
  - åˆ›å»ºå¿«ç…§(ç©ºå†…å®¹)
  - åˆ›å»º reason:new ä»»åŠ¡å¹¶å…¥é˜Ÿ
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreate()` æ–¹æ³•

**4. reasoning â†’ embedding**

- è§¦å‘æ¡ä»¶: reason:new ä»»åŠ¡å®Œæˆ
- æ“ä½œ:
  - ä¿å­˜ç”Ÿæˆå†…å®¹åˆ° context.generatedContent
  - ç›´æ¥æ‰§è¡Œ embedding(ä¸è¿›å…¥é˜Ÿåˆ—)
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `handleReasonNewCompleted()` æ–¹æ³•

**5. embedding â†’ grounding (å¯é€‰)**

- è§¦å‘æ¡ä»¶: embedding å®Œæˆä¸” settings.enableGrounding = true
- æ“ä½œ:
  - ä¿å­˜å‘é‡åµŒå…¥åˆ° context.embedding
  - åˆ›å»º ground ä»»åŠ¡å¹¶å…¥é˜Ÿ
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `executeEmbeddingDirect()` æ–¹æ³•

**6. grounding â†’ awaiting_write_confirm**

- è§¦å‘æ¡ä»¶: ground ä»»åŠ¡å®Œæˆ
- æ“ä½œ:
  - ä¿å­˜ Ground ç»“æœåˆ° context.groundingResult
  - è¿›å…¥ç­‰å¾…å†™å…¥ç¡®è®¤é˜¶æ®µ
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `handleGroundCompleted()` æ–¹æ³•

**7. awaiting_write_confirm â†’ writing**

- è§¦å‘æ¡ä»¶: ç”¨æˆ·ç¡®è®¤å†™å…¥
- æ“ä½œ:
  - è¯»å– Stub æ–‡ä»¶
  - æ›´æ–° status ä¸º Draft
  - æ¸²æŸ“ç”Ÿæˆå†…å®¹ä¸º Markdown
  - åˆ›å»ºå¿«ç…§(Stub çŠ¶æ€)
  - ä½¿ç”¨åŸå­å†™å…¥æ›´æ–°æ–‡ä»¶
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmWrite()` æ–¹æ³•

**8. writing â†’ deduplicating**

- è§¦å‘æ¡ä»¶: æ–‡ä»¶å†™å…¥æˆåŠŸ
- æ“ä½œ:
  - æ›´æ–°å‘é‡ç´¢å¼•
  - è°ƒç”¨ DuplicateManager.detect() æ‰§è¡Œå»é‡æ£€æµ‹
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreateWrite()` æ–¹æ³•

**9. deduplicating â†’ completed**

- è§¦å‘æ¡ä»¶: å»é‡æ£€æµ‹å®Œæˆ
- æ“ä½œ:
  - å‘å¸ƒ "pipeline_completed" äº‹ä»¶
  - é€šçŸ¥ UI æ›´æ–°
- å‚è€ƒ: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreateWrite()` æ–¹æ³•

#### äº‹ä»¶è®¢é˜…æœºåˆ¶

PipelineOrchestrator é€šè¿‡è®¢é˜… TaskQueue äº‹ä»¶æ¥å“åº”ä»»åŠ¡å®Œæˆ:

```typescript
// è®¢é˜…ä»»åŠ¡é˜Ÿåˆ—äº‹ä»¶
this.taskQueue.subscribe((event) => {
  if (event.type === "task-completed") {
    this.handleTaskCompleted(event.taskId);
  } else if (event.type === "task-failed") {
    this.handleTaskFailed(event.taskId);
  }
});
```

**ä»»åŠ¡å®Œæˆå¤„ç†**:
- æ ¹æ®ä»»åŠ¡ç±»å‹è°ƒç”¨å¯¹åº”çš„å¤„ç†æ–¹æ³•
- æ›´æ–°ç®¡çº¿ä¸Šä¸‹æ–‡
- è§¦å‘ä¸‹ä¸€é˜¶æ®µ

**ä»»åŠ¡å¤±è´¥å¤„ç†**:
- æ›´æ–°ç®¡çº¿çŠ¶æ€ä¸º "failed"
- è®°å½•é”™è¯¯ä¿¡æ¯
- å‘å¸ƒ "pipeline_failed" äº‹ä»¶

**å‚è€ƒæ–‡ä»¶**: `src/core/pipeline-orchestrator.ts` çš„ `subscribeToTaskQueue()` æ–¹æ³•

#### ç”¨æˆ·ç¡®è®¤æµç¨‹

ç³»ç»Ÿåœ¨ä¸¤ä¸ªå…³é”®ç‚¹éœ€è¦ç”¨æˆ·ç¡®è®¤:

**1. åˆ›å»ºç¡®è®¤(awaiting_create_confirm)**

- **å½“å‰å®ç°**: è‡ªåŠ¨ç¡®è®¤,æ— éœ€ UI äº¤äº’
- **åŸå› **: ç”¨æˆ·å·²åœ¨ç±»å‹é€‰æ‹©é˜¶æ®µåšå‡ºå†³ç­–
- **æœªæ¥æ‰©å±•**: å¯ä»¥æ·»åŠ é¢„è§ˆåŠŸèƒ½,è®©ç”¨æˆ·æŸ¥çœ‹ Stub å†…å®¹

**2. å†™å…¥ç¡®è®¤(awaiting_write_confirm)**

- **å½“å‰å®ç°**: éœ€è¦ç”¨æˆ·æ˜¾å¼ç¡®è®¤
- **åŸå› **: å†™å…¥æ˜¯ä¸å¯é€†æ“ä½œ(è™½ç„¶æœ‰å¿«ç…§,ä½†ä»éœ€è°¨æ…)
- **UI å±•ç¤º**: æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹é¢„è§ˆ,ç”¨æˆ·å¯ä»¥ç¼–è¾‘æˆ–ç¡®è®¤

**å‚è€ƒæ–‡ä»¶**: `src/core/pipeline-orchestrator.ts` çš„ `confirmCreate()` å’Œ `confirmWrite()` æ–¹æ³•

#### é”™è¯¯å¤„ç†

**ä»»åŠ¡æ‰§è¡Œå¤±è´¥**

- ç®¡çº¿çŠ¶æ€æ›´æ–°ä¸º "failed"
- è®°å½•é”™è¯¯ä¿¡æ¯åˆ° context.error
- å‘å¸ƒ "pipeline_failed" äº‹ä»¶
- ç”¨æˆ·å¯ä»¥åœ¨ WorkbenchPanel æŸ¥çœ‹å¤±è´¥åŸå› 

**ç®¡çº¿å–æ¶ˆ**

- ç”¨æˆ·å¯ä»¥éšæ—¶å–æ¶ˆç®¡çº¿
- å–æ¶ˆæ‰€æœ‰å…³è”çš„ä»»åŠ¡
- é‡Šæ”¾æŒæœ‰çš„é”
- æ›´æ–°ç®¡çº¿çŠ¶æ€ä¸º "failed"

**å‚è€ƒæ–‡ä»¶**: `src/core/pipeline-orchestrator.ts` çš„ `cancelPipeline()` æ–¹æ³•

#### ç®¡çº¿ç±»å‹

ç³»ç»Ÿæ”¯æŒä¸‰ç§ç®¡çº¿ç±»å‹:

1. **create**(åˆ›å»º): åˆ›å»ºæ–°æ¦‚å¿µ
2. **incremental**(å¢é‡æ”¹è¿›): æ”¹è¿›ç°æœ‰æ¦‚å¿µ
3. **merge**(åˆå¹¶): åˆå¹¶é‡å¤æ¦‚å¿µ

**æ³¨æ„**: å½“å‰ç‰ˆæœ¬ä¸»è¦å®ç°äº† create ç®¡çº¿,incremental å’Œ merge ç®¡çº¿çš„å®Œæ•´å®ç°åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ã€‚

#### æ€§èƒ½ä¼˜åŒ–

**1. å¼‚æ­¥æ‰§è¡Œ**

æ‰€æœ‰ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ,ä¸é˜»å¡ UI:
- ä½¿ç”¨ Promise å’Œ async/await
- ä»»åŠ¡æ‰§è¡Œåœ¨åå°è¿›è¡Œ
- UI é€šè¿‡äº‹ä»¶è®¢é˜…å®æ—¶æ›´æ–°

**2. å¹¶å‘æ§åˆ¶**

é€šè¿‡ TaskQueue æ§åˆ¶å¹¶å‘:
- é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°
- é¿å…èµ„æºè€—å°½
- ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

**3. çŠ¶æ€æŒä¹…åŒ–**

ç®¡çº¿çŠ¶æ€ä¸æŒä¹…åŒ–:
- ç®¡çº¿æ˜¯ä¸´æ—¶çš„,é‡å¯åä¸æ¢å¤
- ä»»åŠ¡çŠ¶æ€æŒä¹…åŒ–åˆ° queue-state.json
- é‡å¯åä»»åŠ¡ä¼šç»§ç»­æ‰§è¡Œ,ä½†ç®¡çº¿ä¸Šä¸‹æ–‡ä¸¢å¤±

#### ç»¼åˆæµç¨‹å›¾(åŒ…å«æ‰€æœ‰æ ¸å¿ƒæµç¨‹)

```mermaid
flowchart TD
    subgraph æ¦‚å¿µåˆ›å»ºæµç¨‹
        A1[ç”¨æˆ·è¾“å…¥] --> A2[æ ‡å‡†åŒ–]
        A2 --> A3[ç±»å‹é€‰æ‹©]
        A3 --> A4[ä¸°å¯Œ]
        A4 --> A5[åµŒå…¥]
        A5 --> A6[åˆ›å»º Stub]
        A6 --> A7[æ¨ç†]
        A7 --> A8[å†™å…¥ Draft]
        A8 --> A9[å»é‡æ£€æµ‹]
    end
    
    subgraph ä»»åŠ¡è°ƒåº¦æµç¨‹
        B1[ä»»åŠ¡å…¥é˜Ÿ] --> B2[æ£€æŸ¥é”å†²çª]
        B2 --> B3[æŒä¹…åŒ–é˜Ÿåˆ—]
        B3 --> B4[è°ƒåº¦å™¨è½®è¯¢]
        B4 --> B5[æ£€æŸ¥å¹¶å‘é™åˆ¶]
        B5 --> B6[è·å–é”]
        B6 --> B7[æ‰§è¡Œä»»åŠ¡]
        B7 --> B8[å¤„ç†ç»“æœ]
        B8 --> B9[é‡Šæ”¾é”]
        B9 --> B10[æŒä¹…åŒ–é˜Ÿåˆ—]
    end
    
    subgraph å»é‡æ£€æµ‹æµç¨‹
        C1[è·å–å‘é‡åµŒå…¥] --> C2[æœç´¢ç›¸ä¼¼æ¦‚å¿µ]
        C2 --> C3[è®¡ç®—ç›¸ä¼¼åº¦]
        C3 --> C4[åˆ¤æ–­é˜ˆå€¼]
        C4 --> C5[åˆ›å»ºé‡å¤å¯¹]
        C5 --> C6[æŒä¹…åŒ–]
        C6 --> C7[é€šçŸ¥ UI]
    end
    
    subgraph æ’¤é”€æ¢å¤æµç¨‹
        D1[è§¦å‘æ’¤é”€] --> D2[æŸ¥æ‰¾å¿«ç…§]
        D2 --> D3[è¯»å–å¿«ç…§]
        D3 --> D4[éªŒè¯æ ¡éªŒå’Œ]
        D4 --> D5[åŸå­å†™å…¥]
        D5 --> D6[æ›´æ–°ç´¢å¼•]
        D6 --> D7[æ˜¾ç¤ºé€šçŸ¥]
    end
    
    A4 --> B1
    A7 --> B1
    A9 --> C1
    A8 --> D1
    
    style A1 fill:#e1f5ff
    style A9 fill:#c8e6c9
    style B1 fill:#fff3e0
    style B10 fill:#fff3e0
    style C1 fill:#f3e5f5
    style C7 fill:#f3e5f5
    style D1 fill:#e8f5e9
    style D7 fill:#e8f5e9
```

**å‚è€ƒæ–‡ä»¶**:
- `src/core/pipeline-orchestrator.ts`: ç®¡çº¿ç¼–æ’é€»è¾‘
- `src/core/task-queue.ts`: ä»»åŠ¡è°ƒåº¦é€»è¾‘
- `src/core/duplicate-manager.ts`: å»é‡æ£€æµ‹é€»è¾‘
- `src/core/undo-manager.ts`: æ’¤é”€æ¢å¤é€»è¾‘

---

## 8. æ•°æ®æ¨¡å‹

### 8.1 Frontmatter ç»“æ„

Frontmatter æ˜¯ Cognitive Razor ç¬”è®°çš„å…ƒæ•°æ®æ ¸å¿ƒï¼Œå®šä¹‰äº†æ¦‚å¿µåœ¨ç³»ç»Ÿä¸­çš„èº«ä»½ã€ç±»å‹ã€çŠ¶æ€å’Œè°±ç³»å…³ç³»ã€‚æ¯ä¸ªæ¦‚å¿µç¬”è®°çš„ Frontmatter å¿…é¡»ç¬¦åˆ `CRFrontmatter` æ¥å£è§„èŒƒã€‚

#### æ¥å£å®šä¹‰

```typescript
interface CRFrontmatter {
  uid: string;           // UUID v4 å”¯ä¸€æ ‡è¯†ç¬¦
  type: CRType;          // çŸ¥è¯†ç±»å‹
  status: NoteState;     // ç¬”è®°çŠ¶æ€
  created: string;       // åˆ›å»ºæ—¶é—´ (ISO 8601)
  updated: string;       // æ›´æ–°æ—¶é—´ (ISO 8601)
  aliases?: string[];    // åˆ«ååˆ—è¡¨
  tags?: string[];       // æ ‡ç­¾åˆ—è¡¨
  parentUid?: string;    // çˆ¶æ¦‚å¿µ UID
  parentType?: CRType;   // çˆ¶æ¦‚å¿µç±»å‹
  sourceUids?: string[]; // æ¥æºæ¦‚å¿µ UIDs
  version?: string;      // ç‰ˆæœ¬å·
}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `uid` | `string` | âœ… | **å”¯ä¸€æ ‡è¯†ç¬¦**ï¼šUUID v4 æ ¼å¼ï¼Œå…¨å±€å”¯ä¸€ï¼Œä¸å¯å˜ã€‚ç”¨äºåœ¨ç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†æ¦‚å¿µï¼Œæ”¯æŒé‡å‘½åå’Œç§»åŠ¨æ“ä½œã€‚ |
| `type` | `CRType` | âœ… | **çŸ¥è¯†ç±»å‹**ï¼šäº”ç§æ ¸å¿ƒæ¦‚å¿µç±»å‹ä¹‹ä¸€ï¼š`Domain`ï¼ˆé¢†åŸŸï¼‰ã€`Issue`ï¼ˆè®®é¢˜ï¼‰ã€`Theory`ï¼ˆç†è®ºï¼‰ã€`Entity`ï¼ˆå®ä½“ï¼‰ã€`Mechanism`ï¼ˆæœºåˆ¶ï¼‰ã€‚å†³å®šæ¦‚å¿µçš„æœ¬ä½“è®ºåˆ†ç±»å’Œæ¨ç†æ¨¡æ¿ã€‚ |
| `status` | `NoteState` | âœ… | **ç¬”è®°çŠ¶æ€**ï¼šæ¦‚å¿µçš„æˆç†Ÿåº¦ï¼ŒåŒ…æ‹¬ `Stub`ï¼ˆå­˜æ ¹ï¼Œä»… Frontmatterï¼‰ã€`Draft`ï¼ˆè‰ç¨¿ï¼Œæœ‰å†…å®¹ä½†æœªå®Œå–„ï¼‰ã€`Evergreen`ï¼ˆå¸¸é’ï¼Œå†…å®¹å®Œå–„ä¸”ç¨³å®šï¼‰ã€‚ |
| `created` | `string` | âœ… | **åˆ›å»ºæ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼ˆå¦‚ `2025-12-10T08:30:00.000Z`ï¼‰ï¼Œè®°å½•æ¦‚å¿µé¦–æ¬¡åˆ›å»ºçš„æ—¶é—´ã€‚ |
| `updated` | `string` | âœ… | **æ›´æ–°æ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•æ¦‚å¿µæœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚æ¯æ¬¡å†™å…¥æ“ä½œéƒ½ä¼šæ›´æ–°æ­¤å­—æ®µã€‚ |
| `aliases` | `string[]` | âŒ | **åˆ«ååˆ—è¡¨**ï¼šæ¦‚å¿µçš„æ‰€æœ‰å¯èƒ½ç§°å‘¼ï¼ŒåŒ…æ‹¬å…¨ç§°ã€ç®€ç§°ã€ä¿—ç§°ã€å¤–æ–‡åç­‰ã€‚ç”¨äºæœç´¢å’Œé“¾æ¥è¯†åˆ«ã€‚ä¾‹å¦‚ï¼š`["äººå·¥æ™ºèƒ½", "AI", "Artificial Intelligence"]`ã€‚ |
| `tags` | `string[]` | âŒ | **æ ‡ç­¾åˆ—è¡¨**ï¼šæ¦‚å¿µçš„åˆ†ç±»æ ‡ç­¾ï¼Œç”¨äºç»„ç»‡å’Œè¿‡æ»¤ã€‚ä¾‹å¦‚ï¼š`["è®¡ç®—æœºç§‘å­¦", "æœºå™¨å­¦ä¹ ", "æ·±åº¦å­¦ä¹ "]`ã€‚ |
| `parentUid` | `string` | âŒ | **çˆ¶æ¦‚å¿µ UID**ï¼šå½“å‰æ¦‚å¿µçš„çˆ¶æ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ç”¨äºå»ºç«‹æ¦‚å¿µçš„å±‚çº§å…³ç³»ã€‚ä¾‹å¦‚ï¼Œ"æ·±åº¦å­¦ä¹ "çš„çˆ¶æ¦‚å¿µå¯èƒ½æ˜¯"æœºå™¨å­¦ä¹ "ã€‚ |
| `parentType` | `CRType` | âŒ | **çˆ¶æ¦‚å¿µç±»å‹**ï¼šçˆ¶æ¦‚å¿µçš„çŸ¥è¯†ç±»å‹ã€‚ä¸ `parentUid` é…åˆä½¿ç”¨ï¼Œç”¨äºéªŒè¯è°±ç³»å…³ç³»çš„åˆæ³•æ€§ã€‚ |
| `sourceUids` | `string[]` | âŒ | **æ¥æºæ¦‚å¿µ UIDs**ï¼šå½“å‰æ¦‚å¿µå¼•ç”¨æˆ–æ´¾ç”Ÿè‡ªçš„å…¶ä»–æ¦‚å¿µçš„ UID åˆ—è¡¨ã€‚ç”¨äºè¿½æº¯æ¦‚å¿µçš„çŸ¥è¯†æ¥æºã€‚ |
| `version` | `string` | âŒ | **ç‰ˆæœ¬å·**ï¼šæ¦‚å¿µçš„ç‰ˆæœ¬æ ‡è¯†ï¼Œç”¨äºè¿½è¸ªæ¦‚å¿µçš„æ¼”åŒ–å†å²ã€‚æ ¼å¼å»ºè®®ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆå¦‚ `1.0.0`ï¼‰ã€‚ |

#### çŸ¥è¯†ç±»å‹ (CRType)

```typescript
type CRType = "Domain" | "Issue" | "Theory" | "Entity" | "Mechanism";
```

- **Domainï¼ˆé¢†åŸŸï¼‰**ï¼šå›ç­”"ä½•æ‰€ä¸ºç•Œ"ï¼Œå®šä¹‰é—®é¢˜è®¨è®ºçš„åˆæ³•èŒƒå›´ã€‚ä¾‹å¦‚ï¼š"è®¤çŸ¥ç§‘å­¦"ã€"é‡å­ç‰©ç†"ã€‚
- **Issueï¼ˆè®®é¢˜ï¼‰**ï¼šå›ç­”"å“ªå¯¹çŸ›ç›¾"ï¼Œä½“ç°æ¨åŠ¨ç†è®ºæ¼”åŒ–çš„æ ¹æœ¬åŠ¨åŠ›ã€‚ä¾‹å¦‚ï¼š"è‡ªç”±æ„å¿—ä¸å†³å®šè®º"ã€"æ³¢ç²’äºŒè±¡æ€§"ã€‚
- **Theoryï¼ˆç†è®ºï¼‰**ï¼šå›ç­”"å¦‚ä½•è§£å†³"ï¼Œå½¢æˆä»å…¬ç†åˆ°è§£é‡Šæ¨¡å‹çš„é€»è¾‘è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼š"è¿›åŒ–è®º"ã€"ç›¸å¯¹è®º"ã€‚
- **Entityï¼ˆå®ä½“ï¼‰**ï¼šå›ç­”"ä½•ç‰©"ï¼Œå…·æœ‰å¯è§‚æµ‹å±æ€§çš„å…·ä½“åè¯æ€§å­˜åœ¨ã€‚ä¾‹å¦‚ï¼š"DNA"ã€"é»‘æ´"ã€‚
- **Mechanismï¼ˆæœºåˆ¶ï¼‰**ï¼šå›ç­”"ä½•å› è‡´ä½•æœ"ï¼Œæè¿°å®ä½“ä¹‹é—´ç›¸äº’ä½œç”¨çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼š"å…‰åˆä½œç”¨"ã€"ç¥ç»ä¼ å¯¼"ã€‚

#### ç¬”è®°çŠ¶æ€ (NoteState)

```typescript
type NoteState = "Stub" | "Draft" | "Evergreen";
```

- **Stubï¼ˆå­˜æ ¹ï¼‰**ï¼šä»…åŒ…å« Frontmatterï¼Œæ²¡æœ‰æ­£æ–‡å†…å®¹ã€‚æ¦‚å¿µåˆšåˆ›å»ºæ—¶çš„åˆå§‹çŠ¶æ€ã€‚
- **Draftï¼ˆè‰ç¨¿ï¼‰**ï¼šåŒ…å«æ­£æ–‡å†…å®¹ï¼Œä½†å†…å®¹å°šæœªå®Œå–„æˆ–éªŒè¯ã€‚æ¦‚å¿µç»è¿‡åˆæ¬¡æ¨ç†åçš„çŠ¶æ€ã€‚
- **Evergreenï¼ˆå¸¸é’ï¼‰**ï¼šå†…å®¹å®Œå–„ä¸”ç¨³å®šï¼Œç»è¿‡å¤šæ¬¡è¿­ä»£å’ŒéªŒè¯ã€‚æ¦‚å¿µçš„æœ€ç»ˆæˆç†ŸçŠ¶æ€ã€‚

#### ç¤ºä¾‹

**Domain ç±»å‹æ¦‚å¿µçš„ Frontmatter**ï¼š

```yaml
---
uid: 550e8400-e29b-41d4-a716-446655440000
type: Domain
status: Draft
created: 2025-12-10T08:30:00.000Z
updated: 2025-12-10T09:15:00.000Z
aliases:
  - è®¤çŸ¥ç§‘å­¦
  - Cognitive Science
  - è®¤çŸ¥ç ”ç©¶
tags:
  - è·¨å­¦ç§‘
  - å¿ƒç†å­¦
  - ç¥ç»ç§‘å­¦
  - äººå·¥æ™ºèƒ½
version: 1.0.0
---
```

**Entity ç±»å‹æ¦‚å¿µçš„ Frontmatterï¼ˆå¸¦çˆ¶æ¦‚å¿µï¼‰**ï¼š

```yaml
---
uid: 7c9e6679-7425-40de-944b-e07fc1f90ae7
type: Entity
status: Evergreen
created: 2025-12-08T14:20:00.000Z
updated: 2025-12-10T10:45:00.000Z
aliases:
  - DNA
  - è„±æ°§æ ¸ç³–æ ¸é…¸
  - Deoxyribonucleic Acid
  - é—ä¼ ç‰©è´¨
tags:
  - åˆ†å­ç”Ÿç‰©å­¦
  - é—ä¼ å­¦
  - ç”Ÿç‰©åŒ–å­¦
parentUid: 3fa85f64-5717-4562-b3fc-2c963f66afa6
parentType: Domain
sourceUids:
  - 9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d
  - 1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed
version: 2.1.0
---
```

**Theory ç±»å‹æ¦‚å¿µçš„ Frontmatterï¼ˆæœ€å°é…ç½®ï¼‰**ï¼š

```yaml
---
uid: a1b2c3d4-e5f6-7890-abcd-ef1234567890
type: Theory
status: Stub
created: 2025-12-10T11:00:00.000Z
updated: 2025-12-10T11:00:00.000Z
---
```

#### è®¾è®¡åŸåˆ™

1. **å”¯ä¸€æ€§ä¿éšœ**ï¼š`uid` å­—æ®µç¡®ä¿æ¯ä¸ªæ¦‚å¿µåœ¨ç³»ç»Ÿä¸­æ‹¥æœ‰å…¨å±€å”¯ä¸€çš„èº«ä»½æ ‡è¯†ï¼Œæ”¯æŒé‡å‘½åå’Œç§»åŠ¨æ“ä½œè€Œä¸ç ´åå¼•ç”¨å…³ç³»ã€‚

2. **ç±»å‹çº¦æŸ**ï¼š`type` å­—æ®µå°†æ¦‚å¿µä¸¥æ ¼åˆ†ç±»ä¸ºäº”ç§ç±»å‹ä¹‹ä¸€ï¼Œç¡®ä¿æœ¬ä½“è®ºçš„å®Œå¤‡æ€§å’Œä¸€è‡´æ€§ã€‚

3. **çŠ¶æ€æ¼”åŒ–**ï¼š`status` å­—æ®µè®°å½•æ¦‚å¿µçš„æˆç†Ÿåº¦ï¼Œæ”¯æŒä» Stub â†’ Draft â†’ Evergreen çš„æ¸è¿›å¼æ¼”åŒ–ã€‚

4. **æ—¶é—´é”šç‚¹**ï¼š`created` å’Œ `updated` å­—æ®µæä¾›æ—¶é—´ç»´åº¦çš„è¿½æº¯èƒ½åŠ›ï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†å’Œå†å²æŸ¥è¯¢ã€‚

5. **è°±ç³»è¿½è¸ª**ï¼š`parentUid`ã€`parentType` å’Œ `sourceUids` å­—æ®µå»ºç«‹æ¦‚å¿µä¹‹é—´çš„å±‚çº§å…³ç³»å’Œå¼•ç”¨å…³ç³»ï¼Œå½¢æˆçŸ¥è¯†å›¾è°±ã€‚

6. **å¯é€‰æ‰©å±•**ï¼š`aliases`ã€`tags`ã€`version` ç­‰å¯é€‰å­—æ®µæä¾›çµæ´»çš„æ‰©å±•èƒ½åŠ›ï¼Œæ”¯æŒä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚

#### éªŒè¯è§„åˆ™

ç³»ç»Ÿåœ¨åˆ›å»ºå’Œæ›´æ–° Frontmatter æ—¶ä¼šæ‰§è¡Œä»¥ä¸‹éªŒè¯ï¼š

- `uid` å¿…é¡»æ˜¯æœ‰æ•ˆçš„ UUID v4 æ ¼å¼
- `type` å¿…é¡»æ˜¯äº”ç§çŸ¥è¯†ç±»å‹ä¹‹ä¸€
- `status` å¿…é¡»æ˜¯ä¸‰ç§ç¬”è®°çŠ¶æ€ä¹‹ä¸€
- `created` å’Œ `updated` å¿…é¡»æ˜¯æœ‰æ•ˆçš„ ISO 8601 æ—¶é—´æˆ³
- `parentUid` å¦‚æœå­˜åœ¨ï¼Œå¿…é¡»å¼•ç”¨ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„æ¦‚å¿µ
- `parentType` å¦‚æœå­˜åœ¨ï¼Œå¿…é¡»ä¸ `parentUid` æŒ‡å‘çš„æ¦‚å¿µç±»å‹ä¸€è‡´
- `aliases` å’Œ `tags` å¦‚æœå­˜åœ¨ï¼Œå¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²æ•°ç»„

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šCRFrontmatter æ¥å£å®šä¹‰
- `src/core/frontmatter-utils.ts`ï¼šFrontmatter è§£æå’Œåºåˆ—åŒ–å·¥å…·

### 8.2 ä»»åŠ¡è®°å½•ç»“æ„

ä»»åŠ¡è®°å½•ï¼ˆTaskRecordï¼‰æ˜¯ Cognitive Razor ä»»åŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œè®°å½•äº†ä»»åŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸä¿¡æ¯ï¼ŒåŒ…æ‹¬ä»»åŠ¡ç±»å‹ã€çŠ¶æ€ã€æ‰§è¡Œå‚æ•°ã€ç»“æœå’Œé”™è¯¯å†å²ã€‚

#### æ¥å£å®šä¹‰

```typescript
interface TaskRecord {
  id: string;                          // ä»»åŠ¡ ID
  nodeId: string;                      // å…³è”çš„èŠ‚ç‚¹ ID (UID)
  taskType: TaskType;                  // ä»»åŠ¡ç±»å‹
  state: TaskState;                    // ä»»åŠ¡çŠ¶æ€
  providerRef?: string;                // Provider å¼•ç”¨
  promptRef?: string;                  // Prompt å¼•ç”¨
  attempt: number;                     // å½“å‰å°è¯•æ¬¡æ•°
  maxAttempts: number;                 // æœ€å¤§å°è¯•æ¬¡æ•°
  payload: Record<string, unknown>;    // ä»»åŠ¡è½½è·æ•°æ®
  result?: Record<string, unknown>;    // ä»»åŠ¡ç»“æœ
  undoPointer?: string;                // æ’¤é”€æŒ‡é’ˆ (å¿«ç…§ ID)
  lockKey?: string;                    // é”é”®
  typeLockKey?: string;                // ç±»å‹é”é”®
  created: string;                     // åˆ›å»ºæ—¶é—´
  updated: string;                     // æ›´æ–°æ—¶é—´
  startedAt?: string;                  // å¼€å§‹æ—¶é—´
  completedAt?: string;                // å®Œæˆæ—¶é—´
  errors?: TaskError[];                // é”™è¯¯å†å²
}

interface TaskError {
  code: string;        // é”™è¯¯ç 
  message: string;     // é”™è¯¯æ¶ˆæ¯
  timestamp: string;   // å‘ç”Ÿæ—¶é—´
  attempt: number;     // é‡è¯•æ¬¡æ•°
}
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `id` | `string` | âœ… | **ä»»åŠ¡ ID**ï¼šUUID v4 æ ¼å¼ï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†ä»»åŠ¡ã€‚ç”± TaskQueue åœ¨ä»»åŠ¡å…¥é˜Ÿæ—¶è‡ªåŠ¨ç”Ÿæˆã€‚ |
| `nodeId` | `string` | âœ… | **å…³è”çš„èŠ‚ç‚¹ ID**ï¼šä»»åŠ¡æ“ä½œçš„ç›®æ ‡æ¦‚å¿µçš„ UIDã€‚ç”¨äºé”ç®¡ç†å’Œç»“æœå…³è”ã€‚ |
| `taskType` | `TaskType` | âœ… | **ä»»åŠ¡ç±»å‹**ï¼šå®šä¹‰ä»»åŠ¡çš„å…·ä½“æ“ä½œç±»å‹ï¼Œå†³å®šä½¿ç”¨å“ªä¸ª Prompt æ¨¡æ¿å’Œå¤„ç†é€»è¾‘ã€‚ |
| `state` | `TaskState` | âœ… | **ä»»åŠ¡çŠ¶æ€**ï¼šä»»åŠ¡çš„å½“å‰æ‰§è¡ŒçŠ¶æ€ï¼Œæ”¯æŒå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ |
| `providerRef` | `string` | âŒ | **Provider å¼•ç”¨**ï¼šæ‰§è¡Œä»»åŠ¡ä½¿ç”¨çš„ Provider IDï¼ˆå¦‚ `"openai-main"`ï¼‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤ Providerã€‚ |
| `promptRef` | `string` | âŒ | **Prompt å¼•ç”¨**ï¼šä»»åŠ¡ä½¿ç”¨çš„ Prompt æ¨¡æ¿ IDï¼ˆå¦‚ `"enrich"`ã€`"reason-domain"`ï¼‰ã€‚ç”± PromptManager æ ¹æ® taskType è‡ªåŠ¨è§£æã€‚ |
| `attempt` | `number` | âœ… | **å½“å‰å°è¯•æ¬¡æ•°**ï¼šä»»åŠ¡å·²æ‰§è¡Œçš„æ¬¡æ•°ï¼Œä» 0 å¼€å§‹ã€‚ç”¨äºé‡è¯•é€»è¾‘å’Œé”™è¯¯è¿½è¸ªã€‚ |
| `maxAttempts` | `number` | âœ… | **æœ€å¤§å°è¯•æ¬¡æ•°**ï¼šä»»åŠ¡å…è®¸çš„æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚è¶…è¿‡æ­¤æ¬¡æ•°åä»»åŠ¡æ ‡è®°ä¸º Failedã€‚ |
| `payload` | `Record<string, unknown>` | âœ… | **ä»»åŠ¡è½½è·æ•°æ®**ï¼šä»»åŠ¡æ‰§è¡Œæ‰€éœ€çš„è¾“å…¥å‚æ•°ï¼Œå†…å®¹å› ä»»åŠ¡ç±»å‹è€Œå¼‚ã€‚ä¾‹å¦‚ï¼Œ`enrich` ä»»åŠ¡çš„ payload åŒ…å« `conceptName`ã€`conceptType` ç­‰å­—æ®µã€‚ |
| `result` | `Record<string, unknown>` | âŒ | **ä»»åŠ¡ç»“æœ**ï¼šä»»åŠ¡æ‰§è¡ŒæˆåŠŸåçš„è¾“å‡ºæ•°æ®ã€‚ä¾‹å¦‚ï¼Œ`embedding` ä»»åŠ¡çš„ result åŒ…å« `embedding` æ•°ç»„ã€‚ |
| `undoPointer` | `string` | âŒ | **æ’¤é”€æŒ‡é’ˆ**ï¼šæŒ‡å‘å¿«ç…§ IDï¼Œç”¨äºæ”¯æŒä»»åŠ¡çš„æ’¤é”€æ“ä½œã€‚ä»…å†™å…¥ç±»ä»»åŠ¡ï¼ˆå¦‚ `reason:new`ï¼‰ä¼šåˆ›å»ºå¿«ç…§ã€‚ |
| `lockKey` | `string` | âŒ | **é”é”®**ï¼šèŠ‚ç‚¹é”çš„é”®ï¼Œé€šå¸¸ç­‰äº `nodeId`ã€‚ç”¨äºé˜²æ­¢åŒä¸€æ¦‚å¿µçš„å¹¶å‘å†™å…¥ã€‚ |
| `typeLockKey` | `string` | âŒ | **ç±»å‹é”é”®**ï¼šç±»å‹é”çš„é”®ï¼Œæ ¼å¼ä¸º `type:{CRType}`ï¼ˆå¦‚ `"type:Domain"`ï¼‰ã€‚ç”¨äºé˜²æ­¢åŒç±»å‹æ¦‚å¿µçš„å¹¶å‘å»é‡æ£€æµ‹ã€‚ |
| `created` | `string` | âœ… | **åˆ›å»ºæ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•ä»»åŠ¡å…¥é˜Ÿçš„æ—¶é—´ã€‚ |
| `updated` | `string` | âœ… | **æ›´æ–°æ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•ä»»åŠ¡æœ€åä¸€æ¬¡çŠ¶æ€å˜æ›´çš„æ—¶é—´ã€‚ |
| `startedAt` | `string` | âŒ | **å¼€å§‹æ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•ä»»åŠ¡å¼€å§‹æ‰§è¡Œçš„æ—¶é—´ï¼ˆçŠ¶æ€å˜ä¸º Runningï¼‰ã€‚ |
| `completedAt` | `string` | âŒ | **å®Œæˆæ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•ä»»åŠ¡å®Œæˆçš„æ—¶é—´ï¼ˆçŠ¶æ€å˜ä¸º Completed æˆ– Failedï¼‰ã€‚ |
| `errors` | `TaskError[]` | âŒ | **é”™è¯¯å†å²**ï¼šä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„æ‰€æœ‰é”™è¯¯è®°å½•ï¼Œç”¨äºè°ƒè¯•å’Œé”™è¯¯åˆ†æã€‚ |

#### ä»»åŠ¡ç±»å‹ (TaskType)

```typescript
type TaskType =
  | "embedding"              // ç”Ÿæˆå‘é‡åµŒå…¥
  | "standardizeClassify"    // æ ‡å‡†åŒ–å’Œåˆ†ç±»
  | "enrich"                 // å†…å®¹ç”Ÿæˆï¼ˆåˆ«åå’Œæ ‡ç­¾ï¼‰
  | "reason:new"             // æ–°æ¦‚å¿µæ¨ç†ï¼ˆç”Ÿæˆæ­£æ–‡å†…å®¹ï¼‰
  | "ground";                // æ¥åœ°éªŒè¯
```

- **embedding**ï¼šè°ƒç”¨åµŒå…¥æ¨¡å‹ç”Ÿæˆæ¦‚å¿µçš„å‘é‡è¡¨ç¤ºï¼Œç”¨äºç›¸ä¼¼åº¦æœç´¢å’Œå»é‡æ£€æµ‹ã€‚
- **standardizeClassify**ï¼šæ ‡å‡†åŒ–ç”¨æˆ·è¾“å…¥çš„æ¦‚å¿µæè¿°ï¼Œç”Ÿæˆè§„èŒƒçš„æ¦‚å¿µåç§°å’Œç±»å‹åˆ†ç±»ã€‚
- **enrich**ï¼šç”Ÿæˆæ¦‚å¿µçš„åˆ«åå’Œæ ‡ç­¾ï¼Œä¸°å¯Œæ¦‚å¿µçš„å…ƒæ•°æ®ã€‚
- **reason:new**ï¼šæ ¹æ®æ¦‚å¿µç±»å‹ç”Ÿæˆæ­£æ–‡å†…å®¹ï¼Œä½¿ç”¨ä¸åŒçš„æ¨ç†æ¨¡æ¿ï¼ˆå¦‚ `reason-domain`ã€`reason-entity`ï¼‰ã€‚
- **ground**ï¼šéªŒè¯æ¦‚å¿µçš„æ¥åœ°æ€§ï¼Œç¡®ä¿æ¦‚å¿µä¸ç°å®ä¸–ç•Œçš„å¯¹åº”å…³ç³»ã€‚

#### ä»»åŠ¡çŠ¶æ€ (TaskState)

```typescript
type TaskState =
  | "Pending"      // ç­‰å¾…ä¸­
  | "Running"      // æ‰§è¡Œä¸­
  | "Completed"    // å·²å®Œæˆ
  | "Failed"       // å¤±è´¥
  | "Cancelled";   // å·²å–æ¶ˆ
```

#### ä»»åŠ¡çŠ¶æ€è½¬æ¢å›¾

```mermaid
stateDiagram-v2
    [*] --> Pending: ä»»åŠ¡å…¥é˜Ÿ
    
    Pending --> Running: è°ƒåº¦å™¨åˆ†é…
    Pending --> Cancelled: ç”¨æˆ·å–æ¶ˆ
    
    Running --> Completed: æ‰§è¡ŒæˆåŠŸ
    Running --> Failed: è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
    Running --> Pending: é‡è¯•ï¼ˆattempt < maxAttemptsï¼‰
    Running --> Cancelled: ç”¨æˆ·å–æ¶ˆ
    
    Completed --> [*]
    Failed --> [*]
    Cancelled --> [*]
    
    note right of Pending
        ç­‰å¾…è°ƒåº¦å™¨åˆ†é…
        æ£€æŸ¥é”å†²çª
        æ£€æŸ¥å¹¶å‘é™åˆ¶
    end note
    
    note right of Running
        è·å–é”
        è°ƒç”¨ AI API
        éªŒè¯è¾“å‡º
        å¤„ç†ç»“æœ
    end note
    
    note right of Completed
        é‡Šæ”¾é”
        æŒä¹…åŒ–ç»“æœ
        é€šçŸ¥ UI
    end note
    
    note right of Failed
        é‡Šæ”¾é”
        è®°å½•é”™è¯¯
        é€šçŸ¥ UI
    end note
```

**çŠ¶æ€è½¬æ¢è¯´æ˜**ï¼š

1. **Pending â†’ Running**ï¼šè°ƒåº¦å™¨æ£€æŸ¥é”å†²çªå’Œå¹¶å‘é™åˆ¶åï¼Œå°†ä»»åŠ¡åˆ†é…ç»™ TaskRunner æ‰§è¡Œã€‚
2. **Running â†’ Completed**ï¼šä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼ŒéªŒè¯é€šè¿‡ï¼Œç»“æœå·²æŒä¹…åŒ–ã€‚
3. **Running â†’ Pending**ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥ä½†æœªè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé‡æ–°å…¥é˜Ÿç­‰å¾…é‡è¯•ã€‚
4. **Running â†’ Failed**ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥ä¸”å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥ã€‚
5. **Pending/Running â†’ Cancelled**ï¼šç”¨æˆ·ä¸»åŠ¨å–æ¶ˆä»»åŠ¡ï¼Œé‡Šæ”¾èµ„æºã€‚

#### ç¤ºä¾‹

**embedding ä»»åŠ¡è®°å½•**ï¼š

```json
{
  "id": "task-550e8400-e29b-41d4-a716-446655440000",
  "nodeId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "taskType": "embedding",
  "state": "Completed",
  "providerRef": "openai-main",
  "promptRef": null,
  "attempt": 0,
  "maxAttempts": 3,
  "payload": {
    "conceptName": "æ·±åº¦å­¦ä¹ ",
    "conceptType": "Theory",
    "model": "text-embedding-3-small",
    "dimensions": 1536
  },
  "result": {
    "embedding": [0.023, -0.015, 0.042, ...],
    "tokensUsed": 12
  },
  "lockKey": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  "typeLockKey": "type:Theory",
  "created": "2025-12-10T08:30:00.000Z",
  "updated": "2025-12-10T08:30:15.000Z",
  "startedAt": "2025-12-10T08:30:05.000Z",
  "completedAt": "2025-12-10T08:30:15.000Z"
}
```

**reason:new ä»»åŠ¡è®°å½•ï¼ˆå¸¦é”™è¯¯å†å²ï¼‰**ï¼š

```json
{
  "id": "task-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "nodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "taskType": "reason:new",
  "state": "Completed",
  "providerRef": "openai-main",
  "promptRef": "reason-domain",
  "attempt": 2,
  "maxAttempts": 3,
  "payload": {
    "conceptName": "è®¤çŸ¥ç§‘å­¦",
    "conceptType": "Domain",
    "aliases": ["Cognitive Science", "è®¤çŸ¥ç ”ç©¶"],
    "tags": ["è·¨å­¦ç§‘", "å¿ƒç†å­¦", "ç¥ç»ç§‘å­¦"]
  },
  "result": {
    "content": "# è®¤çŸ¥ç§‘å­¦\n\nè®¤çŸ¥ç§‘å­¦æ˜¯ç ”ç©¶å¿ƒæ™ºå’Œæ™ºèƒ½çš„è·¨å­¦ç§‘é¢†åŸŸ...",
    "tokensUsed": 1500
  },
  "undoPointer": "snapshot-9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d",
  "lockKey": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "created": "2025-12-10T09:00:00.000Z",
  "updated": "2025-12-10T09:02:30.000Z",
  "startedAt": "2025-12-10T09:00:05.000Z",
  "completedAt": "2025-12-10T09:02:30.000Z",
  "errors": [
    {
      "code": "E001",
      "message": "è¾“å‡ºæ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€å­—æ®µ 'content'",
      "timestamp": "2025-12-10T09:00:45.000Z",
      "attempt": 0
    },
    {
      "code": "E100",
      "message": "ç½‘ç»œè¶…æ—¶ï¼šAPI è¯·æ±‚è¶…è¿‡ 30 ç§’",
      "timestamp": "2025-12-10T09:01:50.000Z",
      "attempt": 1
    }
  ]
}
```

**å¤±è´¥çš„ä»»åŠ¡è®°å½•**ï¼š

```json
{
  "id": "task-failed-example",
  "nodeId": "1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed",
  "taskType": "enrich",
  "state": "Failed",
  "providerRef": "openai-main",
  "promptRef": "enrich",
  "attempt": 3,
  "maxAttempts": 3,
  "payload": {
    "conceptName": "é‡å­çº ç¼ ",
    "conceptType": "Mechanism"
  },
  "lockKey": "1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed",
  "created": "2025-12-10T10:00:00.000Z",
  "updated": "2025-12-10T10:05:00.000Z",
  "startedAt": "2025-12-10T10:00:05.000Z",
  "completedAt": "2025-12-10T10:05:00.000Z",
  "errors": [
    {
      "code": "E100",
      "message": "ç½‘ç»œè¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° API ç«¯ç‚¹",
      "timestamp": "2025-12-10T10:01:00.000Z",
      "attempt": 0
    },
    {
      "code": "E100",
      "message": "ç½‘ç»œè¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° API ç«¯ç‚¹",
      "timestamp": "2025-12-10T10:02:30.000Z",
      "attempt": 1
    },
    {
      "code": "E100",
      "message": "ç½‘ç»œè¿æ¥å¤±è´¥ï¼šæ— æ³•è¿æ¥åˆ° API ç«¯ç‚¹",
      "timestamp": "2025-12-10T10:04:00.000Z",
      "attempt": 2
    }
  ]
}
```

#### è®¾è®¡åŸåˆ™

1. **å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸè¿½è¸ª**ï¼šä»åˆ›å»ºåˆ°å®Œæˆçš„æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ—¶é—´æˆ³è®°å½•ï¼Œæ”¯æŒæ€§èƒ½åˆ†æå’Œé—®é¢˜æ’æŸ¥ã€‚

2. **é”™è¯¯å¯è¿½æº¯**ï¼š`errors` æ•°ç»„è®°å½•æ‰€æœ‰å¤±è´¥å°è¯•çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–é‡è¯•ç­–ç•¥ã€‚

3. **é”æœºåˆ¶æ”¯æŒ**ï¼š`lockKey` å’Œ `typeLockKey` å­—æ®µæ”¯æŒèŠ‚ç‚¹é”å’Œç±»å‹é”ï¼Œé˜²æ­¢å¹¶å‘å†²çªã€‚

4. **æ’¤é”€æ”¯æŒ**ï¼š`undoPointer` å­—æ®µæŒ‡å‘å¿«ç…§ IDï¼Œæ”¯æŒä»»åŠ¡çš„æ’¤é”€æ“ä½œã€‚

5. **çµæ´»çš„è½½è·ç»“æ„**ï¼š`payload` å’Œ `result` ä½¿ç”¨ `Record<string, unknown>` ç±»å‹ï¼Œæ”¯æŒä¸åŒä»»åŠ¡ç±»å‹çš„è‡ªå®šä¹‰æ•°æ®ç»“æ„ã€‚

6. **é‡è¯•æœºåˆ¶**ï¼š`attempt` å’Œ `maxAttempts` å­—æ®µæ”¯æŒæ™ºèƒ½é‡è¯•ï¼ŒåŒºåˆ†ä¸´æ—¶é”™è¯¯å’Œæ°¸ä¹…é”™è¯¯ã€‚

#### æŒä¹…åŒ–

ä»»åŠ¡è®°å½•æŒä¹…åŒ–åˆ° `data/queue-state.json` æ–‡ä»¶ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "version": "1.0.0",
  "tasks": [
    { /* TaskRecord 1 */ },
    { /* TaskRecord 2 */ },
    ...
  ],
  "concurrency": 3,
  "paused": false,
  "stats": {
    "totalProcessed": 150,
    "totalFailed": 5,
    "totalCancelled": 2,
    "lastProcessedAt": "2025-12-10T10:30:00.000Z"
  },
  "locks": [
    { /* LockRecord 1 */ },
    { /* LockRecord 2 */ },
    ...
  ]
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šTaskRecord å’Œ TaskError æ¥å£å®šä¹‰
- `src/core/task-queue.ts`ï¼šä»»åŠ¡é˜Ÿåˆ—å®ç°å’ŒçŠ¶æ€ç®¡ç†
- `src/core/task-runner.ts`ï¼šä»»åŠ¡æ‰§è¡Œé€»è¾‘

### 8.3 å‘é‡ç´¢å¼•ç»“æ„

å‘é‡ç´¢å¼•æ˜¯ Cognitive Razor è¯­ä¹‰å»é‡ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œé€šè¿‡å°†æ¦‚å¿µæ˜ å°„åˆ°é«˜ç»´å‘é‡ç©ºé—´ï¼Œå®ç°ç²¾ç¡®çš„ç›¸ä¼¼åº¦è®¡ç®—å’Œå¿«é€Ÿçš„è¿‘é‚»æœç´¢ã€‚ç³»ç»Ÿé‡‡ç”¨æ–°çš„åˆ†æ¡¶å­˜å‚¨æ¶æ„ï¼ˆv2.0ï¼‰ï¼Œæ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ä¸ºå•ä¸ªæ–‡ä»¶ï¼Œæ”¯æŒå»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°ã€‚

#### æ¥å£å®šä¹‰

**å‘é‡æ¡ç›® (VectorEntry)** - å†…å­˜ä¸­çš„å‘é‡è¡¨ç¤ºï¼š

```typescript
interface VectorEntry {
  uid: string;           // æ¦‚å¿µ UID
  type: CRType;          // çŸ¥è¯†ç±»å‹
  embedding: number[];   // å‘é‡åµŒå…¥
  name: string;          // æ¦‚å¿µåç§°
  path: string;          // æ–‡ä»¶è·¯å¾„
  updated: string;       // æ›´æ–°æ—¶é—´
}
```

**å‘é‡ç´¢å¼•å…ƒæ•°æ® (VectorIndexMeta)** - è½»é‡çº§ç´¢å¼•æ–‡ä»¶ï¼š

```typescript
interface VectorIndexMeta {
  version: string;          // ç´¢å¼•ç‰ˆæœ¬ï¼ˆå½“å‰ä¸º "2.0"ï¼‰
  lastUpdated: number;      // æœ€åæ›´æ–°æ—¶é—´æˆ³
  stats: {
    totalConcepts: number;
    byType: Record<CRType, number>;
  };
  concepts: Record<string, ConceptMeta>;  // UID â†’ å…ƒæ•°æ®æ˜ å°„
}

interface ConceptMeta {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  filePath: string;         // å‘é‡æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ "Domain/uid.json"ï¼‰
  lastModified: number;     // æœ€åä¿®æ”¹æ—¶é—´æˆ³
  hasEmbedding: boolean;    // æ˜¯å¦æœ‰åµŒå…¥å‘é‡
}
```

**å•ä¸ªæ¦‚å¿µå‘é‡æ–‡ä»¶ (ConceptVector)** - ç‹¬ç«‹å­˜å‚¨çš„å‘é‡æ•°æ®ï¼š

```typescript
interface ConceptVector {
  id: string;               // æ¦‚å¿µ UID
  name: string;             // æ¦‚å¿µåç§°
  type: CRType;             // çŸ¥è¯†ç±»å‹
  embedding: number[];      // å‘é‡åµŒå…¥
  metadata: {
    createdAt: number;      // åˆ›å»ºæ—¶é—´æˆ³
    updatedAt: number;      // æ›´æ–°æ—¶é—´æˆ³
    embeddingModel: string; // åµŒå…¥æ¨¡å‹ï¼ˆå¦‚ "text-embedding-3-small"ï¼‰
    dimensions: number;     // å‘é‡ç»´åº¦ï¼ˆå¦‚ 1536ï¼‰
  };
}
```

**æœç´¢ç»“æœ (SearchResult)**ï¼š

```typescript
interface SearchResult {
  uid: string;           // æ¦‚å¿µ UID
  similarity: number;    // ç›¸ä¼¼åº¦åˆ†æ•° (0-1)
  name: string;          // æ¦‚å¿µåç§°
  path: string;          // æ–‡ä»¶è·¯å¾„
}
```

**ç´¢å¼•ç»Ÿè®¡ (IndexStats)**ï¼š

```typescript
interface IndexStats {
  totalEntries: number;                    // æ€»æ¡ç›®æ•°
  byType: Record<CRType, number>;          // æŒ‰ç±»å‹åˆ†ç»„çš„æ¡ç›®æ•°
  lastUpdated: string;                     // æœ€åæ›´æ–°æ—¶é—´
}
```

#### å­—æ®µè¯´æ˜

**VectorEntry å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `uid` | `string` | âœ… | **æ¦‚å¿µ UID**ï¼šæ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸ Frontmatter ä¸­çš„ `uid` å­—æ®µå¯¹åº”ã€‚ |
| `type` | `CRType` | âœ… | **çŸ¥è¯†ç±»å‹**ï¼šæ¦‚å¿µçš„ç±»å‹ï¼Œç”¨äºåˆ†æ¡¶ã€‚ç¡®ä¿åªåœ¨åŒç±»å‹æ¦‚å¿µä¹‹é—´è¿›è¡Œç›¸ä¼¼åº¦æ¯”è¾ƒã€‚ |
| `embedding` | `number[]` | âœ… | **å‘é‡åµŒå…¥**ï¼šæ¦‚å¿µçš„é«˜ç»´å‘é‡è¡¨ç¤ºï¼Œç”±åµŒå…¥æ¨¡å‹ç”Ÿæˆã€‚ç»´åº¦ç”± `VectorIndexFile.dimension` å®šä¹‰ï¼ˆé»˜è®¤ 1536ï¼‰ã€‚ |
| `name` | `string` | âœ… | **æ¦‚å¿µåç§°**ï¼šæ¦‚å¿µçš„æ ‡å‡†åç§°ï¼Œç”¨äºæœç´¢ç»“æœå±•ç¤ºã€‚ |
| `path` | `string` | âœ… | **æ–‡ä»¶è·¯å¾„**ï¼šæ¦‚å¿µç¬”è®°çš„ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº Vault æ ¹ç›®å½•ï¼‰ï¼Œç”¨äºæ‰“å¼€æ–‡ä»¶å’Œæ˜¾ç¤ºä½ç½®ã€‚ |
| `updated` | `string` | âœ… | **æ›´æ–°æ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•å‘é‡æ¡ç›®æœ€åä¸€æ¬¡æ›´æ–°çš„æ—¶é—´ã€‚ |

**VectorIndexMeta å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `version` | `string` | âœ… | **ç´¢å¼•ç‰ˆæœ¬**ï¼šç´¢å¼•æ–‡ä»¶çš„æ ¼å¼ç‰ˆæœ¬ï¼Œç”¨äºå…¼å®¹æ€§æ£€æŸ¥å’Œè¿ç§»ã€‚å½“å‰ç‰ˆæœ¬ä¸º `"2.0"`ã€‚ |
| `lastUpdated` | `number` | âœ… | **æœ€åæ›´æ–°æ—¶é—´æˆ³**ï¼šUnix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ï¼Œè®°å½•ç´¢å¼•æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ã€‚ |
| `stats.totalConcepts` | `number` | âœ… | **æ€»æ¦‚å¿µæ•°**ï¼šç´¢å¼•ä¸­æ‰€æœ‰æ¦‚å¿µçš„æ€»æ•°ã€‚ |
| `stats.byType` | `Record<CRType, number>` | âœ… | **æŒ‰ç±»å‹ç»Ÿè®¡**ï¼šæ¯ç§ç±»å‹çš„æ¦‚å¿µæ•°é‡ã€‚ |
| `concepts` | `Record<string, ConceptMeta>` | âœ… | **æ¦‚å¿µå…ƒæ•°æ®æ˜ å°„**ï¼šUID åˆ°æ¦‚å¿µå…ƒæ•°æ®çš„æ˜ å°„ï¼Œç”¨äºå¿«é€ŸæŸ¥æ‰¾ã€‚ |

**ConceptMeta å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `id` | `string` | âœ… | **æ¦‚å¿µ UID**ï¼šæ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ |
| `name` | `string` | âœ… | **æ¦‚å¿µåç§°**ï¼šæ¦‚å¿µçš„æ ‡å‡†åç§°ã€‚ |
| `type` | `CRType` | âœ… | **çŸ¥è¯†ç±»å‹**ï¼šæ¦‚å¿µçš„ç±»å‹ï¼ˆDomainã€Issueã€Theoryã€Entityã€Mechanismï¼‰ã€‚ |
| `filePath` | `string` | âœ… | **å‘é‡æ–‡ä»¶è·¯å¾„**ï¼šç›¸å¯¹äº `data/vectors/` çš„è·¯å¾„ï¼ˆå¦‚ `"Domain/uid.json"`ï¼‰ã€‚ |
| `lastModified` | `number` | âœ… | **æœ€åä¿®æ”¹æ—¶é—´æˆ³**ï¼šUnix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ã€‚ |
| `hasEmbedding` | `boolean` | âœ… | **æ˜¯å¦æœ‰åµŒå…¥**ï¼šæ ‡è®°è¯¥æ¦‚å¿µæ˜¯å¦å·²ç”Ÿæˆå‘é‡åµŒå…¥ã€‚ |

**ConceptVector å­—æ®µ**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `id` | `string` | âœ… | **æ¦‚å¿µ UID**ï¼šæ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ |
| `name` | `string` | âœ… | **æ¦‚å¿µåç§°**ï¼šæ¦‚å¿µçš„æ ‡å‡†åç§°ã€‚ |
| `type` | `CRType` | âœ… | **çŸ¥è¯†ç±»å‹**ï¼šæ¦‚å¿µçš„ç±»å‹ã€‚ |
| `embedding` | `number[]` | âœ… | **å‘é‡åµŒå…¥**ï¼šæ¦‚å¿µçš„é«˜ç»´å‘é‡è¡¨ç¤ºï¼Œç»´åº¦ç”± `metadata.dimensions` å®šä¹‰ã€‚ |
| `metadata.createdAt` | `number` | âœ… | **åˆ›å»ºæ—¶é—´æˆ³**ï¼šUnix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ã€‚ |
| `metadata.updatedAt` | `number` | âœ… | **æ›´æ–°æ—¶é—´æˆ³**ï¼šUnix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ã€‚ |
| `metadata.embeddingModel` | `string` | âœ… | **åµŒå…¥æ¨¡å‹**ï¼šç”Ÿæˆå‘é‡çš„æ¨¡å‹åç§°ï¼ˆå¦‚ `"text-embedding-3-small"`ï¼‰ã€‚ |
| `metadata.dimensions` | `number` | âœ… | **å‘é‡ç»´åº¦**ï¼šå‘é‡åµŒå…¥çš„ç»´åº¦æ•°ï¼ˆå¦‚ 1536ï¼‰ã€‚ |

#### åˆ†æ¡¶ç­–ç•¥

Cognitive Razor é‡‡ç”¨**æŒ‰ç±»å‹åˆ†æ¡¶**çš„ç­–ç•¥ç»„ç»‡å‘é‡æ•°æ®ï¼Œç¡®ä¿ç›¸ä¼¼åº¦æœç´¢åªåœ¨åŒç±»å‹æ¦‚å¿µä¹‹é—´è¿›è¡Œã€‚

**åˆ†æ¡¶åŸç†**ï¼š

- æ¯ä¸ªæ¦‚å¿µç±»å‹ï¼ˆDomainã€Issueã€Theoryã€Entityã€Mechanismï¼‰å¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„æ¡¶
- æœç´¢æ—¶åªåœ¨ç›®æ ‡ç±»å‹çš„æ¡¶å†…è¿›è¡Œï¼Œé¿å…è·¨ç±»å‹è¯¯åˆ¤
- ä¾‹å¦‚ï¼š"è‹¹æœå…¬å¸"ï¼ˆEntityï¼‰å’Œ"è‹¹æœæ°´æœ"ï¼ˆEntityï¼‰å¯èƒ½ç›¸ä¼¼ï¼Œä½†"è‹¹æœå…¬å¸"ï¼ˆEntityï¼‰å’Œ"è‹¹æœäº§ä¸š"ï¼ˆDomainï¼‰ä¸åº”è¢«åˆ¤å®šä¸ºé‡å¤

**æ–°æ¶æ„ä¼˜åŠ¿**ï¼š

1. **å»¶è¿ŸåŠ è½½**ï¼šå…ƒæ•°æ®ç´¢å¼•è½»é‡çº§ï¼ˆä»…åŒ…å«æ¦‚å¿µå…ƒä¿¡æ¯ï¼‰ï¼Œå‘é‡æ•°æ®æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚
2. **å¢é‡æ›´æ–°**ï¼šå•ä¸ªæ¦‚å¿µçš„å¢åˆ æ”¹åªå½±å“ä¸€ä¸ªæ–‡ä»¶ï¼Œé¿å…å…¨é‡ç´¢å¼•çš„è¯»å†™å¼€é”€ã€‚
3. **é¿å…è·¨ç±»å‹è¯¯åˆ¤**ï¼šæŒ‰ç±»å‹åˆ†æ¡¶å­˜å‚¨ï¼Œæœç´¢æ—¶åªæ£€ç´¢åŒç±»å‹ï¼Œä¸åŒç±»å‹çš„æ¦‚å¿µå³ä½¿åç§°ç›¸ä¼¼ä¹Ÿä¸ä¼šè¢«è¯¯åˆ¤ã€‚
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤§è§„æ¨¡çŸ¥è¯†åº“ï¼ˆæ•°ä¸‡ä¸ªæ¦‚å¿µï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨ã€‚
5. **è°ƒè¯•å‹å¥½**ï¼šæ¯ä¸ªæ¦‚å¿µçš„å‘é‡ç‹¬ç«‹å­˜å‚¨ï¼Œä¾¿äºæ£€æŸ¥å’Œæ’æŸ¥é—®é¢˜ã€‚
6. **å¹¶å‘å®‰å…¨**ï¼šä¸åŒæ¦‚å¿µçš„å‘é‡æ–‡ä»¶å¯ä»¥å¹¶å‘å†™å…¥ï¼Œæé«˜æ€§èƒ½ã€‚

#### ç›¸ä¼¼åº¦è®¡ç®—

ç³»ç»Ÿä½¿ç”¨**ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆCosine Similarityï¼‰**è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼š

```
similarity = (A Â· B) / (||A|| * ||B||)
```

å…¶ä¸­ï¼š
- `A Â· B` æ˜¯å‘é‡ A å’Œ B çš„ç‚¹ç§¯
- `||A||` å’Œ `||B||` æ˜¯å‘é‡ A å’Œ B çš„æ¬§å‡ é‡Œå¾—èŒƒæ•°ï¼ˆé•¿åº¦ï¼‰

**ç›¸ä¼¼åº¦èŒƒå›´**ï¼š
- `1.0`ï¼šå®Œå…¨ç›¸åŒ
- `0.9-1.0`ï¼šæé«˜ç›¸ä¼¼åº¦ï¼Œå¯èƒ½æ˜¯é‡å¤æ¦‚å¿µ
- `0.8-0.9`ï¼šé«˜ç›¸ä¼¼åº¦ï¼Œéœ€è¦äººå·¥åˆ¤æ–­
- `0.7-0.8`ï¼šä¸­ç­‰ç›¸ä¼¼åº¦ï¼Œå¯èƒ½ç›¸å…³ä½†ä¸é‡å¤
- `< 0.7`ï¼šä½ç›¸ä¼¼åº¦ï¼Œä¸ç›¸å…³

**é˜ˆå€¼è®¾ç½®**ï¼š

ç³»ç»Ÿä½¿ç”¨åŒé‡é˜ˆå€¼ç­–ç•¥ï¼š
- **é˜»æ–­é˜ˆå€¼ï¼ˆ> 0.95ï¼‰**ï¼šè‡ªåŠ¨æ‹’ç»æé«˜ç›¸ä¼¼åº¦çš„é‡å¤æ¦‚å¿µï¼Œä¸å…è®¸åˆ›å»º
- **æç¤ºé˜ˆå€¼ï¼ˆ> 0.85ï¼‰**ï¼šå°†ç–‘ä¼¼é‡å¤æäº¤äººç±»è£å†³ï¼Œç”¨æˆ·å¯é€‰æ‹©åˆå¹¶æˆ–ç»§ç»­åˆ›å»º

#### æ–°æ¶æ„ï¼šåˆ†æ¡¶å­˜å‚¨ï¼ˆv2.0ï¼‰

**ç›®å½•ç»“æ„**ï¼š

```
data/vectors/
â”œâ”€â”€ index.json              # è½»é‡çº§å…ƒæ•°æ®ç´¢å¼•
â”œâ”€â”€ Domain/                 # Domain ç±»å‹å‘é‡æ–‡ä»¶
â”‚   â”œâ”€â”€ 550e8400-e29b-41d4-a716-446655440000.json
â”‚   â””â”€â”€ 7c9e6679-7425-40de-944b-e07fc1f90ae7.json
â”œâ”€â”€ Issue/                  # Issue ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Theory/                 # Theory ç±»å‹å‘é‡æ–‡ä»¶
â”œâ”€â”€ Entity/                 # Entity ç±»å‹å‘é‡æ–‡ä»¶
â””â”€â”€ Mechanism/              # Mechanism ç±»å‹å‘é‡æ–‡ä»¶
```

**å…ƒæ•°æ®ç´¢å¼•æ–‡ä»¶ç¤ºä¾‹**ï¼ˆ`data/vectors/index.json`ï¼‰ï¼š

```json
{
  "version": "2.0",
  "lastUpdated": 1702200000000,
  "stats": {
    "totalConcepts": 5,
    "byType": {
      "Domain": 2,
      "Issue": 1,
      "Theory": 1,
      "Entity": 1,
      "Mechanism": 0
    }
  },
  "concepts": {
    "550e8400-e29b-41d4-a716-446655440000": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "è®¤çŸ¥ç§‘å­¦",
      "type": "Domain",
      "filePath": "Domain/550e8400-e29b-41d4-a716-446655440000.json",
      "lastModified": 1702200000000,
      "hasEmbedding": true
    },
    "7c9e6679-7425-40de-944b-e07fc1f90ae7": {
      "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
      "name": "é‡å­ç‰©ç†",
      "type": "Domain",
      "filePath": "Domain/7c9e6679-7425-40de-944b-e07fc1f90ae7.json",
      "lastModified": 1702201000000,
      "hasEmbedding": true
    }
  }
}
```

**å•ä¸ªå‘é‡æ–‡ä»¶ç¤ºä¾‹**ï¼ˆ`data/vectors/Domain/550e8400-e29b-41d4-a716-446655440000.json`ï¼‰ï¼š

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "name": "è®¤çŸ¥ç§‘å­¦",
  "type": "Domain",
  "embedding": [0.023, -0.015, 0.042, ..., 0.018],
  "metadata": {
    "createdAt": 1702200000000,
    "updatedAt": 1702200000000,
    "embeddingModel": "text-embedding-3-small",
    "dimensions": 1536
  }
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šVectorIndexMetaã€ConceptMetaã€ConceptVectorã€VectorEntry ç­‰æ¥å£å®šä¹‰
- `src/core/vector-index.ts`ï¼šVectorIndex å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬åˆ†æ¡¶å­˜å‚¨ã€å»¶è¿ŸåŠ è½½å’Œå¢é‡æ›´æ–°
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾› `readVectorFile()`ã€`writeVectorFile()`ã€`readVectorIndexMeta()`ã€`writeVectorIndexMeta()` ç­‰æ–¹æ³•
- `.kiro/steering/project-context.md`ï¼šé¡¹ç›®æ¶æ„çº¦æŸå’Œæ•°æ®æ–‡ä»¶è¯´æ˜

#### æœç´¢æµç¨‹ï¼ˆæ–°æ¶æ„ï¼‰

```mermaid
flowchart TD
    Start([æœç´¢è¯·æ±‚]) --> Input[è¾“å…¥: type, embedding, topK]
    Input --> CheckMeta{å…ƒæ•°æ®ç´¢å¼•ä¸­<br/>æ˜¯å¦æœ‰è¯¥ç±»å‹?}
    CheckMeta -->|å¦| EmptyResult[è¿”å›ç©ºç»“æœ]
    CheckMeta -->|æ˜¯| LoadVectors[æŒ‰éœ€åŠ è½½è¯¥ç±»å‹<br/>çš„å‘é‡æ–‡ä»¶]
    
    LoadVectors --> Loop[éå†å·²åŠ è½½çš„å‘é‡]
    Loop --> Cosine[è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦]
    Cosine --> Store[å­˜å‚¨ uid, similarity, name, path]
    Store --> NextEntry{è¿˜æœ‰å‘é‡?}
    NextEntry -->|æ˜¯| Loop
    NextEntry -->|å¦| Sort[æŒ‰ç›¸ä¼¼åº¦é™åºæ’åº]
    
    Sort --> TopK[å–å‰ topK ä¸ªç»“æœ]
    TopK --> Return[è¿”å›æœç´¢ç»“æœ]
    Return --> End([ç»“æŸ])
    
    EmptyResult --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style LoadVectors fill:#fff3e0
```

**æœç´¢æ­¥éª¤ï¼ˆæ–°æ¶æ„ï¼‰**ï¼š

1. **æ£€æŸ¥å…ƒæ•°æ®ç´¢å¼•**ï¼šä» `VectorIndexMeta.concepts` ä¸­æŸ¥æ‰¾è¯¥ç±»å‹çš„æ¦‚å¿µ
2. **å»¶è¿ŸåŠ è½½å‘é‡**ï¼šæŒ‰éœ€ä» `data/vectors/{type}/{uid}.json` åŠ è½½å‘é‡æ–‡ä»¶
3. **è®¡ç®—ç›¸ä¼¼åº¦**ï¼šéå†å·²åŠ è½½çš„å‘é‡ï¼Œè®¡ç®—æŸ¥è¯¢å‘é‡ä¸æ¯ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
4. **æ’åº**ï¼šæŒ‰ç›¸ä¼¼åº¦é™åºæ’åº
5. **å– TopK**ï¼šè¿”å›å‰ K ä¸ªæœ€ç›¸ä¼¼çš„ç»“æœï¼ˆK ç”± `topK` å‚æ•°æŒ‡å®šï¼Œé»˜è®¤ä¸º 10ï¼‰

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- å…ƒæ•°æ®ç´¢å¼•å§‹ç»ˆåœ¨å†…å­˜ä¸­ï¼ŒæŸ¥æ‰¾é€Ÿåº¦å¿«
- å‘é‡æ•°æ®æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨
- å·²åŠ è½½çš„å‘é‡ä¼šç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œé¿å…é‡å¤è¯»å–

#### ç´¢å¼•æ›´æ–°æ“ä½œï¼ˆæ–°æ¶æ„ï¼‰

**æ’å…¥æˆ–æ›´æ–°ï¼ˆUpsertï¼‰**ï¼š

```typescript
// å¦‚æœ UID å·²å­˜åœ¨ï¼Œæ›´æ–°å‘é‡æ–‡ä»¶ï¼›å¦åˆ™åˆ›å»ºæ–°æ–‡ä»¶
await vectorIndex.upsert({
  uid: "550e8400-e29b-41d4-a716-446655440000",
  type: "Domain",
  embedding: [0.023, -0.015, ...],
  name: "è®¤çŸ¥ç§‘å­¦",
  path: "1-é¢†åŸŸ/è®¤çŸ¥ç§‘å­¦.md",
  updated: new Date().toISOString()
});

// æ“ä½œæµç¨‹ï¼š
// 1. å†™å…¥å‘é‡æ–‡ä»¶ï¼šdata/vectors/Domain/550e8400-e29b-41d4-a716-446655440000.json
// 2. æ›´æ–°å…ƒæ•°æ®ç´¢å¼•ï¼šdata/vectors/index.json
```

**åˆ é™¤**ï¼š

```typescript
// æ ¹æ® UID åˆ é™¤å‘é‡æ–‡ä»¶å’Œå…ƒæ•°æ®
await vectorIndex.delete("550e8400-e29b-41d4-a716-446655440000");

// æ“ä½œæµç¨‹ï¼š
// 1. åˆ é™¤å‘é‡æ–‡ä»¶ï¼šdata/vectors/{type}/{uid}.json
// 2. æ›´æ–°å…ƒæ•°æ®ç´¢å¼•ï¼šdata/vectors/index.json
// 3. æ¸…é™¤å†…å­˜ç¼“å­˜
```

**æœç´¢**ï¼š

```typescript
// åœ¨ Domain ç±»å‹ä¸­æœç´¢æœ€ç›¸ä¼¼çš„ 10 ä¸ªæ¦‚å¿µ
const results = await vectorIndex.search(
  "Domain",
  [0.023, -0.015, ...],
  10
);

// ç»“æœæ ¼å¼ï¼š
// [
//   { uid: "...", similarity: 0.95, name: "è®¤çŸ¥ç§‘å­¦", path: "1-é¢†åŸŸ/è®¤çŸ¥ç§‘å­¦.md" },
//   { uid: "...", similarity: 0.87, name: "å¿ƒç†å­¦", path: "1-é¢†åŸŸ/å¿ƒç†å­¦.md" },
//   ...
// ]
```

#### è®¾è®¡åŸåˆ™ï¼ˆæ–°æ¶æ„ï¼‰

1. **ç±»å‹éš”ç¦»**ï¼šé€šè¿‡åˆ†æ¡¶ç›®å½•ç¡®ä¿åªåœ¨åŒç±»å‹æ¦‚å¿µä¹‹é—´è¿›è¡Œç›¸ä¼¼åº¦æ¯”è¾ƒï¼Œé¿å…è¯¯åˆ¤ã€‚

2. **å»¶è¿ŸåŠ è½½**ï¼šå…ƒæ•°æ®ç´¢å¼•è½»é‡çº§ï¼Œå‘é‡æ•°æ®æŒ‰éœ€åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨å’Œå¯åŠ¨æ—¶é—´ã€‚

3. **å¢é‡æ›´æ–°**ï¼šå•ä¸ªæ¦‚å¿µçš„å¢åˆ æ”¹åªå½±å“ä¸€ä¸ªæ–‡ä»¶ï¼Œé¿å…å…¨é‡ç´¢å¼•çš„è¯»å†™å¼€é”€ï¼Œæ”¯æŒå¹¶å‘å†™å…¥ã€‚

4. **æ¨¡å‹å…¼å®¹æ€§**ï¼šæ¯ä¸ªå‘é‡æ–‡ä»¶è®°å½•åµŒå…¥æ¨¡å‹å’Œç»´åº¦ä¿¡æ¯ï¼Œç¡®ä¿å‘é‡çš„å…¼å®¹æ€§ã€‚

5. **æŒä¹…åŒ–**ï¼šå‘é‡æ•°æ®å’Œå…ƒæ•°æ®åˆ†åˆ«æŒä¹…åŒ–ï¼Œæ”¯æŒæ–­ç”µæ¢å¤å’Œè·¨ä¼šè¯ä½¿ç”¨ã€‚

6. **ç»Ÿè®¡ä¿¡æ¯**ï¼šå…ƒæ•°æ®ç´¢å¼•ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾¿äºç›‘æ§å’Œè°ƒè¯•ã€‚

7. **å¯æ‰©å±•æ€§**ï¼šæ–‡ä»¶ç³»ç»Ÿå¤©ç„¶æ”¯æŒå¤§è§„æ¨¡å­˜å‚¨ï¼Œé€‚ç”¨äºæ•°ä¸‡ä¸ªæ¦‚å¿µçš„çŸ¥è¯†åº“ã€‚

#### æ€§èƒ½ä¼˜åŒ–ï¼ˆæ–°æ¶æ„ï¼‰

**å½“å‰å®ç°**ï¼š
- å…ƒæ•°æ®ç´¢å¼•è½»é‡çº§ï¼Œå§‹ç»ˆåœ¨å†…å­˜ä¸­ï¼ˆ< 1MBï¼‰
- å‘é‡æ•°æ®æŒ‰éœ€åŠ è½½ï¼Œå·²åŠ è½½çš„å‘é‡ç¼“å­˜åœ¨å†…å­˜ä¸­
- ä½¿ç”¨ç®€å•çš„çº¿æ€§æœç´¢ï¼ˆéå†åŒç±»å‹çš„æ‰€æœ‰å‘é‡ï¼‰
- é€‚ç”¨äºä¸­å°è§„æ¨¡çŸ¥è¯†åº“ï¼ˆ< 10,000 ä¸ªæ¦‚å¿µï¼‰
- æœç´¢æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œå…¶ä¸­ n æ˜¯åŒç±»å‹çš„æ¦‚å¿µæ•°

**æ€§èƒ½ç‰¹ç‚¹**ï¼š
- å¯åŠ¨å¿«ï¼šåªåŠ è½½å…ƒæ•°æ®ç´¢å¼•ï¼Œä¸åŠ è½½å‘é‡æ•°æ®
- å†…å­˜å ç”¨ä½ï¼šæŒ‰éœ€åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å‘é‡
- å†™å…¥å¿«ï¼šå•ä¸ªæ–‡ä»¶å†™å…¥ï¼Œé¿å…å…¨é‡ç´¢å¼•æ›´æ–°

**æœªæ¥ä¼˜åŒ–æ–¹å‘**ï¼š
- ä½¿ç”¨è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼ˆANNï¼‰ç®—æ³•ï¼ˆå¦‚ HNSWã€IVFï¼‰
- å¼•å…¥å‘é‡æ•°æ®åº“ï¼ˆå¦‚ Qdrantã€Milvusï¼‰
- æ”¯æŒæ‰¹é‡æœç´¢å’Œå¹¶è¡Œè®¡ç®—
- å®ç°å‘é‡æ–‡ä»¶çš„å‹ç¼©å­˜å‚¨

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šVectorEntryã€VectorIndexMetaã€ConceptMetaã€ConceptVectorã€SearchResult æ¥å£å®šä¹‰
- `src/core/vector-index.ts`ï¼šå‘é‡ç´¢å¼•å®ç°ï¼ŒåŒ…æ‹¬å»¶è¿ŸåŠ è½½ã€åˆ†æ¡¶å­˜å‚¨ã€æœç´¢å’Œç›¸ä¼¼åº¦è®¡ç®—
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼Œæä¾›å‘é‡æ–‡ä»¶è¯»å†™åŠŸèƒ½ï¼ˆ`readVectorFile`ã€`writeVectorFile`ã€`deleteVectorFile`ã€`readVectorIndexMeta`ã€`writeVectorIndexMeta`ï¼‰

### 8.4 é‡å¤å¯¹ç»“æ„

é‡å¤å¯¹ï¼ˆDuplicatePairï¼‰è®°å½•äº†ç³»ç»Ÿæ£€æµ‹åˆ°çš„ç–‘ä¼¼é‡å¤æ¦‚å¿µï¼Œæä¾›ç»™ç”¨æˆ·è¿›è¡Œäººå·¥è£å†³ã€‚æ¯ä¸ªé‡å¤å¯¹åŒ…å«ä¸¤ä¸ªæ¦‚å¿µçš„ä¿¡æ¯ã€ç›¸ä¼¼åº¦åˆ†æ•°å’Œå¤„ç†çŠ¶æ€ã€‚

#### æ¥å£å®šä¹‰

```typescript
interface DuplicatePair {
  id: string;                    // é‡å¤å¯¹ ID
  noteA: {
    nodeId: string;              // ç¬”è®° A çš„ UID
    name: string;                // ç¬”è®° A çš„åç§°
    path: string;                // ç¬”è®° A çš„è·¯å¾„
  };
  noteB: {
    nodeId: string;              // ç¬”è®° B çš„ UID
    name: string;                // ç¬”è®° B çš„åç§°
    path: string;                // ç¬”è®° B çš„è·¯å¾„
  };
  type: CRType;                  // çŸ¥è¯†ç±»å‹
  similarity: number;            // ç›¸ä¼¼åº¦ (0-1)
  detectedAt: string;            // æ£€æµ‹æ—¶é—´
  status: DuplicatePairStatus;   // çŠ¶æ€
}

type DuplicatePairStatus =
  | "pending"    // å¾…å¤„ç†
  | "merging"    // åˆå¹¶ä¸­
  | "merged"     // å·²åˆå¹¶
  | "dismissed"; // å·²å¿½ç•¥
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `id` | `string` | âœ… | **é‡å¤å¯¹ ID**ï¼šUUID v4 æ ¼å¼ï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†é‡å¤å¯¹ã€‚ç”± DuplicateManager åœ¨æ£€æµ‹åˆ°é‡å¤æ—¶è‡ªåŠ¨ç”Ÿæˆã€‚ |
| `noteA.nodeId` | `string` | âœ… | **ç¬”è®° A çš„ UID**ï¼šç¬¬ä¸€ä¸ªæ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚é€šå¸¸æ˜¯æ–°åˆ›å»ºçš„æ¦‚å¿µã€‚ |
| `noteA.name` | `string` | âœ… | **ç¬”è®° A çš„åç§°**ï¼šç¬¬ä¸€ä¸ªæ¦‚å¿µçš„æ ‡å‡†åç§°ï¼Œç”¨äº UI å±•ç¤ºã€‚ |
| `noteA.path` | `string` | âœ… | **ç¬”è®° A çš„è·¯å¾„**ï¼šç¬¬ä¸€ä¸ªæ¦‚å¿µç¬”è®°çš„ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº Vault æ ¹ç›®å½•ï¼‰ã€‚ |
| `noteB.nodeId` | `string` | âœ… | **ç¬”è®° B çš„ UID**ï¼šç¬¬äºŒä¸ªæ¦‚å¿µçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚é€šå¸¸æ˜¯å·²å­˜åœ¨çš„æ¦‚å¿µã€‚ |
| `noteB.name` | `string` | âœ… | **ç¬”è®° B çš„åç§°**ï¼šç¬¬äºŒä¸ªæ¦‚å¿µçš„æ ‡å‡†åç§°ï¼Œç”¨äº UI å±•ç¤ºã€‚ |
| `noteB.path` | `string` | âœ… | **ç¬”è®° B çš„è·¯å¾„**ï¼šç¬¬äºŒä¸ªæ¦‚å¿µç¬”è®°çš„ç›¸å¯¹è·¯å¾„ã€‚ |
| `type` | `CRType` | âœ… | **çŸ¥è¯†ç±»å‹**ï¼šä¸¤ä¸ªæ¦‚å¿µçš„å…±åŒç±»å‹ã€‚ç”±äºé‡‡ç”¨åˆ†æ¡¶ç­–ç•¥ï¼Œé‡å¤å¯¹ä¸­çš„ä¸¤ä¸ªæ¦‚å¿µå¿…å®šå±äºåŒä¸€ç±»å‹ã€‚ |
| `similarity` | `number` | âœ… | **ç›¸ä¼¼åº¦**ï¼šä¸¤ä¸ªæ¦‚å¿µçš„ä½™å¼¦ç›¸ä¼¼åº¦åˆ†æ•°ï¼ŒèŒƒå›´ 0-1ã€‚å€¼è¶Šæ¥è¿‘ 1 è¡¨ç¤ºè¶Šç›¸ä¼¼ã€‚ |
| `detectedAt` | `string` | âœ… | **æ£€æµ‹æ—¶é—´**ï¼šISO 8601 æ ¼å¼çš„æ—¶é—´æˆ³ï¼Œè®°å½•é‡å¤å¯¹è¢«æ£€æµ‹åˆ°çš„æ—¶é—´ã€‚ |
| `status` | `DuplicatePairStatus` | âœ… | **çŠ¶æ€**ï¼šé‡å¤å¯¹çš„å¤„ç†çŠ¶æ€ï¼Œæ”¯æŒå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ |

#### é‡å¤å¯¹çŠ¶æ€ (DuplicatePairStatus)

```typescript
type DuplicatePairStatus =
  | "pending"    // å¾…å¤„ç†ï¼šç­‰å¾…ç”¨æˆ·å†³ç­–
  | "merging"    // åˆå¹¶ä¸­ï¼šç”¨æˆ·é€‰æ‹©åˆå¹¶ï¼Œæ­£åœ¨æ‰§è¡Œåˆå¹¶ä»»åŠ¡
  | "merged"     // å·²åˆå¹¶ï¼šåˆå¹¶å®Œæˆï¼Œä¿ç•™ä¸€ä¸ªæ¦‚å¿µï¼Œåˆ é™¤å¦ä¸€ä¸ª
  | "dismissed"; // å·²å¿½ç•¥ï¼šç”¨æˆ·ç¡®è®¤ä¸æ˜¯é‡å¤ï¼Œä¿ç•™ä¸¤ä¸ªæ¦‚å¿µ
```

#### é‡å¤å¯¹çŠ¶æ€æµè½¬å›¾

```mermaid
stateDiagram-v2
    [*] --> pending: æ£€æµ‹åˆ°é‡å¤
    
    pending --> merging: ç”¨æˆ·é€‰æ‹©åˆå¹¶
    pending --> dismissed: ç”¨æˆ·é€‰æ‹©å¿½ç•¥
    
    merging --> merged: åˆå¹¶å®Œæˆ
    merging --> pending: åˆå¹¶å¤±è´¥
    
    merged --> [*]
    dismissed --> [*]
    
    note right of pending
        æ˜¾ç¤ºåœ¨å·¥ä½œå°
        ç­‰å¾…ç”¨æˆ·å†³ç­–
        å¯ä»¥æ‰“å¼€ä¸¤ä¸ªç¬”è®°å¯¹æ¯”
    end note
    
    note right of merging
        åˆ›å»ºåˆå¹¶ä»»åŠ¡
        æ‰§è¡Œå†…å®¹åˆå¹¶
        æ›´æ–°å‘é‡ç´¢å¼•
        åˆ é™¤é‡å¤ç¬”è®°
    end note
    
    note right of merged
        ä¿ç•™ä¸€ä¸ªæ¦‚å¿µ
        åˆ é™¤å¦ä¸€ä¸ªæ¦‚å¿µ
        æ›´æ–°æ‰€æœ‰å¼•ç”¨
    end note
    
    note right of dismissed
        æ ‡è®°ä¸ºéé‡å¤
        ä¸å†æç¤º
        ä¿ç•™åœ¨å†å²è®°å½•
    end note
```

**çŠ¶æ€è½¬æ¢è¯´æ˜**ï¼š

1. **[*] â†’ pending**ï¼šDuplicateManager åœ¨å‘é‡ç´¢å¼•ä¸­æ£€æµ‹åˆ°ç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼çš„æ¦‚å¿µå¯¹ï¼Œåˆ›å»ºé‡å¤å¯¹è®°å½•ã€‚

2. **pending â†’ merging**ï¼šç”¨æˆ·åœ¨å·¥ä½œå°çš„"é‡å¤æ¦‚å¿µ"åŒºåŸŸé€‰æ‹©"åˆå¹¶"æ“ä½œï¼ŒPipelineOrchestrator åˆ›å»ºåˆå¹¶ç®¡çº¿ã€‚

3. **merging â†’ merged**ï¼šåˆå¹¶ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œä¿ç•™ä¸€ä¸ªæ¦‚å¿µï¼ˆé€šå¸¸æ˜¯å†…å®¹æ›´å®Œå–„çš„é‚£ä¸ªï¼‰ï¼Œåˆ é™¤å¦ä¸€ä¸ªæ¦‚å¿µï¼Œæ›´æ–°æ‰€æœ‰å¼•ç”¨ã€‚

4. **merging â†’ pending**ï¼šåˆå¹¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ˆå¦‚æ–‡ä»¶è¢«é”å®šã€ç½‘ç»œé”™è¯¯ç­‰ï¼‰ï¼Œé‡å¤å¯¹çŠ¶æ€å›é€€åˆ° pendingï¼Œç­‰å¾…ç”¨æˆ·é‡è¯•ã€‚

5. **pending â†’ dismissed**ï¼šç”¨æˆ·ç¡®è®¤ä¸¤ä¸ªæ¦‚å¿µä¸æ˜¯é‡å¤ï¼ˆå¦‚"è‹¹æœå…¬å¸"å’Œ"è‹¹æœæ°´æœ"è™½ç„¶åç§°ç›¸ä¼¼ä½†å«ä¹‰ä¸åŒï¼‰ï¼Œæ ‡è®°ä¸ºå·²å¿½ç•¥ã€‚

6. **merged/dismissed â†’ [*]**ï¼šé‡å¤å¯¹å¤„ç†å®Œæˆï¼Œä»æ´»è·ƒåˆ—è¡¨ä¸­ç§»é™¤ï¼Œä¿ç•™åœ¨å†å²è®°å½•ä¸­ã€‚

#### ç¤ºä¾‹

**å¾…å¤„ç†çš„é‡å¤å¯¹**ï¼š

```json
{
  "id": "dup-550e8400-e29b-41d4-a716-446655440000",
  "noteA": {
    "nodeId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    "name": "æ·±åº¦å­¦ä¹ ",
    "path": "3-ç†è®º/æ·±åº¦å­¦ä¹ .md"
  },
  "noteB": {
    "nodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "name": "æ·±åº¦ç¥ç»ç½‘ç»œ",
    "path": "3-ç†è®º/æ·±åº¦ç¥ç»ç½‘ç»œ.md"
  },
  "type": "Theory",
  "similarity": 0.92,
  "detectedAt": "2025-12-10T08:30:00.000Z",
  "status": "pending"
}
```

**åˆå¹¶ä¸­çš„é‡å¤å¯¹**ï¼š

```json
{
  "id": "dup-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "noteA": {
    "nodeId": "1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed",
    "name": "é‡å­çº ç¼ ",
    "path": "5-æœºåˆ¶/é‡å­çº ç¼ .md"
  },
  "noteB": {
    "nodeId": "9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d",
    "name": "é‡å­çº ç¼ ç°è±¡",
    "path": "5-æœºåˆ¶/é‡å­çº ç¼ ç°è±¡.md"
  },
  "type": "Mechanism",
  "similarity": 0.96,
  "detectedAt": "2025-12-10T09:00:00.000Z",
  "status": "merging"
}
```

**å·²å¿½ç•¥çš„é‡å¤å¯¹**ï¼š

```json
{
  "id": "dup-dismissed-example",
  "noteA": {
    "nodeId": "apple-company-uid",
    "name": "è‹¹æœå…¬å¸",
    "path": "4-å®ä½“/è‹¹æœå…¬å¸.md"
  },
  "noteB": {
    "nodeId": "apple-fruit-uid",
    "name": "è‹¹æœï¼ˆæ°´æœï¼‰",
    "path": "4-å®ä½“/è‹¹æœï¼ˆæ°´æœï¼‰.md"
  },
  "type": "Entity",
  "similarity": 0.88,
  "detectedAt": "2025-12-10T10:00:00.000Z",
  "status": "dismissed"
}
```

#### æŒä¹…åŒ–ç»“æ„

é‡å¤å¯¹æ•°æ®æŒä¹…åŒ–åˆ° `data/duplicate-pairs.json` æ–‡ä»¶ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "version": "1.0.0",
  "pairs": [
    {
      "id": "dup-550e8400-e29b-41d4-a716-446655440000",
      "noteA": {
        "nodeId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
        "name": "æ·±åº¦å­¦ä¹ ",
        "path": "3-ç†è®º/æ·±åº¦å­¦ä¹ .md"
      },
      "noteB": {
        "nodeId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
        "name": "æ·±åº¦ç¥ç»ç½‘ç»œ",
        "path": "3-ç†è®º/æ·±åº¦ç¥ç»ç½‘ç»œ.md"
      },
      "type": "Theory",
      "similarity": 0.92,
      "detectedAt": "2025-12-10T08:30:00.000Z",
      "status": "pending"
    },
    {
      "id": "dup-a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "noteA": {
        "nodeId": "1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed",
        "name": "é‡å­çº ç¼ ",
        "path": "5-æœºåˆ¶/é‡å­çº ç¼ .md"
      },
      "noteB": {
        "nodeId": "9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d",
        "name": "é‡å­çº ç¼ ç°è±¡",
        "path": "5-æœºåˆ¶/é‡å­çº ç¼ ç°è±¡.md"
      },
      "type": "Mechanism",
      "similarity": 0.96,
      "detectedAt": "2025-12-10T09:00:00.000Z",
      "status": "merging"
    }
  ],
  "dismissedPairs": [
    "dup-dismissed-example-1",
    "dup-dismissed-example-2"
  ]
}
```

**å­—æ®µè¯´æ˜**ï¼š

- `version`ï¼šå­˜å‚¨æ–‡ä»¶çš„æ ¼å¼ç‰ˆæœ¬ï¼Œç”¨äºå…¼å®¹æ€§æ£€æŸ¥ã€‚
- `pairs`ï¼šæ‰€æœ‰é‡å¤å¯¹çš„æ•°ç»„ï¼ŒåŒ…æ‹¬ pendingã€merging å’Œ merged çŠ¶æ€çš„é‡å¤å¯¹ã€‚
- `dismissedPairs`ï¼šå·²å¿½ç•¥çš„é‡å¤å¯¹ ID åˆ—è¡¨ï¼Œç”¨äºå†å²è®°å½•å’Œé˜²æ­¢é‡å¤æç¤ºã€‚

#### æ£€æµ‹æµç¨‹

```mermaid
flowchart TD
    Start([æ¦‚å¿µåˆ›å»ºå®Œæˆ]) --> Embed[ç”Ÿæˆå‘é‡åµŒå…¥]
    Embed --> Search[åœ¨å‘é‡ç´¢å¼•ä¸­æœç´¢]
    Search --> Results[è·å– TopK ç›¸ä¼¼æ¦‚å¿µ]
    Results --> Filter{ç›¸ä¼¼åº¦ > é˜ˆå€¼?}
    
    Filter -->|å¦| NoDup[æ— é‡å¤]
    Filter -->|æ˜¯| CheckExist{æ˜¯å¦å·²å­˜åœ¨é‡å¤å¯¹?}
    
    CheckExist -->|æ˜¯| Skip[è·³è¿‡ï¼ˆé¿å…é‡å¤æç¤ºï¼‰]
    CheckExist -->|å¦| CreatePair[åˆ›å»ºé‡å¤å¯¹è®°å½•]
    
    CreatePair --> SetStatus[è®¾ç½®çŠ¶æ€ä¸º pending]
    SetStatus --> Persist[æŒä¹…åŒ–åˆ°æ–‡ä»¶]
    Persist --> Notify[é€šçŸ¥ UI æ›´æ–°]
    Notify --> End([ç»“æŸ])
    
    NoDup --> End
    Skip --> End
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style CreatePair fill:#fff3e0
    style Persist fill:#f1f8e9
```

**æ£€æµ‹æ­¥éª¤**ï¼š

1. **ç”Ÿæˆå‘é‡åµŒå…¥**ï¼šæ¦‚å¿µåˆ›å»ºå®Œæˆåï¼Œæ‰§è¡Œ embedding ä»»åŠ¡ç”Ÿæˆå‘é‡åµŒå…¥ã€‚
2. **æœç´¢ç›¸ä¼¼æ¦‚å¿µ**ï¼šåœ¨å‘é‡ç´¢å¼•çš„å¯¹åº”ç±»å‹æ¡¶ä¸­æœç´¢æœ€ç›¸ä¼¼çš„ TopK ä¸ªæ¦‚å¿µã€‚
3. **è¿‡æ»¤**ï¼šè¿‡æ»¤å‡ºç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼ï¼ˆé»˜è®¤ 0.85ï¼‰çš„æ¦‚å¿µã€‚
4. **æ£€æŸ¥é‡å¤**ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é‡å¤å¯¹ï¼ˆé¿å…é‡å¤æç¤ºï¼‰ã€‚
5. **åˆ›å»ºé‡å¤å¯¹**ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„é‡å¤å¯¹è®°å½•ï¼ŒçŠ¶æ€è®¾ç½®ä¸º pendingã€‚
6. **æŒä¹…åŒ–**ï¼šå°†é‡å¤å¯¹ä¿å­˜åˆ° `data/duplicate-pairs.json` æ–‡ä»¶ã€‚
7. **é€šçŸ¥ UI**ï¼šé€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶é€šçŸ¥ WorkbenchPanel æ›´æ–°"é‡å¤æ¦‚å¿µ"åŒºåŸŸã€‚

#### åˆå¹¶æµç¨‹

```mermaid
flowchart TD
    Start([ç”¨æˆ·é€‰æ‹©åˆå¹¶]) --> SelectKeep[ç”¨æˆ·é€‰æ‹©ä¿ç•™å“ªä¸ªæ¦‚å¿µ]
    SelectKeep --> CreateTask[åˆ›å»ºåˆå¹¶ä»»åŠ¡]
    CreateTask --> UpdateStatus1[æ›´æ–°çŠ¶æ€ä¸º merging]
    
    UpdateStatus1 --> ReadBoth[è¯»å–ä¸¤ä¸ªç¬”è®°å†…å®¹]
    ReadBoth --> MergeContent[åˆå¹¶å†…å®¹]
    MergeContent --> Snapshot[åˆ›å»ºå¿«ç…§]
    Snapshot --> WriteKeep[å†™å…¥ä¿ç•™çš„ç¬”è®°]
    
    WriteKeep --> DeleteOther[åˆ é™¤å¦ä¸€ä¸ªç¬”è®°]
    DeleteOther --> UpdateIndex[æ›´æ–°å‘é‡ç´¢å¼•]
    UpdateIndex --> UpdateRefs[æ›´æ–°æ‰€æœ‰å¼•ç”¨]
    
    UpdateRefs --> UpdateStatus2[æ›´æ–°çŠ¶æ€ä¸º merged]
    UpdateStatus2 --> Persist[æŒä¹…åŒ–]
    Persist --> Notify[é€šçŸ¥ UI]
    Notify --> End([åˆå¹¶å®Œæˆ])
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style MergeContent fill:#fff3e0
    style Persist fill:#f1f8e9
```

**åˆå¹¶æ­¥éª¤**ï¼š

1. **ç”¨æˆ·é€‰æ‹©**ï¼šç”¨æˆ·åœ¨å·¥ä½œå°é€‰æ‹©ä¿ç•™å“ªä¸ªæ¦‚å¿µï¼ˆé€šå¸¸é€‰æ‹©å†…å®¹æ›´å®Œå–„çš„é‚£ä¸ªï¼‰ã€‚
2. **åˆ›å»ºç®¡çº¿**ï¼šPipelineOrchestrator åˆ›å»ºåˆå¹¶ç®¡çº¿ï¼Œæ›´æ–°é‡å¤å¯¹çŠ¶æ€ä¸º mergingã€‚
3. **è¯»å–å†…å®¹**ï¼šè¯»å–ä¸¤ä¸ªç¬”è®°çš„å®Œæ•´å†…å®¹ï¼ˆFrontmatter + æ­£æ–‡ï¼‰ã€‚
4. **åˆå¹¶å†…å®¹**ï¼šåˆå¹¶ä¸¤ä¸ªç¬”è®°çš„å†…å®¹ï¼Œä¿ç•™æ›´å®Œå–„çš„éƒ¨åˆ†ï¼Œåˆå¹¶åˆ«åå’Œæ ‡ç­¾ã€‚
5. **åˆ›å»ºå¿«ç…§**ï¼šä¸ºä¿ç•™çš„ç¬”è®°åˆ›å»ºå¿«ç…§ï¼Œæ”¯æŒæ’¤é”€æ“ä½œã€‚
6. **å†™å…¥**ï¼šå°†åˆå¹¶åçš„å†…å®¹å†™å…¥ä¿ç•™çš„ç¬”è®°ã€‚
7. **åˆ é™¤**ï¼šåˆ é™¤å¦ä¸€ä¸ªç¬”è®°æ–‡ä»¶ã€‚
8. **æ›´æ–°ç´¢å¼•**ï¼šä»å‘é‡ç´¢å¼•ä¸­åˆ é™¤è¢«åˆ é™¤ç¬”è®°çš„æ¡ç›®ã€‚
9. **æ›´æ–°å¼•ç”¨**ï¼šæ‰«ææ‰€æœ‰ç¬”è®°ï¼Œå°†å¯¹è¢«åˆ é™¤ç¬”è®°çš„å¼•ç”¨æ›´æ–°ä¸ºä¿ç•™ç¬”è®°çš„å¼•ç”¨ã€‚
10. **æ›´æ–°çŠ¶æ€**ï¼šå°†é‡å¤å¯¹çŠ¶æ€æ›´æ–°ä¸º mergedã€‚
11. **æŒä¹…åŒ–**ï¼šä¿å­˜é‡å¤å¯¹åˆ—è¡¨ã€‚
12. **é€šçŸ¥ UI**ï¼šæ›´æ–°å·¥ä½œå°æ˜¾ç¤ºã€‚

#### è®¾è®¡åŸåˆ™

1. **äººç±»è£å†³**ï¼šç³»ç»Ÿåªè´Ÿè´£æ£€æµ‹å’Œæç¤ºï¼Œæœ€ç»ˆå†³ç­–æƒåœ¨ç”¨æˆ·æ‰‹ä¸­ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©åˆå¹¶ã€å¿½ç•¥æˆ–ç¨åå¤„ç†ã€‚

2. **åŒé‡é˜ˆå€¼**ï¼š
   - **é˜»æ–­é˜ˆå€¼ï¼ˆ> 0.95ï¼‰**ï¼šæé«˜ç›¸ä¼¼åº¦ï¼Œè‡ªåŠ¨æ‹’ç»åˆ›å»ºï¼Œå¼ºåˆ¶ç”¨æˆ·å¤„ç†é‡å¤
   - **æç¤ºé˜ˆå€¼ï¼ˆ> 0.85ï¼‰**ï¼šé«˜ç›¸ä¼¼åº¦ï¼Œæç¤ºç”¨æˆ·ä½†å…è®¸ç»§ç»­åˆ›å»º

3. **é¿å…é‡å¤æç¤º**ï¼šç³»ç»Ÿè®°å½•å·²æ£€æµ‹åˆ°çš„é‡å¤å¯¹ï¼Œé¿å…å¤šæ¬¡æç¤ºç›¸åŒçš„é‡å¤ã€‚

4. **å¯æ’¤é”€**ï¼šåˆå¹¶æ“ä½œä¼šåˆ›å»ºå¿«ç…§ï¼Œæ”¯æŒæ’¤é”€ã€‚å¦‚æœåˆå¹¶é”™è¯¯ï¼Œå¯ä»¥æ¢å¤åŸçŠ¶æ€ã€‚

5. **å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ**ï¼šä»æ£€æµ‹åˆ°å¤„ç†å®Œæˆçš„æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€ï¼Œæ”¯æŒä¸­æ–­å’Œæ¢å¤ã€‚

6. **å†å²è®°å½•**ï¼šå·²å¿½ç•¥çš„é‡å¤å¯¹ä¿ç•™åœ¨ `dismissedPairs` åˆ—è¡¨ä¸­ï¼Œä¾¿äºå®¡è®¡å’Œå›æº¯ã€‚

#### UI å±•ç¤º

åœ¨ WorkbenchPanel çš„"é‡å¤æ¦‚å¿µ"åŒºåŸŸï¼Œé‡å¤å¯¹æŒ‰ä»¥ä¸‹æ ¼å¼å±•ç¤ºï¼š

```
ğŸ”„ é‡å¤æ¦‚å¿µ (2)

ğŸ“ æ·±åº¦å­¦ä¹  âŸ· æ·±åº¦ç¥ç»ç½‘ç»œ
   ç›¸ä¼¼åº¦: 92%  |  ç±»å‹: Theory
   [æ‰“å¼€ A] [æ‰“å¼€ B] [åˆå¹¶] [å¿½ç•¥]

ğŸ“ é‡å­çº ç¼  âŸ· é‡å­çº ç¼ ç°è±¡
   ç›¸ä¼¼åº¦: 96%  |  ç±»å‹: Mechanism  |  çŠ¶æ€: åˆå¹¶ä¸­...
   [æŸ¥çœ‹è¿›åº¦]
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šDuplicatePair å’Œ DuplicatePairStatus æ¥å£å®šä¹‰
- `src/core/duplicate-manager.ts`ï¼šé‡å¤æ£€æµ‹å’Œç®¡ç†é€»è¾‘
- `src/core/merge-handler.ts`ï¼šåˆå¹¶æµç¨‹å®ç°
- `src/ui/workbench-panel.ts`ï¼šé‡å¤æ¦‚å¿µåŒºåŸŸçš„ UI å®ç°

### 8.5 é…ç½®ç»“æ„

æ’ä»¶é…ç½®ï¼ˆPluginSettingsï¼‰å®šä¹‰äº† Cognitive Razor çš„æ‰€æœ‰å¯é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬åŸºç¡€è®¾ç½®ã€å‘½åè§„åˆ™ã€å­˜å‚¨ç»“æ„ã€å»é‡é˜ˆå€¼ã€é˜Ÿåˆ—å‚æ•°ã€å¿«ç…§ç­–ç•¥ã€Provider é…ç½®å’Œä»»åŠ¡æ¨¡å‹é…ç½®ã€‚é…ç½®æ•°æ®æŒä¹…åŒ–åˆ° Obsidian çš„ `data.json` æ–‡ä»¶ã€‚

#### æ¥å£å®šä¹‰

```typescript
interface PluginSettings {
  // æ’ä»¶ç‰ˆæœ¬
  version: string;
  
  // åŸºç¡€è®¾ç½®
  language: "zh" | "en";
  advancedMode: boolean;
  
  // å‘½åè®¾ç½®
  namingTemplate: string;
  
  // å­˜å‚¨è®¾ç½®
  directoryScheme: DirectoryScheme;
  
  // å»é‡è®¾ç½®
  similarityThreshold: number;
  topK: number;
  
  // é˜Ÿåˆ—è®¾ç½®
  concurrency: number;
  autoRetry: boolean;
  maxRetryAttempts: number;
  taskTimeoutMs: number;
  maxTaskHistory: number;
  
  // å¿«ç…§è®¾ç½®
  maxSnapshots: number;
  maxSnapshotAgeDays: number;
  
  // åŠŸèƒ½å¼€å…³
  enableGrounding: boolean;
  
  // Provider é…ç½®
  providers: Record<string, ProviderConfig>;
  defaultProviderId: string;
  
  // ä»»åŠ¡æ¨¡å‹é…ç½®
  taskModels: Record<TaskType, TaskModelConfig>;
  
  // æ—¥å¿—è®¾ç½®
  logLevel: "debug" | "info" | "warn" | "error";
  logFormat: "json" | "pretty" | "compact";
  
  // åµŒå…¥å‘é‡ç»´åº¦
  embeddingDimension: number;
}
```

#### å­—æ®µè¯´æ˜

**åŸºç¡€è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `version` | `string` | `"1.0.0"` | **æ’ä»¶ç‰ˆæœ¬**ï¼šè®°å½•é…ç½®æ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œç”¨äºå…¼å®¹æ€§æ£€æŸ¥å’Œè¿ç§»ã€‚ |
| `language` | `"zh" \| "en"` | `"zh"` | **ç•Œé¢è¯­è¨€**ï¼šUI æ˜¾ç¤ºè¯­è¨€ï¼Œæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ã€‚ |
| `advancedMode` | `boolean` | `false` | **é«˜çº§æ¨¡å¼**ï¼šæ˜¯å¦æ˜¾ç¤ºé«˜çº§è®¾ç½®é€‰é¡¹ï¼ˆå¦‚æ—¥å¿—çº§åˆ«ã€ä»»åŠ¡è¶…æ—¶ç­‰ï¼‰ã€‚ |

**å‘½åè®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `namingTemplate` | `string` | `"{{name}}"` | **å‘½åæ¨¡æ¿**ï¼šæ¦‚å¿µç¬”è®°çš„æ–‡ä»¶åæ¨¡æ¿ã€‚æ”¯æŒå˜é‡ï¼š`{{name}}`ï¼ˆæ¦‚å¿µåç§°ï¼‰ã€`{{type}}`ï¼ˆæ¦‚å¿µç±»å‹ï¼‰ã€`{{uid}}`ï¼ˆUID å‰ 8 ä½ï¼‰ã€‚ä¾‹å¦‚ï¼š`"{{name}}-{{uid}}"` ç”Ÿæˆ `"æ·±åº¦å­¦ä¹ -7c9e6679.md"`ã€‚ |

**å­˜å‚¨è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `directoryScheme` | `DirectoryScheme` | è§ä¸‹æ–‡ | **ç›®å½•æ–¹æ¡ˆ**ï¼šæŒ‰çŸ¥è¯†ç±»å‹ç»„ç»‡ç¬”è®°çš„ç›®å½•ç»“æ„ã€‚ |

**DirectoryScheme ç»“æ„**ï¼š

```typescript
interface DirectoryScheme {
  Domain: string;      // Domain ç›®å½•ï¼Œé»˜è®¤ "1-é¢†åŸŸ"
  Issue: string;       // Issue ç›®å½•ï¼Œé»˜è®¤ "2-è®®é¢˜"
  Theory: string;      // Theory ç›®å½•ï¼Œé»˜è®¤ "3-ç†è®º"
  Entity: string;      // Entity ç›®å½•ï¼Œé»˜è®¤ "4-å®ä½“"
  Mechanism: string;   // Mechanism ç›®å½•ï¼Œé»˜è®¤ "5-æœºåˆ¶"
}
```

**å»é‡è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `similarityThreshold` | `number` | `0.85` | **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šæ£€æµ‹é‡å¤æ¦‚å¿µçš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰ã€‚è¶…è¿‡æ­¤é˜ˆå€¼çš„æ¦‚å¿µå¯¹ä¼šè¢«æ ‡è®°ä¸ºç–‘ä¼¼é‡å¤ã€‚å»ºè®®èŒƒå›´ï¼š0.80-0.90ã€‚ |
| `topK` | `number` | `10` | **TopK æ•°é‡**ï¼šå‘é‡æœç´¢è¿”å›çš„æœ€ç›¸ä¼¼æ¦‚å¿µæ•°é‡ã€‚å¢å¤§æ­¤å€¼å¯ä»¥æ£€æµ‹æ›´å¤šæ½œåœ¨é‡å¤ï¼Œä½†ä¼šå¢åŠ è®¡ç®—é‡ã€‚ |

**é˜Ÿåˆ—è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `concurrency` | `number` | `3` | **å¹¶å‘æ•°**ï¼šåŒæ—¶æ‰§è¡Œçš„æœ€å¤§ä»»åŠ¡æ•°ã€‚å»ºè®®èŒƒå›´ï¼š1-5ã€‚è¿‡é«˜çš„å¹¶å‘å¯èƒ½å¯¼è‡´ API é™æµã€‚ |
| `autoRetry` | `boolean` | `true` | **è‡ªåŠ¨é‡è¯•**ï¼šä»»åŠ¡å¤±è´¥æ—¶æ˜¯å¦è‡ªåŠ¨é‡è¯•ã€‚ç¦ç”¨åï¼Œå¤±è´¥ä»»åŠ¡éœ€è¦æ‰‹åŠ¨é‡è¯•ã€‚ |
| `maxRetryAttempts` | `number` | `3` | **æœ€å¤§é‡è¯•æ¬¡æ•°**ï¼šä»»åŠ¡å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚è¶…è¿‡æ­¤æ¬¡æ•°åä»»åŠ¡æ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥ã€‚ |
| `taskTimeoutMs` | `number` | `60000` | **ä»»åŠ¡è¶…æ—¶æ—¶é—´**ï¼šå•ä¸ªä»»åŠ¡çš„æœ€å¤§æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ã€‚è¶…æ—¶åä»»åŠ¡ä¼šè¢«ä¸­æ–­å¹¶æ ‡è®°ä¸ºå¤±è´¥ã€‚é»˜è®¤ 60 ç§’ã€‚ |
| `maxTaskHistory` | `number` | `100` | **ä»»åŠ¡å†å²ä¸Šé™**ï¼šä¿ç•™çš„å·²å®Œæˆ/å¤±è´¥/å–æ¶ˆä»»åŠ¡æ•°é‡ã€‚è¶…è¿‡æ­¤æ•°é‡åï¼Œæœ€æ—§çš„ä»»åŠ¡ä¼šè¢«æ¸…ç†ã€‚ |

**å¿«ç…§è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `maxSnapshots` | `number` | `50` | **æœ€å¤§å¿«ç…§æ•°**ï¼šç³»ç»Ÿä¿ç•™çš„æœ€å¤§å¿«ç…§æ•°é‡ã€‚è¶…è¿‡æ­¤æ•°é‡åï¼Œæœ€æ—§çš„å¿«ç…§ä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚ |
| `maxSnapshotAgeDays` | `number` | `30` | **å¿«ç…§æœ€å¤§ä¿ç•™å¤©æ•°**ï¼šå¿«ç…§çš„æœ€å¤§ä¿ç•™æ—¶é—´ï¼ˆå¤©ï¼‰ã€‚è¶…è¿‡æ­¤æ—¶é—´çš„å¿«ç…§ä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚ |

**åŠŸèƒ½å¼€å…³**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `enableGrounding` | `boolean` | `false` | **å¯ç”¨æ¥åœ°éªŒè¯**ï¼šæ˜¯å¦å¯ç”¨æ¦‚å¿µçš„æ¥åœ°éªŒè¯åŠŸèƒ½ã€‚æ¥åœ°éªŒè¯ç¡®ä¿æ¦‚å¿µä¸ç°å®ä¸–ç•Œçš„å¯¹åº”å…³ç³»ã€‚ |

**Provider é…ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `providers` | `Record<string, ProviderConfig>` | `{}` | **Provider é…ç½®**ï¼šæ‰€æœ‰å·²é…ç½®çš„ Provider åˆ—è¡¨ã€‚é”®ä¸º Provider IDï¼Œå€¼ä¸º Provider é…ç½®å¯¹è±¡ã€‚ |
| `defaultProviderId` | `string` | `""` | **é»˜è®¤ Provider ID**ï¼šé»˜è®¤ä½¿ç”¨çš„ Providerã€‚å¦‚æœä»»åŠ¡æœªæŒ‡å®š Providerï¼Œä½¿ç”¨æ­¤é»˜è®¤å€¼ã€‚ |

**ProviderConfig ç»“æ„**ï¼š

```typescript
interface ProviderConfig {
  apiKey: string;                  // API Key
  baseUrl?: string;                // è‡ªå®šä¹‰ç«¯ç‚¹ URLï¼ˆå¯é€‰ï¼‰
  defaultChatModel: string;        // é»˜è®¤èŠå¤©æ¨¡å‹
  defaultEmbedModel: string;       // é»˜è®¤åµŒå…¥æ¨¡å‹
  enabled: boolean;                // æ˜¯å¦å¯ç”¨
  persistApiKey?: boolean;         // æ˜¯å¦æŒä¹…åŒ– API Key
}
```

**Provider é…ç½®å­—æ®µè¯´æ˜**ï¼š

- `apiKey`ï¼šProvider çš„ API å¯†é’¥ã€‚å¦‚æœ `persistApiKey` ä¸º falseï¼Œæ­¤å­—æ®µä¸ä¼šä¿å­˜åˆ° `data.json`ï¼Œä»…å­˜å‚¨åœ¨ä¼šè¯å†…å­˜ä¸­ã€‚
- `baseUrl`ï¼šè‡ªå®šä¹‰ API ç«¯ç‚¹ URLã€‚ç”¨äºæ”¯æŒ OpenRouterã€Azure OpenAI ç­‰ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚å¦‚æœæœªæŒ‡å®šï¼Œä½¿ç”¨é»˜è®¤ç«¯ç‚¹ï¼ˆOpenAI ä¸º `https://api.openai.com/v1`ï¼‰ã€‚
- `defaultChatModel`ï¼šé»˜è®¤çš„èŠå¤©æ¨¡å‹åç§°ï¼ˆå¦‚ `"gpt-4o"`ã€`"gpt-4o-mini"`ï¼‰ã€‚
- `defaultEmbedModel`ï¼šé»˜è®¤çš„åµŒå…¥æ¨¡å‹åç§°ï¼ˆå¦‚ `"text-embedding-3-small"`ï¼‰ã€‚
- `enabled`ï¼šæ˜¯å¦å¯ç”¨æ­¤ Providerã€‚ç¦ç”¨åï¼Œä»»åŠ¡ä¸ä¼šä½¿ç”¨æ­¤ Providerã€‚
- `persistApiKey`ï¼šæ˜¯å¦å°† API Key æŒä¹…åŒ–åˆ° `data.json`ã€‚è®¾ç½®ä¸º false å¯ä»¥æé«˜å®‰å…¨æ€§ï¼Œä½†éœ€è¦æ¯æ¬¡å¯åŠ¨æ—¶é‡æ–°è¾“å…¥ API Keyã€‚

**ä»»åŠ¡æ¨¡å‹é…ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `taskModels` | `Record<TaskType, TaskModelConfig>` | è§ä¸‹æ–‡ | **ä»»åŠ¡æ¨¡å‹é…ç½®**ï¼šä¸ºæ¯ç§ä»»åŠ¡ç±»å‹æŒ‡å®šä½¿ç”¨çš„æ¨¡å‹å’Œå‚æ•°ã€‚ |

**TaskModelConfig ç»“æ„**ï¼š

```typescript
interface TaskModelConfig {
  providerId: string;                              // Provider ID
  model: string;                                   // æ¨¡å‹åç§°
  temperature?: number;                            // æ¸©åº¦å‚æ•°ï¼ˆ0-2ï¼‰
  topP?: number;                                   // TopP å‚æ•°ï¼ˆ0-1ï¼‰
  reasoning_effort?: "low" | "medium" | "high";    // æ¨ç†å¼ºåº¦
  maxTokens?: number;                              // æœ€å¤§ token æ•°
}
```

**TaskModelConfig å­—æ®µè¯´æ˜**ï¼š

- `providerId`ï¼šä½¿ç”¨çš„ Provider IDï¼Œå¼•ç”¨ `providers` ä¸­çš„é…ç½®ã€‚
- `model`ï¼šæ¨¡å‹åç§°ï¼ˆå¦‚ `"gpt-4o"`ã€`"gpt-4o-mini"`ï¼‰ã€‚
- `temperature`ï¼šæ¸©åº¦å‚æ•°ï¼ˆ0-2ï¼‰ï¼Œæ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ã€‚é»˜è®¤ 0.7ã€‚è¾ƒä½çš„å€¼ä½¿è¾“å‡ºæ›´ç¡®å®šï¼Œè¾ƒé«˜çš„å€¼ä½¿è¾“å‡ºæ›´å¤šæ ·ã€‚
- `topP`ï¼šTopP å‚æ•°ï¼ˆ0-1ï¼‰ï¼Œæ§åˆ¶è¾“å‡ºçš„å¤šæ ·æ€§ã€‚é»˜è®¤ 1ã€‚ä¸ temperature é…åˆä½¿ç”¨ã€‚
- `reasoning_effort`ï¼šæ¨ç†å¼ºåº¦ï¼ˆä»…æ”¯æŒæ¨ç†çš„æ¨¡å‹å¦‚ o1ã€o3ï¼‰ã€‚å¯é€‰å€¼ï¼š`"low"`ã€`"medium"`ã€`"high"`ã€‚
- `maxTokens`ï¼šæœ€å¤§ç”Ÿæˆ token æ•°ã€‚é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…è¶…å‡ºæ¨¡å‹é™åˆ¶ã€‚

**æ—¥å¿—è®¾ç½®**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `logLevel` | `"debug" \| "info" \| "warn" \| "error"` | `"info"` | **æ—¥å¿—çº§åˆ«**ï¼šæ§åˆ¶æ—¥å¿—çš„è¯¦ç»†ç¨‹åº¦ã€‚`debug` æœ€è¯¦ç»†ï¼Œ`error` æœ€ç®€æ´ã€‚ |
| `logFormat` | `"json" \| "pretty" \| "compact"` | `"pretty"` | **æ—¥å¿—æ ¼å¼**ï¼šæ—¥å¿—çš„è¾“å‡ºæ ¼å¼ã€‚`json` é€‚åˆæœºå™¨è§£æï¼Œ`pretty` é€‚åˆäººç±»é˜…è¯»ï¼Œ`compact` èŠ‚çœç©ºé—´ã€‚ |

**åµŒå…¥å‘é‡ç»´åº¦**ï¼š

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `embeddingDimension` | `number` | `1536` | **åµŒå…¥å‘é‡ç»´åº¦**ï¼šå‘é‡åµŒå…¥çš„ç»´åº¦æ•°ã€‚`text-embedding-3-small` æ”¯æŒ 512-3072ï¼Œé»˜è®¤ 1536ã€‚è¾ƒä½çš„ç»´åº¦å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´å’Œè®¡ç®—æ—¶é—´ï¼Œä½†å¯èƒ½é™ä½ç²¾åº¦ã€‚ |

#### é»˜è®¤é…ç½®

```typescript
const DEFAULT_SETTINGS: PluginSettings = {
  version: "1.0.0",
  
  // åŸºç¡€è®¾ç½®
  language: "zh",
  advancedMode: false,
  
  // å‘½åè®¾ç½®
  namingTemplate: "{{name}}",
  
  // å­˜å‚¨è®¾ç½®
  directoryScheme: {
    Domain: "1-é¢†åŸŸ",
    Issue: "2-è®®é¢˜",
    Theory: "3-ç†è®º",
    Entity: "4-å®ä½“",
    Mechanism: "5-æœºåˆ¶"
  },
  
  // å»é‡è®¾ç½®
  similarityThreshold: 0.85,
  topK: 10,
  
  // é˜Ÿåˆ—è®¾ç½®
  concurrency: 3,
  autoRetry: true,
  maxRetryAttempts: 3,
  taskTimeoutMs: 60000,
  maxTaskHistory: 100,
  
  // å¿«ç…§è®¾ç½®
  maxSnapshots: 50,
  maxSnapshotAgeDays: 30,
  
  // åŠŸèƒ½å¼€å…³
  enableGrounding: false,
  
  // Provider é…ç½®
  providers: {
    "openai-main": {
      apiKey: "",
      baseUrl: "https://api.openai.com/v1",
      defaultChatModel: "gpt-4o",
      defaultEmbedModel: "text-embedding-3-small",
      enabled: true,
      persistApiKey: false
    }
  },
  defaultProviderId: "openai-main",
  
  // ä»»åŠ¡æ¨¡å‹é…ç½®
  taskModels: {
    "embedding": {
      providerId: "openai-main",
      model: "text-embedding-3-small"
    },
    "standardizeClassify": {
      providerId: "openai-main",
      model: "gpt-4o",
      temperature: 0.3
    },
    "enrich": {
      providerId: "openai-main",
      model: "gpt-4o",
      temperature: 0.7
    },
    "reason:new": {
      providerId: "openai-main",
      model: "gpt-4o",
      temperature: 0.7,
      maxTokens: 4000
    },
    "ground": {
      providerId: "openai-main",
      model: "gpt-4o",
      temperature: 0.3
    }
  },
  
  // æ—¥å¿—è®¾ç½®
  logLevel: "info",
  logFormat: "pretty",
  
  // åµŒå…¥å‘é‡ç»´åº¦
  embeddingDimension: 1536
};
```

#### é…ç½®ç¤ºä¾‹

**å¤š Provider é…ç½®**ï¼š

```json
{
  "providers": {
    "openai-main": {
      "apiKey": "sk-...",
      "baseUrl": "https://api.openai.com/v1",
      "defaultChatModel": "gpt-4o",
      "defaultEmbedModel": "text-embedding-3-small",
      "enabled": true,
      "persistApiKey": false
    },
    "openai-backup": {
      "apiKey": "sk-...",
      "baseUrl": "https://api.openai.com/v1",
      "defaultChatModel": "gpt-4o-mini",
      "defaultEmbedModel": "text-embedding-3-small",
      "enabled": true,
      "persistApiKey": false
    },
    "openrouter": {
      "apiKey": "sk-or-...",
      "baseUrl": "https://openrouter.ai/api/v1",
      "defaultChatModel": "anthropic/claude-3-opus",
      "defaultEmbedModel": "text-embedding-3-small",
      "enabled": false,
      "persistApiKey": false
    }
  },
  "defaultProviderId": "openai-main"
}
```

**ä»»åŠ¡æ¨¡å‹é…ç½®ï¼ˆä½¿ç”¨ä¸åŒ Providerï¼‰**ï¼š

```json
{
  "taskModels": {
    "embedding": {
      "providerId": "openai-main",
      "model": "text-embedding-3-small"
    },
    "standardizeClassify": {
      "providerId": "openai-main",
      "model": "gpt-4o",
      "temperature": 0.3
    },
    "enrich": {
      "providerId": "openai-backup",
      "model": "gpt-4o-mini",
      "temperature": 0.7
    },
    "reason:new": {
      "providerId": "openrouter",
      "model": "anthropic/claude-3-opus",
      "temperature": 0.7,
      "maxTokens": 4000
    },
    "ground": {
      "providerId": "openai-main",
      "model": "gpt-4o",
      "temperature": 0.3
    }
  }
}
```

**è‡ªå®šä¹‰ç›®å½•æ–¹æ¡ˆ**ï¼š

```json
{
  "directoryScheme": {
    "Domain": "Domains",
    "Issue": "Issues",
    "Theory": "Theories",
    "Entity": "Entities",
    "Mechanism": "Mechanisms"
  }
}
```

**é«˜çº§é˜Ÿåˆ—é…ç½®**ï¼š

```json
{
  "concurrency": 5,
  "autoRetry": true,
  "maxRetryAttempts": 5,
  "taskTimeoutMs": 120000,
  "maxTaskHistory": 200
}
```

#### é…ç½®ç®¡ç†

**åŠ è½½é…ç½®**ï¼š

æ’ä»¶å¯åŠ¨æ—¶ï¼ŒSettingsStore ä» Obsidian çš„ `data.json` æ–‡ä»¶åŠ è½½é…ç½®ï¼š

```typescript
async onload() {
  const savedData = await this.loadData();
  this.settings = Object.assign({}, DEFAULT_SETTINGS, savedData);
}
```

**ä¿å­˜é…ç½®**ï¼š

é…ç½®ä¿®æ”¹åï¼ŒSettingsStore å°†é…ç½®ä¿å­˜åˆ° `data.json`ï¼š

```typescript
async updateSettings(partial: Partial<PluginSettings>) {
  this.settings = { ...this.settings, ...partial };
  await this.saveData(this.settings);
}
```

**é…ç½®è¿ç§»**ï¼š

å½“æ’ä»¶ç‰ˆæœ¬å‡çº§æ—¶ï¼ŒVersionChecker æ£€æŸ¥é…ç½®ç‰ˆæœ¬å¹¶æ‰§è¡Œè¿ç§»ï¼š

```typescript
if (settings.version !== CURRENT_VERSION) {
  settings = migrateSettings(settings, CURRENT_VERSION);
  await this.saveData(settings);
}
```

**é…ç½®éªŒè¯**ï¼š

SettingsStore åœ¨åŠ è½½é…ç½®æ—¶æ‰§è¡ŒéªŒè¯ï¼Œç¡®ä¿é…ç½®çš„åˆæ³•æ€§ï¼š

- `concurrency` å¿…é¡»åœ¨ 1-10 ä¹‹é—´
- `similarityThreshold` å¿…é¡»åœ¨ 0-1 ä¹‹é—´
- `maxRetryAttempts` å¿…é¡»å¤§äº 0
- `taskTimeoutMs` å¿…é¡»å¤§äº 0
- `embeddingDimension` å¿…é¡»åœ¨ 512-3072 ä¹‹é—´ï¼ˆé’ˆå¯¹ text-embedding-3-smallï¼‰

#### è®¾è®¡åŸåˆ™

1. **åˆç†çš„é»˜è®¤å€¼**ï¼šæ‰€æœ‰é…ç½®é¡¹éƒ½æœ‰åˆç†çš„é»˜è®¤å€¼ï¼Œç”¨æˆ·æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨ã€‚

2. **çµæ´»çš„æ‰©å±•æ€§**ï¼šæ”¯æŒå¤š Provider é…ç½®å’Œä»»åŠ¡çº§åˆ«çš„æ¨¡å‹é…ç½®ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚

3. **å®‰å…¨æ€§**ï¼šæ”¯æŒä¸æŒä¹…åŒ– API Keyï¼ˆ`persistApiKey: false`ï¼‰ï¼Œæé«˜å®‰å…¨æ€§ã€‚

4. **å‘åå…¼å®¹**ï¼šé€šè¿‡ç‰ˆæœ¬å·å’Œè¿ç§»æœºåˆ¶ï¼Œç¡®ä¿é…ç½®çš„å‘åå…¼å®¹æ€§ã€‚

5. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript æ¥å£å®šä¹‰é…ç½®ç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ã€‚

6. **å®æ—¶ç”Ÿæ•ˆ**ï¼šé…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æ’ä»¶ã€‚é€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶é€šçŸ¥ç›¸å…³ç»„ä»¶ã€‚

#### é…ç½® UI

é…ç½®é€šè¿‡ SettingsTab æä¾›å¯è§†åŒ–ç•Œé¢ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cognitive Razor è®¾ç½®                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºç¡€è®¾ç½®                                â”‚
â”‚   ç•Œé¢è¯­è¨€: [ä¸­æ–‡ â–¼]                    â”‚
â”‚   é«˜çº§æ¨¡å¼: [ ] å¯ç”¨                    â”‚
â”‚                                         â”‚
â”‚ Provider é…ç½®                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ openai-main                     â”‚  â”‚
â”‚   â”‚ API Key: ****************       â”‚  â”‚
â”‚   â”‚ èŠå¤©æ¨¡å‹: gpt-4o                â”‚  â”‚
â”‚   â”‚ åµŒå…¥æ¨¡å‹: text-embedding-3-smallâ”‚  â”‚
â”‚   â”‚ [ç¼–è¾‘] [åˆ é™¤]                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   [+ æ·»åŠ  Provider]                    â”‚
â”‚                                         â”‚
â”‚ å»é‡è®¾ç½®                                â”‚
â”‚   ç›¸ä¼¼åº¦é˜ˆå€¼: [0.85] (0.80-0.90)       â”‚
â”‚   TopK æ•°é‡: [10]                      â”‚
â”‚                                         â”‚
â”‚ é˜Ÿåˆ—è®¾ç½®                                â”‚
â”‚   å¹¶å‘æ•°: [3] (1-5)                    â”‚
â”‚   è‡ªåŠ¨é‡è¯•: [âœ“] å¯ç”¨                   â”‚
â”‚   æœ€å¤§é‡è¯•æ¬¡æ•°: [3]                    â”‚
â”‚                                         â”‚
â”‚ å¿«ç…§è®¾ç½®                                â”‚
â”‚   æœ€å¤§å¿«ç…§æ•°: [50]                     â”‚
â”‚   ä¿ç•™å¤©æ•°: [30]                       â”‚
â”‚                                         â”‚
â”‚ [ä¿å­˜è®¾ç½®] [é‡ç½®ä¸ºé»˜è®¤å€¼]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šPluginSettingsã€ProviderConfigã€TaskModelConfigã€DirectoryScheme æ¥å£å®šä¹‰
- `src/data/settings-store.ts`ï¼šé…ç½®åŠ è½½ã€ä¿å­˜å’Œè®¢é˜…é€»è¾‘
- `src/ui/settings-tab.ts`ï¼šé…ç½® UI å®ç°
- `src/core/version-checker.ts`ï¼šé…ç½®ç‰ˆæœ¬æ£€æŸ¥å’Œè¿ç§»

---

## 9. é”™è¯¯å¤„ç†

### 9.1 é”™è¯¯åˆ†ç±»

Cognitive Razor é‡‡ç”¨ç»“æ„åŒ–çš„é”™è¯¯åˆ†ç±»ç³»ç»Ÿï¼Œå°†æ‰€æœ‰é”™è¯¯æŒ‰ç…§æ¥æºå’Œå¯æ¢å¤æ€§åˆ’åˆ†ä¸ºäº”å¤§ç±»åˆ«ã€‚æ¯ä¸ªé”™è¯¯éƒ½æœ‰å”¯ä¸€çš„é”™è¯¯ç ï¼ˆError Codeï¼‰ï¼Œä¾¿äºæ—¥å¿—è¿½è¸ªå’Œé—®é¢˜è¯Šæ–­ã€‚

#### é”™è¯¯ç ä½“ç³»

é”™è¯¯ç é‡‡ç”¨ `EXXX` æ ¼å¼ï¼Œå…¶ä¸­ `X` ä¸ºæ•°å­—ã€‚é”™è¯¯ç çš„èŒƒå›´å†³å®šäº†é”™è¯¯çš„ç±»åˆ«å’Œå¤„ç†ç­–ç•¥ï¼š

| é”™è¯¯ç èŒƒå›´ | ç±»åˆ« | å¯é‡è¯• | é‡è¯•ç­–ç•¥ | è¯´æ˜ |
|-----------|------|--------|---------|------|
| **E001-E010** | å†…å®¹é”™è¯¯ | âœ… æ˜¯ | ç«‹å³é‡è¯•ï¼Œæœ€å¤š 3 æ¬¡ | AI è¾“å‡ºæ ¼å¼é”™è¯¯ã€éªŒè¯å¤±è´¥ç­‰ |
| **E100-E102** | ç½‘ç»œé”™è¯¯ | âœ… æ˜¯ | æŒ‡æ•°é€€é¿ï¼Œæœ€å¤š 5 æ¬¡ | API è°ƒç”¨å¤±è´¥ã€è¶…æ—¶ã€é€Ÿç‡é™åˆ¶ |
| **E103** | è®¤è¯é”™è¯¯ | âŒ å¦ | ä¸é‡è¯• | API Key æ— æ•ˆæˆ–è¿‡æœŸ |
| **E200-E201** | èƒ½åŠ›é”™è¯¯ | âŒ å¦ | ä¸é‡è¯• | Provider èƒ½åŠ›ä¸è¶³ã€å®‰å…¨é™åˆ¶ |
| **E300-E304** | æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ | âŒ å¦ | ä¸é‡è¯• | æ–‡ä»¶è¯»å†™å¤±è´¥ã€ç´¢å¼•æŸå |

#### 1. å†…å®¹é”™è¯¯ï¼ˆE001-E010ï¼‰

å†…å®¹é”™è¯¯æ˜¯æŒ‡ AI è¾“å‡ºä¸ç¬¦åˆé¢„æœŸæ ¼å¼æˆ–ä¸šåŠ¡è§„åˆ™çš„é”™è¯¯ã€‚è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯ç”±äº AI ç†è§£åå·®æˆ–éšæœºæ€§å¯¼è‡´çš„ï¼Œå¯ä»¥é€šè¿‡é‡è¯•å¹¶é™„åŠ é”™è¯¯å†å²æ¥ä¿®å¤ã€‚

**é”™è¯¯ç åˆ—è¡¨**ï¼š

| é”™è¯¯ç  | åç§° | æè¿° | ä¿®å¤å»ºè®® |
|-------|------|------|---------|
| **E001** | PARSE_ERROR | è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥ | AI è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•å¹¶æä¾›æ›´æ˜ç¡®çš„æŒ‡ç¤º |
| **E002** | SCHEMA_VIOLATION | ä¸ç¬¦åˆè¾“å‡º Schema | AI è¾“å‡ºä¸ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E003** | MISSING_REQUIRED | å¿…å¡«å­—æ®µç¼ºå¤± | AI è¾“å‡ºç¼ºå°‘å¿…å¡«å­—æ®µï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E004** | CONSTRAINT_VIOLATION | è¿åä¸šåŠ¡è§„åˆ™ C001-C016 | AI è¾“å‡ºè¿åä¸šåŠ¡è§„åˆ™ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E005** | SEMANTIC_DUPLICATE | ç›¸ä¼¼åº¦è¶…é˜ˆå€¼ï¼ˆè¯­ä¹‰é‡å¤ï¼‰ | æ£€æµ‹åˆ°è¯­ä¹‰é‡å¤ï¼Œè¯·æ£€æŸ¥é‡å¤é¢æ¿ |
| **E006** | INVALID_WIKILINK | wikilink æ ¼å¼é”™è¯¯ | AI è¾“å‡ºçš„ wikilink æ ¼å¼ä¸æ­£ç¡®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E007** | TYPE_MISMATCH | è¾“å‡ºç±»å‹ä¸é¢„æœŸä¸ç¬¦ | AI è¾“å‡ºç±»å‹ä¸åŒ¹é…ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E008** | CONTENT_TOO_SHORT | å†…å®¹é•¿åº¦ä¸è¶³ | AI è¾“å‡ºå†…å®¹è¿‡çŸ­ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E009** | SUM_NOT_ONE | type_confidences æ±‚å’Œ â‰  1 | AI è¾“å‡ºçš„ç½®ä¿¡åº¦æ±‚å’Œä¸ä¸º 1ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E010** | INVALID_PATTERN | å­—æ®µä¸åŒ¹é…æ­£åˆ™ | AI è¾“å‡ºå­—æ®µæ ¼å¼ä¸æ­£ç¡®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |

**å¤„ç†ç­–ç•¥**ï¼š
- **ç«‹å³é‡è¯•**ï¼šä¸éœ€è¦ç­‰å¾…ï¼Œç›´æ¥é‡è¯•
- **æœ€å¤š 3 æ¬¡**ï¼šå¦‚æœ 3 æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ï¼Œæ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç»“æ„åŒ–é‡è¯•**ï¼šå°†é”™è¯¯å†å²é™„åŠ åˆ° Prompt ä¸­ï¼Œå¸®åŠ© AI é¿å…é‡å¤é”™è¯¯

**ç¤ºä¾‹åœºæ™¯**ï¼š

```typescript
// AI è¾“å‡ºäº†é JSON æ ¼å¼çš„å†…å®¹
{
  "code": "E001",
  "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
  "details": {
    "rawOutput": "è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µ...",
    "parseError": "Unexpected token è¿™ in JSON at position 0"
  }
}

// ç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•ï¼Œå¹¶åœ¨ Prompt ä¸­é™„åŠ é”™è¯¯å†å²ï¼š
// "ä¹‹å‰çš„å°è¯•å¤±è´¥äº†ï¼Œé”™è¯¯åŸå› ï¼šè¾“å‡ºé JSON æ ¼å¼ã€‚è¯·ç¡®ä¿è¾“å‡ºæ˜¯æœ‰æ•ˆçš„ JSONã€‚"
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰å’Œ Result Monad ç±»å‹
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé”™è¯¯åˆ†ç±»é€»è¾‘

---

#### 2. ç½‘ç»œé”™è¯¯ï¼ˆE100-E102ï¼‰

ç½‘ç»œé”™è¯¯æ˜¯æŒ‡ä¸ AI Provider é€šä¿¡è¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯ã€‚è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯æš‚æ—¶æ€§çš„ï¼Œå¯ä»¥é€šè¿‡æŒ‡æ•°é€€é¿é‡è¯•æ¥æ¢å¤ã€‚

**é”™è¯¯ç åˆ—è¡¨**ï¼š

| é”™è¯¯ç  | åç§° | æè¿° | ä¿®å¤å»ºè®® |
|-------|------|------|---------|
| **E100** | API_ERROR | Provider è¿”å› 5xx/4xx | API è°ƒç”¨å¤±è´¥ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E101** | TIMEOUT | è¯·æ±‚è¶…æ—¶ | è¯·æ±‚è¶…æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯• |
| **E102** | RATE_LIMIT | è§¦å‘é€Ÿç‡é™åˆ¶ (429) | è¯·ç¨åå†è¯•ï¼Œæˆ–è€ƒè™‘å‡çº§ API å¥—é¤ä»¥è·å¾—æ›´é«˜çš„é€Ÿç‡é™åˆ¶ |

**å¤„ç†ç­–ç•¥**ï¼š
- **æŒ‡æ•°é€€é¿**ï¼šæ¯æ¬¡é‡è¯•çš„ç­‰å¾…æ—¶é—´å‘ˆæŒ‡æ•°å¢é•¿ï¼ˆ1s, 2s, 4s, 8s, 16sï¼‰
- **æœ€å¤š 5 æ¬¡**ï¼šå¦‚æœ 5 æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ï¼Œæ ‡è®°ä»»åŠ¡ä¸º Failed
- **æ™ºèƒ½é‡è¯•**ï¼šæ ¹æ® HTTP çŠ¶æ€ç å†³å®šæ˜¯å¦é‡è¯•ï¼ˆå¦‚ 401 ä¸é‡è¯•ï¼Œ429 é‡è¯•ï¼‰

**æŒ‡æ•°é€€é¿å…¬å¼**ï¼š

```
ç­‰å¾…æ—¶é—´ = baseDelay * 2^(attempt - 1)

ç¤ºä¾‹ï¼ˆbaseDelay = 1000msï¼‰ï¼š
- ç¬¬ 1 æ¬¡é‡è¯•ï¼š1000ms (1 ç§’)
- ç¬¬ 2 æ¬¡é‡è¯•ï¼š2000ms (2 ç§’)
- ç¬¬ 3 æ¬¡é‡è¯•ï¼š4000ms (4 ç§’)
- ç¬¬ 4 æ¬¡é‡è¯•ï¼š8000ms (8 ç§’)
- ç¬¬ 5 æ¬¡é‡è¯•ï¼š16000ms (16 ç§’)
```

**ç¤ºä¾‹åœºæ™¯**ï¼š

```typescript
// API è¿”å› 429 é€Ÿç‡é™åˆ¶é”™è¯¯
{
  "code": "E102",
  "message": "è§¦å‘é€Ÿç‡é™åˆ¶ (429)",
  "details": {
    "statusCode": 429,
    "retryAfter": 60, // å»ºè®® 60 ç§’åé‡è¯•
    "provider": "openai"
  }
}

// ç³»ç»Ÿå°†ç­‰å¾… 1 ç§’åé‡è¯•ï¼Œå¦‚æœå†æ¬¡å¤±è´¥ï¼Œç­‰å¾… 2 ç§’ï¼Œä»¥æ­¤ç±»æ¨
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œç½‘ç»œé”™è¯¯å¤„ç†

---

#### 3. è®¤è¯é”™è¯¯ï¼ˆE103ï¼‰

è®¤è¯é”™è¯¯æ˜¯æŒ‡ API Key æ— æ•ˆæˆ–è¿‡æœŸå¯¼è‡´çš„é”™è¯¯ã€‚è¿™ç±»é”™è¯¯æ— æ³•é€šè¿‡é‡è¯•è§£å†³ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ›´æ–°é…ç½®ã€‚

**é”™è¯¯ç åˆ—è¡¨**ï¼š

| é”™è¯¯ç  | åç§° | æè¿° | ä¿®å¤å»ºè®® |
|-------|------|------|---------|
| **E103** | AUTH_ERROR | è®¤è¯å¤±è´¥ (401/403) | è¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Key |

**å¤„ç†ç­–ç•¥**ï¼š
- **ä¸é‡è¯•**ï¼šè®¤è¯é”™è¯¯æ— æ³•é€šè¿‡é‡è¯•è§£å†³
- **ç«‹å³å¤±è´¥**ï¼šæ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç”¨æˆ·é€šçŸ¥**ï¼šæ˜¾ç¤º Notice æç¤ºç”¨æˆ·æ›´æ–° API Key

**ç¤ºä¾‹åœºæ™¯**ï¼š

```typescript
// API è¿”å› 401 è®¤è¯å¤±è´¥
{
  "code": "E103",
  "message": "è®¤è¯å¤±è´¥ (401/403)",
  "details": {
    "statusCode": 401,
    "provider": "openai",
    "error": "Invalid API key"
  }
}

// ç³»ç»Ÿå°†æ˜¾ç¤º Noticeï¼š
// "è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Keyã€‚"
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œç³»ç»Ÿé”™è¯¯å¤„ç†

---

#### 4. èƒ½åŠ›é”™è¯¯ï¼ˆE200-E201ï¼‰

èƒ½åŠ›é”™è¯¯æ˜¯æŒ‡ Provider ä¸æ”¯æŒæŸé¡¹åŠŸèƒ½æˆ–è§¦å‘äº†å®‰å…¨é™åˆ¶ã€‚è¿™ç±»é”™è¯¯æ— æ³•é€šè¿‡é‡è¯•è§£å†³ï¼Œéœ€è¦ç”¨æˆ·è°ƒæ•´é…ç½®æˆ–æ›´æ¢ Providerã€‚

**é”™è¯¯ç åˆ—è¡¨**ï¼š

| é”™è¯¯ç  | åç§° | æè¿° | ä¿®å¤å»ºè®® |
|-------|------|------|---------|
| **E200** | SAFETY_VIOLATION | è§¦å‘å®‰å…¨è¾¹ç•Œ | è¯·ä¿®æ”¹è¾“å…¥å†…å®¹ï¼Œé¿å…è§¦å‘å®‰å…¨é™åˆ¶ |
| **E201** | CAPABILITY_MISMATCH | Provider èƒ½åŠ›ä¸è¶³ | è¯·é€‰æ‹©æ”¯æŒæ­¤åŠŸèƒ½çš„ Provider æˆ–æ£€æŸ¥é…ç½® |

**å¤„ç†ç­–ç•¥**ï¼š
- **ä¸é‡è¯•**ï¼šèƒ½åŠ›é”™è¯¯æ— æ³•é€šè¿‡é‡è¯•è§£å†³
- **ç«‹å³å¤±è´¥**ï¼šæ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç”¨æˆ·é€šçŸ¥**ï¼šæ˜¾ç¤º Notice æç¤ºç”¨æˆ·è°ƒæ•´é…ç½®

**ç¤ºä¾‹åœºæ™¯**ï¼š

```typescript
// Provider ä¸æ”¯æŒåµŒå…¥åŠŸèƒ½
{
  "code": "E201",
  "message": "Provider èƒ½åŠ›ä¸è¶³",
  "details": {
    "provider": "custom-provider",
    "requiredCapability": "embedding",
    "availableCapabilities": ["chat"]
  }
}

// ç³»ç»Ÿå°†æ˜¾ç¤º Noticeï¼š
// "Provider ä¸æ”¯æŒåµŒå…¥åŠŸèƒ½ï¼Œè¯·é€‰æ‹©æ”¯æŒæ­¤åŠŸèƒ½çš„ Provider æˆ–æ£€æŸ¥é…ç½®ã€‚"
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œç»ˆæ­¢é”™è¯¯å¤„ç†

---

#### 5. æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ï¼ˆE300-E304ï¼‰

æ–‡ä»¶ç³»ç»Ÿé”™è¯¯æ˜¯æŒ‡æ–‡ä»¶è¯»å†™ã€ç´¢å¼•æ“ä½œç­‰åº•å±‚é”™è¯¯ã€‚è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯ç”±äºæƒé™é—®é¢˜ã€ç£ç›˜ç©ºé—´ä¸è¶³æˆ–æ•°æ®æŸåå¯¼è‡´çš„ï¼Œæ— æ³•é€šè¿‡é‡è¯•è§£å†³ã€‚

**é”™è¯¯ç åˆ—è¡¨**ï¼š

| é”™è¯¯ç  | åç§° | æè¿° | ä¿®å¤å»ºè®® |
|-------|------|------|---------|
| **E300** | FILE_WRITE_ERROR | æ–‡ä»¶å†™å…¥å¤±è´¥ | è¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´ |
| **E301** | FILE_READ_ERROR | æ–‡ä»¶è¯»å–å¤±è´¥ | è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å’Œè¯»å–æƒé™ |
| **E302** | INDEX_CORRUPTED | å‘é‡ç´¢å¼•æŸå | å‘é‡ç´¢å¼•å¯èƒ½å·²æŸåï¼Œè¯·å°è¯•é‡å»ºç´¢å¼• |
| **E303** | SNAPSHOT_RESTORE_FAILED | å¿«ç…§æ¢å¤å¤±è´¥ | å¿«ç…§æ¢å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¿«ç…§æ–‡ä»¶æ˜¯å¦å®Œæ•´ |
| **E304** | PROVIDER_NOT_FOUND | Provider ä¸å­˜åœ¨ | è¯·æ£€æŸ¥ Provider é…ç½®æ˜¯å¦æ­£ç¡® |

**å¤„ç†ç­–ç•¥**ï¼š
- **ä¸é‡è¯•**ï¼šæ–‡ä»¶ç³»ç»Ÿé”™è¯¯é€šå¸¸éœ€è¦äººå·¥å¹²é¢„
- **ç«‹å³å¤±è´¥**ï¼šæ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç”¨æˆ·é€šçŸ¥**ï¼šæ˜¾ç¤º Notice æç¤ºç”¨æˆ·æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ

**ç¤ºä¾‹åœºæ™¯**ï¼š

```typescript
// æ–‡ä»¶å†™å…¥å¤±è´¥ï¼ˆç£ç›˜ç©ºé—´ä¸è¶³ï¼‰
{
  "code": "E300",
  "message": "æ–‡ä»¶å†™å…¥å¤±è´¥",
  "details": {
    "path": "1-é¢†åŸŸ/è®¡ç®—æœºç§‘å­¦.md",
    "error": "ENOSPC: no space left on device"
  }
}

// ç³»ç»Ÿå°†æ˜¾ç¤º Noticeï¼š
// "æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´ã€‚"
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé”™è¯¯åˆ†ç±»æ˜ å°„

---

#### é”™è¯¯åˆ†ç±»è¾…åŠ©å‡½æ•°

ç³»ç»Ÿæä¾›äº†ä¸€ç³»åˆ—è¾…åŠ©å‡½æ•°ç”¨äºé”™è¯¯åˆ†ç±»å’Œåˆ¤æ–­ï¼š

```typescript
// åˆ¤æ–­é”™è¯¯ç±»å‹
isContentError(code: string): boolean
isNetworkError(code: string): boolean
isAuthError(code: string): boolean
isCapabilityError(code: string): boolean
isFileSystemError(code: string): boolean
isTerminalError(code: string): boolean // ä¸å¯é‡è¯•çš„é”™è¯¯

// è·å–é”™è¯¯ä¿¡æ¯
getErrorCodeInfo(code: string): ErrorCodeInfo | undefined
isRetryableErrorCode(code: string): boolean
getFixSuggestion(code: string): string | undefined
getErrorCategory(code: string): ErrorCategory | undefined
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šé”™è¯¯ç å®šä¹‰å’Œ Result Monad ç±»å‹
- `src/core/retry-handler.ts`ï¼šRetryHandler å®Œæ•´å®ç°ï¼Œé”™è¯¯åˆ†ç±»å’Œé‡è¯•ç­–ç•¥

### 9.2 é‡è¯•ç­–ç•¥

Cognitive Razor å®ç°äº†æ™ºèƒ½çš„é‡è¯•ç­–ç•¥ï¼Œæ ¹æ®é”™è¯¯ç±»å‹é‡‡ç”¨ä¸åŒçš„é‡è¯•æœºåˆ¶ã€‚é‡è¯•ç­–ç•¥çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**æœ€å¤§åŒ–ä»»åŠ¡æˆåŠŸç‡ï¼ŒåŒæ—¶é¿å…æ— æ„ä¹‰çš„é‡è¯•æµªè´¹èµ„æº**ã€‚

#### é‡è¯•ç­–ç•¥æ¦‚è§ˆ

ç³»ç»Ÿæ ¹æ®é”™è¯¯ç±»åˆ«é‡‡ç”¨ä¸‰ç§é‡è¯•ç­–ç•¥ï¼š

| é”™è¯¯ç±»åˆ« | é‡è¯•ç­–ç•¥ | æœ€å¤§é‡è¯•æ¬¡æ•° | ç­‰å¾…æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|---------|---------|------------|---------|---------|
| **å†…å®¹é”™è¯¯** | ç«‹å³é‡è¯• | 3 æ¬¡ | 0msï¼ˆç«‹å³ï¼‰ | AI è¾“å‡ºæ ¼å¼é”™è¯¯ã€éªŒè¯å¤±è´¥ |
| **ç½‘ç»œé”™è¯¯** | æŒ‡æ•°é€€é¿ | 5 æ¬¡ | 1s, 2s, 4s, 8s, 16s | API è°ƒç”¨å¤±è´¥ã€è¶…æ—¶ã€é€Ÿç‡é™åˆ¶ |
| **ç»ˆæ­¢é”™è¯¯** | ä¸é‡è¯• | 1 æ¬¡ | - | è®¤è¯å¤±è´¥ã€èƒ½åŠ›ä¸è¶³ã€æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ |

#### 1. ç«‹å³é‡è¯•ç­–ç•¥ï¼ˆå†…å®¹é”™è¯¯ï¼‰

**é€‚ç”¨é”™è¯¯**ï¼šE001-E010ï¼ˆå†…å®¹é”™è¯¯ï¼‰

**ç­–ç•¥ç‰¹ç‚¹**ï¼š
- **æ— ç­‰å¾…æ—¶é—´**ï¼šç«‹å³é‡è¯•ï¼Œä¸éœ€è¦å»¶è¿Ÿ
- **æœ€å¤š 3 æ¬¡**ï¼šå¦‚æœ 3 æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ï¼Œæ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç»“æ„åŒ–é‡è¯•**ï¼šå°†é”™è¯¯å†å²é™„åŠ åˆ° Prompt ä¸­ï¼Œå¸®åŠ© AI é¿å…é‡å¤é”™è¯¯

**é‡è¯•æµç¨‹**ï¼š

```mermaid
flowchart TD
    Start([ä»»åŠ¡æ‰§è¡Œ]) --> Execute[æ‰§è¡Œä»»åŠ¡]
    Execute --> Result{æ‰§è¡Œç»“æœ}
    Result -->|æˆåŠŸ| Success([ä»»åŠ¡æˆåŠŸ])
    Result -->|å¤±è´¥| CheckError{æ£€æŸ¥é”™è¯¯ç±»å‹}
    
    CheckError -->|å†…å®¹é”™è¯¯| CheckAttempt{æ£€æŸ¥é‡è¯•æ¬¡æ•°}
    CheckAttempt -->|< 3 æ¬¡| BuildPrompt[æ„å»ºé”™è¯¯å†å² Prompt]
    BuildPrompt --> Execute
    CheckAttempt -->|>= 3 æ¬¡| Failed([ä»»åŠ¡å¤±è´¥])
    
    CheckError -->|å…¶ä»–é”™è¯¯| OtherStrategy[å…¶ä»–é‡è¯•ç­–ç•¥]
    
    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style Failed fill:#ffcdd2
```

**ç»“æ„åŒ–é‡è¯•ç¤ºä¾‹**ï¼š

```typescript
// ç¬¬ 1 æ¬¡å°è¯•å¤±è´¥ï¼šE001 PARSE_ERROR
// é”™è¯¯å†å²ä¸ºç©ºï¼Œæ­£å¸¸æ‰§è¡Œ

// ç¬¬ 2 æ¬¡å°è¯•ï¼šé™„åŠ é”™è¯¯å†å²
const errorHistoryPrompt = `
## é”™è¯¯å†å²
ä»¥ä¸‹æ˜¯ä¹‹å‰å°è¯•ä¸­é‡åˆ°çš„é”™è¯¯ï¼Œè¯·é¿å…é‡å¤è¿™äº›é”™è¯¯ï¼š

### å°è¯• 1
- é”™è¯¯ç ï¼šE001
- é”™è¯¯ä¿¡æ¯ï¼šè¾“å‡ºé JSON æˆ–è§£æå¤±è´¥
- æ—¶é—´ï¼š2025-12-10T10:30:00.000Z

è¯·ç¡®ä¿è¾“å‡ºæ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚
`;

// å°†é”™è¯¯å†å²é™„åŠ åˆ° Prompt æœ«å°¾
const fullPrompt = originalPrompt + errorHistoryPrompt;

// ç¬¬ 3 æ¬¡å°è¯•ï¼šé™„åŠ æ›´å¤šé”™è¯¯å†å²
// ...
```

**é…ç½®å‚æ•°**ï¼š

```typescript
const CONTENT_ERROR_CONFIG: RetryConfig = {
  maxAttempts: 3,           // æœ€å¤š 3 æ¬¡å°è¯•
  strategy: "immediate",    // ç«‹å³é‡è¯•
  baseDelayMs: 0,           // æ— ç­‰å¾…æ—¶é—´
};
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œå†…å®¹é”™è¯¯åˆ†ç±»

---

#### 2. æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰

**é€‚ç”¨é”™è¯¯**ï¼šE100-E102ï¼ˆç½‘ç»œé”™è¯¯ï¼‰

**ç­–ç•¥ç‰¹ç‚¹**ï¼š
- **æŒ‡æ•°å¢é•¿çš„ç­‰å¾…æ—¶é—´**ï¼šæ¯æ¬¡é‡è¯•çš„ç­‰å¾…æ—¶é—´ç¿»å€ï¼ˆ1s, 2s, 4s, 8s, 16sï¼‰
- **æœ€å¤š 5 æ¬¡**ï¼šå¦‚æœ 5 æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ï¼Œæ ‡è®°ä»»åŠ¡ä¸º Failed
- **é¿å…é›ªå´©**ï¼šé€šè¿‡å»¶è¿Ÿé‡è¯•ï¼Œé¿å…å¤§é‡è¯·æ±‚åŒæ—¶æ¶Œå…¥ API

**æŒ‡æ•°é€€é¿å…¬å¼**ï¼š

```
ç­‰å¾…æ—¶é—´ = baseDelay * 2^(attempt - 1)

å…¶ä¸­ï¼š
- baseDelayï¼šåŸºç¡€å»¶è¿Ÿï¼ˆé»˜è®¤ 1000msï¼‰
- attemptï¼šå½“å‰å°è¯•æ¬¡æ•°ï¼ˆä» 1 å¼€å§‹ï¼‰

ç¤ºä¾‹ï¼ˆbaseDelay = 1000msï¼‰ï¼š
- ç¬¬ 1 æ¬¡é‡è¯•ï¼š1000ms * 2^0 = 1000ms (1 ç§’)
- ç¬¬ 2 æ¬¡é‡è¯•ï¼š1000ms * 2^1 = 2000ms (2 ç§’)
- ç¬¬ 3 æ¬¡é‡è¯•ï¼š1000ms * 2^2 = 4000ms (4 ç§’)
- ç¬¬ 4 æ¬¡é‡è¯•ï¼š1000ms * 2^3 = 8000ms (8 ç§’)
- ç¬¬ 5 æ¬¡é‡è¯•ï¼š1000ms * 2^4 = 16000ms (16 ç§’)
```

**é‡è¯•æµç¨‹**ï¼š

```mermaid
flowchart TD
    Start([ä»»åŠ¡æ‰§è¡Œ]) --> Execute[æ‰§è¡Œä»»åŠ¡]
    Execute --> Result{æ‰§è¡Œç»“æœ}
    Result -->|æˆåŠŸ| Success([ä»»åŠ¡æˆåŠŸ])
    Result -->|å¤±è´¥| CheckError{æ£€æŸ¥é”™è¯¯ç±»å‹}
    
    CheckError -->|ç½‘ç»œé”™è¯¯| CheckAttempt{æ£€æŸ¥é‡è¯•æ¬¡æ•°}
    CheckAttempt -->|< 5 æ¬¡| CalcWait[è®¡ç®—ç­‰å¾…æ—¶é—´<br/>baseDelay * 2^attempt-1]
    CalcWait --> Wait[ç­‰å¾…æŒ‡å®šæ—¶é—´]
    Wait --> Execute
    CheckAttempt -->|>= 5 æ¬¡| Failed([ä»»åŠ¡å¤±è´¥])
    
    CheckError -->|å…¶ä»–é”™è¯¯| OtherStrategy[å…¶ä»–é‡è¯•ç­–ç•¥]
    
    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style Failed fill:#ffcdd2
```

**é€Ÿç‡é™åˆ¶ç‰¹æ®Šå¤„ç†**ï¼š

å¯¹äº E102ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰é”™è¯¯ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ API è¿”å›çš„ `Retry-After` å¤´éƒ¨ï¼š

```typescript
// å¦‚æœ API è¿”å›äº† Retry-After å¤´éƒ¨
if (error.code === "E102" && error.details?.retryAfter) {
  const retryAfter = error.details.retryAfter; // å•ä½ï¼šç§’
  const waitTime = retryAfter * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
  await delay(waitTime);
} else {
  // å¦åˆ™ä½¿ç”¨æŒ‡æ•°é€€é¿
  const waitTime = calculateExponentialBackoff(attempt, baseDelayMs);
  await delay(waitTime);
}
```

**é…ç½®å‚æ•°**ï¼š

```typescript
export const NETWORK_ERROR_CONFIG: RetryConfig = {
  maxAttempts: 5,           // æœ€å¤š 5 æ¬¡å°è¯•
  strategy: "exponential",  // æŒ‡æ•°é€€é¿
  baseDelayMs: 1000,        // åŸºç¡€å»¶è¿Ÿ 1 ç§’
};
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œç½‘ç»œé”™è¯¯åˆ†ç±»

---

#### 3. ä¸é‡è¯•ç­–ç•¥ï¼ˆç»ˆæ­¢é”™è¯¯ï¼‰

**é€‚ç”¨é”™è¯¯**ï¼šE103ï¼ˆè®¤è¯é”™è¯¯ï¼‰ã€E200-E201ï¼ˆèƒ½åŠ›é”™è¯¯ï¼‰ã€E300-E304ï¼ˆæ–‡ä»¶ç³»ç»Ÿé”™è¯¯ï¼‰

**ç­–ç•¥ç‰¹ç‚¹**ï¼š
- **ç«‹å³å¤±è´¥**ï¼šä¸è¿›è¡Œä»»ä½•é‡è¯•ï¼Œç›´æ¥æ ‡è®°ä»»åŠ¡ä¸º Failed
- **ç”¨æˆ·é€šçŸ¥**ï¼šæ˜¾ç¤º Notice æç¤ºç”¨æˆ·é‡‡å–è¡ŒåŠ¨
- **é”™è¯¯è®°å½•**ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯åˆ°æ—¥å¿—

**å¤„ç†æµç¨‹**ï¼š

```mermaid
flowchart TD
    Start([ä»»åŠ¡æ‰§è¡Œ]) --> Execute[æ‰§è¡Œä»»åŠ¡]
    Execute --> Result{æ‰§è¡Œç»“æœ}
    Result -->|æˆåŠŸ| Success([ä»»åŠ¡æˆåŠŸ])
    Result -->|å¤±è´¥| CheckError{æ£€æŸ¥é”™è¯¯ç±»å‹}
    
    CheckError -->|ç»ˆæ­¢é”™è¯¯| Log[è®°å½•é”™è¯¯æ—¥å¿—]
    Log --> Notify[æ˜¾ç¤ºç”¨æˆ·é€šçŸ¥]
    Notify --> Failed([ä»»åŠ¡å¤±è´¥])
    
    CheckError -->|å…¶ä»–é”™è¯¯| OtherStrategy[å…¶ä»–é‡è¯•ç­–ç•¥]
    
    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style Failed fill:#ffcdd2
```

**ç”¨æˆ·é€šçŸ¥ç¤ºä¾‹**ï¼š

```typescript
// E103 è®¤è¯é”™è¯¯
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Keyã€‚", 5000);

// E201 èƒ½åŠ›é”™è¯¯
new Notice("Provider ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·é€‰æ‹©æ”¯æŒæ­¤åŠŸèƒ½çš„ Provider æˆ–æ£€æŸ¥é…ç½®ã€‚", 5000);

// E300 æ–‡ä»¶å†™å…¥é”™è¯¯
new Notice("æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´ã€‚", 5000);
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œç»ˆæ­¢é”™è¯¯åˆ†ç±»

---

#### é‡è¯•å†³ç­–æµç¨‹

ç³»ç»Ÿä½¿ç”¨ `RetryHandler` ç±»ç»Ÿä¸€ç®¡ç†é‡è¯•é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é‡è¯•å†³ç­–æµç¨‹ï¼š

```mermaid
flowchart TD
    Start([ä»»åŠ¡æ‰§è¡Œ]) --> Execute[æ‰§è¡Œä»»åŠ¡]
    Execute --> Result{æ‰§è¡Œç»“æœ}
    Result -->|æˆåŠŸ| Success([ä»»åŠ¡æˆåŠŸ])
    Result -->|å¤±è´¥| Classify[åˆ†ç±»é”™è¯¯<br/>classifyError]
    
    Classify --> Category{é”™è¯¯ç±»åˆ«}
    
    Category -->|å†…å®¹é”™è¯¯| ContentCheck{å°è¯•æ¬¡æ•° < 3?}
    ContentCheck -->|æ˜¯| ContentRetry[ç«‹å³é‡è¯•<br/>é™„åŠ é”™è¯¯å†å²]
    ContentCheck -->|å¦| Failed([ä»»åŠ¡å¤±è´¥])
    ContentRetry --> Execute
    
    Category -->|ç½‘ç»œé”™è¯¯| NetworkCheck{å°è¯•æ¬¡æ•° < 5?}
    NetworkCheck -->|æ˜¯| NetworkWait[è®¡ç®—ç­‰å¾…æ—¶é—´<br/>æŒ‡æ•°é€€é¿]
    NetworkCheck -->|å¦| Failed
    NetworkWait --> Wait[ç­‰å¾…]
    Wait --> Execute
    
    Category -->|ç»ˆæ­¢é”™è¯¯| Terminal[è®°å½•æ—¥å¿—<br/>é€šçŸ¥ç”¨æˆ·]
    Terminal --> Failed
    
    style Start fill:#e1f5ff
    style Success fill:#c8e6c9
    style Failed fill:#ffcdd2
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```typescript
class RetryHandler {
  /**
   * åˆ†ç±»é”™è¯¯å¹¶å†³å®šé‡è¯•ç­–ç•¥
   */
  classifyError(errorCode: string): ErrorClassification {
    if (this.isContentError(errorCode)) {
      return {
        category: "CONTENT_ERROR",
        strategy: "immediate",
        retryable: true,
        maxAttempts: 3,
      };
    }
    
    if (this.isNetworkError(errorCode)) {
      return {
        category: "NETWORK_ERROR",
        strategy: "exponential",
        retryable: true,
        maxAttempts: 5,
      };
    }
    
    // ç»ˆæ­¢é”™è¯¯ï¼šä¸é‡è¯•
    return {
      category: "TERMINAL_ERROR",
      strategy: "no_retry",
      retryable: false,
      maxAttempts: 1,
    };
  }
  
  /**
   * åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
   */
  shouldRetry(error: Err, currentAttempt: number): boolean {
    const classification = this.classifyError(error.error.code);
    
    // ä¸å¯é‡è¯•çš„é”™è¯¯
    if (!classification.retryable) {
      return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
    if (currentAttempt >= classification.maxAttempts) {
      return false;
    }
    
    return true;
  }
  
  /**
   * è®¡ç®—é‡è¯•ç­‰å¾…æ—¶é—´
   */
  calculateWaitTime(error: Err, attempt: number, baseDelayMs: number = 1000): number {
    const classification = this.classifyError(error.error.code);
    
    // ç«‹å³é‡è¯•ç­–ç•¥ï¼šä¸éœ€è¦ç­‰å¾…
    if (classification.strategy === "immediate") {
      return 0;
    }
    
    // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼š1s, 2s, 4s, 8s, 16s
    if (classification.strategy === "exponential") {
      return baseDelayMs * Math.pow(2, attempt - 1);
    }
    
    // ä¸é‡è¯•ç­–ç•¥
    return 0;
  }
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œ`classifyError()` æ–¹æ³•

---

#### é‡è¯•è€—å°½å¤„ç†

å½“ä»»åŠ¡é‡è¯•æ¬¡æ•°è€—å°½åï¼Œç³»ç»Ÿä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **æ›´æ–°ä»»åŠ¡çŠ¶æ€**ï¼šå°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º `Failed`
2. **è®°å½•é”™è¯¯å†å²**ï¼šä¿å­˜æ‰€æœ‰é‡è¯•è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯
3. **è®°å½•æœ€åé”™è¯¯**ï¼šä¿å­˜æœ€åä¸€æ¬¡å¤±è´¥çš„é”™è¯¯ä¿¡æ¯
4. **é‡Šæ”¾é”**ï¼šé‡Šæ”¾ä»»åŠ¡æŒæœ‰çš„èŠ‚ç‚¹é”å’Œç±»å‹é”
5. **æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€**ï¼šå°†é˜Ÿåˆ—çŠ¶æ€å†™å…¥ç£ç›˜
6. **é€šçŸ¥ UI**ï¼šé€šè¿‡äº‹ä»¶è®¢é˜…æœºåˆ¶é€šçŸ¥ UI æ›´æ–°

**é”™è¯¯å†å²ç»“æ„**ï¼š

```typescript
interface TaskError {
  /** é”™è¯¯ç  */
  code: string;
  /** é”™è¯¯æ¶ˆæ¯ */
  message: string;
  /** å‘ç”Ÿæ—¶é—´ */
  timestamp: string;
  /** é‡è¯•æ¬¡æ•° */
  attempt: number;
}

// ä»»åŠ¡å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯
{
  "taskId": "task-123",
  "state": "Failed",
  "lastError": {
    "code": "E001",
    "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
    "timestamp": "2025-12-10T10:35:00.000Z",
    "attempt": 3
  },
  "errorHistory": [
    {
      "code": "E001",
      "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
      "timestamp": "2025-12-10T10:30:00.000Z",
      "attempt": 1
    },
    {
      "code": "E001",
      "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
      "timestamp": "2025-12-10T10:32:00.000Z",
      "attempt": 2
    },
    {
      "code": "E001",
      "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
      "timestamp": "2025-12-10T10:35:00.000Z",
      "attempt": 3
    }
  ],
  "finalAttempt": 3
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé‡è¯•ç­–ç•¥å†³ç­–é€»è¾‘

---

#### é‡è¯•ç­–ç•¥é…ç½®

ç³»ç»Ÿå…è®¸é€šè¿‡è®¾ç½®è°ƒæ•´é‡è¯•ç­–ç•¥çš„å‚æ•°ï¼š

```typescript
interface PluginSettings {
  // ... å…¶ä»–è®¾ç½®
  
  /** æ˜¯å¦å¯ç”¨è‡ªåŠ¨é‡è¯• */
  autoRetry: boolean;
  
  /** æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆå…¨å±€é…ç½®ï¼Œå¯è¢«å…·ä½“ç­–ç•¥è¦†ç›–ï¼‰ */
  maxRetryAttempts: number;
  
  /** å•ä¸ªä»»åŠ¡æœ€å¤§æ‰§è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ */
  taskTimeoutMs: number;
}

// é»˜è®¤é…ç½®
const DEFAULT_SETTINGS: PluginSettings = {
  autoRetry: true,
  maxRetryAttempts: 3,
  taskTimeoutMs: 120000, // 2 åˆ†é’Ÿ
};
```

**æ³¨æ„**ï¼š
- `autoRetry` è®¾ç½®ä¸º `false` æ—¶ï¼Œç³»ç»Ÿå°†ä¸è¿›è¡Œä»»ä½•é‡è¯•ï¼Œæ‰€æœ‰ä»»åŠ¡å¤±è´¥åç«‹å³æ ‡è®°ä¸º Failed
- `maxRetryAttempts` æ˜¯å…¨å±€é…ç½®ï¼Œä½†å…·ä½“çš„é‡è¯•ç­–ç•¥ï¼ˆå†…å®¹é”™è¯¯ 3 æ¬¡ã€ç½‘ç»œé”™è¯¯ 5 æ¬¡ï¼‰ä¼šè¦†ç›–æ­¤é…ç½®
- `taskTimeoutMs` æ˜¯å•ä¸ªä»»åŠ¡çš„æœ€å¤§æ‰§è¡Œæ—¶é•¿ï¼Œè¶…æ—¶åä»»åŠ¡ä¼šè¢«ä¸­æ–­å¹¶æ ‡è®°ä¸º Failed

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šPluginSettings æ¥å£å®šä¹‰
- `src/core/retry-handler.ts`ï¼šRetryHandler å®Œæ•´å®ç°
- `src/core/task-queue.ts`ï¼šTaskQueue å®ç°ï¼Œé‡è¯•ç­–ç•¥åº”ç”¨

### 9.3 Result Monad

Cognitive Razor ä½¿ç”¨ **Result Monad** æ¨¡å¼å¤„ç†é”™è¯¯ï¼Œè€Œéä¼ ç»Ÿçš„å¼‚å¸¸æŠ›å‡ºæœºåˆ¶ã€‚è¿™ç§æ¨¡å¼ä½¿é”™è¯¯å¤„ç†æ›´åŠ æ˜¾å¼ã€å¯é¢„æµ‹å’Œç±»å‹å®‰å…¨ã€‚

#### ä»€ä¹ˆæ˜¯ Result Monadï¼Ÿ

Result Monad æ˜¯ä¸€ç§å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼ï¼Œç”¨äºè¡¨ç¤ºå¯èƒ½æˆåŠŸæˆ–å¤±è´¥çš„æ“ä½œç»“æœã€‚å®ƒå°†æ“ä½œçš„ç»“æœå°è£…åœ¨ä¸€ä¸ªç±»å‹ä¸­ï¼Œå¼ºåˆ¶è°ƒç”¨è€…æ˜¾å¼å¤„ç†æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š
- **æ˜¾å¼é”™è¯¯å¤„ç†**ï¼šé”™è¯¯ä¸æ˜¯"æŠ›å‡º"çš„ï¼Œè€Œæ˜¯ä½œä¸ºè¿”å›å€¼çš„ä¸€éƒ¨åˆ†
- **ç±»å‹å®‰å…¨**ï¼šTypeScript çš„ç±»å‹ç³»ç»Ÿç¡®ä¿ä½ ä¸ä¼šå¿˜è®°å¤„ç†é”™è¯¯
- **å¯ç»„åˆæ€§**ï¼šå¯ä»¥è½»æ¾é“¾å¼è°ƒç”¨å¤šä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œ

#### Result ç±»å‹å®šä¹‰

```typescript
/**
 * æˆåŠŸç»“æœ
 */
interface Ok<T> {
  ok: true;
  value: T;
}

/**
 * å¤±è´¥ç»“æœ
 */
interface Err {
  ok: false;
  error: {
    code: string;
    message: string;
    details?: unknown;
  };
}

/**
 * Result ç±»å‹ï¼šè¡¨ç¤ºå¯èƒ½æˆåŠŸæˆ–å¤±è´¥çš„æ“ä½œ
 */
type Result<T> = Ok<T> | Err;
```

**ç±»å‹è¯´æ˜**ï¼š
- `Ok<T>`ï¼šè¡¨ç¤ºæ“ä½œæˆåŠŸï¼ŒåŒ…å«ç±»å‹ä¸º `T` çš„å€¼
- `Err`ï¼šè¡¨ç¤ºæ“ä½œå¤±è´¥ï¼ŒåŒ…å«é”™è¯¯ç ã€é”™è¯¯æ¶ˆæ¯å’Œå¯é€‰çš„è¯¦ç»†ä¿¡æ¯
- `Result<T>`ï¼šæ˜¯ `Ok<T>` å’Œ `Err` çš„è”åˆç±»å‹

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šResult Monad ç±»å‹å®šä¹‰

---

#### åˆ›å»º Result å¯¹è±¡

ç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ç”¨äºåˆ›å»º Result å¯¹è±¡ï¼š

```typescript
/**
 * åˆ›å»ºæˆåŠŸç»“æœ
 */
function ok<T>(value: T): Ok<T> {
  return { ok: true, value };
}

/**
 * åˆ›å»ºå¤±è´¥ç»“æœ
 */
function err(code: string, message: string, details?: unknown): Err {
  return { ok: false, error: { code, message, details } };
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// æˆåŠŸç»“æœ
const successResult = ok({ uid: "123", name: "è®¡ç®—æœºç§‘å­¦" });
// ç±»å‹ï¼šResult<{ uid: string; name: string }>

// å¤±è´¥ç»“æœ
const failureResult = err("E001", "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥", {
  rawOutput: "è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µ...",
  parseError: "Unexpected token è¿™ in JSON at position 0"
});
// ç±»å‹ï¼šErr
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šResult Monad è¾…åŠ©å‡½æ•° `ok()` å’Œ `err()`

---

#### ä½¿ç”¨ Result Monad

**1. å‡½æ•°è¿”å› Result**

æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½åº”è¯¥è¿”å› `Result<T>` ç±»å‹ï¼š

```typescript
// æ–‡ä»¶è¯»å–æ“ä½œ
async function readFile(path: string): Promise<Result<string>> {
  try {
    const content = await vault.read(path);
    return ok(content);
  } catch (error) {
    return err("E301", "æ–‡ä»¶è¯»å–å¤±è´¥", {
      path,
      error: error.message
    });
  }
}

// æ–‡ä»¶å†™å…¥æ“ä½œ
async function writeFile(path: string, content: string): Promise<Result<void>> {
  try {
    await vault.write(path, content);
    return ok(undefined); // void ç±»å‹ä½¿ç”¨ undefined
  } catch (error) {
    return err("E300", "æ–‡ä»¶å†™å…¥å¤±è´¥", {
      path,
      error: error.message
    });
  }
}

// å‘é‡ç´¢å¼•æœç´¢
async function search(type: CRType, embedding: number[], topK: number): Promise<Result<SearchResult[]>> {
  try {
    const results = await performSearch(type, embedding, topK);
    return ok(results);
  } catch (error) {
    return err("E302", "å‘é‡ç´¢å¼•æŸå", {
      type,
      error: error.message
    });
  }
}
```

**2. å¤„ç† Result**

è°ƒç”¨è¿”å› Result çš„å‡½æ•°æ—¶ï¼Œå¿…é¡»æ˜¾å¼æ£€æŸ¥ `ok` å­—æ®µï¼š

```typescript
// æ–¹å¼ 1ï¼šä½¿ç”¨ if è¯­å¥
const result = await readFile("path/to/file.md");
if (result.ok) {
  // æˆåŠŸï¼šè®¿é—® result.value
  const content = result.value;
  console.log("æ–‡ä»¶å†…å®¹:", content);
} else {
  // å¤±è´¥ï¼šè®¿é—® result.error
  console.error("è¯»å–å¤±è´¥:", result.error.message);
  console.error("é”™è¯¯ç :", result.error.code);
}

// æ–¹å¼ 2ï¼šä½¿ç”¨ä¸‰å…ƒè¡¨è¾¾å¼
const content = result.ok ? result.value : "";

// æ–¹å¼ 3ï¼šæå‰è¿”å›ï¼ˆæ¨èï¼‰
const result = await readFile("path/to/file.md");
if (!result.ok) {
  // å¤„ç†é”™è¯¯å¹¶æå‰è¿”å›
  logger.error("FileStorage", "è¯»å–å¤±è´¥", undefined, {
    errorCode: result.error.code,
    errorMessage: result.error.message
  });
  return err(result.error.code, result.error.message, result.error.details);
}

// ç»§ç»­å¤„ç†æˆåŠŸæƒ…å†µ
const content = result.value;
// ...
```

**3. é”™è¯¯ä¼ æ’­**

å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¤šä¸ªè¿”å› Result çš„å‡½æ•°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æå‰è¿”å›æ¨¡å¼ä¼ æ’­é”™è¯¯ï¼š

```typescript
async function createConcept(description: string): Promise<Result<string>> {
  // æ­¥éª¤ 1ï¼šæ ‡å‡†åŒ–
  const standardizeResult = await standardize(description);
  if (!standardizeResult.ok) {
    return standardizeResult; // ç›´æ¥ä¼ æ’­é”™è¯¯
  }
  const standardized = standardizeResult.value;
  
  // æ­¥éª¤ 2ï¼šç”ŸæˆåµŒå…¥
  const embedResult = await generateEmbedding(standardized.name);
  if (!embedResult.ok) {
    return embedResult; // ç›´æ¥ä¼ æ’­é”™è¯¯
  }
  const embedding = embedResult.value;
  
  // æ­¥éª¤ 3ï¼šæ£€æµ‹é‡å¤
  const searchResult = await vectorIndex.search(standardized.type, embedding, 10);
  if (!searchResult.ok) {
    return searchResult; // ç›´æ¥ä¼ æ’­é”™è¯¯
  }
  const duplicates = searchResult.value;
  
  // æ­¥éª¤ 4ï¼šå†™å…¥æ–‡ä»¶
  const writeResult = await writeFile(path, content);
  if (!writeResult.ok) {
    return writeResult; // ç›´æ¥ä¼ æ’­é”™è¯¯
  }
  
  // æ‰€æœ‰æ­¥éª¤æˆåŠŸ
  return ok(standardized.uid);
}
```

**4. é”™è¯¯è½¬æ¢**

æœ‰æ—¶éœ€è¦å°†ä¸€ä¸ªé”™è¯¯è½¬æ¢ä¸ºå¦ä¸€ä¸ªé”™è¯¯ï¼š

```typescript
async function loadSettings(): Promise<Result<PluginSettings>> {
  const readResult = await readFile("data.json");
  if (!readResult.ok) {
    // å°†æ–‡ä»¶è¯»å–é”™è¯¯è½¬æ¢ä¸ºè®¾ç½®åŠ è½½é”™è¯¯
    return err("E301", "è®¾ç½®åŠ è½½å¤±è´¥", {
      originalError: readResult.error,
      path: "data.json"
    });
  }
  
  const content = readResult.value;
  
  try {
    const settings = JSON.parse(content);
    return ok(settings);
  } catch (error) {
    return err("E001", "è®¾ç½®è§£æå¤±è´¥", {
      parseError: error.message
    });
  }
}
```

---

#### Result Monad çš„ä¼˜åŠ¿

**1. æ˜¾å¼é”™è¯¯å¤„ç†**

ä¼ ç»Ÿçš„å¼‚å¸¸æœºåˆ¶éšè—äº†é”™è¯¯çš„å¯èƒ½æ€§ï¼Œè°ƒç”¨è€…å¯èƒ½å¿˜è®°å¤„ç†é”™è¯¯ï¼š

```typescript
// ä¼ ç»Ÿæ–¹å¼ï¼šå®¹æ˜“å¿˜è®° try-catch
async function badExample() {
  const content = await readFile("path/to/file.md"); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸
  // å¦‚æœå¿˜è®° try-catchï¼Œç¨‹åºä¼šå´©æºƒ
}

// Result Monadï¼šå¼ºåˆ¶å¤„ç†é”™è¯¯
async function goodExample() {
  const result = await readFile("path/to/file.md");
  if (!result.ok) {
    // TypeScript å¼ºåˆ¶ä½ å¤„ç†é”™è¯¯
    return;
  }
  const content = result.value;
}
```

**2. ç±»å‹å®‰å…¨**

TypeScript çš„ç±»å‹ç³»ç»Ÿç¡®ä¿ä½ ä¸ä¼šåœ¨é”™è¯¯æƒ…å†µä¸‹è®¿é—® `value`ï¼š

```typescript
const result = await readFile("path/to/file.md");

// âŒ é”™è¯¯ï¼šTypeScript ä¼šæŠ¥é”™
const content = result.value; // Property 'value' does not exist on type 'Err'

// âœ… æ­£ç¡®ï¼šå…ˆæ£€æŸ¥ ok å­—æ®µ
if (result.ok) {
  const content = result.value; // TypeScript çŸ¥é“è¿™é‡Œæ˜¯ Ok<string>
}
```

**3. å¯ç»„åˆæ€§**

Result Monad å¯ä»¥è½»æ¾ç»„åˆå¤šä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œï¼š

```typescript
// é“¾å¼è°ƒç”¨å¤šä¸ªæ“ä½œ
async function pipeline(input: string): Promise<Result<Output>> {
  const step1 = await operation1(input);
  if (!step1.ok) return step1;
  
  const step2 = await operation2(step1.value);
  if (!step2.ok) return step2;
  
  const step3 = await operation3(step2.value);
  if (!step3.ok) return step3;
  
  return ok(step3.value);
}
```

**4. é”™è¯¯ä¿¡æ¯ä¸°å¯Œ**

Result Monad å¯ä»¥æºå¸¦ä¸°å¯Œçš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸ä»…ä»…æ˜¯é”™è¯¯æ¶ˆæ¯ï¼š

```typescript
return err("E001", "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥", {
  rawOutput: "è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µ...",
  parseError: "Unexpected token è¿™ in JSON at position 0",
  attempt: 2,
  timestamp: "2025-12-10T10:30:00.000Z"
});
```

**5. é¿å…å¼‚å¸¸çš„æ€§èƒ½å¼€é”€**

å¼‚å¸¸æŠ›å‡ºå’Œæ•è·æœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼ŒResult Monad ä½¿ç”¨æ™®é€šçš„è¿”å›å€¼ï¼Œæ€§èƒ½æ›´å¥½ã€‚

---

#### Result Monad çš„æœ€ä½³å®è·µ

**1. æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½è¿”å› Result**

```typescript
// âœ… å¥½çš„åšæ³•
async function readFile(path: string): Promise<Result<string>> { /* ... */ }

// âŒ ä¸å¥½çš„åšæ³•
async function readFile(path: string): Promise<string> {
  // æŠ›å‡ºå¼‚å¸¸
  throw new Error("æ–‡ä»¶ä¸å­˜åœ¨");
}
```

**2. ä½¿ç”¨æå‰è¿”å›æ¨¡å¼ä¼ æ’­é”™è¯¯**

```typescript
// âœ… å¥½çš„åšæ³•
async function process(): Promise<Result<Output>> {
  const result1 = await step1();
  if (!result1.ok) return result1;
  
  const result2 = await step2(result1.value);
  if (!result2.ok) return result2;
  
  return ok(result2.value);
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šåµŒå¥—è¿‡æ·±
async function process(): Promise<Result<Output>> {
  const result1 = await step1();
  if (result1.ok) {
    const result2 = await step2(result1.value);
    if (result2.ok) {
      return ok(result2.value);
    } else {
      return result2;
    }
  } else {
    return result1;
  }
}
```

**3. é”™è¯¯ç ä½¿ç”¨å¸¸é‡**

```typescript
// âœ… å¥½çš„åšæ³•
import { ContentErrorCodes } from "./error-codes";

return err(ContentErrorCodes.E001, "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥");

// âŒ ä¸å¥½çš„åšæ³•ï¼šç¡¬ç¼–ç å­—ç¬¦ä¸²
return err("E001", "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥");
```

**4. æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯**

```typescript
// âœ… å¥½çš„åšæ³•
return err("E300", "æ–‡ä»¶å†™å…¥å¤±è´¥", {
  path: "1-é¢†åŸŸ/è®¡ç®—æœºç§‘å­¦.md",
  error: "ENOSPC: no space left on device",
  diskSpace: "0 bytes available"
});

// âŒ ä¸å¥½çš„åšæ³•ï¼šé”™è¯¯ä¿¡æ¯ä¸è¶³
return err("E300", "æ–‡ä»¶å†™å…¥å¤±è´¥");
```

**5. åœ¨ UI å±‚è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯**

```typescript
// åº”ç”¨å±‚ï¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
return err("E103", "è®¤è¯å¤±è´¥ (401/403)", {
  statusCode: 401,
  provider: "openai",
  error: "Invalid API key"
});

// UI å±‚ï¼šè½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯
if (!result.ok) {
  const userMessage = getUserFriendlyMessage(result.error);
  new Notice(userMessage, 5000);
}

function getUserFriendlyMessage(error: Err["error"]): string {
  switch (error.code) {
    case "E103":
      return "è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Keyã€‚";
    case "E300":
      return "æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´ã€‚";
    default:
      return error.message;
  }
}
```

---

#### Result Monad ä¸å¼‚å¸¸çš„å¯¹æ¯”

| ç‰¹æ€§ | Result Monad | å¼‚å¸¸ |
|------|-------------|------|
| **æ˜¾å¼æ€§** | âœ… æ˜¾å¼ï¼Œå¼ºåˆ¶å¤„ç† | âŒ éšå¼ï¼Œå®¹æ˜“å¿˜è®° |
| **ç±»å‹å®‰å…¨** | âœ… ç±»å‹ç³»ç»Ÿä¿è¯ | âŒ è¿è¡Œæ—¶æ‰çŸ¥é“ |
| **æ€§èƒ½** | âœ… æ— é¢å¤–å¼€é”€ | âŒ æœ‰æŠ›å‡º/æ•è·å¼€é”€ |
| **é”™è¯¯ä¿¡æ¯** | âœ… å¯æºå¸¦ä¸°å¯Œä¿¡æ¯ | âš ï¸ ä¾èµ– Error å¯¹è±¡ |
| **å¯ç»„åˆæ€§** | âœ… æ˜“äºç»„åˆ | âŒ éœ€è¦å¤šå±‚ try-catch |
| **å­¦ä¹ æ›²çº¿** | âš ï¸ éœ€è¦ç†è§£å‡½æ•°å¼ç¼–ç¨‹ | âœ… ä¼ ç»Ÿæ–¹å¼ï¼Œæ˜“ç†è§£ |

**ä½•æ—¶ä½¿ç”¨å¼‚å¸¸**ï¼š
- ç³»ç»Ÿçº§é”™è¯¯ï¼ˆå¦‚å†…å­˜ä¸è¶³ã€æ ˆæº¢å‡ºï¼‰
- ä¸å¯æ¢å¤çš„é”™è¯¯ï¼ˆå¦‚ç¨‹åºé€»è¾‘é”™è¯¯ï¼‰
- ç¬¬ä¸‰æ–¹åº“æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆéœ€è¦åœ¨è¾¹ç•Œå¤„è½¬æ¢ä¸º Resultï¼‰

**ä½•æ—¶ä½¿ç”¨ Result Monad**ï¼š
- ä¸šåŠ¡é€»è¾‘ä¸­çš„å¯é¢„æœŸé”™è¯¯
- éœ€è¦ä¼ æ’­é”™è¯¯ä¿¡æ¯çš„åœºæ™¯
- éœ€è¦ç±»å‹å®‰å…¨çš„é”™è¯¯å¤„ç†

---

#### å®é™…åº”ç”¨ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šæ–‡ä»¶å­˜å‚¨**

```typescript
class FileStorage implements IFileStorage {
  async read(path: string): Promise<Result<string>> {
    try {
      const content = await this.vault.read(path);
      return ok(content);
    } catch (error) {
      this.logger.error("FileStorage", "æ–‡ä»¶è¯»å–å¤±è´¥", error as Error, { path });
      return err("E301", "æ–‡ä»¶è¯»å–å¤±è´¥", {
        path,
        error: (error as Error).message
      });
    }
  }
  
  async write(path: string, content: string): Promise<Result<void>> {
    try {
      await this.vault.write(path, content);
      this.logger.info("FileStorage", "æ–‡ä»¶å†™å…¥æˆåŠŸ", { path });
      return ok(undefined);
    } catch (error) {
      this.logger.error("FileStorage", "æ–‡ä»¶å†™å…¥å¤±è´¥", error as Error, { path });
      return err("E300", "æ–‡ä»¶å†™å…¥å¤±è´¥", {
        path,
        error: (error as Error).message
      });
    }
  }
}
```

**ç¤ºä¾‹ 2ï¼šä»»åŠ¡æ‰§è¡Œå™¨**

```typescript
class TaskRunner implements ITaskRunner {
  async run(task: TaskRecord): Promise<Result<TaskResult>> {
    // æ­¥éª¤ 1ï¼šåŠ è½½æç¤ºè¯
    const promptResult = this.promptManager.build(task.taskType, task.payload);
    if (!promptResult.ok) {
      return err(promptResult.error.code, promptResult.error.message, promptResult.error.details);
    }
    const prompt = promptResult.value;
    
    // æ­¥éª¤ 2ï¼šè°ƒç”¨ API
    const apiResult = await this.providerManager.chat({
      providerId: task.providerRef,
      model: "gpt-4o",
      messages: [{ role: "user", content: prompt }]
    });
    if (!apiResult.ok) {
      return err(apiResult.error.code, apiResult.error.message, apiResult.error.details);
    }
    const response = apiResult.value;
    
    // æ­¥éª¤ 3ï¼šéªŒè¯è¾“å‡º
    const validateResult = await this.validator.validate(response.content, schema, rules);
    if (!validateResult.valid) {
      return err("E002", "è¾“å‡ºéªŒè¯å¤±è´¥", {
        errors: validateResult.errors
      });
    }
    
    // æ‰€æœ‰æ­¥éª¤æˆåŠŸ
    return ok({
      taskId: task.id,
      state: "Completed",
      data: validateResult.data
    });
  }
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šResult Monad å®Œæ•´å®šä¹‰
- `src/data/file-storage.ts`ï¼šFileStorage å®ç°ï¼ŒResult Monad ä½¿ç”¨ç¤ºä¾‹
- `src/core/task-runner.ts`ï¼šTaskRunner å®ç°ï¼ŒResult Monad ä½¿ç”¨ç¤ºä¾‹

### 9.4 æ—¥å¿—è®°å½•

Cognitive Razor å®ç°äº†ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ç³»ç»Ÿï¼Œæä¾›å®Œæ•´çš„å¯è§‚å¯Ÿæ€§æ”¯æŒã€‚æ—¥å¿—ç³»ç»Ÿä¸ä»…è®°å½•é”™è¯¯ï¼Œè¿˜è®°å½•å…³é”®äº‹ä»¶ã€æ€§èƒ½æŒ‡æ ‡å’Œç³»ç»ŸçŠ¶æ€å˜åŒ–ï¼Œå¸®åŠ©å¼€å‘è€…å’Œç”¨æˆ·ç†è§£ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µã€‚

#### æ—¥å¿—çº§åˆ«

ç³»ç»Ÿæ”¯æŒå››ä¸ªæ—¥å¿—çº§åˆ«ï¼ŒæŒ‰ä¸¥é‡ç¨‹åº¦ä»ä½åˆ°é«˜æ’åˆ—ï¼š

| çº§åˆ« | å›¾æ ‡ | æ ‡ç­¾ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|------|------|
| **debug** | ğŸ” | DBG | è°ƒè¯•ä¿¡æ¯ï¼Œè¯¦ç»†çš„æ‰§è¡Œæµç¨‹ | ä»»åŠ¡çŠ¶æ€è½¬æ¢ã€é”è·å–/é‡Šæ”¾ã€API è¯·æ±‚å‚æ•° |
| **info** | â„¹ï¸ | INF | ä¸€èˆ¬ä¿¡æ¯ï¼Œæ­£å¸¸çš„ç³»ç»Ÿäº‹ä»¶ | ä»»åŠ¡å®Œæˆã€æ–‡ä»¶å†™å…¥æˆåŠŸã€é˜Ÿåˆ—çŠ¶æ€æ›´æ–° |
| **warn** | âš ï¸ | WRN | è­¦å‘Šä¿¡æ¯ï¼Œæ½œåœ¨çš„é—®é¢˜ | é‡è¯•æ¬¡æ•°æ¥è¿‘ä¸Šé™ã€ç£ç›˜ç©ºé—´ä¸è¶³ã€API å“åº”æ…¢ |
| **error** | âŒ | ERR | é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨çš„é—®é¢˜ | ä»»åŠ¡å¤±è´¥ã€API è°ƒç”¨å¤±è´¥ã€æ–‡ä»¶è¯»å†™é”™è¯¯ |

**æ—¥å¿—çº§åˆ«è¿‡æ»¤**ï¼š

ç³»ç»Ÿæ ¹æ®é…ç½®çš„æœ€å°æ—¥å¿—çº§åˆ«è¿‡æ»¤æ—¥å¿—è¾“å‡ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½®ä¸º `info`ï¼Œåˆ™åªè®°å½• `info`ã€`warn` å’Œ `error` çº§åˆ«çš„æ—¥å¿—ï¼Œ`debug` çº§åˆ«çš„æ—¥å¿—ä¼šè¢«å¿½ç•¥ã€‚

```typescript
// æ—¥å¿—çº§åˆ«ä¼˜å…ˆçº§
const LOG_LEVEL_PRIORITY: Record<LogLevel, number> = {
  debug: 0,
  info: 1,
  warn: 2,
  error: 3,
};

// æ£€æŸ¥æ˜¯å¦åº”è¯¥è®°å½•è¯¥çº§åˆ«çš„æ—¥å¿—
function shouldLog(level: LogLevel, minLevel: LogLevel): boolean {
  return LOG_LEVEL_PRIORITY[level] >= LOG_LEVEL_PRIORITY[minLevel];
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œæ—¥å¿—çº§åˆ«å®šä¹‰

---

#### æ—¥å¿—æ ¼å¼

ç³»ç»Ÿæ”¯æŒä¸‰ç§æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œé€‚ç”¨äºä¸åŒçš„åœºæ™¯ï¼š

**1. JSON æ ¼å¼ï¼ˆjsonï¼‰**

ç»“æ„åŒ–çš„ JSON æ ¼å¼ï¼Œé€‚åˆæœºå™¨è§£æå’Œæ—¥å¿—åˆ†æå·¥å…·ï¼š

```json
{
  "timestamp": "2025-12-10T10:30:00.000Z",
  "level": "info",
  "module": "TaskQueue",
  "event": "TASK_STATE_CHANGE",
  "message": "ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running",
  "traceId": "abc123-def456",
  "context": {
    "taskId": "task-123",
    "nodeId": "node-456",
    "oldState": "Pending",
    "newState": "Running"
  }
}
```

**2. Pretty æ ¼å¼ï¼ˆprettyï¼‰**

äººç±»å¯è¯»çš„æ ¼å¼ï¼Œå¸¦å›¾æ ‡å’Œç¼©è¿›ï¼Œé€‚åˆå¼€å‘è°ƒè¯•ï¼š

```
10:30:00.123 â„¹ï¸ [TaskQueue][abc123] ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running {taskId=task-123, nodeId=node-456, oldState=Pending, newState=Running}
```

**3. Compact æ ¼å¼ï¼ˆcompactï¼‰**

ç´§å‡‘çš„å•è¡Œæ ¼å¼ï¼Œé€‚åˆå¿«é€Ÿæ‰«æï¼š

```
10:30:00.123 INF TaskQueue[abc123]: ä»»åŠ¡çŠ¶æ€å˜æ›´: Pending â†’ Running {taskId=task-123, nodeId=node-456}
```

**æ ¼å¼é…ç½®**ï¼š

```typescript
// è®¾ç½®æ–‡ä»¶è¾“å‡ºæ ¼å¼
logger.setFileFormat("json");

// è®¾ç½®æ§åˆ¶å°è¾“å‡ºæ ¼å¼
logger.setConsoleFormat("pretty");
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œæ—¥å¿—æ–¹æ³•ï¼ˆdebugã€infoã€warnã€errorï¼‰

---

#### æ—¥å¿—æ¡ç›®ç»“æ„

æ¯æ¡æ—¥å¿—éƒ½åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```typescript
interface LogEntry {
  /** ISO 8601 æ ¼å¼æ—¶é—´æˆ³ */
  timestamp: string;
  
  /** æ—¥å¿—çº§åˆ« */
  level: LogLevel;
  
  /** æ¨¡å—åç§° */
  module: string;
  
  /** äº‹ä»¶ç±»å‹ */
  event: string;
  
  /** äººç±»å¯è¯»æ¶ˆæ¯ */
  message: string;
  
  /** è¿½è¸ª IDï¼ˆç”¨äºå…³è”åŒä¸€æ“ä½œçš„å¤šæ¡æ—¥å¿—ï¼‰ */
  traceId?: string;
  
  /** ä¸Šä¸‹æ–‡æ•°æ® */
  context?: Record<string, unknown>;
  
  /** é”™è¯¯ä¿¡æ¯ */
  error?: {
    name: string;
    message: string;
    stack?: string;
    code?: string;
    codeName?: string;
    fixSuggestion?: string;
  };
}
```

**å­—æ®µè¯´æ˜**ï¼š

- **timestamp**ï¼šæ—¥å¿—è®°å½•çš„æ—¶é—´ï¼Œä½¿ç”¨ ISO 8601 æ ¼å¼ï¼ˆå¦‚ `2025-12-10T10:30:00.000Z`ï¼‰
- **level**ï¼šæ—¥å¿—çº§åˆ«ï¼ˆdebugã€infoã€warnã€errorï¼‰
- **module**ï¼šäº§ç”Ÿæ—¥å¿—çš„æ¨¡å—åç§°ï¼ˆå¦‚ TaskQueueã€VectorIndexã€ProviderManagerï¼‰
- **event**ï¼šäº‹ä»¶ç±»å‹ï¼Œç”¨äºåˆ†ç±»å’Œè¿‡æ»¤ï¼ˆå¦‚ TASK_STATE_CHANGEã€API_ERRORã€FILE_WRITEï¼‰
- **message**ï¼šäººç±»å¯è¯»çš„æ—¥å¿—æ¶ˆæ¯
- **traceId**ï¼šè¿½è¸ª IDï¼Œç”¨äºå…³è”åŒä¸€æ“ä½œçš„å¤šæ¡æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
- **context**ï¼šä¸Šä¸‹æ–‡æ•°æ®ï¼ŒåŒ…å«ä¸æ—¥å¿—ç›¸å…³çš„é¢å¤–ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
- **error**ï¼šé”™è¯¯ä¿¡æ¯ï¼ŒåŒ…å«é”™è¯¯åç§°ã€æ¶ˆæ¯ã€å †æ ˆã€é”™è¯¯ç ç­‰ï¼ˆå¯é€‰ï¼‰

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼ŒLogEntry ç»“æ„å®šä¹‰

---

#### å…³é”®äº‹ä»¶ç±»å‹

ç³»ç»Ÿå®šä¹‰äº†ä¸€ç³»åˆ—å…³é”®äº‹ä»¶ç±»å‹ï¼Œç”¨äºæ ‡è¯†ä¸åŒçš„æ—¥å¿—åœºæ™¯ï¼š

**ä»»åŠ¡ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `TASK_STATE_CHANGE` | ä»»åŠ¡çŠ¶æ€å˜æ›´ | info | Pending â†’ Running |
| `TASK_ENQUEUE` | ä»»åŠ¡å…¥é˜Ÿ | info | ä»»åŠ¡ task-123 å·²å…¥é˜Ÿ |
| `TASK_COMPLETE` | ä»»åŠ¡å®Œæˆ | info | ä»»åŠ¡ task-123 å·²å®Œæˆ |
| `TASK_FAILED` | ä»»åŠ¡å¤±è´¥ | error | ä»»åŠ¡ task-123 å¤±è´¥ï¼Œé”™è¯¯ç  E001 |
| `TASK_RETRY` | ä»»åŠ¡é‡è¯• | warn | ä»»åŠ¡ task-123 é‡è¯•ï¼Œå°è¯• 2/3 |
| `TASK_TIMEOUT` | ä»»åŠ¡è¶…æ—¶ | error | ä»»åŠ¡ task-123 è¶…æ—¶ï¼Œå·²ä¸­æ–­ |

**API ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `API_REQUEST` | API è¯·æ±‚ | debug | è°ƒç”¨ OpenAI APIï¼Œæ¨¡å‹ gpt-4o |
| `API_RESPONSE` | API å“åº” | debug | API å“åº”æˆåŠŸï¼Œè€—æ—¶ 1234ms |
| `API_ERROR` | API é”™è¯¯ | error | API è°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç  429 |
| `API_RETRY` | API é‡è¯• | warn | API é‡è¯•ï¼Œå°è¯• 2/5 |

**æ–‡ä»¶ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `FILE_READ` | æ–‡ä»¶è¯»å– | debug | è¯»å–æ–‡ä»¶ data.json |
| `FILE_WRITE` | æ–‡ä»¶å†™å…¥ | info | å†™å…¥æ–‡ä»¶ 1-é¢†åŸŸ/è®¡ç®—æœºç§‘å­¦.md |
| `FILE_DELETE` | æ–‡ä»¶åˆ é™¤ | info | åˆ é™¤æ–‡ä»¶ temp.md |
| `FILE_ERROR` | æ–‡ä»¶é”™è¯¯ | error | æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œç£ç›˜ç©ºé—´ä¸è¶³ |

**ç´¢å¼•ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `INDEX_UPDATE` | ç´¢å¼•æ›´æ–° | info | æ›´æ–°å‘é‡ç´¢å¼•ï¼ŒUID node-123 |
| `INDEX_SEARCH` | ç´¢å¼•æœç´¢ | debug | æœç´¢ç›¸ä¼¼æ¦‚å¿µï¼Œç±»å‹ Domain |
| `INDEX_CORRUPTED` | ç´¢å¼•æŸå | error | å‘é‡ç´¢å¼•æŸåï¼Œéœ€è¦é‡å»º |

**é˜Ÿåˆ—ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `QUEUE_PAUSED` | é˜Ÿåˆ—æš‚åœ | info | é˜Ÿåˆ—å·²æš‚åœ |
| `QUEUE_RESUMED` | é˜Ÿåˆ—æ¢å¤ | info | é˜Ÿåˆ—å·²æ¢å¤ |
| `QUEUE_STATE_PERSIST` | é˜Ÿåˆ—çŠ¶æ€æŒä¹…åŒ– | debug | é˜Ÿåˆ—çŠ¶æ€å·²æŒä¹…åŒ– |

**é”ç›¸å…³äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ—¥å¿—çº§åˆ« | ç¤ºä¾‹ |
|---------|------|---------|------|
| `LOCK_ACQUIRED` | é”è·å– | debug | è·å–èŠ‚ç‚¹é”ï¼ŒnodeId node-123 |
| `LOCK_RELEASED` | é”é‡Šæ”¾ | debug | é‡Šæ”¾èŠ‚ç‚¹é”ï¼ŒnodeId node-123 |
| `LOCK_CONFLICT` | é”å†²çª | warn | é”å†²çªï¼Œä»»åŠ¡ task-123 ç­‰å¾… |

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œäº‹ä»¶ç±»å‹å®šä¹‰å’Œä½¿ç”¨ç¤ºä¾‹

---

#### ä½¿ç”¨æ—¥å¿—è®°å½•å™¨

**1. åŸºæœ¬ç”¨æ³•**

```typescript
// è°ƒè¯•æ—¥å¿—
logger.debug("TaskQueue", "ä»»åŠ¡å…¥é˜Ÿ", {
  event: "TASK_ENQUEUE",
  taskId: "task-123",
  taskType: "embedding"
});

// ä¿¡æ¯æ—¥å¿—
logger.info("FileStorage", "æ–‡ä»¶å†™å…¥æˆåŠŸ", {
  event: "FILE_WRITE",
  path: "1-é¢†åŸŸ/è®¡ç®—æœºç§‘å­¦.md",
  size: 1024
});

// è­¦å‘Šæ—¥å¿—
logger.warn("TaskQueue", "ä»»åŠ¡é‡è¯•", {
  event: "TASK_RETRY",
  taskId: "task-123",
  attempt: 2,
  maxAttempts: 3
});

// é”™è¯¯æ—¥å¿—
logger.error("ProviderManager", "API è°ƒç”¨å¤±è´¥", error, {
  event: "API_ERROR",
  provider: "openai",
  statusCode: 429
});
```

**2. å¸¦é”™è¯¯ç çš„æ—¥å¿—**

```typescript
// ä½¿ç”¨ errorWithCode æ–¹æ³•è®°å½•å¸¦é”™è¯¯ç çš„é”™è¯¯
logger.errorWithCode(
  "TaskRunner",
  "E001",
  "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
  error,
  {
    event: "TASK_FAILED",
    taskId: "task-123",
    rawOutput: "è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µ..."
  }
);

// æ—¥å¿—è¾“å‡ºä¼šè‡ªåŠ¨åŒ…å«é”™è¯¯ç ä¿¡æ¯ï¼š
// {
//   "timestamp": "2025-12-10T10:30:00.000Z",
//   "level": "error",
//   "module": "TaskRunner",
//   "event": "TASK_FAILED",
//   "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
//   "error": {
//     "name": "PARSE_ERROR",
//     "message": "è¾“å‡ºé JSON æˆ–è§£æå¤±è´¥",
//     "code": "E001",
//     "codeName": "PARSE_ERROR",
//     "fixSuggestion": "AI è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•å¹¶æä¾›æ›´æ˜ç¡®çš„æŒ‡ç¤ºã€‚"
//   },
//   "context": {
//     "taskId": "task-123",
//     "rawOutput": "è¿™æ˜¯ä¸€ä¸ªæ¦‚å¿µ..."
//   }
// }
```

**3. è¿½è¸ª IDï¼ˆTrace IDï¼‰**

è¿½è¸ª ID ç”¨äºå…³è”åŒä¸€æ“ä½œçš„å¤šæ¡æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªå®Œæ•´çš„æ‰§è¡Œæµç¨‹ï¼š

```typescript
// å¼€å§‹è¿½è¸ª
const traceId = logger.startTrace("æ¦‚å¿µåˆ›å»ºæµç¨‹");

// æ‰§è¡Œæ“ä½œï¼Œæ‰€æœ‰æ—¥å¿—éƒ½ä¼šåŒ…å« traceId
logger.info("PipelineOrchestrator", "å¼€å§‹æ ‡å‡†åŒ–", {
  event: "PIPELINE_START",
  stage: "standardize"
});

logger.info("TaskQueue", "ä»»åŠ¡å…¥é˜Ÿ", {
  event: "TASK_ENQUEUE",
  taskId: "task-123"
});

logger.info("TaskRunner", "ä»»åŠ¡æ‰§è¡Œ", {
  event: "TASK_EXECUTE",
  taskId: "task-123"
});

// ç»“æŸè¿½è¸ª
logger.endTrace("æ¦‚å¿µåˆ›å»ºæµç¨‹");

// æ‰€æœ‰æ—¥å¿—éƒ½ä¼šåŒ…å«ç›¸åŒçš„ traceIdï¼Œä¾¿äºè¿‡æ»¤å’Œåˆ†æ
```

**4. æ—¥å¿—åˆ†ç»„**

æ—¥å¿—åˆ†ç»„ç”¨äºå°†ç›¸å…³çš„æ—¥å¿—æ¡ç›®ç»„ç»‡åœ¨ä¸€èµ·ï¼Œæé«˜å¯è¯»æ€§ï¼š

```typescript
// å¼€å§‹åˆ†ç»„
logger.startGroup("æ¦‚å¿µåˆ›å»ºæµç¨‹");

logger.info("Step 1", "æ ‡å‡†åŒ–");
logger.info("Step 2", "ç”ŸæˆåµŒå…¥");
logger.info("Step 3", "æ£€æµ‹é‡å¤");

// ç»“æŸåˆ†ç»„
logger.endGroup();

// è¾“å‡ºï¼š
// â”Œâ”€ æ¦‚å¿µåˆ›å»ºæµç¨‹
// Step 1: æ ‡å‡†åŒ–
// Step 2: ç”ŸæˆåµŒå…¥
// Step 3: æ£€æµ‹é‡å¤
// â””â”€ æ¦‚å¿µåˆ›å»ºæµç¨‹ å®Œæˆ
```

**5. è€—æ—¶è®°å½•**

ç³»ç»Ÿæä¾›äº†ä¾¿æ·çš„è€—æ—¶è®°å½•æ–¹æ³•ï¼š

```typescript
// æ–¹å¼ 1ï¼šä½¿ç”¨ withTiming åŒ…è£…å¼‚æ­¥æ“ä½œ
const result = await logger.withTiming(
  "TaskRunner",
  "æ‰§è¡Œä»»åŠ¡",
  async () => {
    return await executeTask(task);
  }
);
// è‡ªåŠ¨è®°å½•ï¼šæ‰§è¡Œä»»åŠ¡ å®Œæˆ (1234ms)

// æ–¹å¼ 2ï¼šæ‰‹åŠ¨è®°å½•è€—æ—¶
const startTime = Date.now();
const result = await executeTask(task);
const duration = Date.now() - startTime;
logger.timing("TaskRunner", "æ‰§è¡Œä»»åŠ¡", duration, {
  taskId: task.id
});
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œæ—¥å¿—æ ¼å¼åŒ–å’Œè¾“å‡º

---

#### å¾ªç¯æ—¥å¿—æœºåˆ¶

ä¸ºé¿å…æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿ï¼Œç³»ç»Ÿå®ç°äº†å¾ªç¯æ—¥å¿—æœºåˆ¶ï¼š

**ç‰¹æ€§**ï¼š
- **æœ€å¤§æ–‡ä»¶å¤§å°**ï¼šé»˜è®¤ 1MBï¼ˆå¯é…ç½®ï¼‰
- **è‡ªåŠ¨æ¸…ç†**ï¼šå½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡æœ€å¤§å¤§å°æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æœ€æ—§çš„æ—¥å¿—æ¡ç›®
- **ä¿ç•™æœ€æ–°æ—¥å¿—**ï¼šç¡®ä¿æœ€æ–°çš„æ—¥å¿—å§‹ç»ˆå¯ç”¨

**å·¥ä½œåŸç†**ï¼š

```typescript
class Logger {
  private logBuffer: string[] = [];
  private currentSize = 0;
  private readonly maxLogSize = 1024 * 1024; // 1MB
  
  private log(entry: LogEntry): void {
    const logLine = this.formatLogEntry(entry, this.fileFormat);
    const logLineSize = new TextEncoder().encode(logLine + "\n").length;
    
    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å¤§å°
    if (this.currentSize + logLineSize > this.maxLogSize) {
      this.rotateLog(logLineSize);
    }
    
    // æ·»åŠ æ–°æ—¥å¿—
    this.logBuffer.push(logLine);
    this.currentSize += logLineSize;
    
    // å¼‚æ­¥å†™å…¥æ–‡ä»¶
    this.writeToFile();
  }
  
  private rotateLog(newEntrySize: number): void {
    const targetSize = this.maxLogSize - newEntrySize;
    
    // åˆ é™¤æœ€æ—§çš„æ—¥å¿—ï¼Œç›´åˆ°å¤§å°ä½äºç›®æ ‡å€¼
    while (this.logBuffer.length > 0 && this.currentSize > targetSize) {
      const removedLine = this.logBuffer.shift();
      if (removedLine) {
        const removedSize = new TextEncoder().encode(removedLine + "\n").length;
        this.currentSize -= removedSize;
      }
    }
  }
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œå¾ªç¯æ—¥å¿—æœºåˆ¶

---

#### ä¼šè¯åˆ†éš”

ç³»ç»Ÿåœ¨æ¯æ¬¡å¯åŠ¨æ—¶ä¼šåœ¨æ—¥å¿—ä¸­æ·»åŠ ä¼šè¯åˆ†éš”æ ‡è®°ï¼Œä¾¿äºåŒºåˆ†ä¸åŒçš„è¿è¡Œä¼šè¯ï¼š

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
2025-12-10 10:30:00 â„¹ï¸ [Session] æ–°ä¼šè¯å¼€å§‹ [20251210-103000-abc1]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ä¼šè¯ ID æ ¼å¼**ï¼š`YYYYMMDD-HHMMSS-XXXX`
- `YYYYMMDD`ï¼šæ—¥æœŸ
- `HHMMSS`ï¼šæ—¶é—´
- `XXXX`ï¼šéšæœºå­—ç¬¦ä¸²

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œè¿½è¸ª ID ç”Ÿæˆ

---

#### æ—¥å¿—æŸ¥è¯¢å’Œè¿‡æ»¤

ç³»ç»Ÿæä¾›äº†ä¸°å¯Œçš„æ—¥å¿—æŸ¥è¯¢å’Œè¿‡æ»¤æ–¹æ³•ï¼š

```typescript
// æŒ‰çº§åˆ«è¿‡æ»¤
const errors = logger.filterByLevel("error");

// æŒ‰æ¨¡å—è¿‡æ»¤
const taskQueueLogs = logger.filterByModule("TaskQueue");

// æŒ‰è¿½è¸ª ID è¿‡æ»¤
const traceLogs = logger.filterByTraceId("abc123-def456");

// æŒ‰äº‹ä»¶ç±»å‹è¿‡æ»¤
const taskStateLogs = logger.filterByEvent("TASK_STATE_CHANGE");

// æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
const recentLogs = logger.filterByTimeRange(
  new Date("2025-12-10T10:00:00Z"),
  new Date("2025-12-10T11:00:00Z")
);

// æœç´¢æ—¥å¿—æ¶ˆæ¯
const searchResults = logger.search("API è°ƒç”¨å¤±è´¥");

// è·å–æœ€è¿‘ N æ¡æ—¥å¿—
const recent100 = logger.getRecentEntries(100);

// è·å–é”™è¯¯æ‘˜è¦
const errorSummary = logger.getErrorSummary();
// {
//   count: 5,
//   byModule: { "TaskRunner": 3, "ProviderManager": 2 },
//   byCode: { "E001": 2, "E100": 3 }
// }
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/data/logger.ts`ï¼šLogger å®ç°ï¼Œæ—¥å¿—æŒä¹…åŒ–å’Œè¯»å–

---

#### æ—¥å¿—é…ç½®

æ—¥å¿—ç³»ç»Ÿçš„è¡Œä¸ºå¯ä»¥é€šè¿‡æ’ä»¶è®¾ç½®è¿›è¡Œé…ç½®ï¼š

```typescript
interface PluginSettings {
  /** æ—¥å¿—çº§åˆ« */
  logLevel: "debug" | "info" | "warn" | "error";
  
  /** æ—¥å¿—æ ¼å¼ */
  logFormat: "json" | "pretty" | "compact";
}

// é»˜è®¤é…ç½®
const DEFAULT_SETTINGS: PluginSettings = {
  logLevel: "info",
  logFormat: "json",
};
```

**åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«**ï¼š

```typescript
// åœ¨è®¾ç½®é¢æ¿ä¸­è°ƒæ•´æ—¥å¿—çº§åˆ«
logger.setLogLevel("debug"); // å¯ç”¨è°ƒè¯•æ—¥å¿—

// åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ info çº§åˆ«
logger.setLogLevel("info"); // åªè®°å½• infoã€warnã€error
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/types.ts`ï¼šPluginSettings æ¥å£å®šä¹‰
- `src/data/logger.ts`ï¼šLogger å®Œæ•´å®ç°
- `main.ts`ï¼šæ’ä»¶ä¸»ç±»ï¼Œæ—¥å¿—çº§åˆ«åŒæ­¥é€»è¾‘

---

#### æ—¥å¿—æœ€ä½³å®è·µ

**1. ä½¿ç”¨åˆé€‚çš„æ—¥å¿—çº§åˆ«**

```typescript
// âœ… å¥½çš„åšæ³•
logger.debug("TaskQueue", "ä»»åŠ¡å…¥é˜Ÿ", { taskId: "task-123" }); // è°ƒè¯•ä¿¡æ¯
logger.info("FileStorage", "æ–‡ä»¶å†™å…¥æˆåŠŸ", { path: "..." }); // æ­£å¸¸äº‹ä»¶
logger.warn("TaskQueue", "ä»»åŠ¡é‡è¯•", { attempt: 2 }); // æ½œåœ¨é—®é¢˜
logger.error("ProviderManager", "API è°ƒç”¨å¤±è´¥", error); // é”™è¯¯

// âŒ ä¸å¥½çš„åšæ³•
logger.info("TaskQueue", "ä»»åŠ¡å…¥é˜Ÿ", { taskId: "task-123" }); // åº”è¯¥ç”¨ debug
logger.error("FileStorage", "æ–‡ä»¶å†™å…¥æˆåŠŸ", { path: "..." }); // åº”è¯¥ç”¨ info
```

**2. æä¾›ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯**

```typescript
// âœ… å¥½çš„åšæ³•
logger.error("TaskRunner", "ä»»åŠ¡æ‰§è¡Œå¤±è´¥", error, {
  event: "TASK_FAILED",
  taskId: "task-123",
  taskType: "embedding",
  nodeId: "node-456",
  attempt: 2,
  maxAttempts: 3,
  errorCode: "E001"
});

// âŒ ä¸å¥½çš„åšæ³•
logger.error("TaskRunner", "ä»»åŠ¡æ‰§è¡Œå¤±è´¥", error);
```

**3. ä½¿ç”¨äº‹ä»¶ç±»å‹æ ‡è¯†æ—¥å¿—**

```typescript
// âœ… å¥½çš„åšæ³•
logger.info("TaskQueue", "ä»»åŠ¡çŠ¶æ€å˜æ›´", {
  event: "TASK_STATE_CHANGE",
  taskId: "task-123",
  oldState: "Pending",
  newState: "Running"
});

// âŒ ä¸å¥½çš„åšæ³•
logger.info("TaskQueue", "ä»»åŠ¡çŠ¶æ€å˜æ›´", {
  taskId: "task-123",
  oldState: "Pending",
  newState: "Running"
});
```

**4. ä½¿ç”¨è¿½è¸ª ID å…³è”ç›¸å…³æ—¥å¿—**

```typescript
// âœ… å¥½çš„åšæ³•
const traceId = logger.startTrace("æ¦‚å¿µåˆ›å»ºæµç¨‹");
// ... æ‰§è¡Œæ“ä½œ
logger.endTrace("æ¦‚å¿µåˆ›å»ºæµç¨‹");

// âŒ ä¸å¥½çš„åšæ³•
logger.info("Step 1", "æ ‡å‡†åŒ–");
logger.info("Step 2", "ç”ŸæˆåµŒå…¥");
// æ— æ³•å…³è”è¿™äº›æ—¥å¿—
```

**5. é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯**

```typescript
// âœ… å¥½çš„åšæ³•
logger.info("ProviderManager", "API è°ƒç”¨æˆåŠŸ", {
  provider: "openai",
  model: "gpt-4o"
});

// âŒ ä¸å¥½çš„åšæ³•
logger.info("ProviderManager", "API è°ƒç”¨æˆåŠŸ", {
  provider: "openai",
  apiKey: "sk-..." // ä¸è¦è®°å½• API Key
});
```

**å‚è€ƒæ–‡æ¡£**ï¼š
- `src/data/logger.ts`ï¼šLogger å®Œæ•´å®ç°
- `src/data/error-codes.ts`ï¼šé”™è¯¯ç å®šä¹‰

### 9.5 ç”¨æˆ·é€šçŸ¥

Cognitive Razor ä½¿ç”¨ Obsidian çš„ `Notice` ç»„ä»¶å‘ç”¨æˆ·æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯ã€‚é€šçŸ¥ç³»ç»Ÿéµå¾ª"é€æ˜åŸç†"ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤ŸåŠæ—¶äº†è§£ç³»ç»ŸçŠ¶æ€ã€æ“ä½œç»“æœå’Œé”™è¯¯ä¿¡æ¯ã€‚

#### é€šçŸ¥ç±»å‹

ç³»ç»Ÿæ ¹æ®æ¶ˆæ¯çš„æ€§è´¨å’Œä¸¥é‡ç¨‹åº¦ï¼Œå°†é€šçŸ¥åˆ†ä¸ºä¸‰ç±»ï¼š

| é€šçŸ¥ç±»å‹ | ç”¨é€” | æŒç»­æ—¶é—´ | ç¤ºä¾‹ |
|---------|------|---------|------|
| **æˆåŠŸé€šçŸ¥** | æ“ä½œæˆåŠŸå®Œæˆ | 3-5 ç§’ | "æ¦‚å¿µåˆ›å»ºæˆåŠŸ"ã€"æ–‡ä»¶å†™å…¥æˆåŠŸ" |
| **è­¦å‘Šé€šçŸ¥** | æ½œåœ¨é—®é¢˜æˆ–éœ€è¦æ³¨æ„çš„æƒ…å†µ | 5-8 ç§’ | "æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ"ã€"ç£ç›˜ç©ºé—´ä¸è¶³" |
| **é”™è¯¯é€šçŸ¥** | æ“ä½œå¤±è´¥æˆ–å‘ç”Ÿé”™è¯¯ | 8-10 ç§’ | "API è°ƒç”¨å¤±è´¥"ã€"æ–‡ä»¶å†™å…¥å¤±è´¥" |

**æŒç»­æ—¶é—´è¯´æ˜**ï¼š
- æˆåŠŸé€šçŸ¥ï¼šç”¨æˆ·é€šå¸¸åªéœ€è¦å¿«é€Ÿç¡®è®¤ï¼Œ3-5 ç§’è¶³å¤Ÿ
- è­¦å‘Šé€šçŸ¥ï¼šéœ€è¦ç”¨æˆ·æ³¨æ„ï¼Œä½†ä¸ç´§æ€¥ï¼Œ5-8 ç§’
- é”™è¯¯é€šçŸ¥ï¼šéœ€è¦ç”¨æˆ·é‡‡å–è¡ŒåŠ¨ï¼ŒæŒç»­æ—¶é—´è¾ƒé•¿ï¼Œ8-10 ç§’

---

#### ä½•æ—¶æ˜¾ç¤ºé€šçŸ¥

**1. æˆåŠŸé€šçŸ¥**

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ˜¾ç¤ºæˆåŠŸé€šçŸ¥ï¼š

- **æ¦‚å¿µåˆ›å»ºæˆåŠŸ**ï¼šç”¨æˆ·ç¡®è®¤åˆ›å»ºæ¦‚å¿µåï¼Œæ˜¾ç¤º"æ¦‚å¿µåˆ›å»ºæˆåŠŸ"
- **æ–‡ä»¶å†™å…¥æˆåŠŸ**ï¼šé‡è¦çš„æ–‡ä»¶å†™å…¥æ“ä½œå®Œæˆåï¼ˆå¦‚å¿«ç…§æ¢å¤ï¼‰
- **åˆå¹¶å®Œæˆ**ï¼šé‡å¤æ¦‚å¿µåˆå¹¶å®Œæˆå
- **æ’¤é”€æˆåŠŸ**ï¼šå¿«ç…§æ¢å¤æˆåŠŸå

**ç¤ºä¾‹**ï¼š

```typescript
// æ¦‚å¿µåˆ›å»ºæˆåŠŸ
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸï¼šè®¡ç®—æœºç§‘å­¦", 3000);

// å¿«ç…§æ¢å¤æˆåŠŸ
new Notice("å¿«ç…§æ¢å¤æˆåŠŸ", 3000);

// åˆå¹¶å®Œæˆ
new Notice("é‡å¤æ¦‚å¿µåˆå¹¶å®Œæˆ", 3000);
```

**2. è­¦å‘Šé€šçŸ¥**

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ˜¾ç¤ºè­¦å‘Šé€šçŸ¥ï¼š

- **æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ**ï¼šç›¸ä¼¼åº¦è¶…è¿‡é˜ˆå€¼ï¼Œæç¤ºç”¨æˆ·å†³ç­–
- **é‡è¯•æ¬¡æ•°æ¥è¿‘ä¸Šé™**ï¼šä»»åŠ¡é‡è¯•æ¬¡æ•°æ¥è¿‘æœ€å¤§å€¼
- **ç£ç›˜ç©ºé—´ä¸è¶³**ï¼šç£ç›˜ç©ºé—´ä½äºé˜ˆå€¼
- **API å“åº”æ…¢**ï¼šAPI å“åº”æ—¶é—´è¶…è¿‡é¢„æœŸ
- **é˜Ÿåˆ—ä»»åŠ¡è¿‡å¤š**ï¼šé˜Ÿåˆ—ä¸­å¾…å¤„ç†ä»»åŠ¡æ•°é‡è¿‡å¤š

**ç¤ºä¾‹**ï¼š

```typescript
// æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ
new Notice("æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µï¼Œè¯·å‰å¾€é‡å¤é¢æ¿å¤„ç†", 5000);

// ç£ç›˜ç©ºé—´ä¸è¶³
new Notice("ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æ–‡ä»¶", 5000);

// é˜Ÿåˆ—ä»»åŠ¡è¿‡å¤š
new Notice("é˜Ÿåˆ—ä¸­æœ‰ 50 ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´", 5000);
```

**3. é”™è¯¯é€šçŸ¥**

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ˜¾ç¤ºé”™è¯¯é€šçŸ¥ï¼š

- **ä»»åŠ¡å¤±è´¥**ï¼šä»»åŠ¡é‡è¯•è€—å°½åä»ç„¶å¤±è´¥
- **API è°ƒç”¨å¤±è´¥**ï¼šAPI è°ƒç”¨å¤±è´¥ä¸”æ— æ³•é‡è¯•ï¼ˆå¦‚è®¤è¯é”™è¯¯ï¼‰
- **æ–‡ä»¶æ“ä½œå¤±è´¥**ï¼šæ–‡ä»¶è¯»å†™å¤±è´¥
- **ç´¢å¼•æŸå**ï¼šå‘é‡ç´¢å¼•æŸå
- **é…ç½®é”™è¯¯**ï¼šProvider é…ç½®é”™è¯¯

**ç¤ºä¾‹**ï¼š

```typescript
// è®¤è¯å¤±è´¥
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Key", 8000);

// æ–‡ä»¶å†™å…¥å¤±è´¥
new Notice("æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´", 8000);

// ç´¢å¼•æŸå
new Notice("å‘é‡ç´¢å¼•å¯èƒ½å·²æŸåï¼Œè¯·å°è¯•é‡å»ºç´¢å¼•", 8000);
```

---

#### é€šçŸ¥å†…å®¹è§„èŒƒ

é€šçŸ¥å†…å®¹åº”éµå¾ªä»¥ä¸‹è§„èŒƒï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿå¿«é€Ÿç†è§£å¹¶é‡‡å–è¡ŒåŠ¨ï¼š

**1. ç®€æ´æ˜ç¡®**

é€šçŸ¥æ¶ˆæ¯åº”ç®€æ´æ˜äº†ï¼Œé¿å…å†—é•¿çš„æè¿°ï¼š

```typescript
// âœ… å¥½çš„åšæ³•
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸ", 3000);

// âŒ ä¸å¥½çš„åšæ³•
new Notice("æ‚¨çš„æ¦‚å¿µå·²ç»æˆåŠŸåˆ›å»ºå¹¶ä¿å­˜åˆ°çŸ¥è¯†åº“ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­æŸ¥çœ‹", 3000);
```

**2. å¯æ“ä½œæ€§**

å¯¹äºé”™è¯¯å’Œè­¦å‘Šé€šçŸ¥ï¼Œåº”æä¾›æ˜ç¡®çš„è§£å†³æ–¹æ¡ˆæˆ–ä¸‹ä¸€æ­¥æ“ä½œï¼š

```typescript
// âœ… å¥½çš„åšæ³•
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Key", 8000);

// âŒ ä¸å¥½çš„åšæ³•
new Notice("è®¤è¯å¤±è´¥", 8000);
```

**3. é¿å…æŠ€æœ¯æœ¯è¯­**

é€šçŸ¥æ¶ˆæ¯åº”ä½¿ç”¨ç”¨æˆ·å‹å¥½çš„è¯­è¨€ï¼Œé¿å…æŠ€æœ¯æœ¯è¯­ï¼š

```typescript
// âœ… å¥½çš„åšæ³•
new Notice("API è°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•", 5000);

// âŒ ä¸å¥½çš„åšæ³•
new Notice("Provider è¿”å› 429 çŠ¶æ€ç ï¼Œè§¦å‘é€Ÿç‡é™åˆ¶", 5000);
```

**4. æä¾›ä¸Šä¸‹æ–‡**

å¯¹äºé‡è¦çš„é€šçŸ¥ï¼Œåº”æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š

```typescript
// âœ… å¥½çš„åšæ³•
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸï¼šè®¡ç®—æœºç§‘å­¦", 3000);

// âŒ ä¸å¥½çš„åšæ³•
new Notice("åˆ›å»ºæˆåŠŸ", 3000);
```

---

#### é”™è¯¯ç åˆ°ç”¨æˆ·æ¶ˆæ¯çš„è½¬æ¢

ç³»ç»Ÿæä¾›äº† `getUserFriendlyMessage` å‡½æ•°ï¼Œå°†é”™è¯¯ç è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æ¶ˆæ¯ï¼š

```typescript
function getUserFriendlyMessage(error: Err): string {
  const code = error.error.code;
  const classification = classifyError(code);

  switch (classification.category) {
    case "AUTH_ERROR":
      return "è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®é…ç½®ã€‚";

    case "NETWORK_ERROR":
      if (code === "E102") {
        return "API é€Ÿç‡é™åˆ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•ã€‚";
      }
      if (code === "E101") {
        return "è¯·æ±‚è¶…æ—¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•ã€‚";
      }
      return "API è°ƒç”¨å¤±è´¥ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•ã€‚";

    case "CAPABILITY_ERROR":
      return "Provider ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·æ›´æ¢ Provider æˆ–æ£€æŸ¥é…ç½®ã€‚";

    case "CONTENT_ERROR":
      return "AI è¾“å‡ºæ ¼å¼é”™è¯¯ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•ã€‚";

    case "FILE_SYSTEM_ERROR":
      return "æ–‡ä»¶ç³»ç»Ÿæ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç£ç›˜ç©ºé—´ã€‚";

    default:
      return error.error.message;
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// åœ¨ UI å±‚å¤„ç†é”™è¯¯
const result = await createConcept(description);
if (!result.ok) {
  const userMessage = getUserFriendlyMessage(result);
  new Notice(userMessage, 8000);
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé”™è¯¯æ¶ˆæ¯è½¬æ¢

---

#### é€šçŸ¥æ˜¾ç¤ºæ—¶æœº

**1. ç«‹å³æ˜¾ç¤º**

å¯¹äºéœ€è¦ç”¨æˆ·ç«‹å³çŸ¥æ™“çš„ä¿¡æ¯ï¼Œåº”ç«‹å³æ˜¾ç¤ºé€šçŸ¥ï¼š

- æ“ä½œæˆåŠŸå®Œæˆ
- æ“ä½œå¤±è´¥ä¸”æ— æ³•é‡è¯•
- æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ

```typescript
// æ“ä½œæˆåŠŸåç«‹å³æ˜¾ç¤º
const result = await createConcept(description);
if (result.ok) {
  new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸ", 3000);
}
```

**2. å»¶è¿Ÿæ˜¾ç¤º**

å¯¹äºå¯èƒ½é¢‘ç¹å‘ç”Ÿçš„äº‹ä»¶ï¼Œåº”é¿å…è¿‡å¤šé€šçŸ¥å¹²æ‰°ç”¨æˆ·ï¼š

- ä»»åŠ¡é‡è¯•ï¼ˆä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œä»…è®°å½•æ—¥å¿—ï¼‰
- é˜Ÿåˆ—çŠ¶æ€æ›´æ–°ï¼ˆä¸æ˜¾ç¤ºé€šçŸ¥ï¼Œä»…æ›´æ–° UIï¼‰
- æ–‡ä»¶è‡ªåŠ¨ä¿å­˜ï¼ˆä¸æ˜¾ç¤ºé€šçŸ¥ï¼‰

```typescript
// ä»»åŠ¡é‡è¯•æ—¶ä¸æ˜¾ç¤ºé€šçŸ¥
logger.warn("TaskQueue", "ä»»åŠ¡é‡è¯•", {
  event: "TASK_RETRY",
  taskId: "task-123",
  attempt: 2
});
// ä¸æ˜¾ç¤º Notice
```

**3. æ‰¹é‡æ˜¾ç¤º**

å¯¹äºæ‰¹é‡æ“ä½œï¼Œåº”åœ¨æ“ä½œå®Œæˆåæ˜¾ç¤ºæ±‡æ€»é€šçŸ¥ï¼Œè€Œéæ¯ä¸ªæ“ä½œéƒ½æ˜¾ç¤ºï¼š

```typescript
// âœ… å¥½çš„åšæ³•ï¼šæ‰¹é‡æ“ä½œå®Œæˆåæ˜¾ç¤ºæ±‡æ€»
const results = await Promise.all(tasks.map(task => executeTask(task)));
const successCount = results.filter(r => r.ok).length;
const failureCount = results.length - successCount;
new Notice(`æ‰¹é‡æ“ä½œå®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œå¤±è´¥ ${failureCount}`, 5000);

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯ä¸ªæ“ä½œéƒ½æ˜¾ç¤ºé€šçŸ¥
for (const task of tasks) {
  const result = await executeTask(task);
  if (result.ok) {
    new Notice("ä»»åŠ¡æˆåŠŸ", 3000); // ä¼šæ˜¾ç¤ºå¾ˆå¤šé€šçŸ¥
  }
}
```

---

#### é€šçŸ¥ä¸æ—¥å¿—çš„å…³ç³»

é€šçŸ¥å’Œæ—¥å¿—æ˜¯äº’è¡¥çš„ï¼Œä½†æœ‰ä¸åŒçš„ç”¨é€”ï¼š

| ç‰¹æ€§ | é€šçŸ¥ï¼ˆNoticeï¼‰ | æ—¥å¿—ï¼ˆLoggerï¼‰ |
|------|---------------|---------------|
| **ç›®æ ‡å—ä¼—** | ç”¨æˆ· | å¼€å‘è€… |
| **å†…å®¹** | ç®€æ´ã€ç”¨æˆ·å‹å¥½ | è¯¦ç»†ã€æŠ€æœ¯æ€§ |
| **æŒä¹…æ€§** | ä¸´æ—¶æ˜¾ç¤º | æ°¸ä¹…ä¿å­˜ |
| **ç”¨é€”** | å‘ŠçŸ¥ç”¨æˆ·æ“ä½œç»“æœ | è®°å½•ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ |
| **é¢‘ç‡** | ä½é¢‘ï¼Œä»…é‡è¦äº‹ä»¶ | é«˜é¢‘ï¼Œæ‰€æœ‰äº‹ä»¶ |

**æœ€ä½³å®è·µ**ï¼š

```typescript
// åŒæ—¶è®°å½•æ—¥å¿—å’Œæ˜¾ç¤ºé€šçŸ¥
const result = await createConcept(description);
if (!result.ok) {
  // è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
  logger.error("PipelineOrchestrator", "æ¦‚å¿µåˆ›å»ºå¤±è´¥", undefined, {
    event: "CONCEPT_CREATE_FAILED",
    errorCode: result.error.code,
    errorMessage: result.error.message,
    description
  });
  
  // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é€šçŸ¥
  const userMessage = getUserFriendlyMessage(result);
  new Notice(userMessage, 8000);
}
```

---

#### é€šçŸ¥ç¤ºä¾‹

**æˆåŠŸé€šçŸ¥ç¤ºä¾‹**ï¼š

```typescript
// æ¦‚å¿µåˆ›å»ºæˆåŠŸ
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸï¼šè®¡ç®—æœºç§‘å­¦", 3000);

// å¿«ç…§æ¢å¤æˆåŠŸ
new Notice("å¿«ç…§æ¢å¤æˆåŠŸ", 3000);

// è®¾ç½®ä¿å­˜æˆåŠŸ
new Notice("è®¾ç½®å·²ä¿å­˜", 3000);

// é‡å¤æ¦‚å¿µåˆå¹¶æˆåŠŸ
new Notice("é‡å¤æ¦‚å¿µåˆå¹¶å®Œæˆ", 3000);
```

**è­¦å‘Šé€šçŸ¥ç¤ºä¾‹**ï¼š

```typescript
// æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ
new Notice("æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µï¼Œè¯·å‰å¾€é‡å¤é¢æ¿å¤„ç†", 5000);

// ç£ç›˜ç©ºé—´ä¸è¶³
new Notice("ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æ–‡ä»¶", 5000);

// é˜Ÿåˆ—ä»»åŠ¡è¿‡å¤š
new Notice("é˜Ÿåˆ—ä¸­æœ‰ 50 ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´", 5000);

// API å“åº”æ…¢
new Notice("API å“åº”è¾ƒæ…¢ï¼Œè¯·è€å¿ƒç­‰å¾…", 5000);
```

**é”™è¯¯é€šçŸ¥ç¤ºä¾‹**ï¼š

```typescript
// è®¤è¯å¤±è´¥
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Key", 8000);

// æ–‡ä»¶å†™å…¥å¤±è´¥
new Notice("æ–‡ä»¶å†™å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†™å…¥æƒé™å’Œç£ç›˜ç©ºé—´", 8000);

// ç´¢å¼•æŸå
new Notice("å‘é‡ç´¢å¼•å¯èƒ½å·²æŸåï¼Œè¯·å°è¯•é‡å»ºç´¢å¼•", 8000);

// Provider ä¸å­˜åœ¨
new Notice("Provider é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥è®¾ç½®", 8000);

// ä»»åŠ¡è¶…æ—¶
new Notice("ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œå·²è‡ªåŠ¨å–æ¶ˆ", 8000);
```

---

#### é€šçŸ¥æœ€ä½³å®è·µ

**1. é¿å…è¿‡å¤šé€šçŸ¥**

```typescript
// âœ… å¥½çš„åšæ³•ï¼šä»…åœ¨é‡è¦äº‹ä»¶æ—¶æ˜¾ç¤ºé€šçŸ¥
if (result.ok) {
  new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸ", 3000);
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æ˜¾ç¤ºé€šçŸ¥
new Notice("å¼€å§‹æ ‡å‡†åŒ–", 3000);
new Notice("æ ‡å‡†åŒ–å®Œæˆ", 3000);
new Notice("å¼€å§‹ç”ŸæˆåµŒå…¥", 3000);
new Notice("åµŒå…¥ç”Ÿæˆå®Œæˆ", 3000);
// ...
```

**2. ä½¿ç”¨åˆé€‚çš„æŒç»­æ—¶é—´**

```typescript
// âœ… å¥½çš„åšæ³•ï¼šæ ¹æ®æ¶ˆæ¯é‡è¦æ€§è°ƒæ•´æŒç»­æ—¶é—´
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸ", 3000); // æˆåŠŸæ¶ˆæ¯ï¼Œ3 ç§’
new Notice("æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ", 5000); // è­¦å‘Šæ¶ˆæ¯ï¼Œ5 ç§’
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key", 8000); // é”™è¯¯æ¶ˆæ¯ï¼Œ8 ç§’

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½ä½¿ç”¨ç›¸åŒçš„æŒç»­æ—¶é—´
new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸ", 5000);
new Notice("æ£€æµ‹åˆ°é‡å¤æ¦‚å¿µ", 5000);
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key", 5000);
```

**3. æä¾›å¯æ“ä½œçš„ä¿¡æ¯**

```typescript
// âœ… å¥½çš„åšæ³•ï¼šå‘Šè¯‰ç”¨æˆ·å¦‚ä½•è§£å†³é—®é¢˜
new Notice("è®¤è¯å¤±è´¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢æ£€æŸ¥å¹¶æ›´æ–° API Key", 8000);

// âŒ ä¸å¥½çš„åšæ³•ï¼šåªå‘Šè¯‰ç”¨æˆ·å‡ºé”™äº†
new Notice("è®¤è¯å¤±è´¥", 8000);
```

**4. é¿å…æŠ€æœ¯æœ¯è¯­**

```typescript
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ç”¨æˆ·å‹å¥½çš„è¯­è¨€
new Notice("API è°ƒç”¨å¤±è´¥ï¼Œè¯·ç¨åå†è¯•", 5000);

// âŒ ä¸å¥½çš„åšæ³•ï¼šä½¿ç”¨æŠ€æœ¯æœ¯è¯­
new Notice("Provider è¿”å› 429 çŠ¶æ€ç ï¼Œè§¦å‘é€Ÿç‡é™åˆ¶", 5000);
```

**5. æ‰¹é‡æ“ä½œä½¿ç”¨æ±‡æ€»é€šçŸ¥**

```typescript
// âœ… å¥½çš„åšæ³•ï¼šæ˜¾ç¤ºæ±‡æ€»é€šçŸ¥
new Notice(`æ‰¹é‡æ“ä½œå®Œæˆï¼šæˆåŠŸ ${successCount}ï¼Œå¤±è´¥ ${failureCount}`, 5000);

// âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯ä¸ªæ“ä½œéƒ½æ˜¾ç¤ºé€šçŸ¥
for (const result of results) {
  if (result.ok) {
    new Notice("æ“ä½œæˆåŠŸ", 3000);
  }
}
```

---

#### é€šçŸ¥ä¸ UI æ›´æ–°çš„åè°ƒ

é€šçŸ¥å’Œ UI æ›´æ–°åº”è¯¥åè°ƒä¸€è‡´ï¼Œé¿å…ä¿¡æ¯ä¸ä¸€è‡´ï¼š

```typescript
// æ¦‚å¿µåˆ›å»ºæˆåŠŸå
const result = await createConcept(description);
if (result.ok) {
  // 1. æ˜¾ç¤ºé€šçŸ¥
  new Notice("æ¦‚å¿µåˆ›å»ºæˆåŠŸï¼šè®¡ç®—æœºç§‘å­¦", 3000);
  
  // 2. æ›´æ–° UI
  workbenchPanel.updateRecentOperations();
  workbenchPanel.clearInput();
  
  // 3. æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
  statusBadge.updateStatus();
}
```

**å‚è€ƒæ–‡ä»¶**ï¼š
- `src/ui/workbench-panel.ts`ï¼šWorkbenchPanel å®Œæ•´å®ç°
- `src/core/retry-handler.ts`ï¼šRetryHandler å®ç°ï¼Œé”™è¯¯æ¶ˆæ¯è½¬æ¢
- `src/core/i18n.ts`ï¼šI18n å®ç°ï¼Œå¤šè¯­è¨€æ”¯æŒ

---

#### æ€»ç»“

ç”¨æˆ·é€šçŸ¥ç³»ç»Ÿéµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **é€æ˜æ€§**ï¼šåŠæ—¶å‘ŠçŸ¥ç”¨æˆ·æ“ä½œç»“æœå’Œç³»ç»ŸçŠ¶æ€
2. **ç®€æ´æ€§**ï¼šæ¶ˆæ¯ç®€æ´æ˜äº†ï¼Œé¿å…å†—é•¿æè¿°
3. **å¯æ“ä½œæ€§**ï¼šæä¾›æ˜ç¡®çš„è§£å†³æ–¹æ¡ˆæˆ–ä¸‹ä¸€æ­¥æ“ä½œ
4. **ç”¨æˆ·å‹å¥½**ï¼šä½¿ç”¨ç”¨æˆ·å‹å¥½çš„è¯­è¨€ï¼Œé¿å…æŠ€æœ¯æœ¯è¯­
5. **é€‚åº¦æ€§**ï¼šé¿å…è¿‡å¤šé€šçŸ¥å¹²æ‰°ç”¨æˆ·

é€šè¿‡åˆç†ä½¿ç”¨é€šçŸ¥ç³»ç»Ÿï¼ŒCognitive Razor ç¡®ä¿ç”¨æˆ·å§‹ç»ˆäº†è§£ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ï¼Œå¹¶èƒ½å¤ŸåŠæ—¶é‡‡å–å¿…è¦çš„è¡ŒåŠ¨ã€‚
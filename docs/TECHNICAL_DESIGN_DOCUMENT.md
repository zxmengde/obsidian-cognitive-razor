# Cognitive Razor â€” æŠ€æœ¯è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-12-18
**çŠ¶æ€**: è®¾è®¡åŸºçº¿ï¼ˆDesign SSOTï¼‰

## 0. æ„¿æ™¯ä¸ SSOT å®ˆåˆ™
- **æ„¿æ™¯**ï¼šæ‰“é€ ä¸ªäººçŸ¥è¯†å›¾è°±çš„â€œè®¤çŸ¥å‰ƒåˆ€â€ã€‚åˆ©ç”¨ AI å°†æ¨¡ç³Šçš„çŸ¥è¯†ã€æƒ³æ³•è½¬åŒ–ä¸ºç»“æ„åŒ–ã€å¯å¤ç”¨ã€å¯æ¼”è¿›çš„çŸ¥è¯†èŠ‚ç‚¹ï¼ˆStructured Nodesï¼‰ï¼Œå¸®åŠ©ç”¨æˆ·æ„å»ºä¸“å±çš„å¤–éƒ¨ç¬¬äºŒå¤§è„‘ã€‚
- **è®¾è®¡åŸºçº¿ï¼ˆDesign SSOTï¼‰å®ˆåˆ™**ï¼š
  - æœ¬æ–‡æ¡£å®šä¹‰â€œæœ¯è¯­ã€æ•°æ®å¥‘çº¦ã€ä¸å˜é‡ã€äº¤äº’è¯­ä¹‰â€çš„åŸºçº¿ï¼Œå¹¶ä¸å½“å‰å®ç°ä¿æŒä¸€è‡´ã€‚
  - æœ¬æ¬¡ä¿®è®¢ä»¥å½“å‰ä»£ç å®ç°ä¸ºå‡†åŒæ­¥æ–‡æ¡£ï¼›åç»­éœ€æ±‚å˜æ›´éœ€å…ˆæ›´æ–°æœ¬æ–‡æ¡£ï¼Œå†åŒæ­¥å®ç°ä¸æµ‹è¯•ï¼Œé¿å…é•¿æœŸæ¼‚ç§»ã€‚
- **SSOT æƒå¨ç´¢å¼•ï¼ˆé˜²æ¼‚ç§»/å»æ­§ä¹‰ï¼‰**ï¼š
  - **ç±»å‹/æšä¸¾/é»˜è®¤å€¼**ï¼š`src/types.ts` ä¸ `src/data/settings-store.ts`ã€‚
  - **Prompt æ§½ä½ä¸æ¨¡æ¿**ï¼š`src/core/prompt-manager.ts` ä¸ `prompts/`ã€‚
  - **JSON Schema ä¸æ¸²æŸ“é¡ºåº**ï¼š`src/core/schema-registry.ts` ä¸ `src/core/content-renderer.ts`ã€‚
  - **æ•°æ®æ–‡ä»¶æ ¼å¼/è·¯å¾„**ï¼š`src/data/file-storage.ts` + å„ `src/core/*-store.ts`ã€‚
  - **ç®¡çº¿/é˜Ÿåˆ—/é”è¯­ä¹‰**ï¼š`src/core/pipeline-orchestrator.ts`ã€`src/core/task-queue.ts`ã€`src/core/lock-manager.ts`ã€‚
  - **UI è¡Œä¸ºä¸äº¤äº’**ï¼š`src/ui/**`ã€‚
- **æ ¸å¿ƒåŸåˆ™**ï¼š
  - **SOLID**ï¼šä¿æŒæ¨¡å—çš„é«˜å†…èšä½è€¦åˆï¼Œç‰¹åˆ«æ˜¯ UIã€Coreã€Data ä¸‰å±‚åˆ†ç¦»ã€‚
  - **KISS**ï¼šä¿æŒç³»ç»Ÿç®€å•ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚
  - **DRY**ï¼šé€»è¾‘ä¸å®šä¹‰ä¸é‡å¤ï¼ŒPrompt æ¨¡æ¿å¤ç”¨åŸºç¡€ç»„ä»¶ã€‚
  - **YAGNI**ï¼šä¸å¼€å‘å½“å‰ä¸éœ€è¦çš„åŠŸèƒ½ï¼ˆå¦‚ç§»åŠ¨ç«¯æ”¯æŒã€å®æ—¶åä½œï¼‰ã€‚

## 1. ç³»ç»Ÿè¾¹ç•Œä¸æŠ€æœ¯æ ˆ
- **è¾¹ç•Œ**ï¼š
  - **ä»…æ¡Œé¢ç«¯** (`isDesktopOnly: true`)ã€‚
  - **æœ¬åœ°ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ Obsidian Vault ä¸­ï¼Œä¸ä¾èµ–å¤–éƒ¨æ•°æ®åº“ã€‚
  - **å¼‚æ­¥å¤„ç†**ï¼šAI æ“ä½œä»¥å¼‚æ­¥ä»»åŠ¡ä¸ºä¸»ï¼›Define ä¸ Index/Deduplicate ä¸ºç›´è°ƒï¼ˆä¸å…¥é˜Ÿï¼‰ï¼Œå…¶ä½™é€šè¿‡é˜Ÿåˆ—ç®¡ç†ã€‚
- **æŠ€æœ¯æ ˆ**ï¼š
  - **Dev/Build**: TypeScript 5.7+, Node.js 22+ï¼ˆä»…ç”¨äºæœ¬ä»“åº“æ„å»º/æµ‹è¯•ï¼‰
  - **Runtime**: Obsidian Desktop â‰¥ 1.5.7ï¼ˆElectron è¿è¡Œæ—¶ï¼›æ’ä»¶äº§ç‰©ä¸ºå•æ–‡ä»¶ `main.js`ï¼‰
  - **Build**: esbuild 0.25.x
  - **Test**: Vitest 4.x
  - **AI**: OpenAI-Compatible APIï¼ˆé»˜è®¤ï¼š`gemini-3-flash-preview` / `text-embedding-3-small` / `gemini-3-pro-image-preview`ï¼‰å‚è€ƒï¼šhttps://ai.google.dev/gemini-api/docs/openai

## 2. ç»Ÿä¸€è¯­è¨€ (Ubiquitous Language)
æœ¬ç³»ç»Ÿé‡‡ç”¨ä»¥ä¸‹æœ¯è¯­ä½œä¸ºé€šç”¨è¯­è¨€ï¼Œè´¯ç©¿ UIã€ä»£ç ä¸æ–‡æ¡£ï¼š

### 2.1 æ ¸å¿ƒå¯¹è±¡ (Objects)
| æœ¯è¯­ (Term) | ä»£ç  (Code) | å®šä¹‰ (Definition) |
|---|---|---|
| **æ¦‚å¿µèŠ‚ç‚¹** | `CRFrontmatter` + Markdown æ­£æ–‡ | çŸ¥è¯†å›¾è°±ä¸­çš„åŸå­å•å…ƒï¼ŒåŒ…å« Frontmatter å’Œæ­£æ–‡ã€‚ |
| **cruid** | `cruid` | æ¦‚å¿µçš„å…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦ (UUIDv4)ï¼Œå­—æ®µå°å†™ã€‚ |
| **Domain** | `Domain` | çŸ¥è¯†æ‰€å±çš„èŒƒç•´æˆ–å­¦ç§‘èƒŒæ™¯ã€‚ |
| **Issue** | `Issue` | éœ€è¦è§£å†³çš„éš¾é¢˜ã€ç–‘é—®æˆ–ç ”ç©¶è¯¾é¢˜ã€‚ |
| **Theory** | `Theory` | å¯¹é—®é¢˜çš„è§£é‡Šã€ç†è®ºã€è§‚ç‚¹æˆ–å‡è®¾ã€‚ |
| **Entity** | `Entity` | å…·ä½“çš„å¯¹è±¡ã€äº‹ç‰©æˆ–åè¯æ€§æ¦‚å¿µã€‚ |
| **Mechanism** | `Mechanism` | äº‹ç‰©é—´çš„äº¤äº’æœºåˆ¶ã€æµç¨‹æˆ–åŠ¨æ€æ¼”å˜ã€‚ |

### 2.2 å‰ƒåˆ€æ“ä½œ (Razor Actions)
| æœ¯è¯­ (Term) | ä»£ç  (Code) | å®šä¹‰ (Definition) |
|---|---|---|
| **Define** | `Define` | è¯†åˆ«è¾“å…¥æ‰€å±çš„æ¦‚å¿µç±»å‹ (Domain/Issue/Theory/Entity/Mechanism)ã€‚ |
| **Tag** | `Tag` | ä¸ºæ¦‚å¿µç”Ÿæˆåˆ«åã€æ ‡ç­¾ã€å…³é”®è¯ç­‰å…ƒæ•°æ®ã€‚ |
| **Write** | `Write` | æ ¹æ®æ¦‚å¿µç±»å‹ Schema ç”Ÿæˆç»“æ„åŒ–æ­£æ–‡å†…å®¹ã€‚ |
| **Merge** | `Merge` | å°†ä¸¤ä¸ªè¯­ä¹‰é‡å¤çš„æ¦‚å¿µåˆå¹¶ä¸ºä¸€ä¸ªï¼Œæ¸…ç†ç´¢å¼•ã€‚ |
| **Amend** | `Amend` | å¯¹ç°æœ‰æ¦‚å¿µè¿›è¡Œå¢é‡ä¼˜åŒ–ã€æ¶¦è‰²æˆ–ä¿®æ­£ã€‚ |
| **Expand** | `Expand` | åŸºäºç°æœ‰æ¦‚å¿µå‘ç°ä¸Šä¸‹ä½æˆ–ç›¸å…³çš„æ–°æ¦‚å¿µã€‚ |
| **Visualize** | `Visualize` | ä¸ºæ¦‚å¿µç”Ÿæˆè§†è§‰åŒ–è¡¨è¾¾ï¼ˆé…å›¾ï¼‰ã€‚ |

### 2.3 ç³»ç»Ÿç»„ä»¶
- **å·¥ä½œå° (Workbench)**: ç”¨æˆ·æ“ä½œçš„ä¸»ç•Œé¢ï¼Œå±•ç¤ºç®¡çº¿çŠ¶æ€ã€‚
- **ç®¡çº¿ (Pipeline)**: å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„æµæ°´çº¿ã€‚
- **å¿«ç…§ (Snapshot)**: å˜æ›´å‰çš„çŠ¶æ€å¤‡ä»½ï¼Œç”¨äºå›æ»šã€‚


## 3. æ¶æ„è®¾è®¡ (Architecture)
éµå¾ª Clean Architecture åˆ†å±‚åŸåˆ™ï¼Œç¡®ä¿ä¾èµ–å•å‘æµåŠ¨ï¼Œå®ç°é«˜å†…èšä½è€¦åˆã€‚

### 3.1 åˆ†å±‚ç»“æ„
```mermaid
graph TD
    UI[UI Layer<br/>src/ui] -->|ä¾èµ–| Core[Core Layer<br/>src/core]
    Core -->|ä¾èµ–| Data[Data Layer<br/>src/data]
    
    subgraph UI["UI å±‚ (src/ui)"]
        WB["WorkbenchPanel<br/>å·¥ä½œå°ä¸»ç•Œé¢"]
        M["Modals<br/>å„ç±»äº¤äº’å¼¹çª—"]
        SB["StatusBadge<br/>çŠ¶æ€å¾½ç« "]
    end
    
    subgraph Core["Core å±‚ (src/core)"]
        PO["PipelineOrchestrator<br/>ä»»åŠ¡ç®¡çº¿åè°ƒ"]
        TR["TaskRunner<br/>åŸå­ä»»åŠ¡æ‰§è¡Œ"]
        VI["VectorIndex<br/>å‘é‡æ£€ç´¢"]
        CC["CruidCache<br/>CRUIDæ˜ å°„æº"]
        DM["DuplicateManager<br/>é‡å¤å¯¹ç®¡ç†"]
    end
    
    subgraph Data["Data å±‚ (src/data)"]
        FS["FileStorage<br/>æ–‡ä»¶ç³»ç»Ÿæ“ä½œ"]
        SS["SettingsStore<br/>é…ç½®ç®¡ç†"]
        LOG["Logger<br/>æ—¥å¿—è®°å½•"]
        VAL["Validator<br/>æ•°æ®éªŒè¯"]
    end
```

### 3.2 åˆ†å±‚èŒè´£
- **UI Layer**: å‘ˆç°ä¸äº¤äº’
  - `WorkbenchPanel`: å·¥ä½œå°å®¹å™¨ï¼Œè´Ÿè´£å¸ƒå±€ä¸äº‹ä»¶è®¢é˜…ï¼›å››ä¸ªåŒºåŸŸæ‹†åˆ†ä¸º `src/ui/workbench/*-section.ts`
  - `Modals`: è¾“å…¥ã€ç¡®è®¤ã€Diff é¢„è§ˆç­‰å¼¹çª—
  - `StatusBadge`: æ’ä»¶çŠ¶æ€å¾½ç« 
  
- **Core Layer**: ä¸šåŠ¡é€»è¾‘ä¸ç”¨ä¾‹
  - `PipelineOrchestrator`: ç”¨ä¾‹ç¼–æ’ï¼ˆDefineâ†’Tagâ†’Writeâ†’Indexâ†’Verify / Merge / Amendï¼‰ï¼Œä¼šé€šè¿‡æ³¨å…¥çš„ `NoteRepository`/`App` è¯»å–ç¬”è®°ï¼Œå¹¶é€šè¿‡ `ProviderManager` å‘èµ·ç½‘ç»œè¯·æ±‚ï¼›å…¶èŒè´£èšç„¦â€œç¼–æ’ + ä¸€è‡´æ€§â€ï¼Œåº•å±‚è¯»å†™ä»é›†ä¸­åœ¨ `NoteRepository`/`FileStorage`
  - `TaskQueue`: ä»»åŠ¡è°ƒåº¦ + é”ï¼ˆNodeLock/TypeLockï¼‰ï¼Œé˜Ÿåˆ—æŒä¹…åŒ–é€šè¿‡ `TaskQueueStore`
  - `TaskRunner`: åŸå­ä»»åŠ¡æ‰§è¡Œï¼ˆè°ƒç”¨ Providerã€ç”Ÿæˆå‘é‡ã€é©±åŠ¨å†™å…¥ç­‰ï¼‰ï¼›æ–‡ä»¶è½ç›˜é€šè¿‡ `NoteRepository`
  - `NoteRepository`: Vault è¯»å†™ã€åŸå­å†™ã€é™„ä»¶å†™å…¥ä¸å¿«ç…§ååŠ©
  - `ContentRenderer`: ç»“æ„åŒ– JSON â†’ Markdownï¼ˆé¡ºåºç”± SchemaRegistry é©±åŠ¨ï¼‰
  - `VectorIndex`: å‘é‡åŒ–ä¸ç›¸ä¼¼åº¦æ£€ç´¢
  - `CruidCache`: è¿è¡Œæ—¶ç´¢å¼•ï¼Œç»´æŠ¤ `cruid` â†” `TFile` çš„æ˜ å°„ï¼ˆå¯é‡å»ºï¼‰
  - `DuplicateManager`: ç®¡ç†é‡å¤å¯¹çš„ç”Ÿæˆã€çŠ¶æ€è½¬ç§»
  - `LockManager`: èŠ‚ç‚¹çº§ä¸ç±»å‹çº§çš„å¹¶å‘é”
  
- **Data Layer**: æŒä¹…åŒ–ä¸åŸºç¡€è®¾æ–½
  - `FileStorage`: Obsidian Vault æ–‡ä»¶æ“ä½œï¼ˆè¯»ã€å†™ã€åˆ é™¤ã€é‡å‘½åï¼‰
  - `SettingsStore`: ç”¨æˆ·é…ç½®æŒä¹…åŒ–
  - `Logger`: JSONL æ—¥å¿—
  - `Validator`: LLM è¾“å‡º JSON è§£æ + é¡¶å±‚ Schema/å¿…å¡«æ ¡éªŒï¼ˆä¸åšé€’å½’ï¼‰ï¼›frontmatter è§£æ/å½’ä¸€åŒ–ç”± `src/core/frontmatter-utils.ts` æ‰¿æ‹…

### 3.3 è®¾è®¡çº¦æŸ (SOLID)
| åŸåˆ™ | è§„èŒƒ | ç¤ºä¾‹ |
|---|---|---|
| **S** (Single Responsibility) | æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªèŒè´£ | `ContentRenderer` åªè´Ÿè´£ JSONâ†’Markdownï¼Œä¸è§¦å‘ I/O/Provider |
| **O** (Open/Closed) | å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ | é€šè¿‡æ¥å£å®šä¹‰ Providerï¼Œæ”¯æŒåˆ‡æ¢ AI æœåŠ¡å•† |
| **L** (Liskov Substitution) | åŸºç±»ä¸å­ç±»å¯äº’æ¢ | `TaskRunner` çš„ `TaskHandler`ï¼ˆä»»åŠ¡å¤„ç†å™¨ï¼‰éµå¾ªåŒä¸€æ¥å£ï¼ˆè§ `src/core/task-runner.ts`ï¼‰ |
| **I** (Interface Segregation) | ç»†ç²’åº¦æ¥å£ï¼Œé¿å…ä¾èµ–è¿‡å¤š | `PromptManager` ä»…ä½¿ç”¨å…¶æ‰€éœ€çš„æ¨¡æ¿è¯»å–èƒ½åŠ›ï¼ˆå¦‚ `FileStorage.read`ï¼‰ï¼Œé¿å…â€œèƒ–ä¾èµ–â€ |
| **D** (Dependency Inversion) | ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“ | é€šè¿‡æ„é€ æ³¨å…¥ `ProviderManager` / `FileStorage` / `TaskQueue` ç­‰ä¾èµ–ï¼Œæµ‹è¯•å¯æ›¿æ¢ |

### 3.4 å…³é”®è®¾è®¡æ¨¡å¼
| æ¨¡å¼ | åº”ç”¨åœºæ™¯ | å®ç° |
|---|---|---|
| **Result Monad** | é”™è¯¯å¤„ç† | `src/types.ts`ï¼ˆ`Result` / `ok()` / `err()` / `toErr()` / `CognitiveRazorError`ï¼‰ |
| **Observer** | æ–‡ä»¶å˜æ›´ç›‘å¬ | Obsidian `metadataCache.changed` äº‹ä»¶ |
| **Factory** | ä»»åŠ¡åˆ›å»º | `src/core/task-factory.ts`ï¼ˆ`TaskFactory.create(...)`ï¼Œä¾› `TaskQueue.enqueue(...)` ä½¿ç”¨ï¼‰ |
| **Strategy** | å¤šç§æ“ä½œæµç¨‹ | `src/core/task-runner.ts`ï¼ˆæŒ‰ `TaskType` åˆ†å‘çš„ `TaskHandler` ç­–ç•¥æ˜ å°„ï¼‰ä¸ `src/core/prompt-manager.ts`ï¼ˆ`buildOperation()`ï¼‰ |
| **State Machine** | ä»»åŠ¡çŠ¶æ€è½¬ç§» | Pending â†’ Running â†’ Completed/Failed |

### 3.5 æ’ä»¶ç”Ÿå‘½å‘¨æœŸ (Plugin Lifecycle)
ç®¡ç†æ’ä»¶çš„å¯åŠ¨ã€å…³é—­åŠèµ„æºé‡Šæ”¾ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚

**onload (å¯åŠ¨)**:
1. **é…ç½®åŠ è½½**: `SettingsStore.load()`ã€‚
2. **æœåŠ¡åˆå§‹åŒ–**:
   - `CruidCache`: æ‰«æ Vault å»ºç«‹å†…å­˜æ˜ å°„ã€‚
   - `VectorIndex`: åŠ è½½ `index.json` å…ƒæ•°æ®ã€‚
   - `DuplicateManager`: åŠ è½½ `duplicate-pairs.json`ã€‚
   - `TaskQueue`: åŠ è½½ `data/queue-state.json`ï¼ˆé€šè¿‡ `TaskQueueStore`ï¼‰ï¼Œæ¢å¤ Pending ä»»åŠ¡ï¼›è‹¥å­˜åœ¨ Pending åˆ™å¼ºåˆ¶ `paused=true`ï¼ˆä¸è‡ªåŠ¨è°ƒåº¦ï¼Œéœ€ç”¨æˆ·æ˜¾å¼ resumeï¼‰ã€‚
3. **äº‹ä»¶æ³¨å†Œ**: ç›‘å¬ `metadataCache.changed`, `vault.rename/delete`ã€‚
4. **UI æ¸²æŸ“**: æ³¨å†Œ View å’Œ Ribbon Iconã€‚

**onunload (å…³é—­)**:
1. **é˜Ÿåˆ—æš‚åœ**: `TaskQueue.pause()` å¹¶åœæ­¢è°ƒåº¦ï¼ˆpause ä¼šæŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€ï¼‰ã€‚
2. **èµ„æºé‡Šæ”¾**: `PipelineOrchestrator.dispose()`ã€`CruidCache.dispose()` ç­‰é‡Šæ”¾è®¢é˜…ä¸å†…å­˜èµ„æºã€‚
3. **é”é‡Šæ”¾**: é”ä¸ºå†…å­˜ç»“æ„ï¼Œéšé˜Ÿåˆ—å®ä¾‹é‡Šæ”¾ï¼ˆå¯åŠ¨æ—¶é»˜è®¤æ¸…ç©ºï¼Œé¿å…æ­»é”æ®‹ç•™ï¼‰ã€‚
4. **æ¸…ç†**: é”€æ¯å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨ã€‚

## 4. æ ¸å¿ƒæ¦‚å¿µæ¨¡å‹
### 4.1 çŸ¥è¯†ç±»å‹ (Concept Types)
| ç±»å‹ | ç¤ºä¾‹ | ç‰¹å¾ | å¸¸è§çˆ¶ç±» |
|---|---|---|---|
| **Domain** | è®¤çŸ¥ç§‘å­¦ã€æœºå™¨å­¦ä¹  | å®è§‚é¢†åŸŸæˆ–å­¦ç§‘ï¼Œé€šå¸¸æ˜¯æ ‘çš„æ ¹æˆ–ä¸­é—´å±‚ | æ— æˆ–å…¶ä»– Domain |
| **Issue** | æ„è¯†éš¾é¢˜ã€æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ | å…·ä½“çš„å¾…è§£å†³é—®é¢˜æˆ–ç ”ç©¶è¯¾é¢˜ | Domainï¼ˆä¸€ä¸ªé¢†åŸŸå†…çš„æ ¸å¿ƒè®®é¢˜ï¼‰ |
| **Theory** | é¢„æµ‹åŠ å·¥ç†è®ºã€åå‘ä¼ æ’­ | ç†è®ºæ¨¡å‹æˆ–è§£å†³æ–¹æ¡ˆï¼Œç”¨äºè§£é‡Šæˆ–è§£å†³ Issue | Issueï¼ˆå›ç­”æŸä¸ªé—®é¢˜ï¼‰|
| **Entity** | ç¥ç»å…ƒã€å¼ é‡ã€å˜é‡ | åŸºç¡€æ¦‚å¿µå•å…ƒï¼Œæ˜¯ç»„æˆå…¶ä»–çŸ¥è¯†çš„åŸå­ | Theoryï¼ˆç†è®ºä¸­çš„å¯¹è±¡ï¼‰ |
| **Mechanism** | çªè§¦ä¼ é€’ã€æ¢¯åº¦ä¸‹é™ã€æƒé‡æ›´æ–° | åŠ¨æ€çš„äº¤äº’è¿‡ç¨‹ã€æµç¨‹æˆ–æ¼”å˜æœºåˆ¶ | Theoryï¼ˆç†è®ºä¸­çš„æœºåˆ¶ï¼‰ |

**ç±»å‹å…³ç³»**ï¼š
```
Domain
  â””â”€ Issue (è¯¥é¢†åŸŸçš„æ ¸å¿ƒé—®é¢˜)
      â””â”€ Theory (é—®é¢˜çš„è§£é‡Š/è§£å†³æ–¹æ¡ˆ)
          â”œâ”€ Entity (ç†è®ºæ¶‰åŠçš„å¯¹è±¡)
          â””â”€ Mechanism (ç†è®ºä¸­çš„æœºåˆ¶)
```

### 4.2 ç¬”è®°çŠ¶æ€ (Note State)
- **Stub**: Tag å®Œæˆåè‡ªåŠ¨è½ç›˜çš„å ä½ç¬¦ï¼Œä»…å« frontmatterï¼ˆ`status: Stub`ï¼‰ï¼Œæ­£æ–‡ä¸ºç©º
- **Draft**: Write å®Œæˆåç”Ÿæˆæ­£æ–‡å†…å®¹ï¼ˆ`status: Draft`ï¼‰ï¼Œå¯ç»§ç»­äººå·¥æ ¡éªŒ/è¡¥å……
- **Evergreen**: ç”±ç”¨æˆ·æ‰‹åŠ¨æ ‡è®°çš„ç¨³å®šç¬”è®°ï¼›æ’ä»¶ä¸ä¼šè‡ªåŠ¨æå‡çŠ¶æ€

**çŠ¶æ€è½¬ç§»**:
```
Stub â†’ Draft â†’ Evergreen
```

### 4.3 æ“ä½œé£é™©åˆ†çº§
| æ“ä½œ | é£é™©ç­‰çº§ | è¦æ±‚ | æ˜¯å¦å¯æ’¤é”€ |
|---|---|---|---|
| Define/Tag/Write | ğŸŸ¢ Low | æ—  | âœ“ (åˆ é™¤æ–‡ä»¶å¯æ¢å¤) |
| Merge | ğŸ”´ High | å¿«ç…§ + Diff ç¡®è®¤ + åŒç¬”è®°å„å¤‡ä»½ | âœ“ (é€šè¿‡å¿«ç…§æ¢å¤) |
| Amend | ğŸŸ  Medium | å¿«ç…§ + Diff ç¡®è®¤ | âœ“ (é€šè¿‡å¿«ç…§æ¢å¤) |
| Expand | ğŸŸ¡ Low | ç”¨æˆ·å‹¾é€‰å€™é€‰é¡¹ | âœ“ (åˆ é™¤æ–°å»ºç¬”è®°) |
| Visualize | ğŸŸ¢ Low | æ—  | âœ“ (åˆ é™¤é™„ä»¶) |


## 5. æ•°æ®å¥‘çº¦ (Data Contracts)
### 5.1 Frontmatter (YAML)
```yaml
cruid: "550e8400-e29b-41d4-a716-446655440000"
type: "Domain"  # å¯¹åº” ConceptType
name: "è®¤çŸ¥ç§‘å­¦"
status: "Draft"
created: "2025-12-13 10:30:00"
updated: "2025-12-13 15:45:00"
aliases: ["è®¤çŸ¥ç ”ç©¶", "Cognitive Science"]
tags: ["ç§‘å­¦", "å¿ƒæ™º"]
parents: ["[[æ•°å­¦ (Mathematics)]]", "[[ç‰©ç†å­¦ (Physics)]]"]
```
å­—æ®µçº¦æŸï¼š
- å¿…å¡«å­—æ®µï¼š`cruid` / `type` / `name` / `status` / `created` / `updated` / `parents`ï¼ˆ`parents` å¿…é¡»å­˜åœ¨ä¸”ä¸ºæ•°ç»„ï¼Œå¯ä¸ºç©ºï¼‰ã€‚
- æ—¶é—´æ ¼å¼å›ºå®š `yyyy-MM-DD HH:mm:ss`ï¼ˆæœ¬åœ°æ—¶åŒºï¼Œæ— æ—¶åŒºä¿¡æ¯ï¼Œé ISOï¼›ä»…ç”¨äºå±•ç¤º/æ’åºï¼‰ã€‚
- `aliases` åªå­˜åˆ«åï¼Œä¸å« cruidã€‚
- `parents` åªå­˜çˆ¶æ¦‚å¿µçš„ Obsidian wikilinkï¼Œè§„èŒƒå½¢æ€ **ä»…** `[[Title]]`ï¼ˆTitle=æ–‡ä»¶åï¼Œä¸å« `.md`ï¼›ä¸å…è®¸ `[[Title|alias]]` æˆ– `[[Title#Heading]]`ï¼‰ï¼›å…è®¸å¤šçˆ¶ï¼Œå…è®¸å½¢æˆç¯ï¼ˆæ’ä»¶ä¸åšæ— ç¯/DAG æ ¡éªŒï¼‰ã€‚
- æ’ä»¶å†™å…¥/è§£ææ—¶ä¼šå¯¹ `parents` åšå½’ä¸€åŒ–ï¼Œç¡®ä¿è½ç›˜ä¸ºä¸Šè¿°è§„èŒƒå½¢æ€ï¼ˆè§ `src/core/frontmatter-utils.ts`ï¼‰ã€‚

### 5.2 ä»»åŠ¡è®°å½• (Task Record)
**å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`TaskType` / `TaskState` / `TaskRecord` / `QueueStateFile`ï¼‰ã€‚  
æœ¬æ–‡åªçº¦æŸä»¥ä¸‹ä¸å˜é‡ï¼š
- `nodeId` ä¼˜å…ˆä½¿ç”¨ç›®æ ‡æ¦‚å¿µçš„ `cruid`ï¼›å¯¹äºæ—  `cruid` çš„æ–‡ä»¶çº§ä»»åŠ¡ï¼ˆå¦‚å›¾ç‰‡æ’å…¥ï¼‰ï¼Œå…è®¸å›é€€ä¸º `filePath`ï¼ˆä»ç”¨äºèŠ‚ç‚¹çº§äº’æ–¥ï¼‰ã€‚
- `payload` åªæ‰¿è½½æ‰§è¡Œæ‰€éœ€çš„æœ€å°ä¸Šä¸‹æ–‡ï¼›`result` åªå†™å…¥å¯åºåˆ—åŒ–æ•°æ®ã€‚
- é˜Ÿåˆ—æŒä¹…åŒ–æ ¼å¼ä»¥ `QueueStateFile` ä¸ºå‡†ï¼ˆè¯»å†™/trim å®ç°ä½äº `src/core/task-queue-store.ts`ï¼‰ï¼Œé¿å…åœ¨æ–‡æ¡£ä¸­é‡å¤ç»´æŠ¤å­—æ®µåˆ—è¡¨ã€‚

### 5.3 å‘é‡ç´¢å¼• (Vector Index)
å…ƒæ•°æ®ï¼ˆ`data/vectors/index.json`ï¼‰ï¼š
**å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`VectorIndexMeta` / `ConceptMeta` / `ConceptVector`ï¼‰ã€`src/core/vector-index.ts`ï¼ˆè¯»å†™ä¸è¿ç§»é€»è¾‘ï¼‰ä¸ `src/data/file-storage.ts`ï¼ˆæ–‡ä»¶è·¯å¾„ä¸åŸå­å†™ï¼‰ã€‚  
æœ¬æ–‡åªçº¦æŸï¼š
- ç´¢å¼•å…ƒæ•°æ®ä¸å­˜ `name/path`ï¼Œè¿è¡Œæ—¶é€šè¿‡ `CruidCache` è§£æï¼ˆè§ `src/core/cruid-cache.ts`ï¼‰ã€‚
- å‘é‡æ–‡ä»¶å¿…é¡»è®°å½• `embeddingModel` ä¸ `dimensions`ï¼ˆè§ `ConceptVector.metadata`ï¼‰ï¼Œé¿å…æ¨¡å‹/ç»´åº¦æ¼‚ç§»é€ æˆçš„éšæ€§é”™è¯¯ã€‚
å‘é‡æ–‡ä»¶ï¼ˆ`data/vectors/{type}/{cruid}.json`ï¼‰ï¼š
çº¦æŸï¼š
- ç´¢å¼•ä¸å­˜ `name/path`ï¼Œè¿è¡Œæ—¶ç”± `CruidCache` è§£æã€‚
- `vectorFilePath` ä»…å†…éƒ¨ä½¿ç”¨ï¼Œä¸å¯¹å¤–æš´éœ²ã€‚

### 5.4 é‡å¤å¯¹ (Duplicate Pair)
> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`DuplicatePair` ç­‰ç±»å‹å®šä¹‰ï¼‰ä¸ `src/core/duplicate-manager.ts`ï¼ˆå­˜å‚¨/çŠ¶æ€æ›´æ–°/è®¢é˜…é€šçŸ¥ï¼‰ã€‚

ä¸å˜é‡ï¼š
- `nodeIdA` / `nodeIdB` å‡ä¸ºç›®æ ‡æ¦‚å¿µçš„ `cruid`ã€‚
- `similarity` âˆˆ [0, 1]ã€‚
- çŠ¶æ€è¿ç§»ç”± DuplicateManager ç»Ÿä¸€ç»´æŠ¤ï¼ŒUI åªé€šè¿‡ API è§¦å‘æ›´æ–°ã€‚

### 5.5 å¿«ç…§ (Snapshot)
> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`SnapshotRecord` / `SnapshotMetadata` / `SnapshotIndex` ç­‰ï¼‰ä¸ `src/core/undo-manager.ts`ï¼ˆåˆ›å»º/æ¢å¤/æ¸…ç†ï¼‰ã€‚

ä¸å˜é‡ï¼š
- å¿«ç…§ä»¥â€œæ–‡ä»¶è·¯å¾„ + å†…å®¹ + æ ¡éªŒâ€ä¸ºæœ€å°å¯æ¢å¤å•å…ƒã€‚
- ç ´åæ€§å†™å…¥ï¼ˆMerge/Amend ç­‰ï¼‰å¿…é¡»åœ¨è½ç›˜å‰åˆ›å»ºå¿«ç…§ï¼Œå¹¶æ”¯æŒä»å¿«ç…§æ¢å¤ã€‚
- Visualize ä¸åˆ›å»ºå¿«ç…§ï¼Œç”¨æˆ·åˆ é™¤é™„ä»¶å³å¯å›é€€ã€‚

## 6. æ ¸å¿ƒæµç¨‹ (Core Workflows)
æ¯ä¸ªæµç¨‹ç”±å¤šä¸ªåŸå­ä»»åŠ¡ç»„æˆï¼Œé€šè¿‡ Pipeline é¡ºåºæ‰§è¡Œï¼Œæ”¯æŒæš‚åœ/æ¢å¤å’Œé”™è¯¯é‡è¯•ã€‚

### 6.0 æ¦‚å¿µå±‚ / å®ç°å±‚æ˜ å°„ï¼ˆé˜²æ··ç”¨ï¼‰
- **ç”¨æˆ·æ“ä½œï¼ˆPipeline kindï¼‰**ï¼šCreate / Amend / Merge / Verifyï¼›Expand ä¼šæ‰¹é‡è§¦å‘ Createï¼›Visualize å¯¹åº”å›¾åƒç”Ÿæˆã€‚
- **é˜Ÿåˆ—ä»»åŠ¡ï¼ˆ`TaskType`ï¼‰**ï¼šå½“å‰å…¥é˜Ÿ `tag` / `write` / `amend` / `merge` / `verify` / `image-generate`ï¼›`define` / `index` ä»»åŠ¡ç±»å‹å­˜åœ¨ä½†æœªå…¥é˜Ÿï¼ˆä¿ç•™ï¼‰ã€‚
- **åŒæ­¥æ­¥éª¤**ï¼š
  - Defineï¼šç”± `PipelineOrchestrator.defineDirect()` ç›´è°ƒï¼ˆä¸å…¥é˜Ÿï¼Œç”¨äº UI ç«‹å³å‘ˆç°ç±»å‹ç½®ä¿¡åº¦ä¸æ ‡å‡†åï¼‰ã€‚
  - Indexï¼šå½“å‰å®ç°ä¸º embedding ç›´è°ƒï¼ˆ`PipelineOrchestrator.executeEmbeddingDirect()`ï¼‰ï¼Œä¸ä½œä¸º `TaskType` ç‹¬ç«‹å…¥é˜Ÿã€‚
  - Deduplicateï¼šç”± `DuplicateManager.detect(...)` åœ¨ embedding åè§¦å‘ï¼Œä¸ä½œä¸º `TaskType` ç‹¬ç«‹å…¥é˜Ÿï¼›å†…éƒ¨ä½¿ç”¨ `SimpleLockManager` çš„ `type:${CRType}` é”ï¼ˆæœ€ä½³åŠªåŠ›ï¼‰ã€‚

### 6.1 Defineï¼ˆç±»å‹è¯†åˆ« + æ ‡å‡†åŒ–å‘½åï¼‰
å¯¹è¾“å…¥åšæœ¬ä½“åˆ†ç±»ï¼Œå¹¶ä¸ºæ¯ä¸ªç±»å‹ç”Ÿæˆå¯ç”¨çš„æ ‡å‡†å‘½åï¼›UI åŸºäºç»“æœè®©ç”¨æˆ·é€‰æ‹©æœ€ç»ˆç±»å‹ã€‚
- **å…¥å£**: ç”¨æˆ·è¾“å…¥æ–‡æœ¬
- **æµç¨‹**: 
  1. æå–å…³é”®ç‰¹å¾
  2. è°ƒç”¨ LLM ç”Ÿæˆ **5 ç±»ç±»å‹å€™é€‰**çš„æ ‡å‡†åä¸ç½®ä¿¡åº¦åˆ†å¸ƒï¼ˆç½®ä¿¡åº¦æ€»å’Œ=1.0ï¼‰
  3. å‘ˆç°ç»™ç”¨æˆ·é€‰æ‹©æœ€ç»ˆ `type`
- **è¾“å‡º**: `StandardizedConcept`ï¼ˆå”¯ä¸€æ¥æºï¼š`src/types.ts`ï¼‰ï¼ŒåŒ…å«ï¼š
  - `standardNames`: æ¯ç§ `CRType` çš„ `{ chinese, english }`
  - `typeConfidences`: æ¯ç§ `CRType` çš„ç½®ä¿¡åº¦ï¼ˆæ€»å’Œ=1.0ï¼‰
- **å¯èƒ½å¤±è´¥**: LLM è¶…æ—¶ã€æ— æ³•è¯†åˆ«
- **çº¦æŸ**:
  - æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è¦†ç›–ç³»ç»Ÿæ¨è
  - UI è°ƒç”¨ `PipelineOrchestrator.defineDirect()` è·å–ç»“æœï¼ˆä¸å…¥é˜Ÿï¼‰ï¼Œç”¨æˆ·é€‰æ‹©ç±»å‹å Create ç®¡çº¿ä» Tag å¼€å§‹
  - è¾“å‡ºè¦æ±‚ JSONï¼›å®ç°ä¼šå°è¯•å‰¥ç¦» markdown fence ä»¥æé«˜å®¹é”™ï¼Œä½†æ¨è raw JSON

### 6.2 Tag (ç”Ÿæˆå…ƒæ•°æ®)
ä¸ºæ¦‚å¿µç”Ÿæˆåˆ«åã€æ ‡ç­¾ã€å…³é”®è¯ã€‚
- **å…¥å£**: è¾“å…¥æ–‡æœ¬ + å·²ç¡®å®šçš„ `type`
- **æµç¨‹**:
  1. è°ƒç”¨ LLM åˆ†æè¯­ä¹‰
  2. ç”Ÿæˆåˆ«ååˆ—è¡¨ï¼ˆåŒä¹‰è¯ã€ç¼©å†™ï¼‰
  3. ç”Ÿæˆæ ‡ç­¾ï¼ˆåˆ†ç±»ã€å±æ€§ï¼‰
- **è¾“å‡º**: `aliases`, `tags`
- **å¯èƒ½å¤±è´¥**: LLM è°ƒç”¨å¤±è´¥ã€è¾“å‡ºæ ¼å¼é”™è¯¯
- **çº¦æŸ**:
  - åˆ«åä¸åº”åŒ…å« `cruid`ï¼ˆç›®å‰ä»…é€šè¿‡ Prompt çº¦æŸï¼Œä¸åšå¼ºæ ¡éªŒï¼‰
  - Tag å®Œæˆå Create è‡ªåŠ¨è¿›å…¥ Stub â†’ Write â†’ Index â†’ Deduplicateï¼Œæ— éœ€æ˜¾å¼ç”¨æˆ·ç¡®è®¤

### 6.3 Write (ç”Ÿæˆæ­£æ–‡)
æ ¹æ®æ¦‚å¿µç±»å‹ Schema ç”Ÿæˆç»“æ„åŒ–æ­£æ–‡ã€‚
- **å…¥å£**: è¾“å…¥æ–‡æœ¬ + `type` 
- **æµç¨‹**:
  1. åŠ è½½ç±»å‹ç‰¹å®šçš„ Prompt æ¨¡æ¿ï¼ˆå¦‚ `_type/domain-core.md`ï¼‰
  2. æ³¨å…¥ `{{BASE_TERMINOLOGY}}` ç­‰å…¨å±€ä¸Šä¸‹æ–‡
  3. è°ƒç”¨ LLM ç”Ÿæˆæ­£æ–‡ï¼ˆJSON æ ¼å¼ï¼‰
  4. è§£æ JSON å¹¶æ‰§è¡Œæµ…å±‚æ ¡éªŒï¼ˆé¡¶å±‚ç±»å‹ + å¿…å¡«å­—æ®µï¼‰
- **è¾“å‡º**: ç»“æ„åŒ–çš„æ­£æ–‡å†…å®¹ï¼ˆæŒ‰ç±»å‹æœ‰ä¸åŒçš„ Schemaï¼‰
- **å¯èƒ½å¤±è´¥**: JSON è§£æå¤±è´¥ã€å­—æ®µç¼ºå¤±ã€ä¸ç¬¦åˆè§„èŒƒ
- **çº¦æŸ**: è¾“å‡ºå¿…é¡»æ˜¯åŸå§‹ JSONï¼ˆæ—  markdown fenceï¼‰

#### 6.3.1 å„ç±»å‹çš„ Write Schema ä¸å¤„ç†é€»è¾‘
> **å”¯ä¸€æ¥æº**ï¼š
> - Schemaï¼š`src/core/schema-registry.ts`ï¼ˆæŒ‰ `CRType` æ³¨å†Œ JSON Schema ä¸å­—æ®µæè¿°ï¼‰
> - Promptï¼š`prompts/_type/*-core.md`ï¼ˆWrite ç±»å‹æ¨¡æ¿ï¼‰ä¸ `prompts/_base/operations/*.md`ï¼ˆé€šç”¨çº¦æŸ/æ“ä½œå—ï¼›Write é€šè¿‡ `{{OPERATION_BLOCK}}` æ³¨å…¥ `_base/operations/write.md`ï¼‰
> - æ¸²æŸ“ï¼š`src/core/content-renderer.ts`ï¼ˆJSON â†’ Markdownï¼‰

ä¸å˜é‡ï¼š
- LLM è¾“å‡ºå¿…é¡»æ˜¯ raw JSONï¼ˆæ—  markdown fenceï¼‰ï¼Œå¹¶èƒ½é€šè¿‡å½“å‰å®ç°çš„æµ…å±‚ Schema æ ¡éªŒï¼ˆé¡¶å±‚å­—æ®µç±»å‹ + å¿…å¡«å­—æ®µï¼‰ã€‚
- æ¸²æŸ“é¡ºåºç”± SchemaRegistry çš„å­—æ®µæè¿°é¡ºåºé©±åŠ¨ï¼›å…·ä½“ Markdown ç»“æ„ä»¥ ContentRenderer ä¸ºå‡†ï¼ˆé¿å…åœ¨æ–‡æ¡£ä¸­æ‰‹æŠ„å­—æ®µæ¸…å•å¯¼è‡´æ¼‚ç§»ï¼‰ã€‚
- `definition` ä½œä¸ºç»“æ„åŒ–è¾“å‡ºçš„å¿…å¡«å­—æ®µï¼ˆç”± SchemaRegistry çº¦æŸï¼‰ï¼Œå¯é€‰å†™å…¥ frontmatterï¼ˆç”Ÿæˆ/è§£æä»¥ `src/core/frontmatter-utils.ts` ä¸ºå‡†ï¼‰ã€‚

### 6.4 Index (å‘é‡åŒ–)
å°†æ¦‚å¿µå†…å®¹è½¬åŒ–ä¸ºå‘é‡è¡¨ç¤ºï¼Œç”¨äºåç»­æ£€ç´¢ä¸å»é‡ã€‚
- **å…¥å£**: ç”±æ¦‚å¿µç­¾åç”Ÿæˆçš„åµŒå…¥æ–‡æœ¬ï¼ˆä¸»è¦æ¥è‡ª frontmatterï¼›æ­£æ–‡ä¸å‚ä¸ï¼‰
- **æµç¨‹**:
  1. ç”ŸæˆåµŒå…¥æ–‡æœ¬ï¼š
     - Createï¼šæ ‡å‡†å + æ ¸å¿ƒå®šä¹‰ + ç±»å‹ + æ ‡ç­¾
     - Amend/Mergeï¼šä» frontmatter è¯»å– name/aliases/definition/type/tags ç»„åˆ
  2. è°ƒç”¨ Embedding æ¨¡å‹ç”Ÿæˆå‘é‡ï¼ˆç»´åº¦å¯é…ç½®ï¼Œé»˜è®¤ 1536ï¼‰
  3. å­˜å‚¨åˆ° `data/vectors/{type}/{cruid}.json`
  4. æ›´æ–°ç´¢å¼•å…ƒæ•°æ® (`data/vectors/index.json`)
- **è¾“å‡º**: å‘é‡æ–‡ä»¶ + ç´¢å¼•å…ƒæ•°æ®
- **å¯èƒ½å¤±è´¥**: Embedding æœåŠ¡è¶…æ—¶ã€ç½‘ç»œé”™è¯¯
- **çº¦æŸ**:
  - ç»´åº¦å¯é…ç½®ï¼Œä½†å…¨é‡ç´¢å¼•éœ€ä¿æŒä¸€è‡´ã€‚
  - å¢é‡æ”¹è¿›/åˆå¹¶å®Œæˆåå¿…é¡»é‡ç®— embedding å†å»é‡ï¼Œé¿å…é™ˆæ—§å‘é‡ã€‚

### 6.5 Deduplicate (å»é‡æ£€æµ‹)
åœ¨åŒç±»å‹å‘é‡æ¡¶ä¸­æ£€ç´¢ç›¸ä¼¼çš„æ¦‚å¿µã€‚
- **å…¥å£**: æ–°æ¦‚å¿µçš„å‘é‡ + å·²ç´¢å¼•åŒç±»å‹æ¦‚å¿µ
- **æµç¨‹**:
  1. åŠ è½½åŒç±»å‹æ‰€æœ‰å‘é‡
  2. è®¡ç®—æ–°å‘é‡ä¸å„æ¦‚å¿µå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦
  3. ç­›é€‰ç›¸ä¼¼åº¦ > é˜ˆå€¼ï¼ˆé»˜è®¤ 0.85ï¼‰çš„æ¦‚å¿µå¯¹
  4. ç”Ÿæˆ `DuplicatePair` è®°å½•
- **è¾“å‡º**: é‡å¤å¯¹åˆ—è¡¨ï¼ˆå­˜å…¥ `data/duplicate-pairs.json`ï¼‰
- **å¯èƒ½å¤±è´¥**: å‘é‡æ¯”å¯¹å¤±è´¥ï¼ˆç»´åº¦ä¸åŒ¹é…ã€NaN å€¼ï¼‰
- **çº¦æŸ**: åªåœ¨åŒç±»å‹å†…æ£€ç´¢ï¼›æ–°æ¦‚å¿µä¸å·²æœ‰æ¦‚å¿µæ¯”å¯¹

### 6.6 Merge (èåˆ)
åˆå¹¶ä¸¤ä¸ªè¯­ä¹‰é‡å¤çš„æ¦‚å¿µï¼Œä¿ç•™ä¸»æ¦‚å¿µï¼Œåˆ é™¤è¢«åˆ æ¦‚å¿µã€‚
- **å…¥å£**: é€‰å®šçš„ä¸»æ¦‚å¿µ A å’Œè¢«åˆ æ¦‚å¿µ B + ç”¨æˆ·ç¡®è®¤
- **æµç¨‹**:
  1. **å¤‡ä»½**: ä¸º A å’Œ B å„åˆ›å»ºå¿«ç…§ (`SnapshotRecord`)
  2. **èåˆ**: å…¥é˜Ÿ `merge` ä»»åŠ¡ï¼Œç”± LLM ç”Ÿæˆåˆå¹¶åçš„å†…å®¹
  3. **Diff ç¡®è®¤**: ä»»åŠ¡å®Œæˆåä½¿ç”¨ `SimpleDiffView` å±•ç¤ºç»Ÿä¸€è¡Œçº§ Diffï¼Œç”¨æˆ·ç¡®è®¤åç”± `confirmWrite()` è½ç›˜
  4. **å†²çªæ£€æµ‹**: è‹¥ A/B åœ¨ç¡®è®¤å†™å…¥å‰è¢«å¤–éƒ¨ä¿®æ”¹ï¼Œåˆ™ä¸­æ­¢ï¼ˆé¿å…è¦†ç›–/è¯¯åˆ ï¼‰
  5. **å†™å…¥**: æ›´æ–° A çš„å†…å®¹å’Œ `aliases`ï¼ˆè¿½åŠ  B çš„æ ‡é¢˜ï¼‰
  6. **é‡å†™ parents å¼•ç”¨**ï¼ˆè½åœ°ï¼‰ï¼šåœ¨åˆ é™¤ B å‰ï¼Œæ‰«æ Vault ä¸­æ‰€æœ‰ç¬”è®°ï¼šè‹¥å…¶ frontmatter.parents åŒ…å« `[[B]]`ï¼Œåˆ™æ›¿æ¢ä¸º `[[A]]`ï¼ˆå»é‡ï¼‰ï¼›å¯¹æ¯ä¸ªå—å½±å“ç¬”è®°å…ˆåˆ›å»ºå¿«ç…§ï¼Œå†å†™å…¥æ›´æ–°åçš„ frontmatterã€‚
  7. **åˆ é™¤**: ä» Vault åˆ é™¤ B çš„æ–‡ä»¶
  8. **æ¸…ç†**:
      - `VectorIndex.delete(B.cruid)`
      - `DuplicateManager.removePairsByNodeId(B.cruid)` (ä¿ç•™ `merging` çŠ¶æ€é¿å…ç«æ€)
- **è¾“å‡º**: èåˆåçš„ A + å·²åˆ é™¤çš„ B
- **å¯èƒ½å¤±è´¥**: LLM è°ƒç”¨å¤±è´¥ã€Diff ç”¨æˆ·æ‹’ç»ã€æ–‡ä»¶åˆ é™¤å¤±è´¥
- **çº¦æŸ**:
  - å¿…é¡»åˆ›å»ºå¿«ç…§
  - è¢«åˆ  cruid å¿…é¡»ä»æ‰€æœ‰æ•°æ®ç»“æ„å½»åº•æ¸…é™¤
  - è¢«åˆ æ ‡é¢˜è¿½åŠ åˆ° A çš„ `aliases`ï¼ˆä¸æ˜¯ `cruid`ï¼‰
  - è‹¥ â€œé‡å†™ parents å¼•ç”¨â€ å¤±è´¥ï¼šMerge ä¼šä¸­æ­¢åˆ é™¤ Bï¼Œå¹¶å°†é‡å¤å¯¹çŠ¶æ€ä» `merging` å›é€€åˆ° `pending`ï¼Œæç¤ºç”¨æˆ·é‡è¯•ï¼ˆé¿å…ç•™ä¸‹å­¤å„¿ parentsï¼‰

### 6.7 Amend (ä¿®è®¢)
å¯¹ç°æœ‰æ¦‚å¿µè¿›è¡Œå¢é‡ä¼˜åŒ–ã€æ¶¦è‰²æˆ–çº æ­£ã€‚
- **å…¥é—¨**: é€‰å®šçš„æ¦‚å¿µ + ç”¨æˆ·è¾“å…¥ä¿®è®¢æŒ‡ä»¤ (å¦‚"è¡¥å……å®éªŒè¯æ®")
- **æµç¨‹**:
  1. **å¤‡ä»½**: åˆ›å»ºå¿«ç…§ (`SnapshotRecord`)
  2. **æ”¹è¿›**: å…¥é˜Ÿ `amend` ä»»åŠ¡ï¼Œè¾“å…¥åŸå†…å®¹ + ä¿®è®¢æŒ‡ä»¤ï¼Œç”Ÿæˆæ”¹è¿›ç¨¿
  3. **Diff ç¡®è®¤**: ä»»åŠ¡å®Œæˆåä½¿ç”¨ `SimpleDiffView` å±•ç¤ºç»Ÿä¸€è¡Œçº§ Diffï¼Œç”¨æˆ·ç¡®è®¤åç”± `confirmWrite()` è½ç›˜
  4. **å†™å…¥**: æ›´æ–°æ–‡ä»¶ï¼ˆä¿æŒ `cruid`ã€`created` ä¸å˜ï¼Œæ›´æ–° `updated`ï¼‰
  5. **ç´¢å¼•æ›´æ–°**: é‡æ–°ç”Ÿæˆå‘é‡ï¼Œæ›´æ–°ç´¢å¼•
  6. **é‡æ£€å»é‡**: åœ¨åŒç±»å‹å†…é‡æ–°æ£€æµ‹æ˜¯å¦äº§ç”Ÿæ–°çš„é‡å¤å¯¹
- **è¾“å‡º**: æ”¹è¿›åçš„æ¦‚å¿µæ–‡ä»¶ + å¯èƒ½çš„æ–°é‡å¤å¯¹
- **å¯èƒ½å¤±è´¥**: LLM è°ƒç”¨å¤±è´¥ã€Diff ç”¨æˆ·æ‹’ç»ã€å‘é‡ç”Ÿæˆå¤±è´¥
- **çº¦æŸ**:
  - å¿…é¡»åˆ›å»ºå¿«ç…§å¹¶å¾—åˆ°ç”¨æˆ·ç¡®è®¤
  - ä¸æ”¹å˜æ¦‚å¿µçš„ `type` å’Œ `cruid`
  - å¿«ç…§åœ¨ Diff æ˜¾ç¤ºå‰å°±å·²åˆ›å»º
  - ç¡®è®¤å†™å…¥å‰è‹¥æ£€æµ‹åˆ°å¤–éƒ¨ä¿®æ”¹ï¼Œä¼šä¸­æ­¢å†™å…¥å¹¶æç¤ºé‡æ–°ç”Ÿæˆ Diff

### 6.8 Expand (æ‹“å±•)
åŸºäºå½“å‰æ¦‚å¿µå‘ç°ä¸Šä¸‹ä½æˆ–ç›¸å…³çš„æ–°æ¦‚å¿µã€‚
- **å…¥é—¨**: é€‰å®šçš„æ¦‚å¿µ A
- **æµç¨‹**:
  1. **å€™é€‰æå–**ï¼ˆä¸¤ç§æ¨¡å¼ï¼‰ï¼š
     - **å±‚çº§æ‹“å±•ï¼ˆDomain/Issue/Theoryï¼‰**ï¼šä» A çš„æ­£æ–‡æŒ‰å›ºå®šæ ¼å¼è§£æå€™é€‰ï¼ˆä¸è°ƒç”¨ LLM ç”Ÿæˆå€™é€‰ï¼›è§ `src/core/expand-orchestrator.ts`ï¼‰ã€‚
     - **æŠ½è±¡æ‹“å±•ï¼ˆEntity/Mechanismï¼‰**ï¼šåŸºäºå‘é‡ç›¸ä¼¼æ£€ç´¢å€™é€‰æ¥æºï¼Œå†è°ƒç”¨ LLM æ ‡å‡†åŒ–ç”Ÿæˆä¸€ä¸ªæ›´æŠ½è±¡çš„åŒç±»å‹æ¦‚å¿µï¼ˆä¼šè°ƒç”¨æ¨¡å‹ï¼‰ã€‚
  2. **å»é‡è¿‡æ»¤**: æŒ‰ç›®æ ‡è½ç›˜è·¯å¾„æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆ`vault.getAbstractFileByPath`ï¼‰ï¼Œæ ‡è®° `creatable / existing / invalid`ã€‚
  3. **ç”¨æˆ·å‹¾é€‰**: ç”¨æˆ·é€‰æ‹©è¦åˆ›å»ºçš„å€™é€‰é¡¹ï¼ˆæ”¯æŒæ‰¹é‡ï¼Œä¸Šé™ 200ï¼‰ã€‚
  4. **æ‰¹é‡åˆ›å»º**: å¯¹æ¯ä¸ªå‹¾é€‰é¡¹å¯åŠ¨ Create ç®¡çº¿ï¼ˆè·³è¿‡ Defineï¼Œä» Tag å¼€å§‹ï¼‰ï¼š
     - `Tag â†’ (Stub) â†’ Write â†’ Index â†’ Deduplicate`
     - æ–°æ¦‚å¿µçš„ `parents` å­—æ®µå¡«å…¥ A çš„æ ‡é¢˜ï¼ˆ`[[A]]`ï¼‰ã€‚
- **è¾“å‡º**: æ–°å»ºæ¦‚å¿µæœ€ç»ˆè½ç›˜ä¸º `Draft`ï¼›åœ¨ Tag åã€Write å‰çš„çŸ­æš‚é˜¶æ®µä¸º `Stub`ã€‚
- **å¯èƒ½å¤±è´¥**: LLM è°ƒç”¨å¤±è´¥ã€ç”¨æˆ·å–æ¶ˆã€æŸä¸ªåˆ›å»ºä»»åŠ¡å¤±è´¥
- **çº¦æŸ**:
  - å€™é€‰æ•°ä¸è¶…è¿‡ 200ï¼ˆé˜²æ­¢è¶…è½½ï¼‰
  - æ–°æ¦‚å¿µåªå†™ `parents`ï¼Œä¸ä¿®æ”¹åŸæ¦‚å¿µ
  - å¯èƒ½å‡ºç°ç½‘ç»œç­‰ä¸´æ—¶æ•…éšœå¯¼è‡´éƒ¨åˆ†åˆ›å»ºå¤±è´¥ï¼Œéœ€æç¤ºç”¨æˆ·é‡è¯•

### 6.9 Visualize (å¯è§†åŒ–)
ä¸ºæ¦‚å¿µç”Ÿæˆé…å›¾ã€‚
- **å…¥é—¨**: å½“å‰ç¼–è¾‘çš„æ¦‚å¿µ + å…‰æ ‡ä½ç½® + ç”¨æˆ·è¾“å…¥çš„æè¿°ï¼ˆå¯é€‰ï¼‰
- **æµç¨‹**:
  1. **ä¸Šä¸‹æ–‡æå–**: è·å–å½“å‰ç¬”è®°çš„ Frontmatter å’Œå…‰æ ‡é™„è¿‘çš„æ­£æ–‡
  2. **Prompt ç”Ÿæˆï¼ˆä¸¤æ®µå¼ï¼‰**: å…ˆé€šè¿‡ LLM ç”Ÿæˆç»“æ„åŒ– JSON `{ prompt, altText }`ï¼ˆå¿…é¡» raw JSONï¼Œæ—  markdown fenceï¼‰
  3. **è°ƒç”¨ Provider**: é€šè¿‡ OpenAI-Compatible Images APIï¼ˆ`POST /images/generations`ï¼‰ç”Ÿæˆå›¾ç‰‡ï¼ˆé»˜è®¤æ¨¡å‹ï¼š`gemini-3-pro-image-preview`ï¼‰
  4. **ä¿å­˜é™„ä»¶**: è§£ç è¿”å›çš„å›¾åƒæ•°æ®ï¼Œè°ƒç”¨ `vault.getAvailablePathForAttachment()` è®¡ç®—è·¯å¾„ï¼Œä¿å­˜ä¸º Attachment
  5. **æ’å…¥é“¾æ¥**: åœ¨å…‰æ ‡ä½ç½®æ’å…¥ `![alt](path)` é“¾æ¥
  6. **æ’¤é”€æ–¹å¼**: ç”¨æˆ·åˆ é™¤å›¾ç‰‡é“¾æ¥/é™„ä»¶å³å¯å›é€€
- **è¾“å‡º**: ä¿å­˜çš„å›¾ç‰‡ Attachment + Markdown é“¾æ¥
- **å¯èƒ½å¤±è´¥**: å›¾åƒç”Ÿæˆå¤±è´¥ã€ç½‘ç»œè¶…æ—¶ã€ç£ç›˜ç©ºé—´ä¸è¶³
- **çº¦æŸ**:
  - ä¸åˆ›å»ºå¿«ç…§ï¼ˆå›¾ç‰‡ç”Ÿæˆå¤±è´¥ä¸å½±å“åŸç¬”è®°ï¼‰
  - å›¾ç‰‡å¤§å°ã€æ ¼å¼ç”±é…ç½®æŒ‡å®š

### 6.10 Verify (äº‹å®æ ¸æŸ¥)
å¯¹ç¬”è®°å†…å®¹è¿›è¡Œäº‹å®æ ¸æŸ¥ï¼Œå‡å°‘å¹»è§‰ã€‚æ’ä»¶æœ¬èº«ä¸ç›´æ¥å‘èµ·â€œç½‘ç»œæœç´¢â€è¯·æ±‚ï¼›è‹¥æ‰€é€‰ provider/model å…·å¤‡è”ç½‘/æ£€ç´¢èƒ½åŠ›ï¼Œå¯æå‡æ ¸æŸ¥æ•ˆæœã€‚
- **å…¥å£**: 
  - **è‡ªåŠ¨**: å†™å…¥è½ç›˜åè‡ªåŠ¨è§¦å‘ï¼ˆè‹¥é…ç½® `enableAutoVerify: true`ï¼‰ã€‚
  - **æ‰‹åŠ¨**: ç”¨æˆ·åœ¨å·¥ä½œå°æˆ–å‘½ä»¤ `cognitive-razor:verify-current-note` è§¦å‘ã€‚
- **æµç¨‹**:
  1. **æå–å†…å®¹**: è·å–å½“å‰ç¬”è®°çš„å…¨æ–‡ã€‚
  2. **æ‰‹åŠ¨è§¦å‘é¢„å¿«ç…§**: æ‰‹åŠ¨ Verify ä¼šåœ¨å…¥é˜Ÿå‰å°è¯•åˆ›å»ºå¿«ç…§ï¼ˆè‡ªåŠ¨è§¦å‘ä¸åšæ­¤æ­¥ï¼›å¤±è´¥ä¸é˜»æ–­ï¼‰ã€‚
  3. **è°ƒç”¨ Verifier**: é€šè¿‡ OpenAI-Compatible Chat Completions è°ƒç”¨é…ç½®çš„ Verify æ¨¡å‹ï¼Œè¾“å…¥å…¨æ–‡å¹¶è¦æ±‚ç»“æ„åŒ–è¾“å‡ºã€‚
  4. **ç”ŸæˆæŠ¥å‘Š**: Verifier è¿”å› **raw JSONï¼ˆæ—  markdown fenceï¼‰**ï¼Œå¹¶è‡³å°‘åŒ…å«ï¼š`overall_assessment` / `confidence_score` / `issues` / `verified_claims` / `recommendations` / `requires_human_review`ã€‚
  5. **è¿½åŠ ç»“æœ**: è¿½åŠ æŠ¥å‘Šå‰å†æ¬¡åˆ›å»ºå¿«ç…§ï¼›éšåä»¥ `## Verification Report` è¿½åŠ åˆ°ç¬”è®°æœ«å°¾ï¼ˆMarkdown ä»…ç”¨äºå‘ˆç°ï¼›åŸå§‹ JSON ä¼šä»¥ä»£ç å—åµŒå…¥ï¼‰ã€‚
- **è¾“å‡º**: ä¿®æ”¹åçš„ç¬”è®°ï¼ˆè¿½åŠ äº†æŠ¥å‘Šï¼‰ã€‚
- **å¯èƒ½å¤±è´¥**: æ¨¡å‹è¶…æ—¶ã€è¾“å‡ºæ ¼å¼ä¸å¯è§£æã€å¿«ç…§åˆ›å»ºå¤±è´¥ã€‚
- **çº¦æŸ**:
  - ä»…è¿½åŠ å†…å®¹ï¼Œä¸ä¿®æ”¹åŸæ–‡ã€‚
  - éœ€è¦é…ç½®å¯ç”¨çš„ Provider/æ¨¡å‹ï¼›è‹¥æ¨¡å‹ä¸å…·å¤‡è”ç½‘èƒ½åŠ›ï¼Œæ ¸æŸ¥å°†é€€åŒ–ä¸ºâ€œåŸºäºæ¨¡å‹çŸ¥è¯†çš„å®¡é˜…â€ã€‚
  - è¿½åŠ é˜¶æ®µå¿«ç…§å¤±è´¥ä¼šå¯¼è‡´ Verify å¤±è´¥ï¼›æ‰‹åŠ¨è§¦å‘çš„é¢„å¿«ç…§å¤±è´¥ä¸ä¼šé˜»æ–­å…¥é˜Ÿã€‚

## 7. Prompt ç³»ç»Ÿ (Prompt Management)
Prompt æ˜¯è¿æ¥ç”¨æˆ·æ„å›¾ä¸ AI è¾“å‡ºçš„æ¡¥æ¢ï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ä»¥æ”¯æŒå¤ç”¨ä¸å¤šè¯­è¨€ã€‚

### 7.1 ç›®å½•ç»“æ„ä¸æ–‡ä»¶ç»„ç»‡
```
prompts/
  _base/
    terminology.md         # ç»Ÿä¸€è¯­è¨€å®šä¹‰
    output-format.md       # è¾“å‡ºæ ¼å¼è§„èŒƒ
    writing-style.md       # å†™ä½œé£æ ¼æŒ‡å—
    anti-patterns.md       # å¸¸è§é”™è¯¯æ¨¡å¼
    operations/
      define.md            # Define æ“ä½œçš„é€šç”¨æŒ‡ä»¤
      tag.md               # Tag æ“ä½œçš„é€šç”¨æŒ‡ä»¤
      write.md             # Write é€šç”¨æ¡†æ¶ï¼ˆå„ç±»å‹è¦†ç›–ï¼‰
      verify.md            # Verifyï¼ˆäº‹å®æ ¸æŸ¥ï¼‰æ“ä½œæŒ‡ä»¤
      merge.md             # Merge æ“ä½œæŒ‡ä»¤
      amend.md             # Amend æ“ä½œæŒ‡ä»¤
  _type/
    domain-core.md         # Domain ç‰¹å®šçš„ Write schema
    issue-core.md
    theory-core.md
    entity-core.md
    mechanism-core.md
  visualize.md             # Visualize / image-generateï¼ˆå›¾åƒç”Ÿæˆï¼‰ä»»åŠ¡æ¨¡æ¿ï¼ˆå½“å‰åœ¨ç”¨ï¼‰
```
> å…¼å®¹æç¤ºï¼šæ ¹ç›®å½•çš„ `prompts/*.md` å¯èƒ½å­˜åœ¨å†å²é—ç•™ï¼ˆå¦‚ `define.md`ã€`write-*.md`ã€`generate-image.md` ç­‰ï¼‰ï¼›è¿è¡Œæ—¶åŠ è½½æ¸…å•ä»¥ `src/core/prompt-manager.ts` çš„ `preloadAllTemplates()` ä¸ºå‡†ï¼Œæœªåœ¨æ¸…å•ä¸­çš„æ¨¡æ¿è§†ä¸º Legacy/ä¸ç”Ÿæ•ˆã€‚

### 7.2 æ¨¡æ¿å—ç»“æ„
æ¯ä¸ª Prompt æ¨¡æ¿åŒ…å«ä»¥ä¸‹å—ï¼ˆ`<task_instruction>` ä¸ `<task>` äºŒé€‰ä¸€ï¼›`<examples>` å¯é€‰ï¼‰ï¼š
```markdown
<system_instructions>
ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œå®šä¹‰ AI çš„è§’è‰²å’Œè¡Œä¸ºè§„èŒƒã€‚
</system_instructions>

<task_instruction>
å…·ä½“ä»»åŠ¡çš„æŒ‡ä»¤ï¼ŒåŒ…å«è¾“å…¥æè¿°å’ŒæœŸæœ›è¾“å‡ºã€‚
</task_instruction>

<context_slots>
è¿è¡Œæ—¶ä¸Šä¸‹æ–‡æ§½ä½ï¼ˆç”±ç³»ç»Ÿæ³¨å…¥ï¼‰ã€‚
</context_slots>

<output_schema>
å®šä¹‰è¾“å‡ºçš„ç»“æ„ï¼ˆé€šå¸¸ä¸º JSON schemaï¼‰ã€‚
</output_schema>

<examples>
ï¼ˆå¯é€‰ï¼‰å…·ä½“ç¤ºä¾‹ã€‚
</examples>
```

### 7.3 æ¨¡æ¿å˜é‡æ³¨å…¥
| å˜é‡ | å€¼æ¥æº | ä½¿ç”¨åœºæ™¯ |
|---|---|---|
| `{{BASE_TERMINOLOGY}}` | `_base/terminology.md` | æ‰€æœ‰ä»»åŠ¡ï¼ˆç¡®ä¿æœ¯è¯­ä¸€è‡´ï¼‰ |
| `{{BASE_OUTPUT_FORMAT}}` | `_base/output-format.md` | æ‰€æœ‰ä»»åŠ¡ï¼ˆJSON æ ¼å¼è§„èŒƒï¼‰ |
| `{{BASE_WRITING_STYLE}}` | `_base/writing-style.md` | Write/Amendï¼ˆæ–‡ç« è´¨é‡ï¼‰ |
| `{{BASE_ANTI_PATTERNS}}` | `_base/anti-patterns.md` | æ‰€æœ‰ä»»åŠ¡ï¼ˆé¿å…å¸¸è§é”™è¯¯ï¼‰ |
| `{{OPERATION_BLOCK}}` | `_base/operations/write.md`ï¼ˆç”± PromptManager æ³¨å…¥ï¼‰ | `_type/*-core.md`ï¼ˆWriteï¼‰ |
| `{{CONCEPT_TYPE}}` | è¿è¡Œæ—¶ä¼ å…¥ | Merge/Amend ç­‰æ“ä½œæ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ |
| `{{CONTEXT}}` | è¿è¡Œæ—¶æå– | Expandï¼ˆç”¨æˆ·ç¬”è®°ä¸Šä¸‹æ–‡ï¼ŒPlannedï¼‰ |
| `{{USER_INSTRUCTION}}` | ç”¨æˆ·è¾“å…¥ | Amendï¼ˆç”¨æˆ·çš„ä¿®è®¢æŒ‡ä»¤ï¼‰ |

### 7.4 æ„å»ºä¸æ ¡éªŒ
> **å”¯ä¸€æ¥æº**ï¼š
> - æ§½ä½/æ‹¼è£…ï¼š`src/core/prompt-manager.ts`ï¼ˆ`TASK_SLOT_MAPPING` / `OPERATION_SLOT_MAPPING`ï¼‰
> - Schemaï¼š`src/core/schema-registry.ts`ï¼ˆWrite ç±»å‹ schemaï¼‰
> - JSON æ ¡éªŒï¼š`src/data/validator.ts`ï¼ˆLLM è¾“å‡ºè§£æä¸æµ…å±‚æ ¡éªŒï¼‰
> - é€šç”¨é™æ€æ ¡éªŒï¼š`src/data/validators.ts`ï¼ˆUUID/æ—¶é—´æˆ³ç­‰åŸºç¡€æ ¡éªŒï¼Œé LLM è¾“å‡ºç®¡çº¿ï¼‰

ä¸å˜é‡ï¼š
- æ„å»ºåä¸å¾—æ®‹ç•™æœªè§£æçš„å ä½ç¬¦ã€‚
- è¾“å‡ºå¿…é¡»æ˜¯ raw JSONï¼ˆæ—  markdown fenceï¼‰ï¼Œä¸”é€šè¿‡å½“å‰å®ç°çš„æµ…å±‚æ ¡éªŒï¼ˆé¡¶å±‚å­—æ®µç±»å‹ + å¿…å¡«å­—æ®µï¼‰ã€‚

### 7.5 è¾“å‡ºæ ¡éªŒè§„åˆ™
- å¿…é¡»æ˜¯åŸå§‹ JSONï¼ˆæ—  markdown fence å¦‚ ` ```json ... ``` `ï¼‰
- æ‰€æœ‰å¿…éœ€å­—æ®µå¿…é¡»å­˜åœ¨
- é¡¶å±‚å­—æ®µç±»å‹å¿…é¡»åŒ¹é… schemaï¼ˆarray/object/primitiveï¼‰
- ç›®å‰ä¸åšï¼šåµŒå¥—å¯¹è±¡é€’å½’æ ¡éªŒã€minLength/minItems/pattern/enum ç­‰çº¦æŸ

## 8. ç´¢å¼•ã€å­˜å‚¨ä¸æ•°æ®ä¸€è‡´æ€§ (Storage & SSOT)
### 8.1 æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€
```
vault/
  â”œâ”€ 1-é¢†åŸŸ/
  â”‚   â”œâ”€ è®¤çŸ¥ç§‘å­¦.md
  â”‚   â””â”€ ...
  â”œâ”€ 2-è®®é¢˜/
  â”œâ”€ 3-ç†è®º/
  â”œâ”€ 4-å®ä½“/
  â”œâ”€ 5-æœºåˆ¶/
  â””â”€ .obsidian/plugins/obsidian-cognitive-razor/
      â””â”€ data/
          â”œâ”€ app.log                    # JSONL æ ¼å¼çš„æ—¥å¿—
          â”œâ”€ queue-state.json           # æŒä¹…åŒ–é˜Ÿåˆ—çŠ¶æ€
          â”œâ”€ pipeline-state.json        # æŒä¹…åŒ–ç®¡çº¿çŠ¶æ€ï¼ˆç”¨äºé‡å¯æ¢å¤ç¡®è®¤é˜¶æ®µï¼‰
          â”œâ”€ duplicate-pairs.json       # é‡å¤å¯¹åˆ—è¡¨
          â”œâ”€ snapshots/
          â”‚   â”œâ”€ index.json             # å¿«ç…§å…ƒæ•°æ®ç´¢å¼•
          â”‚   â”œâ”€ {snapshotId}.json      # å¿«ç…§å†…å®¹
          â”‚   â””â”€ ...
          â””â”€ vectors/
              â”œâ”€ index.json             # å‘é‡ç´¢å¼•å…ƒæ•°æ®
              â”œâ”€ Domain/
              â”‚   â”œâ”€ {cruid}.json       # å•ä¸ªå‘é‡
              â”‚   â””â”€ ...
              â”œâ”€ Issue/
              â”œâ”€ Theory/
              â”œâ”€ Entity/
              â””â”€ Mechanism/
```

### 8.2 å•ä¸€çœŸç†æº (SSOT) æœºåˆ¶
Vault ä¸­çš„ Markdown æ–‡ä»¶ï¼ˆfrontmatter + æ­£æ–‡ï¼‰æ˜¯æºæ•°æ®ï¼ˆSSOTï¼‰ã€‚`CruidCache` / `VectorIndex` / `DuplicateManager` / é˜Ÿåˆ—çŠ¶æ€ç­‰å‡ä¸ºæ´¾ç”Ÿæ•°æ®ï¼šå¯åœ¨éœ€è¦æ—¶æ¸…ç†å¹¶ä» Vault é‡å»º/é‡ç®—ï¼Œç”¨äºæ€§èƒ½ä¸ä¸€è‡´æ€§è¾…åŠ©ã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/core/cruid-cache.ts`

**CruidCache ç»´æŠ¤çš„è§„åˆ™**:
1. ç›‘å¬ Obsidian çš„ `metadataCache.changed` äº‹ä»¶ï¼Œæå– frontmatter ä¸­çš„ `cruid`
2. ç›‘å¬ `vault.rename` å’Œ `vault.delete` äº‹ä»¶ï¼Œæ›´æ–°æ˜ å°„
3. å¦‚æœæ–‡ä»¶è¢«åˆ é™¤ï¼š
   - `VectorIndex.delete(cruid)` æ¸…ç©ºè¯¥ cruid çš„å‘é‡
   - `DuplicateManager.removePairsByNodeId(cruid)` æ¸…ç©ºç›¸å…³é‡å¤å¯¹ï¼ˆä½†ä¿ç•™ `merging` çŠ¶æ€é¿å…ç«æ€æ¡ä»¶ï¼‰
4. å¦‚æœæ–‡ä»¶è¢«é‡å‘½åï¼šä¸éœ€è¦æ›´æ–°ç´¢å¼•å’Œé‡å¤å¯¹ï¼ˆå› ä¸ºå®ƒä»¬åªå­˜å‚¨ cruidï¼‰

### 8.3 å‘é‡ç´¢å¼• (Vector Index)
**å…ƒæ•°æ®** (`data/vectors/index.json`):
> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`VectorIndexMeta` / `ConceptMeta` / `ConceptVector` ç­‰ï¼‰ä¸ `src/core/vector-index.ts`ï¼ˆè¯»å†™/è¿ç§»é€»è¾‘ï¼‰ã€‚

**å‘é‡æ–‡ä»¶** (`data/vectors/{type}/{cruid}.json`):
çº¦æŸè¦ç‚¹ï¼š
- å‘é‡æ–‡ä»¶å¿…é¡»è®°å½• `embeddingModel` ä¸ `dimensions`ï¼Œç”¨äºæ£€æµ‹æ¨¡å‹/ç»´åº¦æ¼‚ç§»å¹¶è§¦å‘é‡ç®—ã€‚

**ç´¢å¼•æ“ä½œ**:
- å¢ï¼šè°ƒç”¨ Embedding æ¨¡å‹ç”Ÿæˆå‘é‡åï¼Œå­˜å‚¨æ–°æ–‡ä»¶å¹¶æ›´æ–°å…ƒæ•°æ®
- åˆ ï¼š`VectorIndex.delete(cruid)` â†’ åˆ é™¤å‘é‡æ–‡ä»¶ + æ›´æ–°å…ƒæ•°æ®
- æ”¹ï¼šé‡æ–°è°ƒç”¨ Embedding æ¨¡å‹ï¼Œè¦†ç›–åŸæ–‡ä»¶
- æŸ¥ï¼šåŠ è½½ç±»å‹å…ƒæ•°æ® â†’ è¯»å–ç›®æ ‡å‘é‡æ–‡ä»¶ â†’ ä¸å…¶ä»–åŒç±»å‘é‡è®¡ç®—ç›¸ä¼¼åº¦

### 8.4 é‡å¤å¯¹ (Duplicate Pair)
> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`DuplicatePair` ç­‰ç±»å‹å®šä¹‰ï¼‰ä¸ `src/core/duplicate-manager.ts`ï¼ˆå­˜å‚¨/çŠ¶æ€æ›´æ–°/è®¢é˜…é€šçŸ¥ï¼‰ã€‚

**ç”Ÿå‘½å‘¨æœŸ**:
1. å»é‡æ£€æµ‹ â†’ ç”Ÿæˆ `pending` çŠ¶æ€é‡å¤å¯¹
2. ç”¨æˆ·é€‰æ‹©èåˆ â†’ çŠ¶æ€è½¬ä¸º `merging`
3. èåˆå®Œæˆ â†’ çŠ¶æ€è½¬ä¸º `merged` æˆ– `dismissed`

**æ¸…ç†**:
- å½“è¢«åˆ  cruid è¢«å½»åº•åˆ é™¤æ—¶ï¼Œåˆ é™¤æ‰€æœ‰æ¶‰åŠè¯¥ cruid çš„é‡å¤å¯¹ï¼ˆä¿ç•™ `merging` ä»¥é¿å…ç«æ€ï¼‰

### 8.5 å¿«ç…§ (Snapshot)
å¿«ç…§ç”¨äºè®°å½•"å˜æ›´å‰"çš„çŠ¶æ€ï¼Œæ”¯æŒå›æ»šã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`SnapshotRecord` / `SnapshotMetadata` / `SnapshotIndex` ç­‰ï¼‰ä¸ `src/core/undo-manager.ts`ï¼ˆåˆ›å»º/æ¢å¤/æ¸…ç†ï¼‰ã€‚

**ç”Ÿæˆç­–ç•¥**:
- **Merge æ“ä½œ**: å¿…é¡»ä¸ºä¸»ä¸è¢«åˆ ç¬”è®°å„åˆ›å»ºå¿«ç…§
- **Amend æ“ä½œ**: å¿…é¡»åˆ›å»ºå¿«ç…§ï¼ˆå†™å…¥å‰ï¼‰
- **Verify æ“ä½œ**: è¿½åŠ æŠ¥å‘Šå‰åˆ›å»ºå¿«ç…§ï¼›æ‰‹åŠ¨ Verify åœ¨å…¥é˜Ÿå‰ä¼šé¢å¤–å°è¯•åˆ›å»ºå¿«ç…§ï¼ˆå¤±è´¥ä¸é˜»æ–­ï¼‰
- **Expand æ“ä½œ**: ä¸åˆ›å»ºå¿«ç…§ï¼ˆæ–°å»ºç¬”è®°ä¸éœ€è¦ï¼‰
- **Define/Tag/Write**: ä¸åˆ›å»ºå¿«ç…§ï¼ˆè‹¥åˆ›å»ºå¤±è´¥å¯åˆ é™¤æ–‡ä»¶ï¼‰
- **Visualize æ“ä½œ**: ä¸åˆ›å»ºå¿«ç…§ï¼ˆåˆ é™¤å›¾ç‰‡é™„ä»¶å³å¯å›é€€ï¼‰

**ä¿ç•™ç­–ç•¥**:
- é…ç½® `maxSnapshots` (é»˜è®¤ 100) å’Œ `maxSnapshotAgeDays` (é»˜è®¤ 30)
- å®šæœŸæ¸…ç†è¿‡æœŸæˆ–è¶…é¢çš„å¿«ç…§

**æ¢å¤æµç¨‹**:
1. ç”¨æˆ·é€‰æ‹©æ¢å¤æŸä¸ªå¿«ç…§
2. ç³»ç»Ÿä½¿ç”¨"åŸå­å†™"ï¼ˆå†™åˆ°ä¸´æ—¶æ–‡ä»¶ + åŸå­é‡å‘½åï¼‰ä¿è¯ä¸€è‡´æ€§
3. é‡æ–°ç”Ÿæˆå‘é‡ç´¢å¼•

## 9. ä»»åŠ¡é˜Ÿåˆ—ä¸ç®¡çº¿ (Task Queue & Pipeline)
### 9.1 ä»»åŠ¡é˜Ÿåˆ—æ¨¡å‹ï¼ˆé˜²æ¼‚ç§»ï¼‰
> **å”¯ä¸€æ¥æº**ï¼š
> - ç±»å‹ï¼š`src/types.ts`ï¼ˆ`TaskRecord` / `TaskState` / `QueueStateFile` / `TaskError`ï¼‰
> - æŒä¹…åŒ–ï¼š`src/core/task-queue-store.ts`
> - è°ƒåº¦/çŠ¶æ€æœº/é”ï¼š`src/core/task-queue.ts`ã€`src/core/lock-manager.ts`

ä¸å˜é‡ï¼š
- æŒä¹…åŒ–æ–‡ä»¶ï¼š`data/queue-state.json` æŒä¹…åŒ– `pendingTasks` + `paused` + `version`ï¼›ä¿å­˜æ—¶ `pendingTasks` åŒ…å« Pending + Runningï¼Œæ¢å¤æ—¶ç»Ÿä¸€è§†ä¸º Pendingã€‚
- å¯åŠ¨æ¢å¤ï¼šè‹¥å­˜åœ¨ `pendingTasks`ï¼Œå¼ºåˆ¶ `paused=true`ï¼Œä¸ä¼šè‡ªåŠ¨è°ƒåº¦ï¼ˆéœ€ç”¨æˆ·æ˜¾å¼ `resume`ï¼‰ã€‚
- å…¥é˜Ÿä¸é”ï¼šå…¥é˜Ÿä¸ä¼šå› é”å†²çªå¤±è´¥ï¼›è°ƒåº¦é˜¶æ®µè·å– NodeLockï¼Œä»…å½“ä»»åŠ¡æ˜¾å¼è®¾ç½® `typeLockKey` æ—¶è·å– TypeLockï¼ˆå½“å‰ä»»åŠ¡æœªä½¿ç”¨ï¼‰ã€‚

### 9.2 ç®¡çº¿åè°ƒå™¨ (PipelineOrchestrator)
> **å”¯ä¸€æ¥æº**ï¼š`src/core/pipeline-orchestrator.ts`

èŒè´£ä¸å…¥å£ï¼ˆè¯­ä¹‰å±‚ï¼Œä¸æ‰‹æŠ„ç­¾åï¼‰ï¼š
- Createï¼šUI å…ˆ `defineDirect()` å–å¾— Define ç»“æœï¼ˆç±»å‹ç½®ä¿¡åº¦ + æ ‡å‡†åï¼‰ï¼Œç”¨æˆ·é€‰æ‹©ç±»å‹åå† `startCreatePipelineWithStandardized(...)` å…¥é˜Ÿåç»­ä»»åŠ¡ï¼›Tag å®Œæˆåè‡ªåŠ¨åˆ›å»º Stub å¹¶ç»§ç»­ Write â†’ Index â†’ Deduplicateï¼ˆæ— æ˜¾å¼ç”¨æˆ·ç¡®è®¤ï¼‰ã€‚
- Mergeï¼š`startMergePipeline(...)` åˆ›å»ºå¿«ç…§å¹¶å…¥é˜Ÿ `merge` ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåè¿›å…¥ `review_changes`ï¼Œç”¨æˆ·ç¡®è®¤å `confirmWrite()` è½ç›˜ã€‚
- Amendï¼š`startAmendPipeline(...)` åˆ›å»ºå¿«ç…§å¹¶å…¥é˜Ÿ `amend` ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåè¿›å…¥ `review_changes`ï¼Œç”¨æˆ·ç¡®è®¤å `confirmWrite()` è½ç›˜ã€‚
- äº‹ä»¶ï¼šé€šè¿‡ `subscribe()` å‘å¸ƒ pipeline äº‹ä»¶ï¼›UI åœ¨ `src/ui/workbench-panel.ts` è®¢é˜…å¹¶é©±åŠ¨é¢„è§ˆ/é€šçŸ¥ã€‚
- æŒä¹…åŒ–ï¼šé€šè¿‡ `src/core/pipeline-state-store.ts` å†™å…¥ `data/pipeline-state.json`ï¼Œç”¨äºé‡å¯åæ¢å¤ç®¡çº¿ä¸Šä¸‹æ–‡ï¼ˆå°¤å…¶æ˜¯ç¡®è®¤é˜¶æ®µï¼‰ã€‚

### 9.3 ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
- å…¥é˜Ÿ â†’ Pending
- è‹¥ `paused`ï¼šä¿æŒ Pending
- è°ƒåº¦å™¨æ‰«æå¯è¿è¡Œä»»åŠ¡ï¼š
  - è·å– NodeLockï¼›è‹¥ä»»åŠ¡æ˜¾å¼è®¾ç½® `typeLockKey` åˆ™è·å– TypeLock
  - æ ‡è®° Runningï¼Œè°ƒç”¨ `TaskRunner.run()`
  - æˆåŠŸï¼šCompletedï¼ˆé‡Šæ”¾é”ï¼‰
  - å¤±è´¥ï¼š
    - è‹¥å¯é‡è¯•ï¼šPendingï¼ˆattempt++ï¼Œé‡Šæ”¾é”ï¼‰
    - å¦åˆ™ï¼šFailedï¼ˆé‡Šæ”¾é”ï¼‰
- å‘å¸ƒé˜Ÿåˆ—äº‹ä»¶ï¼Œé©±åŠ¨ UI æ›´æ–°

### 9.4 å¹¶å‘é” (Locking)
> **å”¯ä¸€æ¥æº**ï¼š`src/core/lock-manager.ts`ï¼ˆ`SimpleLockManager`ï¼‰ä¸ `src/core/task-queue.ts`ï¼ˆè°ƒåº¦è·å–/é‡Šæ”¾ï¼‰ã€‚

è¯­ä¹‰ï¼š
- **NodeLock**ï¼šåŒä¸€ `cruid` çš„å†™å…¥äº’æ–¥ï¼ˆå¿…éœ€ï¼‰ã€‚
- **TypeLock**ï¼šä»»åŠ¡æ˜¾å¼è®¾ç½® `typeLockKey` æ—¶æ‰è·å–ï¼›å½“å‰é˜Ÿåˆ—ä»»åŠ¡æœªä½¿ç”¨è¯¥å­—æ®µï¼Œå»é‡æ£€æµ‹ç”± `DuplicateManager` ç›´æ¥åœ¨ `SimpleLockManager` ä¸Šè·å– `type:${CRType}` é”ï¼ˆæœ€ä½³åŠªåŠ›ï¼‰ã€‚

### 9.5 é‡è¯•ç­–ç•¥
> **å”¯ä¸€æ¥æº**ï¼š`src/core/retry-handler.ts`ï¼ˆé”™è¯¯åˆ†ç±»ä¸å»ºè®®ç­–ç•¥ï¼‰ä¸ `src/core/task-queue.ts`ï¼ˆåº”ç”¨ç­–ç•¥ï¼‰ã€‚

ä¸å˜é‡ï¼š
- ç”±è®¾ç½® `autoRetry` æ§åˆ¶æ˜¯å¦è‡ªåŠ¨é‡è¯•ï¼›é‡è¯•æ¬¡æ•°ä¸Šé™ç”±é”™è¯¯åˆ†ç±»å»ºè®®ä¸ä»»åŠ¡ `maxAttempts` å…±åŒå†³å®šã€‚
- å½“å‰å®ç°ä¸å¼•å…¥æ˜¾å¼ backoffï¼›å¦‚éœ€èŠ‚æµåº”åœ¨ RetryHandler/è°ƒåº¦å±‚å¼•å…¥å¹¶é…å¥—æµ‹è¯•ã€‚

## 10. é”™è¯¯å¤„ç†ä¸æ¢å¤ (Error Handling & Recovery)
### 10.1 Result Monad
æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½è¿”å› `Result<T, E>` ç±»å‹ï¼Œç¦æ­¢æŠ›å‡ºæœªæ•è·å¼‚å¸¸ã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`Result` / `ok()` / `err()` / `CognitiveRazorError` / `toErr()`ï¼‰ã€‚

çº¦æŸï¼š
- ä¸šåŠ¡å±‚ä¸å¾—æŠ›å‡ºæœªæ•è·å¼‚å¸¸ï¼›è¾¹ç•Œå¤„å°†å¼‚å¸¸è½¬æ¢ä¸º `Result` æˆ–è®°å½•æ—¥å¿—ã€‚
- åŒæ­¥è·¯å¾„å…è®¸æŠ›å‡º `CognitiveRazorError`ï¼ˆæºå¸¦é”™è¯¯ç ï¼‰ï¼›å¿…é¡»åœ¨å¼‚æ­¥/è¾¹ç•Œå¤„æ•è·å¹¶é€šè¿‡ `toErr()` å½’ä¸€åŒ–ã€‚

**é”™è¯¯ç å‰ç¼€è§„èŒƒ**:
| å‰ç¼€ | èŒƒå›´ | å«ä¹‰ | å¯é‡è¯• |
|---|---|---|---|
| E1xx | E101-E199 | è¾“å…¥/éªŒè¯é”™è¯¯ | âœ— ä¸å¯é‡è¯• |
| E2xx | E201-E299 | Provider/AI é”™è¯¯ | âœ“ å¯é‡è¯• |
| E3xx | E301-E399 | ç³»ç»Ÿ/IO/çŠ¶æ€é”™è¯¯ | â–³ è§†æƒ…å†µ |
| E4xx | E401-E499 | é…ç½®é”™è¯¯ | âœ— ä¸å¯é‡è¯• |
| E5xx | E501-E599 | å†…éƒ¨é”™è¯¯/BUG | â–³ è§†æƒ…å†µ |

**å…·ä½“é”™è¯¯ç ç¤ºä¾‹**ï¼ˆéç©·ä¸¾ï¼‰:
- `E101_INVALID_INPUT`: è¾“å…¥æ ¼å¼é”™è¯¯æˆ–æ— æ•ˆ
- `E102_MISSING_FIELD`: å¿…éœ€å­—æ®µç¼ºå¤±
- `E211_MODEL_SCHEMA_VIOLATION`: æ¨¡å‹è¾“å‡ºä¸ç¬¦åˆ Schema
- `E201_PROVIDER_TIMEOUT`: AI æä¾›å•†è¶…æ—¶
- `E202_RATE_LIMITED`: è§¦å‘é€Ÿç‡é™åˆ¶ï¼ˆ429ï¼‰
- `E203_INVALID_API_KEY`: API å¯†é’¥æ— æ•ˆ
- `E301_FILE_NOT_FOUND`: æ–‡ä»¶ä¸å­˜åœ¨
- `E302_PERMISSION_DENIED`: æ²¡æœ‰æ–‡ä»¶æ“ä½œæƒé™
- `E303_DISK_FULL`: ç£ç›˜ç©ºé—´ä¸è¶³
- `E304_SNAPSHOT_FAILED`: å¿«ç…§åˆ›å»ºå¤±è´¥
- `E305_VECTOR_MISMATCH`: å‘é‡ç»´åº¦ä¸åŒ¹é…
- `E310_INVALID_STATE`: çŠ¶æ€ä¸åˆæ³•/æœªåˆå§‹åŒ–
- `E311_NOT_FOUND`: èµ„æº/ä»»åŠ¡/ç®¡çº¿ä¸å­˜åœ¨
- `E320_TASK_CONFLICT`: åŒä¸€èŠ‚ç‚¹å­˜åœ¨å†²çªä»»åŠ¡
- `E404_TEMPLATE_NOT_FOUND`: Prompt æ¨¡æ¿ç¼ºå¤±
- `E405_TEMPLATE_INVALID`: Prompt æ¨¡æ¿ç»“æ„/å ä½ç¬¦é”™è¯¯
- `E401_PROVIDER_NOT_CONFIGURED`: Provider æœªé…ç½®
- `E500_INTERNAL_ERROR`: å†…éƒ¨ç¨‹åºé”™è¯¯

### 10.2 é”™è¯¯é€šçŸ¥
UI å±‚ç»Ÿä¸€ä½¿ç”¨ `WorkbenchPanel.showErrorNotice()` å±•ç¤ºé”™è¯¯ã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/ui/workbench-panel.ts`ï¼ˆ`showErrorNotice()`ï¼‰ä¸ `src/ui/workbench/workbench-section-deps.ts`ï¼ˆä¾èµ–æ³¨å…¥ï¼‰ã€‚

**é€šçŸ¥è§„åˆ™**:
- ğŸ”´ **Error** (6000ms): æ“ä½œå¤±è´¥ï¼Œç”¨æˆ·éœ€è¦æ„ŸçŸ¥
- ğŸŸ¡ **Warning** (4000ms): å¯èƒ½æœ‰é—®é¢˜ä½†ä¸é˜»å¡
- ğŸŸ¢ **Info** (2000ms): æ­£å¸¸æ“ä½œç»“æœ

### 10.3 æ—¥å¿—è®°å½•
æ—¥å¿—é‡‡ç”¨ JSONL æ ¼å¼ï¼Œä¾¿äºåç»­åˆ†æã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/data/logger.ts`ï¼ˆ`LogEntry` / `Logger`ï¼‰ã€‚

**æ—¥å¿—çº§åˆ«é…ç½®** (`settings.logLevel`):
- `debug`: æ‰€æœ‰ç»†èŠ‚ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- `info`: é‡è¦æ“ä½œï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- `warn`: å¼‚å¸¸è­¦å‘Š
- `error`: é”™è¯¯

### 10.4 æ¢å¤æœºåˆ¶
| æ•…éšœåœºæ™¯ | æ¢å¤ç­–ç•¥ |
|---|---|
| **AI è°ƒç”¨è¶…æ—¶** | ç”± `RetryHandler` åˆ†ç±»ä¸ºå¯é‡è¯•æ—¶è‡ªåŠ¨é‡è¯•ï¼ˆattempt++ï¼Œä¸Šé™ç”±åˆ†ç±»ä¸ `maxAttempts` å†³å®šï¼‰ï¼›å¦åˆ™æ ‡è®°ä¸º Failed |
| **æ–‡ä»¶è¢«å¤–éƒ¨ä¿®æ”¹** | å¯¹ Amend/Merge çš„ç¡®è®¤å†™å…¥é˜¶æ®µï¼Œæ¯”è¾ƒâ€œDiff é¢„è§ˆåŸºçº¿å†…å®¹â€ä¸â€œç¡®è®¤æ—¶å½“å‰æ–‡ä»¶å†…å®¹â€ï¼Œä¸ä¸€è‡´åˆ™ä¸­æ­¢å†™å…¥å¹¶æç¤ºç”¨æˆ·é‡æ–°ç”Ÿæˆ Diffï¼ˆé¿å…è¦†ç›–/è¯¯åˆ ï¼‰ |
| **å¿«ç…§åˆ›å»ºå¤±è´¥** | æ“ä½œè¢«ä¸­æ­¢ï¼Œç”¨æˆ·æ”¶åˆ°é€šçŸ¥ |
| **å‘é‡ç”Ÿæˆå¤±è´¥** | ä»»åŠ¡é‡è¯•ï¼Œä»å¤±è´¥åˆ™æ¦‚å¿µæ—  embeddingï¼ˆå¯æ‰‹åŠ¨é‡è¯•ï¼‰ |
| **é˜Ÿåˆ—çŠ¶æ€æŸå** | é‡å¯æ—¶æ£€æµ‹ queue-state.json å®Œæ•´æ€§ï¼ŒæŸååˆ™æ¸…ç©ºé˜Ÿåˆ— |
| **Vault è¢«å¤–éƒ¨åˆ é™¤** | ç›‘å¬å™¨æ£€æµ‹åˆ° delete äº‹ä»¶ï¼Œæ›´æ–° CruidCache å’Œç´¢å¼• |

### 10.5 è°ƒè¯•ä¸æ”¯æŒ
Plannedï¼ˆM4ï¼‰ï¼šæä¾›â€œå¯¼å‡ºè¯Šæ–­ä¿¡æ¯â€å‘½ä»¤ï¼Œè¾“å‡ºæœ€å°åŒ–çš„å¯åˆ†äº«ä¿¡æ¯ï¼ˆç‰ˆæœ¬ã€è®¾ç½®æ‘˜è¦ã€é˜Ÿåˆ—ç»Ÿè®¡ã€æ—¥å¿—è·¯å¾„ä¸æœ€è¿‘é”™è¯¯ï¼‰ã€‚

## 11. UI/UX è®¾è®¡è§„èŒƒ (UI/UX Standards)
### 11.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™
- **ç®€æ´**: æœ€å°‘åŒ– UI å…ƒç´ ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
- **æ— å¹²æ‰°**: åå°ä»»åŠ¡ä¸ä¸­æ–­ç”¨æˆ·å·¥ä½œæµ
- **é”®ç›˜å‹å¥½**: æ‰€æœ‰ä¸»è¦æ“ä½œæ”¯æŒå¿«æ·é”®
- **å¯è®¿é—®**: éµå¾ª WAI-ARIA æ ‡å‡†ï¼Œæ”¯æŒå±å¹•é˜…è¯»å™¨

### 11.2 Workbench é¢æ¿å¸ƒå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ Cognitive Razor Workbench                 â”‚ [Settings]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Create New Concept                        â”‚ [+]
â”‚ Input: [________________]                   â”‚
â”‚ [Define] [Clear Input]                      â”‚
â”‚ [Amend] [Expand] [Visualize] [Verify]       â”‚ (æœ‰æ´»è·ƒç¬”è®°æ—¶æ˜¾ç¤º)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”— Duplicate Concepts                        â”‚ [â–¼]
â”‚ â€¢ "Concept A" vs "Concept B" (0.92 sim)     â”‚
â”‚ â€¢ ...                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â³ Queue Status                              â”‚ [â–¼]
â”‚ Running: Define (Task #1)                   â”‚
â”‚ Pending: 3 tasks                            â”‚
â”‚ [â¸ Pause]                                  â”‚
â”‚ Details: [Retry Failed] [Clear Pending] ... â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š Recent Operations                         â”‚ [â–¼]
â”‚ â€¢ Merge: A + B â†’ A (5 min ago)              â”‚
â”‚ â€¢ Amend: C (10 min ago)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é»˜è®¤æŠ˜å **:
- åˆ›å»ºåŒºã€é‡å¤åŒºæ€»æ˜¯å±•å¼€ï¼ˆä¸»æ“ä½œï¼‰
- é˜Ÿåˆ—ã€å†å²åŒºé»˜è®¤æŠ˜å ï¼ˆè¾…åŠ©ä¿¡æ¯ï¼‰
- å½“å‰ç¬”è®°æ“ä½œæŒ‰é’®ä½äºåˆ›å»ºåŒºåº•éƒ¨ï¼šä»…å½“æœ‰æ´»è·ƒç¬”è®°æ—¶æ˜¾ç¤º
- åˆ›å»ºåŒºæä¾›â€œæ¸…ç©ºè¾“å…¥â€ä»¥å¤ä½è¾“å…¥ä¸ç±»å‹å€™é€‰
- é˜Ÿåˆ—è¯¦æƒ…æä¾›æ‰¹é‡æ“ä½œï¼šé‡è¯•å¤±è´¥ã€æ¸…é™¤å¾…å¤„ç†/å·²å®Œæˆ/å¤±è´¥

### 11.3 Diff View è®¾è®¡ï¼ˆå½“å‰å®ç°ï¼‰
å±•ç¤º"åŸ â†’ æ”¹"çš„å¯¹æ¯”ï¼Œæ‰€æœ‰ç ´åæ€§æ“ä½œå‰å¿…é¡»ç¡®è®¤ã€‚å½“å‰å®ç°ä»¥ç»Ÿä¸€è¡Œçº§ diff ä¸ºä¸»ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§¾ Diff Preview â€” Amend: "Domain X"          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - The study of...                            â”‚
â”‚ + The study of cognition...                  â”‚
â”‚ ...                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [æ¥å—] [æ”¾å¼ƒ]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§**:
- ç»Ÿä¸€è¡Œçº§ diffï¼ˆ`SimpleDiffView`ï¼‰ï¼Œç”¨äº Amend/Merge/ç¡®è®¤å†™å…¥
- Side-by-Side è§†å›¾ç”± `renderSideBySideDiff` / `MergeDiffModal` / `DiffView` æä¾›ï¼Œä½†å½“å‰æœªæ¥å…¥ä¸»æµç¨‹
- å½“å‰ä¸å±•ç¤ºâ€œè‡ªåŠ¨å¿«ç…§å·²å¯ç”¨â€å¾½ç« 



### 11.4 Modal ä¸å¼¹çª—
| Modal | ç”¨é€” | äº¤äº’ |
|---|---|---|
| `SimpleInputModal` | å•è¡Œè¾“å…¥ï¼ˆåˆ›å»ºæ¦‚å¿µ/ä¿®è®¢æŒ‡ä»¤ï¼‰ | æ–‡æœ¬è¾“å…¥ + ç¡®è®¤/å–æ¶ˆ |
| `SimpleDiffView` | å˜æ›´é¢„è§ˆï¼ˆç»Ÿä¸€è¡Œçº§ diffï¼‰ | æ¥å—/æ”¾å¼ƒ |
| `MergeNameSelectionModal` | åˆå¹¶åç§°ä¸ä¸»ä½“é€‰æ‹© | é€‰é¡¹é€‰æ‹© + ç¡®è®¤/å–æ¶ˆ |
| `DuplicatePreviewModal` | é‡å¤å¯¹é¢„è§ˆä¸åˆå¹¶/å¿½ç•¥ | é¢„è§ˆ + åˆå¹¶/å¿½ç•¥ |
| `MergeHistoryModal` | é‡å¤å¯¹å†å²ï¼ˆåˆå¹¶/å¿½ç•¥ï¼‰ | æ ‡ç­¾é¡µåˆ‡æ¢ + æ“ä½œ |
| `ConfirmDialog` | é‡å¤å¯¹åˆ é™¤ç¡®è®¤ | ç¡®è®¤/å–æ¶ˆ |
| `ExpandModal` | å±‚çº§æ‹“å±•å€™é€‰é€‰æ‹© | å‹¾é€‰ + æ‰¹é‡æ“ä½œ |
| `AbstractExpandModal` | æŠ½è±¡æ‹“å±•å€™é€‰é€‰æ‹© | å‹¾é€‰ + ç¡®è®¤/å–æ¶ˆ |
| `VisualizationModal` | ç”Ÿæˆå›¾ç‰‡æè¿° | æ–‡æœ¬è¾“å…¥ + é¢„è§ˆ/ç¡®è®¤ |
| `SnapshotDiffModal` | å¿«ç…§é¢„è§ˆ/æ¢å¤ | æŸ¥çœ‹å·®å¼‚ + æ¢å¤ |
| `ConfirmModal` | é€šç”¨ç¡®è®¤å¯¹è¯æ¡† | ç¡®è®¤/å–æ¶ˆ |
| `ProviderConfigModal` | Provider é…ç½® | è¡¨å•è¾“å…¥ + ä¿å­˜/å–æ¶ˆ |

**è®¾è®¡è§„èŒƒ**:
- ä½¿ç”¨ `AbstractModal` åŸºç±»ï¼Œç»Ÿä¸€æ ·å¼
- æ‰€æœ‰ icon é€šè¿‡ `setIcon()` ä½¿ç”¨ Obsidian ä¸»é¢˜
- æ ‡é¢˜ + å†…å®¹ + æ“ä½œæŒ‰é’® çš„æ ‡å‡†å¸ƒå±€
- æ”¯æŒ Escape å¿«é€Ÿå…³é—­ï¼ˆéç ´åæ€§æ“ä½œï¼‰

### 11.5 æ ·å¼æŒ‡å—
- **Scope**: `.cr-scope` ä½œä¸ºå˜é‡ä½œç”¨åŸŸï¼Œä¸»é¢æ¿/Modal/Notice ä¼šæ·»åŠ è¯¥ç±»ï¼›æ ·å¼é€‰æ‹©å™¨ä»¥ `.cr-` å‰ç¼€ä¸ºä¸»ï¼Œä¸å¼ºåˆ¶åµŒå¥—åœ¨ `.cr-scope` å†…
- **ä¸»é¢˜å˜é‡**: ä»…ä½¿ç”¨ Obsidian ä¸»é¢˜å˜é‡
  - `--text-normal`, `--text-muted`, `--text-error`
  - `--interactive-normal`, `--interactive-hover`
  - `--background-primary`, `--background-secondary`
- **ç¦æ­¢ç¡¬ç¼–ç é¢œè‰²** å’Œ `!important`
- **ç±»åå‰ç¼€**: æ‰€æœ‰ç±»åä»¥ `cr-` å¼€å¤´

```css
.cr-scope {
  --local-accent: var(--interactive-accent);
}

.cr-button-primary {
  background-color: var(--interactive-normal);
  color: var(--text-normal);
}

.cr-button-primary:hover {
  background-color: var(--interactive-hover);
}
```

### 11.6 æ— éšœç¢ (Accessibility)
- **é”®ç›˜å¯¼èˆª**: Tab é¡ºåºåˆç†ï¼Œç„¦ç‚¹å¯è§
- **ARIA æ ‡ç­¾**: æ‰€æœ‰äº¤äº’å…ƒç´ æœ‰ `aria-label` æˆ– `aria-labelledby`
- **Modal**: `role="dialog"` + `aria-modal="true"` + `aria-labelledby`
- **å¿«æ·é”®**: ä¸»è¦æ“ä½œæ”¯æŒ Enter/Space è§¦å‘
- **è¿åŠ¨æ•æ„Ÿ**: å°Šé‡ `prefers-reduced-motion` åª’ä½“æŸ¥è¯¢
  - åŠ è½½åŠ¨ç”»åœ¨ reduce æ¨¡å¼ä¸‹æä¾›é™æ€æ›¿ä»£
  - è¿›åº¦æ¡ç”¨ç™¾åˆ†æ¯”æ–‡å­—æ›¿ä»£åŠ¨ç”»

### 11.7 å›½é™…åŒ– (i18n)
æ”¯æŒä¸­æ–‡ (zh) å’Œè‹±æ–‡ (en)ã€‚

> **å”¯ä¸€æ¥æº**ï¼š`src/core/i18n.ts`ï¼ˆ`I18n` ç±»ã€`Translations` ç»“æ„ã€`formatMessage()`ï¼‰ã€‚

çº¦æŸä¸ä½¿ç”¨æ–¹å¼ï¼š
- UI é€šè¿‡ `plugin.getI18n().t()` è·å–å½“å‰è¯­è¨€çš„ `Translations` å¯¹è±¡ã€‚
- è¯­è¨€åˆ‡æ¢é€šè¿‡ `plugin.getI18n().setLanguage("zh" | "en")` å®Œæˆã€‚
- éœ€è¦æ’å€¼æ—¶ä½¿ç”¨ `formatMessage()`ï¼ˆä¾‹å¦‚ `"å·²å®Œæˆ {count} é¡¹"` â†’ `formatMessage(template, { count })`ï¼‰ã€‚

## 12. å‘½ä»¤ç³»ç»Ÿ (Command System)
### 12.1 å‘½ä»¤åˆ—è¡¨
> **å”¯ä¸€æ¥æº**ï¼š`src/ui/command-utils.ts`ï¼ˆ`COMMAND_IDS`ï¼‰ä¸ `src/ui/command-dispatcher.ts`ï¼ˆå®é™…æ³¨å†Œï¼‰ã€‚æœ¬æ–‡åªç»´æŠ¤è¯­ä¹‰ä¸å®ç°çŠ¶æ€ã€‚

| å‘½ä»¤ ID | åç§° | å®ç°çŠ¶æ€ | è¯´æ˜ | å…¥å£ |
|---|---|---|---|---|
| `cognitive-razor:open-workbench` | æ‰“å¼€å·¥ä½œå° | Implemented | æ‰“å¼€ Workbench é¢æ¿ | CommandDispatcher |
| `cognitive-razor:create-concept` | åˆ›å»ºæ¦‚å¿µ | Implemented | æ‰“å¼€è¾“å…¥æ¡†å¹¶è¿›å…¥ Create æµç¨‹ | Workbench |
| `cognitive-razor:improve-note` | ä¿®è®¢å½“å‰ç¬”è®° | Implemented | å¯åŠ¨ Amend æµç¨‹ï¼ˆDiff ç¡®è®¤åè½ç›˜ï¼‰ | Editor/FileMenu |
| `cognitive-razor:merge-duplicates` | åˆå¹¶é‡å¤å¯¹ | Implemented | å¯¹é€‰ä¸­é‡å¤å¯¹å¯åŠ¨ Merge æµç¨‹ | Workbench |
| `cognitive-razor:expand-current-note` | æ‹“å±•å½“å‰ç¬”è®° | Implemented | å¯¹å½“å‰ç¬”è®°ç”Ÿæˆæ‹“å±•å€™é€‰å¹¶æ‰¹é‡åˆ›å»º | Editor |
| `cognitive-razor:insert-image` | æ’å…¥å›¾ç‰‡ | Implemented | åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå›¾ç‰‡å¹¶æ’å…¥ | Editor |
| `cognitive-razor:verify-current-note` | äº‹å®æ ¸æŸ¥å½“å‰ç¬”è®° | Implemented | å¯¹å½“å‰ç¬”è®°å¯åŠ¨ Verify æµç¨‹ï¼ˆæŠ¥å‘Šè¿½åŠ åˆ°ç¬”è®°æœ«å°¾ï¼‰ | Editor/Workbench |
| `cognitive-razor:view-duplicates` | æŸ¥çœ‹é‡å¤æ¦‚å¿µ | Implemented | æ‰“å¼€å¹¶å®šä½åˆ° Duplicates åŒºåŸŸ | Workbench |
| `cognitive-razor:pause-queue` | æš‚åœé˜Ÿåˆ— | Implemented | æš‚åœè°ƒåº¦ï¼ˆä¸å–æ¶ˆä»»åŠ¡ï¼‰ | Workbench |
| `cognitive-razor:resume-queue` | æ¢å¤é˜Ÿåˆ— | Implemented | æ¢å¤è°ƒåº¦ï¼ˆéœ€è¦æ˜¾å¼æ“ä½œï¼‰ | Workbench |
| `cognitive-razor:clear-queue` | æ¸…ç©ºé˜Ÿåˆ— | Implemented | å–æ¶ˆæ‰€æœ‰ Pending ä»»åŠ¡ | Workbench |
| `cognitive-razor:view-operation-history` | æŸ¥çœ‹æ“ä½œå†å² | Implemented | æ‰“å¼€å†å²åˆ—è¡¨ï¼ˆå¿«ç…§/æ’¤é”€ç›¸å…³ï¼‰ | Workbench |
| `cognitive-razor:retry-failed` | é‡è¯•å¤±è´¥ä»»åŠ¡ | Implemented | å°† Failed ä»»åŠ¡é‡ç½®ä¸º Pending å¹¶é‡æ–°è°ƒåº¦ | StatusBadge / CommandDispatcher |

### 12.2 å‘½ä»¤äº¤äº’çº¦å®š
- **å…¥å£**: å‘½ä»¤é¢æ¿ (Ctrl/Cmd+P)
- **å¿«æ·é”®**: ç”¨æˆ·è‡ªé…ç½®ï¼Œæ’ä»¶ä¸é¢„è®¾ï¼ˆé¿å…å†²çªï¼‰
- **ä¸Šä¸‹æ–‡èœå•**: ç¼–è¾‘å™¨å³é”®èœå•æ”¯æŒå½“å‰ç¬”è®°ç›¸å…³å‘½ä»¤ï¼ˆå¦‚ `cognitive-razor:improve-note`ï¼‰
- **è§¦å‘æ¡ä»¶**: 
  - `cognitive-razor:improve-note` / `cognitive-razor:expand-current-note` ä»…å½“ç¼–è¾‘å™¨æœ‰æ´»è·ƒç¬”è®°æ—¶å¯ç”¨
  - å…¶ä»–å‘½ä»¤å¯å…¨å±€ä½¿ç”¨

### 12.3 å‘½ä»¤å›è°ƒç¤ºä¾‹
å‘½ä»¤æ³¨å†Œä¸åˆ†å‘ç”± `CommandDispatcher` ç»Ÿä¸€å¤„ç†ï¼š
- æ³¨å†Œå…¥å£ï¼š`src/ui/command-dispatcher.ts`ï¼ˆ`registerAllCommands()`ï¼‰
- ID å¸¸é‡ï¼š`src/ui/command-utils.ts`ï¼ˆ`COMMAND_IDS`ï¼‰
- æ’ä»¶è£…é…ï¼š`main.ts` çš„ `registerCommands()` è°ƒç”¨ `CommandDispatcher.registerAllCommands()`


## 13. é…ç½®ä¸æ‰©å±• (Configuration & Extension)
### 13.1 æ’ä»¶è®¾ç½®æ¥å£
> **å”¯ä¸€æ¥æº**ï¼š`src/types.ts`ï¼ˆ`PluginSettings` / `ProviderConfig` / `TaskModelConfig` ç­‰ï¼‰ä¸ `src/data/settings-store.ts`ï¼ˆ`DEFAULT_SETTINGS` ä¸æ ¡éªŒ/åˆå¹¶é€»è¾‘ï¼‰ã€‚  
æœ¬æ–‡åªæè¿°å…³é”®è¯­ä¹‰ä¸çº¦æŸï¼š
- **è¯­è¨€**ï¼š`zh | en`ï¼Œå½±å“ i18n ä¸ Prompt çš„ `CTX_LANGUAGE`ã€‚
- **ç›®å½•/å‘½å**ï¼š`directoryScheme` ä¸ `namingTemplate` æ§åˆ¶è½ç›˜è·¯å¾„ä¸æ ‡é¢˜æ¸²æŸ“ï¼ˆè§ `src/core/naming-utils.ts`ï¼‰ã€‚
- **é˜Ÿåˆ—**ï¼š`concurrency`/`taskTimeoutMs`/`autoRetry`/`maxRetryAttempts`/`maxTaskHistory` æ§åˆ¶è°ƒåº¦ã€é‡è¯•ä¸å†å²è£å‰ªï¼ˆè§ `src/core/task-queue.ts`ï¼‰ã€‚
- **å‘é‡**ï¼š`embeddingDimension` å¿…é¡»ä¸å‘é‡æ–‡ä»¶å…ƒæ•°æ®ä¸€è‡´ï¼ˆè§ `src/core/vector-index.ts` ä¸ `ConceptVector.metadata.dimensions`ï¼‰ã€‚
- **Provider**ï¼š`providers`/`defaultProviderId`/`providerTimeoutMs` æ§åˆ¶ LLM/Embedding/Image è¯·æ±‚ï¼ˆè§ `src/core/provider-manager.ts`ï¼‰ã€‚

### 13.2 è®¾ç½®é¢æ¿
Settings Tab åˆ†ä¸ºä»¥ä¸‹éƒ¨åˆ†ï¼š

**1. åŸºç¡€é…ç½®**
- è¯­è¨€é€‰æ‹©
- ç›®å½•æ–¹æ¡ˆè®¾ç½®
- å¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´

**2. Provider ç®¡ç†**
- æ·»åŠ /åˆ é™¤ Provider
- API Key é…ç½®
- é»˜è®¤ Provider é€‰æ‹©
- è¿æ¥æµ‹è¯•

**3. æ¨¡å‹é…ç½®**
- ä¸ºå„ä»»åŠ¡é€‰æ‹© Chat æ¨¡å‹å’Œ Embed æ¨¡å‹
- æ”¯æŒå•é¡¹é…ç½®æˆ–å…¨é‡é‡ç½®
- å¯é…ç½® Temperature / TopP / Max Tokens ç­‰å‚æ•°ï¼ˆé™¤ index ä»»åŠ¡ï¼‰

**4. é«˜çº§é€‰é¡¹**
- ç›¸ä¼¼åº¦é˜ˆå€¼è°ƒæ•´
- å¿«ç…§ä¿ç•™ç­–ç•¥
- æ—¥å¿—çº§åˆ«
- è‡ªåŠ¨æ ¸æŸ¥å¼€å…³ï¼ˆAuto Verifyï¼‰
- ä»»åŠ¡å†å²ä¸Šé™ï¼ˆå·²å®Œæˆ/å¤±è´¥/å–æ¶ˆï¼‰
- å›¾åƒç”Ÿæˆå‚æ•°

### 13.3 é¦–æ¬¡è¿è¡Œå‘å¯¼ (Setup Wizard)
æ–°ç”¨æˆ·å®‰è£…æ’ä»¶åè§¦å‘ï¼š

```
1ï¸âƒ£  æ¬¢è¿ â†’ ç®€ä»‹ Cognitive Razor çš„æ ¸å¿ƒåŠŸèƒ½
2ï¸âƒ£  Provider é…ç½® â†’ æ·»åŠ è‡³å°‘ä¸€ä¸ª AI Providerï¼ˆGemini/OpenAI/Azure ç­‰ OpenAI-Compatible æœåŠ¡ï¼‰
3ï¸âƒ£  ç›®å½•åˆå§‹åŒ– â†’ åˆ›å»º 5 ä¸ªåˆ†ç±»ç›®å½•
4ï¸âƒ£  å®Œæˆ â†’ æ‰“å¼€ Workbenchï¼Œå·²å‡†å¤‡å¥½ä½¿ç”¨
```

### 13.4 æ‰©å±•ç‚¹ (Extension Points)
ä¸æ”¯æŒç¬¬ä¸‰æ–¹æ’ä»¶æ‰©å±•ã€‚

### 13.5 æ•°æ®è¿ç§»
å½“å‰å®ç°åŒ…å«è½»é‡è¿ç§»/è§„èŒƒåŒ–é€»è¾‘ï¼š
- `data/queue-state.json`ï¼šæ—§æ ¼å¼ `tasks[]` è¿ç§»ä¸º `pendingTasks[]`ï¼›æ¢å¤æ—¶ Running ä»»åŠ¡è§†ä¸º Pendingï¼ˆè§ `src/core/task-queue-store.ts`ï¼‰ã€‚
- `data/vectors/index.json`ï¼šç§»é™¤å†—ä½™å­—æ®µã€ä¿®å¤æ—§å­—æ®µå‘½åå¹¶å‡çº§ç‰ˆæœ¬æ ‡è¯†ï¼ˆè§ `src/core/vector-index.ts`ï¼‰ã€‚
- `data/duplicate-pairs.json`ï¼šæ—§æ ¼å¼ `noteA/noteB` è¿ç§»ä¸º `nodeIdA/nodeIdB`ï¼ˆè§ `src/core/duplicate-manager.ts`ï¼‰ã€‚
- è®¾ç½®é¡¹ï¼šåŠ è½½æ—¶ä¸ `DEFAULT_SETTINGS` åˆå¹¶ï¼Œè¡¥é½ç¼ºå¤±å­—æ®µï¼ˆè§ `src/data/settings-store.ts`ï¼‰ã€‚

## 14. å·²å®ç°/æœªæ¥å…¥æ¸…å•ï¼ˆImplementation Statusï¼‰
æœ¬èŠ‚ç”¨äºåŒºåˆ†â€œä»£ç å·²å®ç°â€ä¸â€œå·²æ¥å…¥ä¸»æµç¨‹â€ï¼Œé¿å…è¯¯åˆ¤èŒƒå›´ã€‚

### 14.1 å·²å®ç°å¹¶æ¥å…¥ï¼ˆUI/æµç¨‹ï¼‰
| é¡¹ | å…¥å£/è§¦å‘ | è¯´æ˜ | ä»£ç  |
|---|---|---|---|
| `WorkbenchPanel` + Workbench Sections | Ribbon/å‘½ä»¤æ‰“å¼€ | Create/Duplicates/Queue/Recent Ops | `src/ui/workbench-panel.ts`ã€`src/ui/workbench/*-section.ts` |
| `SimpleDiffView` | Merge/Amend/ç¡®è®¤å†™å…¥ | ç»Ÿä¸€è¡Œçº§ diff é¢„è§ˆ | `src/ui/diff-view.ts` |
| `DuplicatePreviewModal` | é‡å¤å¯¹é¢„è§ˆ | é¢„è§ˆ + åˆå¹¶/å¿½ç•¥ | `src/ui/workbench/workbench-modals.ts` |
| `MergeNameSelectionModal` | åˆå¹¶é‡å¤å¯¹ | é€‰æ‹©ä¸»ä½“ä¸åç§° | `src/ui/merge-modals.ts` |
| `ExpandModal` / `AbstractExpandModal` | Expand | å€™é€‰é€‰æ‹© | `src/ui/expand-modal.ts`ã€`src/ui/abstract-expand-modal.ts` |
| `VisualizationModal` | Insert Image | å›¾åƒæè¿°ä¸ç¡®è®¤ | `src/ui/image-insert-modal.ts` |
| `SnapshotDiffModal` | å¿«ç…§é¢„è§ˆ | å¿«ç…§å¯¹æ¯”/æ¢å¤ | `src/ui/workbench/workbench-modals.ts` |
| `SettingsTab` / `SetupWizard` / `StatusBadge` | è®¾ç½®/é¦–æ¬¡å¯åŠ¨/çŠ¶æ€ | é¢æ¿ä¸çŠ¶æ€å…¥å£ | `src/ui/settings-tab.ts`ã€`src/ui/setup-wizard.ts`ã€`src/ui/status-badge.ts` |

### 14.2 å·²å®ç°ä½†æœªæ¥å…¥ï¼ˆUI ç»„ä»¶ï¼‰
| ç»„ä»¶ | èƒ½åŠ› | æœªæ¥å…¥è¯´æ˜ | ä»£ç  |
|---|---|---|---|
| `DiffView` | é€é¡¹é€‰æ‹©å·®å¼‚ + Side-by-Side/Tabbed é¢„è§ˆ | æœªè¢«ä»»ä½•å…¥å£è°ƒç”¨ï¼ˆä¸»æµç¨‹ä½¿ç”¨ `SimpleDiffView`ï¼‰ | `src/ui/diff-view.ts` |
| `MergeDiffModal` | åˆå¹¶é¢„è§ˆï¼ˆå·®å¼‚/å®Œæ•´è§†å›¾åˆ‡æ¢ï¼‰ | æœªè¢«ä»»ä½•å…¥å£è°ƒç”¨ | `src/ui/merge-modals.ts` |

### 14.3 é¢„ç•™èƒ½åŠ›ï¼ˆé UIï¼‰
| èƒ½åŠ› | ç°çŠ¶ | è¯´æ˜ | ä»£ç  |
|---|---|---|---|
| `TaskType` ä¸­çš„ `define` / `index` | Handler å·²å®ç°ä½†æœªå…¥é˜Ÿ | Define/Index å½“å‰èµ°ç›´è°ƒï¼ˆéé˜Ÿåˆ—ï¼‰ | `src/core/task-runner.ts`ã€`src/core/pipeline-orchestrator.ts` |
| `TaskQueue` çš„ `typeLockKey` | æ”¯æŒä½†æœªè¢«ä»»åŠ¡ä½¿ç”¨ | å½“å‰ä»… `DuplicateManager` ç›´æ¥åŠ  `type:${CRType}` é” | `src/core/task-queue.ts`ã€`src/core/duplicate-manager.ts` |

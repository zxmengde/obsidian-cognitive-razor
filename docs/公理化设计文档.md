# Cognitive Razor 公理化设计文档（精简版）

> 版本：1.3.0-lite（在 1.3.0 基础上瘦身，仅保留约束“靶子”）  
> 更新：2025-12-07  
> 目标：在保证公理化约束可追溯的前提下，减少上下文占用，便于日常开发调用。

## 0. 设计目的
- 在 Obsidian 中以本地优先的方式，将模糊输入转化为结构化概念，覆盖创建、去重、改进、合并、撤销全链路。
- 严格依赖有限公理集合，避免需求漂移：UID 唯一、类型有限、因果层级固定、人机共生、本地优先、可逆写入、命名规范。
- 所有规则可验证、可追溯，所有写入可撤销，所有外部调用需显式配置。

## 1. 公理速览
### L0 元公理（哲学基础）
M-01 概念实在性｜M-02 结构可表达性｜M-03 语义可判定性｜M-04 人机协作性  
M-05 渐进认知性｜M-06 注意力有限性｜M-07 本地主权性｜M-08 操作可逆性  
M-09 系统透明性｜M-10 知识深化层级性

### L1 根公理（设计原则）
G-01 UID 唯一｜G-02 同类型语义唯一｜G-03 类型集合 K={Domain, Issue, Theory, Entity, Mechanism}  
G-04 深化路径 Domain→Issue→Theory→{Entity,Mechanism}｜G-05 人机共生（确认/撤销/可中断）  
G-06 渐进披露｜G-07 注意力尊重｜G-08 本地优先｜G-09 可逆写入｜G-10 命名模板

### L2 系统公理（摘要）
- 平台约束 O：O-01 仅操作插件目录/笔记 frontmatter；O-02 稳定命令 ID；O-03 IO 异步；O-04 配置存储 data.json；O-05 开发期允许破坏性更新。
- 功能 A-FUNC：A-FUNC-01 队列+锁；A-FUNC-02 写入前快照+撤销；A-FUNC-03 Provider/模板匹配；A-FUNC-04 同类型语义去重；A-FUNC-05 任务链 standardize→enrich→embedding→确认创建→reason:new→(可选 ground)→确认写入→去重；A-FUNC-06 配置含版本；A-FUNC-07 本地存储结构；A-FUNC-08 渐进披露与通知分级；A-FUNC-09 UI 注册规范。
- 非功能 A-NF：性能（持久化≤200ms/UI 刷新≤100ms）、可靠性（原子写入）、可观察性（1MB 循环日志）、可访问性（键盘/aria）、安全（禁止外发 vault 内容，凭据显式）。
- 提示词 A-PDD：固定区块序、变量全替换、共享硬约束、上下文槽位映射、任务模板完备、JSON Schema 校验、同类型去重提示、结构化重试（≤3 次）、安全拒绝。
- 架构 TA：分层单向依赖 UI→应用→数据；写入集中在 TaskRunner 可逆；同类型去重后记录；接口返回 `{ok,data?,error?}`；可观测性钩子；版本兼容检查；多输入一致。
- 体验 A-UCD：核心任务≤3 步、重复面板异步处理、写入需确认且可撤销、渐进披露与静默非关键信息、多输入一致（键鼠/快捷键/触控）。

## 2. 核心模型
- **知识类型字段（必填核心）**  
  - Domain：definition｜teleology｜methodology｜historical_genesis｜boundaries[]｜issues[]｜holistic_understanding（可选：sub_domains, related_domains）  
  - Issue：core_tension("X vs Y")｜significance｜historical_genesis｜structural_analysis｜stakeholder_perspectives[]｜boundary_conditions[]｜theories[]｜holistic_understanding  
  - Theory：axioms[]｜argument_chain[]｜core_predictions[]｜scope_and_applicability｜limitations[]｜historical_development｜extracted_components{entities[],mechanisms[]}｜holistic_understanding  
  - Entity：definition｜classification{genus,differentia[]}｜properties[]｜distinguishing_features[]｜examples[]｜counter_examples[]｜holistic_understanding  
  - Mechanism：definition｜trigger_conditions[]｜causal_chain[]｜termination_conditions[]｜inputs[]｜outputs[]｜process_description｜examples[]｜holistic_understanding（可选关系：operates_on[], produces[], requires[], inhibited_by[]）

- **Frontmatter（CRFrontmatter）**  
  `uid` (UUIDv4)｜`type`｜`status` {Stub,Draft,Evergreen}｜`created`｜`updated`｜可选：aliases[], tags[], parentUid, parentType, sourceUids, version。

- **任务/队列**  
  TaskType：standardizeClassify｜enrich｜embedding｜reason:new｜reason:incremental｜reason:merge｜ground  
  TaskState：Pending/Running/Completed/Failed/Cancelled；TaskQueue 持久化 queue-state.json，受并发/锁控制（nodeLock+typeLock）。

- **向量索引与去重**  
  vector-index.json 按类型分桶；去重阈值默认 0.9，topK 默认 10，记录 DuplicatePair{noteA,noteB,type,similarity,status}。

## 3. 存储布局（本地优先）
```
<plugin root>/
  manifest.json
  data.json                # 配置（Obsidian API）
  data/
    queue-state.json
    vector-index.json
    duplicate-pairs.json
    app.log                # 循环日志（1MB）
    snapshots/
      index.json
      *.json
  prompts/                 # 模板（OpenAI 标准格式）
  styles.css (可选)
```

## 4. 关键流程
- **创建/去重**（A-FUNC-05）：  
  输入 → standardizeClassify → enrich → embedding → *确认创建*（生成 Stub/frontmatter）→ reason:new → (可选 ground) → *确认写入*（Draft 内容）→ 向量入索引 → 同类型去重检测 → 将重复对记录到 DuplicatePairs，用户稍后处理。
- **增量改进**：选择笔记 → reason:incremental（带当前内容与意图）→ Diff 预览 → 确认后写入；Evergreen 自动降级为 Draft；写入前后均有快照。
- **合并重复**：在重复面板选择 pair → reason:merge 生成合并稿 → 预览/确认 → 写入保留笔记并删除被合并笔记，更新向量索引和 DuplicatePairs。
- **撤销/快照**：所有写入前创建快照（含 nodeId/taskId/path/checksum）；撤销时原子写入恢复；快照默认保留 100 个、30 天。
- **Provider & Prompt**：仅调用兼容 OpenAI 标准接口；任务与模板一一匹配，模板通过区块序/槽位/Schema 校验；结构化重试 ≤3 次。

## 5. 校验与错误码
- 校验规则（示例）：  
  C001 core_tension 格式；C002 字段非空；C003 theory 需 axioms；C004 argument_chain；C005 mechanism causal_chain≥2；C006 termination_conditions；C007 Entity classification 完整；C010 JSON 可解析；C011 必填字段存在；C012 holistic_understanding；C013 stakeholder_perspectives≥2；C014 predictions 可检验；C015 extracted_components 完整；C016 sub_domains 结构合法。
- 错误码分组：  
  E001-E010 解析/模板/校验；E100-E103 API/认证；E200-E201 安全/越权；E300-E304 文件/存储/任务队列。

## 6. 体验与安全
- 渐进披露：默认隐藏模型/温度/阈值/并发等高级参数，高级模式显式解锁；输入时静默非关键通知，关键操作用模态/Toast 分级。
- 可撤销：所有生成/改写/合并均需用户显式确认，并提供撤销按钮或历史视图。
- 可访问性：键盘 Tab/Enter 全覆盖，aria-label/aria-live 覆盖所有图标与状态变更；触控操作等价。
- 隐私与安全：不外发 vault 内容或文件名；外部调用仅在用户提供凭据后发起；日志不记录敏感内容。

## 7. 版本与发布
- 版本策略：开发阶段允许破坏性更新；版本存储于 manifest.json、data.json（settings.version）、frontmatter.version，并在 versions.json 映射最小兼容版本；升级时如不兼容应提示导出/重置/迁移选项。
- 发布物料：`main.js`、`manifest.json`、`styles.css`（如有），置于插件根目录；打包需将所有依赖捆绑进 main.js。

---

本精简版仅保留后续开发必须遵循的约束与流程。如需修改公理或流程，请同步更新本文件并追踪影响面（队列、快照、模板、前端交互、版本兼容）。

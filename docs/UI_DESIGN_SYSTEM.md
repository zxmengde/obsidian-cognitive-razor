# Cognitive Razor — UX/UI 设计

> 本文档是所有 UX 交互设计和 UI/CSS 改动的唯一基准（SSOT）。
> 任何新增组件、交互流程或样式修改必须遵循此规范。
> 哲学基线 → `docs/PHILOSOPHICAL_FOUNDATIONS.md`

---

## 设计宣言

设计的核心目标：**让工具消失在使用者的思维流中**。

我们追求的不是"好看的界面"，而是"不被注意到的界面"——用户的注意力应该始终在知识本身，
而非操作工具的过程上。每一个交互决策都服务于这个目标。

### 设计公理（从哲学基线推导）

1. **判断主权在用户** — AI 的每一步输出都是"建议"，接受与拒绝的操作成本必须对称
2. **允许未完成态** — 系统不强迫用户在每一步都做最终决定，模糊和暂定是合法状态
3. **可逆性即安全感** — 破坏性操作必须可撤销，撤销入口必须显眼且持久
4. **结构是脚手架** — 分类和 Schema 帮助思考，但不应成为思考的障碍
5. **不打断，不割裂** — 交互流程在工作台内闭环，重操作在独立标签页完成，二者互不干扰

### 设计参考系

| 参考来源 | 汲取方向 | 边界 |
|----------|----------|------|
| VS Code | 统一 Diff 视图、标签页架构、设置页搜索与分组、信息密度 | 不照搬编辑器范式 |
| Apple HIG | 渐进披露、即时反馈、一致性、容错设计 | 不追求 iOS 视觉风格 |
| Obsidian 原生 | 颜色变量、圆角、阴影、字体、主题适配 | 在原生基础上做克制增强 |
| Less is More | 每个元素必须证明自己存在的必要性 | 不为简洁牺牲可发现性 |


---

## 第一部分：交互架构

### 1.1 视图体系

插件包含三类视图，各司其职：

| 视图类型 | 载体 | 职责 | 生命周期 |
|----------|------|------|----------|
| 工作台面板 | Obsidian 侧边栏 View | 仪表盘：创建、队列、重复对、历史 | 随插件加载常驻 |
| Diff 标签页 | Obsidian 自定义 View（标签页） | 内容对比与决策（Amend/Merge/快照） | 按需打开，可多开 |
| 设置页 | Obsidian PluginSettingTab | 全部配置项管理 | 按需打开 |

关键设计决策：

- **工作台是控制中心**，所有轻量交互（创建、输入指令、查看状态）在此完成，不弹出 Modal
- **Diff 标签页是决策空间**，所有需要对比内容并做出判断的操作在独立标签页完成，
  不占用工作台空间，不打断工作台状态，可与工作台并排查看
- **Modal 仅用于不可避免的阻断确认**（如清空队列、删除 Provider 等破坏性操作），
  且必须是轻量级确认框，不承载复杂交互

### 1.2 内联展开原则

以下场景用工作台内联展开替代独立 Modal：

| 场景 | 旧方案 | 新方案 |
|------|--------|--------|
| 修订指令输入 | SimpleInputModal 弹窗 | 工作台操作区内联展开输入框 |
| 拓展候选列表 | ExpandModal 弹窗 | 工作台内联展开候选列表（含勾选） |
| 抽象拓展选择 | AbstractExpandModal 弹窗 | 工作台内联展开选择列表 |
| 图片生成配置 | VisualizationModal 弹窗 | 工作台内联展开配置面板 |
| 合并名称选择 | MergeNameSelectionModal 弹窗 | Diff 标签页内内联选择 |

保留 Modal 的场景（仅限轻量确认框）：

| 场景 | 理由 |
|------|------|
| 清空队列确认 | 破坏性批量操作，需要明确阻断 |
| 删除 Provider 确认 | 不可逆配置变更 |
| 重置设置确认 | 全局影响 |
| 添加/编辑 Provider | 表单输入，需要独立焦点空间 |


### 1.3 Diff 标签页设计（核心新增）

Diff 标签页是本次重构的核心新增视图，参考 VS Code 的统一 Diff 体验。

#### 视图注册

注册为 Obsidian 自定义 View（`VIEW_TYPE_CR_DIFF`），可在标签页中打开，
支持多实例并存，支持与编辑器/工作台并排。

#### 布局结构

```
┌─ Diff Tab ─────────────────────────────────────────────┐
│ ┌─ 标题栏 ──────────────────────────────────────────┐  │
│ │ [图标] 操作类型: 笔记名称          [统一|并排] ▼  │  │
│ └────────────────────────────────────────────────────┘  │
│                                                         │
│ ┌─ Diff 内容区 ─────────────────────────────────────┐  │
│ │                                                    │  │
│ │  统一视图：                                        │  │
│ │  - 删除行（红色背景 + 左侧红色边线）              │  │
│ │  + 新增行（绿色背景 + 左侧绿色边线）              │  │
│ │    未变行（无背景）                                │  │
│ │                                                    │  │
│ │  并排视图：                                        │  │
│ │  ┌─ 原始 ──────┐ ┌─ 修改后 ─────┐                │  │
│ │  │              │ │              │                 │  │
│ │  └──────────────┘ └──────────────┘                │  │
│ │                                                    │  │
│ └────────────────────────────────────────────────────┘  │
│                                                         │
│ ┌─ 操作栏（底部固定）──────────────────────────────┐  │
│ │ [上下文信息]              [拒绝]  [接受修改]      │  │
│ │                                                    │  │
│ │ ← 合并场景追加：内联名称选择                      │  │
│ │ [保留名称: ▼ 下拉选择 / 自定义输入]               │  │
│ └────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

#### 交互规范

- 标题栏显示操作类型（修订/合并/快照恢复）和目标笔记名称
- 视图模式切换（统一/并排）通过下拉选择，默认统一视图
- 底部操作栏固定不随内容滚动，始终可见
- 接受/拒绝按钮尺寸相同（对称性原则），接受为 Primary，拒绝为 Secondary
- 合并场景：操作栏内追加名称选择控件（下拉 + 自定义输入），无需额外 Modal
- 快照恢复场景：接受按钮文案改为"恢复到此版本"
- 关闭标签页等同于拒绝（取消操作），关闭前无需二次确认
- 支持键盘快捷键：`Ctrl+Enter` 接受，`Escape` 拒绝/关闭

#### 打开方式

- 从工作台重复对列表点击 → 打开 Merge Diff 标签页
- 从工作台操作历史点击"查看" → 打开 Snapshot Diff 标签页
- Amend/Merge 管线完成后 → 自动打开对应 Diff 标签页等待用户决策
- 如果同一笔记已有打开的 Diff 标签页，复用而非新开


---

## 第二部分：工作台面板

### 2.1 整体布局

工作台保持仪表盘模式，垂直单列布局，四个功能区从上到下排列。

```
┌─ Workbench Panel (.cr-workbench-panel) ────────────────┐
│                                                         │
│  ┌─ 创建区 (CreateSection) ─────────────────────────┐  │
│  │  搜索输入框 + 操作按钮行 + 内联展开区            │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─ 队列区 (QueueSection) ──────────────────────────┐  │
│  │  状态指示 + 紧凑统计 + 可展开任务列表            │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─ 重复对区 (DuplicatesSection) ───────────────────┐  │
│  │  可折叠 + 重复对列表                              │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌─ 历史区 (RecentOpsSection) ──────────────────────┐  │
│  │  可折叠 + 快照列表                                │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

布局原则：
- 创建区始终可见，不可折叠（最高频操作）
- 队列区始终可见但视觉轻量，详情可展开
- 重复对区和历史区可折叠，折叠状态持久化
- 各区之间用间距分隔，不用分割线（减少视觉噪音）
- 面板最大宽度 `900px`，居中对齐

### 2.2 创建区（CreateSection）

创建区是工作台的核心，承载概念创建和笔记操作两大功能。

#### 搜索输入区

```
┌─ 搜索输入框 ────────────────────────────────────────┐
│ [🔍] 输入概念描述...                    [✕] [↵]    │
└──────────────────────────────────────────────────────┘
```

- 输入框占据全宽，视觉突出（最大的交互元素）
- 清除按钮（✕）仅在有内容时显示
- 提交按钮（↵）仅在有内容时启用
- `Enter` 键触发 Define，与按钮点击等效
- Define 期间：提交按钮显示加载动画，输入框禁用
- placeholder 提供示例引导文字

#### 操作按钮行

```
┌─ 操作按钮行（有活跃 Markdown 笔记时显示）───────────┐
│                    [改进] [拓展] [配图] [核查]       │
└──────────────────────────────────────────────────────┘
```

- 按钮右对齐，使用 Secondary 样式
- 无活跃 Markdown 笔记时：整行隐藏，显示引导提示文字
- 图片生成功能未启用时：配图按钮隐藏（而非禁用灰显）
- 点击"改进"→ 在创建区下方内联展开修订输入框
- 点击"拓展"→ 在创建区下方内联展开候选列表
- 点击"配图"→ 在创建区下方内联展开配置面板
- 点击"核查"→ 直接触发，Notice 反馈

#### 内联展开区

内联展开区是替代 Modal 的核心机制。它位于操作按钮行下方，
同一时间只能展开一个面板（互斥）。展开时带平滑过渡动画。

**修订输入面板：**
```
┌─ 内联展开：修订 ────────────────────────────────────┐
│ 修订指令：                                           │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 输入修订指令...                          [提交]  │ │
│ └──────────────────────────────────────────────────┘ │
│                                          [取消]      │
└──────────────────────────────────────────────────────┘
```

**拓展候选面板：**
```
┌─ 内联展开：拓展 "概念名称" ─────────────────────────┐
│ 统计: 共 N 个 / 可创建 M 个 / 已存在 K 个           │
│ [全选] [全不选]                                      │
│                                                       │
│ ☑ 候选概念 A (Domain)                                │
│ ☑ 候选概念 B (Theory)                                │
│ ☐ 候选概念 C (Entity) — 已存在                       │
│ ...                                                   │
│                                          [创建] [取消]│
└──────────────────────────────────────────────────────┘
```

**图片配置面板：**
```
┌─ 内联展开：生成配图 ────────────────────────────────┐
│ 图片描述（可选，留空则自动从上下文生成）：           │
│ ┌──────────────────────────────────────────────────┐ │
│ │                                                   │ │
│ └──────────────────────────────────────────────────┘ │
│                                        [生成] [取消] │
└──────────────────────────────────────────────────────┘
```

内联展开的交互规范：
- 展开/收起使用 `max-height` + `opacity` 过渡动画（200ms）
- 点击"取消"或再次点击触发按钮 → 收起面板
- 提交后自动收起面板
- `Escape` 键收起当前展开的面板
- 展开面板时，触发按钮保持视觉激活状态


#### 类型置信度表格（简化版）

Define 成功后，在搜索输入框下方显示类型选择表格。

```
┌─ 选择概念类型 ──────────────────────────────────────┐
│                                                       │
│  类型        标准名称              操作               │
│  ─────────────────────────────────────────────────── │
│  Domain      认知科学 (Cognitive…  [██████████] 创建  │  ← 最高置信度行高亮
│  Theory      认知负荷 (Cognitive…  [██████░░░░] 创建  │
│  Issue       认知偏差 (Cognitive…  [████░░░░░░] 创建  │
│  Entity      丹尼尔·卡… (Daniel…   [██░░░░░░░░] 创建  │
│  Mechanism   注意力分… (Attenti…   [█░░░░░░░░░] 创建  │
│                                                       │
└──────────────────────────────────────────────────────┘
```

简化要点（相比旧版）：
- 去掉置信度百分比数字，仅用进度条长度和颜色区分强弱
- 进度条颜色：高置信度用强调色，低置信度用淡化色（渐变过渡）
- 最高置信度行的"创建"按钮使用 Primary 样式，其余行使用 Ghost 样式
- 表格无表头行（列含义通过内容自解释），减少视觉重量
- 选择类型后自动清空输入框和表格，回到初始状态

### 2.3 队列区（QueueSection）

队列区提供后台任务的状态概览，视觉轻量，不喧宾夺主。

#### 核心变更：不再显示已完成任务

已完成的任务从队列区移除，不再占据视觉空间。用户通过历史区（快照）追溯已完成操作。
队列区仅显示：Pending（等待中）、Running（运行中）、Failed（失败）三种状态的任务。

#### 布局结构

```
┌─ 队列状态栏 ────────────────────────────────────────┐
│ ● 运行中    待处理 3 · 运行中 1 · 失败 0    [⏸]    │
│                                                       │
│ ▸ 展开详情                                           │
│ ┌─ 任务列表（展开时显示）──────────────────────────┐ │
│ │ 概念名称        类型     状态      操作          │ │
│ │ 认知科学        write    运行中    —             │ │
│ │ 认知负荷        tag      等待中    [取消]        │ │
│ │ 注意力分配      index    等待中    [取消]        │ │
│ │                                                   │ │
│ │ [重试失败] [清空等待中]                           │ │
│ └──────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

状态指示器：
- 空闲（无任务）：灰色圆点 + "空闲"
- 运行中：强调色圆点（脉冲动画）+ "运行中"
- 已暂停：橙色圆点 + "已暂停"
- 有失败：红色圆点 + "有失败任务"

紧凑统计：
- 仅显示非零状态的计数（如全部为 0 则显示"无任务"）
- 格式：`待处理 N · 运行中 N · 失败 N`
- 使用 `·` 分隔而非 `|`，视觉更轻

暂停/恢复按钮：
- 图标按钮，暂停时显示播放图标，运行时显示暂停图标
- 暂停状态下按钮带橙色视觉提示

展开详情：
- 点击状态栏或"展开详情"文字切换展开/收起
- 展开时显示任务表格 + 批量操作按钮
- 任务表格列：概念名称、任务类型、状态、操作
- 等待中的任务可单独取消
- 失败的任务显示错误图标（hover 显示错误信息）
- 批量操作：重试失败、清空等待中（清空需确认 Modal）


### 2.4 重复对区（DuplicatesSection）

重复对区展示语义相似的概念对，引导用户进行合并或忽略决策。

#### 布局结构

```
┌─ ▾ 重复概念 (3) ────────────────────────────────────┐
│                                                       │
│  ┌─ 重复对项 ─────────────────────────────────────┐  │
│  │ ┌────────────────────────────────────────────┐  │  │
│  │ │ ████████████████████░░░░ 相似度进度条       │  │  │
│  │ └────────────────────────────────────────────┘  │  │
│  │ 认知科学  ↔  认知心理学                         │  │
│  │ Domain · 87%                    [对比] [忽略]   │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ┌─ 重复对项 ─────────────────────────────────────┐  │
│  │ ...                                              │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
└──────────────────────────────────────────────────────┘
```

交互规范：
- 可折叠，默认展开，折叠状态持久化
- Section header 显示数量 badge
- 列表项按相似度降序排列
- 每项顶部有相似度进度条（颜色分级：>90% 红色，80-90% 橙色，<80% 蓝色）
- 点击"对比"→ 打开 Diff 标签页（Merge 模式），在标签页内完成合并决策
- 点击"忽略"→ 直接忽略该重复对，从列表移除，Notice 反馈
- 点击列表项本身 → 等同于点击"对比"
- 操作按钮在 hover 时淡入显示（非 hover 时半透明）

### 2.5 历史区（RecentOpsSection）

历史区展示最近的操作快照，提供撤销和回溯能力。

#### 布局结构

```
┌─ ▸ 操作历史 (5) ──────────────── [清空全部] ────────┐
│                                                       │
│  ┌─ 快照项 ───────────────────────────────────────┐  │
│  │ 修订: 认知科学.md                               │  │
│  │ 3 分钟前                        [查看] [撤销]   │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ┌─ 快照项 ───────────────────────────────────────┐  │
│  │ 创建: 认知负荷.md                               │  │
│  │ 15 分钟前                       [查看] [撤销]   │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  还有 3 条更早的记录                                  │
│                                                       │
└──────────────────────────────────────────────────────┘
```

交互规范：
- 可折叠，默认折叠，折叠状态持久化
- 最多显示最近 10 条快照
- 每条显示：操作类型 + 文件名 + 相对时间
- 点击"查看"→ 打开 Diff 标签页（Snapshot 模式），对比快照内容与当前内容
- 点击"撤销"→ 直接恢复快照内容，Notice 反馈
- "清空全部"按钮在 Section header 右侧，需确认 Modal


---

## 第三部分：交互流程规范

### 3.1 创建概念流程

```
用户输入描述 → Enter / 点击提交
    │
    ▼
[Define] AI 识别类型 + 标准化命名
    │  （输入框禁用 + 提交按钮加载动画）
    │
    ├─ 成功 → 显示简化版类型表格
    │           │
    │           ▼
    │       用户点击某行"创建"按钮
    │           │
    │           ▼
    │       [Create Pipeline] Tag → Write → Index → Dedup
    │           │  （任务入队，队列区状态更新）
    │           │
    │           ▼
    │       输入框清空，表格消失，回到初始状态
    │       Write 完成后 → Undo Toast (8s)
    │
    └─ 失败 → Notice 错误提示 + 输入框恢复可用（重试入口）
```

### 3.2 修订流程（Amend）

```
用户点击"改进" → 内联展开修订输入面板
    │
    ▼
用户输入修订指令 → 提交
    │  （面板收起，Notice "修订任务已启动"）
    │
    ▼
[Amend Pipeline] AI 生成修订内容（后台队列执行）
    │
    ▼
完成后自动打开 Diff 标签页
    │
    ├─ 用户点击"接受" → 写入文件 → Undo Toast (8s)
    └─ 用户点击"拒绝"或关闭标签页 → Notice "已取消"
```

### 3.3 合并流程（Merge）

```
用户在重复对列表点击"对比"
    │
    ▼
打开 Diff 标签页（Merge 模式）
    │  左侧：笔记 A 内容
    │  右侧：笔记 B 内容
    │  底部操作栏：名称选择 + 接受/拒绝
    │
    ├─ 用户选择保留名称（下拉选择或自定义输入）
    │  用户点击"确认合并"
    │       │
    │       ▼
    │   [Merge Pipeline] AI 合并内容（后台队列执行）
    │       │
    │       ▼
    │   完成后在同一 Diff 标签页更新内容为合并结果预览
    │       │
    │       ├─ 接受 → 写入 → Undo Toast (8s)
    │       └─ 拒绝 → Notice "已取消"
    │
    └─ 用户关闭标签页 → 取消，返回工作台
```

### 3.4 拓展流程（Expand）

```
用户点击"拓展" → 内联展开候选面板
    │  （后台调用 prepare，面板显示加载状态）
    │
    ▼
AI 返回候选列表
    │
    ├─ 层级拓展 → 显示勾选列表（标注已存在/无效项）
    │               用户勾选 → 点击"创建"
    │               → 批量 Create Pipeline → 面板收起
    │
    └─ 抽象拓展 → 显示关联概念选择列表
                    用户选择 → 点击"创建"
                    → 单个 Create Pipeline → 面板收起
```

### 3.5 事实核查流程（Verify）

```
用户点击"核查" → 直接触发（无需额外输入）
    │
    ▼
Notice "核查任务已启动"
    │
    ▼
[Verify Pipeline] 后台执行
    │
    ▼
完成后核查结果追加到笔记末尾 → Notice "核查完成"
```

### 3.6 图片生成流程（Visualize）

```
用户点击"配图" → 内联展开配置面板
    │  （自动提取光标前后上下文）
    │
    ▼
用户输入描述（可选）→ 点击"生成"
    │  （面板收起，Notice "图片生成任务已创建"）
    │
    ▼
[Image Pipeline] 后台执行
    │
    ▼
完成后图片插入到光标位置 → Notice "图片已插入"
```


---

## 第四部分：状态管理

### 4.1 组件状态矩阵

每个 Section 必须处理以下四种状态：

| 状态 | 视觉表现 | 交互行为 |
|------|----------|----------|
| 空状态 | 引导文字（居中、淡色） | 提供"下一步"建议 |
| 加载中 | 内联加载指示器（不用骨架屏） | 禁用相关交互，防止重复操作 |
| 正常 | 数据列表/内容 | 完整交互能力 |
| 错误 | 内联错误描述 + 重试入口 | 仅允许重试或关闭 |

### 4.2 各区空状态

| 区域 | 空状态文案 | 视觉 |
|------|-----------|------|
| 创建区 | 输入框 placeholder 引导 | 无额外元素 |
| 队列区 | "空闲"状态指示 + "无任务" | 灰色圆点 |
| 重复对区 | "暂无重复概念" | 居中淡色文字 |
| 历史区 | "暂无操作记录" | 居中淡色文字 |

### 4.3 反馈系统分级

所有用户反馈必须经统一出口，禁止在业务代码中散点 `new Notice(...)`。

| 级别 | 通道 | 持续时间 | 适用场景 |
|------|------|----------|----------|
| 成功 | Obsidian Notice | 3000ms | 创建完成、修订完成 |
| 信息 | 内联文字更新 | 持久 | 队列状态变化、进度更新 |
| 警告 | Obsidian Notice | 5000ms | 功能未启用、前置条件不满足 |
| 错误 | Obsidian Notice | 6000ms | API 失败、系统错误 |
| 可撤销 | Undo Toast（底部浮层） | 8000ms | 写入完成后的撤销窗口 |
| 确认 | 轻量 Modal | 用户关闭 | 破坏性操作（清空队列、删除 Provider） |
| 预览 | Diff 标签页 | 用户关闭 | 写入前的变更预览 |

错误展示规范：
- 仅显示 `[错误码] + 用户可理解信息`
- 禁止直接暴露 `result.error.message` 等底层技术细节
- 同一操作链中禁止连续弹出同级通知
- 优先内联状态更新，避免通知疲劳

### 4.4 UI 状态持久化

| 持久化内容 | 存储位置 | 默认值 |
|-----------|----------|--------|
| 重复对区折叠状态 | `PluginSettings.uiState` | 展开 |
| 历史区折叠状态 | `PluginSettings.uiState` | 折叠 |
| 队列详情展开状态 | `PluginSettings.uiState` | 收起 |
| Diff 视图模式（统一/并排） | `PluginSettings.uiState` | 统一 |

损坏或缺失时回退到默认值，不报错。


---

## 第五部分：设置页

### 5.1 设计原则

- 所有可配置项开放给用户，不隐藏
- 每个设置项必须有清晰的注解说明和合理的默认值
- 设置项按逻辑分组，层级结构清晰
- 输入方式与数据类型严格匹配

### 5.2 Tab 结构与设置项清单

#### Tab 1: 通用

基础偏好设置，影响全局行为。

| 设置组 | 设置项 | 数据类型 | 输入方式 | 默认值 | 说明 |
|--------|--------|----------|----------|--------|------|
| 语言与显示 | 界面语言 | enum | 下拉选择 | zh | 中文 / English |
| 语言与显示 | 命名模板 | string | 文本输入 | `{{chinese}} ({{english}})` | 支持 `{{chinese}}` `{{english}}` `{{type}}` 变量 |
| 知识存储 | 目录方案 | object | 专用编辑器 | 按类型分目录 | 每种类型的存储目录路径 |
| 自动化 | 创建后自动核查 | boolean | 开关 | false | 概念创建完成后自动触发事实核查 |

#### Tab 2: AI 服务

Provider 管理和任务模型配置。

| 设置组 | 设置项 | 数据类型 | 输入方式 | 默认值 | 说明 |
|--------|--------|----------|----------|--------|------|
| Provider 管理 | Provider 列表 | array | 卡片列表 + 添加按钮 | 空 | 每个 Provider 可展开编辑 |
| Provider 管理 | 默认 Provider | enum | 下拉选择 | 第一个 | 未指定任务模型时的 fallback |
| Provider 管理 | 请求超时 | number | 滑块 (10-120s) | 60s | 单次 API 请求超时时间 |
| 任务模型 | 各任务类型模型配置 | object | 卡片列表 | 使用默认 Provider | 每种任务类型可独立指定 Provider、模型、温度 |

Provider 卡片内部字段：

| 字段 | 数据类型 | 输入方式 | 说明 |
|------|----------|----------|------|
| 名称 | string | 文本输入 | 显示名称 |
| 类型 | enum | 下拉选择 | openai / anthropic / google / openrouter / custom |
| API Key | string | 密码输入 | 带显示/隐藏切换 |
| Base URL | string | 文本输入 | 自定义端点（可选） |
| 默认模型 | string | 文本输入 | 模型标识符 |
| 启用状态 | boolean | 开关 | 启用/禁用 |
| 连接测试 | action | 按钮 | 测试 API 连通性 |

任务模型卡片内部字段：

| 字段 | 数据类型 | 输入方式 | 说明 |
|------|----------|----------|------|
| Provider | enum | 下拉选择 | 从已配置的 Provider 中选择 |
| 模型 | string | 文本输入 | 覆盖 Provider 默认模型 |
| 温度 | number | 滑块 (0-2, 步长 0.1) | 附带推荐值提示 |
| 重置为默认 | action | 按钮 | 恢复该任务类型的默认配置 |

#### Tab 3: 高级

性能调优、去重、快照等高级参数。

| 设置组 | 设置项 | 数据类型 | 输入方式 | 默认值 | 说明 |
|--------|--------|----------|----------|--------|------|
| 去重检测 | 相似度阈值 | number | 滑块 (0.5-1.0, 步长 0.01) | 0.85 | 高于此值判定为重复 |
| 去重检测 | 嵌入向量维度 | number | 下拉选择 (512/1024/1536/3072) | 1536 | text-embedding-3-small 支持范围 |
| 队列性能 | 并发数 | number | 滑块 (1-5) | 2 | 同时执行的最大任务数 |
| 队列性能 | 自动重试 | boolean | 开关 | true | 失败任务是否自动重试 |
| 队列性能 | 最大重试次数 | number | 滑块 (1-5) | 3 | 单个任务最大重试次数 |
| 队列性能 | 任务超时 | number | 滑块 (30-300s) | 120s | 单个任务最大执行时长 |
| 队列性能 | 历史保留上限 | number | 滑块 (10-200) | 50 | 已完成/失败/取消任务的保留数量 |
| 快照管理 | 最大快照数 | number | 滑块 (5-100) | 20 | 快照保留上限 |
| 快照管理 | 快照保留天数 | number | 滑块 (1-90) | 30 | 超过天数的快照自动清理 |
| 图片生成 | 启用图片生成 | boolean | 开关 | false | 总开关 |
| 图片生成 | 默认尺寸 | enum | 下拉选择 | 1024x1024 | 1024x1024 / 1792x1024 / 1024x1792 |
| 图片生成 | 默认质量 | enum | 下拉选择 | standard | standard / hd |
| 图片生成 | 默认风格 | enum | 下拉选择 | vivid | vivid / natural |
| 图片生成 | 上下文窗口大小 | number | 滑块 (100-2000) | 500 | 光标前后提取的字符数 |

#### Tab 4: 系统

日志、备份、导入导出等维护功能。

| 设置组 | 设置项 | 数据类型 | 输入方式 | 默认值 | 说明 |
|--------|--------|----------|----------|--------|------|
| 日志 | 日志级别 | enum | 下拉选择 | info | debug / info / warn / error |
| 日志 | 清空日志 | action | 按钮 | — | 清空 data/app.log |
| 数据管理 | 导出设置 | action | 按钮 | — | 导出为 JSON（API Key 脱敏） |
| 数据管理 | 导入设置 | action | 按钮 | — | 从 JSON 导入 |
| 数据管理 | 重置为默认 | action | 危险按钮 | — | 恢复所有设置为默认值（需确认） |

### 5.3 设置页视觉规范

- Tab 导航：顶部水平排列，sticky 定位，当前 tab 下划线高亮
- 设置组：用标题 + 分隔线分组，组内设置项垂直排列
- 每个设置项：左侧标签 + 说明文字，右侧输入控件，单行布局
- 滑块：显示当前值 + 单位，支持直接输入数字微调
- 下拉选择：使用 Obsidian 原生 `<select>` 样式
- 开关：使用 Obsidian 原生 toggle 组件
- 文本输入：根据内容长度使用不同宽度类（xs/sm/md/lg）
- 密码输入：带眼睛图标切换显示/隐藏
- 危险操作按钮：使用 Danger 样式，与普通按钮视觉区分


---

## 第六部分：UI 视觉规范

### 6.1 设计哲学

**Obsidian 原生 + VS Code 信息密度**：在 Obsidian 原生视觉语言基础上，
借鉴 VS Code 的紧凑信息呈现方式，追求高效而不拥挤的视觉体验。

核心原则：
- 一致性 > 美观性：所有组件遵循同一套规则
- 克制：不加不必要的阴影、动画、装饰
- 信息层级清晰：主操作突出，辅助信息收敛
- 呼吸感：用间距而非分割线区分区域

### 6.2 颜色系统

所有组件样式只允许引用 `--cr-*` 变量，禁止直接使用 Obsidian 原生变量。

```css
/* ✅ 正确 */
background: var(--cr-bg-surface);
/* ❌ 禁止 */
background: var(--background-secondary);
```

语义色板：

| 用途 | 变量 | 映射 |
|------|------|------|
| 基础背景 | `--cr-bg-base` | `--background-primary` |
| 表面背景 | `--cr-bg-surface` | `--background-secondary` |
| 悬停背景 | `--cr-bg-hover` | `--background-modifier-hover` |
| 正文 | `--cr-text-normal` | `--text-normal` |
| 次要文字 | `--cr-text-muted` | `--text-muted` |
| 淡化文字 | `--cr-text-faint` | `--text-faint` |
| 强调色 | `--cr-text-accent` | `--interactive-accent` |
| 边框 | `--cr-border` | `--background-modifier-border` |
| 焦点边框 | `--cr-border-focus` | `--interactive-accent` |
| 成功 | `--cr-status-success` | `--color-green` |
| 警告 | `--cr-status-warning` | `--color-orange` |
| 错误 | `--cr-status-error` | `--color-red` |
| 信息 | `--cr-status-info` | `--color-blue` |

半透明叠加色统一使用 `color-mix`：
```css
--cr-overlay-{status}-{opacity}: color-mix(in srgb, var(--cr-status-{status}) {opacity}%, transparent);
```

### 6.3 间距系统

4px 基准网格，所有间距通过 `--cr-space-*` 引用。

| Token | 值 | 用途 |
|-------|-----|------|
| `--cr-space-half` | `2px` | 微间距（badge 内边距） |
| `--cr-space-1` | `4px` | 最小间距（图标与文字） |
| `--cr-space-2` | `8px` | 紧凑间距（列表项内部） |
| `--cr-space-3` | `12px` | 标准间距（卡片内边距） |
| `--cr-space-4` | `16px` | 宽松间距（Section 间距） |
| `--cr-space-6` | `24px` | 大间距（面板内边距） |
| `--cr-space-8` | `32px` | 最大间距（空状态区域） |

间距规则：
- 同级元素间距用 `gap`，不用 `margin`
- 容器内边距用 `padding`
- 嵌套层级越深，间距越小


### 6.4 圆角与阴影

| Token | 值 | 用途 |
|-------|-----|------|
| `--cr-radius-sm` | `var(--radius-s)` | 按钮、badge |
| `--cr-radius-md` | `var(--radius-m)` | 卡片、Section |
| `--cr-radius-lg` | `var(--radius-l)` | 搜索框、大容器 |
| `--cr-radius-pill` | `999px` | 药丸形状 |
| `--cr-shadow-sm` | `var(--shadow-s)` | 卡片悬停 |
| `--cr-shadow-lg` | `var(--shadow-l)` | 浮动面板 |

### 6.5 按钮规范

四种变体：

| 变体 | 类名 | 用途 | 样式 |
|------|------|------|------|
| Primary | `cr-btn-primary` | 主操作（创建、接受） | 强调色背景 + 白字 |
| Secondary | `cr-btn-secondary` | 次要操作（改进、拒绝） | 边框 + 透明背景 |
| Ghost | `cr-btn-ghost` | 低优先级（清除、取消） | 无边框 + 透明背景 |
| Danger | `cr-btn-danger` | 危险操作（删除、清空） | 红色边框/背景 |

尺寸修饰符：
- 默认：`min-height: 32px`，`padding: 6px 12px`
- `cr-btn--sm`：`min-height: 28px`，`padding: 4px 8px`，`font-size: smaller`
- `cr-btn--icon`：正方形 `28px`，仅图标

按钮状态：

| 状态 | 视觉变化 |
|------|----------|
| 默认 | 按变体样式 |
| Hover | 背景色加深一级 |
| Focus | 2px 强调色轮廓 |
| Active | `scale(0.98)` |
| Disabled | `opacity: 0.5`, `cursor: not-allowed` |
| Loading | 旋转指示器，文字保留 |

禁止使用 Obsidian 原生按钮类（`mod-cta`、`mod-warning`）。

### 6.6 输入框宽度类

设置页输入框宽度通过 CSS 类控制，禁止 JS 内联 `style.width`：

| 类名 | 宽度 | 用途 |
|------|------|------|
| `cr-input-xs` | 80px | 数字输入 |
| `cr-input-sm` | 120px | 中等数字 |
| `cr-input-md` | 200px | 路径输入 |
| `cr-input-lg` | 300px | 模板输入 |

### 6.7 Diff 视图颜色

| 元素 | 深色主题 | 浅色主题 |
|------|----------|----------|
| 新增行背景 | `color-mix(success 15%)` | `color-mix(success 10%)` |
| 新增行左边线 | `--cr-status-success` 3px | 同左 |
| 删除行背景 | `color-mix(error 15%)` | `color-mix(error 10%)` |
| 删除行左边线 | `--cr-status-error` 3px | 同左 |
| 未变行 | 无背景 | 无背景 |


---

## 第七部分：无障碍与键盘导航

### 7.1 ARIA 标注规范

| 组件 | 必需 ARIA 属性 |
|------|----------------|
| 可折叠 Section header | `role="button"`, `tabindex="0"`, `aria-expanded`, `aria-controls` |
| Section 内容区 | `role="region"`, `aria-labelledby` |
| 队列展开指示器 | `role="button"`, `tabindex="0"`, `aria-expanded` |
| 状态文字 | `aria-live="polite"` |
| 图标按钮 | `aria-label`（描述操作，非图标名称） |
| 装饰性图标 | `aria-hidden="true"` |
| 禁用按钮 | `aria-disabled="true"` + `disabled` 属性 |
| Diff 标签页 | `role="document"`, 操作栏 `role="toolbar"` |
| 内联展开面板 | `aria-expanded` on trigger, `role="region"` on panel |

### 7.2 键盘导航

工作台面板 Tab 顺序：
1. 概念输入框
2. 清除按钮（有内容时）
3. 提交按钮（有内容时）
4. 操作按钮行：改进 → 拓展 → 配图 → 核查（有活跃笔记时）
5. 内联展开面板内的交互元素（展开时）
6. 队列状态指示器
7. 暂停/恢复按钮
8. 重复概念 Section header → 列表项（展开时）
9. 操作历史 Section header → 快照项（展开时）

Diff 标签页 Tab 顺序：
1. 视图模式切换
2. Diff 内容区（可滚动）
3. 合并名称选择（合并场景）
4. 拒绝按钮
5. 接受按钮

键盘快捷键：
- `Enter` / `Space`：触发按钮、切换折叠
- `Enter`（输入框内）：触发提交
- `Escape`：关闭内联展开面板 / 关闭 Diff 标签页
- `Ctrl+Enter`（Diff 标签页）：接受修改
- `ArrowLeft/Right`：设置页 Tab 切换

### 7.3 动画与减弱动效

- 内联展开/收起：`max-height` + `opacity` 过渡（200ms）
- 折叠/展开：`max-height` 过渡（200ms）
- 加载动画：CSS `@keyframes` 旋转
- 状态指示器：脉冲动画（1.5s 循环）
- 当 `prefers-reduced-motion: reduce` 时：禁用所有过渡和动画

```css
@media (prefers-reduced-motion: reduce) {
    .cr-scope * {
        transition: none !important;
        animation: none !important;
    }
}
```


---

## 第八部分：微交互规范

### 8.1 列表项交互（重复对/快照）

| 状态 | 视觉变化 |
|------|----------|
| 默认 | `--cr-bg-base` 背景，`--cr-border` 边框 |
| Hover | 背景变 `--cr-bg-hover`，操作按钮淡入 |
| Focus | 2px `--cr-border-focus` 轮廓 |

操作按钮默认 `opacity: 0`，hover/focus-within 时 `opacity: 1`，过渡 150ms。

### 8.2 内联展开动画

```css
.cr-inline-panel {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
}
.cr-inline-panel.is-expanded {
    max-height: 500px; /* 足够大的值 */
    opacity: 1;
}
```

### 8.3 状态指示器

```css
.cr-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    transition: background-color 0.2s ease;
}
.cr-status-dot.is-idle { background: var(--cr-text-faint); }
.cr-status-dot.is-running {
    background: var(--cr-text-accent);
    animation: cr-pulse 1.5s ease-in-out infinite;
}
.cr-status-dot.is-paused { background: var(--cr-status-warning); }
.cr-status-dot.is-error { background: var(--cr-status-error); }

@keyframes cr-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}
```

### 8.4 相似度进度条

- 高相似度 (>90%)：`--cr-status-error` 红色
- 中相似度 (80-90%)：`--cr-status-warning` 橙色
- 低相似度 (<80%)：`--cr-status-info` 蓝色
- 宽度 = `similarity * 100%`

### 8.5 置信度进度条（简化版）

- 最高置信度行：`--cr-text-accent` 强调色
- 其余行：`--cr-text-faint` 淡化色
- 不显示百分比数字，仅用条形长度表达强弱
- 条形高度 6px，圆角 3px

---

## 第九部分：响应式行为

| 宽度范围 | 适配策略 |
|----------|----------|
| < 280px | 操作按钮行换行，表格横向滚动 |
| 280-400px | 标准布局，单列排列 |
| > 400px | 标准布局（侧边栏面板通常不超过此宽度） |

Diff 标签页响应式：
| 宽度范围 | 适配策略 |
|----------|----------|
| < 600px | 仅支持统一视图，隐藏并排选项 |
| 600-900px | 支持统一和并排视图 |
| > 900px | 并排视图有更宽的列宽 |

## 第十部分：禁止清单

### CSS 禁止

- ❌ 直接使用 `var(--background-*)`, `var(--text-*)` 等 Obsidian 原生变量
- ❌ 使用 `mod-cta`, `mod-warning` 等 Obsidian 原生按钮类
- ❌ 硬编码颜色值（`#xxx`, `rgb()`, `rgba()`）
- ❌ 硬编码间距值（`12px`, `1.5em`）
- ❌ 在组件内定义新的 CSS 变量（所有变量集中在 `.cr-scope`）
- ❌ 使用 `!important`（除 `prefers-reduced-motion` 媒体查询外）

### JS/TS 禁止

- ❌ 通过 JS 设置固定布局样式（如 `style.width = "80px"`）
- ❌ 使用全局 DOM 查询（`document.querySelector`），必须限制在组件容器作用域内
- ❌ 在业务代码中散点 `new Notice(...)`（必须经统一反馈服务）
- ❌ 直接暴露 `result.error.message` 给用户

### UX 禁止

- ❌ 接受/拒绝按钮大小不对称（违反判断主权原则）
- ❌ AI 建议自动执行无需确认（违反主体性原则）
- ❌ 破坏性操作无撤销入口（违反可逆性原则）
- ❌ 错误消息仅显示技术细节无用户指引（违反错误可恢复原则）
- ❌ 功能入口在用户需要时不可见（违反可发现性原则）
- ❌ 操作后无任何视觉反馈（违反即时反馈原则）
- ❌ 轻量交互使用 Modal 打断工作台（违反不打断原则）
- ❌ Diff labels 依赖英文默认值（违反 i18n 完整性要求）
- ❌ 已完成任务显示在队列区（违反视觉轻量原则）

### 架构禁止

- ❌ Orchestrator 共性逻辑在多个类中复制
- ❌ "大一统 deps"接口扩散（按场景拆分最小依赖）
- ❌ 预留状态但无完整交互链路的功能（YAGNI 债务）
- ❌ 内联面板和 Modal 混用同一交互场景（一致性原则）

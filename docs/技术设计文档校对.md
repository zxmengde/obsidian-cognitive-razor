# Cognitive Razor — 技术设计文档校对

## 背景
- 基于 docs/TECHNICAL_DESIGN_DOCUMENT.md（标记为 SSOT）与当前代码（core/data/ui）对照，列出脱节点，供后续择优收敛。
- 评估标准：KISS、YAGNI、DRY、SOLID；优先关注功能契约、数据一致性、并发安全。

## 差异清单（细分 + 双边对比）
> 说明：每条记录列出 SSOT 描述 vs 代码现状，并附优劣与建议偏向。偏向判断以 KISS/YAGNI/DRY/SOLID 为准。

### 流程与队列
- **任务覆盖**
  - SSOT：所有 Define/Tag/Write/Index/Verify/Merge/Amend/Expand/Visualize 进入队列，统一状态机。
  - 代码：队列仅 define/tag/write/index/verify/image-generate；merge/incremental/standardize/embed 直连 Provider；Expand 未实现。
  - 优劣：SSOT统一但重；代码路径快但破坏一致性、重启恢复范围窄。**建议偏向 SSOT**（至少让写入类/合并类纳管，保持状态一致）。
- **调度时机**
  - SSOT：恢复 Pending 需用户/配置触发。
  - 代码：TaskQueue 初始化后自动 tryScheduleAll。
  - 优劣：SSOT更安全；代码更自动但可能在离线/半配置状态误触。**建议偏向 SSOT**（延迟调度、需用户 resume）。
- **锁模型**
  - SSOT：NodeLock + TypeLock，支持等待避免竞争。
  - 代码：SimpleLockManager 单 Set，无等待；DuplicateManager 临时用 `type:${type}` 字符串锁；TaskQueue 不检查类型锁。
  - 优劣：SSOT减少竞态；代码简单但可能双重入队/并发去重。**建议偏向 SSOT**（至少补 TypeLock 抽象和阻塞/重试策略）。

### 数据与索引
- **Embedding 与去重**
  - SSOT：Index 阶段重算 1536 维固定向量，再做去重。
  - 代码：create 时 embed；incremental/merge 仅更新时间戳复用旧 embedding；embeddingDimension 可配置。
  - 优劣：SSOT保证语义一致；代码快但去重可能陈旧且与“固定 1536”不符。**建议偏向 SSOT**（变更后重算 embedding，保持维度契约或在文档说明可配置）。
- **Frontmatter 契约**
  - SSOT：基础字段 + definition 入 frontmatter；无 parentUid/parentType/sourceUids/version。
  - 代码：额外 parentUid/parentType/sourceUids/version；definition 未入 frontmatter；时间格式符合。
  - 优劣：SSOT简洁；代码多字段利于溯源/父子，但文档未载明。**建议折中**：保留新增字段并在 SSOT 声明；同时补写 definition 以对齐。
- **快照策略**
  - SSOT：Define/Tag/Write 不建快照；Merge/Amend 必须快照 + Diff。
  - 代码：TaskRunner 写入前可建快照，但 create 写时 skipSnapshot=true；incremental/merge 在 PipelineOrchestrator 内建快照。
  - 优劣：SSOT清晰；代码双轨。**建议偏向 SSOT**：规范“仅破坏性操作建快照”，并统一入口（放 TaskRunner/Pipeline 之一）。
- **错误码与分类**
  - SSOT：E1xx…E5xx 分段；Result Monad。
  - 代码：E001/E100…体系；多处 throw 再 catch 包装。
  - 优劣：SSOT分类清；代码已有表但混用异常。**建议偏向 SSOT**：保持现有表但改为全 Result/err，避免裸 throw，并在 SSOT 记录现行码表。
- **Prompt 槽位与输出形态**
  - SSOT：Write/Define/Tag 输出原始 JSON（无 Markdown fence），字段如 definition/teleology/...，definition 应写入 frontmatter，同步到正文引用块。
  - 代码：
    - create 流：TaskRunner 用 PromptManager.build + schemaRegistry 校验 JSON；renderContentToMarkdown 把字段转 Markdown，但 definition 未写入 frontmatter，仅写正文，frontmatter 只含 cruid/type/name/status/parents/aliases/tags 等。
    - incremental/merge 流：PipelineOrchestrator 期望 LLM 直接返回含 frontmatter 的 Markdown（extractFrontmatter 后落盘），无 schema 校验，definition/frontmatter 完全依赖模型输出。
    - schemaRegistry 字段与 SSOT 基本一致，但 Issue/Mechanism 等字段顺序/命名以代码为准（含 boundary_conditions、stakeholder_perspectives 等）。
  - 优劣：SSOT统一 JSON 流、便于校验；代码双路径（JSON→Markdown vs Markdown直写），frontmatter definition 缺失，增量/合并无 schema 保障。**建议偏向 SSOT**：统一输出形态（JSON→渲染），在 frontmatter 写入 definition，并为增量/合并补最小字段校验。

### 交互与命令
- **Workbench 折叠默认**
  - SSOT：Create/Duplicate 展开，Queue/History 折叠。
  - 代码：duplicates/queue/recent 默认折叠。
  - 优劣：SSOT凸显主功能；代码更安静。**建议偏向 SSOT**（至少 duplicates 默认展开，凸显核心价值）。
- **命令矩阵**
  - SSOT：含 expand-current-note、visualize-concept、verify-concept 等。
  - 代码：create/incremental/merge/deepen/image；缺 expand/verify/visualize（除 image-generate）。
  - 优劣：SSOT完备；代码聚焦已实现。**建议折中**：文档标注“未实现”并规划优先级；短期先补 verify/visualize 触发通路或从文档删除。

### 架构与职责
- **分层/依赖方向**
  - SSOT：UI → Core → Data，核心通过抽象依赖；SRP/DIP。
  - 代码：PipelineOrchestrator 集成 LLM/文件/索引/去重/状态机，直接用 vault；类 >3k 行。
  - 优劣：SSOT更可维护；代码耦合高但落地快。**建议偏向 SSOT**：逐步拆分（LLM 调用、文件写入、去重/索引更新）为独立服务，UI 仍经 Core。

## 折中执行建议（优先序）
1) 先修“正确性/一致性”：
   - 增量/合并后重算 embedding + 去重；保持/记录维度契约。
   - 补 TypeLock 抽象与调度等待；启动不自动 resume。
   - 将 definition 写入 frontmatter；在 SSOT 写明额外字段（parentUid 等）。
2) 再修“体验/安全”：
   - Workbench 默认展开 duplicates；命令集标注未实现项。
   - 错误码改为全 err(Result) 流，减少 throw。
3) 后续“架构”：
   - 拆分 PipelineOrchestrator；统一快照策略到单入口。

> 以上偏向已在各条说明；如确认，我会据此更新 SSOT 文档版本，并输出对应代码改动清单（按优先级）。***


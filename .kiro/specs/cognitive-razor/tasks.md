# 实现计划

- [x] 1. 设置项目结构和核心接口
  - 创建 src/ 目录结构（ui/, core/, data/）
  - 定义 TypeScript 接口和类型（types.ts）
  - 配置 esbuild 和 tsconfig
  - 设置测试框架（Jest + fast-check）
  - _需求：所有_

- [x] 2. 实现数据模型和存储层

- [x] 2.1 创建核心数据模型
  - 实现 CRFrontmatter、TaskRecord、DuplicatePair 等接口
  - 实现数据验证函数
  - _需求：1.5, 6.1_

- [x] 2.2 编写属性测试：数据模型序列化 round trip
  - **属性 3: Stub 笔记元数据完整性**
  - **验证需求：1.5**

- [x] 2.3 实现 FileStorage 工具类
  - 实现原子写入（临时文件 + 重命名）
  - 实现目录创建和文件读写
  - _需求：9.1_

- [x] 2.4 编写属性测试：本地存储约束
  - **属性 17: 本地存储约束**
  - **验证需求：9.1**

- [x] 2.5 实现 Logger 组件
  - 实现循环日志（1MB 上限）
  - 实现日志级别过滤
  - _需求：所有（可观察性）_

- [x] 3. 实现向量索引和去重检测

- [x] 3.1 实现 VectorIndex 组件
  - 实现向量存储和检索（按类型分桶）
  - 实现余弦相似度计算
  - 实现 TopK 检索
  - _需求：2.1, 2.2, 9.3, 9.4_

- [x] 3.2 编写属性测试：同类型去重检索
  - **属性 4: 同类型去重检索**
  - **验证需求：2.1**

- [x] 3.3 编写属性测试：去重阈值判定
  - **属性 5: 去重阈值判定**
  - **验证需求：2.2**

- [x] 3.4 编写属性测试：向量本地存储
  - **属性 18: 向量本地存储**
  - **验证需求：9.3**

- [x] 3.5 编写属性测试：本地相似度检索
  - **属性 19: 本地相似度检索**
  - **验证需求：9.4**

- [x] 3.6 实现 DuplicateManager 组件
  - 实现重复对检测和记录
  - 实现重复对状态管理
  - 实现合并协调逻辑
  - _需求：2.2, 2.3, 7.5_

- [x] 3.7 编写属性测试：重复对显示完整性
  - **属性 6: 重复对显示完整性**
  - **验证需求：2.3, 2.4**

- [x] 4. 实现快照和撤销机制

- [x] 4.1 实现 UndoManager 组件
  - 实现快照创建和存储
  - 实现快照恢复
  - 实现快照清理策略
  - _需求：5.1, 5.3, 5.4_

- [x] 4.2 编写属性测试：写入前快照创建
  - **属性 10: 写入前快照创建**
  - **验证需求：5.1**

- [x] 4.3 编写属性测试：撤销操作 round trip
  - **属性 11: 撤销操作 round trip**
  - **验证需求：5.3**

- [x] 4.4 编写属性测试：快照清理策略
  - **属性 12: 快照清理策略**
  - **验证需求：5.4**

- [x] 5. 实现任务队列和锁机制





- [x] 5.1 实现 LockManager 组件


  - 实现节点锁和类型锁
  - 实现锁获取和释放
  - 实现锁冲突检测
  - _需求：6.2_

- [x] 5.2 编写属性测试：节点锁互斥


  - **属性 13: 节点锁互斥**
  - **验证需求：6.2**

- [x] 5.3 实现 TaskQueue 组件


  - 实现任务入队和持久化
  - 实现并发调度
  - 实现任务状态管理
  - 实现暂停/恢复功能
  - _需求：6.1, 6.3, 6.4_

- [x] 5.4 编写属性测试：任务取消释放锁


  - **属性 14: 任务取消释放锁**
  - **验证需求：6.5**

- [x] 6. 实现错误处理和重试逻辑（Provider API 调用容错机制）






- [x] 6.1 实现 ProviderManager 组件



  - 实现 Google Gemini Provider
  - 实现 OpenAI Provider
  - 实现 OpenRouter Provider
  - 实现 Provider 能力检测
  - _需求：8.2, 8.3_

- [x] 6.2 编写属性测试：认证错误终止


  - **属性 21: 认证错误终止**
  - **验证需求：10.3**

- [x] 6.3 编写属性测试：速率限制退避

  - **属性 22: 速率限制退避**
  - **验证需求：10.2**

- [x] 6.4 实现错误处理和重试逻辑


  - 实现结构化重试
  - 实现指数退避重试
  - 实现错误码映射
  - _需求：10.1, 10.2, 10.3, 10.4_

- [x] 6.5 编写属性测试：重试上限

  - **属性 20: 重试上限**
  - **验证需求：10.1, 10.4**


- [x] 7. 实现提示词管理和内容验证（PromptManager 和 Validator）




- [x] 7.1 实现 PromptManager 组件


  - 实现模板加载和解析
  - 实现槽位插值
  - 实现共享约束注入
  - _需求：3.1_

- [x] 7.2 创建提示词模板


  - 创建 standardizeClassify.md
  - 创建 enrich.md
  - 创建 reason-domain.md
  - 创建 reason-issue.md
  - 创建 reason-theory.md
  - 创建 reason-entity.md
  - 创建 reason-mechanism.md
  - 创建 reason-incremental.md
  - 创建 reason-merge.md
  - _需求：1.1, 3.1, 4.2, 7.2_

- [x] 7.3 实现 Validator 组件


  - 实现 JSON 解析校验
  - 实现 Schema 校验
  - 实现业务规则校验（C001-C009）
  - _需求：3.2, 3.3, 3.4_

- [x] 7.4 编写属性测试：Issue 类型格式约束


  - **属性 7: Issue 类型格式约束**
  - **验证需求：3.2**

- [x] 7.5 编写属性测试：Theory 类型最小约束

  - **属性 8: Theory 类型最小约束**
  - **验证需求：3.3**

- [x] 7.6 编写属性测试：Mechanism 类型最小约束

  - **属性 9: Mechanism 类型最小约束**
  - **验证需求：3.4**


- [x] 8. 实现任务执行器（TaskRunner 和 AI 内容生成流程）




- [x] 8.1 实现 TaskRunner 组件


  - 实现任务执行流程
  - 实现 Provider 调用
  - 实现结果验证
  - 实现写入协调
  - _需求：1.1, 3.1, 4.2, 7.2_

- [x] 8.2 编写属性测试：标准化输出完整性


  - **属性 1: 标准化输出完整性**
  - **验证需求：1.1, 1.2, 1.3**

- [x] 8.3 编写属性测试：类型置信度总和恒等


  - **属性 2: 类型置信度总和恒等**
  - **验证需求：1.3**


- [x] 9. 实现配置管理和数据迁移（SettingsStore 和版本升级）




- [x] 9.1 实现 SettingsStore 组件


  - 实现配置读写
  - 实现配置验证
  - 实现配置导入导出
  - _需求：8.5, 9.5_

- [x] 9.2 实现 MigrationRunner 组件


  - 实现版本检测
  - 实现迁移脚本执行
  - 实现迁移失败处理
  - _需求：8.1_

- [x] 10. 实现用户界面组件（WorkbenchPanel、QueueView、DiffView 等）





- [x] 10.1 实现 WorkbenchPanel 组件


  - 实现创建概念区域
  - 实现重复概念面板
  - 实现队列状态区域
  - 实现最近操作区域
  - _需求：1.1, 2.3, 6.1, 5.5_

- [x] 10.2 实现 QueueView 组件


  - 实现任务列表显示
  - 实现任务操作（取消、重试）
  - 实现并发控制
  - _需求：6.3, 6.4, 6.5_

- [x] 10.3 实现 DiffView 组件


  - 实现差异显示
  - 实现逐项确认
  - 实现接受/放弃操作
  - _需求：4.3, 7.3_

- [x] 10.4 实现 StatusBadge 组件


  - 实现状态栏徽章
  - 实现快捷入口
  - _需求：6.1, 10.5_

- [x] 10.5 实现 CommandDispatcher 组件


  - 注册所有命令
  - 实现快捷键绑定
  - 实现命令分发
  - _需求：12.1, 12.2_

- [x] 10.6 编写属性测试：键盘焦点导航


  - **属性 23: 键盘焦点导航**
  - **验证需求：12.3**

- [x] 10.7 编写属性测试：键盘操作触发

  - **属性 24: 键盘操作触发**
  - **验证需求：12.4**

- [x] 10.8 编写属性测试：屏幕阅读器支持

  - **属性 25: 屏幕阅读器支持**
  - **验证需求：12.5**


- [x] 11. 实现插件主入口和生命周期管理（main.ts 和初始化流程）




- [x] 11.1 实现 main.ts


  - 实现 onload 生命周期
  - 实现 onunload 生命周期
  - 注册所有组件
  - 实现首次配置向导
  - _需求：8.1_

- [x] 11.2 实现配置向导


  - 实现 Provider 选择界面
  - 实现 API Key 验证
  - 实现配置保存
  - _需求：8.1, 8.2, 8.3, 8.4, 8.5_


- [x] 12. 实现增量改进流程（笔记内容渐进式完善功能）




- [x] 12.1 实现增量改进触发


  - 添加笔记右键菜单项
  - 实现意图输入框
  - 生成 reason:incremental 任务
  - _需求：4.1, 4.2_

- [x] 12.2 实现增量改进预览和确认


  - 实现 Diff 生成
  - 实现确认写入
  - 实现状态降级
  - _需求：4.3, 4.4, 4.5_

- [x] 12.3 编写属性测试：Evergreen 降级


  - **属性 16: Evergreen 降级**
  - **验证需求：4.5**


- [x] 13. 实现重复概念合并流程（AI 辅助的笔记合并功能）




- [x] 13.1 实现合并任务生成


  - 实现合并按钮处理
  - 生成 reason:merge 任务
  - _需求：7.1_

- [x] 13.2 实现合并内容生成和预览


  - 实现 AI 合并内容生成
  - 实现合并预览
  - _需求：7.2, 7.3_

- [x] 13.3 实现合并确认和清理


  - 实现合并写入
  - 删除被合并笔记
  - 更新向量索引
  - 移除重复对
  - _需求：7.4, 7.5_

- [x] 13.4 编写属性测试：合并后清理


  - **属性 15: 合并后清理**
  - **验证需求：7.4, 7.5**


- [x] 14. 实现样式和主题适配（CSS 样式和暗色主题支持）





- [x] 14.1 创建 styles.css


  - 实现 WorkbenchPanel 样式
  - 实现 QueueView 样式
  - 实现 DiffView 样式
  - 实现响应式布局
  - _需求：所有（UI）_

- [x] 14.2 实现暗色主题支持


  - 适配 Obsidian 暗色主题
  - 实现主题切换
  - _需求：所有（UI）_


- [x] 15. 编写端到端集成测试（完整功能流程验证）






- [x] 15.1 编写集成测试：完整创建流程

  - 测试从用户输入到笔记创建的端到端流程
  - _需求：1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 3.1_


- [x] 15.2 编写集成测试：合并流程

  - 测试从检测重复到合并完成的端到端流程
  - _需求：2.2, 2.3, 7.1, 7.2, 7.3, 7.4, 7.5_


- [x] 15.3 编写集成测试：增量改进流程

  - 测试从触发改进到写入完成的端到端流程
  - _需求：4.1, 4.2, 4.3, 4.4, 4.5_


- [x] 15.4 编写集成测试：撤销流程

  - 测试从写入到撤销的端到端流程
  - _需求：5.1, 5.2, 5.3_


- [x] 15.5 编写集成测试：队列管理

  - 测试任务入队、执行、取消的集成流程
  - _需求：6.1, 6.2, 6.3, 6.4, 6.5_


- [x] 16. 修复失败的属性测试





- [x] 16.1 修复 UndoManager 属性测试 10

  - 修复写入前快照创建测试中的失败案例
  - 确保快照创建在所有情况下都能正确工作
  - **属性 10: 写入前快照创建**
  - **验证需求：5.1**

- [ ] 17. 最终质量检查点（确保所有测试通过和功能完整）
  - 运行完整测试套件确保所有测试通过
  - 验证所有核心功能正常工作
  - 确保没有遗留的 bug 或问题
  - _需求：所有_

- [x] 18. 编写用户文档和开发文档（README、使用指南、FAQ）







- [x] 17.1 更新 README.md

  - 添加功能介绍
  - 添加安装说明
  - 添加使用指南
  - 添加配置说明
  - _需求：所有_


- [x] 18.2 创建用户文档
  - 创建快速开始指南
  - 创建常见问题解答
  - 创建故障排除指南
  - _需求：所有_

- [x] 19. 准备插件发布（构建、打包和发布流程）





- [x] 19.1 更新 manifest.json
  - 设置正确的版本号
  - 设置正确的 minAppVersion
  - 完善描述和作者信息
  - _需求：所有_

- [x] 19.2 构建发布版本


  - 运行 npm run build
  - 验证 main.js 生成
  - 测试插件加载
  - _需求：所有_

- [x] 19.3 创建发布包


  - 准备 main.js、manifest.json、styles.css
  - 创建 GitHub Release
  - _需求：所有_

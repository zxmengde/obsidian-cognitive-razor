# 需求文档

## 简介

Cognitive Razor 是一个 Obsidian 插件，旨在帮助用户将模糊的概念转化为结构化的知识节点。插件通过 AI 辅助，实现概念的标准化、分类、内容生成和语义去重，同时保持本地优先和人机协作的原则。

## 术语表

- **System（系统）**：Cognitive Razor 插件
- **User（用户）**：使用 Obsidian 和本插件的知识工作者
- **Concept（概念）**：知识管理的原子单位，具有唯一标识符
- **Knowledge Type（知识类型）**：五种类型之一：Domain（领域）、Issue（议题）、Theory（理论）、Entity（实体）、Mechanism（机制）
- **Provider（提供商）**：AI 服务提供商（Google Gemini、OpenAI、OpenRouter）
- **Task（任务）**：系统执行的原子操作单元
- **Queue（队列）**：任务调度和管理组件
- **Snapshot（快照）**：用于撤销操作的文件备份
- **Vector Index（向量索引）**：本地存储的概念向量嵌入数据库
- **Duplicate Pair（重复对）**：语义相似度超过阈值的两个概念
- **Frontmatter（前置元数据）**：Markdown 文件头部的 YAML 格式元数据

## 需求

### 需求 1：概念创建与标准化

**用户故事**：作为知识工作者，我想要快速将模糊的想法转化为结构化的概念节点，以便系统化地管理知识。

#### 验收标准

1. WHEN 用户输入概念描述 THEN 系统应调用 AI 进行标准化处理并生成中英文标准名称
2. WHEN 标准化完成 THEN 系统应生成 3-10 个别名供用户参考
3. WHEN 标准化完成 THEN 系统应判断知识类型并给出五种类型的置信度分数
4. WHEN 类型置信度最高值低于 0.6 THEN 系统应提示用户手动选择类型
5. WHEN 用户确认创建 THEN 系统应生成包含 UID、类型、状态等元数据的 Stub 笔记

### 需求 2：语义去重检测

**用户故事**：作为知识工作者，我想要系统自动检测重复的概念，以便避免知识库中的冗余和混乱。

#### 验收标准

1. WHEN 新概念创建完成 THEN 系统应在同类型概念中执行语义相似度检索
2. WHEN 相似度大于等于阈值（默认 0.9）THEN 系统应将重复对记录到 DuplicatePairs 存储
3. WHEN 检测到重复对 THEN 系统应在侧边栏 DuplicatesPanel 中显示待处理项
4. WHEN 用户查看重复对 THEN 系统应显示两个概念的名称、相似度和类型
5. WHEN 用户选择合并 THEN 系统应生成 AI 辅助的合并任务

### 需求 3：AI 内容生成

**用户故事**：作为知识工作者，我想要 AI 根据概念类型生成结构化的内容，以便快速建立知识框架。

#### 验收标准

1. WHEN Stub 笔记创建后 THEN 系统应根据知识类型生成对应的结构化内容
2. WHEN 生成 Issue 类型内容 THEN 系统应确保 core_tension 字段匹配 "X vs Y" 格式
3. WHEN 生成 Theory 类型内容 THEN 系统应包含至少 1 个公理（axiom）
4. WHEN 生成 Mechanism 类型内容 THEN 系统应包含至少 2 步因果链（causal_chain）
5. WHEN 内容生成完成 THEN 系统应展示预览并要求用户显式确认写入

### 需求 4：增量改进

**用户故事**：作为知识编辑者，我想要对现有笔记进行增量改进，以便逐步完善知识内容。

#### 验收标准

1. WHEN 用户触发增量改进 THEN 系统应弹出意图输入框
2. WHEN 用户输入改进意图 THEN 系统应调用 AI 生成改进后的内容
3. WHEN 改进内容生成完成 THEN 系统应在 DiffView 中展示原内容和新内容的差异
4. WHEN 用户确认改进 THEN 系统应创建快照并写入新内容
5. WHEN Evergreen 笔记被改进 THEN 系统应将状态降级为 Draft

### 需求 5：可逆写入

**用户故事**：作为用户，我想要能够撤销任何已确认的写入操作，以便在发现错误时恢复原状。

#### 验收标准

1. WHEN 系统执行任何写入操作前 THEN 系统应创建文件快照
2. WHEN 写入完成 THEN 系统应在通知中显示"撤销"按钮（5 秒内可点击）
3. WHEN 用户点击撤销 THEN 系统应恢复快照内容并删除快照文件
4. WHEN 快照数量达到上限（默认 100）THEN 系统应自动清理最旧的快照
5. WHEN 用户查看操作历史 THEN 系统应显示所有可撤销的操作列表

### 需求 6：任务队列管理

**用户故事**：作为用户，我想要查看和管理正在执行的任务，以便控制系统的工作流程。

#### 验收标准

1. WHEN 任务加入队列 THEN 系统应在状态栏显示任务计数
2. WHEN 同一概念已有任务在执行 THEN 系统应拒绝新任务并提示锁冲突
3. WHEN 用户打开队列视图 THEN 系统应显示进行中、等待中、已完成和失败的任务
4. WHEN 用户暂停队列 THEN 系统应停止执行新任务但保留当前任务
5. WHEN 用户取消任务 THEN 系统应释放相关锁并更新任务状态

### 需求 7：重复概念合并

**用户故事**：作为知识工作者，我想要合并重复的概念，以便保持知识库的整洁和一致性。

#### 验收标准

1. WHEN 用户在 DuplicatesPanel 中点击合并 THEN 系统应生成 reason:merge 任务
2. WHEN 合并任务执行 THEN 系统应调用 AI 读取两篇笔记并生成合并后的内容
3. WHEN 合并内容生成完成 THEN 系统应在 DiffView 中展示合并预览
4. WHEN 用户确认合并 THEN 系统应将合并内容写入主笔记并删除被合并笔记
5. WHEN 合并完成 THEN 系统应从 DuplicatePairs 中移除该重复对并更新向量索引

### 需求 8：Provider 配置

**用户故事**：作为系统管理员，我想要配置 AI 服务提供商，以便使用不同的 API 和模型。

#### 验收标准

1. WHEN 用户首次启用插件 THEN 系统应打开配置向导
2. WHEN 用户选择 Provider THEN 系统应显示对应的配置表单
3. WHEN 用户输入 API Key THEN 系统应验证 Key 的有效性
4. WHEN 验证失败 THEN 系统应显示错误原因并允许重试
5. WHEN 配置完成 THEN 系统应创建 data/ 目录结构并保存配置

### 需求 9：本地优先存储

**用户故事**：作为用户，我想要所有数据都存储在本地，以便保持数据主权和隐私。

#### 验收标准

1. WHEN 系统持久化数据 THEN 系统应将所有数据存储在 .obsidian/plugins/obsidian-cognitive-razor/data/ 目录
2. WHEN 系统调用 AI API THEN 系统应仅发送用户明确输入的概念信息
3. WHEN 系统生成向量嵌入 THEN 系统应将向量存储在本地 vector-index.json 文件
4. WHEN 系统执行相似度检索 THEN 系统应在本地向量索引中执行
5. WHEN 用户导出配置 THEN 系统应生成包含所有设置的 JSON 文件

### 需求 10：错误处理与重试

**用户故事**：作为用户，我想要系统能够优雅地处理错误并自动重试，以便提高操作的成功率。

#### 验收标准

1. WHEN AI 返回非 JSON 输出 THEN 系统应记录错误并执行结构化重试（最多 3 次）
2. WHEN API 返回 429 速率限制错误 THEN 系统应使用指数退避策略自动重试
3. WHEN API 返回 401 认证错误 THEN 系统应终止任务并提示用户检查 API Key
4. WHEN 任务重试 3 次仍失败 THEN 系统应将任务标记为失败并记录详细错误信息
5. WHEN 网络不可用 THEN 系统应暂停队列并在状态栏显示离线图标

### 需求 11：渐进披露

**用户故事**：作为新手用户，我想要看到简化的界面，以便快速上手而不被复杂选项困扰。

#### 验收标准

1. WHEN 用户首次使用 THEN 系统应默认隐藏高级参数（模型选择、温度、TopP 等）
2. WHEN 用户启用高级模式 THEN 系统应显示所有高级配置选项
3. WHEN 用户在编辑器中输入 THEN 系统应静默非关键通知
4. WHEN 发生关键错误 THEN 系统应使用模态对话框通知用户
5. WHEN 任务完成 THEN 系统应仅更新状态栏而不打断用户

### 需求 12：键盘操作支持

**用户故事**：作为用户，我想要通过键盘高效操作插件，以便提高工作效率。

#### 验收标准

1. WHEN 用户按下 Ctrl/Cmd + Shift + N THEN 系统应打开创建概念界面
2. WHEN 用户按下 Ctrl/Cmd + Shift + Q THEN 系统应打开队列视图
3. WHEN 用户使用 Tab 键 THEN 系统应在交互元素间切换焦点
4. WHEN 用户按下 Enter 键在聚焦的按钮上 THEN 系统应触发对应操作
5. WHEN 用户使用屏幕阅读器 THEN 系统应提供 aria-label 和 aria-live 支持

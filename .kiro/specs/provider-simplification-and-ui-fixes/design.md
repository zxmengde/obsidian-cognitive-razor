# è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬è®¾è®¡æ–‡æ¡£æ—¨åœ¨è§£å†³ Cognitive Razor æ’ä»¶ä¸­çš„ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š

1. **Provider ç®€åŒ–**ï¼šç§»é™¤å†—ä½™çš„ OpenRouter Providerï¼Œä»…ä¿ç•™ OpenAI å’Œ Gemini ä¸¤ç§ç±»å‹ï¼Œå¹¶æ”¯æŒè‡ªå®šä¹‰ç«¯ç‚¹é…ç½®
2. **è®¾ç½®ç•Œé¢ä¿®å¤**ï¼šä¿®å¤ `prompt() is not supported` é”™è¯¯ï¼Œä½¿ç”¨ Obsidian Modal æ›¿ä»£æ‰€æœ‰ prompt è°ƒç”¨
3. **åŠŸèƒ½å®Œæ•´å®ç°**ï¼šå®ç°æ‰€æœ‰å¾…å®ç°çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬åˆ›å»ºæ¦‚å¿µã€é˜Ÿåˆ—è¯¦æƒ…ã€é‡å¤ç®¡ç†ã€å¢é‡æ”¹è¿›å’Œæ’¤é”€ç­‰

## æ¶æ„

### ä¿®æ”¹çš„ç»„ä»¶

æœ¬æ¬¡ä¿®æ”¹æ¶‰åŠä»¥ä¸‹ç»„ä»¶ï¼š

1. **ProviderManager**ï¼šç§»é™¤ OpenRouter æ”¯æŒï¼Œæ·»åŠ è‡ªå®šä¹‰ç«¯ç‚¹é…ç½®
2. **SettingsTab**ï¼šä½¿ç”¨ Modal æ›¿ä»£ prompt()ï¼Œå®ç°æ‰€æœ‰æŒ‰é’®åŠŸèƒ½
3. **SetupWizard**ï¼šæ·»åŠ è‡ªå®šä¹‰ç«¯ç‚¹é…ç½®ï¼Œç§»é™¤ OpenRouter é€‰é¡¹
4. **WorkbenchPanel**ï¼šå®ç°å®Œæ•´çš„åˆ›å»ºæ¦‚å¿µæµç¨‹
5. **QueueView**ï¼šå®ç°å®Œæ•´çš„é˜Ÿåˆ—è¯¦æƒ…å’Œæ“ä½œåŠŸèƒ½
6. **æ–°å¢ Modal ç»„ä»¶**ï¼šTextInputModalã€SelectModalã€ConfirmModal

### ç»„ä»¶å…³ç³»å›¾

```mermaid
graph TD
    A[SettingsTab] --> B[ProviderConfigModal]
    A --> C[ConfirmModal]
    D[SetupWizard] --> B
    E[WorkbenchPanel] --> F[TextInputModal]
    G[QueueView] --> C
    H[ProviderManager] --> I[OpenAIProvider]
    H --> J[GeminiProvider]
    
    style H fill:#f9f,stroke:#333
    style A fill:#bbf,stroke:#333
    style D fill:#bbf,stroke:#333
```

## ç»„ä»¶å’Œæ¥å£

### Modal ç»„ä»¶æ¥å£

#### TextInputModal

ç”¨äºæ›¿ä»£ `prompt()` çš„æ–‡æœ¬è¾“å…¥å¯¹è¯æ¡†ã€‚

```typescript
interface TextInputModalOptions {
  title: string;
  placeholder?: string;
  defaultValue?: string;
  validator?: (value: string) => string | null; // è¿”å›é”™è¯¯æ¶ˆæ¯æˆ– null
  onSubmit: (value: string) => void;
  onCancel?: () => void;
}

class TextInputModal extends Modal {
  constructor(app: App, options: TextInputModalOptions);
}
```

#### SelectModal

ç”¨äºé€‰æ‹©é€‰é¡¹çš„å¯¹è¯æ¡†ã€‚

```typescript
interface SelectOption {
  value: string;
  label: string;
  description?: string;
}

interface SelectModalOptions {
  title: string;
  options: SelectOption[];
  onSelect: (value: string) => void;
  onCancel?: () => void;
}

class SelectModal extends Modal {
  constructor(app: App, options: SelectModalOptions);
}
```

#### ConfirmModal

ç”¨äºç¡®è®¤æ“ä½œçš„å¯¹è¯æ¡†ã€‚

```typescript
interface ConfirmModalOptions {
  title: string;
  message: string;
  confirmText?: string;
  cancelText?: string;
  danger?: boolean;
  onConfirm: () => void;
  onCancel?: () => void;
}

class ConfirmModal extends Modal {
  constructor(app: App, options: ConfirmModalOptions);
}
```

#### ProviderConfigModal

ç”¨äºé…ç½® Provider çš„å¯¹è¯æ¡†ã€‚

```typescript
interface ProviderConfigModalOptions {
  mode: 'add' | 'edit';
  providerId?: string;
  providerType?: ProviderType;
  currentConfig?: ProviderConfig;
  onSave: (id: string, config: ProviderConfig) => Promise<void>;
  onCancel?: () => void;
}

class ProviderConfigModal extends Modal {
  constructor(app: App, options: ProviderConfigModalOptions);
}
```

### ProviderManager æ¥å£æ›´æ–°

```typescript
interface ProviderConfig {
  type: 'openai' | 'google'; // ç§»é™¤ 'openrouter'
  apiKey: string;
  baseUrl?: string; // æ–°å¢ï¼šè‡ªå®šä¹‰ç«¯ç‚¹
  defaultChatModel: string;
  defaultEmbedModel: string;
  enabled: boolean;
}

// é»˜è®¤ç«¯ç‚¹é…ç½®
const DEFAULT_ENDPOINTS = {
  openai: 'https://api.openai.com/v1',
  google: 'https://generativelanguage.googleapis.com/v1beta'
};
```

### WorkbenchPanel æ¥å£

```typescript
interface WorkbenchPanel {
  // åˆ›å»ºæ¦‚å¿µåŒºåŸŸ
  renderCreateSection(): void;
  handleStandardize(input: string): Promise<void>;
  handleCreate(standardizedData: StandardizedConcept): Promise<void>;
  
  // é‡å¤æ¦‚å¿µåŒºåŸŸ
  renderDuplicatesSection(): void;
  handleMerge(pairId: string): Promise<void>;
  handleDismiss(pairId: string): Promise<void>;
  
  // é˜Ÿåˆ—çŠ¶æ€åŒºåŸŸ
  renderQueueSection(): void;
  openQueueView(): void;
  
  // æœ€è¿‘æ“ä½œåŒºåŸŸ
  renderRecentSection(): void;
  handleUndo(snapshotId: string): Promise<void>;
}
```

### QueueView æ¥å£

```typescript
interface QueueView {
  // ä»»åŠ¡åˆ—è¡¨
  renderTaskList(): void;
  handleTaskClick(taskId: string): void;
  
  // ä»»åŠ¡æ“ä½œ
  handleCancel(taskId: string): Promise<void>;
  handleRetry(taskId: string): Promise<void>;
  
  // é˜Ÿåˆ—æ§åˆ¶
  handlePause(): void;
  handleResume(): void;
  handleClear(): void;
}
```

## æ•°æ®æ¨¡å‹

### Provider é…ç½®æ¨¡å‹

```typescript
// ç®€åŒ–åçš„ Provider ç±»å‹
type ProviderType = 'openai' | 'google';

// Provider é…ç½®
interface ProviderConfig {
  type: ProviderType;
  apiKey: string;
  baseUrl?: string; // è‡ªå®šä¹‰ç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰
  defaultChatModel: string;
  defaultEmbedModel: string;
  enabled: boolean;
}

// é»˜è®¤é…ç½®
const DEFAULT_PROVIDER_CONFIGS: Record<ProviderType, Partial<ProviderConfig>> = {
  openai: {
    baseUrl: 'https://api.openai.com/v1',
    defaultChatModel: 'gpt-4-turbo-preview',
    defaultEmbedModel: 'text-embedding-3-small'
  },
  google: {
    baseUrl: 'https://generativelanguage.googleapis.com/v1beta',
    defaultChatModel: 'gemini-1.5-flash',
    defaultEmbedModel: 'text-embedding-004'
  }
};
```

### æ ‡å‡†åŒ–æ¦‚å¿µæ¨¡å‹

```typescript
interface StandardizedConcept {
  standardName: {
    chinese: string;
    english: string;
  };
  aliases: string[];
  typeConfidences: {
    Domain: number;
    Issue: number;
    Theory: number;
    Entity: number;
    Mechanism: number;
  };
  coreDefinition: string;
}
```

### ä»»åŠ¡è¯¦æƒ…æ¨¡å‹

```typescript
interface TaskDetails extends TaskRecord {
  // æ‰©å±•å­—æ®µç”¨äº UI æ˜¾ç¤º
  providerName?: string;
  elapsedTime?: number;
  estimatedTime?: number;
}
```

## æ­£ç¡®æ€§å±æ€§

*å±æ€§æ˜¯ä¸€ä¸ªåº”è¯¥åœ¨æ‰€æœ‰æœ‰æ•ˆæ‰§è¡Œä¸­ä¿æŒä¸ºçœŸçš„ç‰¹å¾æˆ–è¡Œä¸ºâ€”â€”æœ¬è´¨ä¸Šæ˜¯å…³äºç³»ç»Ÿåº”è¯¥åšä»€ä¹ˆçš„å½¢å¼åŒ–é™ˆè¿°ã€‚å±æ€§ä½œä¸ºäººç±»å¯è¯»è§„èŒƒå’Œæœºå™¨å¯éªŒè¯æ­£ç¡®æ€§ä¿è¯ä¹‹é—´çš„æ¡¥æ¢ã€‚*

### å±æ€§ 1ï¼šProvider ç±»å‹é™åˆ¶

*å¯¹äºä»»æ„*ç³»ç»Ÿåˆå§‹åŒ–ï¼Œå¯ç”¨çš„ Provider ç±»å‹åˆ—è¡¨å¿…é¡»ä»…åŒ…å« 'openai' å’Œ 'google'ï¼Œä¸å¾—åŒ…å«å…¶ä»–ç±»å‹ã€‚

**éªŒè¯éœ€æ±‚**ï¼š1.1

### å±æ€§ 2ï¼šURL æ ¼å¼éªŒè¯

*å¯¹äºä»»æ„*è¾“å…¥çš„ç«¯ç‚¹ URL å­—ç¬¦ä¸²ï¼ŒéªŒè¯å‡½æ•°å¿…é¡»æ­£ç¡®è¯†åˆ«æœ‰æ•ˆçš„ HTTP/HTTPS URL æ ¼å¼ï¼Œæ‹’ç»æ— æ•ˆæ ¼å¼ã€‚

**éªŒè¯éœ€æ±‚**ï¼š1.4, 3.3

### å±æ€§ 3ï¼šè‡ªå®šä¹‰ç«¯ç‚¹æŒä¹…åŒ–

*å¯¹äºä»»æ„*ä¿å­˜çš„ Provider é…ç½®ï¼Œå¦‚æœåŒ…å«è‡ªå®šä¹‰ç«¯ç‚¹ï¼Œåˆ™åç»­çš„ API è°ƒç”¨å¿…é¡»ä½¿ç”¨è¯¥è‡ªå®šä¹‰ç«¯ç‚¹è€Œéé»˜è®¤ç«¯ç‚¹ã€‚

**éªŒè¯éœ€æ±‚**ï¼š1.5

### å±æ€§ 4ï¼šModal æ›¿ä»£ prompt

*å¯¹äºä»»æ„*éœ€è¦ç”¨æˆ·è¾“å…¥çš„åœºæ™¯ï¼Œç³»ç»Ÿå¿…é¡»ä½¿ç”¨ Modal ç»„ä»¶ï¼ˆTextInputModalã€SelectModal æˆ– ConfirmModalï¼‰ï¼Œä¸å¾—è°ƒç”¨ `window.prompt()`ã€‚

**éªŒè¯éœ€æ±‚**ï¼š2.1, 10.1, 10.2, 10.3

### å±æ€§ 5ï¼šProvider ç±»å‹è¡¨å•æ˜ å°„

*å¯¹äºä»»æ„*é€‰æ‹©çš„ Provider ç±»å‹ï¼Œé…ç½®è¡¨å•å¿…é¡»æ˜¾ç¤ºå¯¹åº”ç±»å‹çš„é»˜è®¤ç«¯ç‚¹ã€é»˜è®¤æ¨¡å‹å’Œç›¸å…³é…ç½®é¡¹ã€‚

**éªŒè¯éœ€æ±‚**ï¼š2.2, 3.2

### å±æ€§ 6ï¼šé…ç½®ä¿å­˜å®Œæ•´æ€§

*å¯¹äºä»»æ„*é€šè¿‡ Modal ä¿å­˜çš„ Provider é…ç½®ï¼Œé…ç½®æ–‡ä»¶ä¸­å¿…é¡»åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆtypeã€apiKeyã€baseUrlã€defaultChatModelã€defaultEmbedModelã€enabledï¼‰ã€‚

**éªŒè¯éœ€æ±‚**ï¼š2.4, 3.4

### å±æ€§ 7ï¼šModal å–æ¶ˆä¸ä¿å­˜

*å¯¹äºä»»æ„*æ‰“å¼€çš„é…ç½® Modalï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆæˆ–æŒ‰ Escape é”®ï¼Œåˆ™é…ç½®æ–‡ä»¶å¿…é¡»ä¿æŒä¸å˜ã€‚

**éªŒè¯éœ€æ±‚**ï¼š2.5, 10.5

### å±æ€§ 8ï¼šæ ‡å‡†åŒ–è¾“å‡ºè§¦å‘

*å¯¹äºä»»æ„*åœ¨ Workbench ä¸­è¾“å…¥çš„éç©ºæ¦‚å¿µæè¿°ï¼Œç‚¹å‡»æ ‡å‡†åŒ–æŒ‰é’®å¿…é¡»åˆ›å»ºä¸€ä¸ª standardizeClassify ç±»å‹çš„ä»»åŠ¡ã€‚

**éªŒè¯éœ€æ±‚**ï¼š4.2

### å±æ€§ 9ï¼šæ ‡å‡†åŒ–ç»“æœæ˜¾ç¤ºå®Œæ•´æ€§

*å¯¹äºä»»æ„*å®Œæˆçš„æ ‡å‡†åŒ–ä»»åŠ¡ï¼ŒUI å¿…é¡»æ˜¾ç¤ºä¸­æ–‡åã€è‹±æ–‡åã€åˆ«ååˆ—è¡¨å’Œäº”ç§ç±»å‹çš„ç½®ä¿¡åº¦åˆ†æ•°ã€‚

**éªŒè¯éœ€æ±‚**ï¼š4.3

### å±æ€§ 10ï¼šç¬”è®°åˆ›å»ºè§¦å‘

*å¯¹äºä»»æ„*ç¡®è®¤çš„æ ‡å‡†åŒ–ç»“æœï¼Œç‚¹å‡»åˆ›å»ºæŒ‰é’®å¿…é¡»ç”Ÿæˆä¸€ä¸ª Stub ç¬”è®°æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºå¯¹åº”ç±»å‹çš„ enrich ä»»åŠ¡ã€‚

**éªŒè¯éœ€æ±‚**ï¼š4.4

### å±æ€§ 11ï¼šé˜Ÿåˆ—è§†å›¾ä»»åŠ¡å®Œæ•´æ€§

*å¯¹äºä»»æ„*æ‰“å¼€çš„é˜Ÿåˆ—è§†å›¾ï¼Œæ˜¾ç¤ºçš„ä»»åŠ¡åˆ—è¡¨å¿…é¡»åŒ…å«é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œä¸”æ¯ä¸ªä»»åŠ¡å¿…é¡»æ˜¾ç¤ºç±»å‹ã€çŠ¶æ€ã€è¿›åº¦å’Œåˆ›å»ºæ—¶é—´ã€‚

**éªŒè¯éœ€æ±‚**ï¼š5.1, 5.2

### å±æ€§ 12ï¼šä»»åŠ¡å–æ¶ˆçŠ¶æ€æ›´æ–°

*å¯¹äºä»»æ„*é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œç‚¹å‡»å–æ¶ˆæŒ‰é’®åï¼Œä»»åŠ¡çŠ¶æ€å¿…é¡»æ›´æ–°ä¸º Cancelledï¼Œä¸”ç›¸å…³é”å¿…é¡»è¢«é‡Šæ”¾ã€‚

**éªŒè¯éœ€æ±‚**ï¼š5.4

### å±æ€§ 13ï¼šä»»åŠ¡é‡è¯•å…¥é˜Ÿ

*å¯¹äºä»»æ„*çŠ¶æ€ä¸º Failed çš„ä»»åŠ¡ï¼Œç‚¹å‡»é‡è¯•æŒ‰é’®åï¼Œå¿…é¡»åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼ˆç›¸åŒ payloadï¼‰å¹¶åŠ å…¥é˜Ÿåˆ—ã€‚

**éªŒè¯éœ€æ±‚**ï¼š5.5

### å±æ€§ 14ï¼šé‡å¤å¯¹æ˜¾ç¤º

*å¯¹äºä»»æ„*æ£€æµ‹åˆ°çš„é‡å¤æ¦‚å¿µå¯¹ï¼ŒWorkbench çš„é‡å¤é¢æ¿ä¸­å¿…é¡»æ˜¾ç¤ºè¯¥é‡å¤å¯¹ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªç¬”è®°çš„åç§°ã€ç›¸ä¼¼åº¦å’Œç±»å‹ã€‚

**éªŒè¯éœ€æ±‚**ï¼š6.1

### å±æ€§ 15ï¼šåˆå¹¶ä»»åŠ¡ç”Ÿæˆ

*å¯¹äºä»»æ„*é‡å¤å¯¹ï¼Œç‚¹å‡»åˆå¹¶æŒ‰é’®å¿…é¡»åˆ›å»ºä¸€ä¸ª reason:merge ç±»å‹çš„ä»»åŠ¡ï¼Œpayload åŒ…å«ä¸¤ä¸ªç¬”è®°çš„ nodeIdã€‚

**éªŒè¯éœ€æ±‚**ï¼š6.3

### å±æ€§ 16ï¼šé‡å¤å¯¹å¿½ç•¥çŠ¶æ€

*å¯¹äºä»»æ„*é‡å¤å¯¹ï¼Œç‚¹å‡»å¿½ç•¥æŒ‰é’®åï¼Œè¯¥é‡å¤å¯¹çš„çŠ¶æ€å¿…é¡»æ›´æ–°ä¸º dismissedï¼Œä¸”ä¸å†æ˜¾ç¤ºåœ¨å¾…å¤„ç†åˆ—è¡¨ä¸­ã€‚

**éªŒè¯éœ€æ±‚**ï¼š6.4

### å±æ€§ 17ï¼šåˆå¹¶å®Œæˆæ¸…ç†

*å¯¹äºä»»æ„*å®Œæˆçš„åˆå¹¶ä»»åŠ¡ï¼Œç³»ç»Ÿå¿…é¡»ä» DuplicatePairs å­˜å‚¨ä¸­ç§»é™¤è¯¥é‡å¤å¯¹ï¼Œä¸” UI åˆ—è¡¨ä¸­ä¸å†æ˜¾ç¤ºã€‚

**éªŒè¯éœ€æ±‚**ï¼š6.5

### å±æ€§ 18ï¼šå¢é‡æ”¹è¿›ä»»åŠ¡ç”Ÿæˆ

*å¯¹äºä»»æ„*è¾“å…¥çš„æ”¹è¿›æ„å›¾ï¼Œç¡®è®¤åå¿…é¡»åˆ›å»ºä¸€ä¸ª reason:incremental ç±»å‹çš„ä»»åŠ¡ï¼Œpayload åŒ…å«å½“å‰ç¬”è®°çš„ nodeId å’Œç”¨æˆ·æ„å›¾ã€‚

**éªŒè¯éœ€æ±‚**ï¼š7.3

### å±æ€§ 19ï¼šæ”¹è¿›å®Œæˆ DiffView æ˜¾ç¤º

*å¯¹äºä»»æ„*å®Œæˆçš„å¢é‡æ”¹è¿›ä»»åŠ¡ï¼Œç³»ç»Ÿå¿…é¡»æ‰“å¼€ DiffView æ˜¾ç¤ºåŸå†…å®¹å’Œæ–°å†…å®¹çš„å·®å¼‚ã€‚

**éªŒè¯éœ€æ±‚**ï¼š7.4

### å±æ€§ 20ï¼šæ”¹è¿›ç¡®è®¤å¿«ç…§åˆ›å»º

*å¯¹äºä»»æ„*åœ¨ DiffView ä¸­ç¡®è®¤çš„æ”¹è¿›ï¼Œç³»ç»Ÿå¿…é¡»åœ¨å†™å…¥å‰åˆ›å»ºå¿«ç…§ï¼Œå†™å…¥åå¿«ç…§æ–‡ä»¶å¿…é¡»å­˜åœ¨ã€‚

**éªŒè¯éœ€æ±‚**ï¼š7.5

### å±æ€§ 21ï¼šæ’¤é”€æŒ‰é’®æ˜¾ç¤º

*å¯¹äºä»»æ„*å†™å…¥æ“ä½œï¼Œç³»ç»Ÿå¿…é¡»åœ¨é€šçŸ¥ä¸­æ˜¾ç¤ºæ’¤é”€æŒ‰é’®ï¼Œä¸”æŒ‰é’®åœ¨ 5 ç§’å†…å¯ç‚¹å‡»ã€‚

**éªŒè¯éœ€æ±‚**ï¼š8.1

### å±æ€§ 22ï¼šæ’¤é”€æ¢å¤å†…å®¹

*å¯¹äºä»»æ„*ç‚¹å‡»çš„æ’¤é”€æŒ‰é’®ï¼Œæ–‡ä»¶å†…å®¹å¿…é¡»æ¢å¤åˆ°å¿«ç…§ä¸­ä¿å­˜çš„çŠ¶æ€ï¼Œä¸”å¿«ç…§æ–‡ä»¶å¿…é¡»è¢«åˆ é™¤ã€‚

**éªŒè¯éœ€æ±‚**ï¼š8.2

### å±æ€§ 23ï¼šæ“ä½œå†å²å®Œæ•´æ€§

*å¯¹äºä»»æ„*æ‰“å¼€çš„æ“ä½œå†å²è§†å›¾ï¼Œæ˜¾ç¤ºçš„æ“ä½œåˆ—è¡¨å¿…é¡»åŒ…å«æ‰€æœ‰æœªè¿‡æœŸçš„å¿«ç…§ï¼Œä¸”æ¯ä¸ªæ“ä½œå¿…é¡»æ˜¾ç¤ºæ—¶é—´ã€æ–‡ä»¶è·¯å¾„å’Œæ“ä½œç±»å‹ã€‚

**éªŒè¯éœ€æ±‚**ï¼š8.3

### å±æ€§ 24ï¼šé»˜è®¤ Provider æ›´æ–°

*å¯¹äºä»»æ„*é€‰ä¸­çš„ Providerï¼Œç‚¹å‡»"è®¾ä¸ºé»˜è®¤"æŒ‰é’®åï¼Œé…ç½®æ–‡ä»¶ä¸­çš„ defaultProviderId å¿…é¡»æ›´æ–°ä¸ºè¯¥ Provider çš„ IDã€‚

**éªŒè¯éœ€æ±‚**ï¼š9.2

### å±æ€§ 25ï¼šæ—¥å¿—æ¸…é™¤

*å¯¹äºä»»æ„*ç‚¹å‡»"æ¸…é™¤æ—¥å¿—"æŒ‰é’®çš„æ“ä½œï¼Œæ—¥å¿—æ–‡ä»¶å¿…é¡»è¢«æ¸…ç©ºæˆ–åˆ é™¤ï¼Œæ–‡ä»¶å¤§å°å¿…é¡»ä¸º 0 æˆ–æ–‡ä»¶ä¸å­˜åœ¨ã€‚

**éªŒè¯éœ€æ±‚**ï¼š9.3

### å±æ€§ 26ï¼šè®¾ç½®é‡ç½®

*å¯¹äºä»»æ„*ç¡®è®¤çš„é‡ç½®æ“ä½œï¼Œæ‰€æœ‰é…ç½®é¡¹å¿…é¡»æ¢å¤åˆ°é»˜è®¤å€¼ï¼Œä¸” Providers é…ç½®å¿…é¡»è¢«æ¸…ç©ºã€‚

**éªŒè¯éœ€æ±‚**ï¼š9.5

### å±æ€§ 27ï¼šModal ç„¦ç‚¹ç®¡ç†

*å¯¹äºä»»æ„*æ‰“å¼€çš„ Modalï¼Œç„¦ç‚¹å¿…é¡»è‡ªåŠ¨è®¾ç½®åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥å…ƒç´ æˆ–ä¸»è¦æ“ä½œæŒ‰é’®ä¸Šã€‚

**éªŒè¯éœ€æ±‚**ï¼š10.4

## é”™è¯¯å¤„ç†

### æ–°å¢é”™è¯¯ç 

| ä»£ç  | åç§° | è§¦å‘æ¡ä»¶ | å¤„ç†ç­–ç•¥ |
|------|------|----------|----------|
| E300 | INVALID_URL | è‡ªå®šä¹‰ç«¯ç‚¹ URL æ ¼å¼æ— æ•ˆ | æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé˜»æ­¢ä¿å­˜ |
| E301 | PROVIDER_NOT_SUPPORTED | å°è¯•ä½¿ç”¨ä¸æ”¯æŒçš„ Provider ç±»å‹ | æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå¼•å¯¼ç”¨æˆ·é€‰æ‹©æ”¯æŒçš„ç±»å‹ |
| E302 | MODAL_CANCELLED | ç”¨æˆ·å–æ¶ˆ Modal æ“ä½œ | é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ |

### URL éªŒè¯è§„åˆ™

```typescript
function validateUrl(url: string): string | null {
  // å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´
  if (!/^https?:\/\/.+/.test(url)) {
    return "URL å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´";
  }
  
  // å°è¯•è§£æ URL
  try {
    new URL(url);
    return null; // æœ‰æ•ˆ
  } catch {
    return "æ— æ•ˆçš„ URL æ ¼å¼";
  }
}
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

å•å…ƒæµ‹è¯•è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

1. **URL éªŒè¯**ï¼šæµ‹è¯•å„ç§æœ‰æ•ˆå’Œæ— æ•ˆçš„ URL æ ¼å¼
2. **Provider é…ç½®**ï¼šæµ‹è¯•é…ç½®çš„ä¿å­˜ã€åŠ è½½å’ŒéªŒè¯
3. **Modal ç»„ä»¶**ï¼šæµ‹è¯• Modal çš„æ‰“å¼€ã€å…³é—­å’Œå›è°ƒ
4. **é»˜è®¤å€¼**ï¼šæµ‹è¯•å„ç§é»˜è®¤ç«¯ç‚¹å’Œæ¨¡å‹é…ç½®

### å±æ€§æµ‹è¯•

å±æ€§æµ‹è¯•ä½¿ç”¨ **fast-check** åº“ï¼Œæ¯ä¸ªæµ‹è¯•è¿è¡Œè‡³å°‘ 100 æ¬¡è¿­ä»£ã€‚

å±æ€§æµ‹è¯•è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

1. **Provider ç±»å‹é™åˆ¶**ï¼ˆå±æ€§ 1ï¼‰
2. **URL æ ¼å¼éªŒè¯**ï¼ˆå±æ€§ 2ï¼‰
3. **è‡ªå®šä¹‰ç«¯ç‚¹æŒä¹…åŒ–**ï¼ˆå±æ€§ 3ï¼‰
4. **Modal æ›¿ä»£ prompt**ï¼ˆå±æ€§ 4ï¼‰
5. **é…ç½®ä¿å­˜å®Œæ•´æ€§**ï¼ˆå±æ€§ 6ï¼‰
6. **Modal å–æ¶ˆä¸ä¿å­˜**ï¼ˆå±æ€§ 7ï¼‰
7. **ä»»åŠ¡åˆ›å»ºå’ŒçŠ¶æ€æ›´æ–°**ï¼ˆå±æ€§ 8-20ï¼‰
8. **é…ç½®æ›´æ–°**ï¼ˆå±æ€§ 24-26ï¼‰
9. **ç„¦ç‚¹ç®¡ç†**ï¼ˆå±æ€§ 27ï¼‰

æ¯ä¸ªå±æ€§æµ‹è¯•å¿…é¡»ä½¿ç”¨æ³¨é‡Šæ ‡è®°å¯¹åº”çš„å±æ€§ç¼–å·ï¼š

```typescript
// **Feature: provider-simplification-and-ui-fixes, Property 1: Provider ç±»å‹é™åˆ¶**
test('provider types are limited to openai and google', () => {
  fc.assert(
    fc.property(fc.constantFrom('openai', 'google', 'openrouter', 'anthropic'), (type) => {
      const isValid = type === 'openai' || type === 'google';
      expect(isValidProviderType(type)).toBe(isValid);
    }),
    { numRuns: 100 }
  );
});
```

### é›†æˆæµ‹è¯•

é›†æˆæµ‹è¯•è¦†ç›–ä»¥ä¸‹åœºæ™¯ï¼š

1. **å®Œæ•´é…ç½®æµç¨‹**ï¼šä»æ‰“å¼€è®¾ç½®åˆ°ä¿å­˜ Provider é…ç½®
2. **å®Œæ•´åˆ›å»ºæµç¨‹**ï¼šä»è¾“å…¥æ¦‚å¿µåˆ°åˆ›å»ºç¬”è®°
3. **å®Œæ•´é˜Ÿåˆ—æµç¨‹**ï¼šä»ä»»åŠ¡å…¥é˜Ÿåˆ°å–æ¶ˆ/é‡è¯•
4. **å®Œæ•´åˆå¹¶æµç¨‹**ï¼šä»æ£€æµ‹é‡å¤åˆ°åˆå¹¶å®Œæˆ
5. **å®Œæ•´æ’¤é”€æµç¨‹**ï¼šä»å†™å…¥åˆ°æ’¤é”€æ¢å¤

## UI è®¾è®¡

### ProviderConfigModal å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é…ç½® AI Provider                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Provider ç±»å‹: [OpenAI â–¼]         â”‚
â”‚                                     â”‚
â”‚  Provider ID: [my-openai        ]  â”‚
â”‚                                     â”‚
â”‚  API Key: [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]   â”‚
â”‚           [æ˜¾ç¤º]                    â”‚
â”‚                                     â”‚
â”‚  è‡ªå®šä¹‰ç«¯ç‚¹ (å¯é€‰):                 â”‚
â”‚  [https://api.openai.com/v1    ]   â”‚
â”‚  ğŸ’¡ ç•™ç©ºä½¿ç”¨é»˜è®¤ç«¯ç‚¹                â”‚
â”‚                                     â”‚
â”‚  èŠå¤©æ¨¡å‹: [gpt-4-turbo-preview ]  â”‚
â”‚                                     â”‚
â”‚  åµŒå…¥æ¨¡å‹: [text-embedding-3-small]â”‚
â”‚                                     â”‚
â”‚  [æµ‹è¯•è¿æ¥]                         â”‚
â”‚                                     â”‚
â”‚           [å–æ¶ˆ]  [ä¿å­˜]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WorkbenchPanel åˆ›å»ºåŒºåŸŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºæ¦‚å¿µ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  æ¦‚å¿µæè¿°:                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â”‚                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    [æ ‡å‡†åŒ–]         â”‚
â”‚                                     â”‚
â”‚  â”€â”€â”€ æ ‡å‡†åŒ–ç»“æœ â”€â”€â”€                 â”‚
â”‚  ä¸­æ–‡å: äººå·¥æ™ºèƒ½                   â”‚
â”‚  è‹±æ–‡å: Artificial Intelligence    â”‚
â”‚  åˆ«å: AI, æœºå™¨æ™ºèƒ½, ...            â”‚
â”‚  ç±»å‹: Entity (0.85)                â”‚
â”‚                                     â”‚
â”‚                    [åˆ›å»º]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### QueueView ä»»åŠ¡åˆ—è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡é˜Ÿåˆ—                [æš‚åœ]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â–¶ è¿›è¡Œä¸­ (2)                       â”‚
â”‚  â”œâ”€ standardizeClassify             â”‚
â”‚  â”‚  äººå·¥æ™ºèƒ½ | è¿è¡Œä¸­ | 5s          â”‚
â”‚  â”‚  [å–æ¶ˆ]                          â”‚
â”‚  â””â”€ enrich                          â”‚
â”‚     æ·±åº¦å­¦ä¹  | è¿è¡Œä¸­ | 12s         â”‚
â”‚     [å–æ¶ˆ]                          â”‚
â”‚                                     â”‚
â”‚  â–¶ ç­‰å¾…ä¸­ (3)                       â”‚
â”‚  â”œâ”€ embedding                       â”‚
â”‚  â”‚  ç¥ç»ç½‘ç»œ | ç­‰å¾… | åˆšåˆš          â”‚
â”‚  â””â”€ ...                             â”‚
â”‚                                     â”‚
â”‚  â–¶ å·²å®Œæˆ (15)                      â”‚
â”‚  â–¶ å¤±è´¥ (1)                         â”‚
â”‚     reason:merge                    â”‚
â”‚     åˆå¹¶å¤±è´¥ | å¤±è´¥ | 2åˆ†é’Ÿå‰       â”‚
â”‚     [é‡è¯•] [æŸ¥çœ‹è¯¦æƒ…]               â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|----------|
| Modal æ‰“å¼€å»¶è¿Ÿ | â‰¤ 50ms | ç‚¹å‡»åˆ° Modal æ˜¾ç¤º |
| é…ç½®ä¿å­˜å»¶è¿Ÿ | â‰¤ 100ms | ç‚¹å‡»ä¿å­˜åˆ°å®Œæˆ |
| é˜Ÿåˆ—è§†å›¾åˆ·æ–° | â‰¤ 100ms | ä»»åŠ¡çŠ¶æ€å˜æ›´åˆ° UI æ›´æ–° |
| URL éªŒè¯å»¶è¿Ÿ | â‰¤ 10ms | è¾“å…¥åˆ°éªŒè¯ç»“æœæ˜¾ç¤º |

## è¿ç§»ç­–ç•¥

### ä» OpenRouter è¿ç§»

å¯¹äºå·²é…ç½® OpenRouter çš„ç”¨æˆ·ï¼š

1. åœ¨æ’ä»¶å¯åŠ¨æ—¶æ£€æµ‹ OpenRouter é…ç½®
2. æ˜¾ç¤ºè¿ç§»æç¤ºï¼š
   ```
   æ£€æµ‹åˆ° OpenRouter é…ç½®ã€‚
   æ–°ç‰ˆæœ¬ä¸å†æ”¯æŒ OpenRouterï¼Œä½†æ‚¨å¯ä»¥ï¼š
   1. ä½¿ç”¨ OpenAI Provider + è‡ªå®šä¹‰ç«¯ç‚¹æŒ‡å‘ OpenRouter
   2. é…ç½®å…¶ä»–æ”¯æŒçš„ Providerï¼ˆOpenAI æˆ– Geminiï¼‰
   
   [é…ç½® OpenAI] [é…ç½® Gemini] [ç¨å]
   ```
3. å¦‚æœç”¨æˆ·é€‰æ‹©é…ç½® OpenAIï¼Œè‡ªåŠ¨å¡«å……ï¼š
   - baseUrl: `https://openrouter.ai/api/v1`
   - apiKey: ä» OpenRouter é…ç½®å¤åˆ¶
   - æ¨¡å‹: ä¿æŒåŸæœ‰é…ç½®

### é…ç½®æ–‡ä»¶ç‰ˆæœ¬å‡çº§

```typescript
interface MigrationV2 {
  version: 2;
  changes: [
    {
      type: 'remove_provider_type';
      removed: 'openrouter';
    },
    {
      type: 'add_field';
      field: 'baseUrl';
      default: null;
    }
  ];
}

async function migrateToV2(oldSettings: any): Promise<Settings> {
  const newSettings = { ...oldSettings, version: 2 };
  
  // ç§»é™¤ OpenRouter é…ç½®
  for (const [id, config] of Object.entries(newSettings.providers)) {
    if (config.type === 'openrouter') {
      delete newSettings.providers[id];
    }
  }
  
  // ä¸ºç°æœ‰ Provider æ·»åŠ  baseUrl å­—æ®µï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
  for (const [id, config] of Object.entries(newSettings.providers)) {
    if (!config.baseUrl) {
      config.baseUrl = DEFAULT_ENDPOINTS[config.type];
    }
  }
  
  return newSettings;
}
```

## å®‰å…¨ä¸éšç§

1. **API Key ä¿æŠ¤**ï¼š
   - åœ¨ UI ä¸­é»˜è®¤éšè— API Keyï¼ˆæ˜¾ç¤ºä¸º â€¢â€¢â€¢â€¢ï¼‰
   - æä¾›"æ˜¾ç¤º"æŒ‰é’®ä¸´æ—¶æ˜¾ç¤º
   - ä¸åœ¨æ—¥å¿—ä¸­è®°å½• API Key

2. **è‡ªå®šä¹‰ç«¯ç‚¹éªŒè¯**ï¼š
   - éªŒè¯ URL æ ¼å¼
   - è­¦å‘Šç”¨æˆ·ä½¿ç”¨éå®˜æ–¹ç«¯ç‚¹çš„é£é™©
   - ä¸è‡ªåŠ¨å‘é€æ•°æ®åˆ°è‡ªå®šä¹‰ç«¯ç‚¹ï¼ˆéœ€ç”¨æˆ·ç¡®è®¤ï¼‰

3. **é…ç½®å¯¼å‡º**ï¼š
   - å¯¼å‡ºé…ç½®æ—¶æç¤ºç”¨æˆ· API Key å°†è¢«åŒ…å«
   - æä¾›"å¯¼å‡ºæ—¶ç§»é™¤ API Key"é€‰é¡¹

## å¯è®¿é—®æ€§

1. **é”®ç›˜å¯¼èˆª**ï¼š
   - æ‰€æœ‰ Modal æ”¯æŒ Tab é”®åˆ‡æ¢ç„¦ç‚¹
   - Enter é”®ç¡®è®¤ï¼ŒEscape é”®å–æ¶ˆ
   - ç„¦ç‚¹é¡ºåºç¬¦åˆè§†è§‰é¡ºåº

2. **å±å¹•é˜…è¯»å™¨**ï¼š
   - æ‰€æœ‰è¾“å…¥æ¡†æä¾› label
   - é”™è¯¯æ¶ˆæ¯ä½¿ç”¨ aria-live
   - æŒ‰é’®æä¾› aria-label

3. **è§†è§‰åé¦ˆ**ï¼š
   - ç„¦ç‚¹å…ƒç´ æœ‰æ˜æ˜¾çš„è§†è§‰æŒ‡ç¤º
   - é”™è¯¯æ¶ˆæ¯ä½¿ç”¨çº¢è‰²é«˜äº®
   - æˆåŠŸæ“ä½œä½¿ç”¨ç»¿è‰²æç¤º
